
 <!DOCTYPE HTML>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  
    <title>Android 源码分析之基于NuPlayer的RTSP流媒体协议 | Edgar&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Edgar">
    

    
    <meta name="description" content="RTSP 概述：RTSP 是Real Time Streaming Protocol（实时流媒体协议）的简称。RTSP提供一种可扩展的框架，使得能够提供可控制的，按需传输实时数据，比如音频和视频文件。RTSP对流媒体提供了诸如暂停，快进等控制，而它本身并不传输数据，RTSP作用相当于流媒体服务器的远程控制。传输数据可以通过传输层的TCP，UDP协议，RTSP也提供了基于 RTP传输机制的一些有效的">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 源码分析之基于NuPlayer的RTSP流媒体协议">
<meta property="og:url" content="http://yoursite.com/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/index.html">
<meta property="og:site_name" content="Edgar&#39;s Blog">
<meta property="og:description" content="RTSP 概述：RTSP 是Real Time Streaming Protocol（实时流媒体协议）的简称。RTSP提供一种可扩展的框架，使得能够提供可控制的，按需传输实时数据，比如音频和视频文件。RTSP对流媒体提供了诸如暂停，快进等控制，而它本身并不传输数据，RTSP作用相当于流媒体服务器的远程控制。传输数据可以通过传输层的TCP，UDP协议，RTSP也提供了基于 RTP传输机制的一些有效的">
<meta property="og:locale">
<meta property="og:image" content="http://yoursite.com/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/1.png">
<meta property="og:image" content="http://yoursite.com/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/2.png">
<meta property="og:image" content="http://yoursite.com/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/3.png">
<meta property="og:image" content="http://yoursite.com/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/4.png">
<meta property="og:image" content="http://yoursite.com/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/5.png">
<meta property="og:image" content="http://yoursite.com/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/6.png">
<meta property="og:image" content="http://yoursite.com/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/7.png">
<meta property="og:image" content="http://yoursite.com/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/8.png">
<meta property="og:image" content="http://yoursite.com/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/9.png">
<meta property="og:image" content="http://yoursite.com/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/10.png">
<meta property="og:image" content="http://yoursite.com/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/11.png">
<meta property="og:image" content="http://yoursite.com/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/12.png">
<meta property="og:image" content="http://yoursite.com/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/23.png">
<meta property="og:image" content="http://yoursite.com/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/24.png">
<meta property="og:image" content="http://yoursite.com/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/13.png">
<meta property="og:image" content="http://yoursite.com/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/14.png">
<meta property="article:published_time" content="2016-08-02T14:58:12.000Z">
<meta property="article:modified_time" content="2016-08-05T23:55:00.000Z">
<meta property="article:author" content="Edgar">
<meta property="article:tag" content="AOSP 源码">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/1.png">

    
    <link rel="alternative" href="atom.xml" title="Edgar&#39;s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/unnamed4_n_mSY_icon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/profile.png">
    <link rel="apple-touch-icon-precomposed" href="/img/profile.png">
    
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.2.0"></head>

  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Edgar&#39;s Blog">Edgar&#39;s Blog</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
					<li>
 					
					<form class="search" action="/search/index.html" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" autocomplete="off" name="q" maxlength="20" placeholder="Search" />
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/08/02/Android-进阶之源码分析基于NuPlayer的RTSP流媒体协议/" title="Android 源码分析之基于NuPlayer的RTSP流媒体协议" itemprop="url">Android 源码分析之基于NuPlayer的RTSP流媒体协议</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Edgar" target="_blank" itemprop="author">Edgar</a>
		
  <p class="article-time">
    <time datetime="2016-08-02T14:58:12.000Z" itemprop="datePublished"> Published 2016-08-02</time>
    
  </p>
</header>
	<div class="article-content">
		
		<h5 id="RTSP-概述："><a href="#RTSP-概述：" class="headerlink" title="RTSP 概述："></a>RTSP 概述：</h5><p>RTSP 是Real Time Streaming Protocol（实时流媒体协议）的简称。RTSP提供一种可扩展的框架，使得能够提供可控制的，按需传输实时数据，比如音频和视频文件。RTSP对流媒体提供了诸如暂停，快进等控制，而它本身并不传输数据，RTSP作用相当于流媒体服务器的远程控制。传输数据可以通过传输层的TCP，UDP协议，RTSP也提供了基于 RTP传输机制的一些有效的方法。</p>
<h5 id="RTSP-模型："><a href="#RTSP-模型：" class="headerlink" title="RTSP 模型："></a>RTSP 模型：</h5><p>客户机在向视频服务器请求视频服务之前，首先通过HTTP协议从WEB服务器获取所请求视频服务的演示描述（Presentation description）文件，在RTSP中，每个演示（Presentation）及其所对应的媒体流都由一个RTSP URL标识。整个演示及媒体特性都在一个演示描述（Presentation description）文件中定义，该文件可能包括媒体编码方式、语言、RTSPURLs、目标地址、端口及其它参数。用户在向服务器请求某个连续媒体流的服务之前，必须首先从服务器获得该媒体流的演示描述（Presentation description ）文件以得到必需的参数。利用该文件提供的信息定位视频服务地址（包括视频服务器地址和端口号）及视频服务的编码方式等信息。<br>客户机根据上述信息向视频服务器请求视频服务。视频服务初始化完毕，视频服务器为该客户建立一个新的视频服务流，客户端与服务器运行实时流控制协议RTSP，以对该流进行各种VCR 控制信号的交换，如播放、暂停、快进、快退等。当服务完毕，客户端提出拆线（TEARDOWN）请求。服务器使用 RTP协议将媒体数据传输给客户端，一旦数据抵达客户端，客户端应用程序即可播放输出。在流式传输中，使用RTP&#x2F;RTCP和RTSP &#x2F;TCP两种不同的通信协议在客户端和服务器间建立联系。如下图：</p>
<p><img src="/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/1.png"></p>
<h5 id="RTSP-协议消息格式："><a href="#RTSP-协议消息格式：" class="headerlink" title="RTSP 协议消息格式："></a>RTSP 协议消息格式：</h5><ul>
<li>请求消息格式:</li>
</ul>
<figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">方法   URI  RTSP版本   <span class="keyword">CR</span>  <span class="keyword">LF</span> </span><br><span class="line">消息头 <span class="keyword">CR</span>   <span class="keyword">LF</span>   <span class="keyword">CR</span>  <span class="keyword">LF</span> </span><br><span class="line">消息体 <span class="keyword">CR</span>   <span class="keyword">LF</span> </span><br></pre></td></tr></table></figure>

<p>其中方法包括OPTION回应中所有的命令,URI是接受方的地址,例如<br>rtsp:&#x2F;&#x2F;192.168.20.136</p>
<p>RTSP版本一般都是 RTSP&#x2F;1.0.每行后面的CR LF表示回车换行，需要接受端有相应的解析，最后一个消息头需要有两个CR LF</p>
<ul>
<li>回应消息格式:</li>
</ul>
<figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">RTSP版本  状态码  解释 <span class="keyword">CR</span>  <span class="keyword">LF</span> </span><br><span class="line">消息头 <span class="keyword">CR</span>  <span class="keyword">LF</span>  <span class="keyword">CR</span>  <span class="keyword">LF</span> </span><br><span class="line">消息体 <span class="keyword">CR</span>  <span class="keyword">LF</span></span><br></pre></td></tr></table></figure>
<p>其中RTSP版本一般都是RTSP&#x2F;1.0,状态码是一个数值,200表示成功,解释是与状态码对应的文本解释。	</p>
<h5 id="简单的RTSP-交互过程"><a href="#简单的RTSP-交互过程" class="headerlink" title="简单的RTSP 交互过程:"></a>简单的RTSP 交互过程:</h5><p>下面以一次流媒体播放为例介绍整个播放过程的RTSP状态转换的流程：<br>其中C表示RTSP客户端,S表示RTSP服务端：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">C-&gt;S:OPTION     request        <span class="regexp">//</span>询问服务端有哪些方法可用</span><br><span class="line">S-&gt;C:OPTION     response       <span class="regexp">//</span>服务端回应信息中包括提供的所有可用方法 </span><br><span class="line"></span><br><span class="line">C-&gt;S:DESCRIBE    request        <span class="regexp">//</span>要求得到服务端提供的媒体初始化描述信息 </span><br><span class="line">S-&gt;C:DESCRIBE    response       <span class="regexp">//</span>服务端回应媒体初始化描述信息，主要是SDP</span><br><span class="line"></span><br><span class="line">C-&gt;S:SETUP       request        <span class="regexp">//</span>设置会话的属性，以及传输模式提醒服务端建立会话 </span><br><span class="line">S-&gt;C:SETUP       response       <span class="regexp">//</span>服务端建立会话，返回会话标识符，和会话相关信息 </span><br><span class="line"></span><br><span class="line">C-&gt;S:PLAY        request         <span class="regexp">//</span>客户端请求播放 </span><br><span class="line">S-&gt;C:PLAY        response       <span class="regexp">//</span>服务器回应该请求的信息 </span><br><span class="line"></span><br><span class="line">S-&gt;C:                           <span class="regexp">//</span>发送流媒体数据 </span><br><span class="line"></span><br><span class="line">C-&gt;S:TEARDOWN    request        <span class="regexp">//</span>客户端请求关闭会话 </span><br><span class="line">S-&gt;C:TEARDOWN    response <span class="regexp">//</span>服务端回应该请求 </span><br></pre></td></tr></table></figure>

<p>其中第SETUP和PLAY这两部是必需的，<br>OPTION 步骤只要服务器客户端约定好，有哪些方法可用，则option请求可以不要。<br>如果我们有其他途径得到媒体初始化描述信息，则我们也不需要通过RTSP中的DESCRIPTION请求来完成。<br>TEARDOWN，可以根据系统需求的设计来决定是否需要。<br><img src="/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/2.png"></p>
<h5 id="RTSP的主要命令表："><a href="#RTSP的主要命令表：" class="headerlink" title="RTSP的主要命令表："></a>RTSP的主要命令表：</h5><p><img src="/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/3.png"><br><img src="/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/4.png"><br><img src="/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/5.png"><br><img src="/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/6.png"><br><img src="/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/7.png"></p>
<h5 id="RTSP状态码："><a href="#RTSP状态码：" class="headerlink" title="RTSP状态码："></a>RTSP状态码：</h5><figure class="highlight llvm"><table><tr><td class="code"><pre><span class="line">Status-Code <span class="operator">=</span></span><br><span class="line">| <span class="string">&quot;100&quot;</span> <span class="comment">; 				Continue</span></span><br><span class="line">| <span class="string">&quot;200&quot;</span> <span class="comment">; 				OK</span></span><br><span class="line">| <span class="string">&quot;201&quot;</span> <span class="comment">; 				Created</span></span><br><span class="line">| <span class="string">&quot;250&quot;</span> <span class="comment">; 				Low on Storage Space</span></span><br><span class="line">| <span class="string">&quot;300&quot;</span> <span class="comment">; 				Multiple Choices</span></span><br><span class="line">| <span class="string">&quot;301&quot;</span> <span class="comment">;				Moved Permanently</span></span><br><span class="line">| <span class="string">&quot;302&quot;</span> <span class="comment">; 				Moved Temporarily</span></span><br><span class="line">| <span class="string">&quot;303&quot;</span> <span class="comment">; 				See Other</span></span><br><span class="line">| <span class="string">&quot;304&quot;</span> <span class="comment">; 				Not Modified</span></span><br><span class="line">| <span class="string">&quot;305&quot;</span> <span class="comment">; 				Use Proxy</span></span><br><span class="line">| <span class="string">&quot;400&quot;</span> <span class="comment">; 				Bad Request</span></span><br><span class="line">| <span class="string">&quot;401&quot;</span> <span class="comment">; 				Unauthorized</span></span><br><span class="line">| <span class="string">&quot;402&quot;</span> <span class="comment">; 				Payment Required</span></span><br><span class="line">| <span class="string">&quot;403&quot;</span> <span class="comment">; 				Forbidden</span></span><br><span class="line">| <span class="string">&quot;404&quot;</span> <span class="comment">; 				Not Found</span></span><br><span class="line">| <span class="string">&quot;405&quot;</span> <span class="comment">; 				Method Not Allowed</span></span><br><span class="line">| <span class="string">&quot;406&quot;</span> <span class="comment">; 				Not Acceptable</span></span><br><span class="line">| <span class="string">&quot;407&quot;</span> <span class="comment">; 				Proxy Authentication Required</span></span><br><span class="line">| <span class="string">&quot;408&quot;</span> <span class="comment">; 				Request Time-out</span></span><br><span class="line">| <span class="string">&quot;410&quot;</span> <span class="comment">; 				Gone</span></span><br><span class="line">| <span class="string">&quot;411&quot;</span> <span class="comment">; 				Length Required</span></span><br><span class="line">| <span class="string">&quot;412&quot;</span> <span class="comment">; 				Precondition Failed</span></span><br><span class="line">| <span class="string">&quot;413&quot;</span> <span class="comment">; 				Request Entity Too Large</span></span><br><span class="line">| <span class="string">&quot;414&quot;</span> <span class="comment">; 				Request-URI Too Large</span></span><br><span class="line">| <span class="string">&quot;415&quot;</span> <span class="comment">; 				Unsupported Media Type</span></span><br><span class="line">| <span class="string">&quot;451&quot;</span> <span class="comment">; 				Parameter Not Understood</span></span><br><span class="line">| <span class="string">&quot;452&quot;</span> <span class="comment">; 				Conference Not Found</span></span><br><span class="line">| <span class="string">&quot;453&quot;</span> <span class="comment">; 				Not Enough Bandwidth</span></span><br><span class="line">| <span class="string">&quot;454&quot;</span> <span class="comment">; 				Session Not Found</span></span><br><span class="line">| <span class="string">&quot;455&quot;</span> <span class="comment">; 				Method Not Valid in This State</span></span><br><span class="line">| <span class="string">&quot;456&quot;</span> <span class="comment">; 				Header Field Not Valid for Resource</span></span><br><span class="line">| <span class="string">&quot;457&quot;</span> <span class="comment">; 				Invalid Range</span></span><br><span class="line">| <span class="string">&quot;458&quot;</span> <span class="comment">; 				Parameter Is Read-Only</span></span><br><span class="line">| <span class="string">&quot;459&quot;</span> <span class="comment">;				Aggregate operation not allowed</span></span><br><span class="line">| <span class="string">&quot;460&quot;</span> <span class="comment">; 				Only aggregate operation allowed</span></span><br><span class="line">| <span class="string">&quot;461&quot;</span> <span class="comment">; 				Unsupported transport</span></span><br><span class="line">| <span class="string">&quot;462&quot;</span> <span class="comment">; 				Destination unreachable</span></span><br><span class="line">| <span class="string">&quot;500&quot;</span> <span class="comment">; 				Internal Server Error</span></span><br><span class="line">| <span class="string">&quot;501&quot;</span> <span class="comment">; 				Not Implemented</span></span><br><span class="line">| <span class="string">&quot;502&quot;</span> <span class="comment">; 				Bad Gateway</span></span><br><span class="line">| <span class="string">&quot;503&quot;</span> <span class="comment">; 				Service Unavailable</span></span><br><span class="line">| <span class="string">&quot;504&quot;</span> <span class="comment">; 				Gateway Time-out</span></span><br><span class="line">| <span class="string">&quot;505&quot;</span> <span class="comment">; 				RTSP Version not supported</span></span><br><span class="line">| <span class="string">&quot;551&quot;</span> <span class="comment">; 				Option not supported</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="SDP的格式："><a href="#SDP的格式：" class="headerlink" title="SDP的格式："></a>SDP的格式：</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">v=<span class="tag">&lt;<span class="name">version</span>&gt;</span>                            (协议版本)</span><br><span class="line">o=<span class="tag">&lt;<span class="name">username</span>&gt;</span> <span class="tag">&lt;<span class="name">session</span> <span class="attr">id</span>&gt;</span> <span class="tag">&lt;<span class="name">version</span>&gt;</span> <span class="tag">&lt;<span class="name">network</span> <span class="attr">type</span>&gt;</span> <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>&gt;</span> <span class="tag">&lt;<span class="name">address</span>&gt;</span>                              （所有者/创建者和会话标识符）</span><br><span class="line">s=<span class="tag">&lt;<span class="name">session</span> <span class="attr">name</span>&gt;</span>                       （会话名称）</span><br><span class="line">i=<span class="tag">&lt;<span class="name">session</span> <span class="attr">description</span>&gt;</span>                （会话信息） </span><br><span class="line">u=<span class="tag">&lt;<span class="name">URI</span>&gt;</span>                                （URI 描述）</span><br><span class="line">e=<span class="tag">&lt;<span class="name">email</span> <span class="attr">address</span>&gt;</span>                      （Email 地址）</span><br><span class="line">p=<span class="tag">&lt;<span class="name">phone</span> <span class="attr">number</span>&gt;</span>                       （电话号码）</span><br><span class="line">c=<span class="tag">&lt;<span class="name">network</span> <span class="attr">type</span>&gt;</span> <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>&gt;</span> <span class="tag">&lt;<span class="name">connection</span> <span class="attr">address</span>&gt;</span>   （连接信息）</span><br><span class="line">b=<span class="tag">&lt;<span class="name">modifier</span>&gt;</span>:<span class="tag">&lt;<span class="name">bandwidth-value</span>&gt;</span>         （带宽信息）</span><br><span class="line">t=<span class="tag">&lt;<span class="name">start</span> <span class="attr">time</span>&gt;</span> <span class="tag">&lt;<span class="name">stop</span> <span class="attr">time</span>&gt;</span>             （会话活动时间）</span><br><span class="line">r=<span class="tag">&lt;<span class="name">repeat</span> <span class="attr">interval</span>&gt;</span> <span class="tag">&lt;<span class="name">active</span> <span class="attr">duration</span>&gt;</span> <span class="tag">&lt;<span class="name">list</span> <span class="attr">of</span> <span class="attr">offsets</span> <span class="attr">from</span> <span class="attr">start-time</span>&gt;</span> </span><br><span class="line">                                        （0或多次重复次数）</span><br><span class="line">z=<span class="tag">&lt;<span class="name">adjustment</span> <span class="attr">time</span>&gt;</span> <span class="tag">&lt;<span class="name">offset</span>&gt;</span> <span class="tag">&lt;<span class="name">adjustment</span> <span class="attr">time</span>&gt;</span> <span class="tag">&lt;<span class="name">offset</span>&gt;</span>（时间区域调整）</span><br><span class="line">k=<span class="tag">&lt;<span class="name">method</span>&gt;</span>:<span class="tag">&lt;<span class="name">encryption</span> <span class="attr">key</span>&gt;</span>             （加密密钥）</span><br><span class="line">a=<span class="tag">&lt;<span class="name">attribute</span>&gt;</span>:<span class="tag">&lt;<span class="name">value</span>&gt;</span>                   （0 个或多个会话属性行）</span><br><span class="line">m=<span class="tag">&lt;<span class="name">media</span>&gt;</span> <span class="tag">&lt;<span class="name">port</span>&gt;</span> <span class="tag">&lt;<span class="name">transport</span>&gt;</span> <span class="tag">&lt;<span class="name">fmt</span> <span class="attr">list</span>&gt;</span> （媒体名称和传输地址）</span><br><span class="line"></span><br><span class="line">时间描述： </span><br><span class="line">t = （会话活动时间） </span><br><span class="line">r = * （0或多次重复次数） </span><br><span class="line">媒体描述： </span><br><span class="line">m = （媒体名称和传输地址） </span><br><span class="line">i = * （媒体标题） </span><br><span class="line">c = * （连接信息 — 如果包含在会话层则该字段可选） </span><br><span class="line">b = * （带宽信息） </span><br><span class="line">k = * （加密密钥） </span><br><span class="line">a = * （0 个或多个媒体属性行） </span><br></pre></td></tr></table></figure>
<h5 id="RTP协议："><a href="#RTP协议：" class="headerlink" title="RTP协议："></a>RTP协议：</h5><p>实时传输协议（Real-time Transport Protocol，RTP）是用来在单播或者多播的情境中传流媒体数据的数据传输协议。通常使用UDP来进行多媒体数据的传输，也不排除使用TCP或者ATM等其它协议作为它的载体，整个RTP 协议由两个密切相关的部分组成：RTP数据协议和RTP控制协议（也就是RTCP协议）。<br>RTP为Internet上端到端的实时传输提供时间信息和流同步，但它并不保证服务质量，服务质量由RTCP来提供。</p>
<ul>
<li>使用RTP协议进行数据传输的一个简要RTP的会话过程：</li>
</ul>
<p>当应用程序建立一个RTP会话时，应用程序将确定一对目的传输地址。目的传输地址由一个网络地址和一对端口组成，有两个端口：一个给RTP包，一个给RTCP包，也就是说RTP和RTCP数据包是分开传输的，这样可以使得RTP&#x2F;RTCP数据能够正确发送。其中RTP数据发向偶数的UDP端口，而对应的控制信号RTCP数据发向相邻的奇数UDP端口，这样就构成一个UDP端口对。<br>当发送数据的时候RTP协议从上层接收流媒体信息码流，封装成RTP数据包；RTCP从上层接收控制信息，封装成RTCP控制包。RTP将RTP 数据包发往UDP端口对中偶数端口；RTCP将RTCP控制包发往UDP端口对中的接收端口。<br>如果在一次会议中同时使用了音频和视频会议，这两种媒体将分别在不同的RTP会话中传送，每一个会话使用不同的传输地址（IP地址＋端口）。如果一个用户同时使用了两个会话，则每个会话对应的RTCP包都使用规范化名字CNAME（Canonical Name）。与会者可以根据RTCP包中的CNAME来获取相关联的音频和视频，然后根据RTCP包中的计时信息(Network time protocol)来实现音频和视频的同步。</p>
<ul>
<li>翻译器和混合器<br>在RTP协议中还引入了翻译器和混合器。翻译器和混合器都是RTP级的中继系统。<br>混合器的使用情景：<br>在Internet上举行视频会议时，可能有少数参加者通过低速链路与使用高速网络的多数参加者相连接。为了不强制所有会议参加者都使用低带宽和低质量的数据编码，RTP允许在低带宽区域附近使用混合器作为RTP级中继器。混合器从一个或多个信源接收RTP报文，对到达的数据报文进行重新同步和重新组合，这些重组的数据流被混合成一个数据流，将数据编码转化为在低带宽上可用的类型，并通过低速链路向低带宽区域转发。为了对多个输入信源进行统一的同步，混合器在多个媒体流之间进行定时调整，产生它自己的定时同步，因此所有从混合器输出的报文都把混合器作为同步信源。为了保证接收者能够正确识别混合器处理前的原始报文发送者，混合器在RTP报头中设置了CSRC标识符队列，以标识那些产生混和报文的原始同步信源。<br>翻译器的使用情景<br>在Internet环境中，一些会议的参加者可能被隔离在应用级防火墙的外面，这些参加者被禁止直接使用IP组播地址进行访问，虽然他们可能是通过高速链路连接的。在这些情况下，RTP允许使用转换器作为RTP级中继器。在防火墙两端分别安装一个转换器，防火墙之外的转换器过滤所有接收到的组播报文，并通过一条安全的连接传送给防火墙之内的转换器，内部转换器将这些组播报文再转发送给内部网络中的组播组成员</li>
</ul>
<h5 id="RTP协议报头格式"><a href="#RTP协议报头格式" class="headerlink" title="RTP协议报头格式"></a>RTP协议报头格式</h5><p><img src="/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/8.png"><br><img src="/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/9.png"></p>
<h5 id="RTCP协议报头格式"><a href="#RTCP协议报头格式" class="headerlink" title="RTCP协议报头格式"></a>RTCP协议报头格式</h5><p>如前面所述RTCP的主要功能是：服务质量的监视与反馈、媒体间的同步，以及多播组中成员的标识。在RTP会话期间，各参与者周期性地传送RTCP包。RTCP包中含有已发送的数据包的数量、丢失的数据包的数量等统计资料，因此，各参与者可以利用这些信息动态地改变传输速率，甚至改变有效载荷类型。RTP和RTCP配合使用，它们能以有效的反馈和最小的开销使传输效率最佳化，因而特别适合传送网上的实时数据。RTCP也是用UDP来传送的，但RTCP封装的仅仅是一些控制信息，因而分组很短，所以可以将多个RTCP分组封装在一个UDP包中。<br>RTCP有如下五种分组类型：<br><img src="/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/10.png"><br>下面是SR分组的格式：<br><img src="/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/11.png"><br><img src="/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/12.png"></p>
<h5 id="基于NuPLayer的RTSP-代码流程"><a href="#基于NuPLayer的RTSP-代码流程" class="headerlink" title="基于NuPLayer的RTSP 代码流程"></a>基于NuPLayer的RTSP 代码流程</h5><p>setDataSource 阶段的任务这里就不重复介绍了，它主要完成播放引擎的建立以及根据URL格式创建对应的Source，比如这里将要提到的RTSPSource，然后赋值给mSource。</p>
<p>我们直接来看prepare阶段：</p>
<p>先上图再看代码，结合图看会比较清晰<br><img src="/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/23.png"><br><img src="/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/24.png"><br><img src="/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/13.png"><br><img src="/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/14.png"></p>
<p>在prepare阶段我们首先会判断是否是SDP，mIsSDP这个变量是在初始化RTSPSource时候传入的，我们这里先分析mIsSDP &#x3D; false的情况。这种情况下首先创建一个MyHandler，并调用connect，与服务器建立连接。</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void NuPlayer::RTSPSource::prepare<span class="constructor">Async()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//..........</span></span><br><span class="line">    sp&lt;AMessage&gt; notify = <span class="keyword">new</span> <span class="constructor">AMessage(<span class="params">kWhatNotify</span>, <span class="params">this</span>)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//检查当前状态是否为DISCONNECTED</span></span><br><span class="line">    <span class="constructor">CHECK_EQ(<span class="params">mState</span>, (<span class="params">int</span>)</span>DISCONNECTED);</span><br><span class="line">    <span class="comment">//设置当前状态为CONNECTING</span></span><br><span class="line">    mState = CONNECTING;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mIsSDP) &#123;</span><br><span class="line">        <span class="comment">//如果是SDP那么就需要创建一个SDPLoader 从服务器上加载一个描述文件</span></span><br><span class="line">        mSDPLoader = <span class="keyword">new</span> <span class="constructor">SDPLoader(<span class="params">notify</span>, (<span class="params">mFlags</span> &amp; <span class="params">kFlagIncognito</span>)</span> ? SDPLoader::kFlagIncognito : <span class="number">0</span>, mHTTPService);</span><br><span class="line">        mSDPLoader-&gt;load(mURL.c<span class="constructor">_str()</span>, mExtraHeaders.is<span class="constructor">Empty()</span> ? NULL : &amp;mExtraHeaders);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//如果不是SDP 那么就使用MyHandler 来进行连接</span></span><br><span class="line">        mHandler = <span class="keyword">new</span> <span class="constructor">MyHandler(<span class="params">mURL</span>.<span class="params">c_str</span>()</span>, notify, mUIDValid, mUID);</span><br><span class="line">        mLooper-&gt;register<span class="constructor">Handler(<span class="params">mHandler</span>)</span>;</span><br><span class="line">        mHandler-&gt;connect<span class="literal">()</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//启动缓存</span></span><br><span class="line">    start<span class="constructor">BufferingIfNecessary()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在介绍connect方法之前需要先了解mConn以及mRTPConn这两个成员变量，mConn是一个ARTSPConnection，它主要与服务器相连，发送和接收请求数据，mRTPConn是一个ARTPConnection 用于发送和接收媒体数据。<br>在connect方法中会使用mConn向服务器发起连接请求。</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void connect<span class="literal">()</span> &#123;</span><br><span class="line">    <span class="comment">//mConn(new ARTSPConnection(mUIDValid, mUID)),</span></span><br><span class="line">    looper<span class="literal">()</span>-&gt;register<span class="constructor">Handler(<span class="params">mConn</span>)</span>;</span><br><span class="line">    <span class="comment">//mRTPConn(new ARTPConnection),</span></span><br><span class="line">    (<span class="number">1</span> ? mNetLooper : looper<span class="literal">()</span>)-&gt;register<span class="constructor">Handler(<span class="params">mRTPConn</span>)</span>;</span><br><span class="line">    sp&lt;AMessage&gt; notify = <span class="keyword">new</span> <span class="constructor">AMessage(&#x27;<span class="params">biny</span>&#x27;, <span class="params">this</span>)</span>;</span><br><span class="line">    mConn-&gt;observe<span class="constructor">BinaryData(<span class="params">notify</span>)</span>;</span><br><span class="line">    <span class="comment">//连接服务</span></span><br><span class="line">    sp&lt;AMessage&gt; reply = <span class="keyword">new</span> <span class="constructor">AMessage(&#x27;<span class="params">conn</span>&#x27;, <span class="params">this</span>)</span>;</span><br><span class="line">    mConn-&gt;connect(mOriginalSessionURL.c<span class="constructor">_str()</span>, reply);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void ARTSPConnection::connect(const <span class="built_in">char</span> *url, const sp&lt;AMessage&gt; &amp;reply) &#123;</span><br><span class="line">    <span class="comment">//发送一个kWhatConnect消息，注意这里传递的是一个url和reply</span></span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> <span class="constructor">AMessage(<span class="params">kWhatConnect</span>, <span class="params">this</span>)</span>;</span><br><span class="line">    msg-&gt;set<span class="constructor">String(<span class="string">&quot;url&quot;</span>, <span class="params">url</span>)</span>;</span><br><span class="line">    msg-&gt;set<span class="constructor">Message(<span class="string">&quot;reply&quot;</span>, <span class="params">reply</span>)</span>;</span><br><span class="line">    msg-&gt;post<span class="literal">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight actionscript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> kWhatConnect:</span><br><span class="line">    onConnect(msg);</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>在ARTSPConnection::onConnect中将会从传递过来的URl中解析host，port，path，mUser，mPass，并调用::connect 和服务器取得联系，最后调用postReceiveReponseEvent将请求的回复响应暂存起来。</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void ARTSPConnection::on<span class="constructor">Connect(<span class="params">const</span> <span class="params">sp</span>&lt;AMessage&gt; &amp;<span class="params">msg</span>)</span> &#123;</span><br><span class="line">    ++mConnectionID;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (mState != DISCONNECTED) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mUIDValid) &#123;</span><br><span class="line">            HTTPBase::<span class="constructor">UnRegisterSocketUserTag(<span class="params">mSocket</span>)</span>;</span><br><span class="line">            HTTPBase::<span class="constructor">UnRegisterSocketUserMark(<span class="params">mSocket</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        close(mSocket);</span><br><span class="line">        mSocket = -<span class="number">1</span>;</span><br><span class="line">        flush<span class="constructor">PendingRequests()</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mState = CONNECTING;</span><br><span class="line">    AString url;</span><br><span class="line">    <span class="comment">//从消息中取下Url</span></span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">findString</span>(<span class="string">&quot;url&quot;</span>, &amp;<span class="params">url</span>)</span>);</span><br><span class="line">    sp&lt;AMessage&gt; reply;</span><br><span class="line">    <span class="comment">//从消息中取下replay</span></span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">findMessage</span>(<span class="string">&quot;reply&quot;</span>, &amp;<span class="params">reply</span>)</span>);</span><br><span class="line"></span><br><span class="line">    AString host, path;</span><br><span class="line">    unsigned port;</span><br><span class="line">    <span class="comment">//从URl中解析host，port，path，mUser，mPass</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="constructor">ParseURL(<span class="params">url</span>.<span class="params">c_str</span>()</span>, &amp;host, &amp;port, &amp;path, &amp;mUser, &amp;mPass)<span class="operator"></span></span><br><span class="line"><span class="operator">            || </span>(mUser.size<span class="literal">()</span> &gt; <span class="number">0</span><span class="operator"> &amp;&amp; </span>mPass.size<span class="literal">()</span><span class="operator"> == </span><span class="number">0</span>)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//有用户名，但是没有密码，返回错误信息</span></span><br><span class="line">        <span class="comment">// If we have a user name but no password we have to give up</span></span><br><span class="line">        <span class="comment">// right here, since we currently have no way of asking the user</span></span><br><span class="line">        <span class="comment">// for this information.</span></span><br><span class="line">        <span class="constructor">ALOGE(<span class="string">&quot;Malformed rtsp url %s&quot;</span>, <span class="params">uriDebugString</span>(<span class="params">url</span>)</span>.c<span class="constructor">_str()</span>);</span><br><span class="line">        reply-&gt;set<span class="constructor">Int32(<span class="string">&quot;result&quot;</span>, ERROR_MALFORMED)</span>;</span><br><span class="line">        reply-&gt;post<span class="literal">()</span>;</span><br><span class="line">        mState = DISCONNECTED;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mUser.size<span class="literal">()</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="constructor">ALOGV(<span class="string">&quot;user = &#x27;%s&#x27;, pass = &#x27;%s&#x27;&quot;</span>, <span class="params">mUser</span>.<span class="params">c_str</span>()</span>, mPass.c<span class="constructor">_str()</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> hostent *ent = gethostbyname(host.c<span class="constructor">_str()</span>);</span><br><span class="line">    <span class="keyword">if</span> (ent<span class="operator"> == </span>NULL) &#123;</span><br><span class="line">        <span class="constructor">ALOGE(<span class="string">&quot;Unknown host %s&quot;</span>, <span class="params">host</span>.<span class="params">c_str</span>()</span>);</span><br><span class="line">        reply-&gt;set<span class="constructor">Int32(<span class="string">&quot;result&quot;</span>, -ENOENT)</span>;</span><br><span class="line">        reply-&gt;post<span class="literal">()</span>;</span><br><span class="line">        mState = DISCONNECTED;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mSocket = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mUIDValid) &#123;</span><br><span class="line">        HTTPBase::<span class="constructor">RegisterSocketUserTag(<span class="params">mSocket</span>, <span class="params">mUID</span>,(<span class="params">uint32_t</span>)</span>*(uint32_t*) <span class="string">&quot;RTSP&quot;</span>);</span><br><span class="line">        HTTPBase::<span class="constructor">RegisterSocketUserMark(<span class="params">mSocket</span>, <span class="params">mUID</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="constructor">MakeSocketBlocking(<span class="params">mSocket</span>, <span class="params">false</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> sockaddr_in remote;</span><br><span class="line">    memset(remote.sin_zero, <span class="number">0</span>, sizeof(remote.sin_zero));</span><br><span class="line">    remote.sin_family = AF_INET;</span><br><span class="line">    remote.sin_addr.s_addr = *(in_addr_t *)ent-&gt;h_addr;</span><br><span class="line">    remote.sin_port = htons(port);</span><br><span class="line">    <span class="comment">//连接到服务器</span></span><br><span class="line">    <span class="built_in">int</span> err = ::connect(mSocket, (const <span class="keyword">struct</span> sockaddr *)&amp;remote, sizeof(remote));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回服务器ip</span></span><br><span class="line">    reply-&gt;set<span class="constructor">Int32(<span class="string">&quot;server-ip&quot;</span>, <span class="params">ntohl</span>(<span class="params">remote</span>.<span class="params">sin_addr</span>.<span class="params">s_addr</span>)</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (errno<span class="operator"> == </span>EINPROGRESS) &#123;</span><br><span class="line">            sp&lt;AMessage&gt; msg = <span class="keyword">new</span> <span class="constructor">AMessage(<span class="params">kWhatCompleteConnection</span>, <span class="params">this</span>)</span>;</span><br><span class="line">            msg-&gt;set<span class="constructor">Message(<span class="string">&quot;reply&quot;</span>, <span class="params">reply</span>)</span>;</span><br><span class="line">            msg-&gt;set<span class="constructor">Int32(<span class="string">&quot;connection-id&quot;</span>, <span class="params">mConnectionID</span>)</span>;</span><br><span class="line">            msg-&gt;post<span class="literal">()</span>;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        reply-&gt;set<span class="constructor">Int32(<span class="string">&quot;result&quot;</span>, -<span class="params">errno</span>)</span>;</span><br><span class="line">        mState = DISCONNECTED;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mUIDValid) &#123;</span><br><span class="line">            HTTPBase::<span class="constructor">UnRegisterSocketUserTag(<span class="params">mSocket</span>)</span>;</span><br><span class="line">            HTTPBase::<span class="constructor">UnRegisterSocketUserMark(<span class="params">mSocket</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        close(mSocket);</span><br><span class="line">        mSocket = -<span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//成功的花返回result为OK</span></span><br><span class="line">        reply-&gt;set<span class="constructor">Int32(<span class="string">&quot;result&quot;</span>, OK)</span>;</span><br><span class="line">        <span class="comment">//设置状态为CONNECTED</span></span><br><span class="line">        mState = CONNECTED;</span><br><span class="line">        mNextCSeq = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">//发送等待返回消息</span></span><br><span class="line">        post<span class="constructor">ReceiveReponseEvent()</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//‘conn’</span></span><br><span class="line">    reply-&gt;post<span class="literal">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们接下来看下postReceiveReponseEvent</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title class_">ARTSPConnection</span>::<span class="title function_">postReceiveReponseEvent</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (mReceiveResponseEventPending) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    sp&lt;<span class="title class_">AMessage</span>&gt; msg = <span class="keyword">new</span> <span class="title class_">AMessage</span>(kWhatReceiveResponse, <span class="variable language_">this</span>);</span><br><span class="line">    msg-&gt;<span class="title function_">post</span>();</span><br><span class="line">    mReceiveResponseEventPending = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用receiveRTSPReponse获得服务器的回复</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void ARTSPConnection::on<span class="constructor">ReceiveResponse()</span> &#123;</span><br><span class="line">    mReceiveResponseEventPending = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (mState != CONNECTED) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">struct</span> timeval tv;</span><br><span class="line">    tv.tv_sec = <span class="number">0</span>;</span><br><span class="line">    tv.tv_usec = kSelectTimeoutUs;</span><br><span class="line">    fd_set rs;</span><br><span class="line">    <span class="constructor">FD_ZERO(&amp;<span class="params">rs</span>)</span>;</span><br><span class="line">    <span class="constructor">FD_SET(<span class="params">mSocket</span>, &amp;<span class="params">rs</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//选择一个返回的连接</span></span><br><span class="line">    <span class="built_in">int</span> res = select(mSocket + <span class="number">1</span>, &amp;rs, NULL, NULL, &amp;tv);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (res<span class="operator"> == </span><span class="number">1</span>) &#123;</span><br><span class="line">        <span class="constructor">MakeSocketBlocking(<span class="params">mSocket</span>, <span class="params">true</span>)</span>;</span><br><span class="line">        <span class="built_in">bool</span> success = receive<span class="constructor">RTSPReponse()</span>;</span><br><span class="line">        <span class="constructor">MakeSocketBlocking(<span class="params">mSocket</span>, <span class="params">false</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">            <span class="comment">// Something horrible, irreparable has happened.</span></span><br><span class="line">            flush<span class="constructor">PendingRequests()</span>;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    post<span class="constructor">ReceiveReponseEvent()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意这里的receiveRTSPReponse是有双重功能的，方面可以接收从服务器发来的请求，另一方面可以处理服务器发来的应答信号。</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="built_in">bool</span> ARTSPConnection::receive<span class="constructor">RTSPReponse()</span> &#123;</span><br><span class="line"></span><br><span class="line">    AString statusLine;</span><br><span class="line">    <span class="keyword">if</span> (!receive<span class="constructor">Line(&amp;<span class="params">statusLine</span>)</span>) &#123;</span><br><span class="line">        return <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (statusLine<span class="operator"> == </span><span class="string">&quot;$&quot;</span>) &#123;</span><br><span class="line">        sp&lt;ABuffer&gt; buffer = receive<span class="constructor">BinaryData()</span>;</span><br><span class="line">        <span class="keyword">if</span> (buffer<span class="operator"> == </span>NULL) &#123;</span><br><span class="line">            return <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mObserveBinaryMessage != NULL) &#123;</span><br><span class="line">            sp&lt;AMessage&gt; notify = mObserveBinaryMessage-&gt;dup<span class="literal">()</span>;</span><br><span class="line">            notify-&gt;set<span class="constructor">Buffer(<span class="string">&quot;buffer&quot;</span>, <span class="params">buffer</span>)</span>;</span><br><span class="line">            notify-&gt;post<span class="literal">()</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="constructor">ALOGW(<span class="string">&quot;received binary data, but no one cares.&quot;</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        return <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//RTSP返回对象</span></span><br><span class="line">    sp&lt;ARTSPResponse&gt; response = <span class="keyword">new</span> ARTSPResponse;</span><br><span class="line">    response-&gt;mStatusLine = statusLine;</span><br><span class="line">    <span class="constructor">ALOGI(<span class="string">&quot;status: %s&quot;</span>, <span class="params">response</span>-&gt;<span class="params">mStatusLine</span>.<span class="params">c_str</span>()</span>);</span><br><span class="line">    ssize_t space1 = response-&gt;mStatusLine.find(<span class="string">&quot; &quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (space1 &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        return <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ssize_t space2 = response-&gt;mStatusLine.find(<span class="string">&quot; &quot;</span>, space1 + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (space2 &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        return <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">bool</span> isRequest = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">//判断返回的RTSP版本是否正确</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="constructor">IsRTSPVersion(AString(<span class="params">response</span>-&gt;<span class="params">mStatusLine</span>, 0, <span class="params">space1</span>)</span>)) &#123;</span><br><span class="line">        <span class="constructor">CHECK(IsRTSPVersion(AString(<span class="params">response</span>-&gt;<span class="params">mStatusLine</span>,<span class="params">space2</span> + 1,<span class="params">response</span>-&gt;<span class="params">mStatusLine</span>.<span class="params">size</span>()</span> - space2 - <span class="number">1</span>)));</span><br><span class="line">        isRequest = <span class="literal">true</span>;</span><br><span class="line">        response-&gt;mStatusCode = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//判断状态码是否正确</span></span><br><span class="line">        AString status<span class="constructor">CodeStr(<span class="params">response</span>-&gt;<span class="params">mStatusLine</span>, <span class="params">space1</span> + 1, <span class="params">space2</span> - <span class="params">space1</span> - 1)</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="constructor">ParseSingleUnsignedLong(<span class="params">statusCodeStr</span>.<span class="params">c_str</span>()</span>, &amp;response-&gt;mStatusCode)<span class="operator"> || </span>response-&gt;mStatusCode &lt; <span class="number">100</span><span class="operator"> || </span>response-&gt;mStatusCode &gt; <span class="number">999</span>) &#123;</span><br><span class="line">            return <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    AString line;</span><br><span class="line">    ssize_t lastDictIndex = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!receive<span class="constructor">Line(&amp;<span class="params">line</span>)</span>) &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (line.empty<span class="literal">()</span>) &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="constructor">ALOGV(<span class="string">&quot;line: &#x27;%s&#x27;&quot;</span>, <span class="params">line</span>.<span class="params">c_str</span>()</span>);</span><br><span class="line">        <span class="keyword">if</span> (line.c<span class="constructor">_str()</span><span class="literal">[<span class="number">0</span>]</span><span class="operator"> == </span><span class="character">&#x27; &#x27;</span><span class="operator"> || </span>line.c<span class="constructor">_str()</span><span class="literal">[<span class="number">0</span>]</span><span class="operator"> == </span><span class="character">&#x27;\t&#x27;</span>) &#123;</span><br><span class="line">            <span class="comment">// Support for folded header values.</span></span><br><span class="line">            <span class="keyword">if</span> (lastDictIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// First line cannot be a continuation of the previous one.</span></span><br><span class="line">                return <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            AString &amp;value = response-&gt;mHeaders.edit<span class="constructor">ValueAt(<span class="params">lastDictIndex</span>)</span>;</span><br><span class="line">            value.append(line);</span><br><span class="line"></span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">        ssize_t colonPos = line.find(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (colonPos &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Malformed header line.</span></span><br><span class="line">            return <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        AString key(line, <span class="number">0</span>, colonPos);</span><br><span class="line">        key.trim<span class="literal">()</span>;</span><br><span class="line">        key.tolower<span class="literal">()</span>;</span><br><span class="line">        line.erase(<span class="number">0</span>, colonPos + <span class="number">1</span>);</span><br><span class="line">        lastDictIndex = response-&gt;mHeaders.add(key, line);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (size_t i = <span class="number">0</span>; i &lt; response-&gt;mHeaders.size<span class="literal">()</span>; ++i) &#123;</span><br><span class="line">        response-&gt;mHeaders.edit<span class="constructor">ValueAt(<span class="params">i</span>)</span>.trim<span class="literal">()</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    unsigned long contentLength = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    ssize_t i = response-&gt;mHeaders.index<span class="constructor">OfKey(<span class="string">&quot;content-length&quot;</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (i &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        AString value = response-&gt;mHeaders.value<span class="constructor">At(<span class="params">i</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="constructor">ParseSingleUnsignedLong(<span class="params">value</span>.<span class="params">c_str</span>()</span>, &amp;contentLength)) &#123;</span><br><span class="line">            return <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//接收mContent</span></span><br><span class="line">    <span class="keyword">if</span> (contentLength &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        response-&gt;mContent = <span class="keyword">new</span> <span class="constructor">ABuffer(<span class="params">contentLength</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (receive(response-&gt;mContent-&gt;data<span class="literal">()</span>, contentLength) != OK) &#123;</span><br><span class="line">            return <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//isRequest 表示是服务器主动发送的请求，那么将调用handleServerRequest，否则表示是服务器被动响应客户端的请求，那么将通知服务器有响应了notifyResponseListener</span></span><br><span class="line">    return isRequest</span><br><span class="line">        ? handle<span class="constructor">ServerRequest(<span class="params">response</span>)</span></span><br><span class="line">        : notify<span class="constructor">ResponseListener(<span class="params">response</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>isRequest 表示是服务器主动发送的请求，那么将调用handleServerRequest，否则表示是服务器被动响应客户端的请求，那么将通知服务器有响应了notifyResponseListener，我们这里先看下这两个方法的实现：</p>
<p>看到handleServerRequest大家可能会有点失望，因为这里尚未实现这个功能所以只是向服务器返回一个“RTSP&#x2F;1.0 501 Not Implemented”的消息。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ARTSPConnection::handleServerRequest</span><span class="params">(<span class="type">const</span> sp&lt;ARTSPResponse&gt; &amp;request)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Implementation of server-&gt;client requests is optional for all methods</span></span><br><span class="line">    <span class="comment">// but we do need to respond, even if it&#x27;s just to say that we don&#x27;t</span></span><br><span class="line">    <span class="comment">// support the method.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//这里我们不实现任何答复行为只是简单反馈我们尚未实现这个功能</span></span><br><span class="line">    <span class="type">ssize_t</span> space1 = request-&gt;mStatusLine.<span class="built_in">find</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">    <span class="built_in">CHECK_GE</span>(space1, <span class="number">0</span>);</span><br><span class="line">    AString response;</span><br><span class="line">    response.<span class="built_in">append</span>(<span class="string">&quot;RTSP/1.0 501 Not Implemented\r\n&quot;</span>);</span><br><span class="line">    <span class="type">ssize_t</span> i = request-&gt;mHeaders.<span class="built_in">indexOfKey</span>(<span class="string">&quot;cseq&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (i &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        AString value = request-&gt;mHeaders.<span class="built_in">valueAt</span>(i);</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> cseq;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">ParseSingleUnsignedLong</span>(value.<span class="built_in">c_str</span>(), &amp;cseq)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        response.<span class="built_in">append</span>(<span class="string">&quot;CSeq: &quot;</span>);</span><br><span class="line">        response.<span class="built_in">append</span>(cseq);</span><br><span class="line">        response.<span class="built_in">append</span>(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    response.<span class="built_in">append</span>(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">    <span class="type">size_t</span> numBytesSent = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (numBytesSent &lt; response.<span class="built_in">size</span>()) &#123;</span><br><span class="line">        <span class="type">ssize_t</span> n =</span><br><span class="line">            <span class="built_in">send</span>(mSocket, response.<span class="built_in">c_str</span>() + numBytesSent,</span><br><span class="line">                 response.<span class="built_in">size</span>() - numBytesSent, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (n &lt; <span class="number">0</span> &amp;&amp; errno == EINTR) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (n &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// Server closed the connection.</span></span><br><span class="line">                <span class="built_in">ALOGE</span>(<span class="string">&quot;Server unexpectedly closed the connection.&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">ALOGE</span>(<span class="string">&quot;Error sending rtsp response (%s).&quot;</span>, <span class="built_in">strerror</span>(errno));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">performDisconnect</span>();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        numBytesSent += (<span class="type">size_t</span>)n;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>notifyResponseListener的实现比较清晰，它会根据服务器发来的应答响应，找出响应该应答的Message，然后将response返回给MyHandler，进行处理。</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="type">bool</span> ARTSPConnection::<span class="title function_ invoke__">notifyResponseListener</span>(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;ARTSPResponse&gt; &amp;response) &#123;</span><br><span class="line">    ssize_t i;</span><br><span class="line">    <span class="comment">//在队列中查找尚未处理的请求</span></span><br><span class="line">    status_t err = <span class="title function_ invoke__">findPendingRequest</span>(response, &amp;i);</span><br><span class="line">    <span class="title function_ invoke__">if</span> (err != OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//发送服务器的回复给它</span></span><br><span class="line">    sp&lt;AMessage&gt; reply = mPendingRequests.<span class="title function_ invoke__">valueAt</span>(i);</span><br><span class="line">    mPendingRequests.<span class="title function_ invoke__">removeItemsAt</span>(i);</span><br><span class="line">    reply<span class="punctuation">-&gt;</span><span class="title function_ invoke__">setInt32</span>(<span class="string">&quot;result&quot;</span>, OK);</span><br><span class="line">    reply<span class="punctuation">-&gt;</span><span class="title function_ invoke__">setObject</span>(<span class="string">&quot;response&quot;</span>, response);</span><br><span class="line">    reply<span class="punctuation">-&gt;</span><span class="title function_ invoke__">post</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>好了我们言归正传，我们看下MyHandler中对conn回复怎么处理：</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">case &#x27;conn&#x27;:</span><br><span class="line">&#123;</span><br><span class="line">    int32_t result;</span><br><span class="line">    <span class="comment">//取出反馈结果</span></span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">findInt32</span>(<span class="string">&quot;result&quot;</span>, &amp;<span class="params">result</span>)</span>);</span><br><span class="line">    <span class="keyword">if</span> (result<span class="operator"> == </span>OK) &#123;</span><br><span class="line">        <span class="comment">//发送请求描述符的消息</span></span><br><span class="line">        AString request;</span><br><span class="line">        request = <span class="string">&quot;DESCRIBE &quot;</span>;</span><br><span class="line">        request.append(mSessionURL);</span><br><span class="line">        request.append(<span class="string">&quot; RTSP/1.0\r\n&quot;</span>);</span><br><span class="line">        request.append(<span class="string">&quot;Accept: application/sdp\r\n&quot;</span>);</span><br><span class="line">        request.append(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">        sp&lt;AMessage&gt; reply = <span class="keyword">new</span> <span class="constructor">AMessage(&#x27;<span class="params">desc</span>&#x27;, <span class="params">this</span>)</span>;</span><br><span class="line">        mConn-&gt;send<span class="constructor">Request(<span class="params">request</span>.<span class="params">c_str</span>()</span>, reply);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        (<span class="keyword">new</span> <span class="constructor">AMessage(&#x27;<span class="params">disc</span>&#x27;, <span class="params">this</span>)</span>)-&gt;post<span class="literal">()</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    break;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里比较简单就是收到答复之后，直接判断结果是OK还是不OK，如果OK那么就发送一个DESCRIBE的请求。我们重点看下，onSendRequest理解这个很重要：<br>在onSendRequest中会对请求加工处理下，比如添加Cseq等操作，然后就会调用send向服务器发送请求。并将请求以Cseq为键码，replay为回复消息的待处理请求队列中。</p>
<figure class="highlight wren"><table><tr><td class="code"><pre><span class="line"><span class="variable">void</span> <span class="title class_">ARTSPConnection</span>::<span class="title function_">onSendRequest</span>(<span class="params">const</span> <span class="params">sp</span>&lt;<span class="params">AMessage</span>&gt; &amp;<span class="params">msg</span>) &#123;</span><br><span class="line">    <span class="variable">sp</span><span class="operator">&lt;</span><span class="title class_">AMessage</span><span class="operator">&gt;</span> <span class="variable">reply</span>;</span><br><span class="line">    <span class="title function_">CHECK</span>(<span class="variable">msg</span><span class="operator">-</span><span class="operator">&gt;</span><span class="title function_">findMessage</span>(<span class="string">&quot;reply&quot;</span>, <span class="operator">&amp;</span><span class="variable">reply</span>));</span><br><span class="line">    <span class="comment">//对请求进行加工处理</span></span><br><span class="line">    <span class="title class_">AString</span> <span class="variable">request</span>;</span><br><span class="line">    <span class="title function_">CHECK</span>(<span class="variable">msg</span><span class="operator">-</span><span class="operator">&gt;</span><span class="title function_">findString</span>(<span class="string">&quot;request&quot;</span>, <span class="operator">&amp;</span><span class="variable">request</span>));</span><br><span class="line">    <span class="comment">// Just in case we need to re-issue the request with proper authentication</span></span><br><span class="line">    <span class="comment">// later, stash it away.</span></span><br><span class="line">    <span class="variable">reply</span><span class="operator">-</span><span class="operator">&gt;</span><span class="title function_">setString</span>(<span class="string">&quot;original-request&quot;</span>, <span class="variable">request</span>.<span class="property">c_str</span>(), <span class="variable">request</span>.<span class="property">size</span>());</span><br><span class="line">    <span class="title function_">addAuthentication</span>(<span class="operator">&amp;</span><span class="variable">request</span>);</span><br><span class="line">    <span class="title function_">addUserAgent</span>(<span class="operator">&amp;</span><span class="variable">request</span>);</span><br><span class="line">    <span class="comment">// Find the boundary between headers and the body.</span></span><br><span class="line">    <span class="variable">ssize_t</span> <span class="variable">i</span> <span class="operator">=</span> <span class="variable">request</span>.<span class="property">find</span>(<span class="string">&quot;<span class="char escape_">\r</span><span class="char escape_">\n</span><span class="char escape_">\r</span><span class="char escape_">\n</span>&quot;</span>);</span><br><span class="line">    <span class="title function_">CHECK_GE</span>(<span class="variable">i</span>, <span class="number">0</span>);</span><br><span class="line">    int32_t <span class="variable">cseq</span> <span class="operator">=</span> <span class="variable">mNextCSeq</span><span class="operator">+</span><span class="operator">+</span>;</span><br><span class="line">    <span class="title class_">AString</span> <span class="variable">cseqHeader</span> <span class="operator">=</span> <span class="string">&quot;CSeq: &quot;</span>;</span><br><span class="line">    <span class="variable">cseqHeader</span>.<span class="property">append</span>(<span class="variable">cseq</span>);</span><br><span class="line">    <span class="variable">cseqHeader</span>.<span class="property">append</span>(<span class="string">&quot;<span class="char escape_">\r</span><span class="char escape_">\n</span>&quot;</span>);</span><br><span class="line">    <span class="variable">request</span>.<span class="property">insert</span>(<span class="variable">cseqHeader</span>, <span class="variable">i</span> <span class="operator">+</span> <span class="number">2</span>);</span><br><span class="line">    <span class="title function_">ALOGV</span>(<span class="string">&quot;request: &#x27;%s&#x27;&quot;</span>, <span class="variable">request</span>.<span class="property">c_str</span>());</span><br><span class="line"></span><br><span class="line">    <span class="variable">size_t</span> <span class="variable">numBytesSent</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="variable">numBytesSent</span> <span class="operator">&lt;</span> <span class="variable">request</span>.<span class="property">size</span>()) &#123;</span><br><span class="line">        <span class="comment">//如果请求还没完全发送结束那么继续发送</span></span><br><span class="line">        <span class="variable">ssize_t</span> <span class="variable">n</span> <span class="operator">=</span> <span class="title function_">send</span>(<span class="variable">mSocket</span>, <span class="variable">request</span>.<span class="property">c_str</span>() <span class="operator">+</span> <span class="variable">numBytesSent</span>,<span class="variable">request</span>.<span class="property">size</span>() <span class="operator">-</span> <span class="variable">numBytesSent</span>, <span class="number">0</span>);&#125;</span><br><span class="line">        <span class="comment">//忽略错误处理代码</span></span><br><span class="line">        <span class="variable">numBytesSent</span> <span class="operator">+</span><span class="operator">=</span> (<span class="variable">size_t</span>)<span class="variable">n</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//将请求添加到mPendingRequests，等待服务器回复</span></span><br><span class="line">    <span class="variable">mPendingRequests</span>.<span class="property">add</span>(<span class="variable">cseq</span>, <span class="variable">reply</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>回到上面提到的notifyResponseListener结合onSendRequest以及findPendingRequest是否看出了整个事件处理的流程？</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">status_t</span> <span class="title">ARTSPConnection::findPendingRequest</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> sp&lt;ARTSPResponse&gt; &amp;response, <span class="type">ssize_t</span> *index)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">    *index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">ssize_t</span> i = response-&gt;mHeaders.<span class="built_in">indexOfKey</span>(<span class="string">&quot;cseq&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (i &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// This is an unsolicited server-&gt;client message.</span></span><br><span class="line">        *index = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">return</span> OK;</span><br><span class="line">    &#125;</span><br><span class="line">    AString value = response-&gt;mHeaders.<span class="built_in">valueAt</span>(i);</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> cseq;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">ParseSingleUnsignedLong</span>(value.<span class="built_in">c_str</span>(), &amp;cseq)) &#123;</span><br><span class="line">        <span class="keyword">return</span> ERROR_MALFORMED;</span><br><span class="line">    &#125;</span><br><span class="line">    i = mPendingRequests.<span class="built_in">indexOfKey</span>(cseq);</span><br><span class="line">    <span class="keyword">if</span> (i &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> -ENOENT;</span><br><span class="line">    &#125;</span><br><span class="line">    *index = i;</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>onSendRequest 会不断将请求放入mPendingRequests中，而每次服务器给出应答的时候会调用notifyResponseListener，notifyResponseListener会从mPendingRequests中取出一个应答消息，并发送消息给MyHandler进行处理，而notifyResponseListener又会阻塞等待下一个服务器的应答信号。</p>
<p>OK我们接下来看下收到‘desc’信号后的处理：</p>
<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line">case <span class="string">&#x27;desc&#x27;</span>:</span><br><span class="line">&#123;</span><br><span class="line">    int32_t result;</span><br><span class="line">    CHECK(<span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;result&quot;</span>, &amp;result));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result == OK) &#123;</span><br><span class="line">        sp&lt;RefBase&gt; obj;</span><br><span class="line">        CHECK(<span class="function"><span class="title">msg</span>-&gt;</span>findObject(<span class="string">&quot;response&quot;</span>, &amp;obj));</span><br><span class="line">        sp&lt;ARTSPResponse&gt; response = static_cast&lt;ARTSPResponse *&gt;(obj.get());</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="title">if</span> (response-&gt;</span><span class="function"><span class="title">mStatusCode</span> == 301 || response-&gt;</span>mStatusCode == <span class="number">302</span>) &#123;</span><br><span class="line">            <span class="comment">//重定向连接</span></span><br><span class="line">            <span class="comment">//............</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="title">if</span> (response-&gt;</span>mStatusCode != <span class="number">200</span>) &#123;</span><br><span class="line">            result = UNKNOWN_ERROR;</span><br><span class="line">        &#125; <span class="function"><span class="title">else</span> <span class="keyword">if</span> (response-&gt;</span>mContent == NULL) &#123;</span><br><span class="line">            result = ERROR_MALFORMED;</span><br><span class="line">            ALOGE(<span class="string">&quot;The response has no content.&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//获得ASessionDescription</span></span><br><span class="line">            mSessionDesc = new ASessionDescription;</span><br><span class="line">            <span class="function"><span class="title">mSessionDesc</span>-&gt;</span><span class="function"><span class="title">setTo</span>(response-&gt;</span><span class="function"><span class="title">mContent</span>-&gt;</span><span class="function"><span class="title">data</span>(),response-&gt;</span><span class="function"><span class="title">mContent</span>-&gt;</span>size());</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="title">if</span> (!mSessionDesc-&gt;</span>isValid()) &#123;</span><br><span class="line">                <span class="comment">//............</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//............</span></span><br><span class="line">                <span class="function"><span class="title">if</span> (mSessionDesc-&gt;</span>countTracks() &lt; <span class="number">2</span>) &#123;</span><br><span class="line">                    <span class="comment">// There&#x27;s no actual tracks in this session.</span></span><br><span class="line">                    <span class="comment">// The first &quot;track&quot; is merely session meta</span></span><br><span class="line">                    <span class="comment">// data.</span></span><br><span class="line">                    ALOGW(<span class="string">&quot;Session doesn&#x27;t contain any playable &quot;</span></span><br><span class="line">                         <span class="string">&quot;tracks. Aborting.&quot;</span>);</span><br><span class="line">                    result = ERROR_UNSUPPORTED;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//这里才是真正要处理的代码</span></span><br><span class="line">                    setupTrack(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    break;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面代码很长我们忽略不重要的，直接看setupTrack。</p>
<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line">void setupTrack(size_t index) &#123;</span><br><span class="line"></span><br><span class="line">    sp&lt;APacketSource&gt; source = new APacketSource(mSessionDesc, index);</span><br><span class="line">    AString url;</span><br><span class="line">    CHECK(<span class="function"><span class="title">mSessionDesc</span>-&gt;</span>findAttribute(index, <span class="string">&quot;a=control&quot;</span>, &amp;url));</span><br><span class="line">    AString trackURL;</span><br><span class="line">    <span class="comment">//获得多媒体文件的Uri</span></span><br><span class="line">    CHECK(MakeURL(mBaseURL.c_str(), url.c_str(), &amp;trackURL));</span><br><span class="line"></span><br><span class="line">    mTracks.push(TrackInfo());</span><br><span class="line">    TrackInfo *info = &amp;mTracks.editItemAt(mTracks.size() - <span class="number">1</span>);</span><br><span class="line">    <span class="comment">//设置uri</span></span><br><span class="line">    <span class="function"><span class="title">info</span>-&gt;</span>mURL = trackURL;</span><br><span class="line">    <span class="comment">//设置APacketSource</span></span><br><span class="line">    <span class="function"><span class="title">info</span>-&gt;</span>mPacketSource = source;</span><br><span class="line">    <span class="function"><span class="title">info</span>-&gt;</span>mUsingInterleavedTCP = <span class="literal">false</span>;</span><br><span class="line">    <span class="function"><span class="title">info</span>-&gt;</span>mFirstSeqNumInSegment = <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="title">info</span>-&gt;</span>mNewSegment = <span class="literal">true</span>;</span><br><span class="line">    <span class="function"><span class="title">info</span>-&gt;</span>mRTPSocket = -<span class="number">1</span>;</span><br><span class="line">    <span class="function"><span class="title">info</span>-&gt;</span>mRTCPSocket = -<span class="number">1</span>;</span><br><span class="line">    <span class="function"><span class="title">info</span>-&gt;</span>mRTPAnchor = <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="title">info</span>-&gt;</span>mNTPAnchorUs = -<span class="number">1</span>;</span><br><span class="line">    <span class="function"><span class="title">info</span>-&gt;</span>mNormalPlayTimeRTP = <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="title">info</span>-&gt;</span>mNormalPlayTimeUs = <span class="number">0</span>ll;</span><br><span class="line"></span><br><span class="line">    unsigned long PT;</span><br><span class="line">    AString formatDesc;</span><br><span class="line">    AString formatParams;</span><br><span class="line">    <span class="function"><span class="title">mSessionDesc</span>-&gt;</span>getFormatType(index, &amp;PT, &amp;formatDesc, &amp;formatParams);</span><br><span class="line"></span><br><span class="line">    int32_t timescale;</span><br><span class="line">    int32_t numChannels;</span><br><span class="line">    ASessionDescription::ParseFormatDesc(formatDesc.c_str(), &amp;timescale, &amp;numChannels);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">info</span>-&gt;</span>mTimeScale = timescale;</span><br><span class="line">    <span class="function"><span class="title">info</span>-&gt;</span>mEOSReceived = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    ALOGV(<span class="string">&quot;track #%zu URL=%s&quot;</span>, mTracks.size(), trackURL.c_str());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//建立SETUP请求</span></span><br><span class="line">    AString request = <span class="string">&quot;SETUP &quot;</span>;</span><br><span class="line">    request.append(trackURL);</span><br><span class="line">    request.append(<span class="string">&quot; RTSP/1.0\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (mTryTCPInterleaving) &#123;</span><br><span class="line">        size_t interleaveIndex = <span class="number">2</span> * (mTracks.size() - <span class="number">1</span>);</span><br><span class="line">        <span class="function"><span class="title">info</span>-&gt;</span>mUsingInterleavedTCP = <span class="literal">true</span>;</span><br><span class="line">        <span class="function"><span class="title">info</span>-&gt;</span>mRTPSocket = interleaveIndex;</span><br><span class="line">        <span class="function"><span class="title">info</span>-&gt;</span>mRTCPSocket = interleaveIndex + <span class="number">1</span>;</span><br><span class="line">        request.append(<span class="string">&quot;Transport: RTP/AVP/TCP;interleaved=&quot;</span>);</span><br><span class="line">        request.append(interleaveIndex);</span><br><span class="line">        request.append(<span class="string">&quot;-&quot;</span>);</span><br><span class="line">        request.append(interleaveIndex + <span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        unsigned rtpPort;</span><br><span class="line">        ARTPConnection::MakePortPair(</span><br><span class="line">                &amp;<span class="function"><span class="title">info</span>-&gt;</span><span class="function"><span class="title">mRTPSocket</span>, &amp;info-&gt;</span>mRTCPSocket, &amp;rtpPort);</span><br><span class="line">        <span class="keyword">if</span> (mUIDValid) &#123;</span><br><span class="line">            HTTPB<span class="function"><span class="title">ase</span>::RegisterSocketUserTag(info-&gt;</span>mRTPSocket, mUID,</span><br><span class="line">                                            (uint32_t)*(uint32_t*) <span class="string">&quot;RTP_&quot;</span>);</span><br><span class="line">            HTTPB<span class="function"><span class="title">ase</span>::RegisterSocketUserTag(info-&gt;</span>mRTCPSocket, mUID,</span><br><span class="line">                                            (uint32_t)*(uint32_t*) <span class="string">&quot;RTP_&quot;</span>);</span><br><span class="line">            HTTPB<span class="function"><span class="title">ase</span>::RegisterSocketUserMark(info-&gt;</span>mRTPSocket, mUID);</span><br><span class="line">            HTTPB<span class="function"><span class="title">ase</span>::RegisterSocketUserMark(info-&gt;</span>mRTCPSocket, mUID);</span><br><span class="line">        &#125;</span><br><span class="line">        request.append(<span class="string">&quot;Transport: RTP/AVP/UDP;unicast;client_port=&quot;</span>);</span><br><span class="line">        request.append(rtpPort);</span><br><span class="line">        request.append(<span class="string">&quot;-&quot;</span>);</span><br><span class="line">        request.append(rtpPort + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    request.append(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (index &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        request.append(<span class="string">&quot;Session: &quot;</span>);</span><br><span class="line">        request.append(mSessionID);</span><br><span class="line">        request.append(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    request.append(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">    sp&lt;AMessage&gt; reply = new AMessage(<span class="string">&#x27;setu&#x27;</span>, this);</span><br><span class="line">    <span class="function"><span class="title">reply</span>-&gt;</span>setSize(<span class="string">&quot;index&quot;</span>, index);</span><br><span class="line">    <span class="function"><span class="title">reply</span>-&gt;</span>setSize(<span class="string">&quot;track-index&quot;</span>, mTracks.size() - <span class="number">1</span>);</span><br><span class="line">    <span class="function"><span class="title">mConn</span>-&gt;</span>sendRequest(request.c_str(), reply);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的逻辑也很简单就是将要获取到的歌曲信息存放到mTracks，并使用sendRequest发起setu请求，sendRequest就不再作详细介绍了，我们直接看下‘setu’返回后的处理：</p>
<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line">case <span class="string">&#x27;setu&#x27;</span>:</span><br><span class="line">&#123;</span><br><span class="line">    size_t index;</span><br><span class="line">    CHECK(<span class="function"><span class="title">msg</span>-&gt;</span>findSize(<span class="string">&quot;index&quot;</span>, &amp;index));</span><br><span class="line">    TrackInfo *track = NULL;</span><br><span class="line">    size_t trackIndex;</span><br><span class="line">    <span class="function"><span class="title">if</span> (msg-&gt;</span>findSize(<span class="string">&quot;track-index&quot;</span>, &amp;trackIndex)) &#123;</span><br><span class="line">        track = &amp;mTracks.editItemAt(trackIndex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    int32_t result;</span><br><span class="line">    CHECK(<span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;result&quot;</span>, &amp;result));</span><br><span class="line">    <span class="keyword">if</span> (result == OK) &#123;</span><br><span class="line">        CHECK(track != NULL);</span><br><span class="line">        sp&lt;RefBase&gt; obj;</span><br><span class="line">        CHECK(<span class="function"><span class="title">msg</span>-&gt;</span>findObject(<span class="string">&quot;response&quot;</span>, &amp;obj));</span><br><span class="line">        sp&lt;ARTSPResponse&gt; response =</span><br><span class="line">            static_cast&lt;ARTSPResponse *&gt;(obj.get());</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="title">if</span> (response-&gt;</span>mStatusCode != <span class="number">200</span>) &#123;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="function"><span class="title">ssize_t</span> i = response-&gt;</span>mHeaders.indexOfKey(<span class="string">&quot;session&quot;</span>);</span><br><span class="line">            CHECK_GE(i, <span class="number">0</span>);</span><br><span class="line">            <span class="comment">//得到SessionID</span></span><br><span class="line">            <span class="function"><span class="title">mSessionID</span> = response-&gt;</span>mHeaders.valueAt(i);</span><br><span class="line">            mKeepAliveTimeoutUs = kDefaultKeepAliveTimeoutUs;</span><br><span class="line">            AString timeoutStr;</span><br><span class="line">            <span class="comment">//........................</span></span><br><span class="line">            sp&lt;AMessage&gt; notify = new AMessage(<span class="string">&#x27;accu&#x27;</span>, this);</span><br><span class="line">            <span class="function"><span class="title">notify</span>-&gt;</span>setSize(<span class="string">&quot;track-index&quot;</span>, trackIndex);</span><br><span class="line">            <span class="function"><span class="title">i</span> = response-&gt;</span>mHeaders.indexOfKey(<span class="string">&quot;transport&quot;</span>);</span><br><span class="line">            CHECK_GE(i, <span class="number">0</span>);</span><br><span class="line">            <span class="function"><span class="title">if</span> (track-&gt;</span><span class="function"><span class="title">mRTPSocket</span> != -1 &amp;&amp; track-&gt;</span>mRTCPSocket != -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="function"><span class="title">if</span> (!track-&gt;</span>mUsingInterleavedTCP) &#123;</span><br><span class="line">                    AS<span class="function"><span class="title">tring</span> transport = response-&gt;</span>mHeaders.valueAt(i);</span><br><span class="line">                    <span class="comment">// We are going to continue even if we were</span></span><br><span class="line">                    <span class="comment">// unable to poke a hole into the firewall...</span></span><br><span class="line">                    pokeAHole(</span><br><span class="line">                            <span class="function"><span class="title">track</span>-&gt;</span>mRTPSocket,</span><br><span class="line">                            <span class="function"><span class="title">track</span>-&gt;</span>mRTCPSocket,</span><br><span class="line">                            transport);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="function"><span class="title">mRTPConn</span>-&gt;</span>addStream(</span><br><span class="line">                        <span class="function"><span class="title">track</span>-&gt;</span><span class="function"><span class="title">mRTPSocket</span>, track-&gt;</span>mRTCPSocket,</span><br><span class="line">                        mSessionDesc, index,</span><br><span class="line">                        <span class="function"><span class="title">notify</span>, track-&gt;</span>mUsingInterleavedTCP);</span><br><span class="line">                mSetupTracksSuccessful = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                result = BAD_VALUE;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上面最重要的就是获取SessionID并调用mRTPConn-&gt;addStream完ARTPConnection中添加一个流，我们看下addStream：</p>
<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line">void ARTPConnection::addStream(</span><br><span class="line">        int rtpSocket, int rtcpSocket,</span><br><span class="line">        const sp&lt;ASessionDescription&gt; &amp;sessionDesc,</span><br><span class="line">        size_t index,</span><br><span class="line">        const sp&lt;AMessage&gt; &amp;notify,</span><br><span class="line">        bool injected) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = new AMessage(kWhatAddStream, this);</span><br><span class="line">    <span class="function"><span class="title">msg</span>-&gt;</span>setInt32(<span class="string">&quot;rtp-socket&quot;</span>, rtpSocket);</span><br><span class="line">    <span class="function"><span class="title">msg</span>-&gt;</span>setInt32(<span class="string">&quot;rtcp-socket&quot;</span>, rtcpSocket);</span><br><span class="line">    <span class="function"><span class="title">msg</span>-&gt;</span>setObject(<span class="string">&quot;session-desc&quot;</span>, sessionDesc);</span><br><span class="line">    <span class="function"><span class="title">msg</span>-&gt;</span>setSize(<span class="string">&quot;index&quot;</span>, index);</span><br><span class="line">    <span class="function"><span class="title">msg</span>-&gt;</span>setMessage(<span class="string">&quot;notify&quot;</span>, notify);</span><br><span class="line">    <span class="function"><span class="title">msg</span>-&gt;</span>setInt32(<span class="string">&quot;injected&quot;</span>, injected);</span><br><span class="line">    <span class="function"><span class="title">msg</span>-&gt;</span>post();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line">case kWhatAddStream:</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">onAddStream</span>(msg);</span><br><span class="line">    break;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void ARTPConnection::on<span class="constructor">AddStream(<span class="params">const</span> <span class="params">sp</span>&lt;AMessage&gt; &amp;<span class="params">msg</span>)</span> &#123;</span><br><span class="line">    <span class="comment">//将Stream信息添加到mStreams</span></span><br><span class="line">    mStreams.push<span class="constructor">_back(StreamInfo()</span>);</span><br><span class="line">    StreamInfo *info = &amp;*--mStreams.<span class="keyword">end</span><span class="literal">()</span>;</span><br><span class="line">    int32_t s;</span><br><span class="line">    <span class="comment">//获得rtp-socket</span></span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">findInt32</span>(<span class="string">&quot;rtp-socket&quot;</span>, &amp;<span class="params">s</span>)</span>);</span><br><span class="line">    info-&gt;mRTPSocket = s;</span><br><span class="line">    <span class="comment">//获得rtcp-socket</span></span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">findInt32</span>(<span class="string">&quot;rtcp-socket&quot;</span>, &amp;<span class="params">s</span>)</span>);</span><br><span class="line">    info-&gt;mRTCPSocket = s;</span><br><span class="line"></span><br><span class="line">    int32_t injected;</span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">findInt32</span>(<span class="string">&quot;injected&quot;</span>, &amp;<span class="params">injected</span>)</span>);</span><br><span class="line"></span><br><span class="line">    info-&gt;mIsInjected = injected;</span><br><span class="line">    <span class="comment">//获得session-desc</span></span><br><span class="line">    sp&lt;RefBase&gt; obj;</span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">findObject</span>(<span class="string">&quot;session-desc&quot;</span>, &amp;<span class="params">obj</span>)</span>);</span><br><span class="line">    info-&gt;mSessionDesc = static_cast&lt;ASessionDescription *&gt;(obj.get<span class="literal">()</span>);</span><br><span class="line"></span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">findSize</span>(<span class="string">&quot;index&quot;</span>, &amp;<span class="params">info</span>-&gt;<span class="params">mIndex</span>)</span>);</span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">findMessage</span>(<span class="string">&quot;notify&quot;</span>, &amp;<span class="params">info</span>-&gt;<span class="params">mNotifyMsg</span>)</span>);</span><br><span class="line"></span><br><span class="line">    info-&gt;mNumRTCPPacketsReceived = <span class="number">0</span>;</span><br><span class="line">    info-&gt;mNumRTPPacketsReceived = <span class="number">0</span>;</span><br><span class="line">    memset(&amp;info-&gt;mRemoteRTCPAddr, <span class="number">0</span>, sizeof(info-&gt;mRemoteRTCPAddr));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发送轮询查询事件</span></span><br><span class="line">    <span class="keyword">if</span> (!injected) &#123;</span><br><span class="line">        post<span class="constructor">PollEvent()</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面代码中重点关注的是postPollEvent：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title class_">ARTPConnection</span>::<span class="title function_">postPollEvent</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (mPollEventPending) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    sp&lt;<span class="title class_">AMessage</span>&gt; msg = <span class="keyword">new</span> <span class="title class_">AMessage</span>(kWhatPollStreams, <span class="variable language_">this</span>);</span><br><span class="line">    msg-&gt;<span class="title function_">post</span>();</span><br><span class="line">    mPollEventPending = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line">case kWhatPollStreams:</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">onPollStreams</span>();</span><br><span class="line">    break;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line">void ARTPConnection::onPollStreams() &#123;</span><br><span class="line">    mPollEventPending = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mStreams.empty()) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    struct timeval tv;</span><br><span class="line">    tv.tv_sec = <span class="number">0</span>;</span><br><span class="line">    tv.tv_usec = kSelectTimeoutUs;</span><br><span class="line"></span><br><span class="line">    fd_set rs;</span><br><span class="line">    FD_ZERO(&amp;rs);</span><br><span class="line"></span><br><span class="line">    int maxSocket = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (List&lt;StreamInfo&gt;::iterator it = mStreams.begin();</span><br><span class="line">         it != mStreams.end(); ++it) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((*it).mIsInjected) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">        FD_SET(<span class="function"><span class="title">it</span>-&gt;</span>mRTPSocket, &amp;rs);</span><br><span class="line">        FD_SET(<span class="function"><span class="title">it</span>-&gt;</span>mRTCPSocket, &amp;rs);</span><br><span class="line">        <span class="function"><span class="title">if</span> (it-&gt;</span>mRTPSocket &gt; maxSocket) &#123;</span><br><span class="line">            <span class="function"><span class="title">maxSocket</span> = it-&gt;</span>mRTPSocket;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="title">if</span> (it-&gt;</span>mRTCPSocket &gt; maxSocket) &#123;</span><br><span class="line">            <span class="function"><span class="title">maxSocket</span> = it-&gt;</span>mRTCPSocket;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (maxSocket == -<span class="number">1</span>) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//选择一个网络请求</span></span><br><span class="line">    int res = select(maxSocket + <span class="number">1</span>, &amp;rs, NULL, NULL, &amp;tv);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (res &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//在这里接收服务器发过来的数据</span></span><br><span class="line">        List&lt;StreamInfo&gt;::iterator it = mStreams.begin();</span><br><span class="line">        <span class="keyword">while</span> (it != mStreams.end()) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((*it).mIsInjected) &#123;</span><br><span class="line">                ++it;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            status_t err = OK;</span><br><span class="line">            <span class="comment">//接受从服务器发来的数据</span></span><br><span class="line">            <span class="function"><span class="title">if</span> (FD_ISSET(it-&gt;</span>mRTPSocket, &amp;rs)) &#123;</span><br><span class="line">                <span class="comment">//调用的是status_t ARTPConnection::receive(StreamInfo *s, bool receiveRTP)</span></span><br><span class="line">                err = receive(&amp;*it, <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//接受从服务器发来的数据</span></span><br><span class="line">            <span class="function"><span class="title">if</span> (err == OK &amp;&amp; FD_ISSET(it-&gt;</span>mRTCPSocket, &amp;rs)) &#123;</span><br><span class="line">                <span class="comment">//调用的是status_t ARTPConnection::receive(StreamInfo *s, bool receiveRTP)</span></span><br><span class="line">                err = receive(&amp;*it, <span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ++it;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    int64_t nowUs = ALooper::GetNowUs();</span><br><span class="line">    <span class="keyword">if</span> (mLastReceiverReportTimeUs &lt;= <span class="number">0</span>|| mLastReceiverReportTimeUs + <span class="number">5000000</span>ll &lt;= nowUs) &#123;</span><br><span class="line">        <span class="comment">//新建一个缓存区</span></span><br><span class="line">        sp&lt;ABuffer&gt; buffer = new ABuffer(kMaxUDPSize);</span><br><span class="line">        List&lt;StreamInfo&gt;::iterator it = mStreams.begin();</span><br><span class="line">        <span class="keyword">while</span> (it != mStreams.end()) &#123;</span><br><span class="line">            StreamInfo *s = &amp;*it;</span><br><span class="line">            <span class="function"><span class="title">if</span> (s-&gt;</span>mIsInjected) &#123;</span><br><span class="line">                ++it;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="title">if</span> (s-&gt;</span>mNumRTCPPacketsReceived == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// We have never received any RTCP packets on this stream,</span></span><br><span class="line">                <span class="comment">// we don&#x27;t even know where to send a report.</span></span><br><span class="line">                ++it;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="title">buffer</span>-&gt;</span>setRange(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="function"><span class="title">for</span> (size_t i = 0; i &lt; s-&gt;</span>mSources.size(); ++i) &#123;</span><br><span class="line">                <span class="function"><span class="title">sp</span>&lt;ARTPSource&gt; source = s-&gt;</span>mSources.valueAt(i);</span><br><span class="line">                <span class="comment">//填充buffer</span></span><br><span class="line">                <span class="function"><span class="title">source</span>-&gt;</span>addReceiverReport(buffer);</span><br><span class="line">                <span class="keyword">if</span> (mFlags &amp; kRegularlyRequestFIR) &#123;</span><br><span class="line">                    <span class="function"><span class="title">source</span>-&gt;</span>addFIR(buffer);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="title">if</span> (buffer-&gt;</span>size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                ALOGV(<span class="string">&quot;Sending RR...&quot;</span>);</span><br><span class="line">                ssize_t n;</span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    <span class="comment">//通過RTCPSocket發送</span></span><br><span class="line">                    <span class="function"><span class="title">n</span> = sendto(s-&gt;</span><span class="function"><span class="title">mRTCPSocket</span>, buffer-&gt;</span><span class="function"><span class="title">data</span>(), buffer-&gt;</span><span class="function"><span class="title">size</span>(), 0,(const struct sockaddr *)&amp;s-&gt;</span><span class="function"><span class="title">mRemoteRTCPAddr</span>, sizeof(s-&gt;</span>mRemoteRTCPAddr));</span><br><span class="line">                &#125; <span class="keyword">while</span> (n &lt; <span class="number">0</span> &amp;&amp; errno == EINTR);</span><br><span class="line">                CHECK_EQ(<span class="function"><span class="title">n</span>, (ssize_t)buffer-&gt;</span>size());</span><br><span class="line">                mLastReceiverReportTimeUs = nowUs;</span><br><span class="line">            &#125;</span><br><span class="line">            ++it;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mStreams.empty()) &#123;</span><br><span class="line">        postPollEvent();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再onPollStreams中会阻塞监听服务器发过来的媒体数据，并调用receive对其进行处理，并定期发送RTCP消息给服务器。</p>
<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line">status_t ARTPConnection::receive(StreamInfo *s, bool receiveRTP) &#123;</span><br><span class="line">    </span><br><span class="line">    ALOGV(<span class="string">&quot;receiving %s&quot;</span>, receiveRTP ? <span class="string">&quot;RTP&quot;</span> : <span class="string">&quot;RTCP&quot;</span>);</span><br><span class="line"></span><br><span class="line">    CHECK(!<span class="function"><span class="title">s</span>-&gt;</span>mIsInjected);</span><br><span class="line"></span><br><span class="line">    sp&lt;ABuffer&gt; buffer = new ABuffer(<span class="number">65536</span>);</span><br><span class="line"></span><br><span class="line">    socklen_t remoteAddrLen =</span><br><span class="line">        (!<span class="function"><span class="title">receiveRTP</span> &amp;&amp; s-&gt;</span>mNumRTCPPacketsReceived == <span class="number">0</span>)</span><br><span class="line">            ? <span class="function"><span class="title">sizeof</span>(s-&gt;</span>mRemoteRTCPAddr) : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    ssize_t nbytes;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">//从服务器接收数据</span></span><br><span class="line">        nbytes = recvfrom(</span><br><span class="line">            <span class="function"><span class="title">receiveRTP</span> ? s-&gt;</span><span class="function"><span class="title">mRTPSocket</span> : s-&gt;</span>mRTCPSocket,</span><br><span class="line">            <span class="function"><span class="title">buffer</span>-&gt;</span><span class="keyword">data</span>(),</span><br><span class="line">            <span class="function"><span class="title">buffer</span>-&gt;</span>capacity(),</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            <span class="function"><span class="title">remoteAddrLen</span> &gt; 0 ? (struct sockaddr *)&amp;s-&gt;</span>mRemoteRTCPAddr : NULL,</span><br><span class="line">            remoteAddrLen &gt; <span class="number">0</span> ? &amp;remoteAddrLen : NULL);</span><br><span class="line">    &#125; <span class="keyword">while</span> (nbytes &lt; <span class="number">0</span> &amp;&amp; errno == EINTR);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nbytes &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        return -ECONNRESET;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">buffer</span>-&gt;</span>setRange(<span class="number">0</span>, nbytes);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ALOGI(&quot;received %d bytes.&quot;, buffer-&gt;size());</span></span><br><span class="line"></span><br><span class="line">    status_t err;</span><br><span class="line">    <span class="comment">//解析RTP 或者 parseRTCP</span></span><br><span class="line">    <span class="keyword">if</span> (receiveRTP) &#123;</span><br><span class="line">        err = parseRTP(s, buffer);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        err = parseRTCP(s, buffer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>receive方法中会调用recvfrom。将数据从服务器中读取到缓存，并调用parseRTP或者parseRTCP对缓存中的数据进行处理</p>
<figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">status_t</span> <span class="title">ARTPConnection::parseRTP</span><span class="params">(StreamInfo *s, <span class="type">const</span> sp&lt;ABuffer&gt; &amp;buffer)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="type">const</span> <span class="type">uint8_t</span> *data = buffer-&gt;<span class="built_in">data</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((data[<span class="number">0</span>] &gt;&gt; <span class="number">6</span>) != <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="comment">// Unsupported version.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (data[<span class="number">0</span>] &amp; <span class="number">0x20</span>) &#123;</span><br><span class="line">        <span class="comment">// Padding present.</span></span><br><span class="line"></span><br><span class="line">        <span class="type">size_t</span> paddingLength = data[size - <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (paddingLength + <span class="number">12</span> &gt; size) &#123;</span><br><span class="line">            <span class="comment">// If we removed this much padding we&#x27;d end up with something</span></span><br><span class="line">            <span class="comment">// that&#x27;s too short to be a valid RTP header.</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        size -= paddingLength;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> numCSRCs = data[<span class="number">0</span>] &amp; <span class="number">0x0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> payloadOffset = <span class="number">12</span> + <span class="number">4</span> * numCSRCs;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (size &lt; payloadOffset) &#123;</span><br><span class="line">        <span class="comment">// Not enough data to fit the basic header and all the CSRC entries.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (data[<span class="number">0</span>] &amp; <span class="number">0x10</span>) &#123;</span><br><span class="line">        <span class="comment">// Header eXtension present.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (size &lt; payloadOffset + <span class="number">4</span>) &#123;</span><br><span class="line">            <span class="comment">// Not enough data to fit the basic header, all CSRC entries</span></span><br><span class="line">            <span class="comment">// and the first 4 bytes of the extension header.</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">const</span> <span class="type">uint8_t</span> *extensionData = &amp;data[payloadOffset];</span><br><span class="line"></span><br><span class="line">        <span class="type">size_t</span> extensionLength =</span><br><span class="line">            <span class="number">4</span> * (extensionData[<span class="number">2</span>] &lt;&lt; <span class="number">8</span> | extensionData[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (size &lt; payloadOffset + <span class="number">4</span> + extensionLength) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        payloadOffset += <span class="number">4</span> + extensionLength;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> srcId = <span class="built_in">u32at</span>(&amp;data[<span class="number">8</span>]);</span><br><span class="line"></span><br><span class="line">    sp&lt;ARTPSource&gt; source = <span class="built_in">findSource</span>(s, srcId);</span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> rtpTime = <span class="built_in">u32at</span>(&amp;data[<span class="number">4</span>]);</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; meta = buffer-&gt;<span class="built_in">meta</span>();</span><br><span class="line">    meta-&gt;<span class="built_in">setInt32</span>(<span class="string">&quot;ssrc&quot;</span>, srcId);</span><br><span class="line">    meta-&gt;<span class="built_in">setInt32</span>(<span class="string">&quot;rtp-time&quot;</span>, rtpTime);</span><br><span class="line">    meta-&gt;<span class="built_in">setInt32</span>(<span class="string">&quot;PT&quot;</span>, data[<span class="number">1</span>] &amp; <span class="number">0x7f</span>);</span><br><span class="line">    meta-&gt;<span class="built_in">setInt32</span>(<span class="string">&quot;M&quot;</span>, data[<span class="number">1</span>] &gt;&gt; <span class="number">7</span>);</span><br><span class="line"></span><br><span class="line">    buffer-&gt;<span class="built_in">setInt32Data</span>(<span class="built_in">u16at</span>(&amp;data[<span class="number">2</span>]));</span><br><span class="line">    buffer-&gt;<span class="built_in">setRange</span>(payloadOffset, size - payloadOffset);</span><br><span class="line">    <span class="comment">//这里十分重要void ARTPSource::processRTPPacket(const sp&lt;ABuffer&gt; &amp;buffer)</span></span><br><span class="line">    source-&gt;<span class="built_in">processRTPPacket</span>(buffer);</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在parsRTP中根据RTP格式对缓存区中的数据进行解析，最后调用ARTPSource::processRTPPacket进行后续处理。</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void ARTPSource::process<span class="constructor">RTPPacket(<span class="params">const</span> <span class="params">sp</span>&lt;ABuffer&gt; &amp;<span class="params">buffer</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (queue<span class="constructor">Packet(<span class="params">buffer</span>)</span><span class="operator"> &amp;&amp; </span>mAssembler != NULL) &#123;</span><br><span class="line">        mAssembler-&gt;on<span class="constructor">PacketReceived(<span class="params">this</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>processRTPPacket中调用Assembler来将数据进行重组，这里最重要的方法是assembleMore</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void ARTPAssembler::on<span class="constructor">PacketReceived(<span class="params">const</span> <span class="params">sp</span>&lt;ARTPSource&gt; &amp;<span class="params">source</span>)</span> &#123;</span><br><span class="line">    AssemblyStatus status;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">//assembleMore</span></span><br><span class="line">        status = assemble<span class="constructor">More(<span class="params">source</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (status<span class="operator"> == </span>WRONG_SEQUENCE_NUMBER) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mFirstFailureTimeUs &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ALooper::<span class="constructor">GetNowUs()</span> - mFirstFailureTimeUs &gt; <span class="number">10000l</span>l) &#123;</span><br><span class="line">                    mFirstFailureTimeUs = -<span class="number">1</span>;</span><br><span class="line">                    <span class="comment">// LOG(VERBOSE) &lt;&lt; &quot;waited too long for packet.&quot;;</span></span><br><span class="line">                    packet<span class="constructor">Lost()</span>;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mFirstFailureTimeUs = ALooper::<span class="constructor">GetNowUs()</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mFirstFailureTimeUs = -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (status<span class="operator"> == </span>NOT_ENOUGH_DATA) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="title class_">ARTPAssembler</span>::<span class="title class_">AssemblyStatus</span> <span class="title class_">AMPEG4AudioAssembler</span>::<span class="title function_">assembleMore</span>(<span class="params"></span></span><br><span class="line"><span class="params">        <span class="keyword">const</span> sp&lt;ARTPSource&gt; &amp;source</span>) &#123;</span><br><span class="line">        <span class="comment">//调用addPacket</span></span><br><span class="line">    <span class="title class_">AssemblyStatus</span> status = <span class="title function_">addPacket</span>(source);</span><br><span class="line">    <span class="keyword">if</span> (status == <span class="variable constant_">MALFORMED_PACKET</span>) &#123;</span><br><span class="line">        mAccessUnitDamaged = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里实际上是对无序的数据包进行排序，并调用submitAccessUnit提交AU数据。</p>
<figure class="highlight livescript"><table><tr><td class="code"><pre><span class="line">ARTPAssembler::AssemblyStatus AMPEG4AudioAssembler::addPacket(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;ARTPSource&gt; &amp;source) &#123;</span><br><span class="line"></span><br><span class="line">    List&lt;sp&lt;ABuffer&gt; &gt; *queue = source-&gt;queue();</span><br><span class="line">    <span class="keyword">if</span> (queue-&gt;empty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> NOT_ENOUGH_DATA;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mNextExpectedSeqNoValid) &#123;</span><br><span class="line">        List&lt;sp&lt;ABuffer&gt; &gt;::iterator <span class="literal">it</span> = queue-&gt;begin();</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">it</span> != queue-&gt;end()) &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="function"><span class="params">((uint32_t)(*<span class="literal">it</span>)-&gt;int32Data() &gt;= mNextExpectedSeqNo)</span> &#123;</span></span><br><span class="line"><span class="function">                <span class="title">break</span>;</span></span><br><span class="line"><span class="function">            &#125;</span></span><br><span class="line"><span class="function">            <span class="title">it</span> = <span class="title">queue</span>-&gt;</span>erase(<span class="literal">it</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (queue-&gt;empty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> NOT_ENOUGH_DATA;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;ABuffer&gt; buffer = *queue-&gt;begin();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mNextExpectedSeqNoValid) &#123;</span><br><span class="line">        mNextExpectedSeqNoValid = <span class="literal">true</span>;</span><br><span class="line">        mNextExpectedSeqNo = (uint32_t)buffer-&gt;int32Data();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((uint32_t)buffer-&gt;int32Data() != mNextExpectedSeqNo) &#123;</span><br><span class="line"><span class="comment">#if VERBOSE</span></span><br><span class="line">        LOG(VERBOSE) &lt;&lt; <span class="string">&quot;Not the sequence number I expected&quot;</span>;</span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line">        <span class="keyword">return</span> WRONG_SEQUENCE_NUMBER;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    uint32_t rtpTime;</span><br><span class="line">    CHECK<span class="function"><span class="params">(buffer-&gt;meta()-&gt;findInt32(<span class="string">&quot;rtp-time&quot;</span>, (int32_t *)&amp;rtpTime))</span>;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    //提交<span class="title">AccessUnit</span></span></span><br><span class="line"><span class="function">    <span class="title">if</span> <span class="params">(mPackets.size() &gt; <span class="number">0</span> &amp;&amp; rtpTime != mAccessUnitRTPTime)</span> &#123;</span></span><br><span class="line"><span class="function">        <span class="title">submitAccessUnit</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">    <span class="title">mAccessUnitRTPTime</span> = <span class="title">rtpTime</span>;</span></span><br><span class="line"><span class="function">    //将缓存添加到<span class="title">mPackets</span></span></span><br><span class="line"><span class="function">    <span class="title">mPackets</span>.<span class="title">push_back</span><span class="params">(buffer)</span>;</span></span><br><span class="line"><span class="function">    <span class="title">queue</span>-&gt;</span>erase(queue-&gt;begin());</span><br><span class="line">    ++mNextExpectedSeqNo;</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>submitAccessUnit中回调‘accu’，交给MyHandler处理</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void AMPEG4AudioAssembler::submit<span class="constructor">AccessUnit()</span> &#123;</span><br><span class="line">    <span class="constructor">CHECK(!<span class="params">mPackets</span>.<span class="params">empty</span>()</span>);</span><br><span class="line"></span><br><span class="line">#<span class="keyword">if</span> VERBOSE</span><br><span class="line">    <span class="constructor">LOG(VERBOSE)</span> &lt;&lt; <span class="string">&quot;Access unit complete (&quot;</span> &lt;&lt; mPackets.size<span class="literal">()</span> &lt;&lt; <span class="string">&quot; packets)&quot;</span>;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    sp&lt;ABuffer&gt; accessUnit = <span class="constructor">MakeCompoundFromPackets(<span class="params">mPackets</span>)</span>;</span><br><span class="line">    accessUnit = remove<span class="constructor">LATMFraming(<span class="params">accessUnit</span>)</span>;</span><br><span class="line">    <span class="constructor">CopyTimes(<span class="params">accessUnit</span>, <span class="operator">*</span><span class="params">mPackets</span>.<span class="params">begin</span>()</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mAccessUnitDamaged) &#123;</span><br><span class="line">        accessUnit-&gt;meta<span class="literal">()</span>-&gt;set<span class="constructor">Int32(<span class="string">&quot;damaged&quot;</span>, <span class="params">true</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mPackets.clear<span class="literal">()</span>;</span><br><span class="line">    mAccessUnitDamaged = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">//回调‘accu’</span></span><br><span class="line">    sp&lt;AMessage&gt; msg = mNotifyMsg-&gt;dup<span class="literal">()</span>;</span><br><span class="line">    msg-&gt;set<span class="constructor">Buffer(<span class="string">&quot;access-unit&quot;</span>, <span class="params">accessUnit</span>)</span>;</span><br><span class="line">    msg-&gt;post<span class="literal">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line">case <span class="string">&#x27;accu&#x27;</span>:</span><br><span class="line">&#123;</span><br><span class="line">    int32_t timeUpdate;</span><br><span class="line">    <span class="function"><span class="title">if</span> (msg-&gt;</span>findInt32(<span class="string">&quot;time-update&quot;</span>, &amp;timeUpdate) &amp;&amp; timeUpdate) &#123;</span><br><span class="line">        size_t trackIndex;</span><br><span class="line">        CHECK(<span class="function"><span class="title">msg</span>-&gt;</span>findSize(<span class="string">&quot;track-index&quot;</span>, &amp;trackIndex));</span><br><span class="line"></span><br><span class="line">        uint32_t rtpTime;</span><br><span class="line">        uint64_t ntpTime;</span><br><span class="line">        CHECK(<span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;rtp-time&quot;</span>, (int32_t *)&amp;rtpTime));</span><br><span class="line">        CHECK(<span class="function"><span class="title">msg</span>-&gt;</span>findInt64(<span class="string">&quot;ntp-time&quot;</span>, (int64_t *)&amp;ntpTime));</span><br><span class="line"></span><br><span class="line">        onTimeUpdate(trackIndex, rtpTime, ntpTime);</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    int32_t first;</span><br><span class="line">    <span class="function"><span class="title">if</span> (msg-&gt;</span>findInt32(<span class="string">&quot;first-rtcp&quot;</span>, &amp;first)) &#123;</span><br><span class="line">        mReceivedFirstRTCPPacket = <span class="literal">true</span>;</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">if</span> (msg-&gt;</span>findInt32(<span class="string">&quot;first-rtp&quot;</span>, &amp;first)) &#123;</span><br><span class="line">        mReceivedFirstRTPPacket = <span class="literal">true</span>;</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ++mNumAccessUnitsReceived;</span><br><span class="line">    postAccessUnitTimeoutCheck();</span><br><span class="line"></span><br><span class="line">    size_t trackIndex;</span><br><span class="line">    CHECK(<span class="function"><span class="title">msg</span>-&gt;</span>findSize(<span class="string">&quot;track-index&quot;</span>, &amp;trackIndex));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (trackIndex &gt;= mTracks.size()) &#123;</span><br><span class="line">        ALOGV(<span class="string">&quot;late packets ignored.&quot;</span>);</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    TrackInfo *track = &amp;mTracks.editItemAt(trackIndex);</span><br><span class="line"></span><br><span class="line">    int32_t eos;</span><br><span class="line">    <span class="function"><span class="title">if</span> (msg-&gt;</span>findInt32(<span class="string">&quot;eos&quot;</span>, &amp;eos)) &#123;</span><br><span class="line">        ALOGI(<span class="string">&quot;received BYE on track index %zu&quot;</span>, trackIndex);</span><br><span class="line">        <span class="keyword">if</span> (!mAllTracksHaveTime &amp;&amp; dataReceivedOnAllChannels()) &#123;</span><br><span class="line">            ALOGI(<span class="string">&quot;No time established =&gt; fake existing data&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="title">track</span>-&gt;</span>mEOSReceived = <span class="literal">true</span>;</span><br><span class="line">            mTryFakeRTCP = <span class="literal">true</span>;</span><br><span class="line">            mReceivedFirstRTCPPacket = <span class="literal">true</span>;</span><br><span class="line">            fakeTimestamps();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            postQueueEOS(trackIndex, ERROR_END_OF_STREAM);</span><br><span class="line">        &#125;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;ABuffer&gt; accessUnit;</span><br><span class="line">    <span class="comment">//取出accessUnit</span></span><br><span class="line">    CHECK(<span class="function"><span class="title">msg</span>-&gt;</span>findBuffer(<span class="string">&quot;access-unit&quot;</span>, &amp;accessUnit));</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">uint32_t</span> seqNum = (uint32_t)accessUnit-&gt;</span>int32Data();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mSeekPending) &#123;</span><br><span class="line">        ALOGV(<span class="string">&quot;we&#x27;re seeking, dropping stale packet.&quot;</span>);</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">if</span> (seqNum &lt; track-&gt;</span>mFirstSeqNumInSegment) &#123;</span><br><span class="line">        ALOGV(<span class="string">&quot;dropping stale access-unit (%d &lt; %d)&quot;</span>,</span><br><span class="line">             <span class="function"><span class="title">seqNum</span>, track-&gt;</span>mFirstSeqNumInSegment);</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">if</span> (track-&gt;</span>mNewSegment) &#123;</span><br><span class="line">        <span class="function"><span class="title">track</span>-&gt;</span>mNewSegment = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//调用onAccessUnitComplete</span></span><br><span class="line">    onAccessUnitComplete(trackIndex, accessUnit);</span><br><span class="line">    break;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>‘accu’取出AU数据后调用onAccessUnitComplete进行处理，我们接下来看下这部分逻辑：</p>
<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line">void onAccessUnitComplete(</span><br><span class="line">        int32_t trackIndex, const sp&lt;ABuffer&gt; &amp;accessUnit) &#123;</span><br><span class="line">    ALOGV(<span class="string">&quot;onAccessUnitComplete track %d&quot;</span>, trackIndex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!mPlayResponseParsed)&#123;</span><br><span class="line">        ALOGI(<span class="string">&quot;play response is not parsed, storing accessunit&quot;</span>);</span><br><span class="line">        TrackInfo *track = &amp;mTracks.editItemAt(trackIndex);</span><br><span class="line">        <span class="function"><span class="title">track</span>-&gt;</span>mPackets.push_back(accessUnit);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    handleFirstAccessUnit();</span><br><span class="line"></span><br><span class="line">    TrackInfo *track = &amp;mTracks.editItemAt(trackIndex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mAllTracksHaveTime) &#123;</span><br><span class="line">        ALOGV(<span class="string">&quot;storing accessUnit, no time established yet&quot;</span>);</span><br><span class="line">        <span class="function"><span class="title">track</span>-&gt;</span>mPackets.push_back(accessUnit);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">while</span> (!track-&gt;</span>mPackets.empty()) &#123;</span><br><span class="line">        <span class="function"><span class="title">sp</span>&lt;ABuffer&gt; accessUnit = *track-&gt;</span>mPackets.begin();</span><br><span class="line">        <span class="function"><span class="title">track</span>-&gt;</span><span class="function"><span class="title">mPackets</span>.erase(track-&gt;</span>mPackets.begin());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (addMediaTimestamp(trackIndex, track, accessUnit)) &#123;</span><br><span class="line">            <span class="comment">//postQueueAccessUnit</span></span><br><span class="line">            postQueueAccessUnit(trackIndex, accessUnit);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (addMediaTimestamp(trackIndex, track, accessUnit)) &#123;</span><br><span class="line">        postQueueAccessUnit(trackIndex, accessUnit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">if</span> (track-&gt;</span>mEOSReceived) &#123;</span><br><span class="line">        postQueueEOS(trackIndex, ERROR_END_OF_STREAM);</span><br><span class="line">        <span class="function"><span class="title">track</span>-&gt;</span>mEOSReceived = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line">void postQueueAccessUnit(</span><br><span class="line">        size_t trackIndex, const sp&lt;ABuffer&gt; &amp;accessUnit) &#123;</span><br><span class="line">    <span class="function"><span class="title">sp</span>&lt;AMessage&gt; msg = mNotify-&gt;</span>dup();</span><br><span class="line">    <span class="function"><span class="title">msg</span>-&gt;</span>setInt32(<span class="string">&quot;what&quot;</span>, kWhatAccessUnit);</span><br><span class="line">    <span class="function"><span class="title">msg</span>-&gt;</span>setSize(<span class="string">&quot;trackIndex&quot;</span>, trackIndex);</span><br><span class="line">    <span class="function"><span class="title">msg</span>-&gt;</span>setBuffer(<span class="string">&quot;accessUnit&quot;</span>, accessUnit);</span><br><span class="line">    <span class="function"><span class="title">msg</span>-&gt;</span>post();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在RTSPSource中调用AnotherPacketSource  queueAccessUnit(accessUnit)</p>
<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line">case MyHandler::kWhatAccessUnit:</span><br><span class="line">&#123;</span><br><span class="line">    size_t trackIndex;</span><br><span class="line">    CHECK(<span class="function"><span class="title">msg</span>-&gt;</span>findSize(<span class="string">&quot;trackIndex&quot;</span>, &amp;trackIndex));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mTSParser == NULL) &#123;</span><br><span class="line">        CHECK_LT(trackIndex, mTracks.size());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        CHECK_EQ(trackIndex, <span class="number">0</span>u);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;ABuffer&gt; accessUnit;</span><br><span class="line">    CHECK(<span class="function"><span class="title">msg</span>-&gt;</span>findBuffer(<span class="string">&quot;accessUnit&quot;</span>, &amp;accessUnit));</span><br><span class="line"></span><br><span class="line">    int32_t damaged;</span><br><span class="line">    <span class="function"><span class="title">if</span> (accessUnit-&gt;</span><span class="function"><span class="title">meta</span>()-&gt;</span>findInt32(<span class="string">&quot;damaged&quot;</span>, &amp;damaged)</span><br><span class="line">            &amp;&amp; damaged) &#123;</span><br><span class="line">        ALOGI(<span class="string">&quot;dropping damaged access unit.&quot;</span>);</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mTSParser != NULL) &#123;</span><br><span class="line">        size_t offset = <span class="number">0</span>;</span><br><span class="line">        status_t err = OK;</span><br><span class="line">        <span class="function"><span class="title">while</span> (offset + 188 &lt;= accessUnit-&gt;</span>size()) &#123;</span><br><span class="line">            <span class="function"><span class="title">err</span> = mTSParser-&gt;</span>feedTSPacket(</span><br><span class="line">                    <span class="function"><span class="title">accessUnit</span>-&gt;</span><span class="keyword">data</span>() + offset, <span class="number">188</span>);</span><br><span class="line">            <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            offset += <span class="number">188</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="title">if</span> (offset &lt; accessUnit-&gt;</span>size()) &#123;</span><br><span class="line">            err = ERROR_MALFORMED;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">            sp&lt;AnotherPacketSource&gt; source = getSource(<span class="literal">false</span> <span class="comment">/* audio */</span>);</span><br><span class="line">            <span class="keyword">if</span> (source != NULL) &#123;</span><br><span class="line">                <span class="function"><span class="title">source</span>-&gt;</span>signalEOS(err);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            source = getSource(<span class="literal">true</span> <span class="comment">/* audio */</span>);</span><br><span class="line">            <span class="keyword">if</span> (source != NULL) &#123;</span><br><span class="line">                <span class="function"><span class="title">source</span>-&gt;</span>signalEOS(err);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    TrackInfo *info = &amp;mTracks.editItemAt(trackIndex);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">sp</span>&lt;AnotherPacketSource&gt; source = info-&gt;</span>mSource;</span><br><span class="line">    <span class="keyword">if</span> (source != NULL) &#123;</span><br><span class="line">        uint32_t rtpTime;</span><br><span class="line">        CHECK(<span class="function"><span class="title">accessUnit</span>-&gt;</span><span class="function"><span class="title">meta</span>()-&gt;</span>findInt32(<span class="string">&quot;rtp-time&quot;</span>, (int32_t *)&amp;rtpTime));</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="title">if</span> (!info-&gt;</span>mNPTMappingValid) &#123;</span><br><span class="line">            <span class="comment">// This is a live stream, we didn&#x27;t receive any normal</span></span><br><span class="line">            <span class="comment">// playtime mapping. We won&#x27;t map to npt time.</span></span><br><span class="line">            <span class="function"><span class="title">source</span>-&gt;</span>queueAccessUnit(accessUnit);</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        int64_t nptUs =</span><br><span class="line">            ((<span class="function"><span class="title">double</span>)rtpTime - (double)info-&gt;</span>mRTPTime)</span><br><span class="line">                / <span class="function"><span class="title">info</span>-&gt;</span>mTimeScale</span><br><span class="line">                * <span class="number">1000000</span>ll</span><br><span class="line">                + <span class="function"><span class="title">info</span>-&gt;</span>mNormalPlaytimeUs;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="title">accessUnit</span>-&gt;</span><span class="function"><span class="title">meta</span>()-&gt;</span>setInt64(<span class="string">&quot;timeUs&quot;</span>, nptUs);</span><br><span class="line">        <span class="comment">//。。。。。。。。。。。。。。。</span></span><br><span class="line">        <span class="function"><span class="title">source</span>-&gt;</span>queueAccessUnit(accessUnit);</span><br><span class="line">    &#125;</span><br><span class="line">    break;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>queueAccessUnit(accessUnit);将AU数据存放到AnotherPacketSource 的mBuffers中供解码器解码播放：</p>
<figure class="highlight livescript"><table><tr><td class="code"><pre><span class="line"><span class="literal">void</span> AnotherPacketSource::queueAccessUnit(<span class="keyword">const</span> sp&lt;ABuffer&gt; &amp;buffer) &#123;</span><br><span class="line">    int32_t damaged;</span><br><span class="line">    <span class="keyword">if</span> <span class="function"><span class="params">(buffer-&gt;meta()-&gt;findInt32(<span class="string">&quot;damaged&quot;</span>, &amp;damaged) &amp;&amp; damaged)</span> &#123;</span></span><br><span class="line"><span class="function">        // <span class="title">LOG</span><span class="params">(VERBOSE)</span> &lt;&lt; &quot;<span class="title">discarding</span> <span class="title">damaged</span> <span class="title">AU</span>&quot;;</span></span><br><span class="line"><span class="function">        <span class="title">return</span>;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="title">Mutex</span>::<span class="title">Autolock</span> <span class="title">autoLock</span><span class="params">(mLock)</span>;</span></span><br><span class="line"><span class="function">    <span class="title">mBuffers</span>.<span class="title">push_back</span><span class="params">(buffer)</span>;</span></span><br><span class="line"><span class="function">    <span class="title">mCondition</span>.<span class="title">signal</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="title">int32_t</span> <span class="title">discontinuity</span>;</span></span><br><span class="line"><span class="function">    <span class="title">if</span> <span class="params">(buffer-&gt;meta()-&gt;findInt32(<span class="string">&quot;discontinuity&quot;</span>, &amp;discontinuity))</span>&#123;</span></span><br><span class="line"><span class="function">        <span class="title">ALOGV</span><span class="params">(<span class="string">&quot;queueing a discontinuity with queueAccessUnit&quot;</span>)</span>;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">        <span class="title">mLastQueuedTimeUs</span> = 0<span class="title">ll</span>;</span></span><br><span class="line"><span class="function">        <span class="title">mEOSResult</span> = <span class="title">OK</span>;</span></span><br><span class="line"><span class="function">        <span class="title">mLatestEnqueuedMeta</span> = <span class="title">NULL</span>;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">        <span class="title">mDiscontinuitySegments</span>.<span class="title">push_back</span><span class="params">(DiscontinuitySegment())</span>;</span></span><br><span class="line"><span class="function">        <span class="title">return</span>;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="title">int64_t</span> <span class="title">lastQueuedTimeUs</span>;</span></span><br><span class="line"><span class="function">    <span class="title">CHECK</span><span class="params">(buffer-&gt;meta()-&gt;findInt64(<span class="string">&quot;timeUs&quot;</span>, &amp;lastQueuedTimeUs))</span>;</span></span><br><span class="line"><span class="function">    <span class="title">mLastQueuedTimeUs</span> = <span class="title">lastQueuedTimeUs</span>;</span></span><br><span class="line"><span class="function">    <span class="title">ALOGV</span><span class="params">(<span class="string">&quot;queueAccessUnit timeUs=%&quot;</span> PRIi64 <span class="string">&quot; us (%.2f secs)&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">            mLastQueuedTimeUs, mLastQueuedTimeUs / <span class="number">1E</span>6)</span>;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    // <span class="title">CHECK</span><span class="params">(!mDiscontinuitySegments.empty())</span>;</span></span><br><span class="line"><span class="function">    <span class="title">DiscontinuitySegment</span> &amp;<span class="title">tailSeg</span> = *<span class="params">(--mDiscontinuitySegments.end())</span>;</span></span><br><span class="line"><span class="function">    <span class="title">if</span> <span class="params">(lastQueuedTimeUs &gt; tailSeg.mMaxEnqueTimeUs)</span> &#123;</span></span><br><span class="line"><span class="function">        <span class="title">tailSeg</span>.<span class="title">mMaxEnqueTimeUs</span> = <span class="title">lastQueuedTimeUs</span>;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">    <span class="title">if</span> <span class="params">(tailSeg.mMaxDequeTimeUs == -<span class="number">1</span>)</span> &#123;</span></span><br><span class="line"><span class="function">        <span class="title">tailSeg</span>.<span class="title">mMaxDequeTimeUs</span> = <span class="title">lastQueuedTimeUs</span>;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="title">if</span> <span class="params">(mLatestEnqueuedMeta == NULL)</span> &#123;</span></span><br><span class="line"><span class="function">        <span class="title">mLatestEnqueuedMeta</span> = <span class="title">buffer</span>-&gt;</span>meta<span class="function"><span class="params">()</span>-&gt;</span>dup();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        int64_t latestTimeUs = <span class="number">0</span>;</span><br><span class="line">        int64_t frameDeltaUs = <span class="number">0</span>;</span><br><span class="line">        CHECK(mLatestEnqueuedMeta-&gt;findInt64(<span class="string">&quot;timeUs&quot;</span>, &amp;latestTimeUs));</span><br><span class="line">        <span class="keyword">if</span> (lastQueuedTimeUs &gt; latestTimeUs) &#123;</span><br><span class="line">            mLatestEnqueuedMeta = buffer-&gt;meta<span class="function"><span class="params">()</span>-&gt;</span>dup();</span><br><span class="line">            frameDeltaUs = lastQueuedTimeUs - latestTimeUs;</span><br><span class="line">            mLatestEnqueuedMeta-&gt;setInt64(<span class="string">&quot;durationUs&quot;</span>, frameDeltaUs);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!mLatestEnqueuedMeta-&gt;findInt64(<span class="string">&quot;durationUs&quot;</span>, &amp;frameDeltaUs)) &#123;</span><br><span class="line">            <span class="regexp">// For B frames</span></span><br><span class="line"><span class="regexp">            frameDeltaUs = latestTimeUs - lastQueuedTimeUs;</span></span><br><span class="line"><span class="regexp">            mLatestEnqueuedMeta-&gt;setInt64(&quot;durationUs&quot;, frameDeltaUs);</span></span><br><span class="line"><span class="regexp">        &#125;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>

<p>开始播放流程，这部分和介绍HLS的时候是重复的，方便查看，所以粘贴了过来，大体的任务就是初始化解码器，然后开始从输入缓冲区往解码器中添加数据。</p>
<figure class="highlight livescript"><table><tr><td class="code"><pre><span class="line"><span class="literal">void</span> NuPlayer::start() &#123;</span><br><span class="line">    <span class="function"><span class="params">(<span class="keyword">new</span> AMessage(kWhatStart, this))</span>-&gt;</span>post();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight actionscript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> kWhatStart:</span><br><span class="line">&#123;</span><br><span class="line">    ALOGV(<span class="string">&quot;kWhatStart&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (mStarted) &#123;</span><br><span class="line">        <span class="comment">//...............</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        onStart();</span><br><span class="line">    &#125;</span><br><span class="line">    mPausedByClient = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void NuPlayer::on<span class="constructor">Start(<span class="params">int64_t</span> <span class="params">startPositionUs</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!mSourceStarted) &#123;</span><br><span class="line">        mSourceStarted = <span class="literal">true</span>;</span><br><span class="line">        mSource-&gt;start<span class="literal">()</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mOffloadAudio = <span class="literal">false</span>;</span><br><span class="line">    mAudioEOS = <span class="literal">false</span>;</span><br><span class="line">    mVideoEOS = <span class="literal">false</span>;</span><br><span class="line">    mStarted = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    uint32_t flags = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    sp&lt;MetaData&gt; audioMeta = mSource-&gt;get<span class="constructor">FormatMeta(<span class="params">true</span> <span class="operator">/</span><span class="operator">*</span> <span class="params">audio</span> <span class="operator">*</span><span class="operator">/</span>)</span>;</span><br><span class="line">    audio_stream_type_t streamType = AUDIO_STREAM_MUSIC;</span><br><span class="line">    <span class="keyword">if</span> (mAudioSink != NULL) &#123;</span><br><span class="line">        streamType = mAudioSink-&gt;get<span class="constructor">AudioStreamType()</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; videoFormat = mSource-&gt;get<span class="constructor">Format(<span class="params">false</span> <span class="operator">/</span><span class="operator">*</span> <span class="params">audio</span> <span class="operator">*</span><span class="operator">/</span>)</span>;</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; notify = <span class="keyword">new</span> <span class="constructor">AMessage(<span class="params">kWhatRendererNotify</span>, <span class="params">this</span>)</span>;</span><br><span class="line">    ++mRendererGeneration;</span><br><span class="line">    notify-&gt;set<span class="constructor">Int32(<span class="string">&quot;generation&quot;</span>, <span class="params">mRendererGeneration</span>)</span>;</span><br><span class="line">    mRenderer = <span class="keyword">new</span> <span class="constructor">Renderer(<span class="params">mAudioSink</span>, <span class="params">notify</span>, <span class="params">flags</span>)</span>;</span><br><span class="line">    mRendererLooper = <span class="keyword">new</span> ALooper;</span><br><span class="line">    mRendererLooper-&gt;set<span class="constructor">Name(<span class="string">&quot;NuPlayerRenderer&quot;</span>)</span>;</span><br><span class="line">    mRendererLooper-&gt;start(<span class="literal">false</span>, <span class="literal">false</span>, ANDROID_PRIORITY_AUDIO);</span><br><span class="line">    mRendererLooper-&gt;register<span class="constructor">Handler(<span class="params">mRenderer</span>)</span>;</span><br><span class="line"></span><br><span class="line">    status_t err = mRenderer-&gt;set<span class="constructor">PlaybackSettings(<span class="params">mPlaybackSettings</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">float</span> rate = get<span class="constructor">FrameRate()</span>;</span><br><span class="line">    <span class="keyword">if</span> (rate &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        mRenderer-&gt;set<span class="constructor">VideoFrameRate(<span class="params">rate</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mVideoDecoder != NULL) &#123;</span><br><span class="line">        mVideoDecoder-&gt;set<span class="constructor">Renderer(<span class="params">mRenderer</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mAudioDecoder != NULL) &#123;</span><br><span class="line">        mAudioDecoder-&gt;set<span class="constructor">Renderer(<span class="params">mRenderer</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    post<span class="constructor">ScanSources()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>紧接着我们看下初始化编码器部分：</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void NuPlayer::post<span class="constructor">ScanSources()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mScanSourcesPending) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> <span class="constructor">AMessage(<span class="params">kWhatScanSources</span>, <span class="params">this</span>)</span>;</span><br><span class="line">    msg-&gt;set<span class="constructor">Int32(<span class="string">&quot;generation&quot;</span>, <span class="params">mScanSourcesGeneration</span>)</span>;</span><br><span class="line">    msg-&gt;post<span class="literal">()</span>;</span><br><span class="line">    mScanSourcesPending = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> kWhatScanSources:</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int32_t</span> generation;</span><br><span class="line"></span><br><span class="line">    mScanSourcesPending = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> mHadAnySourcesBefore =</span><br><span class="line">        (mAudioDecoder != <span class="literal">NULL</span>) || (mVideoDecoder != <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// initialize video before audio because successful initialization of</span></span><br><span class="line">    <span class="comment">// video may change deep buffer mode of audio.</span></span><br><span class="line">    <span class="keyword">if</span> (mSurface != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">instantiateDecoder</span>(<span class="literal">false</span>, &amp;mVideoDecoder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Don&#x27;t try to re-open audio sink if there&#x27;s an existing decoder.</span></span><br><span class="line">    <span class="keyword">if</span> (mAudioSink != <span class="literal">NULL</span> &amp;&amp; mAudioDecoder == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">instantiateDecoder</span>(<span class="literal">true</span>, &amp;mAudioDecoder);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">status_t NuPlayer::instantiate<span class="constructor">Decoder(<span class="params">bool</span> <span class="params">audio</span>, <span class="params">sp</span>&lt;DecoderBase&gt; <span class="operator">*</span><span class="params">decoder</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取格式</span></span><br><span class="line">    sp&lt;AMessage&gt; format = mSource-&gt;get<span class="constructor">Format(<span class="params">audio</span>)</span>;</span><br><span class="line">    format-&gt;set<span class="constructor">Int32(<span class="string">&quot;priority&quot;</span>, 0 <span class="operator">/</span><span class="operator">*</span> <span class="params">realtime</span> <span class="operator">*</span><span class="operator">/</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (audio) &#123;</span><br><span class="line">        sp&lt;AMessage&gt; notify = <span class="keyword">new</span> <span class="constructor">AMessage(<span class="params">kWhatAudioNotify</span>, <span class="params">this</span>)</span>;</span><br><span class="line">        ++mAudioDecoderGeneration;</span><br><span class="line">        notify-&gt;set<span class="constructor">Int32(<span class="string">&quot;generation&quot;</span>, <span class="params">mAudioDecoderGeneration</span>)</span>;</span><br><span class="line">        determine<span class="constructor">AudioModeChange()</span>;</span><br><span class="line">        <span class="keyword">if</span> (mOffloadAudio) &#123;</span><br><span class="line">          <span class="comment">//....................</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            *decoder = <span class="keyword">new</span> <span class="constructor">Decoder(<span class="params">notify</span>, <span class="params">mSource</span>, <span class="params">mPID</span>, <span class="params">mRenderer</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sp&lt;AMessage&gt; notify = <span class="keyword">new</span> <span class="constructor">AMessage(<span class="params">kWhatVideoNotify</span>, <span class="params">this</span>)</span>;</span><br><span class="line">        ++mVideoDecoderGeneration;</span><br><span class="line">        notify-&gt;set<span class="constructor">Int32(<span class="string">&quot;generation&quot;</span>, <span class="params">mVideoDecoderGeneration</span>)</span>;</span><br><span class="line">        *decoder = <span class="keyword">new</span> <span class="constructor">Decoder(<span class="params">notify</span>, <span class="params">mSource</span>, <span class="params">mPID</span>, <span class="params">mRenderer</span>, <span class="params">mSurface</span>, <span class="params">mCCDecoder</span>)</span>;</span><br><span class="line">        <span class="comment">//...........................</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//解码器初始化</span></span><br><span class="line">    (*decoder)-&gt;init<span class="literal">()</span>;</span><br><span class="line">    <span class="comment">//配置解码器</span></span><br><span class="line">    (*decoder)-&gt;configure(format);</span><br><span class="line">    <span class="comment">//.........</span></span><br><span class="line">    return OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里创建出解码器并初始化它。</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void NuPlayer::DecoderBase::configure(const sp&lt;AMessage&gt; &amp;format) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> <span class="constructor">AMessage(<span class="params">kWhatConfigure</span>, <span class="params">this</span>)</span>;</span><br><span class="line">    msg-&gt;set<span class="constructor">Message(<span class="string">&quot;format&quot;</span>, <span class="params">format</span>)</span>;</span><br><span class="line">    msg-&gt;post<span class="literal">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void NuPlayer::DecoderBase::init<span class="literal">()</span> &#123;</span><br><span class="line">    mDecoderLooper-&gt;register<span class="constructor">Handler(<span class="params">this</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void NuPlayer::Decoder::on<span class="constructor">Configure(<span class="params">const</span> <span class="params">sp</span>&lt;AMessage&gt; &amp;<span class="params">format</span>)</span> &#123;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">//创建MediaCodec</span></span><br><span class="line">    mCodec = MediaCodec::<span class="constructor">CreateByType(<span class="params">mCodecLooper</span>, <span class="params">mime</span>.<span class="params">c_str</span>()</span>, <span class="literal">false</span> <span class="comment">/* encoder */</span>, NULL <span class="comment">/* err */</span>, mPid);</span><br><span class="line">    <span class="comment">//配置MediaCodec</span></span><br><span class="line">    err = mCodec-&gt;configure(format, mSurface, NULL <span class="comment">/* crypto */</span>, <span class="number">0</span> <span class="comment">/* flags */</span>);</span><br><span class="line">    <span class="comment">//如果是视频文件则设置宽高</span></span><br><span class="line">    <span class="keyword">if</span> (!mIsAudio) &#123;</span><br><span class="line">        int32_t width, height;</span><br><span class="line">        <span class="keyword">if</span> (mOutputFormat-&gt;find<span class="constructor">Int32(<span class="string">&quot;width&quot;</span>, &amp;<span class="params">width</span>)</span>&amp;&amp; mOutputFormat-&gt;find<span class="constructor">Int32(<span class="string">&quot;height&quot;</span>, &amp;<span class="params">height</span>)</span>) &#123;</span><br><span class="line">            mStats-&gt;set<span class="constructor">Int32(<span class="string">&quot;width&quot;</span>, <span class="params">width</span>)</span>;</span><br><span class="line">            mStats-&gt;set<span class="constructor">Int32(<span class="string">&quot;height&quot;</span>, <span class="params">height</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//启动MediaCodec</span></span><br><span class="line">    err = mCodec-&gt;start<span class="literal">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">sp&lt;MediaCodec&gt; MediaCodec::<span class="constructor">CreateByType(<span class="params">const</span> <span class="params">sp</span>&lt;ALooper&gt; &amp;<span class="params">looper</span>, <span class="params">const</span> <span class="params">char</span> <span class="operator">*</span><span class="params">mime</span>, <span class="params">bool</span> <span class="params">encoder</span>, <span class="params">status_t</span> <span class="operator">*</span><span class="params">err</span>, <span class="params">pid_t</span> <span class="params">pid</span>)</span> &#123;</span><br><span class="line">    sp&lt;MediaCodec&gt; codec = <span class="keyword">new</span> <span class="constructor">MediaCodec(<span class="params">looper</span>, <span class="params">pid</span>)</span>;</span><br><span class="line">    const status_t ret = codec-&gt;init(mime, <span class="literal">true</span> <span class="comment">/* nameIsType */</span>, encoder);</span><br><span class="line">    return ret<span class="operator"> == </span>OK ? codec : NULL; <span class="comment">// NULL deallocates codec.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里说明mCodec是一个ACodec对象</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">status_t MediaCodec::init(const AString &amp;name, <span class="built_in">bool</span> nameIsType, <span class="built_in">bool</span> encoder) &#123;</span><br><span class="line">    mResourceManagerService-&gt;init<span class="literal">()</span>;</span><br><span class="line">    <span class="keyword">if</span> (nameIsType<span class="operator"> || </span>!strncasecmp(name.c<span class="constructor">_str()</span>, <span class="string">&quot;omx.&quot;</span>, <span class="number">4</span>)) &#123;</span><br><span class="line">        <span class="comment">//根据名称创建Codec</span></span><br><span class="line">        mCodec = <span class="keyword">new</span> ACodec;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!nameIsType&amp;&amp; !strncasecmp(name.c<span class="constructor">_str()</span>, <span class="string">&quot;android.filter.&quot;</span>, <span class="number">15</span>)) &#123;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> <span class="constructor">AMessage(<span class="params">kWhatInit</span>, <span class="params">this</span>)</span>;</span><br><span class="line">    msg-&gt;set<span class="constructor">String(<span class="string">&quot;name&quot;</span>, <span class="params">name</span>)</span>;</span><br><span class="line">    msg-&gt;set<span class="constructor">Int32(<span class="string">&quot;nameIsType&quot;</span>, <span class="params">nameIsType</span>)</span>;</span><br><span class="line">    <span class="keyword">if</span> (nameIsType) &#123;</span><br><span class="line">        msg-&gt;set<span class="constructor">Int32(<span class="string">&quot;encoder&quot;</span>, <span class="params">encoder</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    return err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight mel"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> kWhatInit:</span><br><span class="line">&#123;</span><br><span class="line">   	<span class="comment">//....................</span></span><br><span class="line">    mCodec-&gt;initiateAllocateComponent(<span class="keyword">format</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void ACodec::initiate<span class="constructor">AllocateComponent(<span class="params">const</span> <span class="params">sp</span>&lt;AMessage&gt; &amp;<span class="params">msg</span>)</span> &#123;</span><br><span class="line">    msg-&gt;set<span class="constructor">What(<span class="params">kWhatAllocateComponent</span>)</span>;</span><br><span class="line">    msg-&gt;set<span class="constructor">Target(<span class="params">this</span>)</span>;</span><br><span class="line">    msg-&gt;post<span class="literal">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> ACodec::kWhatAllocateComponent:</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">onAllocateComponent</span>(msg);</span><br><span class="line">    handled = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里开始实例化编码器并设置状态</p>
<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line">bool ACodec::UninitializedState::onAllocateComponent(const sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    </span><br><span class="line">    Vector&lt;OMXCodec::CodecNameAndQuirks&gt; matchingCodecs;</span><br><span class="line">    AString mime;</span><br><span class="line">    AString componentName;</span><br><span class="line">    uint32_t quirks = <span class="number">0</span>;</span><br><span class="line">    int32_t encoder = <span class="literal">false</span>;</span><br><span class="line">    <span class="function"><span class="title">if</span> (msg-&gt;</span>findString(<span class="string">&quot;componentName&quot;</span>, &amp;componentName)) &#123;</span><br><span class="line">        ssize_t index = matchingCodecs.add();</span><br><span class="line">        OMXCodec::CodecNameAndQuirks *entry = &amp;matchingCodecs.editItemAt(index);</span><br><span class="line">        <span class="function"><span class="title">entry</span>-&gt;</span>mName = String8(componentName.c_str());</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="title">if</span> (!OMXCodec::findCodecQuirks(componentName.c_str(), &amp;entry-&gt;</span>mQuirks)) &#123;</span><br><span class="line">            <span class="function"><span class="title">entry</span>-&gt;</span>mQuirks = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        CHECK(<span class="function"><span class="title">msg</span>-&gt;</span>findString(<span class="string">&quot;mime&quot;</span>, &amp;mime));</span><br><span class="line">        <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;encoder&quot;</span>, &amp;encoder)) &#123;</span><br><span class="line">            encoder = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        OMXCodec::findMatchingCodecs(</span><br><span class="line">                mime.c_str(),</span><br><span class="line">                encoder, <span class="comment">// createEncoder</span></span><br><span class="line">                NULL,  <span class="comment">// matchComponentName</span></span><br><span class="line">                <span class="number">0</span>,     <span class="comment">// flags</span></span><br><span class="line">                &amp;matchingCodecs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;CodecObserver&gt; observer = new CodecObserver;</span><br><span class="line">    IOMX::node_id node = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    status_t err = NAME_NOT_FOUND;</span><br><span class="line">    <span class="keyword">for</span> (size_t matchIndex = <span class="number">0</span>; matchIndex &lt; matchingCodecs.size();++matchIndex) &#123;</span><br><span class="line">        componentName = matchingCodecs.itemAt(matchIndex).mName.string();</span><br><span class="line">        quirks = matchingCodecs.itemAt(matchIndex).mQuirks;</span><br><span class="line"></span><br><span class="line">        pid_t tid = gettid();</span><br><span class="line">        int prevPriority = androidGetThreadPriority(tid);</span><br><span class="line">        androidSetThreadPriority(tid, ANDROID_PRIORITY_FOREGROUND);</span><br><span class="line">        <span class="function"><span class="title">err</span> = omx-&gt;</span>allocateNode(componentName.c_str(), observer, &amp;node);</span><br><span class="line">        androidSetThreadPriority(tid, prevPriority);</span><br><span class="line">        node = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    notify = new AMessage(kWhatOMXMessageList, mCodec);</span><br><span class="line">    <span class="function"><span class="title">observer</span>-&gt;</span>setNotificationMessage(notify);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">mCodec</span>-&gt;</span>mComponentName = componentName;</span><br><span class="line">    <span class="function"><span class="title">mCodec</span>-&gt;</span>mRenderTracker.setComponentName(componentName);</span><br><span class="line">    <span class="function"><span class="title">mCodec</span>-&gt;</span>mFlags = <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="title">mCodec</span>-&gt;</span>mQuirks = quirks;</span><br><span class="line">    <span class="function"><span class="title">mCodec</span>-&gt;</span>mOMX = omx;</span><br><span class="line">    <span class="function"><span class="title">mCodec</span>-&gt;</span>mNode = node;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="title">sp</span>&lt;AMessage&gt; notify = mCodec-&gt;</span><span class="function"><span class="title">mNotify</span>-&gt;</span>dup();</span><br><span class="line">        <span class="function"><span class="title">notify</span>-&gt;</span>setInt32(<span class="string">&quot;what&quot;</span>, CodecBase::kWhatComponentAllocated);</span><br><span class="line">        <span class="function"><span class="title">notify</span>-&gt;</span><span class="function"><span class="title">setString</span>(&quot;componentName&quot;, mCodec-&gt;</span>mComponentName.c_str());</span><br><span class="line">        <span class="function"><span class="title">notify</span>-&gt;</span>post();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">mCodec</span>-&gt;</span><span class="function"><span class="title">changeState</span>(mCodec-&gt;</span>mLoadedState);</span><br><span class="line">    return <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解码器的配置</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">status_t MediaCodec::configure(</span><br><span class="line">        const sp&lt;AMessage&gt; &amp;format,</span><br><span class="line">        const sp&lt;Surface&gt; &amp;surface,</span><br><span class="line">        const sp&lt;ICrypto&gt; &amp;crypto,</span><br><span class="line">        uint32_t flags) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> <span class="constructor">AMessage(<span class="params">kWhatConfigure</span>, <span class="params">this</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mIsVideo) &#123;</span><br><span class="line">        format-&gt;find<span class="constructor">Int32(<span class="string">&quot;width&quot;</span>, &amp;<span class="params">mVideoWidth</span>)</span>;</span><br><span class="line">        format-&gt;find<span class="constructor">Int32(<span class="string">&quot;height&quot;</span>, &amp;<span class="params">mVideoHeight</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (!format-&gt;find<span class="constructor">Int32(<span class="string">&quot;rotation-degrees&quot;</span>, &amp;<span class="params">mRotationDegrees</span>)</span>) &#123;</span><br><span class="line">            mRotationDegrees = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    msg-&gt;set<span class="constructor">Message(<span class="string">&quot;format&quot;</span>, <span class="params">format</span>)</span>;</span><br><span class="line">    msg-&gt;set<span class="constructor">Int32(<span class="string">&quot;flags&quot;</span>, <span class="params">flags</span>)</span>;</span><br><span class="line">    msg-&gt;set<span class="constructor">Object(<span class="string">&quot;surface&quot;</span>, <span class="params">surface</span>)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//.....................</span></span><br><span class="line">    <span class="comment">// save msg for reset</span></span><br><span class="line">    mConfigureMsg = msg;</span><br><span class="line">	<span class="comment">//.....................</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt;= kMaxRetry; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Don&#x27;t try to reclaim resource for the first time.</span></span><br><span class="line">            <span class="keyword">if</span> (!mResourceManagerService-&gt;reclaim<span class="constructor">Resource(<span class="params">resources</span>)</span>) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        sp&lt;AMessage&gt; response;</span><br><span class="line">        err = <span class="constructor">PostAndAwaitResponse(<span class="params">msg</span>, &amp;<span class="params">response</span>)</span>;</span><br><span class="line">        <span class="comment">//.....................</span></span><br><span class="line">    &#125;</span><br><span class="line">    return err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">case kWhatConfigure:</span><br><span class="line">&#123;</span><br><span class="line">    sp&lt;AReplyToken&gt; replyID;</span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">senderAwaitsResponse</span>(&amp;<span class="params">replyID</span>)</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    sp&lt;RefBase&gt; obj;</span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">findObject</span>(<span class="string">&quot;surface&quot;</span>, &amp;<span class="params">obj</span>)</span>);</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; format;</span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">findMessage</span>(<span class="string">&quot;format&quot;</span>, &amp;<span class="params">format</span>)</span>);</span><br><span class="line"></span><br><span class="line">    int32_t push;</span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;find<span class="constructor">Int32(<span class="string">&quot;push-blank-buffers-on-shutdown&quot;</span>, &amp;<span class="params">push</span>)</span><span class="operator"> &amp;&amp; </span>push != <span class="number">0</span>) &#123;</span><br><span class="line">        mFlags <span class="pattern-match">|= k<span class="constructor">FlagPushBlankBuffersOnShutdown</span>;</span></span><br><span class="line"><span class="pattern-match">    &#125;</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">    <span class="keyword">if</span> (obj != <span class="constructor">NULL</span>) &#123;</span></span><br><span class="line"><span class="pattern-match">        format-&gt;set<span class="constructor">Object(<span class="string">&quot;native-window&quot;</span>, <span class="params">obj</span>)</span>;</span></span><br><span class="line"><span class="pattern-match">        status<span class="constructor">_t</span> err = handle<span class="constructor">SetSurface(<span class="params">static_cast</span>&lt;Surface <span class="operator">*</span>&gt;(<span class="params">obj</span>.<span class="params">get</span>()</span>));</span></span><br><span class="line"><span class="pattern-match">        <span class="keyword">if</span> (err != <span class="constructor">OK</span>) &#123;</span></span><br><span class="line"><span class="pattern-match">            <span class="constructor">PostReplyWithError(<span class="params">replyID</span>, <span class="params">err</span>)</span>;</span></span><br><span class="line"><span class="pattern-match">            break;</span></span><br><span class="line"><span class="pattern-match">        &#125;</span></span><br><span class="line"><span class="pattern-match">    &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="pattern-match">        handle<span class="constructor">SetSurface(NULL)</span>;</span></span><br><span class="line"><span class="pattern-match">    &#125;</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">    m<span class="constructor">ReplyID</span> = reply<span class="constructor">ID</span>;</span></span><br><span class="line"><span class="pattern-match">    set<span class="constructor">State(CONFIGURING)</span>;</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">    void <span class="operator">*</span>crypto;</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">    uint32<span class="constructor">_t</span> flags;</span></span><br><span class="line"><span class="pattern-match">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">findInt32</span>(<span class="string">&quot;flags&quot;</span>, (<span class="params">int32_t</span> <span class="operator">*</span>)</span>&amp;flags));</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">    <span class="keyword">if</span> (flags &amp; <span class="constructor">CONFIGURE_FLAG_ENCODE</span>) &#123;</span></span><br><span class="line"><span class="pattern-match">        format-&gt;set<span class="constructor">Int32(<span class="string">&quot;encoder&quot;</span>, <span class="params">true</span>)</span>;</span></span><br><span class="line"><span class="pattern-match">        m<span class="constructor">Flags</span> |= k<span class="constructor">FlagIsEncoder</span>;</span></span><br><span class="line"><span class="pattern-match">    &#125;</span></span><br><span class="line"><span class="pattern-match">	<span class="operator">/</span><span class="operator">/</span>这里最重要</span></span><br><span class="line"><span class="pattern-match">    m<span class="constructor">Codec</span>-&gt;initiate<span class="constructor">ConfigureComponent(<span class="params">format</span>)</span>;</span></span><br><span class="line"><span class="pattern-match">    break;</span></span><br><span class="line"><span class="pattern-match">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void ACodec::initiate<span class="constructor">ConfigureComponent(<span class="params">const</span> <span class="params">sp</span>&lt;AMessage&gt; &amp;<span class="params">msg</span>)</span> &#123;</span><br><span class="line">    msg-&gt;set<span class="constructor">What(<span class="params">kWhatConfigureComponent</span>)</span>;</span><br><span class="line">    msg-&gt;set<span class="constructor">Target(<span class="params">this</span>)</span>;</span><br><span class="line">    msg-&gt;post<span class="literal">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> ACodec::kWhatConfigureComponent:</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">onConfigureComponent</span>(msg);</span><br><span class="line">    handled = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line">bool ACodec::LoadedState::onConfigureComponent(</span><br><span class="line">        const sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    ALOGV(<span class="string">&quot;onConfigureComponent&quot;</span>);</span><br><span class="line"></span><br><span class="line">    CHECK(<span class="function"><span class="title">mCodec</span>-&gt;</span>mNode != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    status_t err = OK;</span><br><span class="line">    AString mime;</span><br><span class="line">    <span class="function"><span class="title">if</span> (!msg-&gt;</span>findString(<span class="string">&quot;mime&quot;</span>, &amp;mime)) &#123;</span><br><span class="line">        err = BAD_VALUE;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="function"><span class="title">err</span> = mCodec-&gt;</span>configureCodec(mime.c_str(), msg);</span><br><span class="line">    &#125;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="title">sp</span>&lt;AMessage&gt; notify = mCodec-&gt;</span><span class="function"><span class="title">mNotify</span>-&gt;</span>dup();</span><br><span class="line">        <span class="function"><span class="title">notify</span>-&gt;</span>setInt32(<span class="string">&quot;what&quot;</span>, CodecBase::kWhatComponentConfigured);</span><br><span class="line">        <span class="function"><span class="title">notify</span>-&gt;</span><span class="function"><span class="title">setMessage</span>(&quot;input-format&quot;, mCodec-&gt;</span>mInputFormat);</span><br><span class="line">        <span class="function"><span class="title">notify</span>-&gt;</span><span class="function"><span class="title">setMessage</span>(&quot;output-format&quot;, mCodec-&gt;</span>mOutputFormat);</span><br><span class="line">        <span class="function"><span class="title">notify</span>-&gt;</span>post();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">case CodecBase::kWhatComponentConfigured:</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (mState<span class="operator"> == </span>UNINITIALIZED<span class="operator"> || </span>mState<span class="operator"> == </span>INITIALIZED) &#123;</span><br><span class="line">        <span class="comment">// In case a kWhatError message came in and replied with error,</span></span><br><span class="line">        <span class="comment">// we log a warning and ignore.</span></span><br><span class="line">        <span class="constructor">ALOGW(<span class="string">&quot;configure interrupted by error, current state %d&quot;</span>, <span class="params">mState</span>)</span>;</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="constructor">CHECK_EQ(<span class="params">mState</span>, CONFIGURING)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// reset input surface flag</span></span><br><span class="line">    mHaveInputSurface = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">findMessage</span>(<span class="string">&quot;input-format&quot;</span>, &amp;<span class="params">mInputFormat</span>)</span>);</span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">findMessage</span>(<span class="string">&quot;output-format&quot;</span>, &amp;<span class="params">mOutputFormat</span>)</span>);</span><br><span class="line"></span><br><span class="line">    int32_t usingSwRenderer;</span><br><span class="line">    <span class="keyword">if</span> (mOutputFormat-&gt;find<span class="constructor">Int32(<span class="string">&quot;using-sw-renderer&quot;</span>, &amp;<span class="params">usingSwRenderer</span>)</span><span class="operator"></span></span><br><span class="line"><span class="operator">            &amp;&amp; </span>usingSwRenderer) &#123;</span><br><span class="line">        mFlags <span class="pattern-match">|= k<span class="constructor">FlagUsesSoftwareRenderer</span>;</span></span><br><span class="line"><span class="pattern-match">    &#125;</span></span><br><span class="line"><span class="pattern-match">    set<span class="constructor">State(CONFIGURED)</span>;</span></span><br><span class="line"><span class="pattern-match">    (<span class="keyword">new</span> <span class="constructor">AMessage</span>)-&gt;post<span class="constructor">Reply(<span class="params">mReplyID</span>)</span>;</span></span><br><span class="line"><span class="pattern-match">    break;</span></span><br><span class="line"><span class="pattern-match">&#125;</span></span><br></pre></td></tr></table></figure>
<p>这里才是解码器最详细的配置，有时间好好针对这个展开研究，这篇博客先针对整个流程进行分析：</p>
<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line">status_t ACodec::configureCodec(</span><br><span class="line">        const char *mime, const sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    int32_t encoder;</span><br><span class="line">    <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;encoder&quot;</span>, &amp;encoder)) &#123;</span><br><span class="line">        encoder = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; inputFormat = new AMessage();</span><br><span class="line">    <span class="function"><span class="title">sp</span>&lt;AMessage&gt; outputFormat = mNotify-&gt;</span>dup(); <span class="comment">// will use this for kWhatOutputFormatChanged</span></span><br><span class="line"></span><br><span class="line">    mIsEncoder = encoder;</span><br><span class="line"></span><br><span class="line">    mInputMetadataType = kMetadataBufferTypeInvalid;</span><br><span class="line">    mOutputMetadataType = kMetadataBufferTypeInvalid;</span><br><span class="line"></span><br><span class="line">    status_t err = setComponentRole(encoder <span class="comment">/* isEncoder */</span>, mime);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">        return err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    int32_t bitRate = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// FLAC encoder doesn&#x27;t need a bitrate, other encoders do</span></span><br><span class="line">    <span class="keyword">if</span> (encoder &amp;&amp; strcasecmp(mime, MEDIA_MIMETYPE_AUDIO_FLAC)</span><br><span class="line">            &amp;&amp; !<span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;bitrate&quot;</span>, &amp;bitRate)) &#123;</span><br><span class="line">        return INVALID_OPERATION;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    int32_t storeMeta;</span><br><span class="line">    <span class="keyword">if</span> (encoder</span><br><span class="line">            &amp;&amp; <span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;store-metadata-in-buffers&quot;</span>, &amp;storeMeta)</span><br><span class="line">            &amp;&amp; storeMeta != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="function"><span class="title">err</span> = mOMX-&gt;</span>storeMetaDataInBuffers(mNode, kPortIndexInput, OMX_TRUE, &amp;mInputMetadataType);</span><br><span class="line">        <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">            ALOGE(<span class="string">&quot;[%s] storeMetaDataInBuffers (input) failed w/ err %d&quot;</span>,</span><br><span class="line">                    mComponentName.c_str(), err);</span><br><span class="line"></span><br><span class="line">            return err;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// For this specific case we could be using camera source even if storeMetaDataInBuffers</span></span><br><span class="line">        <span class="comment">// returns Gralloc source. Pretend that we are; this will force us to use nBufferSize.</span></span><br><span class="line">        <span class="keyword">if</span> (mInputMetadataType == kMetadataBufferTypeGrallocSource) &#123;</span><br><span class="line">            mInputMetadataType = kMetadataBufferTypeCameraSource;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        uint32_t usageBits;</span><br><span class="line">        <span class="function"><span class="title">if</span> (mOMX-&gt;</span>getParameter(</span><br><span class="line">                mNode, (OMX_INDEXTYPE)OMX_IndexParamConsumerUsageBits,</span><br><span class="line">                &amp;usageBits, sizeof(usageBits)) == OK) &#123;</span><br><span class="line">            <span class="function"><span class="title">inputFormat</span>-&gt;</span>setInt32(</span><br><span class="line">                    <span class="string">&quot;using-sw-read-often&quot;</span>, !!(usageBits &amp; GRALLOC_USAGE_SW_READ_OFTEN));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    int32_t prependSPSPPS = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (encoder</span><br><span class="line">            &amp;&amp; <span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;prepend-sps-pps-to-idr-frames&quot;</span>, &amp;prependSPSPPS)</span><br><span class="line">            &amp;&amp; prependSPSPPS != <span class="number">0</span>) &#123;</span><br><span class="line">        OMX_INDEXTYPE index;</span><br><span class="line">        <span class="function"><span class="title">err</span> = mOMX-&gt;</span>getExtensionIndex(</span><br><span class="line">                mNode,</span><br><span class="line">                <span class="string">&quot;OMX.google.android.index.prependSPSPPSToIDRFrames&quot;</span>,</span><br><span class="line">                &amp;index);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (err == OK) &#123;</span><br><span class="line">            PrependSPSPPSToIDRFramesParams params;</span><br><span class="line">            InitOMXParams(&amp;params);</span><br><span class="line">            params.bEnable = OMX_TRUE;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="title">err</span> = mOMX-&gt;</span>setParameter(</span><br><span class="line">                    mNode, index, &amp;params, sizeof(params));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">            ALOGE(<span class="string">&quot;Encoder could not be configured to emit SPS/PPS before &quot;</span></span><br><span class="line">                  <span class="string">&quot;IDR frames. (err %d)&quot;</span>, err);</span><br><span class="line"></span><br><span class="line">            return err;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Only enable metadata mode on encoder output if encoder can prepend</span></span><br><span class="line">    <span class="comment">// sps/pps to idr frames, since in metadata mode the bitstream is in an</span></span><br><span class="line">    <span class="comment">// opaque handle, to which we don&#x27;t have access.</span></span><br><span class="line">    int32_t video = !strncasecmp(mime, <span class="string">&quot;video/&quot;</span>, <span class="number">6</span>);</span><br><span class="line">    mIsVideo = video;</span><br><span class="line">    <span class="keyword">if</span> (encoder &amp;&amp; video) &#123;</span><br><span class="line">        OMX_BOOL enable = (OMX_BOOL) (prependSPSPPS</span><br><span class="line">            &amp;&amp; <span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;store-metadata-in-buffers-output&quot;</span>, &amp;storeMeta)</span><br><span class="line">            &amp;&amp; storeMeta != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="title">err</span> = mOMX-&gt;</span>storeMetaDataInBuffers(mNode, kPortIndexOutput, enable, &amp;mOutputMetadataType);</span><br><span class="line">        <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">            ALOGE(<span class="string">&quot;[%s] storeMetaDataInBuffers (output) failed w/ err %d&quot;</span>,</span><br><span class="line">                mComponentName.c_str(), err);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt64(</span><br><span class="line">                    <span class="string">&quot;repeat-previous-frame-after&quot;</span>,</span><br><span class="line">                    &amp;mRepeatFrameDelayUs)) &#123;</span><br><span class="line">            mRepeatFrameDelayUs = -<span class="number">1</span>ll;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt64(<span class="string">&quot;max-pts-gap-to-encoder&quot;</span>, &amp;mMaxPtsGapUs)) &#123;</span><br><span class="line">            mMaxPtsGapUs = -<span class="number">1</span>ll;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="title">if</span> (!msg-&gt;</span>findFloat(<span class="string">&quot;max-fps-to-encoder&quot;</span>, &amp;mMaxFps)) &#123;</span><br><span class="line">            mMaxFps = -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt64(<span class="string">&quot;time-lapse&quot;</span>, &amp;mTimePerCaptureUs)) &#123;</span><br><span class="line">            mTimePerCaptureUs = -<span class="number">1</span>ll;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(</span><br><span class="line">                    <span class="string">&quot;create-input-buffers-suspended&quot;</span>,</span><br><span class="line">                    (int32_t*)&amp;mCreateInputBuffersSuspended)) &#123;</span><br><span class="line">            mCreateInputBuffersSuspended = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">NOTE:</span> we only use native window for video decoders</span></span><br><span class="line">    sp&lt;RefBase&gt; obj;</span><br><span class="line">    <span class="function"><span class="title">bool</span> haveNativeWindow = msg-&gt;</span>findObject(<span class="string">&quot;native-window&quot;</span>, &amp;obj)</span><br><span class="line">            &amp;&amp; obj != NULL &amp;&amp; video &amp;&amp; !encoder;</span><br><span class="line">    mLegacyAdaptiveExperiment = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (video &amp;&amp; !encoder) &#123;</span><br><span class="line">        <span class="function"><span class="title">inputFormat</span>-&gt;</span>setInt32(<span class="string">&quot;adaptive-playback&quot;</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        int32_t usageProtected;</span><br><span class="line">        <span class="function"><span class="title">if</span> (msg-&gt;</span>findInt32(<span class="string">&quot;protected&quot;</span>, &amp;usageProtected) &amp;&amp; usageProtected) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!haveNativeWindow) &#123;</span><br><span class="line">                ALOGE(<span class="string">&quot;protected output buffers must be sent to an ANativeWindow&quot;</span>);</span><br><span class="line">                return PERMISSION_DENIED;</span><br><span class="line">            &#125;</span><br><span class="line">            mFlags |= kFlagIsGrallocUsageProtected;</span><br><span class="line">            mFlags |= kFlagPushBlankBuffersToNativeWindowOnShutdown;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (haveNativeWindow) &#123;</span><br><span class="line">        sp&lt;ANativeWindow&gt; nativeWindow =</span><br><span class="line">            static_cast&lt;ANativeWindow *&gt;(static_cast&lt;Surface *&gt;(obj.get()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// START of temporary support for automatic FRC - THIS WILL BE REMOVED</span></span><br><span class="line">        int32_t autoFrc;</span><br><span class="line">        <span class="function"><span class="title">if</span> (msg-&gt;</span>findInt32(<span class="string">&quot;auto-frc&quot;</span>, &amp;autoFrc)) &#123;</span><br><span class="line">            bool enabled = autoFrc;</span><br><span class="line">            OMX_CONFIG_BOOLEANTYPE config;</span><br><span class="line">            InitOMXParams(&amp;config);</span><br><span class="line">            config.bEnabled = (OMX_BOOL)enabled;</span><br><span class="line">            <span class="function"><span class="title">status_t</span> temp = mOMX-&gt;</span>setConfig(</span><br><span class="line">                    mNode, (OMX_INDEXTYPE)OMX_IndexConfigAutoFramerateConversion,</span><br><span class="line">                    &amp;config, sizeof(config));</span><br><span class="line">            <span class="keyword">if</span> (temp == OK) &#123;</span><br><span class="line">                <span class="function"><span class="title">outputFormat</span>-&gt;</span>setInt32(<span class="string">&quot;auto-frc&quot;</span>, enabled);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (enabled) &#123;</span><br><span class="line">                ALOGI(<span class="string">&quot;codec does not support requested auto-frc (err %d)&quot;</span>, temp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// END of temporary support for automatic FRC</span></span><br><span class="line"></span><br><span class="line">        int32_t tunneled;</span><br><span class="line">        <span class="function"><span class="title">if</span> (msg-&gt;</span>findInt32(<span class="string">&quot;feature-tunneled-playback&quot;</span>, &amp;tunneled) &amp;&amp;</span><br><span class="line">            tunneled != <span class="number">0</span>) &#123;</span><br><span class="line">            ALOGI(<span class="string">&quot;Configuring TUNNELED video playback.&quot;</span>);</span><br><span class="line">            mTunneled = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            int32_t audioHwSync = <span class="number">0</span>;</span><br><span class="line">            <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;audio-hw-sync&quot;</span>, &amp;audioHwSync)) &#123;</span><br><span class="line">                ALOGW(<span class="string">&quot;No Audio HW Sync provided for video tunnel&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            err = configureTunneledVideoPlayback(audioHwSync, nativeWindow);</span><br><span class="line">            <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">                ALOGE(<span class="string">&quot;configureTunneledVideoPlayback(%d,%p) failed!&quot;</span>,</span><br><span class="line">                        audioHwSync, nativeWindow.get());</span><br><span class="line">                return err;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            int32_t maxWidth = <span class="number">0</span>, maxHeight = <span class="number">0</span>;</span><br><span class="line">            <span class="function"><span class="title">if</span> (msg-&gt;</span>findInt32(<span class="string">&quot;max-width&quot;</span>, &amp;maxWidth) &amp;&amp;</span><br><span class="line">                    <span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;max-height&quot;</span>, &amp;maxHeight)) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="function"><span class="title">err</span> = mOMX-&gt;</span>prepareForAdaptivePlayback(</span><br><span class="line">                        mNode, kPortIndexOutput, OMX_TRUE, maxWidth, maxHeight);</span><br><span class="line">                <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">                    ALOGW(<span class="string">&quot;[%s] prepareForAdaptivePlayback failed w/ err %d&quot;</span>,</span><br><span class="line">                            mComponentName.c_str(), err);</span><br><span class="line">                    <span class="comment">// allow failure</span></span><br><span class="line">                    err = OK;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="function"><span class="title">inputFormat</span>-&gt;</span>setInt32(<span class="string">&quot;max-width&quot;</span>, maxWidth);</span><br><span class="line">                    <span class="function"><span class="title">inputFormat</span>-&gt;</span>setInt32(<span class="string">&quot;max-height&quot;</span>, maxHeight);</span><br><span class="line">                    <span class="function"><span class="title">inputFormat</span>-&gt;</span>setInt32(<span class="string">&quot;adaptive-playback&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ALOGV(<span class="string">&quot;Configuring CPU controlled video playback.&quot;</span>);</span><br><span class="line">            mTunneled = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Explicity reset the sideband handle of the window for</span></span><br><span class="line">            <span class="comment">// non-tunneled video in case the window was previously used</span></span><br><span class="line">            <span class="comment">// for a tunneled video playback.</span></span><br><span class="line">            err = native_window_set_sideband_stream(nativeWindow.get(), NULL);</span><br><span class="line">            <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">                ALOGE(<span class="string">&quot;set_sideband_stream(NULL) failed! (err %d).&quot;</span>, err);</span><br><span class="line">                return err;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Always try to enable dynamic output buffers on native surface</span></span><br><span class="line">            <span class="function"><span class="title">err</span> = mOMX-&gt;</span>storeMetaDataInBuffers(</span><br><span class="line">                    mNode, kPortIndexOutput, OMX_TRUE, &amp;mOutputMetadataType);</span><br><span class="line">            <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">                ALOGE(<span class="string">&quot;[%s] storeMetaDataInBuffers failed w/ err %d&quot;</span>,</span><br><span class="line">                        mComponentName.c_str(), err);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// if adaptive playback has been requested, try JB fallback</span></span><br><span class="line">                <span class="comment">// <span class="doctag">NOTE:</span> THIS FALLBACK MECHANISM WILL BE REMOVED DUE TO ITS</span></span><br><span class="line">                <span class="comment">// LARGE MEMORY REQUIREMENT</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// we will not do adaptive playback on software accessed</span></span><br><span class="line">                <span class="comment">// surfaces as they never had to respond to changes in the</span></span><br><span class="line">                <span class="comment">// crop window, and we don&#x27;t trust that they will be able to.</span></span><br><span class="line">                int usageBits = <span class="number">0</span>;</span><br><span class="line">                bool canDoAdaptivePlayback;</span><br><span class="line"></span><br><span class="line">                <span class="function"><span class="title">if</span> (nativeWindow-&gt;</span>query(</span><br><span class="line">                        nativeWindow.get(),</span><br><span class="line">                        NATIVE_WINDOW_CONSUMER_USAGE_BITS,</span><br><span class="line">                        &amp;usageBits) != OK) &#123;</span><br><span class="line">                    canDoAdaptivePlayback = <span class="literal">false</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    canDoAdaptivePlayback =</span><br><span class="line">                        (usageBits &amp;</span><br><span class="line">                                (GRALLOC_USAGE_SW_READ_MASK |</span><br><span class="line">                                 GRALLOC_USAGE_SW_WRITE_MASK)) == <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                int32_t maxWidth = <span class="number">0</span>, maxHeight = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (canDoAdaptivePlayback &amp;&amp;</span><br><span class="line">                        <span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;max-width&quot;</span>, &amp;maxWidth) &amp;&amp;</span><br><span class="line">                        <span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;max-height&quot;</span>, &amp;maxHeight)) &#123;</span><br><span class="line">                    ALOGV(<span class="string">&quot;[%s] prepareForAdaptivePlayback(%dx%d)&quot;</span>,</span><br><span class="line">                            mComponentName.c_str(), maxWidth, maxHeight);</span><br><span class="line"></span><br><span class="line">                    <span class="function"><span class="title">err</span> = mOMX-&gt;</span>prepareForAdaptivePlayback(</span><br><span class="line">                            mNode, kPortIndexOutput, OMX_TRUE, maxWidth,</span><br><span class="line">                            maxHeight);</span><br><span class="line">                    ALOGW_IF(err != OK,</span><br><span class="line">                            <span class="string">&quot;[%s] prepareForAdaptivePlayback failed w/ err %d&quot;</span>,</span><br><span class="line">                            mComponentName.c_str(), err);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (err == OK) &#123;</span><br><span class="line">                        <span class="function"><span class="title">inputFormat</span>-&gt;</span>setInt32(<span class="string">&quot;max-width&quot;</span>, maxWidth);</span><br><span class="line">                        <span class="function"><span class="title">inputFormat</span>-&gt;</span>setInt32(<span class="string">&quot;max-height&quot;</span>, maxHeight);</span><br><span class="line">                        <span class="function"><span class="title">inputFormat</span>-&gt;</span>setInt32(<span class="string">&quot;adaptive-playback&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// allow failure</span></span><br><span class="line">                err = OK;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ALOGV(<span class="string">&quot;[%s] storeMetaDataInBuffers succeeded&quot;</span>,</span><br><span class="line">                        mComponentName.c_str());</span><br><span class="line">                CHECK(storingMetadataInDecodedBuffers());</span><br><span class="line">                mLegacyAdaptiveExperiment = ADebug::isExperimentEnabled(</span><br><span class="line">                        <span class="string">&quot;legacy-adaptive&quot;</span>, !<span class="function"><span class="title">msg</span>-&gt;</span><span class="built_in">contains</span>(<span class="string">&quot;no-experiments&quot;</span>));</span><br><span class="line"></span><br><span class="line">                <span class="function"><span class="title">inputFormat</span>-&gt;</span>setInt32(<span class="string">&quot;adaptive-playback&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            int32_t push;</span><br><span class="line">            <span class="function"><span class="title">if</span> (msg-&gt;</span>findInt32(<span class="string">&quot;push-blank-buffers-on-shutdown&quot;</span>, &amp;push)</span><br><span class="line">                    &amp;&amp; push != <span class="number">0</span>) &#123;</span><br><span class="line">                mFlags |= kFlagPushBlankBuffersToNativeWindowOnShutdown;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        int32_t rotationDegrees;</span><br><span class="line">        <span class="function"><span class="title">if</span> (msg-&gt;</span>findInt32(<span class="string">&quot;rotation-degrees&quot;</span>, &amp;rotationDegrees)) &#123;</span><br><span class="line">            mRotationDegrees = rotationDegrees;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mRotationDegrees = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (video) &#123;</span><br><span class="line">        <span class="comment">// determine need for software renderer</span></span><br><span class="line">        bool usingSwRenderer = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (haveNativeWindow &amp;&amp; mComponentName.startsWith(<span class="string">&quot;OMX.google.&quot;</span>)) &#123;</span><br><span class="line">            usingSwRenderer = <span class="literal">true</span>;</span><br><span class="line">            haveNativeWindow = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (encoder) &#123;</span><br><span class="line">            err = setupVideoEncoder(mime, msg);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            err = setupVideoDecoder(mime, msg, haveNativeWindow);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">            return err;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (haveNativeWindow) &#123;</span><br><span class="line">            mNativeWindow = static_cast&lt;Surface *&gt;(obj.get());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// initialize native window now to get actual output format</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> this is needed for some encoders even though they don&#x27;t use native window</span></span><br><span class="line">        err = initNativeWindow();</span><br><span class="line">        <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">            return err;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// fallback for devices that do not handle flex-YUV for native buffers</span></span><br><span class="line">        <span class="keyword">if</span> (haveNativeWindow) &#123;</span><br><span class="line">            int32_t requestedColorFormat = OMX_COLOR_FormatUnused;</span><br><span class="line">            <span class="function"><span class="title">if</span> (msg-&gt;</span>findInt32(<span class="string">&quot;color-format&quot;</span>, &amp;requestedColorFormat) &amp;&amp;</span><br><span class="line">                    requestedColorFormat == OMX_COLOR_FormatYUV420Flexible) &#123;</span><br><span class="line">                status_t err = getPortFormat(kPortIndexOutput, outputFormat);</span><br><span class="line">                <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">                    return err;</span><br><span class="line">                &#125;</span><br><span class="line">                int32_t colorFormat = OMX_COLOR_FormatUnused;</span><br><span class="line">                OMX_U32 flexibleEquivalent = OMX_COLOR_FormatUnused;</span><br><span class="line">                <span class="function"><span class="title">if</span> (!outputFormat-&gt;</span>findInt32(<span class="string">&quot;color-format&quot;</span>, &amp;colorFormat)) &#123;</span><br><span class="line">                    ALOGE(<span class="string">&quot;ouptut port did not have a color format (wrong domain?)&quot;</span>);</span><br><span class="line">                    return BAD_VALUE;</span><br><span class="line">                &#125;</span><br><span class="line">                ALOGD(<span class="string">&quot;[%s] Requested output format %#x and got %#x.&quot;</span>,</span><br><span class="line">                        mComponentName.c_str(), requestedColorFormat, colorFormat);</span><br><span class="line">                <span class="keyword">if</span> (!isFlexibleColorFormat(</span><br><span class="line">                                mOMX, mNode, colorFormat, haveNativeWindow, &amp;flexibleEquivalent)</span><br><span class="line">                        || flexibleEquivalent != (OMX_U32)requestedColorFormat) &#123;</span><br><span class="line">                    <span class="comment">// device did not handle flex-YUV request for native window, fall back</span></span><br><span class="line">                    <span class="comment">// to SW renderer</span></span><br><span class="line">                    ALOGI(<span class="string">&quot;[%s] Falling back to software renderer&quot;</span>, mComponentName.c_str());</span><br><span class="line">                    mNativeWindow.clear();</span><br><span class="line">                    mNativeWindowUsageBits = <span class="number">0</span>;</span><br><span class="line">                    haveNativeWindow = <span class="literal">false</span>;</span><br><span class="line">                    usingSwRenderer = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">if</span> (storingMetadataInDecodedBuffers()) &#123;</span><br><span class="line">                        <span class="function"><span class="title">err</span> = mOMX-&gt;</span>storeMetaDataInBuffers(</span><br><span class="line">                                mNode, kPortIndexOutput, OMX_FALSE, &amp;mOutputMetadataType);</span><br><span class="line">                        mOutputMetadataType = kMetadataBufferTypeInvalid; <span class="comment">// just in case</span></span><br><span class="line">                        <span class="comment">// <span class="doctag">TODO:</span> implement adaptive-playback support for bytebuffer mode.</span></span><br><span class="line">                        <span class="comment">// This is done by SW codecs, but most HW codecs don&#x27;t support it.</span></span><br><span class="line">                        <span class="function"><span class="title">inputFormat</span>-&gt;</span>setInt32(<span class="string">&quot;adaptive-playback&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (err == OK) &#123;</span><br><span class="line">                        <span class="function"><span class="title">err</span> = mOMX-&gt;</span>enableGraphicBuffers(mNode, kPortIndexOutput, OMX_FALSE);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (mFlags &amp; kFlagIsGrallocUsageProtected) &#123;</span><br><span class="line">                        <span class="comment">// fallback is not supported for protected playback</span></span><br><span class="line">                        err = PERMISSION_DENIED;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (err == OK) &#123;</span><br><span class="line">                        err = setupVideoDecoder(mime, msg, <span class="literal">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (usingSwRenderer) &#123;</span><br><span class="line">            <span class="function"><span class="title">outputFormat</span>-&gt;</span>setInt32(<span class="string">&quot;using-sw-renderer&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(mime, MEDIA_MIMETYPE_AUDIO_MPEG)) &#123;</span><br><span class="line">        int32_t numChannels, sampleRate;</span><br><span class="line">        <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;channel-count&quot;</span>, &amp;numChannels)</span><br><span class="line">                || !<span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;sample-rate&quot;</span>, &amp;sampleRate)) &#123;</span><br><span class="line">            <span class="comment">// Since we did not always check for these, leave them optional</span></span><br><span class="line">            <span class="comment">// and have the decoder figure it all out.</span></span><br><span class="line">            err = OK;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            err = setupRawAudioFormat(</span><br><span class="line">                    encoder ? kPortIndexInput : kPortIndexOutput,</span><br><span class="line">                    sampleRate,</span><br><span class="line">                    numChannels);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(mime, MEDIA_MIMETYPE_AUDIO_AAC)) &#123;</span><br><span class="line">        int32_t numChannels, sampleRate;</span><br><span class="line">        <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;channel-count&quot;</span>, &amp;numChannels)</span><br><span class="line">                || !<span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;sample-rate&quot;</span>, &amp;sampleRate)) &#123;</span><br><span class="line">            err = INVALID_OPERATION;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            int32_t isADTS, aacProfile;</span><br><span class="line">            int32_t sbrMode;</span><br><span class="line">            int32_t maxOutputChannelCount;</span><br><span class="line">            int32_t pcmLimiterEnable;</span><br><span class="line">            drcParams_t drc;</span><br><span class="line">            <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;is-adts&quot;</span>, &amp;isADTS)) &#123;</span><br><span class="line">                isADTS = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;aac-profile&quot;</span>, &amp;aacProfile)) &#123;</span><br><span class="line">                aacProfile = OMX_AUDIO_AACObjectNull;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;aac-sbr-mode&quot;</span>, &amp;sbrMode)) &#123;</span><br><span class="line">                sbrMode = -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;aac-max-output-channel_count&quot;</span>, &amp;maxOutputChannelCount)) &#123;</span><br><span class="line">                maxOutputChannelCount = -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;aac-pcm-limiter-enable&quot;</span>, &amp;pcmLimiterEnable)) &#123;</span><br><span class="line">                <span class="comment">// value is unknown</span></span><br><span class="line">                pcmLimiterEnable = -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;aac-encoded-target-level&quot;</span>, &amp;drc.encodedTargetLevel)) &#123;</span><br><span class="line">                <span class="comment">// value is unknown</span></span><br><span class="line">                drc.encodedTargetLevel = -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;aac-drc-cut-level&quot;</span>, &amp;drc.drcCut)) &#123;</span><br><span class="line">                <span class="comment">// value is unknown</span></span><br><span class="line">                drc.drcCut = -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;aac-drc-boost-level&quot;</span>, &amp;drc.drcBoost)) &#123;</span><br><span class="line">                <span class="comment">// value is unknown</span></span><br><span class="line">                drc.drcBoost = -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;aac-drc-heavy-compression&quot;</span>, &amp;drc.heavyCompression)) &#123;</span><br><span class="line">                <span class="comment">// value is unknown</span></span><br><span class="line">                drc.heavyCompression = -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;aac-target-ref-level&quot;</span>, &amp;drc.targetRefLevel)) &#123;</span><br><span class="line">                <span class="comment">// value is unknown</span></span><br><span class="line">                drc.targetRefLevel = -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            err = setupAACCodec(</span><br><span class="line">                    encoder, numChannels, sampleRate, bitRate, aacProfile,</span><br><span class="line">                    isADTS != <span class="number">0</span>, sbrMode, maxOutputChannelCount, drc,</span><br><span class="line">                    pcmLimiterEnable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(mime, MEDIA_MIMETYPE_AUDIO_AMR_NB)) &#123;</span><br><span class="line">        err = setupAMRCodec(encoder, <span class="literal">false</span> <span class="comment">/* isWAMR */</span>, bitRate);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(mime, MEDIA_MIMETYPE_AUDIO_AMR_WB)) &#123;</span><br><span class="line">        err = setupAMRCodec(encoder, <span class="literal">true</span> <span class="comment">/* isWAMR */</span>, bitRate);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(mime, MEDIA_MIMETYPE_AUDIO_G711_ALAW)</span><br><span class="line">            || !strcasecmp(mime, MEDIA_MIMETYPE_AUDIO_G711_MLAW)) &#123;</span><br><span class="line">        <span class="comment">// These are PCM-like formats with a fixed sample rate but</span></span><br><span class="line">        <span class="comment">// a variable number of channels.</span></span><br><span class="line"></span><br><span class="line">        int32_t numChannels;</span><br><span class="line">        <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;channel-count&quot;</span>, &amp;numChannels)) &#123;</span><br><span class="line">            err = INVALID_OPERATION;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            int32_t sampleRate;</span><br><span class="line">            <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;sample-rate&quot;</span>, &amp;sampleRate)) &#123;</span><br><span class="line">                sampleRate = <span class="number">8000</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            err = setupG711Codec(encoder, sampleRate, numChannels);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(mime, MEDIA_MIMETYPE_AUDIO_FLAC)) &#123;</span><br><span class="line">        int32_t numChannels = <span class="number">0</span>, sampleRate = <span class="number">0</span>, compressionLevel = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (encoder &amp;&amp;</span><br><span class="line">                (!<span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;channel-count&quot;</span>, &amp;numChannels)</span><br><span class="line">                        || !<span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;sample-rate&quot;</span>, &amp;sampleRate))) &#123;</span><br><span class="line">            ALOGE(<span class="string">&quot;missing channel count or sample rate for FLAC encoder&quot;</span>);</span><br><span class="line">            err = INVALID_OPERATION;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (encoder) &#123;</span><br><span class="line">                <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(</span><br><span class="line">                            <span class="string">&quot;complexity&quot;</span>, &amp;compressionLevel) &amp;&amp;</span><br><span class="line">                    !<span class="function"><span class="title">msg</span>-&gt;</span>findInt32(</span><br><span class="line">                            <span class="string">&quot;flac-compression-level&quot;</span>, &amp;compressionLevel)) &#123;</span><br><span class="line">                    compressionLevel = <span class="number">5</span>; <span class="comment">// default FLAC compression level</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (compressionLevel &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    ALOGW(<span class="string">&quot;compression level %d outside [0..8] range, &quot;</span></span><br><span class="line">                          <span class="string">&quot;using 0&quot;</span>,</span><br><span class="line">                          compressionLevel);</span><br><span class="line">                    compressionLevel = <span class="number">0</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (compressionLevel &gt; <span class="number">8</span>) &#123;</span><br><span class="line">                    ALOGW(<span class="string">&quot;compression level %d outside [0..8] range, &quot;</span></span><br><span class="line">                          <span class="string">&quot;using 8&quot;</span>,</span><br><span class="line">                          compressionLevel);</span><br><span class="line">                    compressionLevel = <span class="number">8</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            err = setupFlacCodec(</span><br><span class="line">                    encoder, numChannels, sampleRate, compressionLevel);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(mime, MEDIA_MIMETYPE_AUDIO_RAW)) &#123;</span><br><span class="line">        int32_t numChannels, sampleRate;</span><br><span class="line">        <span class="keyword">if</span> (encoder</span><br><span class="line">                || !<span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;channel-count&quot;</span>, &amp;numChannels)</span><br><span class="line">                || !<span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;sample-rate&quot;</span>, &amp;sampleRate)) &#123;</span><br><span class="line">            err = INVALID_OPERATION;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            err = setupRawAudioFormat(kPortIndexInput, sampleRate, numChannels);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(mime, MEDIA_MIMETYPE_AUDIO_AC3)) &#123;</span><br><span class="line">        int32_t numChannels;</span><br><span class="line">        int32_t sampleRate;</span><br><span class="line">        <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;channel-count&quot;</span>, &amp;numChannels)</span><br><span class="line">                || !<span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;sample-rate&quot;</span>, &amp;sampleRate)) &#123;</span><br><span class="line">            err = INVALID_OPERATION;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            err = setupAC3Codec(encoder, numChannels, sampleRate);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(mime, MEDIA_MIMETYPE_AUDIO_EAC3)) &#123;</span><br><span class="line">        int32_t numChannels;</span><br><span class="line">        int32_t sampleRate;</span><br><span class="line">        <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;channel-count&quot;</span>, &amp;numChannels)</span><br><span class="line">                || !<span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;sample-rate&quot;</span>, &amp;sampleRate)) &#123;</span><br><span class="line">            err = INVALID_OPERATION;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            err = setupEAC3Codec(encoder, numChannels, sampleRate);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">        return err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;encoder-delay&quot;</span>, &amp;mEncoderDelay)) &#123;</span><br><span class="line">        mEncoderDelay = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;encoder-padding&quot;</span>, &amp;mEncoderPadding)) &#123;</span><br><span class="line">        mEncoderPadding = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">if</span> (msg-&gt;</span>findInt32(<span class="string">&quot;channel-mask&quot;</span>, &amp;mChannelMask)) &#123;</span><br><span class="line">        mChannelMaskPresent = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mChannelMaskPresent = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    int32_t maxInputSize;</span><br><span class="line">    <span class="function"><span class="title">if</span> (msg-&gt;</span>findInt32(<span class="string">&quot;max-input-size&quot;</span>, &amp;maxInputSize)) &#123;</span><br><span class="line">        err = setMinBufferSize(kPortIndexInput, (size_t)maxInputSize);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcmp(<span class="string">&quot;OMX.Nvidia.aac.decoder&quot;</span>, mComponentName.c_str())) &#123;</span><br><span class="line">        err = setMinBufferSize(kPortIndexInput, <span class="number">8192</span>);  <span class="comment">// XXX</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    int32_t priority;</span><br><span class="line">    <span class="function"><span class="title">if</span> (msg-&gt;</span>findInt32(<span class="string">&quot;priority&quot;</span>, &amp;priority)) &#123;</span><br><span class="line">        err = setPriority(priority);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    int32_t rateInt = -<span class="number">1</span>;</span><br><span class="line">    float rateFloat = -<span class="number">1</span>;</span><br><span class="line">    <span class="function"><span class="title">if</span> (!msg-&gt;</span>findFloat(<span class="string">&quot;operating-rate&quot;</span>, &amp;rateFloat)) &#123;</span><br><span class="line">        <span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;operating-rate&quot;</span>, &amp;rateInt);</span><br><span class="line">        rateFloat = (float)rateInt;  <span class="comment">// 16MHz (FLINTMAX) is OK for upper bound.</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (rateFloat &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        err = setOperatingRate(rateFloat, video);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mBaseOutputFormat = outputFormat;</span><br><span class="line"></span><br><span class="line">    err = getPortFormat(kPortIndexInput, inputFormat);</span><br><span class="line">    <span class="keyword">if</span> (err == OK) &#123;</span><br><span class="line">        err = getPortFormat(kPortIndexOutput, outputFormat);</span><br><span class="line">        <span class="keyword">if</span> (err == OK) &#123;</span><br><span class="line">            mInputFormat = inputFormat;</span><br><span class="line">            mOutputFormat = outputFormat;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>到了这里整个解码器的初始化和配置已经结束了，我们看下解码器的start阶段：</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">status_t MediaCodec::start<span class="literal">()</span> &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> <span class="constructor">AMessage(<span class="params">kWhatStart</span>, <span class="params">this</span>)</span>;</span><br><span class="line"></span><br><span class="line">    status_t err;</span><br><span class="line">    Vector&lt;MediaResource&gt; resources;</span><br><span class="line">    const <span class="built_in">char</span> *<span class="keyword">type</span> = (mFlags &amp; kFlagIsSecure) ?</span><br><span class="line">            kResourceSecureCodec : kResourceNonSecureCodec;</span><br><span class="line">    const <span class="built_in">char</span> *subtype = mIsVideo ? kResourceVideoCodec : kResourceAudioCodec;</span><br><span class="line">    resources.push<span class="constructor">_back(MediaResource(String8(<span class="params">type</span>)</span>, <span class="constructor">String8(<span class="params">subtype</span>)</span>, <span class="number">1</span>));</span><br><span class="line">    <span class="comment">// Don&#x27;t know the buffer size at this point, but it&#x27;s fine to use 1 because</span></span><br><span class="line">    <span class="comment">// the reclaimResource call doesn&#x27;t consider the requester&#x27;s buffer size for now.</span></span><br><span class="line">    resources.push<span class="constructor">_back(MediaResource(String8(<span class="params">kResourceGraphicMemory</span>)</span>, <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt;= kMaxRetry; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Don&#x27;t try to reclaim resource for the first time.</span></span><br><span class="line">            <span class="keyword">if</span> (!mResourceManagerService-&gt;reclaim<span class="constructor">Resource(<span class="params">resources</span>)</span>) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Recover codec from previous error before retry start.</span></span><br><span class="line">            err = reset<span class="literal">()</span>;</span><br><span class="line">            <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">                <span class="constructor">ALOGE(<span class="string">&quot;retrying start: failed to reset codec&quot;</span>)</span>;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            sp&lt;AMessage&gt; response;</span><br><span class="line">            err = <span class="constructor">PostAndAwaitResponse(<span class="params">mConfigureMsg</span>, &amp;<span class="params">response</span>)</span>;</span><br><span class="line">            <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">                <span class="constructor">ALOGE(<span class="string">&quot;retrying start: failed to configure codec&quot;</span>)</span>;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        sp&lt;AMessage&gt; response;</span><br><span class="line">        err = <span class="constructor">PostAndAwaitResponse(<span class="params">msg</span>, &amp;<span class="params">response</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (!is<span class="constructor">ResourceError(<span class="params">err</span>)</span>) &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">case kWhatStart:</span><br><span class="line">&#123;</span><br><span class="line">    sp&lt;AReplyToken&gt; replyID;</span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">senderAwaitsResponse</span>(&amp;<span class="params">replyID</span>)</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mState<span class="operator"> == </span>FLUSHED) &#123;</span><br><span class="line">        set<span class="constructor">State(STARTED)</span>;</span><br><span class="line">        <span class="keyword">if</span> (mHavePendingInputBuffers) &#123;</span><br><span class="line">            on<span class="constructor">InputBufferAvailable()</span>;</span><br><span class="line">            mHavePendingInputBuffers = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//我们重点看这里</span></span><br><span class="line">        mCodec-&gt;signal<span class="constructor">Resume()</span>;</span><br><span class="line">        <span class="comment">//..................</span></span><br><span class="line">        <span class="constructor">PostReplyWithError(<span class="params">replyID</span>, OK)</span>;</span><br><span class="line">        break;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mState != CONFIGURED) &#123;</span><br><span class="line">        <span class="constructor">PostReplyWithError(<span class="params">replyID</span>, INVALID_OPERATION)</span>;</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mReplyID = replyID;</span><br><span class="line">    set<span class="constructor">State(STARTING)</span>;</span><br><span class="line"></span><br><span class="line">    mCodec-&gt;initiate<span class="constructor">Start()</span>;</span><br><span class="line">    break;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先調用initiateStart初始化解码器状态</p>
<figure class="highlight livescript"><table><tr><td class="code"><pre><span class="line"><span class="literal">void</span> ACodec::initiateStart() &#123;</span><br><span class="line">    <span class="function"><span class="params">(<span class="keyword">new</span> AMessage(kWhatStart, this))</span>-&gt;</span>post();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> ACodec::kWhatStart:</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">onStart</span>();</span><br><span class="line">    handled = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line">void ACodec::LoadedState::onStart() &#123;</span><br><span class="line">    ALOGV(<span class="string">&quot;onStart&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">status_t</span> err = mCodec-&gt;</span><span class="function"><span class="title">mOMX</span>-&gt;</span><span class="function"><span class="title">sendCommand</span>(mCodec-&gt;</span>mNode, OMX_CommandStateSet, OMX_StateIdle);</span><br><span class="line">    <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">        <span class="function"><span class="title">mCodec</span>-&gt;</span>signalError(OMX_ErrorUndefined, makeNoSideEffectStatus(err));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="function"><span class="title">mCodec</span>-&gt;</span><span class="function"><span class="title">changeState</span>(mCodec-&gt;</span>mLoadedToIdleState);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着开始获取数据进行解码</p>
<figure class="highlight livescript"><table><tr><td class="code"><pre><span class="line"><span class="literal">void</span> ACodec::signalResume() &#123;</span><br><span class="line">    <span class="function"><span class="params">(<span class="keyword">new</span> AMessage(kWhatResume, this))</span>-&gt;</span>post();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight actionscript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> kWhatResume:</span><br><span class="line">&#123;</span><br><span class="line">    resume();</span><br><span class="line">    handled = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line">void ACodec::ExecutingState::resume() &#123;</span><br><span class="line"></span><br><span class="line">    submitOutputBuffers();</span><br><span class="line">    <span class="comment">// Post all available input buffers</span></span><br><span class="line">    <span class="function"><span class="title">if</span> (mCodec-&gt;</span>mBuffers[kPortIndexInput].size() == <span class="number">0</span>u) &#123;</span><br><span class="line">        ALOGW(<span class="string">&quot;[%s] we don&#x27;t have any input buffers to resume&quot;</span>, <span class="function"><span class="title">mCodec</span>-&gt;</span>mComponentName.c_str());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">for</span> (size_t i = 0; i &lt; mCodec-&gt;</span>mBuffers[kPortIndexInput].size(); i++) &#123;</span><br><span class="line">        B<span class="function"><span class="title">ufferInfo</span> *info = &amp;mCodec-&gt;</span>mBuffers[kPortIndexInput].editItemAt(i);</span><br><span class="line">        <span class="function"><span class="title">if</span> (info-&gt;</span>mStatus == BufferInfo::OWNED_BY_US) &#123;</span><br><span class="line">            postFillThisBuffer(info);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mActive = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line">void ACodec::BaseState::postFillThisBuffer(BufferInfo *info) &#123;</span><br><span class="line">    <span class="function"><span class="title">if</span> (mCodec-&gt;</span>mPortEOS[kPortIndexInput]) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CHECK_EQ((<span class="function"><span class="title">int</span>)info-&gt;</span>mStatus, (int)BufferInfo::OWNED_BY_US);</span><br><span class="line">    <span class="function"><span class="title">sp</span>&lt;AMessage&gt; notify = mCodec-&gt;</span><span class="function"><span class="title">mNotify</span>-&gt;</span>dup();</span><br><span class="line">    <span class="function"><span class="title">notify</span>-&gt;</span>setInt32(<span class="string">&quot;what&quot;</span>, CodecBase::kWhatFillThisBuffer);</span><br><span class="line">    <span class="function"><span class="title">notify</span>-&gt;</span><span class="function"><span class="title">setInt32</span>(&quot;buffer-id&quot;, info-&gt;</span>mBufferID);</span><br><span class="line">    <span class="function"><span class="title">info</span>-&gt;</span><span class="function"><span class="title">mData</span>-&gt;</span><span class="function"><span class="title">meta</span>()-&gt;</span>clear();</span><br><span class="line">    <span class="function"><span class="title">notify</span>-&gt;</span><span class="function"><span class="title">setBuffer</span>(&quot;buffer&quot;, info-&gt;</span>mData);</span><br><span class="line">    sp&lt;AMessage&gt; reply = new AMessage(kWhatInputBufferFilled, mCodec);</span><br><span class="line">    <span class="function"><span class="title">reply</span>-&gt;</span><span class="function"><span class="title">setInt32</span>(&quot;buffer-id&quot;, info-&gt;</span>mBufferID);</span><br><span class="line">    <span class="function"><span class="title">notify</span>-&gt;</span>setMessage(<span class="string">&quot;reply&quot;</span>, reply);</span><br><span class="line">    <span class="function"><span class="title">notify</span>-&gt;</span>post();</span><br><span class="line">    <span class="function"><span class="title">info</span>-&gt;</span>mStatus = BufferInfo::OWNED_BY_UPSTREAM;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">case CodecBase::kWhatFillThisBuffer:</span><br><span class="line">&#123;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">//..........</span></span><br><span class="line">    <span class="keyword">if</span> (mFlags &amp; kFlagIsAsync) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mHaveInputSurface) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mState<span class="operator"> == </span>FLUSHED) &#123;</span><br><span class="line">                mHavePendingInputBuffers = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                on<span class="constructor">InputBufferAvailable()</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mFlags &amp; kFlagDequeueInputPending) &#123;</span><br><span class="line">        <span class="constructor">CHECK(<span class="params">handleDequeueInputBuffer</span>(<span class="params">mDequeueInputReplyID</span>)</span>);</span><br><span class="line">        ++mDequeueInputTimeoutGeneration;</span><br><span class="line">        mFlags &amp;= ~kFlagDequeueInputPending;</span><br><span class="line">        mDequeueInputReplyID = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        post<span class="constructor">ActivityNotificationIfPossible()</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    break;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line">void MediaCodec::onInputBufferAvailable() &#123;</span><br><span class="line">    int32_t index;</span><br><span class="line">    <span class="keyword">while</span> ((index = dequeuePortBuffer(kPortIndexInput)) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="function"><span class="title">sp</span>&lt;AMessage&gt; msg = mCallback-&gt;</span>dup();</span><br><span class="line">        <span class="function"><span class="title">msg</span>-&gt;</span>setInt32(<span class="string">&quot;callbackID&quot;</span>, CB_INPUT_AVAILABLE);</span><br><span class="line">        <span class="function"><span class="title">msg</span>-&gt;</span>setInt32(<span class="string">&quot;index&quot;</span>, index);</span><br><span class="line">        <span class="function"><span class="title">msg</span>-&gt;</span>post();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还记得这个mCallback怎么来的吗？</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void NuPlayer::Decoder::on<span class="constructor">Configure(<span class="params">const</span> <span class="params">sp</span>&lt;AMessage&gt; &amp;<span class="params">format</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//.................</span></span><br><span class="line">    sp&lt;AMessage&gt; reply = <span class="keyword">new</span> <span class="constructor">AMessage(<span class="params">kWhatCodecNotify</span>, <span class="params">this</span>)</span>;</span><br><span class="line">    mCodec-&gt;set<span class="constructor">Callback(<span class="params">reply</span>)</span>;</span><br><span class="line">	<span class="comment">//..................</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">status_t MediaCodec::set<span class="constructor">Callback(<span class="params">const</span> <span class="params">sp</span>&lt;AMessage&gt; &amp;<span class="params">callback</span>)</span> &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> <span class="constructor">AMessage(<span class="params">kWhatSetCallback</span>, <span class="params">this</span>)</span>;</span><br><span class="line">    msg-&gt;set<span class="constructor">Message(<span class="string">&quot;callback&quot;</span>, <span class="params">callback</span>)</span>;</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; response;</span><br><span class="line">    return <span class="constructor">PostAndAwaitResponse(<span class="params">msg</span>, &amp;<span class="params">response</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">case kWhatSetCallback:</span><br><span class="line">&#123;</span><br><span class="line">    sp&lt;AReplyToken&gt; replyID;</span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">senderAwaitsResponse</span>(&amp;<span class="params">replyID</span>)</span>);</span><br><span class="line">    sp&lt;AMessage&gt; callback;</span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">findMessage</span>(<span class="string">&quot;callback&quot;</span>, &amp;<span class="params">callback</span>)</span>);</span><br><span class="line"></span><br><span class="line">    mCallback = callback;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mCallback != NULL) &#123;</span><br><span class="line">        mFlags <span class="pattern-match">|= k<span class="constructor">FlagIsAsync</span>;</span></span><br><span class="line"><span class="pattern-match">    &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="pattern-match">        m<span class="constructor">Flags</span> &amp;= ~k<span class="constructor">FlagIsAsync</span>;</span></span><br><span class="line"><span class="pattern-match">    &#125;</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">    sp&lt;<span class="constructor">AMessage</span>&gt; response = <span class="keyword">new</span> <span class="constructor">AMessage</span>;</span></span><br><span class="line"><span class="pattern-match">    response-&gt;post<span class="constructor">Reply(<span class="params">replyID</span>)</span>;</span></span><br><span class="line"><span class="pattern-match">    break;</span></span><br><span class="line"><span class="pattern-match">&#125;</span></span><br></pre></td></tr></table></figure>
<p>所以根据上面我们可以知道接下来i调用的是kWhatCodecNotify 下的 CB_INPUT_AVAILABLE</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">case MediaCodec::CB_INPUT_AVAILABLE:</span><br><span class="line">&#123;</span><br><span class="line">    int32_t index;</span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">findInt32</span>(<span class="string">&quot;index&quot;</span>, &amp;<span class="params">index</span>)</span>);</span><br><span class="line"></span><br><span class="line">    handle<span class="constructor">AnInputBuffer(<span class="params">index</span>)</span>;</span><br><span class="line">    break;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="built_in">bool</span> NuPlayer::Decoder::handle<span class="constructor">AnInputBuffer(<span class="params">size_t</span> <span class="params">index</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (is<span class="constructor">DiscontinuityPending()</span>) &#123;</span><br><span class="line">        return <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;ABuffer&gt; buffer;</span><br><span class="line">    mCodec-&gt;get<span class="constructor">InputBuffer(<span class="params">index</span>, &amp;<span class="params">buffer</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (buffer<span class="operator"> == </span>NULL) &#123;</span><br><span class="line">        handle<span class="constructor">Error(UNKNOWN_ERROR)</span>;</span><br><span class="line">        return <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index &gt;= mInputBuffers.size<span class="literal">()</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (size_t i = mInputBuffers.size<span class="literal">()</span>; i &lt;= index; ++i) &#123;</span><br><span class="line">            mInputBuffers.add<span class="literal">()</span>;</span><br><span class="line">            mMediaBuffers.add<span class="literal">()</span>;</span><br><span class="line">            mInputBufferIsDequeued.add<span class="literal">()</span>;</span><br><span class="line">            mMediaBuffers.edit<span class="constructor">ItemAt(<span class="params">i</span>)</span> = NULL;</span><br><span class="line">            mInputBufferIsDequeued.edit<span class="constructor">ItemAt(<span class="params">i</span>)</span> = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mInputBuffers.edit<span class="constructor">ItemAt(<span class="params">index</span>)</span> = buffer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//CHECK_LT(bufferIx, mInputBuffers.size());</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mMediaBuffers<span class="literal">[<span class="identifier">index</span>]</span> != NULL) &#123;</span><br><span class="line">        mMediaBuffers<span class="literal">[<span class="identifier">index</span>]</span>-&gt;release<span class="literal">()</span>;</span><br><span class="line">        mMediaBuffers.edit<span class="constructor">ItemAt(<span class="params">index</span>)</span> = NULL;</span><br><span class="line">    &#125;</span><br><span class="line">    mInputBufferIsDequeued.edit<span class="constructor">ItemAt(<span class="params">index</span>)</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mCSDsToSubmit.is<span class="constructor">Empty()</span>) &#123;</span><br><span class="line">        sp&lt;AMessage&gt; msg = <span class="keyword">new</span> <span class="constructor">AMessage()</span>;</span><br><span class="line">        msg-&gt;set<span class="constructor">Size(<span class="string">&quot;buffer-ix&quot;</span>, <span class="params">index</span>)</span>;</span><br><span class="line"></span><br><span class="line">        sp&lt;ABuffer&gt; buffer = mCSDsToSubmit.item<span class="constructor">At(0)</span>;</span><br><span class="line">        <span class="constructor">ALOGI(<span class="string">&quot;[%s] resubmitting CSD&quot;</span>, <span class="params">mComponentName</span>.<span class="params">c_str</span>()</span>);</span><br><span class="line">        msg-&gt;set<span class="constructor">Buffer(<span class="string">&quot;buffer&quot;</span>, <span class="params">buffer</span>)</span>;</span><br><span class="line">        mCSDsToSubmit.remove<span class="constructor">At(0)</span>;</span><br><span class="line">        <span class="constructor">CHECK(<span class="params">onInputBufferFetched</span>(<span class="params">msg</span>)</span>);</span><br><span class="line">        return <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!mPendingInputMessages.empty<span class="literal">()</span>) &#123;</span><br><span class="line">        sp&lt;AMessage&gt; msg = *mPendingInputMessages.<span class="keyword">begin</span><span class="literal">()</span>;</span><br><span class="line">        <span class="keyword">if</span> (!on<span class="constructor">InputBufferFetched(<span class="params">msg</span>)</span>) &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        mPendingInputMessages.erase(mPendingInputMessages.<span class="keyword">begin</span><span class="literal">()</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mInputBufferIsDequeued.edit<span class="constructor">ItemAt(<span class="params">index</span>)</span>) &#123;</span><br><span class="line">        return <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mDequeuedInputBuffers.push<span class="constructor">_back(<span class="params">index</span>)</span>;</span><br><span class="line"></span><br><span class="line">    on<span class="constructor">RequestInputBuffers()</span>;</span><br><span class="line">    return <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void NuPlayer::DecoderBase::on<span class="constructor">RequestInputBuffers()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mRequestInputBuffersPending) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// doRequestBuffers() return true if we should request more data</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">do</span><span class="constructor">RequestBuffers()</span>) &#123;</span><br><span class="line">        mRequestInputBuffersPending = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        sp&lt;AMessage&gt; msg = <span class="keyword">new</span> <span class="constructor">AMessage(<span class="params">kWhatRequestInputBuffers</span>, <span class="params">this</span>)</span>;</span><br><span class="line">        msg-&gt;post(<span class="number">10</span><span class="operator"> * </span><span class="number">1000l</span>l);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="built_in">bool</span> NuPlayer::Decoder::<span class="keyword">do</span><span class="constructor">RequestBuffers()</span> &#123;</span><br><span class="line">    <span class="comment">// mRenderer is only NULL if we have a legacy widevine source that</span></span><br><span class="line">    <span class="comment">// is not yet ready. In this case we must not fetch input.</span></span><br><span class="line">    <span class="keyword">if</span> (is<span class="constructor">DiscontinuityPending()</span><span class="operator"> || </span>mRenderer<span class="operator"> == </span>NULL) &#123;</span><br><span class="line">        return <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    status_t err = OK;</span><br><span class="line">    <span class="keyword">while</span> (err<span class="operator"> == </span>OK<span class="operator"> &amp;&amp; </span>!mDequeuedInputBuffers.empty<span class="literal">()</span>) &#123;</span><br><span class="line">        size_t bufferIx = *mDequeuedInputBuffers.<span class="keyword">begin</span><span class="literal">()</span>;</span><br><span class="line">        sp&lt;AMessage&gt; msg = <span class="keyword">new</span> <span class="constructor">AMessage()</span>;</span><br><span class="line">        msg-&gt;set<span class="constructor">Size(<span class="string">&quot;buffer-ix&quot;</span>, <span class="params">bufferIx</span>)</span>;</span><br><span class="line">        err = fetch<span class="constructor">InputData(<span class="params">msg</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (err != OK<span class="operator"> &amp;&amp; </span>err != ERROR_END_OF_STREAM) &#123;</span><br><span class="line">            <span class="comment">// if EOS, need to queue EOS buffer</span></span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        mDequeuedInputBuffers.erase(mDequeuedInputBuffers.<span class="keyword">begin</span><span class="literal">()</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!mPendingInputMessages.empty<span class="literal">()</span><span class="operator"></span></span><br><span class="line"><span class="operator">                || </span>!on<span class="constructor">InputBufferFetched(<span class="params">msg</span>)</span>) &#123;</span><br><span class="line">            mPendingInputMessages.push<span class="constructor">_back(<span class="params">msg</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return err<span class="operator"> == </span>-EWOULDBLOCK<span class="operator"></span></span><br><span class="line"><span class="operator">            &amp;&amp; </span>mSource-&gt;feed<span class="constructor">MoreTSData()</span><span class="operator"> == </span>OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line">status_t NuPlayer::Decoder::<span class="title function_ invoke__">fetchInputData</span>(sp&lt;AMessage&gt; &amp;reply) &#123;</span><br><span class="line">    sp&lt;ABuffer&gt; accessUnit;</span><br><span class="line">    <span class="type">bool</span> dropAccessUnit;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        status_t err = mSource<span class="punctuation">-&gt;</span><span class="title function_ invoke__">dequeueAccessUnit</span>(mIsAudio, &amp;accessUnit);</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">if</span> (err == -EWOULDBLOCK) &#123;</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="title function_ invoke__">if</span> (err != OK) &#123;</span><br><span class="line">            <span class="title function_ invoke__">if</span> (err == INFO_DISCONTINUITY) &#123;</span><br><span class="line">                int32_t <span class="keyword">type</span>;</span><br><span class="line">                <span class="title function_ invoke__">CHECK</span>(accessUnit<span class="punctuation">-&gt;</span><span class="title function_ invoke__">meta</span>()<span class="punctuation">-&gt;</span><span class="title function_ invoke__">findInt32</span>(<span class="string">&quot;discontinuity&quot;</span>, &amp;<span class="keyword">type</span>));</span><br><span class="line"></span><br><span class="line">                <span class="type">bool</span> formatChange =</span><br><span class="line">                    (mIsAudio &amp;&amp;</span><br><span class="line">                     (<span class="keyword">type</span> &amp; ATSParser::DISCONTINUITY_AUDIO_FORMAT))</span><br><span class="line">                    || (!mIsAudio &amp;&amp;</span><br><span class="line">                            (<span class="keyword">type</span> &amp; ATSParser::DISCONTINUITY_VIDEO_FORMAT));</span><br><span class="line"></span><br><span class="line">                <span class="type">bool</span> timeChange = (<span class="keyword">type</span> &amp; ATSParser::DISCONTINUITY_TIME) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                <span class="title function_ invoke__">ALOGI</span>(<span class="string">&quot;%s discontinuity (format=%d, time=%d)&quot;</span>,</span><br><span class="line">                        mIsAudio ? <span class="string">&quot;audio&quot;</span> : <span class="string">&quot;video&quot;</span>, formatChange, timeChange);</span><br><span class="line"></span><br><span class="line">                <span class="type">bool</span> seamlessFormatChange = <span class="literal">false</span>;</span><br><span class="line">                sp&lt;AMessage&gt; newFormat = mSource<span class="punctuation">-&gt;</span><span class="title function_ invoke__">getFormat</span>(mIsAudio);</span><br><span class="line">                <span class="title function_ invoke__">if</span> (formatChange) &#123;</span><br><span class="line">                    seamlessFormatChange =</span><br><span class="line">                        <span class="title function_ invoke__">supportsSeamlessFormatChange</span>(newFormat);</span><br><span class="line">                    <span class="comment">// treat seamless format change separately</span></span><br><span class="line">                    formatChange = !seamlessFormatChange;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// For format or time change, return EOS to queue EOS input,</span></span><br><span class="line">                <span class="comment">// then wait for EOS on output.</span></span><br><span class="line">                <span class="title function_ invoke__">if</span> (formatChange <span class="comment">/* not seamless */</span>) &#123;</span><br><span class="line">                    mFormatChangePending = <span class="literal">true</span>;</span><br><span class="line">                    err = ERROR_END_OF_STREAM;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="title function_ invoke__">if</span> (timeChange) &#123;</span><br><span class="line">                    <span class="title function_ invoke__">rememberCodecSpecificData</span>(newFormat);</span><br><span class="line">                    mTimeChangePending = <span class="literal">true</span>;</span><br><span class="line">                    err = ERROR_END_OF_STREAM;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="title function_ invoke__">if</span> (seamlessFormatChange) &#123;</span><br><span class="line">                    <span class="comment">// reuse existing decoder and don&#x27;t flush</span></span><br><span class="line">                    <span class="title function_ invoke__">rememberCodecSpecificData</span>(newFormat);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// This stream is unaffected by the discontinuity</span></span><br><span class="line">                    <span class="keyword">return</span> -EWOULDBLOCK;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// reply should only be returned without a buffer set</span></span><br><span class="line">            <span class="comment">// when there is an error (including EOS)</span></span><br><span class="line">            <span class="title function_ invoke__">CHECK</span>(err != OK);</span><br><span class="line"></span><br><span class="line">            reply<span class="punctuation">-&gt;</span><span class="title function_ invoke__">setInt32</span>(<span class="string">&quot;err&quot;</span>, err);</span><br><span class="line">            <span class="keyword">return</span> ERROR_END_OF_STREAM;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        dropAccessUnit = <span class="literal">false</span>;</span><br><span class="line">        <span class="title function_ invoke__">if</span> (!mIsAudio</span><br><span class="line">                &amp;&amp; !mIsSecure</span><br><span class="line">                &amp;&amp; mRenderer<span class="punctuation">-&gt;</span><span class="title function_ invoke__">getVideoLateByUs</span>() &gt; <span class="number">100000</span>ll</span><br><span class="line">                &amp;&amp; mIsVideoAVC</span><br><span class="line">                &amp;&amp; !<span class="title function_ invoke__">IsAVCReferenceFrame</span>(accessUnit)) &#123;</span><br><span class="line">            dropAccessUnit = <span class="literal">true</span>;</span><br><span class="line">            ++mNumInputFramesDropped;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="title function_ invoke__">while</span> (dropAccessUnit);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ALOGV(&quot;returned a valid buffer of %s data&quot;, mIsAudio ? &quot;mIsAudio&quot; : &quot;video&quot;);</span></span><br><span class="line">#<span class="keyword">if</span> <span class="number">0</span></span><br><span class="line">    int64_t mediaTimeUs;</span><br><span class="line">    <span class="title function_ invoke__">CHECK</span>(accessUnit<span class="punctuation">-&gt;</span><span class="title function_ invoke__">meta</span>()<span class="punctuation">-&gt;</span><span class="title function_ invoke__">findInt64</span>(<span class="string">&quot;timeUs&quot;</span>, &amp;mediaTimeUs));</span><br><span class="line">    <span class="title function_ invoke__">ALOGV</span>(<span class="string">&quot;[%s] feeding input buffer at media time %.3f&quot;</span>,</span><br><span class="line">         mIsAudio ? <span class="string">&quot;audio&quot;</span> : <span class="string">&quot;video&quot;</span>,</span><br><span class="line">         mediaTimeUs / <span class="number">1E6</span>);</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">if</span> (mCCDecoder != NULL) &#123;</span><br><span class="line">        mCCDecoder<span class="punctuation">-&gt;</span><span class="title function_ invoke__">decode</span>(accessUnit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    reply<span class="punctuation">-&gt;</span><span class="title function_ invoke__">setBuffer</span>(<span class="string">&quot;buffer&quot;</span>, accessUnit);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">Android 源码分析</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/AOSP-源码/">AOSP 源码</a>
  </div>

</div>



</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2016/08/03/Android-源码分析Android系统启动流程/" title="Android 源码分析Android系统启动流程">
  <span>
  Android 源码分析Android系统启动流程</span>
</a>
</div>


<div class="next">
<a href="/2016/08/02/Android-进阶之源码分析基于NuPlayer的HLS流媒体协议/"  title="Android 源码分析之基于NuPlayer的HLS流媒体协议">
 <span>Android 源码分析之基于NuPlayer的HLS流媒体协议
</span>
</a>
</div>

</nav>

	
<section id="comments" class="comment">
	<div class="ds-thread" data-thread-key="2016/08/02/Android-进阶之源码分析基于NuPlayer的RTSP流媒体协议/" data-title="Android 源码分析之基于NuPlayer的RTSP流媒体协议" data-url="http://yoursite.com/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84RTSP%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/"></div>
</section>


<section id="comments" class="comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
 
 <ol class="toc"><li class="toc-item toc-level-5"><a class="toc-link" href="#RTSP-%E6%A6%82%E8%BF%B0%EF%BC%9A"><span class="toc-number">1.</span> <span class="toc-text">RTSP 概述：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#RTSP-%E6%A8%A1%E5%9E%8B%EF%BC%9A"><span class="toc-number">2.</span> <span class="toc-text">RTSP 模型：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#RTSP-%E5%8D%8F%E8%AE%AE%E6%B6%88%E6%81%AF%E6%A0%BC%E5%BC%8F%EF%BC%9A"><span class="toc-number">3.</span> <span class="toc-text">RTSP 协议消息格式：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E7%9A%84RTSP-%E4%BA%A4%E4%BA%92%E8%BF%87%E7%A8%8B"><span class="toc-number">4.</span> <span class="toc-text">简单的RTSP 交互过程:</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#RTSP%E7%9A%84%E4%B8%BB%E8%A6%81%E5%91%BD%E4%BB%A4%E8%A1%A8%EF%BC%9A"><span class="toc-number">5.</span> <span class="toc-text">RTSP的主要命令表：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#RTSP%E7%8A%B6%E6%80%81%E7%A0%81%EF%BC%9A"><span class="toc-number">6.</span> <span class="toc-text">RTSP状态码：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SDP%E7%9A%84%E6%A0%BC%E5%BC%8F%EF%BC%9A"><span class="toc-number">7.</span> <span class="toc-text">SDP的格式：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#RTP%E5%8D%8F%E8%AE%AE%EF%BC%9A"><span class="toc-number">8.</span> <span class="toc-text">RTP协议：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#RTP%E5%8D%8F%E8%AE%AE%E6%8A%A5%E5%A4%B4%E6%A0%BC%E5%BC%8F"><span class="toc-number">9.</span> <span class="toc-text">RTP协议报头格式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#RTCP%E5%8D%8F%E8%AE%AE%E6%8A%A5%E5%A4%B4%E6%A0%BC%E5%BC%8F"><span class="toc-number">10.</span> <span class="toc-text">RTCP协议报头格式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8ENuPLayer%E7%9A%84RTSP-%E4%BB%A3%E7%A0%81%E6%B5%81%E7%A8%8B"><span class="toc-number">11.</span> <span class="toc-text">基于NuPLayer的RTSP 代码流程</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">
<div id="authorInfo">
	
		<div class="author-img"></div>		
	
	<div class="social-info" class="clearfix">
		
		
		<a href="https://github.com/tbfungeek" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
		
		<a href="mailto:tbfungeek@163.com" target="_blank" class="icon-email" title="Email Me"></a>
		

	</div>
</div>

  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
		  
			<li><a href="/categories/Android-小经验/" title="Android 小经验">Android 小经验<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android-源码分析/" title="Android 源码分析">Android 源码分析<sup>21</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android其他/" title="Android其他">Android其他<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android初步/" title="Android初步">Android初步<sup>21</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android进阶/" title="Android进阶">Android进阶<sup>100</sup></a></li>
		  
		
		  
			<li><a href="/categories/Hexo-使用/" title="Hexo 使用">Hexo 使用<sup>10</sup></a></li>
		  
		
		  
			<li><a href="/categories/JavaScript理论/" title="JavaScript理论">JavaScript理论<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Objective-C-相关/" title="Objective C 相关">Objective C 相关<sup>24</sup></a></li>
		  
		
		  
			<li><a href="/categories/OpenCV/" title="OpenCV">OpenCV<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/ROS/" title="ROS">ROS<sup>9</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-工具使用/" title="iOS 工具使用">iOS 工具使用<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-开源库分析/" title="iOS 开源库分析">iOS 开源库分析<sup>36</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-理论基础/" title="iOS 理论基础">iOS 理论基础<sup>14</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-进阶/" title="iOS 进阶">iOS 进阶<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/个人收藏/" title="个人收藏">个人收藏<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/代码规范/" title="代码规范">代码规范<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/其他/" title="其他">其他<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/博客分类目录/" title="博客分类目录">博客分类目录<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/叨叨系列/" title="叨叨系列">叨叨系列<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/开源代码分析/" title="开源代码分析">开源代码分析<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/开源库分析/" title="开源库分析">开源库分析<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/树莓派/" title="树莓派">树莓派<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/版本控制/" title="版本控制">版本控制<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/直播/" title="直播">直播<sup>6</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/iOS-开源库分析/" title="iOS 开源库分析">iOS 开源库分析<sup>36</sup></a></li>
			
		
			
				<li><a href="/tags/Android-设计模式/" title="Android 设计模式">Android 设计模式<sup>29</sup></a></li>
			
		
			
				<li><a href="/tags/Objective-C-相关/" title="Objective C 相关">Objective C 相关<sup>24</sup></a></li>
			
		
			
				<li><a href="/tags/Android基础/" title="Android基础">Android基础<sup>21</sup></a></li>
			
		
			
				<li><a href="/tags/AOSP-源码/" title="AOSP 源码">AOSP 源码<sup>17</sup></a></li>
			
		
			
				<li><a href="/tags/Android-常用第三方库/" title="Android 常用第三方库">Android 常用第三方库<sup>15</sup></a></li>
			
		
			
				<li><a href="/tags/iOS-理论基础/" title="iOS 理论基础">iOS 理论基础<sup>14</sup></a></li>
			
		
			
				<li><a href="/tags/Hexo-使用/" title="Hexo 使用">Hexo 使用<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/ROS/" title="ROS">ROS<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/Android-动画进阶/" title="Android 动画进阶">Android 动画进阶<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/Android-JNI/" title="Android JNI">Android JNI<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android-绘图进阶/" title="Android 绘图进阶">Android 绘图进阶<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android性能优化/" title="Android性能优化">Android性能优化<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android-自动化测试/" title="Android 自动化测试">Android 自动化测试<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/OpenCV/" title="OpenCV">OpenCV<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/直播/" title="直播">直播<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android-开源源码/" title="Android 开源源码">Android 开源源码<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Android-自定义View进阶/" title="Android 自定义View进阶">Android 自定义View进阶<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/树莓派/" title="树莓派">树莓派<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/iOS-进阶/" title="iOS 进阶">iOS 进阶<sup>4</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="https://hexo.io" target="_blank" title="Hexo">Hexo</a>
            
          </li>
        
          <li>
            
            	<a href="https://pages.github.com/" target="_blank" title="GitHub">GitHub</a>
            
          </li>
        
          <li>
            
            	<a href="http://pf18.github.io/" target="_blank" title="PF18">PF18</a>
            
          </li>
        
          <li>
            
            	<a href="http://toutiao.io/" target="_blank" title="开发者头条">开发者头条</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.jcodecraeer.com/" target="_blank" title="泡在网上的日子">泡在网上的日子</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="atom.xml" target="_blank" title="rss">RSS</a>
</div>

  
  <div class="tagcloudlist">
    <p class="asidetitle">Tag Cloud</p>
    <div class="tagcloudlist clearfix">
       <a href="/tags/AOSP-%E6%BA%90%E7%A0%81/" style="font-size: 17.14px;">AOSP 源码</a> <a href="/tags/Android-APK-%E7%AD%BE%E5%90%8D/" style="font-size: 10px;">Android APK 签名</a> <a href="/tags/Android-JNI/" style="font-size: 12.86px;">Android JNI</a> <a href="/tags/Android-%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E8%BF%9B%E9%98%B6/" style="font-size: 10.71px;">Android 事件处理进阶</a> <a href="/tags/Android-%E5%8A%A8%E7%94%BB%E8%BF%9B%E9%98%B6/" style="font-size: 13.57px;">Android 动画进阶</a> <a href="/tags/Android-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%BC%80%E5%8F%91/" style="font-size: 10px;">Android 多线程开发</a> <a href="/tags/Android-%E5%B0%8F%E7%BB%8F%E9%AA%8C/" style="font-size: 10px;">Android 小经验</a> <a href="/tags/Android-%E5%B8%B8%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93/" style="font-size: 16.43px;">Android 常用第三方库</a> <a href="/tags/Android-%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B/" style="font-size: 10px;">Android 开发流程</a> <a href="/tags/Android-%E5%BC%80%E6%BA%90%E6%BA%90%E7%A0%81/" style="font-size: 12.14px;">Android 开源源码</a> <a href="/tags/Android-%E7%BB%98%E5%9B%BE%E8%BF%9B%E9%98%B6/" style="font-size: 12.86px;">Android 绘图进阶</a> <a href="/tags/Android-%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/" style="font-size: 12.86px;">Android 自动化测试</a> <a href="/tags/Android-%E8%87%AA%E5%AE%9A%E4%B9%89View%E8%BF%9B%E9%98%B6/" style="font-size: 12.14px;">Android 自定义View进阶</a> <a href="/tags/Android-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 19.29px;">Android 设计模式</a> <a href="/tags/Android%E5%85%B6%E4%BB%96/" style="font-size: 10px;">Android其他</a> <a href="/tags/Android%E5%9F%BA%E7%A1%80/" style="font-size: 17.86px;">Android基础</a> <a href="/tags/Android%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B/" style="font-size: 10px;">Android开发流程</a> <a href="/tags/Android%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" style="font-size: 12.86px;">Android性能优化</a> <a href="/tags/Android%E6%B7%B7%E6%B7%86%E6%8A%80%E6%9C%AF/" style="font-size: 10px;">Android混淆技术</a> <a href="/tags/Android%E8%B4%A8%E9%87%8F%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/" style="font-size: 11.43px;">Android质量管理工具</a> <a href="/tags/Android%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/" style="font-size: 10px;">Android逆向工程</a> <a href="/tags/Git-github/" style="font-size: 10px;">Git && github</a> <a href="/tags/Hexo-%E4%BD%BF%E7%94%A8/" style="font-size: 15px;">Hexo 使用</a> <a href="/tags/JavaScript/" style="font-size: 10px;">JavaScript</a> <a href="/tags/Linux-%E4%BD%BF%E7%94%A8/" style="font-size: 10px;">Linux 使用</a> <a href="/tags/Objective-C-%E7%9B%B8%E5%85%B3/" style="font-size: 18.57px;">Objective C 相关</a> <a href="/tags/OpenCV/" style="font-size: 12.86px;">OpenCV</a> <a href="/tags/ROS/" style="font-size: 14.29px;">ROS</a> <a href="/tags/iOS-%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/" style="font-size: 10.71px;">iOS 工具使用</a> <a href="/tags/iOS-%E5%BC%80%E6%BA%90%E5%BA%93%E5%88%86%E6%9E%90/" style="font-size: 20px;">iOS 开源库分析</a> <a href="/tags/iOS-%E7%90%86%E8%AE%BA%E5%9F%BA%E7%A1%80/" style="font-size: 15.71px;">iOS 理论基础</a> <a href="/tags/iOS-%E8%BF%9B%E9%98%B6/" style="font-size: 12.14px;">iOS 进阶</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83/" style="font-size: 10px;">代码规范</a> <a href="/tags/%E5%8D%9A%E5%AE%A2%E5%88%86%E7%B1%BB%E7%9B%AE%E5%BD%95/" style="font-size: 10.71px;">博客分类目录</a> <a href="/tags/%E5%8F%A8%E5%8F%A8%E7%B3%BB%E5%88%97/" style="font-size: 10px;">叨叨系列</a> <a href="/tags/%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8/" style="font-size: 11.43px;">工具的使用</a> <a href="/tags/%E5%BC%80%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/" style="font-size: 10.71px;">开源代码分析</a> <a href="/tags/%E5%BC%80%E6%BA%90%E5%BA%93%E5%88%86%E6%9E%90/" style="font-size: 10px;">开源库分析</a> <a href="/tags/%E6%9D%82%E7%B1%BB/" style="font-size: 10px;">杂类</a> <a href="/tags/%E6%A0%91%E8%8E%93%E6%B4%BE/" style="font-size: 12.14px;">树莓派</a> <a href="/tags/%E7%9B%B4%E6%92%AD/" style="font-size: 12.86px;">直播</a> <a href="/tags/%E7%BC%96%E7%A8%8B%E6%8A%80%E5%B7%A7/" style="font-size: 10.71px;">编程技巧</a> <a href="/tags/%E7%BD%91%E7%AB%99%E6%94%B6%E8%97%8F/" style="font-size: 10px;">网站收藏</a> <a href="/tags/%E9%87%8D%E8%A6%81%E6%8E%A7%E4%BB%B6/" style="font-size: 11.43px;">重要控件</a>
    </div>
  </div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
		
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/hsihohuang/kiddochan" target="_blank" title="Kiddochan">Kiddochan</a> © 2022 
		
		<a href="/about" target="_blank" title="Edgar">Edgar</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
        getSize();
        if (myWidth >= 1024) {
          c.click();
        }
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>




<script type="text/javascript">
  var duoshuoQuery = {short_name:"tbfungeek"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 


<script type="text/javascript">

var disqus_shortname = 'tbfungeek';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>






<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?7c9443b0374f1cf6b1dbb5ab84d939cb";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
