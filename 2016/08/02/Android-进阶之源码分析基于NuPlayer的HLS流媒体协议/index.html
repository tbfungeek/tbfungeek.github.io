
 <!DOCTYPE HTML>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  
    <title>Android 源码分析之基于NuPlayer的HLS流媒体协议 | Edgar&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Edgar">
    

    
    <meta name="description" content="HLS 概述HTTP Live Streaming（HLS）是苹果公司实现的基于HTTP的流媒体直播和点播协议，主要应用在iOS系统。相对于普通的流媒体，例如RTMP协议、RTSP协议、MMS协议等，HLS最大的优点是可以根据网络状况自动切换到不同码率的视频，如果网络状况较好，则会切换到高码率的视频，若发现网络状况不佳，则会逐渐过渡到低码率的视频，这个我们下面将会结合代码对其进行说明。 HLS框架">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 源码分析之基于NuPlayer的HLS流媒体协议">
<meta property="og:url" content="http://yoursite.com/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84HLS%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/index.html">
<meta property="og:site_name" content="Edgar&#39;s Blog">
<meta property="og:description" content="HLS 概述HTTP Live Streaming（HLS）是苹果公司实现的基于HTTP的流媒体直播和点播协议，主要应用在iOS系统。相对于普通的流媒体，例如RTMP协议、RTSP协议、MMS协议等，HLS最大的优点是可以根据网络状况自动切换到不同码率的视频，如果网络状况较好，则会切换到高码率的视频，若发现网络状况不佳，则会逐渐过渡到低码率的视频，这个我们下面将会结合代码对其进行说明。 HLS框架">
<meta property="og:locale">
<meta property="og:image" content="http://yoursite.com/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84HLS%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/0.png">
<meta property="og:image" content="http://yoursite.com/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84HLS%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/4.png">
<meta property="og:image" content="http://yoursite.com/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84HLS%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/1.png">
<meta property="og:image" content="http://yoursite.com/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84HLS%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/2.png">
<meta property="og:image" content="http://yoursite.com/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84HLS%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/3.png">
<meta property="article:published_time" content="2016-08-02T14:58:01.000Z">
<meta property="article:modified_time" content="2016-08-05T23:55:00.000Z">
<meta property="article:author" content="Edgar">
<meta property="article:tag" content="AOSP 源码">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84HLS%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/0.png">

    
    <link rel="alternative" href="atom.xml" title="Edgar&#39;s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/unnamed4_n_mSY_icon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/profile.png">
    <link rel="apple-touch-icon-precomposed" href="/img/profile.png">
    
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.2.0"></head>

  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Edgar&#39;s Blog">Edgar&#39;s Blog</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
					<li>
 					
					<form class="search" action="/search/index.html" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" autocomplete="off" name="q" maxlength="20" placeholder="Search" />
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/08/02/Android-进阶之源码分析基于NuPlayer的HLS流媒体协议/" title="Android 源码分析之基于NuPlayer的HLS流媒体协议" itemprop="url">Android 源码分析之基于NuPlayer的HLS流媒体协议</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Edgar" target="_blank" itemprop="author">Edgar</a>
		
  <p class="article-time">
    <time datetime="2016-08-02T14:58:01.000Z" itemprop="datePublished"> Published 2016-08-02</time>
    
  </p>
</header>
	<div class="article-content">
		
		<h4 id="HLS-概述"><a href="#HLS-概述" class="headerlink" title="HLS 概述"></a>HLS 概述</h4><p>HTTP Live Streaming（HLS）是苹果公司实现的基于HTTP的流媒体直播和点播协议，主要应用在iOS系统。相对于普通的流媒体，例如RTMP协议、RTSP协议、MMS协议等，HLS最大的优点是可以根据网络状况自动切换到不同码率的视频，如果网络状况较好，则会切换到高码率的视频，若发现网络状况不佳，则会逐渐过渡到低码率的视频，这个我们下面将会结合代码对其进行说明。</p>
<h4 id="HLS框架介绍"><a href="#HLS框架介绍" class="headerlink" title="HLS框架介绍"></a>HLS框架介绍</h4><p>我们接下来看下HLS系统的整体结构图：</p>
<p><img src="/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84HLS%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/0.png"></p>
<p>我们首先将要直播的视频送到编码器中，编码器分别对视频和音频进行编码，然后输出到一个MPEG-2格式的传输流中，再由分段器将MPEG-2传输流进行分段，产生一系列等间隔的媒体片段，这些媒体片段一般很小并且保存成后缀为.ts的文件，同时生成一个指向这些媒体文件的索引文件，也就是我们很经常听到的.M3U8文件。完成分段之后将这些索引文件以及媒体文件上传到Web服务器上。客户端读取索引文件，然后按顺序请求下载索引文件中列出的媒体文件。下载后是一个ts文件。需要进行解压获得对应的媒体数据并解码后进行播放。由于在直播过程中服务器端会不断地将最新的直播数据生成新的小文件，并上传所以只要客户端不断地按顺序下载并播放从服务器获取到的文件，从整个过程上看就相当于实现了直播。而且由于分段文件的很短，客户端可以根据实际的带宽情况切换到不同码率的直播源，从而实现多码率的适配的目的。</p>
<h4 id="M3U8-标签介绍："><a href="#M3U8-标签介绍：" class="headerlink" title="M3U8 标签介绍："></a>M3U8 标签介绍：</h4><p>这部分可以看下下面这篇博客：<br><a target="_blank" rel="noopener" href="http://blog.csdn.net/jwzhangjie/article/details/9744027">http://blog.csdn.net/jwzhangjie/article/details/9744027</a></p>
<h4 id="HLS播放流程"><a href="#HLS播放流程" class="headerlink" title="HLS播放流程"></a>HLS播放流程</h4><ol>
<li>获取不同带宽下对应的网络资源URI及音视频编解码，视频分辨率等信息的文件<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="comment">#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=899152,RESOLUTION=480x270,CODECS=&quot;avc1.4d4015,mp4a.40.5&quot;</span></span><br><span class="line">http:<span class="regexp">//</span>hls.ftdp.com<span class="regexp">/video1_widld/m</span>3u8/<span class="number">01</span>.m3u8</span><br></pre></td></tr></table></figure></li>
<li>根据上述获取的信息初始化对应的编解码器</li>
<li>获取第一个网络资源对应的分段索引列表（index文件）<figure class="highlight oxygene"><table><tr><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-VERSION:<span class="number">3</span></span><br><span class="line">#EXT-X-TARGETDURATION:<span class="number">10</span></span><br><span class="line">#EXT-X-MEDIA-<span class="keyword">SEQUENCE</span>:<span class="number">6532</span></span><br><span class="line">#EXT-X-KEY:<span class="keyword">METHOD</span>=<span class="title function_">AES</span>-128,<span class="title function_">URI</span>=&quot;18319965201.<span class="title function_">key</span>&quot;</span><br><span class="line">#<span class="title function_">EXTINF</span>:<span class="number">10</span>,</span><br><span class="line"><span class="number">20125484</span>T125708-<span class="number">01</span>-<span class="number">6533</span>.ts</span><br><span class="line">#EXT-X-KEY:<span class="keyword">METHOD</span>=<span class="title function_">AES</span>-128,<span class="title function_">URI</span>=&quot;14319965205.<span class="title function_">key</span>&quot;</span><br><span class="line">#<span class="title function_">EXTINF</span>:<span class="number">10</span>,</span><br><span class="line"><span class="number">20125484</span>T125708-<span class="number">01</span>-<span class="number">6534</span>.ts</span><br><span class="line">....</span><br><span class="line">#EXTINF:<span class="number">8</span>,</span><br><span class="line"><span class="number">20140804</span>T125708-<span class="number">01</span>-<span class="number">6593</span>.ts</span><br></pre></td></tr></table></figure></li>
<li>获取某一个分片的Key</li>
<li>请求下载某一个分片</li>
<li>根据当前的带宽决定是否切换视频资源</li>
<li>将下载的分片资源解密后送到解码器进行解码</li>
</ol>
<p><img src="/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84HLS%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/4.png"></p>
<p>关于NuPlayerDrvier的创建以及SetDataSource的流程和Stagefight Player大体一致，区别在于setDataSource的时候是根据url的不同会创建三种不同的DataSource：HttpLiveSource，RTSPSource，以及GenericSource。这里就不做大篇幅的介绍了，就直接上图吧：<br><img src="/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84HLS%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/1.png"><br><img src="/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84HLS%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/2.png"><br><img src="/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84HLS%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/3.png"></p>
<p>我们直接从prepare结合HLS原理开始分析：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">status_t</span> <span class="title">NuPlayerDriver::prepare</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">ALOGV</span>(<span class="string">&quot;prepare(%p)&quot;</span>, <span class="keyword">this</span>);</span><br><span class="line">    <span class="function">Mutex::Autolock <span class="title">autoLock</span><span class="params">(mLock)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">prepare_l</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">status_t</span> <span class="title">NuPlayerDriver::prepare_l</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (mState) &#123;</span><br><span class="line">        <span class="keyword">case</span> STATE_UNPREPARED:</span><br><span class="line">            mState = STATE_PREPARING;</span><br><span class="line">            <span class="comment">// Make sure we&#x27;re not posting any notifications, success or</span></span><br><span class="line">            <span class="comment">// failure information is only communicated through our result</span></span><br><span class="line">            <span class="comment">// code.</span></span><br><span class="line">            mIsAsyncPrepare = <span class="literal">false</span>;</span><br><span class="line">            mPlayer-&gt;<span class="built_in">prepareAsync</span>();</span><br><span class="line">            <span class="keyword">while</span> (mState == STATE_PREPARING) &#123;</span><br><span class="line">                mCondition.<span class="built_in">wait</span>(mLock);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> (mState == STATE_PREPARED) ? OK : UNKNOWN_ERROR;</span><br><span class="line">        <span class="keyword">case</span> STATE_STOPPED:</span><br><span class="line">            <span class="comment">//......</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> INVALID_OPERATION;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先我们在经过setDataSource阶段会将状态变量mState设置为STATE_UNPREPARED，那么在NuPlayerDriver::prepare_l()中我们实际上调用的是mPlayer-&gt;prepareAsync()，也就是Nuplayer的prepareAsync方法。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title class_">NuPlayer</span>::<span class="title function_">prepareAsync</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">//发送一个kWhatPrepare消息</span></span><br><span class="line">    (<span class="keyword">new</span> <span class="title class_">AMessage</span>(kWhatPrepare, <span class="variable language_">this</span>))-&gt;<span class="title function_">post</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在NuPlayer::prepareAsync中只是发送了一个kWhatPrepare的消息。找到对应的Handler查看处理流程如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title class_">NuPlayer</span>::<span class="title function_">onMessageReceived</span>(<span class="params"><span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg</span>) &#123;</span><br><span class="line">	<span class="comment">//ignore other fuck source</span></span><br><span class="line">    <span class="keyword">case</span> <span class="attr">kWhatPrepare</span>:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//调用Source的prepareAsync 我们这里看下HttpliveSource</span></span><br><span class="line">        mSource-&gt;<span class="title function_">prepareAsync</span>();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ignore other fuck source</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里直接调用的是Source的prepareAsync，这个mSource是在setDataSource阶段设置的，我们这里只分析HLS的情形所以需要查看HttpliveSource的prepareAsync。</p>
<figure class="highlight zephir"><table><tr><td class="code"><pre><span class="line">void NuPlayer::HTTPLiveSource::prepareAsync() &#123;</span><br><span class="line">    <span class="comment">//创建并启动一个Looper</span></span><br><span class="line">    <span class="keyword">if</span> (mLiveLooper == NULL) &#123;</span><br><span class="line">        mLiveLooper = <span class="keyword">new</span> ALooper;</span><br><span class="line">        mLiveLooper-&gt;setName(<span class="string">&quot;http live&quot;</span>);</span><br><span class="line">        mLiveLooper-&gt;start();</span><br><span class="line">        mLiveLooper-&gt;registerHandler(this);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//创建一个kWhatSessionNotify赋值给LiveSession用于通知</span></span><br><span class="line">    sp&lt;AMessage&gt; notify = <span class="keyword">new</span> AMessage(kWhatSessionNotify, this);</span><br><span class="line">    <span class="comment">//创建一个LiveSession</span></span><br><span class="line">    mLiveSession = <span class="keyword">new</span> LiveSession(</span><br><span class="line">            notify,</span><br><span class="line">            (mFlags &amp; kFlagIncognito) ? LiveSession::kFlagIncognito : <span class="number">0</span>,</span><br><span class="line">            mHTTPService);</span><br><span class="line">    mLiveLooper-&gt;registerHandler(mLiveSession);</span><br><span class="line">    <span class="comment">//使用LiveSession进行异步连接</span></span><br><span class="line">    mLiveSession-&gt;connectAsync(mURL.c_str(), mExtraHeaders.isEmpty() ? NULL : &amp;mExtraHeaders);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void LiveSession::connect<span class="constructor">Async(<span class="params">const</span> <span class="params">char</span> <span class="operator">*</span><span class="params">url</span>, <span class="params">const</span> KeyedVector&lt;String8, String8&gt; <span class="operator">*</span><span class="params">headers</span>)</span> &#123;</span><br><span class="line">    <span class="comment">//创建一个kWhatConnect并传入url</span></span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> <span class="constructor">AMessage(<span class="params">kWhatConnect</span>, <span class="params">this</span>)</span>;</span><br><span class="line">    msg-&gt;set<span class="constructor">String(<span class="string">&quot;url&quot;</span>, <span class="params">url</span>)</span>;</span><br><span class="line">    <span class="keyword">if</span> (headers != NULL) &#123;</span><br><span class="line">        msg-&gt;set<span class="constructor">Pointer(<span class="string">&quot;headers&quot;</span>,<span class="params">new</span> KeyedVector&lt;String8, String8&gt;(<span class="operator">*</span><span class="params">headers</span>)</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    msg-&gt;post<span class="literal">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title class_">LiveSession</span>::<span class="title function_">onMessageReceived</span>(<span class="params"><span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg</span>) &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="attr">kWhatConnect</span>:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//调用onConnect</span></span><br><span class="line">        <span class="title function_">onConnect</span>(msg);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void LiveSession::on<span class="constructor">Connect(<span class="params">const</span> <span class="params">sp</span>&lt;AMessage&gt; &amp;<span class="params">msg</span>)</span> &#123;</span><br><span class="line">    <span class="comment">//获取传过来的Uri</span></span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">findString</span>(<span class="string">&quot;url&quot;</span>, &amp;<span class="params">mMasterURL</span>)</span>);</span><br><span class="line">    KeyedVector&lt;String8, String8&gt; *headers = NULL;</span><br><span class="line">    <span class="keyword">if</span> (!msg-&gt;find<span class="constructor">Pointer(<span class="string">&quot;headers&quot;</span>, (<span class="params">void</span> <span class="operator">**</span>)</span>&amp;headers)) &#123;</span><br><span class="line">        mExtraHeaders.clear<span class="literal">()</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mExtraHeaders = *headers;</span><br><span class="line">        delete headers;</span><br><span class="line">        headers = NULL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//创建一个mFetcherLooper</span></span><br><span class="line">    <span class="keyword">if</span> (mFetcherLooper<span class="operator"> == </span>NULL) &#123;</span><br><span class="line">        mFetcherLooper = <span class="keyword">new</span> <span class="constructor">ALooper()</span>;</span><br><span class="line">        mFetcherLooper-&gt;set<span class="constructor">Name(<span class="string">&quot;Fetcher&quot;</span>)</span>;</span><br><span class="line">        mFetcherLooper-&gt;start(<span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取不同带宽下对应的网络资源URI及音视频编解码信息</span></span><br><span class="line">    add<span class="constructor">Fetcher(<span class="params">mMasterURL</span>.<span class="params">c_str</span>()</span>)-&gt;fetch<span class="constructor">PlaylistAsync()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里就开始获取不同带宽下对应的网络资源URI及音视频编解码信息了</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">sp&lt;PlaylistFetcher&gt; LiveSession::add<span class="constructor">Fetcher(<span class="params">const</span> <span class="params">char</span> <span class="operator">*</span><span class="params">uri</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    ssize_t index = mFetcherInfos.index<span class="constructor">OfKey(<span class="params">uri</span>)</span>;</span><br><span class="line">    sp&lt;AMessage&gt; notify = <span class="keyword">new</span> <span class="constructor">AMessage(<span class="params">kWhatFetcherNotify</span>, <span class="params">this</span>)</span>;</span><br><span class="line">    notify-&gt;set<span class="constructor">String(<span class="string">&quot;uri&quot;</span>, <span class="params">uri</span>)</span>;</span><br><span class="line">    notify-&gt;set<span class="constructor">Int32(<span class="string">&quot;switchGeneration&quot;</span>, <span class="params">mSwitchGeneration</span>)</span>;</span><br><span class="line">    FetcherInfo info;</span><br><span class="line">    <span class="comment">//创建一个PlaylistFetcher并返回</span></span><br><span class="line">    info.mFetcher = <span class="keyword">new</span> <span class="constructor">PlaylistFetcher(<span class="params">notify</span>, <span class="params">this</span>, <span class="params">uri</span>, <span class="params">mCurBandwidthIndex</span>, <span class="params">mSubtitleGeneration</span>)</span>;</span><br><span class="line">    info.mDurationUs = -<span class="number">1l</span>l;</span><br><span class="line">    info.mToBeRemoved = <span class="literal">false</span>;</span><br><span class="line">    info.mToBeResumed = <span class="literal">false</span>;</span><br><span class="line">    mFetcherLooper-&gt;register<span class="constructor">Handler(<span class="params">info</span>.<span class="params">mFetcher</span>)</span>;</span><br><span class="line">    mFetcherInfos.add(uri, info);</span><br><span class="line">    <span class="comment">//这里的info.mFetcher是上面new 出来的PlaylistFetcher</span></span><br><span class="line">    return info.mFetcher;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们通过这里返回的PlaylistFetcher调用fetchPlaylistAsync来获取playlists</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void PlaylistFetcher::fetch<span class="constructor">PlaylistAsync()</span> &#123;</span><br><span class="line">    (<span class="keyword">new</span> <span class="constructor">AMessage(<span class="params">kWhatFetchPlaylist</span>, <span class="params">this</span>)</span>)-&gt;post<span class="literal">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void PlaylistFetcher::on<span class="constructor">MessageReceived(<span class="params">const</span> <span class="params">sp</span>&lt;AMessage&gt; &amp;<span class="params">msg</span>)</span> &#123;</span><br><span class="line">    case kWhatFetchPlaylist:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">bool</span> unchanged;</span><br><span class="line">        <span class="comment">//获取一个M3U8Parser</span></span><br><span class="line">        sp&lt;M3UParser&gt; playlist = mHTTPDownloader-&gt;fetch<span class="constructor">Playlist(<span class="params">mURI</span>.<span class="params">c_str</span>()</span>, NULL <span class="comment">/* curPlaylistHash */</span>, &amp;unchanged);</span><br><span class="line">        sp&lt;AMessage&gt; notify = mNotify-&gt;dup<span class="literal">()</span>;</span><br><span class="line">        notify-&gt;set<span class="constructor">Int32(<span class="string">&quot;what&quot;</span>, <span class="params">kWhatPlaylistFetched</span>)</span>;</span><br><span class="line">        <span class="comment">//将playlist返回</span></span><br><span class="line">        notify-&gt;set<span class="constructor">Object(<span class="string">&quot;playlist&quot;</span>, <span class="params">playlist</span>)</span>;</span><br><span class="line">        notify-&gt;post<span class="literal">()</span>;</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们接下来看下fetchFile过程：首先会通过fetchFile从服务器端获取到m3u8 playlist内容存放到buffer缓存区，然后将获取到的缓存数据包装成M3UParser</p>
<figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line"><span class="function">sp&lt;M3UParser&gt; <span class="title">HTTPDownloader::fetchPlaylist</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> <span class="type">char</span> *url, <span class="type">uint8_t</span> *curPlaylistHash, <span class="type">bool</span> *unchanged)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    *unchanged = <span class="literal">false</span>;</span><br><span class="line">    sp&lt;ABuffer&gt; buffer;</span><br><span class="line">    String8 actualUrl;</span><br><span class="line">    <span class="comment">//调用fetchFile</span></span><br><span class="line">    <span class="type">ssize_t</span> err = <span class="built_in">fetchFile</span>(url, &amp;buffer, &amp;actualUrl);</span><br><span class="line">	<span class="comment">//断开连接</span></span><br><span class="line">    mHTTPDataSource-&gt;<span class="built_in">disconnect</span>();</span><br><span class="line"> 	<span class="comment">//将获取到的缓存数据包装成M3UParser</span></span><br><span class="line">    sp&lt;M3UParser&gt; playlist = <span class="keyword">new</span> <span class="built_in">M3UParser</span>(actualUrl.<span class="built_in">string</span>(), buffer-&gt;<span class="built_in">data</span>(), buffer-&gt;<span class="built_in">size</span>());</span><br><span class="line">    <span class="keyword">return</span> playlist;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">ssize_t</span> <span class="title">HTTPDownloader::fetchFile</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> <span class="type">char</span> *url, sp&lt;ABuffer&gt; *out, String8 *actualUrl)</span> </span>&#123;</span><br><span class="line">    <span class="type">ssize_t</span> err = <span class="built_in">fetchBlock</span>(url, out, <span class="number">0</span>, <span class="number">-1</span>, <span class="number">0</span>, actualUrl, <span class="literal">true</span> <span class="comment">/* reconnect */</span>);</span><br><span class="line">    <span class="comment">// close off the connection after use</span></span><br><span class="line">    mHTTPDataSource-&gt;<span class="built_in">disconnect</span>();</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>我们这里看下M3UParser构造方法：</p>
<figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line">M3UParser::<span class="built_in">M3UParser</span>(</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span> *baseURI, <span class="type">const</span> <span class="type">void</span> *data, <span class="type">size_t</span> size)</span><br><span class="line">    : <span class="built_in">mInitCheck</span>(NO_INIT),</span><br><span class="line">      <span class="built_in">mBaseURI</span>(baseURI),</span><br><span class="line">      <span class="built_in">mIsExtM3U</span>(<span class="literal">false</span>),</span><br><span class="line">      <span class="built_in">mIsVariantPlaylist</span>(<span class="literal">false</span>),</span><br><span class="line">      <span class="built_in">mIsComplete</span>(<span class="literal">false</span>),</span><br><span class="line">      <span class="built_in">mIsEvent</span>(<span class="literal">false</span>),</span><br><span class="line">      <span class="built_in">mFirstSeqNumber</span>(<span class="number">-1</span>),</span><br><span class="line">      <span class="built_in">mLastSeqNumber</span>(<span class="number">-1</span>),</span><br><span class="line">      <span class="built_in">mTargetDurationUs</span>(<span class="number">-1ll</span>),</span><br><span class="line">      <span class="built_in">mDiscontinuitySeq</span>(<span class="number">0</span>),</span><br><span class="line">      <span class="built_in">mDiscontinuityCount</span>(<span class="number">0</span>),</span><br><span class="line">      <span class="built_in">mSelectedIndex</span>(<span class="number">-1</span>) &#123;</span><br><span class="line">    mInitCheck = <span class="built_in">parse</span>(data, size);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在最后的时候会调用parse对缓存数据进行解析：</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">status_t M3UParser::parse(const <span class="type">void</span> *_data, size_t size) &#123;</span><br><span class="line">    int32_t lineNo = <span class="number">0</span>;</span><br><span class="line">    sp&lt;AMessage&gt; itemMeta;</span><br><span class="line">    const <span class="type">char</span> *data = (const <span class="type">char</span> *)_data;</span><br><span class="line">    size_t <span class="keyword">offset</span> = <span class="number">0</span>;</span><br><span class="line">    uint64_t segmentRangeOffset = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">offset</span> &lt; size) &#123;</span><br><span class="line">        size_t offsetLF = <span class="keyword">offset</span>;</span><br><span class="line">        <span class="keyword">while</span> (offsetLF &lt; size &amp;&amp; data[offsetLF] != <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">            ++offsetLF;</span><br><span class="line">        &#125;</span><br><span class="line">        AString <span class="type">line</span>;</span><br><span class="line">        <span class="keyword">if</span> (offsetLF &gt; <span class="keyword">offset</span> &amp;&amp; data[offsetLF - <span class="number">1</span>] == <span class="string">&#x27;\r&#x27;</span>) &#123;</span><br><span class="line">            <span class="type">line</span>.setTo(&amp;data[<span class="keyword">offset</span>], offsetLF - <span class="keyword">offset</span> - <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">line</span>.setTo(&amp;data[<span class="keyword">offset</span>], offsetLF - <span class="keyword">offset</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="type">line</span>.empty()) &#123;</span><br><span class="line">            <span class="keyword">offset</span> = offsetLF + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (lineNo == <span class="number">0</span> &amp;&amp; <span class="type">line</span> == &quot;#EXTM3U&quot;) &#123;</span><br><span class="line">            mIsExtM3U = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mIsExtM3U) &#123;</span><br><span class="line">            status_t err = OK;</span><br><span class="line">            <span class="keyword">if</span> (<span class="type">line</span>.startsWith(&quot;#EXT-X-TARGETDURATION&quot;)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mIsVariantPlaylist) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ERROR_MALFORMED;</span><br><span class="line">                &#125;</span><br><span class="line">                err = parseMetaData(<span class="type">line</span>, &amp;mMeta, &quot;target-duration&quot;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="type">line</span>.startsWith(&quot;#EXT-X-MEDIA-SEQUENCE&quot;)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mIsVariantPlaylist) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ERROR_MALFORMED;</span><br><span class="line">                &#125;</span><br><span class="line">                err = parseMetaData(<span class="type">line</span>, &amp;mMeta, &quot;media-sequence&quot;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="type">line</span>.startsWith(&quot;#EXT-X-KEY&quot;)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mIsVariantPlaylist) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ERROR_MALFORMED;</span><br><span class="line">                &#125;</span><br><span class="line">                err = parseCipherInfo(<span class="type">line</span>, &amp;itemMeta, mBaseURI);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="type">line</span>.startsWith(&quot;#EXT-X-ENDLIST&quot;)) &#123;</span><br><span class="line">                mIsComplete = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="type">line</span>.startsWith(&quot;#EXT-X-PLAYLIST-TYPE:EVENT&quot;)) &#123;</span><br><span class="line">                mIsEvent = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="type">line</span>.startsWith(&quot;#EXTINF&quot;)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mIsVariantPlaylist) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ERROR_MALFORMED;</span><br><span class="line">                &#125;</span><br><span class="line">                err = parseMetaDataDuration(<span class="type">line</span>, &amp;itemMeta, &quot;durationUs&quot;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="type">line</span>.startsWith(&quot;#EXT-X-DISCONTINUITY&quot;)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mIsVariantPlaylist) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ERROR_MALFORMED;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (itemMeta == <span class="keyword">NULL</span>) &#123;</span><br><span class="line">                    itemMeta = <span class="built_in">new</span> AMessage;</span><br><span class="line">                &#125;</span><br><span class="line">                itemMeta-&gt;setInt32(&quot;discontinuity&quot;, <span class="keyword">true</span>);</span><br><span class="line">                ++mDiscontinuityCount;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="type">line</span>.startsWith(&quot;#EXT-X-STREAM-INF&quot;)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mMeta != <span class="keyword">NULL</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ERROR_MALFORMED;</span><br><span class="line">                &#125;</span><br><span class="line">                mIsVariantPlaylist = <span class="keyword">true</span>;</span><br><span class="line">                err = parseStreamInf(<span class="type">line</span>, &amp;itemMeta);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="type">line</span>.startsWith(&quot;#EXT-X-BYTERANGE&quot;)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mIsVariantPlaylist) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ERROR_MALFORMED;</span><br><span class="line">                &#125;</span><br><span class="line">                uint64_t length, <span class="keyword">offset</span>;</span><br><span class="line">                err = parseByteRange(<span class="type">line</span>, segmentRangeOffset, &amp;length, &amp;<span class="keyword">offset</span>);</span><br><span class="line">                <span class="keyword">if</span> (err == OK) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (itemMeta == <span class="keyword">NULL</span>) &#123;</span><br><span class="line">                        itemMeta = <span class="built_in">new</span> AMessage;</span><br><span class="line">                    &#125;</span><br><span class="line">                    itemMeta-&gt;setInt64(&quot;range-offset&quot;, <span class="keyword">offset</span>);</span><br><span class="line">                    itemMeta-&gt;setInt64(&quot;range-length&quot;, length);</span><br><span class="line">                    segmentRangeOffset = <span class="keyword">offset</span> + length;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="type">line</span>.startsWith(&quot;#EXT-X-MEDIA&quot;)) &#123;</span><br><span class="line">                err = parseMedia(<span class="type">line</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="type">line</span>.startsWith(&quot;#EXT-X-DISCONTINUITY-SEQUENCE&quot;)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mIsVariantPlaylist) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ERROR_MALFORMED;</span><br><span class="line">                &#125;</span><br><span class="line">                size_t seq;</span><br><span class="line">                err = parseDiscontinuitySequence(<span class="type">line</span>, &amp;seq);</span><br><span class="line">                <span class="keyword">if</span> (err == OK) &#123;</span><br><span class="line">                    mDiscontinuitySeq = seq;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">                <span class="keyword">return</span> err;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="type">line</span>.startsWith(&quot;#&quot;)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mIsVariantPlaylist) &#123;</span><br><span class="line">                int64_t durationUs;</span><br><span class="line">                <span class="keyword">if</span> (itemMeta == <span class="keyword">NULL</span></span><br><span class="line">                        || !itemMeta-&gt;findInt64(&quot;durationUs&quot;, &amp;durationUs)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ERROR_MALFORMED;</span><br><span class="line">                &#125;</span><br><span class="line">                itemMeta-&gt;setInt32(&quot;discontinuity-sequence&quot;,</span><br><span class="line">                        mDiscontinuitySeq + mDiscontinuityCount);</span><br><span class="line">            &#125;</span><br><span class="line">            mItems.push();</span><br><span class="line">            Item *item = &amp;mItems.editItemAt(mItems.size() - <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">CHECK</span>(MakeURL(mBaseURI.c_str(), <span class="type">line</span>.c_str(), &amp;item-&gt;mURI));</span><br><span class="line">            item-&gt;mMeta = itemMeta;</span><br><span class="line">            itemMeta.clear();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">offset</span> = offsetLF + <span class="number">1</span>;</span><br><span class="line">        ++lineNo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mIsVariantPlaylist) &#123;</span><br><span class="line">        int32_t targetDurationSecs;</span><br><span class="line">        <span class="keyword">if</span> (mMeta == <span class="keyword">NULL</span> || !mMeta-&gt;findInt32(</span><br><span class="line">                &quot;target-duration&quot;, &amp;targetDurationSecs)) &#123;</span><br><span class="line">            ALOGE(&quot;Media playlist missing #EXT-X-TARGETDURATION&quot;);</span><br><span class="line">            <span class="keyword">return</span> ERROR_MALFORMED;</span><br><span class="line">        &#125;</span><br><span class="line">        mTargetDurationUs = targetDurationSecs * <span class="number">1000000</span>ll;</span><br><span class="line">        mFirstSeqNumber = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (mMeta != <span class="keyword">NULL</span>) &#123;</span><br><span class="line">            mMeta-&gt;findInt32(&quot;media-sequence&quot;, &amp;mFirstSeqNumber);</span><br><span class="line">        &#125;</span><br><span class="line">        mLastSeqNumber = mFirstSeqNumber + mItems.size() - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>好了我们现在已经获取到了类型为M3UParser的播放列表文件了，这时候会发送一个kWhatPlaylistFetched，这个在哪里被处理呢？当然是LiveSession啊。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> PlaylistFetcher::kWhatPlaylistFetched:</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">onMasterPlaylistFetched</span>(msg);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取到播放列表后要干啥呢？我们接下来看：</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void LiveSession::on<span class="constructor">MasterPlaylistFetched(<span class="params">const</span> <span class="params">sp</span>&lt;AMessage&gt; &amp;<span class="params">msg</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    AString uri;</span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">findString</span>(<span class="string">&quot;uri&quot;</span>, &amp;<span class="params">uri</span>)</span>);</span><br><span class="line">    ssize_t index = mFetcherInfos.index<span class="constructor">OfKey(<span class="params">uri</span>)</span>;</span><br><span class="line">    <span class="comment">// no longer useful, remove</span></span><br><span class="line">    mFetcherLooper-&gt;unregister<span class="constructor">Handler(<span class="params">mFetcherInfos</span>[<span class="params">index</span>].<span class="params">mFetcher</span>-&gt;<span class="params">id</span>()</span>);</span><br><span class="line">    mFetcherInfos.remove<span class="constructor">ItemsAt(<span class="params">index</span>)</span>;</span><br><span class="line">    <span class="comment">//取走获取到的playlist</span></span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">findObject</span>(<span class="string">&quot;playlist&quot;</span>, (<span class="params">sp</span>&lt;RefBase&gt; <span class="operator">*</span>)</span>&amp;mPlaylist));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We trust the content provider to make a reasonable choice of preferred</span></span><br><span class="line">    <span class="comment">// initial bandwidth by listing it first in the variant playlist.</span></span><br><span class="line">    <span class="comment">// At startup we really don&#x27;t have a good estimate on the available</span></span><br><span class="line">    <span class="comment">// network bandwidth since we haven&#x27;t tranferred any data yet. Once</span></span><br><span class="line">    <span class="comment">// we have we can make a better informed choice.</span></span><br><span class="line">    size_t initialBandwidth = <span class="number">0</span>;</span><br><span class="line">    size_t initialBandwidthIndex = <span class="number">0</span>;</span><br><span class="line">    int32_t maxWidth = <span class="number">0</span>;</span><br><span class="line">    int32_t maxHeight = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//判断获取到的playlist是否有效，无效就没啥用了，我们这里假设有效</span></span><br><span class="line">    <span class="keyword">if</span> (mPlaylist-&gt;is<span class="constructor">VariantPlaylist()</span>) &#123;</span><br><span class="line">        Vector&lt;BandwidthItem&gt; itemsWithVideo;</span><br><span class="line">        <span class="keyword">for</span> (size_t i = <span class="number">0</span>; i &lt; mPlaylist-&gt;size<span class="literal">()</span>; ++i) &#123;</span><br><span class="line">            BandwidthItem item;</span><br><span class="line">            item.mPlaylistIndex = i;</span><br><span class="line">            item.mLastFailureUs = -<span class="number">1l</span>l;</span><br><span class="line">            sp&lt;AMessage&gt; meta;</span><br><span class="line">            AString uri;</span><br><span class="line">            mPlaylist-&gt;item<span class="constructor">At(<span class="params">i</span>, &amp;<span class="params">uri</span>, &amp;<span class="params">meta</span>)</span>;</span><br><span class="line">            <span class="comment">//获取带宽</span></span><br><span class="line">            <span class="constructor">CHECK(<span class="params">meta</span>-&gt;<span class="params">findInt32</span>(<span class="string">&quot;bandwidth&quot;</span>, (<span class="params">int32_t</span> <span class="operator">*</span>)</span>&amp;item.mBandwidth));</span><br><span class="line">            <span class="comment">//获取最大分辨率</span></span><br><span class="line">            int32_t width, height;</span><br><span class="line">            <span class="keyword">if</span> (meta-&gt;find<span class="constructor">Int32(<span class="string">&quot;width&quot;</span>, &amp;<span class="params">width</span>)</span>) &#123;</span><br><span class="line">                maxWidth = max(maxWidth, width);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (meta-&gt;find<span class="constructor">Int32(<span class="string">&quot;height&quot;</span>, &amp;<span class="params">height</span>)</span>) &#123;</span><br><span class="line">                maxHeight = max(maxHeight, height);</span><br><span class="line">            &#125;</span><br><span class="line">            mBandwidthItems.push(item);</span><br><span class="line">            <span class="keyword">if</span> (mPlaylist-&gt;has<span class="constructor">Type(<span class="params">i</span>, <span class="string">&quot;video&quot;</span>)</span>) &#123;</span><br><span class="line">                itemsWithVideo.push(item);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//移除只有声音的信息</span></span><br><span class="line">        <span class="keyword">if</span> (!itemsWithVideo.empty<span class="literal">()</span>&amp;&amp; itemsWithVideo.size<span class="literal">()</span> &lt; mBandwidthItems.size<span class="literal">()</span>) &#123;</span><br><span class="line">            mBandwidthItems.clear<span class="literal">()</span>;</span><br><span class="line">            <span class="keyword">for</span> (size_t i = <span class="number">0</span>; i &lt; itemsWithVideo.size<span class="literal">()</span>; ++i) &#123;</span><br><span class="line">                mBandwidthItems.push(itemsWithVideo<span class="literal">[<span class="identifier">i</span>]</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="constructor">CHECK_GT(<span class="params">mBandwidthItems</span>.<span class="params">size</span>()</span>, <span class="number">0</span>u);</span><br><span class="line">        initialBandwidth = mBandwidthItems<span class="literal">[<span class="number">0</span>]</span>.mBandwidth;</span><br><span class="line">        <span class="comment">//按照带宽进行排序</span></span><br><span class="line">        mBandwidthItems.sort(SortByBandwidth);</span><br><span class="line">        <span class="keyword">for</span> (size_t i = <span class="number">0</span>; i &lt; mBandwidthItems.size<span class="literal">()</span>; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mBandwidthItems.item<span class="constructor">At(<span class="params">i</span>)</span>.mBandwidth<span class="operator"> == </span>initialBandwidth) &#123;</span><br><span class="line">                initialBandwidthIndex = i;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="comment">//......</span></span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//获取到最大的分辨率</span></span><br><span class="line">    mMaxWidth = maxWidth &gt; <span class="number">0</span> ? maxWidth : mMaxWidth;</span><br><span class="line">    mMaxHeight = maxHeight &gt; <span class="number">0</span> ? maxHeight : mMaxHeight;</span><br><span class="line">    mPlaylist-&gt;pick<span class="constructor">RandomMediaItems()</span>;</span><br><span class="line">    change<span class="constructor">Configuration(0ll <span class="operator">/</span><span class="operator">*</span> <span class="params">timeUs</span> <span class="operator">*</span><span class="operator">/</span>, <span class="params">initialBandwidthIndex</span>, <span class="params">false</span> <span class="operator">/</span><span class="operator">*</span> <span class="params">pickTrack</span> <span class="operator">*</span><span class="operator">/</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void LiveSession::change<span class="constructor">Configuration(<span class="params">int64_t</span> <span class="params">timeUs</span>, <span class="params">ssize_t</span> <span class="params">bandwidthIndex</span>, <span class="params">bool</span> <span class="params">pickTrack</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//取消带宽切换</span></span><br><span class="line">    cancel<span class="constructor">BandwidthSwitch()</span>;</span><br><span class="line">    mReconfigurationInProgress = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">//由mOrigBandwidthIndex切换到mCurBandwidthIndex</span></span><br><span class="line">    <span class="keyword">if</span> (bandwidthIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//将当前的带宽设置为当前带宽</span></span><br><span class="line">        mOrigBandwidthIndex = mCurBandwidthIndex;</span><br><span class="line">        mCurBandwidthIndex = bandwidthIndex;</span><br><span class="line">        <span class="keyword">if</span> (mOrigBandwidthIndex != mCurBandwidthIndex) &#123;</span><br><span class="line">            <span class="comment">//开始切换带宽</span></span><br><span class="line">            <span class="constructor">ALOGI(<span class="string">&quot;#### Starting Bandwidth Switch: %zd =&gt; %zd&quot;</span>,<span class="params">mOrigBandwidthIndex</span>, <span class="params">mCurBandwidthIndex</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="constructor">CHECK_LT(<span class="params">mCurBandwidthIndex</span>, <span class="params">mBandwidthItems</span>.<span class="params">size</span>()</span>);</span><br><span class="line">    <span class="comment">//获取当前的BandwidthItem</span></span><br><span class="line">    const BandwidthItem &amp;item = mBandwidthItems.item<span class="constructor">At(<span class="params">mCurBandwidthIndex</span>)</span>;</span><br><span class="line">    uint32_t streamMask = <span class="number">0</span>; <span class="comment">// streams that should be fetched by the new fetcher</span></span><br><span class="line">    uint32_t resumeMask = <span class="number">0</span>; <span class="comment">// streams that should be fetched by the original fetcher</span></span><br><span class="line">    AString URIs<span class="literal">[<span class="identifier">kMaxStreams</span>]</span>;</span><br><span class="line">    <span class="keyword">for</span> (size_t i = <span class="number">0</span>; i &lt; kMaxStreams; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mPlaylist-&gt;get<span class="constructor">TypeURI(<span class="params">item</span>.<span class="params">mPlaylistIndex</span>, <span class="params">mStreams</span>[<span class="params">i</span>].<span class="params">mType</span>, &amp;URIs[<span class="params">i</span>])</span>) &#123;</span><br><span class="line">            streamMask <span class="pattern-match">|= index<span class="constructor">ToType(<span class="params">i</span>)</span>;</span></span><br><span class="line"><span class="pattern-match">        &#125;</span></span><br><span class="line"><span class="pattern-match">    &#125;</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">    <span class="operator">/</span><span class="operator">/</span> 停止我们不需要的，暂停我们将要复用的，第一次的时候这里是没有的所以跳过</span></span><br><span class="line"><span class="pattern-match">    <span class="keyword">for</span> (size<span class="constructor">_t</span> i = 0; i &lt; m<span class="constructor">FetcherInfos</span>.size(); <span class="operator">++</span>i) &#123;</span></span><br><span class="line"><span class="pattern-match">        <span class="operator">/</span><span class="operator">/</span><span class="operator">...</span><span class="operator">...</span><span class="operator">...</span><span class="operator">...</span><span class="operator">...</span><span class="operator">...</span><span class="operator">...</span><span class="operator">...</span>.</span></span><br><span class="line"><span class="pattern-match">    &#125;</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">    sp&lt;<span class="constructor">AMessage</span>&gt; msg;</span></span><br><span class="line"><span class="pattern-match">    <span class="keyword">if</span> (time<span class="constructor">Us</span> &lt; 0ll) &#123;</span></span><br><span class="line"><span class="pattern-match">        <span class="operator">/</span><span class="operator">/</span> skip on<span class="constructor">ChangeConfiguration2</span> (decoder destruction) <span class="keyword">if</span> not seeking.</span></span><br><span class="line"><span class="pattern-match">        msg = <span class="keyword">new</span> <span class="constructor">AMessage(<span class="params">kWhatChangeConfiguration3</span>, <span class="params">this</span>)</span>;</span></span><br><span class="line"><span class="pattern-match">    &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="pattern-match">        msg = <span class="keyword">new</span> <span class="constructor">AMessage(<span class="params">kWhatChangeConfiguration2</span>, <span class="params">this</span>)</span>;</span></span><br><span class="line"><span class="pattern-match">    &#125;</span></span><br><span class="line"><span class="pattern-match">    msg-&gt;set<span class="constructor">Int32(<span class="string">&quot;streamMask&quot;</span>, <span class="params">streamMask</span>)</span>;</span></span><br><span class="line"><span class="pattern-match">    msg-&gt;set<span class="constructor">Int32(<span class="string">&quot;resumeMask&quot;</span>, <span class="params">resumeMask</span>)</span>;</span></span><br><span class="line"><span class="pattern-match">    msg-&gt;set<span class="constructor">Int32(<span class="string">&quot;pickTrack&quot;</span>, <span class="params">pickTrack</span>)</span>;</span></span><br><span class="line"><span class="pattern-match">    msg-&gt;set<span class="constructor">Int64(<span class="string">&quot;timeUs&quot;</span>, <span class="params">timeUs</span>)</span>;</span></span><br><span class="line"><span class="pattern-match">    <span class="keyword">for</span> (size<span class="constructor">_t</span> i = 0; i &lt; k<span class="constructor">MaxStreams</span>; <span class="operator">++</span>i) &#123;</span></span><br><span class="line"><span class="pattern-match">        <span class="keyword">if</span> ((stream<span class="constructor">Mask</span> | resume<span class="constructor">Mask</span>) &amp; index<span class="constructor">ToType(<span class="params">i</span>)</span>) &#123;</span></span><br><span class="line"><span class="pattern-match">            msg-&gt;set<span class="constructor">String(<span class="params">mStreams</span>[<span class="params">i</span>].<span class="params">uriKey</span>()</span>.c<span class="constructor">_str()</span>, <span class="constructor">URIs</span>[i].c<span class="constructor">_str()</span>);</span></span><br><span class="line"><span class="pattern-match">        &#125;</span></span><br><span class="line"><span class="pattern-match">    &#125;</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">    <span class="operator">/</span><span class="operator">/</span> <span class="constructor">Every</span> time a fetcher acknowledges the stop<span class="constructor">Async</span> <span class="keyword">or</span> pause<span class="constructor">Async</span> request</span></span><br><span class="line"><span class="pattern-match">    <span class="operator">/</span><span class="operator">/</span> we&#x27;ll decrement m<span class="constructor">ContinuationCounter</span>, once it reaches zero, i.e. all</span></span><br><span class="line"><span class="pattern-match">    <span class="operator">/</span><span class="operator">/</span> fetchers have completed their asynchronous operation, we&#x27;ll post</span></span><br><span class="line"><span class="pattern-match">    <span class="operator">/</span><span class="operator">/</span> m<span class="constructor">Continuation</span>, which <span class="keyword">then</span> is handled below <span class="keyword">in</span> on<span class="constructor">ChangeConfiguration2</span>.</span></span><br><span class="line"><span class="pattern-match">  	<span class="operator">/</span><span class="operator">/</span>每次fetcher 调用了stop<span class="constructor">Async</span>和pause<span class="constructor">Async</span> m<span class="constructor">ContinuationCounter</span> 数值都会减去1,一旦减到0 那么将会在on<span class="constructor">ChangeConfiguration2</span>处理</span></span><br><span class="line"><span class="pattern-match">    m<span class="constructor">ContinuationCounter</span> = m<span class="constructor">FetcherInfos</span>.size();</span></span><br><span class="line"><span class="pattern-match">    m<span class="constructor">Continuation</span> = msg;</span></span><br><span class="line"><span class="pattern-match">    <span class="keyword">if</span> (m<span class="constructor">ContinuationCounter</span> <span class="operator">==</span> 0) &#123;</span></span><br><span class="line"><span class="pattern-match">        msg-&gt;post();</span></span><br><span class="line"><span class="pattern-match">    &#125;</span></span><br><span class="line"><span class="pattern-match">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line">void LiveSession::onChangeConfiguration2(const sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    int64_t timeUs;</span><br><span class="line">    CHECK(<span class="function"><span class="title">msg</span>-&gt;</span>findInt64(<span class="string">&quot;timeUs&quot;</span>, &amp;timeUs));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (timeUs &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        mLastSeekTimeUs = timeUs;</span><br><span class="line">        mLastDequeuedTimeUs = timeUs;</span><br><span class="line">        <span class="keyword">for</span> (size_t i = <span class="number">0</span>; i &lt; mPacketSources.size(); i++) &#123;</span><br><span class="line">            sp&lt;AnotherPacketSource&gt; packetSource = mPacketSources.editValueAt(i);</span><br><span class="line">            <span class="function"><span class="title">sp</span>&lt;MetaData&gt; format = packetSource-&gt;</span>getFormat();</span><br><span class="line">            <span class="function"><span class="title">packetSource</span>-&gt;</span>clear();</span><br><span class="line">            <span class="function"><span class="title">packetSource</span>-&gt;</span>setFormat(format);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (size_t i = <span class="number">0</span>; i &lt; kMaxStreams; ++i) &#123;</span><br><span class="line">            mStreams[i].reset();</span><br><span class="line">        &#125;</span><br><span class="line">        mDiscontinuityOffsetTimesUs.clear();</span><br><span class="line">        mDiscontinuityAbsStartTimesUs.clear();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mSeekReplyID != NULL) &#123;</span><br><span class="line">            CHECK(mSeekReply != NULL);</span><br><span class="line">            <span class="function"><span class="title">mSeekReply</span>-&gt;</span>setInt32(<span class="string">&quot;err&quot;</span>, OK);</span><br><span class="line">            <span class="function"><span class="title">mSeekReply</span>-&gt;</span>postReply(mSeekReplyID);</span><br><span class="line">            mSeekReplyID.clear();</span><br><span class="line">            mSeekReply.clear();</span><br><span class="line">        &#125;</span><br><span class="line">        restartPollBuffering();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    uint32_t streamMask, resumeMask;</span><br><span class="line">    CHECK(<span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;streamMask&quot;</span>, (int32_t *)&amp;streamMask));</span><br><span class="line">    CHECK(<span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;resumeMask&quot;</span>, (int32_t *)&amp;resumeMask));</span><br><span class="line"></span><br><span class="line">    streamMask |= resumeMask;</span><br><span class="line"></span><br><span class="line">    AString URIs[kMaxStreams];</span><br><span class="line">    <span class="keyword">for</span> (size_t i = <span class="number">0</span>; i &lt; kMaxStreams; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (streamMask &amp; indexToType(i)) &#123;</span><br><span class="line">            const AString &amp;uriKey = mStreams[i].uriKey();</span><br><span class="line">            CHECK(<span class="function"><span class="title">msg</span>-&gt;</span>findString(uriKey.c_str(), &amp;URIs[i]));</span><br><span class="line">            ALOGV(<span class="string">&quot;%s = &#x27;%s&#x27;&quot;</span>, uriKey.c_str(), URIs[i].c_str());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    uint32_t changedMask = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (size_t i = <span class="number">0</span>; i &lt; kMaxStreams &amp;&amp; i != kSubtitleIndex; ++i) &#123;</span><br><span class="line">        <span class="comment">// stream URI could change even if onChangeConfiguration2 is only</span></span><br><span class="line">        <span class="comment">// used for seek. Seek could happen during a bw switch, in this</span></span><br><span class="line">        <span class="comment">// case bw switch will be cancelled, but the seekTo position will</span></span><br><span class="line">        <span class="comment">// fetch from the new URI.</span></span><br><span class="line">        <span class="keyword">if</span> ((mStreamMask &amp; streamMask &amp; indexToType(i))</span><br><span class="line">                &amp;&amp; !mStreams[i].mUri.empty()</span><br><span class="line">                &amp;&amp; !(URIs[i] == mStreams[i].mUri)) &#123;</span><br><span class="line">            ALOGV(<span class="string">&quot;stream %zu changed: oldURI %s, newURI %s&quot;</span>, i,</span><br><span class="line">                    mStreams[i].mUri.c_str(), URIs[i].c_str());</span><br><span class="line">            sp&lt;AnotherPacketSource&gt; source = mPacketSources.valueFor(indexToType(i));</span><br><span class="line">            <span class="function"><span class="title">if</span> (source-&gt;</span>getLatestDequeuedMeta() != NULL) &#123;</span><br><span class="line">                <span class="function"><span class="title">source</span>-&gt;</span>queueDiscontinuity(ATSParser::DISCONTINUITY_FORMATCHANGE, NULL, <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Determine which decoders to shutdown on the player side,</span></span><br><span class="line">        <span class="comment">// a decoder has to be shutdown if its streamtype was active</span></span><br><span class="line">        <span class="comment">// before but now longer isn&#x27;t.</span></span><br><span class="line">        <span class="keyword">if</span> ((mStreamMask &amp; ~streamMask &amp; indexToType(i))) &#123;</span><br><span class="line">            changedMask |= indexToType(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//这里会触发kWhatStreamsChanged</span></span><br><span class="line">    <span class="function"><span class="title">sp</span>&lt;AMessage&gt; notify = mNotify-&gt;</span>dup();</span><br><span class="line">    <span class="function"><span class="title">notify</span>-&gt;</span>setInt32(<span class="string">&quot;what&quot;</span>, kWhatStreamsChanged);</span><br><span class="line">    <span class="function"><span class="title">notify</span>-&gt;</span>setInt32(<span class="string">&quot;changedMask&quot;</span>, changedMask);</span><br><span class="line">	<span class="comment">//将kWhatChangeConfiguration3作为回复消息</span></span><br><span class="line">    <span class="function"><span class="title">msg</span>-&gt;</span>setWhat(kWhatChangeConfiguration3);</span><br><span class="line">    <span class="function"><span class="title">msg</span>-&gt;</span>setTarget(this);</span><br><span class="line">    <span class="function"><span class="title">notify</span>-&gt;</span>setMessage(<span class="string">&quot;reply&quot;</span>, msg);</span><br><span class="line">    <span class="function"><span class="title">notify</span>-&gt;</span>post();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">case LiveSession::kWhatStreamsChanged:</span><br><span class="line">&#123;</span><br><span class="line">    uint32_t changedMask;</span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">findInt32</span>(<span class="string">&quot;changedMask&quot;</span>, (<span class="params">int32_t</span> <span class="operator">*</span>)</span>&amp;changedMask));</span><br><span class="line">    <span class="comment">//判断什么流改变</span></span><br><span class="line">    <span class="built_in">bool</span> audio = changedMask &amp; LiveSession::STREAMTYPE_AUDIO;</span><br><span class="line">    <span class="built_in">bool</span> video = changedMask &amp; LiveSession::STREAMTYPE_VIDEO;</span><br><span class="line">    sp&lt;AMessage&gt; reply;</span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">findMessage</span>(<span class="string">&quot;reply&quot;</span>, &amp;<span class="params">reply</span>)</span>);</span><br><span class="line">    sp&lt;AMessage&gt; notify = dup<span class="constructor">Notify()</span>;</span><br><span class="line">    notify-&gt;set<span class="constructor">Int32(<span class="string">&quot;what&quot;</span>, <span class="params">kWhatQueueDecoderShutdown</span>)</span>;</span><br><span class="line">    notify-&gt;set<span class="constructor">Int32(<span class="string">&quot;audio&quot;</span>, <span class="params">audio</span>)</span>;</span><br><span class="line">    notify-&gt;set<span class="constructor">Int32(<span class="string">&quot;video&quot;</span>, <span class="params">video</span>)</span>;</span><br><span class="line">    notify-&gt;set<span class="constructor">Message(<span class="string">&quot;reply&quot;</span>, <span class="params">reply</span>)</span>;</span><br><span class="line">    notify-&gt;post<span class="literal">()</span>;</span><br><span class="line">    break;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">case Source::kWhatQueueDecoderShutdown:</span><br><span class="line">&#123;</span><br><span class="line">    int32_t audio, video;</span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">findInt32</span>(<span class="string">&quot;audio&quot;</span>, &amp;<span class="params">audio</span>)</span>);</span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">findInt32</span>(<span class="string">&quot;video&quot;</span>, &amp;<span class="params">video</span>)</span>);</span><br><span class="line">    sp&lt;AMessage&gt; reply;</span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">findMessage</span>(<span class="string">&quot;reply&quot;</span>, &amp;<span class="params">reply</span>)</span>);</span><br><span class="line">    queue<span class="constructor">DecoderShutdown(<span class="params">audio</span>, <span class="params">video</span>, <span class="params">reply</span>)</span>;</span><br><span class="line">    break;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title class_">NuPlayer</span>::<span class="title function_ invoke__">queueDecoderShutdown</span>(</span><br><span class="line">        <span class="keyword">bool</span> audio, <span class="keyword">bool</span> video, <span class="keyword">const</span> sp&lt;AMessage&gt; &amp;reply) &#123;</span><br><span class="line">    <span class="title function_ invoke__">ALOGI</span>(<span class="string">&quot;queueDecoderShutdown audio=%d, video=%d&quot;</span>, audio, video);</span><br><span class="line">    mDeferredActions.<span class="title function_ invoke__">push_back</span>(<span class="keyword">new</span> <span class="title class_">FlushDecoderAction</span>(audio ? FLUSH_CMD_SHUTDOWN : FLUSH_CMD_NONE,video ? FLUSH_CMD_SHUTDOWN : FLUSH_CMD_NONE));</span><br><span class="line">    mDeferredActions.<span class="title function_ invoke__">push_back</span>(<span class="keyword">new</span> <span class="title class_">SimpleAction</span>(&amp;<span class="title class_">NuPlayer</span>::<span class="variable constant_">performScanSources</span>));</span><br><span class="line">    mDeferredActions.<span class="title function_ invoke__">push_back</span>(<span class="keyword">new</span> <span class="title class_">PostMessageAction</span>(reply));</span><br><span class="line">    <span class="title function_ invoke__">processDeferredActions</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用performDecoderFlush</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> NuPlayer::FlushDecoderAction : public Action &#123;</span><br><span class="line">    <span class="constructor">FlushDecoderAction(FlushCommand <span class="params">audio</span>, FlushCommand <span class="params">video</span>)</span></span><br><span class="line">        : m<span class="constructor">Audio(<span class="params">audio</span>)</span>,</span><br><span class="line">          m<span class="constructor">Video(<span class="params">video</span>)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">virtual</span> void execute(NuPlayer *player) &#123;</span><br><span class="line">        player-&gt;perform<span class="constructor">DecoderFlush(<span class="params">mAudio</span>, <span class="params">mVideo</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    FlushCommand mAudio;</span><br><span class="line">    FlushCommand mVideo;</span><br><span class="line">    <span class="constructor">DISALLOW_EVIL_CONSTRUCTORS(FlushDecoderAction)</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void NuPlayer::perform<span class="constructor">DecoderFlush(FlushCommand <span class="params">audio</span>, FlushCommand <span class="params">video</span>)</span> &#123;</span><br><span class="line">    <span class="constructor">ALOGV(<span class="string">&quot;performDecoderFlush audio=%d, video=%d&quot;</span>, <span class="params">audio</span>, <span class="params">video</span>)</span>;</span><br><span class="line">    <span class="keyword">if</span> ((audio<span class="operator"> == </span>FLUSH_CMD_NONE<span class="operator"> || </span>mAudioDecoder<span class="operator"> == </span>NULL)&amp;&amp; (video<span class="operator"> == </span>FLUSH_CMD_NONE<span class="operator"> || </span>mVideoDecoder<span class="operator"> == </span>NULL)) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (audio != FLUSH_CMD_NONE<span class="operator"> &amp;&amp; </span>mAudioDecoder != NULL) &#123;</span><br><span class="line">        flush<span class="constructor">Decoder(<span class="params">true</span> <span class="operator">/</span><span class="operator">*</span> <span class="params">audio</span> <span class="operator">*</span><span class="operator">/</span>, (<span class="params">audio</span> <span class="operator">==</span> FLUSH_CMD_SHUTDOWN)</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (video != FLUSH_CMD_NONE<span class="operator"> &amp;&amp; </span>mVideoDecoder != NULL) &#123;</span><br><span class="line">        flush<span class="constructor">Decoder(<span class="params">false</span> <span class="operator">/</span><span class="operator">*</span> <span class="params">audio</span> <span class="operator">*</span><span class="operator">/</span>, (<span class="params">video</span> <span class="operator">==</span> FLUSH_CMD_SHUTDOWN)</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">NuPlayer::flushDecoder</span><span class="params">(<span class="type">bool</span> audio, <span class="type">bool</span> needShutdown)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">ALOGV</span>(<span class="string">&quot;[%s] flushDecoder needShutdown=%d&quot;</span>,</span><br><span class="line">          audio ? <span class="string">&quot;audio&quot;</span> : <span class="string">&quot;video&quot;</span>, needShutdown);</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> sp&lt;DecoderBase&gt; &amp;decoder = <span class="built_in">getDecoder</span>(audio);</span><br><span class="line">    <span class="type">const</span> sp&lt;DecoderBase&gt; &amp;decoder = <span class="built_in">getDecoder</span>(audio);</span><br><span class="line">    <span class="keyword">if</span> (decoder == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">ALOGI</span>(<span class="string">&quot;flushDecoder %s without decoder present&quot;</span>,audio ? <span class="string">&quot;audio&quot;</span> : <span class="string">&quot;video&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...........</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>紧接着我们看下初始化编码器部分：</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void NuPlayer::post<span class="constructor">ScanSources()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mScanSourcesPending) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> <span class="constructor">AMessage(<span class="params">kWhatScanSources</span>, <span class="params">this</span>)</span>;</span><br><span class="line">    msg-&gt;set<span class="constructor">Int32(<span class="string">&quot;generation&quot;</span>, <span class="params">mScanSourcesGeneration</span>)</span>;</span><br><span class="line">    msg-&gt;post<span class="literal">()</span>;</span><br><span class="line">    mScanSourcesPending = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> kWhatScanSources:</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int32_t</span> generation;</span><br><span class="line"></span><br><span class="line">    mScanSourcesPending = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> mHadAnySourcesBefore =</span><br><span class="line">        (mAudioDecoder != <span class="literal">NULL</span>) || (mVideoDecoder != <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// initialize video before audio because successful initialization of</span></span><br><span class="line">    <span class="comment">// video may change deep buffer mode of audio.</span></span><br><span class="line">    <span class="keyword">if</span> (mSurface != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">instantiateDecoder</span>(<span class="literal">false</span>, &amp;mVideoDecoder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Don&#x27;t try to re-open audio sink if there&#x27;s an existing decoder.</span></span><br><span class="line">    <span class="keyword">if</span> (mAudioSink != <span class="literal">NULL</span> &amp;&amp; mAudioDecoder == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">instantiateDecoder</span>(<span class="literal">true</span>, &amp;mAudioDecoder);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">status_t NuPlayer::instantiate<span class="constructor">Decoder(<span class="params">bool</span> <span class="params">audio</span>, <span class="params">sp</span>&lt;DecoderBase&gt; <span class="operator">*</span><span class="params">decoder</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取格式</span></span><br><span class="line">    sp&lt;AMessage&gt; format = mSource-&gt;get<span class="constructor">Format(<span class="params">audio</span>)</span>;</span><br><span class="line">    format-&gt;set<span class="constructor">Int32(<span class="string">&quot;priority&quot;</span>, 0 <span class="operator">/</span><span class="operator">*</span> <span class="params">realtime</span> <span class="operator">*</span><span class="operator">/</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (audio) &#123;</span><br><span class="line">        sp&lt;AMessage&gt; notify = <span class="keyword">new</span> <span class="constructor">AMessage(<span class="params">kWhatAudioNotify</span>, <span class="params">this</span>)</span>;</span><br><span class="line">        ++mAudioDecoderGeneration;</span><br><span class="line">        notify-&gt;set<span class="constructor">Int32(<span class="string">&quot;generation&quot;</span>, <span class="params">mAudioDecoderGeneration</span>)</span>;</span><br><span class="line">        determine<span class="constructor">AudioModeChange()</span>;</span><br><span class="line">        <span class="keyword">if</span> (mOffloadAudio) &#123;</span><br><span class="line">          <span class="comment">//....................</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            *decoder = <span class="keyword">new</span> <span class="constructor">Decoder(<span class="params">notify</span>, <span class="params">mSource</span>, <span class="params">mPID</span>, <span class="params">mRenderer</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sp&lt;AMessage&gt; notify = <span class="keyword">new</span> <span class="constructor">AMessage(<span class="params">kWhatVideoNotify</span>, <span class="params">this</span>)</span>;</span><br><span class="line">        ++mVideoDecoderGeneration;</span><br><span class="line">        notify-&gt;set<span class="constructor">Int32(<span class="string">&quot;generation&quot;</span>, <span class="params">mVideoDecoderGeneration</span>)</span>;</span><br><span class="line">        *decoder = <span class="keyword">new</span> <span class="constructor">Decoder(<span class="params">notify</span>, <span class="params">mSource</span>, <span class="params">mPID</span>, <span class="params">mRenderer</span>, <span class="params">mSurface</span>, <span class="params">mCCDecoder</span>)</span>;</span><br><span class="line">        <span class="comment">//...........................</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//解码器初始化</span></span><br><span class="line">    (*decoder)-&gt;init<span class="literal">()</span>;</span><br><span class="line">    <span class="comment">//配置解码器</span></span><br><span class="line">    (*decoder)-&gt;configure(format);</span><br><span class="line">    <span class="comment">//.........</span></span><br><span class="line">    return OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里创建出解码器并初始化它。</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void NuPlayer::DecoderBase::configure(const sp&lt;AMessage&gt; &amp;format) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> <span class="constructor">AMessage(<span class="params">kWhatConfigure</span>, <span class="params">this</span>)</span>;</span><br><span class="line">    msg-&gt;set<span class="constructor">Message(<span class="string">&quot;format&quot;</span>, <span class="params">format</span>)</span>;</span><br><span class="line">    msg-&gt;post<span class="literal">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void NuPlayer::DecoderBase::init<span class="literal">()</span> &#123;</span><br><span class="line">    mDecoderLooper-&gt;register<span class="constructor">Handler(<span class="params">this</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void NuPlayer::Decoder::on<span class="constructor">Configure(<span class="params">const</span> <span class="params">sp</span>&lt;AMessage&gt; &amp;<span class="params">format</span>)</span> &#123;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">//创建MediaCodec</span></span><br><span class="line">    mCodec = MediaCodec::<span class="constructor">CreateByType(<span class="params">mCodecLooper</span>, <span class="params">mime</span>.<span class="params">c_str</span>()</span>, <span class="literal">false</span> <span class="comment">/* encoder */</span>, NULL <span class="comment">/* err */</span>, mPid);</span><br><span class="line">    <span class="comment">//配置MediaCodec</span></span><br><span class="line">    err = mCodec-&gt;configure(format, mSurface, NULL <span class="comment">/* crypto */</span>, <span class="number">0</span> <span class="comment">/* flags */</span>);</span><br><span class="line">    <span class="comment">//如果是视频文件则设置宽高</span></span><br><span class="line">    <span class="keyword">if</span> (!mIsAudio) &#123;</span><br><span class="line">        int32_t width, height;</span><br><span class="line">        <span class="keyword">if</span> (mOutputFormat-&gt;find<span class="constructor">Int32(<span class="string">&quot;width&quot;</span>, &amp;<span class="params">width</span>)</span>&amp;&amp; mOutputFormat-&gt;find<span class="constructor">Int32(<span class="string">&quot;height&quot;</span>, &amp;<span class="params">height</span>)</span>) &#123;</span><br><span class="line">            mStats-&gt;set<span class="constructor">Int32(<span class="string">&quot;width&quot;</span>, <span class="params">width</span>)</span>;</span><br><span class="line">            mStats-&gt;set<span class="constructor">Int32(<span class="string">&quot;height&quot;</span>, <span class="params">height</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//启动MediaCodec</span></span><br><span class="line">    err = mCodec-&gt;start<span class="literal">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">sp&lt;MediaCodec&gt; MediaCodec::<span class="constructor">CreateByType(<span class="params">const</span> <span class="params">sp</span>&lt;ALooper&gt; &amp;<span class="params">looper</span>, <span class="params">const</span> <span class="params">char</span> <span class="operator">*</span><span class="params">mime</span>, <span class="params">bool</span> <span class="params">encoder</span>, <span class="params">status_t</span> <span class="operator">*</span><span class="params">err</span>, <span class="params">pid_t</span> <span class="params">pid</span>)</span> &#123;</span><br><span class="line">    sp&lt;MediaCodec&gt; codec = <span class="keyword">new</span> <span class="constructor">MediaCodec(<span class="params">looper</span>, <span class="params">pid</span>)</span>;</span><br><span class="line">    const status_t ret = codec-&gt;init(mime, <span class="literal">true</span> <span class="comment">/* nameIsType */</span>, encoder);</span><br><span class="line">    return ret<span class="operator"> == </span>OK ? codec : NULL; <span class="comment">// NULL deallocates codec.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里说明mCodec是一个ACodec对象</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">status_t MediaCodec::init(const AString &amp;name, <span class="built_in">bool</span> nameIsType, <span class="built_in">bool</span> encoder) &#123;</span><br><span class="line">    mResourceManagerService-&gt;init<span class="literal">()</span>;</span><br><span class="line">    <span class="keyword">if</span> (nameIsType<span class="operator"> || </span>!strncasecmp(name.c<span class="constructor">_str()</span>, <span class="string">&quot;omx.&quot;</span>, <span class="number">4</span>)) &#123;</span><br><span class="line">        <span class="comment">//根据名称创建Codec</span></span><br><span class="line">        mCodec = <span class="keyword">new</span> ACodec;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!nameIsType&amp;&amp; !strncasecmp(name.c<span class="constructor">_str()</span>, <span class="string">&quot;android.filter.&quot;</span>, <span class="number">15</span>)) &#123;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> <span class="constructor">AMessage(<span class="params">kWhatInit</span>, <span class="params">this</span>)</span>;</span><br><span class="line">    msg-&gt;set<span class="constructor">String(<span class="string">&quot;name&quot;</span>, <span class="params">name</span>)</span>;</span><br><span class="line">    msg-&gt;set<span class="constructor">Int32(<span class="string">&quot;nameIsType&quot;</span>, <span class="params">nameIsType</span>)</span>;</span><br><span class="line">    <span class="keyword">if</span> (nameIsType) &#123;</span><br><span class="line">        msg-&gt;set<span class="constructor">Int32(<span class="string">&quot;encoder&quot;</span>, <span class="params">encoder</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    return err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight mel"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> kWhatInit:</span><br><span class="line">&#123;</span><br><span class="line">   	<span class="comment">//....................</span></span><br><span class="line">    mCodec-&gt;initiateAllocateComponent(<span class="keyword">format</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void ACodec::initiate<span class="constructor">AllocateComponent(<span class="params">const</span> <span class="params">sp</span>&lt;AMessage&gt; &amp;<span class="params">msg</span>)</span> &#123;</span><br><span class="line">    msg-&gt;set<span class="constructor">What(<span class="params">kWhatAllocateComponent</span>)</span>;</span><br><span class="line">    msg-&gt;set<span class="constructor">Target(<span class="params">this</span>)</span>;</span><br><span class="line">    msg-&gt;post<span class="literal">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> ACodec::kWhatAllocateComponent:</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">onAllocateComponent</span>(msg);</span><br><span class="line">    handled = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里开始实例化编码器并设置状态</p>
<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line">bool ACodec::UninitializedState::onAllocateComponent(const sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    </span><br><span class="line">    Vector&lt;OMXCodec::CodecNameAndQuirks&gt; matchingCodecs;</span><br><span class="line">    AString mime;</span><br><span class="line">    AString componentName;</span><br><span class="line">    uint32_t quirks = <span class="number">0</span>;</span><br><span class="line">    int32_t encoder = <span class="literal">false</span>;</span><br><span class="line">    <span class="function"><span class="title">if</span> (msg-&gt;</span>findString(<span class="string">&quot;componentName&quot;</span>, &amp;componentName)) &#123;</span><br><span class="line">        ssize_t index = matchingCodecs.add();</span><br><span class="line">        OMXCodec::CodecNameAndQuirks *entry = &amp;matchingCodecs.editItemAt(index);</span><br><span class="line">        <span class="function"><span class="title">entry</span>-&gt;</span>mName = String8(componentName.c_str());</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="title">if</span> (!OMXCodec::findCodecQuirks(componentName.c_str(), &amp;entry-&gt;</span>mQuirks)) &#123;</span><br><span class="line">            <span class="function"><span class="title">entry</span>-&gt;</span>mQuirks = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        CHECK(<span class="function"><span class="title">msg</span>-&gt;</span>findString(<span class="string">&quot;mime&quot;</span>, &amp;mime));</span><br><span class="line">        <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;encoder&quot;</span>, &amp;encoder)) &#123;</span><br><span class="line">            encoder = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        OMXCodec::findMatchingCodecs(</span><br><span class="line">                mime.c_str(),</span><br><span class="line">                encoder, <span class="comment">// createEncoder</span></span><br><span class="line">                NULL,  <span class="comment">// matchComponentName</span></span><br><span class="line">                <span class="number">0</span>,     <span class="comment">// flags</span></span><br><span class="line">                &amp;matchingCodecs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;CodecObserver&gt; observer = new CodecObserver;</span><br><span class="line">    IOMX::node_id node = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    status_t err = NAME_NOT_FOUND;</span><br><span class="line">    <span class="keyword">for</span> (size_t matchIndex = <span class="number">0</span>; matchIndex &lt; matchingCodecs.size();++matchIndex) &#123;</span><br><span class="line">        componentName = matchingCodecs.itemAt(matchIndex).mName.string();</span><br><span class="line">        quirks = matchingCodecs.itemAt(matchIndex).mQuirks;</span><br><span class="line"></span><br><span class="line">        pid_t tid = gettid();</span><br><span class="line">        int prevPriority = androidGetThreadPriority(tid);</span><br><span class="line">        androidSetThreadPriority(tid, ANDROID_PRIORITY_FOREGROUND);</span><br><span class="line">        <span class="function"><span class="title">err</span> = omx-&gt;</span>allocateNode(componentName.c_str(), observer, &amp;node);</span><br><span class="line">        androidSetThreadPriority(tid, prevPriority);</span><br><span class="line">        node = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    notify = new AMessage(kWhatOMXMessageList, mCodec);</span><br><span class="line">    <span class="function"><span class="title">observer</span>-&gt;</span>setNotificationMessage(notify);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">mCodec</span>-&gt;</span>mComponentName = componentName;</span><br><span class="line">    <span class="function"><span class="title">mCodec</span>-&gt;</span>mRenderTracker.setComponentName(componentName);</span><br><span class="line">    <span class="function"><span class="title">mCodec</span>-&gt;</span>mFlags = <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="title">mCodec</span>-&gt;</span>mQuirks = quirks;</span><br><span class="line">    <span class="function"><span class="title">mCodec</span>-&gt;</span>mOMX = omx;</span><br><span class="line">    <span class="function"><span class="title">mCodec</span>-&gt;</span>mNode = node;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="title">sp</span>&lt;AMessage&gt; notify = mCodec-&gt;</span><span class="function"><span class="title">mNotify</span>-&gt;</span>dup();</span><br><span class="line">        <span class="function"><span class="title">notify</span>-&gt;</span>setInt32(<span class="string">&quot;what&quot;</span>, CodecBase::kWhatComponentAllocated);</span><br><span class="line">        <span class="function"><span class="title">notify</span>-&gt;</span><span class="function"><span class="title">setString</span>(&quot;componentName&quot;, mCodec-&gt;</span>mComponentName.c_str());</span><br><span class="line">        <span class="function"><span class="title">notify</span>-&gt;</span>post();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">mCodec</span>-&gt;</span><span class="function"><span class="title">changeState</span>(mCodec-&gt;</span>mLoadedState);</span><br><span class="line">    return <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解码器的配置</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">status_t MediaCodec::configure(</span><br><span class="line">        const sp&lt;AMessage&gt; &amp;format,</span><br><span class="line">        const sp&lt;Surface&gt; &amp;surface,</span><br><span class="line">        const sp&lt;ICrypto&gt; &amp;crypto,</span><br><span class="line">        uint32_t flags) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> <span class="constructor">AMessage(<span class="params">kWhatConfigure</span>, <span class="params">this</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mIsVideo) &#123;</span><br><span class="line">        format-&gt;find<span class="constructor">Int32(<span class="string">&quot;width&quot;</span>, &amp;<span class="params">mVideoWidth</span>)</span>;</span><br><span class="line">        format-&gt;find<span class="constructor">Int32(<span class="string">&quot;height&quot;</span>, &amp;<span class="params">mVideoHeight</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (!format-&gt;find<span class="constructor">Int32(<span class="string">&quot;rotation-degrees&quot;</span>, &amp;<span class="params">mRotationDegrees</span>)</span>) &#123;</span><br><span class="line">            mRotationDegrees = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    msg-&gt;set<span class="constructor">Message(<span class="string">&quot;format&quot;</span>, <span class="params">format</span>)</span>;</span><br><span class="line">    msg-&gt;set<span class="constructor">Int32(<span class="string">&quot;flags&quot;</span>, <span class="params">flags</span>)</span>;</span><br><span class="line">    msg-&gt;set<span class="constructor">Object(<span class="string">&quot;surface&quot;</span>, <span class="params">surface</span>)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//.....................</span></span><br><span class="line">    <span class="comment">// save msg for reset</span></span><br><span class="line">    mConfigureMsg = msg;</span><br><span class="line">	<span class="comment">//.....................</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt;= kMaxRetry; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Don&#x27;t try to reclaim resource for the first time.</span></span><br><span class="line">            <span class="keyword">if</span> (!mResourceManagerService-&gt;reclaim<span class="constructor">Resource(<span class="params">resources</span>)</span>) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        sp&lt;AMessage&gt; response;</span><br><span class="line">        err = <span class="constructor">PostAndAwaitResponse(<span class="params">msg</span>, &amp;<span class="params">response</span>)</span>;</span><br><span class="line">        <span class="comment">//.....................</span></span><br><span class="line">    &#125;</span><br><span class="line">    return err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">case kWhatConfigure:</span><br><span class="line">&#123;</span><br><span class="line">    sp&lt;AReplyToken&gt; replyID;</span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">senderAwaitsResponse</span>(&amp;<span class="params">replyID</span>)</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    sp&lt;RefBase&gt; obj;</span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">findObject</span>(<span class="string">&quot;surface&quot;</span>, &amp;<span class="params">obj</span>)</span>);</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; format;</span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">findMessage</span>(<span class="string">&quot;format&quot;</span>, &amp;<span class="params">format</span>)</span>);</span><br><span class="line"></span><br><span class="line">    int32_t push;</span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;find<span class="constructor">Int32(<span class="string">&quot;push-blank-buffers-on-shutdown&quot;</span>, &amp;<span class="params">push</span>)</span><span class="operator"> &amp;&amp; </span>push != <span class="number">0</span>) &#123;</span><br><span class="line">        mFlags <span class="pattern-match">|= k<span class="constructor">FlagPushBlankBuffersOnShutdown</span>;</span></span><br><span class="line"><span class="pattern-match">    &#125;</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">    <span class="keyword">if</span> (obj != <span class="constructor">NULL</span>) &#123;</span></span><br><span class="line"><span class="pattern-match">        format-&gt;set<span class="constructor">Object(<span class="string">&quot;native-window&quot;</span>, <span class="params">obj</span>)</span>;</span></span><br><span class="line"><span class="pattern-match">        status<span class="constructor">_t</span> err = handle<span class="constructor">SetSurface(<span class="params">static_cast</span>&lt;Surface <span class="operator">*</span>&gt;(<span class="params">obj</span>.<span class="params">get</span>()</span>));</span></span><br><span class="line"><span class="pattern-match">        <span class="keyword">if</span> (err != <span class="constructor">OK</span>) &#123;</span></span><br><span class="line"><span class="pattern-match">            <span class="constructor">PostReplyWithError(<span class="params">replyID</span>, <span class="params">err</span>)</span>;</span></span><br><span class="line"><span class="pattern-match">            break;</span></span><br><span class="line"><span class="pattern-match">        &#125;</span></span><br><span class="line"><span class="pattern-match">    &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="pattern-match">        handle<span class="constructor">SetSurface(NULL)</span>;</span></span><br><span class="line"><span class="pattern-match">    &#125;</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">    m<span class="constructor">ReplyID</span> = reply<span class="constructor">ID</span>;</span></span><br><span class="line"><span class="pattern-match">    set<span class="constructor">State(CONFIGURING)</span>;</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">    void <span class="operator">*</span>crypto;</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">    uint32<span class="constructor">_t</span> flags;</span></span><br><span class="line"><span class="pattern-match">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">findInt32</span>(<span class="string">&quot;flags&quot;</span>, (<span class="params">int32_t</span> <span class="operator">*</span>)</span>&amp;flags));</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">    <span class="keyword">if</span> (flags &amp; <span class="constructor">CONFIGURE_FLAG_ENCODE</span>) &#123;</span></span><br><span class="line"><span class="pattern-match">        format-&gt;set<span class="constructor">Int32(<span class="string">&quot;encoder&quot;</span>, <span class="params">true</span>)</span>;</span></span><br><span class="line"><span class="pattern-match">        m<span class="constructor">Flags</span> |= k<span class="constructor">FlagIsEncoder</span>;</span></span><br><span class="line"><span class="pattern-match">    &#125;</span></span><br><span class="line"><span class="pattern-match">	<span class="operator">/</span><span class="operator">/</span>这里最重要</span></span><br><span class="line"><span class="pattern-match">    m<span class="constructor">Codec</span>-&gt;initiate<span class="constructor">ConfigureComponent(<span class="params">format</span>)</span>;</span></span><br><span class="line"><span class="pattern-match">    break;</span></span><br><span class="line"><span class="pattern-match">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void ACodec::initiate<span class="constructor">ConfigureComponent(<span class="params">const</span> <span class="params">sp</span>&lt;AMessage&gt; &amp;<span class="params">msg</span>)</span> &#123;</span><br><span class="line">    msg-&gt;set<span class="constructor">What(<span class="params">kWhatConfigureComponent</span>)</span>;</span><br><span class="line">    msg-&gt;set<span class="constructor">Target(<span class="params">this</span>)</span>;</span><br><span class="line">    msg-&gt;post<span class="literal">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> ACodec::kWhatConfigureComponent:</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">onConfigureComponent</span>(msg);</span><br><span class="line">    handled = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line">bool ACodec::LoadedState::onConfigureComponent(</span><br><span class="line">        const sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    ALOGV(<span class="string">&quot;onConfigureComponent&quot;</span>);</span><br><span class="line"></span><br><span class="line">    CHECK(<span class="function"><span class="title">mCodec</span>-&gt;</span>mNode != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    status_t err = OK;</span><br><span class="line">    AString mime;</span><br><span class="line">    <span class="function"><span class="title">if</span> (!msg-&gt;</span>findString(<span class="string">&quot;mime&quot;</span>, &amp;mime)) &#123;</span><br><span class="line">        err = BAD_VALUE;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="function"><span class="title">err</span> = mCodec-&gt;</span>configureCodec(mime.c_str(), msg);</span><br><span class="line">    &#125;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="title">sp</span>&lt;AMessage&gt; notify = mCodec-&gt;</span><span class="function"><span class="title">mNotify</span>-&gt;</span>dup();</span><br><span class="line">        <span class="function"><span class="title">notify</span>-&gt;</span>setInt32(<span class="string">&quot;what&quot;</span>, CodecBase::kWhatComponentConfigured);</span><br><span class="line">        <span class="function"><span class="title">notify</span>-&gt;</span><span class="function"><span class="title">setMessage</span>(&quot;input-format&quot;, mCodec-&gt;</span>mInputFormat);</span><br><span class="line">        <span class="function"><span class="title">notify</span>-&gt;</span><span class="function"><span class="title">setMessage</span>(&quot;output-format&quot;, mCodec-&gt;</span>mOutputFormat);</span><br><span class="line">        <span class="function"><span class="title">notify</span>-&gt;</span>post();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">case CodecBase::kWhatComponentConfigured:</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (mState<span class="operator"> == </span>UNINITIALIZED<span class="operator"> || </span>mState<span class="operator"> == </span>INITIALIZED) &#123;</span><br><span class="line">        <span class="comment">// In case a kWhatError message came in and replied with error,</span></span><br><span class="line">        <span class="comment">// we log a warning and ignore.</span></span><br><span class="line">        <span class="constructor">ALOGW(<span class="string">&quot;configure interrupted by error, current state %d&quot;</span>, <span class="params">mState</span>)</span>;</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="constructor">CHECK_EQ(<span class="params">mState</span>, CONFIGURING)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// reset input surface flag</span></span><br><span class="line">    mHaveInputSurface = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">findMessage</span>(<span class="string">&quot;input-format&quot;</span>, &amp;<span class="params">mInputFormat</span>)</span>);</span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">findMessage</span>(<span class="string">&quot;output-format&quot;</span>, &amp;<span class="params">mOutputFormat</span>)</span>);</span><br><span class="line"></span><br><span class="line">    int32_t usingSwRenderer;</span><br><span class="line">    <span class="keyword">if</span> (mOutputFormat-&gt;find<span class="constructor">Int32(<span class="string">&quot;using-sw-renderer&quot;</span>, &amp;<span class="params">usingSwRenderer</span>)</span><span class="operator"></span></span><br><span class="line"><span class="operator">            &amp;&amp; </span>usingSwRenderer) &#123;</span><br><span class="line">        mFlags <span class="pattern-match">|= k<span class="constructor">FlagUsesSoftwareRenderer</span>;</span></span><br><span class="line"><span class="pattern-match">    &#125;</span></span><br><span class="line"><span class="pattern-match">    set<span class="constructor">State(CONFIGURED)</span>;</span></span><br><span class="line"><span class="pattern-match">    (<span class="keyword">new</span> <span class="constructor">AMessage</span>)-&gt;post<span class="constructor">Reply(<span class="params">mReplyID</span>)</span>;</span></span><br><span class="line"><span class="pattern-match">    break;</span></span><br><span class="line"><span class="pattern-match">&#125;</span></span><br></pre></td></tr></table></figure>
<p>这里才是解码器最详细的配置，有时间好好针对这个展开研究，这篇博客先针对整个流程进行分析：</p>
<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line">status_t ACodec::configureCodec(</span><br><span class="line">        const char *mime, const sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    int32_t encoder;</span><br><span class="line">    <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;encoder&quot;</span>, &amp;encoder)) &#123;</span><br><span class="line">        encoder = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; inputFormat = new AMessage();</span><br><span class="line">    <span class="function"><span class="title">sp</span>&lt;AMessage&gt; outputFormat = mNotify-&gt;</span>dup(); <span class="comment">// will use this for kWhatOutputFormatChanged</span></span><br><span class="line"></span><br><span class="line">    mIsEncoder = encoder;</span><br><span class="line"></span><br><span class="line">    mInputMetadataType = kMetadataBufferTypeInvalid;</span><br><span class="line">    mOutputMetadataType = kMetadataBufferTypeInvalid;</span><br><span class="line"></span><br><span class="line">    status_t err = setComponentRole(encoder <span class="comment">/* isEncoder */</span>, mime);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">        return err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    int32_t bitRate = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// FLAC encoder doesn&#x27;t need a bitrate, other encoders do</span></span><br><span class="line">    <span class="keyword">if</span> (encoder &amp;&amp; strcasecmp(mime, MEDIA_MIMETYPE_AUDIO_FLAC)</span><br><span class="line">            &amp;&amp; !<span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;bitrate&quot;</span>, &amp;bitRate)) &#123;</span><br><span class="line">        return INVALID_OPERATION;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    int32_t storeMeta;</span><br><span class="line">    <span class="keyword">if</span> (encoder</span><br><span class="line">            &amp;&amp; <span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;store-metadata-in-buffers&quot;</span>, &amp;storeMeta)</span><br><span class="line">            &amp;&amp; storeMeta != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="function"><span class="title">err</span> = mOMX-&gt;</span>storeMetaDataInBuffers(mNode, kPortIndexInput, OMX_TRUE, &amp;mInputMetadataType);</span><br><span class="line">        <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">            ALOGE(<span class="string">&quot;[%s] storeMetaDataInBuffers (input) failed w/ err %d&quot;</span>,</span><br><span class="line">                    mComponentName.c_str(), err);</span><br><span class="line"></span><br><span class="line">            return err;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// For this specific case we could be using camera source even if storeMetaDataInBuffers</span></span><br><span class="line">        <span class="comment">// returns Gralloc source. Pretend that we are; this will force us to use nBufferSize.</span></span><br><span class="line">        <span class="keyword">if</span> (mInputMetadataType == kMetadataBufferTypeGrallocSource) &#123;</span><br><span class="line">            mInputMetadataType = kMetadataBufferTypeCameraSource;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        uint32_t usageBits;</span><br><span class="line">        <span class="function"><span class="title">if</span> (mOMX-&gt;</span>getParameter(</span><br><span class="line">                mNode, (OMX_INDEXTYPE)OMX_IndexParamConsumerUsageBits,</span><br><span class="line">                &amp;usageBits, sizeof(usageBits)) == OK) &#123;</span><br><span class="line">            <span class="function"><span class="title">inputFormat</span>-&gt;</span>setInt32(</span><br><span class="line">                    <span class="string">&quot;using-sw-read-often&quot;</span>, !!(usageBits &amp; GRALLOC_USAGE_SW_READ_OFTEN));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    int32_t prependSPSPPS = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (encoder</span><br><span class="line">            &amp;&amp; <span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;prepend-sps-pps-to-idr-frames&quot;</span>, &amp;prependSPSPPS)</span><br><span class="line">            &amp;&amp; prependSPSPPS != <span class="number">0</span>) &#123;</span><br><span class="line">        OMX_INDEXTYPE index;</span><br><span class="line">        <span class="function"><span class="title">err</span> = mOMX-&gt;</span>getExtensionIndex(</span><br><span class="line">                mNode,</span><br><span class="line">                <span class="string">&quot;OMX.google.android.index.prependSPSPPSToIDRFrames&quot;</span>,</span><br><span class="line">                &amp;index);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (err == OK) &#123;</span><br><span class="line">            PrependSPSPPSToIDRFramesParams params;</span><br><span class="line">            InitOMXParams(&amp;params);</span><br><span class="line">            params.bEnable = OMX_TRUE;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="title">err</span> = mOMX-&gt;</span>setParameter(</span><br><span class="line">                    mNode, index, &amp;params, sizeof(params));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">            ALOGE(<span class="string">&quot;Encoder could not be configured to emit SPS/PPS before &quot;</span></span><br><span class="line">                  <span class="string">&quot;IDR frames. (err %d)&quot;</span>, err);</span><br><span class="line"></span><br><span class="line">            return err;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Only enable metadata mode on encoder output if encoder can prepend</span></span><br><span class="line">    <span class="comment">// sps/pps to idr frames, since in metadata mode the bitstream is in an</span></span><br><span class="line">    <span class="comment">// opaque handle, to which we don&#x27;t have access.</span></span><br><span class="line">    int32_t video = !strncasecmp(mime, <span class="string">&quot;video/&quot;</span>, <span class="number">6</span>);</span><br><span class="line">    mIsVideo = video;</span><br><span class="line">    <span class="keyword">if</span> (encoder &amp;&amp; video) &#123;</span><br><span class="line">        OMX_BOOL enable = (OMX_BOOL) (prependSPSPPS</span><br><span class="line">            &amp;&amp; <span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;store-metadata-in-buffers-output&quot;</span>, &amp;storeMeta)</span><br><span class="line">            &amp;&amp; storeMeta != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="title">err</span> = mOMX-&gt;</span>storeMetaDataInBuffers(mNode, kPortIndexOutput, enable, &amp;mOutputMetadataType);</span><br><span class="line">        <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">            ALOGE(<span class="string">&quot;[%s] storeMetaDataInBuffers (output) failed w/ err %d&quot;</span>,</span><br><span class="line">                mComponentName.c_str(), err);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt64(</span><br><span class="line">                    <span class="string">&quot;repeat-previous-frame-after&quot;</span>,</span><br><span class="line">                    &amp;mRepeatFrameDelayUs)) &#123;</span><br><span class="line">            mRepeatFrameDelayUs = -<span class="number">1</span>ll;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt64(<span class="string">&quot;max-pts-gap-to-encoder&quot;</span>, &amp;mMaxPtsGapUs)) &#123;</span><br><span class="line">            mMaxPtsGapUs = -<span class="number">1</span>ll;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="title">if</span> (!msg-&gt;</span>findFloat(<span class="string">&quot;max-fps-to-encoder&quot;</span>, &amp;mMaxFps)) &#123;</span><br><span class="line">            mMaxFps = -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt64(<span class="string">&quot;time-lapse&quot;</span>, &amp;mTimePerCaptureUs)) &#123;</span><br><span class="line">            mTimePerCaptureUs = -<span class="number">1</span>ll;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(</span><br><span class="line">                    <span class="string">&quot;create-input-buffers-suspended&quot;</span>,</span><br><span class="line">                    (int32_t*)&amp;mCreateInputBuffersSuspended)) &#123;</span><br><span class="line">            mCreateInputBuffersSuspended = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">NOTE:</span> we only use native window for video decoders</span></span><br><span class="line">    sp&lt;RefBase&gt; obj;</span><br><span class="line">    <span class="function"><span class="title">bool</span> haveNativeWindow = msg-&gt;</span>findObject(<span class="string">&quot;native-window&quot;</span>, &amp;obj)</span><br><span class="line">            &amp;&amp; obj != NULL &amp;&amp; video &amp;&amp; !encoder;</span><br><span class="line">    mLegacyAdaptiveExperiment = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (video &amp;&amp; !encoder) &#123;</span><br><span class="line">        <span class="function"><span class="title">inputFormat</span>-&gt;</span>setInt32(<span class="string">&quot;adaptive-playback&quot;</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        int32_t usageProtected;</span><br><span class="line">        <span class="function"><span class="title">if</span> (msg-&gt;</span>findInt32(<span class="string">&quot;protected&quot;</span>, &amp;usageProtected) &amp;&amp; usageProtected) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!haveNativeWindow) &#123;</span><br><span class="line">                ALOGE(<span class="string">&quot;protected output buffers must be sent to an ANativeWindow&quot;</span>);</span><br><span class="line">                return PERMISSION_DENIED;</span><br><span class="line">            &#125;</span><br><span class="line">            mFlags |= kFlagIsGrallocUsageProtected;</span><br><span class="line">            mFlags |= kFlagPushBlankBuffersToNativeWindowOnShutdown;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (haveNativeWindow) &#123;</span><br><span class="line">        sp&lt;ANativeWindow&gt; nativeWindow =</span><br><span class="line">            static_cast&lt;ANativeWindow *&gt;(static_cast&lt;Surface *&gt;(obj.get()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// START of temporary support for automatic FRC - THIS WILL BE REMOVED</span></span><br><span class="line">        int32_t autoFrc;</span><br><span class="line">        <span class="function"><span class="title">if</span> (msg-&gt;</span>findInt32(<span class="string">&quot;auto-frc&quot;</span>, &amp;autoFrc)) &#123;</span><br><span class="line">            bool enabled = autoFrc;</span><br><span class="line">            OMX_CONFIG_BOOLEANTYPE config;</span><br><span class="line">            InitOMXParams(&amp;config);</span><br><span class="line">            config.bEnabled = (OMX_BOOL)enabled;</span><br><span class="line">            <span class="function"><span class="title">status_t</span> temp = mOMX-&gt;</span>setConfig(</span><br><span class="line">                    mNode, (OMX_INDEXTYPE)OMX_IndexConfigAutoFramerateConversion,</span><br><span class="line">                    &amp;config, sizeof(config));</span><br><span class="line">            <span class="keyword">if</span> (temp == OK) &#123;</span><br><span class="line">                <span class="function"><span class="title">outputFormat</span>-&gt;</span>setInt32(<span class="string">&quot;auto-frc&quot;</span>, enabled);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (enabled) &#123;</span><br><span class="line">                ALOGI(<span class="string">&quot;codec does not support requested auto-frc (err %d)&quot;</span>, temp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// END of temporary support for automatic FRC</span></span><br><span class="line"></span><br><span class="line">        int32_t tunneled;</span><br><span class="line">        <span class="function"><span class="title">if</span> (msg-&gt;</span>findInt32(<span class="string">&quot;feature-tunneled-playback&quot;</span>, &amp;tunneled) &amp;&amp;</span><br><span class="line">            tunneled != <span class="number">0</span>) &#123;</span><br><span class="line">            ALOGI(<span class="string">&quot;Configuring TUNNELED video playback.&quot;</span>);</span><br><span class="line">            mTunneled = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            int32_t audioHwSync = <span class="number">0</span>;</span><br><span class="line">            <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;audio-hw-sync&quot;</span>, &amp;audioHwSync)) &#123;</span><br><span class="line">                ALOGW(<span class="string">&quot;No Audio HW Sync provided for video tunnel&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            err = configureTunneledVideoPlayback(audioHwSync, nativeWindow);</span><br><span class="line">            <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">                ALOGE(<span class="string">&quot;configureTunneledVideoPlayback(%d,%p) failed!&quot;</span>,</span><br><span class="line">                        audioHwSync, nativeWindow.get());</span><br><span class="line">                return err;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            int32_t maxWidth = <span class="number">0</span>, maxHeight = <span class="number">0</span>;</span><br><span class="line">            <span class="function"><span class="title">if</span> (msg-&gt;</span>findInt32(<span class="string">&quot;max-width&quot;</span>, &amp;maxWidth) &amp;&amp;</span><br><span class="line">                    <span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;max-height&quot;</span>, &amp;maxHeight)) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="function"><span class="title">err</span> = mOMX-&gt;</span>prepareForAdaptivePlayback(</span><br><span class="line">                        mNode, kPortIndexOutput, OMX_TRUE, maxWidth, maxHeight);</span><br><span class="line">                <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">                    ALOGW(<span class="string">&quot;[%s] prepareForAdaptivePlayback failed w/ err %d&quot;</span>,</span><br><span class="line">                            mComponentName.c_str(), err);</span><br><span class="line">                    <span class="comment">// allow failure</span></span><br><span class="line">                    err = OK;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="function"><span class="title">inputFormat</span>-&gt;</span>setInt32(<span class="string">&quot;max-width&quot;</span>, maxWidth);</span><br><span class="line">                    <span class="function"><span class="title">inputFormat</span>-&gt;</span>setInt32(<span class="string">&quot;max-height&quot;</span>, maxHeight);</span><br><span class="line">                    <span class="function"><span class="title">inputFormat</span>-&gt;</span>setInt32(<span class="string">&quot;adaptive-playback&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ALOGV(<span class="string">&quot;Configuring CPU controlled video playback.&quot;</span>);</span><br><span class="line">            mTunneled = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Explicity reset the sideband handle of the window for</span></span><br><span class="line">            <span class="comment">// non-tunneled video in case the window was previously used</span></span><br><span class="line">            <span class="comment">// for a tunneled video playback.</span></span><br><span class="line">            err = native_window_set_sideband_stream(nativeWindow.get(), NULL);</span><br><span class="line">            <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">                ALOGE(<span class="string">&quot;set_sideband_stream(NULL) failed! (err %d).&quot;</span>, err);</span><br><span class="line">                return err;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Always try to enable dynamic output buffers on native surface</span></span><br><span class="line">            <span class="function"><span class="title">err</span> = mOMX-&gt;</span>storeMetaDataInBuffers(</span><br><span class="line">                    mNode, kPortIndexOutput, OMX_TRUE, &amp;mOutputMetadataType);</span><br><span class="line">            <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">                ALOGE(<span class="string">&quot;[%s] storeMetaDataInBuffers failed w/ err %d&quot;</span>,</span><br><span class="line">                        mComponentName.c_str(), err);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// if adaptive playback has been requested, try JB fallback</span></span><br><span class="line">                <span class="comment">// <span class="doctag">NOTE:</span> THIS FALLBACK MECHANISM WILL BE REMOVED DUE TO ITS</span></span><br><span class="line">                <span class="comment">// LARGE MEMORY REQUIREMENT</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// we will not do adaptive playback on software accessed</span></span><br><span class="line">                <span class="comment">// surfaces as they never had to respond to changes in the</span></span><br><span class="line">                <span class="comment">// crop window, and we don&#x27;t trust that they will be able to.</span></span><br><span class="line">                int usageBits = <span class="number">0</span>;</span><br><span class="line">                bool canDoAdaptivePlayback;</span><br><span class="line"></span><br><span class="line">                <span class="function"><span class="title">if</span> (nativeWindow-&gt;</span>query(</span><br><span class="line">                        nativeWindow.get(),</span><br><span class="line">                        NATIVE_WINDOW_CONSUMER_USAGE_BITS,</span><br><span class="line">                        &amp;usageBits) != OK) &#123;</span><br><span class="line">                    canDoAdaptivePlayback = <span class="literal">false</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    canDoAdaptivePlayback =</span><br><span class="line">                        (usageBits &amp;</span><br><span class="line">                                (GRALLOC_USAGE_SW_READ_MASK |</span><br><span class="line">                                 GRALLOC_USAGE_SW_WRITE_MASK)) == <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                int32_t maxWidth = <span class="number">0</span>, maxHeight = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (canDoAdaptivePlayback &amp;&amp;</span><br><span class="line">                        <span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;max-width&quot;</span>, &amp;maxWidth) &amp;&amp;</span><br><span class="line">                        <span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;max-height&quot;</span>, &amp;maxHeight)) &#123;</span><br><span class="line">                    ALOGV(<span class="string">&quot;[%s] prepareForAdaptivePlayback(%dx%d)&quot;</span>,</span><br><span class="line">                            mComponentName.c_str(), maxWidth, maxHeight);</span><br><span class="line"></span><br><span class="line">                    <span class="function"><span class="title">err</span> = mOMX-&gt;</span>prepareForAdaptivePlayback(</span><br><span class="line">                            mNode, kPortIndexOutput, OMX_TRUE, maxWidth,</span><br><span class="line">                            maxHeight);</span><br><span class="line">                    ALOGW_IF(err != OK,</span><br><span class="line">                            <span class="string">&quot;[%s] prepareForAdaptivePlayback failed w/ err %d&quot;</span>,</span><br><span class="line">                            mComponentName.c_str(), err);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (err == OK) &#123;</span><br><span class="line">                        <span class="function"><span class="title">inputFormat</span>-&gt;</span>setInt32(<span class="string">&quot;max-width&quot;</span>, maxWidth);</span><br><span class="line">                        <span class="function"><span class="title">inputFormat</span>-&gt;</span>setInt32(<span class="string">&quot;max-height&quot;</span>, maxHeight);</span><br><span class="line">                        <span class="function"><span class="title">inputFormat</span>-&gt;</span>setInt32(<span class="string">&quot;adaptive-playback&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// allow failure</span></span><br><span class="line">                err = OK;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ALOGV(<span class="string">&quot;[%s] storeMetaDataInBuffers succeeded&quot;</span>,</span><br><span class="line">                        mComponentName.c_str());</span><br><span class="line">                CHECK(storingMetadataInDecodedBuffers());</span><br><span class="line">                mLegacyAdaptiveExperiment = ADebug::isExperimentEnabled(</span><br><span class="line">                        <span class="string">&quot;legacy-adaptive&quot;</span>, !<span class="function"><span class="title">msg</span>-&gt;</span><span class="built_in">contains</span>(<span class="string">&quot;no-experiments&quot;</span>));</span><br><span class="line"></span><br><span class="line">                <span class="function"><span class="title">inputFormat</span>-&gt;</span>setInt32(<span class="string">&quot;adaptive-playback&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            int32_t push;</span><br><span class="line">            <span class="function"><span class="title">if</span> (msg-&gt;</span>findInt32(<span class="string">&quot;push-blank-buffers-on-shutdown&quot;</span>, &amp;push)</span><br><span class="line">                    &amp;&amp; push != <span class="number">0</span>) &#123;</span><br><span class="line">                mFlags |= kFlagPushBlankBuffersToNativeWindowOnShutdown;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        int32_t rotationDegrees;</span><br><span class="line">        <span class="function"><span class="title">if</span> (msg-&gt;</span>findInt32(<span class="string">&quot;rotation-degrees&quot;</span>, &amp;rotationDegrees)) &#123;</span><br><span class="line">            mRotationDegrees = rotationDegrees;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mRotationDegrees = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (video) &#123;</span><br><span class="line">        <span class="comment">// determine need for software renderer</span></span><br><span class="line">        bool usingSwRenderer = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (haveNativeWindow &amp;&amp; mComponentName.startsWith(<span class="string">&quot;OMX.google.&quot;</span>)) &#123;</span><br><span class="line">            usingSwRenderer = <span class="literal">true</span>;</span><br><span class="line">            haveNativeWindow = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (encoder) &#123;</span><br><span class="line">            err = setupVideoEncoder(mime, msg);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            err = setupVideoDecoder(mime, msg, haveNativeWindow);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">            return err;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (haveNativeWindow) &#123;</span><br><span class="line">            mNativeWindow = static_cast&lt;Surface *&gt;(obj.get());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// initialize native window now to get actual output format</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> this is needed for some encoders even though they don&#x27;t use native window</span></span><br><span class="line">        err = initNativeWindow();</span><br><span class="line">        <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">            return err;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// fallback for devices that do not handle flex-YUV for native buffers</span></span><br><span class="line">        <span class="keyword">if</span> (haveNativeWindow) &#123;</span><br><span class="line">            int32_t requestedColorFormat = OMX_COLOR_FormatUnused;</span><br><span class="line">            <span class="function"><span class="title">if</span> (msg-&gt;</span>findInt32(<span class="string">&quot;color-format&quot;</span>, &amp;requestedColorFormat) &amp;&amp;</span><br><span class="line">                    requestedColorFormat == OMX_COLOR_FormatYUV420Flexible) &#123;</span><br><span class="line">                status_t err = getPortFormat(kPortIndexOutput, outputFormat);</span><br><span class="line">                <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">                    return err;</span><br><span class="line">                &#125;</span><br><span class="line">                int32_t colorFormat = OMX_COLOR_FormatUnused;</span><br><span class="line">                OMX_U32 flexibleEquivalent = OMX_COLOR_FormatUnused;</span><br><span class="line">                <span class="function"><span class="title">if</span> (!outputFormat-&gt;</span>findInt32(<span class="string">&quot;color-format&quot;</span>, &amp;colorFormat)) &#123;</span><br><span class="line">                    ALOGE(<span class="string">&quot;ouptut port did not have a color format (wrong domain?)&quot;</span>);</span><br><span class="line">                    return BAD_VALUE;</span><br><span class="line">                &#125;</span><br><span class="line">                ALOGD(<span class="string">&quot;[%s] Requested output format %#x and got %#x.&quot;</span>,</span><br><span class="line">                        mComponentName.c_str(), requestedColorFormat, colorFormat);</span><br><span class="line">                <span class="keyword">if</span> (!isFlexibleColorFormat(</span><br><span class="line">                                mOMX, mNode, colorFormat, haveNativeWindow, &amp;flexibleEquivalent)</span><br><span class="line">                        || flexibleEquivalent != (OMX_U32)requestedColorFormat) &#123;</span><br><span class="line">                    <span class="comment">// device did not handle flex-YUV request for native window, fall back</span></span><br><span class="line">                    <span class="comment">// to SW renderer</span></span><br><span class="line">                    ALOGI(<span class="string">&quot;[%s] Falling back to software renderer&quot;</span>, mComponentName.c_str());</span><br><span class="line">                    mNativeWindow.clear();</span><br><span class="line">                    mNativeWindowUsageBits = <span class="number">0</span>;</span><br><span class="line">                    haveNativeWindow = <span class="literal">false</span>;</span><br><span class="line">                    usingSwRenderer = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">if</span> (storingMetadataInDecodedBuffers()) &#123;</span><br><span class="line">                        <span class="function"><span class="title">err</span> = mOMX-&gt;</span>storeMetaDataInBuffers(</span><br><span class="line">                                mNode, kPortIndexOutput, OMX_FALSE, &amp;mOutputMetadataType);</span><br><span class="line">                        mOutputMetadataType = kMetadataBufferTypeInvalid; <span class="comment">// just in case</span></span><br><span class="line">                        <span class="comment">// <span class="doctag">TODO:</span> implement adaptive-playback support for bytebuffer mode.</span></span><br><span class="line">                        <span class="comment">// This is done by SW codecs, but most HW codecs don&#x27;t support it.</span></span><br><span class="line">                        <span class="function"><span class="title">inputFormat</span>-&gt;</span>setInt32(<span class="string">&quot;adaptive-playback&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (err == OK) &#123;</span><br><span class="line">                        <span class="function"><span class="title">err</span> = mOMX-&gt;</span>enableGraphicBuffers(mNode, kPortIndexOutput, OMX_FALSE);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (mFlags &amp; kFlagIsGrallocUsageProtected) &#123;</span><br><span class="line">                        <span class="comment">// fallback is not supported for protected playback</span></span><br><span class="line">                        err = PERMISSION_DENIED;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (err == OK) &#123;</span><br><span class="line">                        err = setupVideoDecoder(mime, msg, <span class="literal">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (usingSwRenderer) &#123;</span><br><span class="line">            <span class="function"><span class="title">outputFormat</span>-&gt;</span>setInt32(<span class="string">&quot;using-sw-renderer&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(mime, MEDIA_MIMETYPE_AUDIO_MPEG)) &#123;</span><br><span class="line">        int32_t numChannels, sampleRate;</span><br><span class="line">        <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;channel-count&quot;</span>, &amp;numChannels)</span><br><span class="line">                || !<span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;sample-rate&quot;</span>, &amp;sampleRate)) &#123;</span><br><span class="line">            <span class="comment">// Since we did not always check for these, leave them optional</span></span><br><span class="line">            <span class="comment">// and have the decoder figure it all out.</span></span><br><span class="line">            err = OK;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            err = setupRawAudioFormat(</span><br><span class="line">                    encoder ? kPortIndexInput : kPortIndexOutput,</span><br><span class="line">                    sampleRate,</span><br><span class="line">                    numChannels);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(mime, MEDIA_MIMETYPE_AUDIO_AAC)) &#123;</span><br><span class="line">        int32_t numChannels, sampleRate;</span><br><span class="line">        <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;channel-count&quot;</span>, &amp;numChannels)</span><br><span class="line">                || !<span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;sample-rate&quot;</span>, &amp;sampleRate)) &#123;</span><br><span class="line">            err = INVALID_OPERATION;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            int32_t isADTS, aacProfile;</span><br><span class="line">            int32_t sbrMode;</span><br><span class="line">            int32_t maxOutputChannelCount;</span><br><span class="line">            int32_t pcmLimiterEnable;</span><br><span class="line">            drcParams_t drc;</span><br><span class="line">            <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;is-adts&quot;</span>, &amp;isADTS)) &#123;</span><br><span class="line">                isADTS = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;aac-profile&quot;</span>, &amp;aacProfile)) &#123;</span><br><span class="line">                aacProfile = OMX_AUDIO_AACObjectNull;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;aac-sbr-mode&quot;</span>, &amp;sbrMode)) &#123;</span><br><span class="line">                sbrMode = -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;aac-max-output-channel_count&quot;</span>, &amp;maxOutputChannelCount)) &#123;</span><br><span class="line">                maxOutputChannelCount = -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;aac-pcm-limiter-enable&quot;</span>, &amp;pcmLimiterEnable)) &#123;</span><br><span class="line">                <span class="comment">// value is unknown</span></span><br><span class="line">                pcmLimiterEnable = -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;aac-encoded-target-level&quot;</span>, &amp;drc.encodedTargetLevel)) &#123;</span><br><span class="line">                <span class="comment">// value is unknown</span></span><br><span class="line">                drc.encodedTargetLevel = -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;aac-drc-cut-level&quot;</span>, &amp;drc.drcCut)) &#123;</span><br><span class="line">                <span class="comment">// value is unknown</span></span><br><span class="line">                drc.drcCut = -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;aac-drc-boost-level&quot;</span>, &amp;drc.drcBoost)) &#123;</span><br><span class="line">                <span class="comment">// value is unknown</span></span><br><span class="line">                drc.drcBoost = -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;aac-drc-heavy-compression&quot;</span>, &amp;drc.heavyCompression)) &#123;</span><br><span class="line">                <span class="comment">// value is unknown</span></span><br><span class="line">                drc.heavyCompression = -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;aac-target-ref-level&quot;</span>, &amp;drc.targetRefLevel)) &#123;</span><br><span class="line">                <span class="comment">// value is unknown</span></span><br><span class="line">                drc.targetRefLevel = -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            err = setupAACCodec(</span><br><span class="line">                    encoder, numChannels, sampleRate, bitRate, aacProfile,</span><br><span class="line">                    isADTS != <span class="number">0</span>, sbrMode, maxOutputChannelCount, drc,</span><br><span class="line">                    pcmLimiterEnable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(mime, MEDIA_MIMETYPE_AUDIO_AMR_NB)) &#123;</span><br><span class="line">        err = setupAMRCodec(encoder, <span class="literal">false</span> <span class="comment">/* isWAMR */</span>, bitRate);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(mime, MEDIA_MIMETYPE_AUDIO_AMR_WB)) &#123;</span><br><span class="line">        err = setupAMRCodec(encoder, <span class="literal">true</span> <span class="comment">/* isWAMR */</span>, bitRate);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(mime, MEDIA_MIMETYPE_AUDIO_G711_ALAW)</span><br><span class="line">            || !strcasecmp(mime, MEDIA_MIMETYPE_AUDIO_G711_MLAW)) &#123;</span><br><span class="line">        <span class="comment">// These are PCM-like formats with a fixed sample rate but</span></span><br><span class="line">        <span class="comment">// a variable number of channels.</span></span><br><span class="line"></span><br><span class="line">        int32_t numChannels;</span><br><span class="line">        <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;channel-count&quot;</span>, &amp;numChannels)) &#123;</span><br><span class="line">            err = INVALID_OPERATION;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            int32_t sampleRate;</span><br><span class="line">            <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;sample-rate&quot;</span>, &amp;sampleRate)) &#123;</span><br><span class="line">                sampleRate = <span class="number">8000</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            err = setupG711Codec(encoder, sampleRate, numChannels);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(mime, MEDIA_MIMETYPE_AUDIO_FLAC)) &#123;</span><br><span class="line">        int32_t numChannels = <span class="number">0</span>, sampleRate = <span class="number">0</span>, compressionLevel = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (encoder &amp;&amp;</span><br><span class="line">                (!<span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;channel-count&quot;</span>, &amp;numChannels)</span><br><span class="line">                        || !<span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;sample-rate&quot;</span>, &amp;sampleRate))) &#123;</span><br><span class="line">            ALOGE(<span class="string">&quot;missing channel count or sample rate for FLAC encoder&quot;</span>);</span><br><span class="line">            err = INVALID_OPERATION;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (encoder) &#123;</span><br><span class="line">                <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(</span><br><span class="line">                            <span class="string">&quot;complexity&quot;</span>, &amp;compressionLevel) &amp;&amp;</span><br><span class="line">                    !<span class="function"><span class="title">msg</span>-&gt;</span>findInt32(</span><br><span class="line">                            <span class="string">&quot;flac-compression-level&quot;</span>, &amp;compressionLevel)) &#123;</span><br><span class="line">                    compressionLevel = <span class="number">5</span>; <span class="comment">// default FLAC compression level</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (compressionLevel &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    ALOGW(<span class="string">&quot;compression level %d outside [0..8] range, &quot;</span></span><br><span class="line">                          <span class="string">&quot;using 0&quot;</span>,</span><br><span class="line">                          compressionLevel);</span><br><span class="line">                    compressionLevel = <span class="number">0</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (compressionLevel &gt; <span class="number">8</span>) &#123;</span><br><span class="line">                    ALOGW(<span class="string">&quot;compression level %d outside [0..8] range, &quot;</span></span><br><span class="line">                          <span class="string">&quot;using 8&quot;</span>,</span><br><span class="line">                          compressionLevel);</span><br><span class="line">                    compressionLevel = <span class="number">8</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            err = setupFlacCodec(</span><br><span class="line">                    encoder, numChannels, sampleRate, compressionLevel);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(mime, MEDIA_MIMETYPE_AUDIO_RAW)) &#123;</span><br><span class="line">        int32_t numChannels, sampleRate;</span><br><span class="line">        <span class="keyword">if</span> (encoder</span><br><span class="line">                || !<span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;channel-count&quot;</span>, &amp;numChannels)</span><br><span class="line">                || !<span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;sample-rate&quot;</span>, &amp;sampleRate)) &#123;</span><br><span class="line">            err = INVALID_OPERATION;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            err = setupRawAudioFormat(kPortIndexInput, sampleRate, numChannels);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(mime, MEDIA_MIMETYPE_AUDIO_AC3)) &#123;</span><br><span class="line">        int32_t numChannels;</span><br><span class="line">        int32_t sampleRate;</span><br><span class="line">        <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;channel-count&quot;</span>, &amp;numChannels)</span><br><span class="line">                || !<span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;sample-rate&quot;</span>, &amp;sampleRate)) &#123;</span><br><span class="line">            err = INVALID_OPERATION;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            err = setupAC3Codec(encoder, numChannels, sampleRate);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(mime, MEDIA_MIMETYPE_AUDIO_EAC3)) &#123;</span><br><span class="line">        int32_t numChannels;</span><br><span class="line">        int32_t sampleRate;</span><br><span class="line">        <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;channel-count&quot;</span>, &amp;numChannels)</span><br><span class="line">                || !<span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;sample-rate&quot;</span>, &amp;sampleRate)) &#123;</span><br><span class="line">            err = INVALID_OPERATION;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            err = setupEAC3Codec(encoder, numChannels, sampleRate);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">        return err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;encoder-delay&quot;</span>, &amp;mEncoderDelay)) &#123;</span><br><span class="line">        mEncoderDelay = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">if</span> (!msg-&gt;</span>findInt32(<span class="string">&quot;encoder-padding&quot;</span>, &amp;mEncoderPadding)) &#123;</span><br><span class="line">        mEncoderPadding = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">if</span> (msg-&gt;</span>findInt32(<span class="string">&quot;channel-mask&quot;</span>, &amp;mChannelMask)) &#123;</span><br><span class="line">        mChannelMaskPresent = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mChannelMaskPresent = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    int32_t maxInputSize;</span><br><span class="line">    <span class="function"><span class="title">if</span> (msg-&gt;</span>findInt32(<span class="string">&quot;max-input-size&quot;</span>, &amp;maxInputSize)) &#123;</span><br><span class="line">        err = setMinBufferSize(kPortIndexInput, (size_t)maxInputSize);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcmp(<span class="string">&quot;OMX.Nvidia.aac.decoder&quot;</span>, mComponentName.c_str())) &#123;</span><br><span class="line">        err = setMinBufferSize(kPortIndexInput, <span class="number">8192</span>);  <span class="comment">// XXX</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    int32_t priority;</span><br><span class="line">    <span class="function"><span class="title">if</span> (msg-&gt;</span>findInt32(<span class="string">&quot;priority&quot;</span>, &amp;priority)) &#123;</span><br><span class="line">        err = setPriority(priority);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    int32_t rateInt = -<span class="number">1</span>;</span><br><span class="line">    float rateFloat = -<span class="number">1</span>;</span><br><span class="line">    <span class="function"><span class="title">if</span> (!msg-&gt;</span>findFloat(<span class="string">&quot;operating-rate&quot;</span>, &amp;rateFloat)) &#123;</span><br><span class="line">        <span class="function"><span class="title">msg</span>-&gt;</span>findInt32(<span class="string">&quot;operating-rate&quot;</span>, &amp;rateInt);</span><br><span class="line">        rateFloat = (float)rateInt;  <span class="comment">// 16MHz (FLINTMAX) is OK for upper bound.</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (rateFloat &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        err = setOperatingRate(rateFloat, video);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mBaseOutputFormat = outputFormat;</span><br><span class="line"></span><br><span class="line">    err = getPortFormat(kPortIndexInput, inputFormat);</span><br><span class="line">    <span class="keyword">if</span> (err == OK) &#123;</span><br><span class="line">        err = getPortFormat(kPortIndexOutput, outputFormat);</span><br><span class="line">        <span class="keyword">if</span> (err == OK) &#123;</span><br><span class="line">            mInputFormat = inputFormat;</span><br><span class="line">            mOutputFormat = outputFormat;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>到了这里整个解码器的初始化和配置已经结束了，我们看下解码器的start阶段：</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">status_t MediaCodec::start<span class="literal">()</span> &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> <span class="constructor">AMessage(<span class="params">kWhatStart</span>, <span class="params">this</span>)</span>;</span><br><span class="line"></span><br><span class="line">    status_t err;</span><br><span class="line">    Vector&lt;MediaResource&gt; resources;</span><br><span class="line">    const <span class="built_in">char</span> *<span class="keyword">type</span> = (mFlags &amp; kFlagIsSecure) ?</span><br><span class="line">            kResourceSecureCodec : kResourceNonSecureCodec;</span><br><span class="line">    const <span class="built_in">char</span> *subtype = mIsVideo ? kResourceVideoCodec : kResourceAudioCodec;</span><br><span class="line">    resources.push<span class="constructor">_back(MediaResource(String8(<span class="params">type</span>)</span>, <span class="constructor">String8(<span class="params">subtype</span>)</span>, <span class="number">1</span>));</span><br><span class="line">    <span class="comment">// Don&#x27;t know the buffer size at this point, but it&#x27;s fine to use 1 because</span></span><br><span class="line">    <span class="comment">// the reclaimResource call doesn&#x27;t consider the requester&#x27;s buffer size for now.</span></span><br><span class="line">    resources.push<span class="constructor">_back(MediaResource(String8(<span class="params">kResourceGraphicMemory</span>)</span>, <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt;= kMaxRetry; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Don&#x27;t try to reclaim resource for the first time.</span></span><br><span class="line">            <span class="keyword">if</span> (!mResourceManagerService-&gt;reclaim<span class="constructor">Resource(<span class="params">resources</span>)</span>) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Recover codec from previous error before retry start.</span></span><br><span class="line">            err = reset<span class="literal">()</span>;</span><br><span class="line">            <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">                <span class="constructor">ALOGE(<span class="string">&quot;retrying start: failed to reset codec&quot;</span>)</span>;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            sp&lt;AMessage&gt; response;</span><br><span class="line">            err = <span class="constructor">PostAndAwaitResponse(<span class="params">mConfigureMsg</span>, &amp;<span class="params">response</span>)</span>;</span><br><span class="line">            <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">                <span class="constructor">ALOGE(<span class="string">&quot;retrying start: failed to configure codec&quot;</span>)</span>;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        sp&lt;AMessage&gt; response;</span><br><span class="line">        err = <span class="constructor">PostAndAwaitResponse(<span class="params">msg</span>, &amp;<span class="params">response</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (!is<span class="constructor">ResourceError(<span class="params">err</span>)</span>) &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">case kWhatStart:</span><br><span class="line">&#123;</span><br><span class="line">    sp&lt;AReplyToken&gt; replyID;</span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">senderAwaitsResponse</span>(&amp;<span class="params">replyID</span>)</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mState<span class="operator"> == </span>FLUSHED) &#123;</span><br><span class="line">        set<span class="constructor">State(STARTED)</span>;</span><br><span class="line">        <span class="keyword">if</span> (mHavePendingInputBuffers) &#123;</span><br><span class="line">            on<span class="constructor">InputBufferAvailable()</span>;</span><br><span class="line">            mHavePendingInputBuffers = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//我们重点看这里</span></span><br><span class="line">        mCodec-&gt;signal<span class="constructor">Resume()</span>;</span><br><span class="line">        <span class="comment">//..................</span></span><br><span class="line">        <span class="constructor">PostReplyWithError(<span class="params">replyID</span>, OK)</span>;</span><br><span class="line">        break;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mState != CONFIGURED) &#123;</span><br><span class="line">        <span class="constructor">PostReplyWithError(<span class="params">replyID</span>, INVALID_OPERATION)</span>;</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mReplyID = replyID;</span><br><span class="line">    set<span class="constructor">State(STARTING)</span>;</span><br><span class="line"></span><br><span class="line">    mCodec-&gt;initiate<span class="constructor">Start()</span>;</span><br><span class="line">    break;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先調用initiateStart初始化解码器状态</p>
<figure class="highlight livescript"><table><tr><td class="code"><pre><span class="line"><span class="literal">void</span> ACodec::initiateStart() &#123;</span><br><span class="line">    <span class="function"><span class="params">(<span class="keyword">new</span> AMessage(kWhatStart, this))</span>-&gt;</span>post();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> ACodec::kWhatStart:</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">onStart</span>();</span><br><span class="line">    handled = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line">void ACodec::LoadedState::onStart() &#123;</span><br><span class="line">    ALOGV(<span class="string">&quot;onStart&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">status_t</span> err = mCodec-&gt;</span><span class="function"><span class="title">mOMX</span>-&gt;</span><span class="function"><span class="title">sendCommand</span>(mCodec-&gt;</span>mNode, OMX_CommandStateSet, OMX_StateIdle);</span><br><span class="line">    <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">        <span class="function"><span class="title">mCodec</span>-&gt;</span>signalError(OMX_ErrorUndefined, makeNoSideEffectStatus(err));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="function"><span class="title">mCodec</span>-&gt;</span><span class="function"><span class="title">changeState</span>(mCodec-&gt;</span>mLoadedToIdleState);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着开始获取数据进行解码</p>
<figure class="highlight livescript"><table><tr><td class="code"><pre><span class="line"><span class="literal">void</span> ACodec::signalResume() &#123;</span><br><span class="line">    <span class="function"><span class="params">(<span class="keyword">new</span> AMessage(kWhatResume, this))</span>-&gt;</span>post();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight actionscript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> kWhatResume:</span><br><span class="line">&#123;</span><br><span class="line">    resume();</span><br><span class="line">    handled = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line">void ACodec::ExecutingState::resume() &#123;</span><br><span class="line"></span><br><span class="line">    submitOutputBuffers();</span><br><span class="line">    <span class="comment">// Post all available input buffers</span></span><br><span class="line">    <span class="function"><span class="title">if</span> (mCodec-&gt;</span>mBuffers[kPortIndexInput].size() == <span class="number">0</span>u) &#123;</span><br><span class="line">        ALOGW(<span class="string">&quot;[%s] we don&#x27;t have any input buffers to resume&quot;</span>, <span class="function"><span class="title">mCodec</span>-&gt;</span>mComponentName.c_str());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">for</span> (size_t i = 0; i &lt; mCodec-&gt;</span>mBuffers[kPortIndexInput].size(); i++) &#123;</span><br><span class="line">        B<span class="function"><span class="title">ufferInfo</span> *info = &amp;mCodec-&gt;</span>mBuffers[kPortIndexInput].editItemAt(i);</span><br><span class="line">        <span class="function"><span class="title">if</span> (info-&gt;</span>mStatus == BufferInfo::OWNED_BY_US) &#123;</span><br><span class="line">            postFillThisBuffer(info);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mActive = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line">void ACodec::BaseState::postFillThisBuffer(BufferInfo *info) &#123;</span><br><span class="line">    <span class="function"><span class="title">if</span> (mCodec-&gt;</span>mPortEOS[kPortIndexInput]) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CHECK_EQ((<span class="function"><span class="title">int</span>)info-&gt;</span>mStatus, (int)BufferInfo::OWNED_BY_US);</span><br><span class="line">    <span class="function"><span class="title">sp</span>&lt;AMessage&gt; notify = mCodec-&gt;</span><span class="function"><span class="title">mNotify</span>-&gt;</span>dup();</span><br><span class="line">    <span class="function"><span class="title">notify</span>-&gt;</span>setInt32(<span class="string">&quot;what&quot;</span>, CodecBase::kWhatFillThisBuffer);</span><br><span class="line">    <span class="function"><span class="title">notify</span>-&gt;</span><span class="function"><span class="title">setInt32</span>(&quot;buffer-id&quot;, info-&gt;</span>mBufferID);</span><br><span class="line">    <span class="function"><span class="title">info</span>-&gt;</span><span class="function"><span class="title">mData</span>-&gt;</span><span class="function"><span class="title">meta</span>()-&gt;</span>clear();</span><br><span class="line">    <span class="function"><span class="title">notify</span>-&gt;</span><span class="function"><span class="title">setBuffer</span>(&quot;buffer&quot;, info-&gt;</span>mData);</span><br><span class="line">    sp&lt;AMessage&gt; reply = new AMessage(kWhatInputBufferFilled, mCodec);</span><br><span class="line">    <span class="function"><span class="title">reply</span>-&gt;</span><span class="function"><span class="title">setInt32</span>(&quot;buffer-id&quot;, info-&gt;</span>mBufferID);</span><br><span class="line">    <span class="function"><span class="title">notify</span>-&gt;</span>setMessage(<span class="string">&quot;reply&quot;</span>, reply);</span><br><span class="line">    <span class="function"><span class="title">notify</span>-&gt;</span>post();</span><br><span class="line">    <span class="function"><span class="title">info</span>-&gt;</span>mStatus = BufferInfo::OWNED_BY_UPSTREAM;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">case CodecBase::kWhatFillThisBuffer:</span><br><span class="line">&#123;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">//..........</span></span><br><span class="line">    <span class="keyword">if</span> (mFlags &amp; kFlagIsAsync) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mHaveInputSurface) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mState<span class="operator"> == </span>FLUSHED) &#123;</span><br><span class="line">                mHavePendingInputBuffers = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                on<span class="constructor">InputBufferAvailable()</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mFlags &amp; kFlagDequeueInputPending) &#123;</span><br><span class="line">        <span class="constructor">CHECK(<span class="params">handleDequeueInputBuffer</span>(<span class="params">mDequeueInputReplyID</span>)</span>);</span><br><span class="line">        ++mDequeueInputTimeoutGeneration;</span><br><span class="line">        mFlags &amp;= ~kFlagDequeueInputPending;</span><br><span class="line">        mDequeueInputReplyID = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        post<span class="constructor">ActivityNotificationIfPossible()</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    break;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line">void MediaCodec::onInputBufferAvailable() &#123;</span><br><span class="line">    int32_t index;</span><br><span class="line">    <span class="keyword">while</span> ((index = dequeuePortBuffer(kPortIndexInput)) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="function"><span class="title">sp</span>&lt;AMessage&gt; msg = mCallback-&gt;</span>dup();</span><br><span class="line">        <span class="function"><span class="title">msg</span>-&gt;</span>setInt32(<span class="string">&quot;callbackID&quot;</span>, CB_INPUT_AVAILABLE);</span><br><span class="line">        <span class="function"><span class="title">msg</span>-&gt;</span>setInt32(<span class="string">&quot;index&quot;</span>, index);</span><br><span class="line">        <span class="function"><span class="title">msg</span>-&gt;</span>post();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还记得这个mCallback怎么来的吗？</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void NuPlayer::Decoder::on<span class="constructor">Configure(<span class="params">const</span> <span class="params">sp</span>&lt;AMessage&gt; &amp;<span class="params">format</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//.................</span></span><br><span class="line">    sp&lt;AMessage&gt; reply = <span class="keyword">new</span> <span class="constructor">AMessage(<span class="params">kWhatCodecNotify</span>, <span class="params">this</span>)</span>;</span><br><span class="line">    mCodec-&gt;set<span class="constructor">Callback(<span class="params">reply</span>)</span>;</span><br><span class="line">	<span class="comment">//..................</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">status_t MediaCodec::set<span class="constructor">Callback(<span class="params">const</span> <span class="params">sp</span>&lt;AMessage&gt; &amp;<span class="params">callback</span>)</span> &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> <span class="constructor">AMessage(<span class="params">kWhatSetCallback</span>, <span class="params">this</span>)</span>;</span><br><span class="line">    msg-&gt;set<span class="constructor">Message(<span class="string">&quot;callback&quot;</span>, <span class="params">callback</span>)</span>;</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; response;</span><br><span class="line">    return <span class="constructor">PostAndAwaitResponse(<span class="params">msg</span>, &amp;<span class="params">response</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">case kWhatSetCallback:</span><br><span class="line">&#123;</span><br><span class="line">    sp&lt;AReplyToken&gt; replyID;</span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">senderAwaitsResponse</span>(&amp;<span class="params">replyID</span>)</span>);</span><br><span class="line">    sp&lt;AMessage&gt; callback;</span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">findMessage</span>(<span class="string">&quot;callback&quot;</span>, &amp;<span class="params">callback</span>)</span>);</span><br><span class="line"></span><br><span class="line">    mCallback = callback;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mCallback != NULL) &#123;</span><br><span class="line">        mFlags <span class="pattern-match">|= k<span class="constructor">FlagIsAsync</span>;</span></span><br><span class="line"><span class="pattern-match">    &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="pattern-match">        m<span class="constructor">Flags</span> &amp;= ~k<span class="constructor">FlagIsAsync</span>;</span></span><br><span class="line"><span class="pattern-match">    &#125;</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">    sp&lt;<span class="constructor">AMessage</span>&gt; response = <span class="keyword">new</span> <span class="constructor">AMessage</span>;</span></span><br><span class="line"><span class="pattern-match">    response-&gt;post<span class="constructor">Reply(<span class="params">replyID</span>)</span>;</span></span><br><span class="line"><span class="pattern-match">    break;</span></span><br><span class="line"><span class="pattern-match">&#125;</span></span><br></pre></td></tr></table></figure>
<p>所以根据上面我们可以知道接下来i调用的是kWhatCodecNotify 下的 CB_INPUT_AVAILABLE</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">case MediaCodec::CB_INPUT_AVAILABLE:</span><br><span class="line">&#123;</span><br><span class="line">    int32_t index;</span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">findInt32</span>(<span class="string">&quot;index&quot;</span>, &amp;<span class="params">index</span>)</span>);</span><br><span class="line"></span><br><span class="line">    handle<span class="constructor">AnInputBuffer(<span class="params">index</span>)</span>;</span><br><span class="line">    break;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="built_in">bool</span> NuPlayer::Decoder::handle<span class="constructor">AnInputBuffer(<span class="params">size_t</span> <span class="params">index</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (is<span class="constructor">DiscontinuityPending()</span>) &#123;</span><br><span class="line">        return <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;ABuffer&gt; buffer;</span><br><span class="line">    mCodec-&gt;get<span class="constructor">InputBuffer(<span class="params">index</span>, &amp;<span class="params">buffer</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (buffer<span class="operator"> == </span>NULL) &#123;</span><br><span class="line">        handle<span class="constructor">Error(UNKNOWN_ERROR)</span>;</span><br><span class="line">        return <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index &gt;= mInputBuffers.size<span class="literal">()</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (size_t i = mInputBuffers.size<span class="literal">()</span>; i &lt;= index; ++i) &#123;</span><br><span class="line">            mInputBuffers.add<span class="literal">()</span>;</span><br><span class="line">            mMediaBuffers.add<span class="literal">()</span>;</span><br><span class="line">            mInputBufferIsDequeued.add<span class="literal">()</span>;</span><br><span class="line">            mMediaBuffers.edit<span class="constructor">ItemAt(<span class="params">i</span>)</span> = NULL;</span><br><span class="line">            mInputBufferIsDequeued.edit<span class="constructor">ItemAt(<span class="params">i</span>)</span> = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mInputBuffers.edit<span class="constructor">ItemAt(<span class="params">index</span>)</span> = buffer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//CHECK_LT(bufferIx, mInputBuffers.size());</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mMediaBuffers<span class="literal">[<span class="identifier">index</span>]</span> != NULL) &#123;</span><br><span class="line">        mMediaBuffers<span class="literal">[<span class="identifier">index</span>]</span>-&gt;release<span class="literal">()</span>;</span><br><span class="line">        mMediaBuffers.edit<span class="constructor">ItemAt(<span class="params">index</span>)</span> = NULL;</span><br><span class="line">    &#125;</span><br><span class="line">    mInputBufferIsDequeued.edit<span class="constructor">ItemAt(<span class="params">index</span>)</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mCSDsToSubmit.is<span class="constructor">Empty()</span>) &#123;</span><br><span class="line">        sp&lt;AMessage&gt; msg = <span class="keyword">new</span> <span class="constructor">AMessage()</span>;</span><br><span class="line">        msg-&gt;set<span class="constructor">Size(<span class="string">&quot;buffer-ix&quot;</span>, <span class="params">index</span>)</span>;</span><br><span class="line"></span><br><span class="line">        sp&lt;ABuffer&gt; buffer = mCSDsToSubmit.item<span class="constructor">At(0)</span>;</span><br><span class="line">        <span class="constructor">ALOGI(<span class="string">&quot;[%s] resubmitting CSD&quot;</span>, <span class="params">mComponentName</span>.<span class="params">c_str</span>()</span>);</span><br><span class="line">        msg-&gt;set<span class="constructor">Buffer(<span class="string">&quot;buffer&quot;</span>, <span class="params">buffer</span>)</span>;</span><br><span class="line">        mCSDsToSubmit.remove<span class="constructor">At(0)</span>;</span><br><span class="line">        <span class="constructor">CHECK(<span class="params">onInputBufferFetched</span>(<span class="params">msg</span>)</span>);</span><br><span class="line">        return <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!mPendingInputMessages.empty<span class="literal">()</span>) &#123;</span><br><span class="line">        sp&lt;AMessage&gt; msg = *mPendingInputMessages.<span class="keyword">begin</span><span class="literal">()</span>;</span><br><span class="line">        <span class="keyword">if</span> (!on<span class="constructor">InputBufferFetched(<span class="params">msg</span>)</span>) &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        mPendingInputMessages.erase(mPendingInputMessages.<span class="keyword">begin</span><span class="literal">()</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mInputBufferIsDequeued.edit<span class="constructor">ItemAt(<span class="params">index</span>)</span>) &#123;</span><br><span class="line">        return <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mDequeuedInputBuffers.push<span class="constructor">_back(<span class="params">index</span>)</span>;</span><br><span class="line"></span><br><span class="line">    on<span class="constructor">RequestInputBuffers()</span>;</span><br><span class="line">    return <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void NuPlayer::DecoderBase::on<span class="constructor">RequestInputBuffers()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mRequestInputBuffersPending) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// doRequestBuffers() return true if we should request more data</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">do</span><span class="constructor">RequestBuffers()</span>) &#123;</span><br><span class="line">        mRequestInputBuffersPending = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        sp&lt;AMessage&gt; msg = <span class="keyword">new</span> <span class="constructor">AMessage(<span class="params">kWhatRequestInputBuffers</span>, <span class="params">this</span>)</span>;</span><br><span class="line">        msg-&gt;post(<span class="number">10</span><span class="operator"> * </span><span class="number">1000l</span>l);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="built_in">bool</span> NuPlayer::Decoder::<span class="keyword">do</span><span class="constructor">RequestBuffers()</span> &#123;</span><br><span class="line">    <span class="comment">// mRenderer is only NULL if we have a legacy widevine source that</span></span><br><span class="line">    <span class="comment">// is not yet ready. In this case we must not fetch input.</span></span><br><span class="line">    <span class="keyword">if</span> (is<span class="constructor">DiscontinuityPending()</span><span class="operator"> || </span>mRenderer<span class="operator"> == </span>NULL) &#123;</span><br><span class="line">        return <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    status_t err = OK;</span><br><span class="line">    <span class="keyword">while</span> (err<span class="operator"> == </span>OK<span class="operator"> &amp;&amp; </span>!mDequeuedInputBuffers.empty<span class="literal">()</span>) &#123;</span><br><span class="line">        size_t bufferIx = *mDequeuedInputBuffers.<span class="keyword">begin</span><span class="literal">()</span>;</span><br><span class="line">        sp&lt;AMessage&gt; msg = <span class="keyword">new</span> <span class="constructor">AMessage()</span>;</span><br><span class="line">        msg-&gt;set<span class="constructor">Size(<span class="string">&quot;buffer-ix&quot;</span>, <span class="params">bufferIx</span>)</span>;</span><br><span class="line">        err = fetch<span class="constructor">InputData(<span class="params">msg</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (err != OK<span class="operator"> &amp;&amp; </span>err != ERROR_END_OF_STREAM) &#123;</span><br><span class="line">            <span class="comment">// if EOS, need to queue EOS buffer</span></span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        mDequeuedInputBuffers.erase(mDequeuedInputBuffers.<span class="keyword">begin</span><span class="literal">()</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!mPendingInputMessages.empty<span class="literal">()</span><span class="operator"></span></span><br><span class="line"><span class="operator">                || </span>!on<span class="constructor">InputBufferFetched(<span class="params">msg</span>)</span>) &#123;</span><br><span class="line">            mPendingInputMessages.push<span class="constructor">_back(<span class="params">msg</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return err<span class="operator"> == </span>-EWOULDBLOCK<span class="operator"></span></span><br><span class="line"><span class="operator">            &amp;&amp; </span>mSource-&gt;feed<span class="constructor">MoreTSData()</span><span class="operator"> == </span>OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line">status_t NuPlayer::Decoder::<span class="title function_ invoke__">fetchInputData</span>(sp&lt;AMessage&gt; &amp;reply) &#123;</span><br><span class="line">    sp&lt;ABuffer&gt; accessUnit;</span><br><span class="line">    <span class="type">bool</span> dropAccessUnit;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        status_t err = mSource<span class="punctuation">-&gt;</span><span class="title function_ invoke__">dequeueAccessUnit</span>(mIsAudio, &amp;accessUnit);</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">if</span> (err == -EWOULDBLOCK) &#123;</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="title function_ invoke__">if</span> (err != OK) &#123;</span><br><span class="line">            <span class="title function_ invoke__">if</span> (err == INFO_DISCONTINUITY) &#123;</span><br><span class="line">                int32_t <span class="keyword">type</span>;</span><br><span class="line">                <span class="title function_ invoke__">CHECK</span>(accessUnit<span class="punctuation">-&gt;</span><span class="title function_ invoke__">meta</span>()<span class="punctuation">-&gt;</span><span class="title function_ invoke__">findInt32</span>(<span class="string">&quot;discontinuity&quot;</span>, &amp;<span class="keyword">type</span>));</span><br><span class="line"></span><br><span class="line">                <span class="type">bool</span> formatChange =</span><br><span class="line">                    (mIsAudio &amp;&amp;</span><br><span class="line">                     (<span class="keyword">type</span> &amp; ATSParser::DISCONTINUITY_AUDIO_FORMAT))</span><br><span class="line">                    || (!mIsAudio &amp;&amp;</span><br><span class="line">                            (<span class="keyword">type</span> &amp; ATSParser::DISCONTINUITY_VIDEO_FORMAT));</span><br><span class="line"></span><br><span class="line">                <span class="type">bool</span> timeChange = (<span class="keyword">type</span> &amp; ATSParser::DISCONTINUITY_TIME) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                <span class="title function_ invoke__">ALOGI</span>(<span class="string">&quot;%s discontinuity (format=%d, time=%d)&quot;</span>,</span><br><span class="line">                        mIsAudio ? <span class="string">&quot;audio&quot;</span> : <span class="string">&quot;video&quot;</span>, formatChange, timeChange);</span><br><span class="line"></span><br><span class="line">                <span class="type">bool</span> seamlessFormatChange = <span class="literal">false</span>;</span><br><span class="line">                sp&lt;AMessage&gt; newFormat = mSource<span class="punctuation">-&gt;</span><span class="title function_ invoke__">getFormat</span>(mIsAudio);</span><br><span class="line">                <span class="title function_ invoke__">if</span> (formatChange) &#123;</span><br><span class="line">                    seamlessFormatChange =</span><br><span class="line">                        <span class="title function_ invoke__">supportsSeamlessFormatChange</span>(newFormat);</span><br><span class="line">                    <span class="comment">// treat seamless format change separately</span></span><br><span class="line">                    formatChange = !seamlessFormatChange;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// For format or time change, return EOS to queue EOS input,</span></span><br><span class="line">                <span class="comment">// then wait for EOS on output.</span></span><br><span class="line">                <span class="title function_ invoke__">if</span> (formatChange <span class="comment">/* not seamless */</span>) &#123;</span><br><span class="line">                    mFormatChangePending = <span class="literal">true</span>;</span><br><span class="line">                    err = ERROR_END_OF_STREAM;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="title function_ invoke__">if</span> (timeChange) &#123;</span><br><span class="line">                    <span class="title function_ invoke__">rememberCodecSpecificData</span>(newFormat);</span><br><span class="line">                    mTimeChangePending = <span class="literal">true</span>;</span><br><span class="line">                    err = ERROR_END_OF_STREAM;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="title function_ invoke__">if</span> (seamlessFormatChange) &#123;</span><br><span class="line">                    <span class="comment">// reuse existing decoder and don&#x27;t flush</span></span><br><span class="line">                    <span class="title function_ invoke__">rememberCodecSpecificData</span>(newFormat);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// This stream is unaffected by the discontinuity</span></span><br><span class="line">                    <span class="keyword">return</span> -EWOULDBLOCK;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// reply should only be returned without a buffer set</span></span><br><span class="line">            <span class="comment">// when there is an error (including EOS)</span></span><br><span class="line">            <span class="title function_ invoke__">CHECK</span>(err != OK);</span><br><span class="line"></span><br><span class="line">            reply<span class="punctuation">-&gt;</span><span class="title function_ invoke__">setInt32</span>(<span class="string">&quot;err&quot;</span>, err);</span><br><span class="line">            <span class="keyword">return</span> ERROR_END_OF_STREAM;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        dropAccessUnit = <span class="literal">false</span>;</span><br><span class="line">        <span class="title function_ invoke__">if</span> (!mIsAudio</span><br><span class="line">                &amp;&amp; !mIsSecure</span><br><span class="line">                &amp;&amp; mRenderer<span class="punctuation">-&gt;</span><span class="title function_ invoke__">getVideoLateByUs</span>() &gt; <span class="number">100000</span>ll</span><br><span class="line">                &amp;&amp; mIsVideoAVC</span><br><span class="line">                &amp;&amp; !<span class="title function_ invoke__">IsAVCReferenceFrame</span>(accessUnit)) &#123;</span><br><span class="line">            dropAccessUnit = <span class="literal">true</span>;</span><br><span class="line">            ++mNumInputFramesDropped;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="title function_ invoke__">while</span> (dropAccessUnit);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ALOGV(&quot;returned a valid buffer of %s data&quot;, mIsAudio ? &quot;mIsAudio&quot; : &quot;video&quot;);</span></span><br><span class="line">#<span class="keyword">if</span> <span class="number">0</span></span><br><span class="line">    int64_t mediaTimeUs;</span><br><span class="line">    <span class="title function_ invoke__">CHECK</span>(accessUnit<span class="punctuation">-&gt;</span><span class="title function_ invoke__">meta</span>()<span class="punctuation">-&gt;</span><span class="title function_ invoke__">findInt64</span>(<span class="string">&quot;timeUs&quot;</span>, &amp;mediaTimeUs));</span><br><span class="line">    <span class="title function_ invoke__">ALOGV</span>(<span class="string">&quot;[%s] feeding input buffer at media time %.3f&quot;</span>,</span><br><span class="line">         mIsAudio ? <span class="string">&quot;audio&quot;</span> : <span class="string">&quot;video&quot;</span>,</span><br><span class="line">         mediaTimeUs / <span class="number">1E6</span>);</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">if</span> (mCCDecoder != NULL) &#123;</span><br><span class="line">        mCCDecoder<span class="punctuation">-&gt;</span><span class="title function_ invoke__">decode</span>(accessUnit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    reply<span class="punctuation">-&gt;</span><span class="title function_ invoke__">setBuffer</span>(<span class="string">&quot;buffer&quot;</span>, accessUnit);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们接着看下如何获取索引列表,首先看下onChangeConfiguration3，在这部分代码很长，大家有兴趣可以看下这里面的代码，它的任务主要有如下几点</p>
<ol>
<li>判断audio及Video是否发送变化</li>
<li>根据当前的mFetcherInfos更新resumeMask</li>
<li>如果是有新的Fetcher那么需要新建FetcherInfo</li>
<li>启动对应的Fetcher</li>
<li>检查当前带宽根据带宽切换资源<br>但是最关键的代码在于fetcher-&gt;startAsync,<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">void LiveSession::<span class="built_in">onChangeConfiguration3</span>(const sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    //........</span><br><span class="line">    fetcher-&gt;startAsync(</span><br><span class="line">            sources<span class="selector-attr">[kAudioIndex]</span>,</span><br><span class="line">            sources<span class="selector-attr">[kVideoIndex]</span>,</span><br><span class="line">            sources<span class="selector-attr">[kSubtitleIndex]</span>,</span><br><span class="line">            getMetadataSource(sources, mNewStreamMask, switching),</span><br><span class="line">            startTime<span class="selector-class">.mTimeUs</span> &lt; <span class="number">0</span> ? mLastSeekTimeUs : startTime.mTimeUs,</span><br><span class="line">            startTime.<span class="built_in">getSegmentTimeUs</span>(),</span><br><span class="line">            startTime.mSeq,</span><br><span class="line">            seekMode);</span><br><span class="line">    //.......</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PlaylistFetcher::startAsync</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> sp&lt;AnotherPacketSource&gt; &amp;audioSource,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> sp&lt;AnotherPacketSource&gt; &amp;videoSource,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> sp&lt;AnotherPacketSource&gt; &amp;subtitleSource,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> sp&lt;AnotherPacketSource&gt; &amp;metadataSource,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">int64_t</span> startTimeUs,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">int64_t</span> segmentStartTimeUs,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">int32_t</span> startDiscontinuitySeq,</span></span></span><br><span class="line"><span class="params"><span class="function">        LiveSession::SeekMode seekMode)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> <span class="built_in">AMessage</span>(kWhatStart, <span class="keyword">this</span>);</span><br><span class="line">	<span class="comment">//.................</span></span><br><span class="line">    msg-&gt;<span class="built_in">post</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line">case kWhatStart:</span><br><span class="line">&#123;</span><br><span class="line">    status_t err = onStart(msg);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">sp</span>&lt;AMessage&gt; notify = mNotify-&gt;</span>dup();</span><br><span class="line">    <span class="function"><span class="title">notify</span>-&gt;</span>setInt32(<span class="string">&quot;what&quot;</span>, kWhatStarted);</span><br><span class="line">    <span class="function"><span class="title">notify</span>-&gt;</span>setInt32(<span class="string">&quot;err&quot;</span>, err);</span><br><span class="line">    <span class="function"><span class="title">notify</span>-&gt;</span>post();</span><br><span class="line">    break;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">status_t PlaylistFetcher::on<span class="constructor">Start(<span class="params">const</span> <span class="params">sp</span>&lt;AMessage&gt; &amp;<span class="params">msg</span>)</span> &#123;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">//..........</span></span><br><span class="line">    <span class="keyword">if</span> (streamTypeMask &amp; LiveSession::STREAMTYPE_AUDIO) &#123;</span><br><span class="line">        void *ptr;</span><br><span class="line">        <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">findPointer</span>(<span class="string">&quot;audioSource&quot;</span>, &amp;<span class="params">ptr</span>)</span>);</span><br><span class="line">        mPacketSources.add(LiveSession::STREAMTYPE_AUDIO,static_cast&lt;AnotherPacketSource *&gt;(ptr));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (streamTypeMask &amp; LiveSession::STREAMTYPE_VIDEO) &#123;</span><br><span class="line">        void *ptr;</span><br><span class="line">        <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">findPointer</span>(<span class="string">&quot;videoSource&quot;</span>, &amp;<span class="params">ptr</span>)</span>);</span><br><span class="line"></span><br><span class="line">        mPacketSources.add(LiveSession::STREAMTYPE_VIDEO,static_cast&lt;AnotherPacketSource *&gt;(ptr));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (streamTypeMask &amp; LiveSession::STREAMTYPE_SUBTITLES) &#123;</span><br><span class="line">        void *ptr;</span><br><span class="line">        <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">findPointer</span>(<span class="string">&quot;subtitleSource&quot;</span>, &amp;<span class="params">ptr</span>)</span>);</span><br><span class="line">        mPacketSources.add(LiveSession::STREAMTYPE_SUBTITLES,static_cast&lt;AnotherPacketSource *&gt;(ptr));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void *ptr;</span><br><span class="line">    <span class="comment">// metadataSource is not part of streamTypeMask</span></span><br><span class="line">    <span class="keyword">if</span> ((streamTypeMask &amp; (LiveSession::STREAMTYPE_AUDIO <span class="pattern-match">| <span class="constructor">LiveSession</span>::<span class="constructor">STREAMTYPE_VIDEO</span>))</span></span><br><span class="line"><span class="pattern-match">            <span class="operator">&amp;&amp;</span> msg-&gt;find<span class="constructor">Pointer(<span class="string">&quot;metadataSource&quot;</span>, &amp;<span class="params">ptr</span>)</span>) &#123;</span></span><br><span class="line"><span class="pattern-match">        m<span class="constructor">PacketSources</span>.add(<span class="constructor">LiveSession</span>::<span class="constructor">STREAMTYPE_METADATA</span>,static<span class="constructor">_cast</span>&lt;<span class="constructor">AnotherPacketSource</span> <span class="operator">*</span>&gt;(ptr));</span></span><br><span class="line"><span class="pattern-match">    &#125;</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">  	<span class="operator">/</span><span class="operator">/</span><span class="operator">...</span><span class="operator">...</span><span class="operator">...</span><span class="operator">...</span><span class="operator">...</span></span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">    post<span class="constructor">MonitorQueue()</span>;</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">    return <span class="constructor">OK</span>;</span></span><br><span class="line"><span class="pattern-match">&#125;</span></span><br><span class="line"><span class="pattern-match"></span></span><br></pre></td></tr></table></figure>

<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void PlaylistFetcher::post<span class="constructor">MonitorQueue(<span class="params">int64_t</span> <span class="params">delayUs</span>, <span class="params">int64_t</span> <span class="params">minDelayUs</span>)</span> &#123;</span><br><span class="line">    int64_t maxDelayUs = delay<span class="constructor">UsToRefreshPlaylist()</span>;</span><br><span class="line">    <span class="keyword">if</span> (maxDelayUs &lt; minDelayUs) &#123;</span><br><span class="line">        maxDelayUs = minDelayUs;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (delayUs &gt; maxDelayUs) &#123;</span><br><span class="line">        <span class="constructor">FLOGV(<span class="string">&quot;Need to refresh playlist in %lld&quot;</span>, (<span class="params">long</span> <span class="params">long</span>)</span>maxDelayUs);</span><br><span class="line">        delayUs = maxDelayUs;</span><br><span class="line">    &#125;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> <span class="constructor">AMessage(<span class="params">kWhatMonitorQueue</span>, <span class="params">this</span>)</span>;</span><br><span class="line">    msg-&gt;set<span class="constructor">Int32(<span class="string">&quot;generation&quot;</span>, <span class="params">mMonitorQueueGeneration</span>)</span>;</span><br><span class="line">    msg-&gt;post(delayUs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">case kWhatMonitorQueue:</span><br><span class="line">case kWhatDownloadNext:</span><br><span class="line">&#123;</span><br><span class="line">    int32_t generation;</span><br><span class="line">    <span class="constructor">CHECK(<span class="params">msg</span>-&gt;<span class="params">findInt32</span>(<span class="string">&quot;generation&quot;</span>, &amp;<span class="params">generation</span>)</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (generation != mMonitorQueueGeneration) &#123;</span><br><span class="line">        <span class="comment">// Stale event</span></span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (msg-&gt;what<span class="literal">()</span><span class="operator"> == </span>kWhatMonitorQueue) &#123;</span><br><span class="line">        on<span class="constructor">MonitorQueue()</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        on<span class="constructor">DownloadNext()</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    break;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PlaylistFetcher::onMonitorQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">//.......................</span></span><br><span class="line">    <span class="keyword">if</span> (finalResult == OK &amp;&amp; bufferedDurationUs &lt; kMinBufferedDurationUs) &#123;</span><br><span class="line">        <span class="built_in">FLOGV</span>(<span class="string">&quot;monitoring, buffered=%lld &lt; %lld&quot;</span>,</span><br><span class="line">                (<span class="type">long</span> <span class="type">long</span>)bufferedDurationUs, (<span class="type">long</span> <span class="type">long</span>)kMinBufferedDurationUs);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// delay the next download slightly; hopefully this gives other concurrent fetchers</span></span><br><span class="line">        <span class="comment">// a better chance to run.</span></span><br><span class="line">        <span class="comment">// onDownloadNext();</span></span><br><span class="line">        sp&lt;AMessage&gt; msg = <span class="keyword">new</span> <span class="built_in">AMessage</span>(kWhatDownloadNext, <span class="keyword">this</span>);</span><br><span class="line">        msg-&gt;<span class="built_in">setInt32</span>(<span class="string">&quot;generation&quot;</span>, mMonitorQueueGeneration);</span><br><span class="line">        msg-&gt;<span class="built_in">post</span>(<span class="number">1000l</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// We&#x27;d like to maintain buffering above durationToBufferUs, so try</span></span><br><span class="line">        <span class="comment">// again when buffer just about to go below durationToBufferUs</span></span><br><span class="line">        <span class="comment">// (or after targetDurationUs / 2, whichever is smaller).</span></span><br><span class="line">        <span class="type">int64_t</span> delayUs = bufferedDurationUs - kMinBufferedDurationUs + <span class="number">1000000ll</span>;</span><br><span class="line">        <span class="keyword">if</span> (delayUs &gt; targetDurationUs / <span class="number">2</span>) &#123;</span><br><span class="line">            delayUs = targetDurationUs / <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">FLOGV</span>(<span class="string">&quot;pausing for %lld, buffered=%lld &gt; %lld&quot;</span>,</span><br><span class="line">                (<span class="type">long</span> <span class="type">long</span>)delayUs,</span><br><span class="line">                (<span class="type">long</span> <span class="type">long</span>)bufferedDurationUs,</span><br><span class="line">                (<span class="type">long</span> <span class="type">long</span>)kMinBufferedDurationUs);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">postMonitorQueue</span>(delayUs);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>initDownloadState 用于在获取TS包之前获取对应的Uri</p>
<figure class="highlight zephir"><table><tr><td class="code"><pre><span class="line"><span class="keyword">bool</span> PlaylistFetcher::initDownloadState(</span><br><span class="line">        AString &amp;uri,</span><br><span class="line">        sp&lt;AMessage&gt; &amp;itemMeta,</span><br><span class="line">        int32_t &amp;firstSeqNumberInPlaylist,</span><br><span class="line">        int32_t &amp;lastSeqNumberInPlaylist) &#123;</span><br><span class="line">    status_t err = refreshPlaylist();</span><br><span class="line">    firstSeqNumberInPlaylist = <span class="number">0</span>;</span><br><span class="line">    lastSeqNumberInPlaylist = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">bool</span> discontinuity = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mPlaylist != NULL) &#123;</span><br><span class="line">        mPlaylist-&gt;getSeqNumberRange(</span><br><span class="line">                &amp;firstSeqNumberInPlaylist, &amp;lastSeqNumberInPlaylist);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mDiscontinuitySeq &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            mDiscontinuitySeq = mPlaylist-&gt;getDiscontinuitySeq();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mSegmentFirstPTS = <span class="number">-1</span>ll;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mPlaylist != NULL &amp;&amp; mSeqNumber &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        CHECK_GE(mStartTimeUs, <span class="number">0</span>ll);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mSegmentStartTimeUs &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mPlaylist-&gt;isComplete() &amp;&amp; !mPlaylist-&gt;isEvent()) &#123;</span><br><span class="line">                <span class="comment">// If this is a live session, start 3 segments from the end on connect</span></span><br><span class="line">                mSeqNumber = lastSeqNumberInPlaylist - <span class="number">3</span>;</span><br><span class="line">                <span class="keyword">if</span> (mSeqNumber &lt; firstSeqNumberInPlaylist) &#123;</span><br><span class="line">                    mSeqNumber = firstSeqNumberInPlaylist;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// When seeking mSegmentStartTimeUs is unavailable (&lt; 0), we</span></span><br><span class="line">                <span class="comment">// use mStartTimeUs (client supplied timestamp) to determine both start segment</span></span><br><span class="line">                <span class="comment">// and relative position inside a segment</span></span><br><span class="line">                mSeqNumber = getSeqNumberForTime(mStartTimeUs);</span><br><span class="line">                mStartTimeUs -= getSegmentStartTimeUs(mSeqNumber);</span><br><span class="line">            &#125;</span><br><span class="line">            mStartTimeUsRelative = <span class="keyword">true</span>;</span><br><span class="line">            FLOGV(<span class="string">&quot;Initial sequence number for time %lld is %d from (%d .. %d)&quot;</span>,</span><br><span class="line">                    (<span class="keyword">long</span> <span class="keyword">long</span>)mStartTimeUs, mSeqNumber, firstSeqNumberInPlaylist,</span><br><span class="line">                    lastSeqNumberInPlaylist);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// When adapting or track switching, mSegmentStartTimeUs (relative</span></span><br><span class="line">            <span class="comment">// to media time 0) is used to determine the start segment; mStartTimeUs (absolute</span></span><br><span class="line">            <span class="comment">// timestamps coming from the media container) is used to determine the position</span></span><br><span class="line">            <span class="comment">// inside a segments.</span></span><br><span class="line">            <span class="keyword">if</span> (mStreamTypeMask != LiveSession::STREAMTYPE_SUBTITLES</span><br><span class="line">                    &amp;&amp; mSeekMode != LiveSession::kSeekModeNextSample) &#123;</span><br><span class="line">                <span class="comment">// avoid double fetch/decode</span></span><br><span class="line">                <span class="comment">// Use (mSegmentStartTimeUs + 1/2 * targetDurationUs) to search</span></span><br><span class="line">                <span class="comment">// for the starting segment in new variant.</span></span><br><span class="line">                <span class="comment">// If the two variants&#x27; segments are aligned, this gives the</span></span><br><span class="line">                <span class="comment">// next segment. If they&#x27;re not aligned, this gives the segment</span></span><br><span class="line">                <span class="comment">// that overlaps no more than 1/2 * targetDurationUs.</span></span><br><span class="line">                mSeqNumber = getSeqNumberForTime(mSegmentStartTimeUs</span><br><span class="line">                        + mPlaylist-&gt;getTargetDuration() / <span class="number">2</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mSeqNumber = getSeqNumberForTime(mSegmentStartTimeUs);</span><br><span class="line">            &#125;</span><br><span class="line">            ssize_t minSeq = getSeqNumberForDiscontinuity(mDiscontinuitySeq);</span><br><span class="line">            <span class="keyword">if</span> (mSeqNumber &lt; minSeq) &#123;</span><br><span class="line">                mSeqNumber = minSeq;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mSeqNumber &lt; firstSeqNumberInPlaylist) &#123;</span><br><span class="line">                mSeqNumber = firstSeqNumberInPlaylist;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mSeqNumber &gt; lastSeqNumberInPlaylist) &#123;</span><br><span class="line">                mSeqNumber = lastSeqNumberInPlaylist;</span><br><span class="line">            &#125;</span><br><span class="line">            FLOGV(<span class="string">&quot;Initial sequence number is %d from (%d .. %d)&quot;</span>,</span><br><span class="line">                    mSeqNumber, firstSeqNumberInPlaylist,</span><br><span class="line">                    lastSeqNumberInPlaylist);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if mPlaylist is NULL then err must be non-OK; but the other way around might not be true</span></span><br><span class="line">    <span class="keyword">if</span> (mSeqNumber &lt; firstSeqNumberInPlaylist</span><br><span class="line">            || mSeqNumber &gt; lastSeqNumberInPlaylist</span><br><span class="line">            || err != OK) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err != OK || !mPlaylist-&gt;isComplete()) &amp;&amp; mNumRetries &lt; kMaxNumRetries) &#123;</span><br><span class="line">            ++mNumRetries;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mSeqNumber &gt; lastSeqNumberInPlaylist || err != OK) &#123;</span><br><span class="line">                <span class="comment">// make sure we reach this retry logic on refresh failures</span></span><br><span class="line">                <span class="comment">// by adding an err != OK clause to all enclosing if&#x27;s.</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// refresh in increasing fraction (1/2, 1/3, ...) of the</span></span><br><span class="line">                <span class="comment">// playlist&#x27;s target duration or 3 seconds, whichever is less</span></span><br><span class="line">                int64_t delayUs = kMaxMonitorDelayUs;</span><br><span class="line">                <span class="keyword">if</span> (mPlaylist != NULL) &#123;</span><br><span class="line">                    delayUs = mPlaylist-&gt;size() * mPlaylist-&gt;getTargetDuration()</span><br><span class="line">                            / (<span class="number">1</span> + mNumRetries);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (delayUs &gt; kMaxMonitorDelayUs) &#123;</span><br><span class="line">                    delayUs = kMaxMonitorDelayUs;</span><br><span class="line">                &#125;</span><br><span class="line">                FLOGV(<span class="string">&quot;sequence number high: %d from (%d .. %d), &quot;</span></span><br><span class="line">                      <span class="string">&quot;monitor in %lld (retry=%d)&quot;</span>,</span><br><span class="line">                        mSeqNumber, firstSeqNumberInPlaylist,</span><br><span class="line">                        lastSeqNumberInPlaylist, (<span class="keyword">long</span> <span class="keyword">long</span>)delayUs, mNumRetries);</span><br><span class="line">                postMonitorQueue(delayUs);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">                notifyError(err);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// we&#x27;ve missed the boat, let&#x27;s start 3 segments prior to the latest sequence</span></span><br><span class="line">            <span class="comment">// number available and signal a discontinuity.</span></span><br><span class="line"></span><br><span class="line">            ALOGI(<span class="string">&quot;We&#x27;ve missed the boat, restarting playback.&quot;</span></span><br><span class="line">                  <span class="string">&quot;  mStartup=%d, was  looking for %d in %d-%d&quot;</span>,</span><br><span class="line">                    mStartup, mSeqNumber, firstSeqNumberInPlaylist,</span><br><span class="line">                    lastSeqNumberInPlaylist);</span><br><span class="line">            <span class="keyword">if</span> (mStopParams != NULL) &#123;</span><br><span class="line">                <span class="comment">// we should have kept on fetching until we hit the boundaries in mStopParams,</span></span><br><span class="line">                <span class="comment">// but since the segments we are supposed to fetch have already rolled off</span></span><br><span class="line">                <span class="comment">// the playlist, i.e. we have already missed the boat, we inevitably have to</span></span><br><span class="line">                <span class="comment">// skip.</span></span><br><span class="line">                notifyStopReached();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            mSeqNumber = lastSeqNumberInPlaylist - <span class="number">3</span>;</span><br><span class="line">            <span class="keyword">if</span> (mSeqNumber &lt; firstSeqNumberInPlaylist) &#123;</span><br><span class="line">                mSeqNumber = firstSeqNumberInPlaylist;</span><br><span class="line">            &#125;</span><br><span class="line">            discontinuity = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// fall through</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (mPlaylist != NULL) &#123;</span><br><span class="line">                ALOGE(<span class="string">&quot;Cannot find sequence number %d in playlist &quot;</span></span><br><span class="line">                     <span class="string">&quot;(contains %d - %d)&quot;</span>,</span><br><span class="line">                     mSeqNumber, firstSeqNumberInPlaylist,</span><br><span class="line">                      firstSeqNumberInPlaylist + (int32_t)mPlaylist-&gt;size() - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (mTSParser != NULL) &#123;</span><br><span class="line">                    mTSParser-&gt;signalEOS(ERROR_END_OF_STREAM);</span><br><span class="line">                    <span class="comment">// Use an empty buffer; we don&#x27;t have any new data, just want to extract</span></span><br><span class="line">                    <span class="comment">// potential new access units after flush.  Reset mSeqNumber to</span></span><br><span class="line">                    <span class="comment">// lastSeqNumberInPlaylist such that we set the correct access unit</span></span><br><span class="line">                    <span class="comment">// properties in extractAndQueueAccessUnitsFromTs.</span></span><br><span class="line">                    sp&lt;ABuffer&gt; buffer = <span class="keyword">new</span> ABuffer(<span class="number">0</span>);</span><br><span class="line">                    mSeqNumber = lastSeqNumberInPlaylist;</span><br><span class="line">                    extractAndQueueAccessUnitsFromTs(buffer);</span><br><span class="line">                &#125;</span><br><span class="line">                notifyError(ERROR_END_OF_STREAM);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// It&#x27;s possible that we were never able to download the playlist.</span></span><br><span class="line">                <span class="comment">// In this case we should notify error, instead of EOS, as EOS during</span></span><br><span class="line">                <span class="comment">// prepare means we succeeded in downloading everything.</span></span><br><span class="line">                ALOGE(<span class="string">&quot;Failed to download playlist!&quot;</span>);</span><br><span class="line">                notifyError(ERROR_IO);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mNumRetries = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    CHECK(mPlaylist-&gt;itemAt(</span><br><span class="line">                mSeqNumber - firstSeqNumberInPlaylist,</span><br><span class="line">                &amp;uri,</span><br><span class="line">                &amp;itemMeta));</span><br><span class="line"></span><br><span class="line">    CHECK(itemMeta-&gt;findInt32(<span class="string">&quot;discontinuity-sequence&quot;</span>, &amp;mDiscontinuitySeq));</span><br><span class="line"></span><br><span class="line">    int32_t val;</span><br><span class="line">    <span class="keyword">if</span> (itemMeta-&gt;findInt32(<span class="string">&quot;discontinuity&quot;</span>, &amp;val) &amp;&amp; val != <span class="number">0</span>) &#123;</span><br><span class="line">        discontinuity = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mLastDiscontinuitySeq &gt;= <span class="number">0</span></span><br><span class="line">            &amp;&amp; mDiscontinuitySeq != mLastDiscontinuitySeq) &#123;</span><br><span class="line">        <span class="comment">// Seek jumped to a new discontinuity sequence. We need to signal</span></span><br><span class="line">        <span class="comment">// a format change to decoder. Decoder needs to shutdown and be</span></span><br><span class="line">        <span class="comment">// created again if seamless format change is unsupported.</span></span><br><span class="line">        FLOGV(<span class="string">&quot;saw discontinuity: mStartup %d, mLastDiscontinuitySeq %d, &quot;</span></span><br><span class="line">                <span class="string">&quot;mDiscontinuitySeq %d, mStartTimeUs %lld&quot;</span>,</span><br><span class="line">                mStartup, mLastDiscontinuitySeq, mDiscontinuitySeq, (<span class="keyword">long</span> <span class="keyword">long</span>)mStartTimeUs);</span><br><span class="line">        discontinuity = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mLastDiscontinuitySeq = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// decrypt a junk buffer to prefetch key; since a session uses only one http connection,</span></span><br><span class="line">    <span class="comment">// this avoids interleaved connections to the key and segment file.</span></span><br><span class="line">    &#123;</span><br><span class="line">        sp&lt;ABuffer&gt; junk = <span class="keyword">new</span> ABuffer(<span class="number">16</span>);</span><br><span class="line">        junk-&gt;setRange(<span class="number">0</span>, <span class="number">16</span>);</span><br><span class="line">        status_t err = decryptBuffer(mSeqNumber - firstSeqNumberInPlaylist, junk,</span><br><span class="line">                <span class="keyword">true</span> <span class="comment">/* first */</span>);</span><br><span class="line">        <span class="keyword">if</span> (err == ERROR_NOT_CONNECTED) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">            notifyError(err);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((mStartup &amp;&amp; !mTimeChangeSignaled) || discontinuity) &#123;</span><br><span class="line">        <span class="comment">// We need to signal a time discontinuity to ATSParser on the</span></span><br><span class="line">        <span class="comment">// first segment after start, or on a discontinuity segment.</span></span><br><span class="line">        <span class="comment">// Setting mNextPTSTimeUs informs extractAndQueueAccessUnitsXX()</span></span><br><span class="line">        <span class="comment">// to send the time discontinuity.</span></span><br><span class="line">        <span class="keyword">if</span> (mPlaylist-&gt;isComplete() || mPlaylist-&gt;isEvent()) &#123;</span><br><span class="line">            <span class="comment">// If this was a live event this made no sense since</span></span><br><span class="line">            <span class="comment">// we don&#x27;t have access to all the segment before the current</span></span><br><span class="line">            <span class="comment">// one.</span></span><br><span class="line">            mNextPTSTimeUs = getSegmentStartTimeUs(mSeqNumber);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Setting mTimeChangeSignaled to true, so that if start time</span></span><br><span class="line">        <span class="comment">// searching goes into 2nd segment (without a discontinuity),</span></span><br><span class="line">        <span class="comment">// we don&#x27;t reset time again. It causes corruption when pending</span></span><br><span class="line">        <span class="comment">// data in ATSParser is cleared.</span></span><br><span class="line">        mTimeChangeSignaled = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (discontinuity) &#123;</span><br><span class="line">        ALOGI(<span class="string">&quot;queueing discontinuity (explicit=%d)&quot;</span>, discontinuity);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Signal a format discontinuity to ATSParser to clear partial data</span></span><br><span class="line">        <span class="comment">// from previous streams. Not doing this causes bitstream corruption.</span></span><br><span class="line">        <span class="keyword">if</span> (mTSParser != NULL) &#123;</span><br><span class="line">            mTSParser-&gt;signalDiscontinuity(</span><br><span class="line">                    ATSParser::DISCONTINUITY_FORMATCHANGE, NULL <span class="comment">/* extra */</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        queueDiscontinuity(</span><br><span class="line">                ATSParser::DISCONTINUITY_FORMAT_ONLY,</span><br><span class="line">                NULL <span class="comment">/* extra */</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mStartup &amp;&amp; mStartTimeUsRelative &amp;&amp; mFirstPTSValid) &#123;</span><br><span class="line">            <span class="comment">// This means we guessed mStartTimeUs to be in the previous</span></span><br><span class="line">            <span class="comment">// segment (likely very close to the end), but either video or</span></span><br><span class="line">            <span class="comment">// audio has not found start by the end of that segment.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// If this new segment is not a discontinuity, keep searching.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// If this new segment even got a discontinuity marker, just</span></span><br><span class="line">            <span class="comment">// set mStartTimeUs=0, and take all samples from now on.</span></span><br><span class="line">            mStartTimeUs = <span class="number">0</span>;</span><br><span class="line">            mFirstPTSValid = <span class="keyword">false</span>;</span><br><span class="line">            mIDRFound = <span class="keyword">false</span>;</span><br><span class="line">            mVideoBuffer-&gt;clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FLOGV(<span class="string">&quot;fetching segment %d from (%d .. %d)&quot;</span>,</span><br><span class="line">            mSeqNumber, firstSeqNumberInPlaylist, lastSeqNumberInPlaylist);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line">void PlaylistFetcher::onDownloadNext() &#123;</span><br><span class="line">    AString uri;</span><br><span class="line">    sp&lt;AMessage&gt; itemMeta;</span><br><span class="line">    sp&lt;ABuffer&gt; buffer;</span><br><span class="line">    sp&lt;ABuffer&gt; tsBuffer;</span><br><span class="line">    int32_t firstSeqNumberInPlaylist = <span class="number">0</span>;</span><br><span class="line">    int32_t lastSeqNumberInPlaylist = <span class="number">0</span>;</span><br><span class="line">    bool connectHTTP = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">if</span> (mDownloadState-&gt;</span>hasSavedState()) &#123;</span><br><span class="line">        <span class="function"><span class="title">mDownloadState</span>-&gt;</span>restoreState(</span><br><span class="line">                uri,</span><br><span class="line">                itemMeta,</span><br><span class="line">                buffer,</span><br><span class="line">                tsBuffer,</span><br><span class="line">                firstSeqNumberInPlaylist,</span><br><span class="line">                lastSeqNumberInPlaylist);</span><br><span class="line">        connectHTTP = <span class="literal">false</span>;</span><br><span class="line">        FLOGV(<span class="string">&quot;resuming: &#x27;%s&#x27;&quot;</span>, uri.c_str());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!initDownloadState(</span><br><span class="line">                uri,</span><br><span class="line">                itemMeta,</span><br><span class="line">                firstSeqNumberInPlaylist,</span><br><span class="line">                lastSeqNumberInPlaylist)) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        FLOGV(<span class="string">&quot;fetching: &#x27;%s&#x27;&quot;</span>, uri.c_str());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    int64_t range_offset, range_length;</span><br><span class="line">    <span class="function"><span class="title">if</span> (!itemMeta-&gt;</span>findInt64(<span class="string">&quot;range-offset&quot;</span>, &amp;range_offset)</span><br><span class="line">            || !<span class="function"><span class="title">itemMeta</span>-&gt;</span>findInt64(<span class="string">&quot;range-length&quot;</span>, &amp;range_length)) &#123;</span><br><span class="line">        range_offset = <span class="number">0</span>;</span><br><span class="line">        range_length = -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// block-wise download</span></span><br><span class="line">    bool shouldPause = <span class="literal">false</span>;</span><br><span class="line">    ssize_t bytesRead;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        int64_t startUs = ALooper::GetNowUs();</span><br><span class="line">        <span class="comment">//下载</span></span><br><span class="line">        <span class="function"><span class="title">bytesRead</span> = mHTTPDownloader-&gt;</span>fetchBlock(</span><br><span class="line">                uri.c_str(), &amp;buffer, range_offset, range_length, kDownloadBlockSize,</span><br><span class="line">                NULL <span class="comment">/* actualURL */</span>, connectHTTP);</span><br><span class="line">        int64_t delayUs = ALooper::GetNowUs() - startUs;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bytesRead == ERROR_NOT_CONNECTED) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (bytesRead &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            status_t err = bytesRead;</span><br><span class="line">            ALOGE(<span class="string">&quot;failed to fetch .ts segment at url &#x27;%s&#x27;&quot;</span>, uri.c_str());</span><br><span class="line">            notifyError(err);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// add sample for bandwidth estimation, excluding samples from subtitles (as</span></span><br><span class="line">        <span class="comment">// its too small), or during startup/resumeUntil (when we could have more than</span></span><br><span class="line">        <span class="comment">// one connection open which affects bandwidth)</span></span><br><span class="line">        <span class="keyword">if</span> (!mStartup &amp;&amp; mStopParams == NULL &amp;&amp; bytesRead &gt; <span class="number">0</span></span><br><span class="line">                &amp;&amp; (mStreamTypeMask</span><br><span class="line">                        &amp; (LiveSession::STREAMTYPE_AUDIO</span><br><span class="line">                        | LiveSession::STREAMTYPE_VIDEO))) &#123;</span><br><span class="line">            <span class="function"><span class="title">mSession</span>-&gt;</span>addBandwidthMeasurement(bytesRead, delayUs);</span><br><span class="line">            <span class="keyword">if</span> (delayUs &gt; <span class="number">2000000</span>ll) &#123;</span><br><span class="line">                FLOGV(<span class="string">&quot;bytesRead %zd took %.2f seconds - abnormal bandwidth dip&quot;</span>,</span><br><span class="line">                        bytesRead, (double)delayUs / <span class="number">1.0</span>e6);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        connectHTTP = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        CHECK(buffer != NULL);</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="title">size_t</span> size = buffer-&gt;</span>size();</span><br><span class="line">        <span class="comment">// Set decryption range.</span></span><br><span class="line">        <span class="function"><span class="title">buffer</span>-&gt;</span>setRange(size - bytesRead, bytesRead);</span><br><span class="line">        <span class="comment">//通过获取的key解密buffer</span></span><br><span class="line">        status_t err = decryptBuffer(mSeqNumber - firstSeqNumberInPlaylist, buffer,</span><br><span class="line">                <span class="function"><span class="title">buffer</span>-&gt;</span>offset() == <span class="number">0</span> <span class="comment">/* first */</span>);</span><br><span class="line">        <span class="comment">// Unset decryption range.</span></span><br><span class="line">        <span class="function"><span class="title">buffer</span>-&gt;</span>setRange(<span class="number">0</span>, size);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">            ALOGE(<span class="string">&quot;decryptBuffer failed w/ error %d&quot;</span>, err);</span><br><span class="line"></span><br><span class="line">            notifyError(err);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        bool startUp = mStartup; <span class="comment">// save current start up state</span></span><br><span class="line"></span><br><span class="line">        err = OK;</span><br><span class="line">        <span class="keyword">if</span> (bufferStartsWithTsSyncByte(buffer)) &#123;</span><br><span class="line">            <span class="comment">// Incremental extraction is only supported for MPEG2 transport streams.</span></span><br><span class="line">            <span class="keyword">if</span> (tsBuffer == NULL) &#123;</span><br><span class="line">                <span class="function"><span class="title">tsBuffer</span> = new ABuffer(buffer-&gt;</span><span class="function"><span class="title">data</span>(), buffer-&gt;</span>capacity());</span><br><span class="line">                <span class="function"><span class="title">tsBuffer</span>-&gt;</span>setRange(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            &#125; <span class="function"><span class="title">else</span> <span class="keyword">if</span> (tsBuffer-&gt;</span><span class="function"><span class="title">capacity</span>() != buffer-&gt;</span>capacity()) &#123;</span><br><span class="line">                <span class="function"><span class="title">size_t</span> tsOff = tsBuffer-&gt;</span><span class="function"><span class="title">offset</span>(), tsSize = tsBuffer-&gt;</span>size();</span><br><span class="line">                <span class="function"><span class="title">tsBuffer</span> = new ABuffer(buffer-&gt;</span><span class="function"><span class="title">data</span>(), buffer-&gt;</span>capacity());</span><br><span class="line">                <span class="function"><span class="title">tsBuffer</span>-&gt;</span>setRange(tsOff, tsSize);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="title">tsBuffer</span>-&gt;</span><span class="function"><span class="title">setRange</span>(tsBuffer-&gt;</span><span class="function"><span class="title">offset</span>(), tsBuffer-&gt;</span>size() + bytesRead);</span><br><span class="line">            <span class="comment">//将解密后的buffer递给解码器</span></span><br><span class="line">            err = extractAndQueueAccessUnitsFromTs(tsBuffer);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (err == -EAGAIN) &#123;</span><br><span class="line">            <span class="comment">// starting sequence number too low/high</span></span><br><span class="line">            mTSParser.clear();</span><br><span class="line">            <span class="keyword">for</span> (size_t i = <span class="number">0</span>; i &lt; mPacketSources.size(); i++) &#123;</span><br><span class="line">                sp&lt;AnotherPacketSource&gt; packetSource = mPacketSources.valueAt(i);</span><br><span class="line">                <span class="function"><span class="title">packetSource</span>-&gt;</span>clear();</span><br><span class="line">            &#125;</span><br><span class="line">            postMonitorQueue();</span><br><span class="line">            return;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (err == ERROR_OUT_OF_RANGE) &#123;</span><br><span class="line">            <span class="comment">// reached stopping point</span></span><br><span class="line">            notifyStopReached();</span><br><span class="line">            return;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">            notifyError(err);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// If we&#x27;re switching, post start notification</span></span><br><span class="line">        <span class="comment">// this should only be posted when the last chunk is full processed by TSParser</span></span><br><span class="line">        <span class="keyword">if</span> (mSeekMode != LiveSession::kSeekModeExactPosition &amp;&amp; startUp != mStartup) &#123;</span><br><span class="line">            CHECK(mStartTimeUsNotify != NULL);</span><br><span class="line">            <span class="function"><span class="title">mStartTimeUsNotify</span>-&gt;</span>post();</span><br><span class="line">            mStartTimeUsNotify.clear();</span><br><span class="line">            shouldPause = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (shouldPause || shouldPauseDownload()) &#123;</span><br><span class="line">            <span class="comment">// save state and return if this is not the last chunk,</span></span><br><span class="line">            <span class="comment">// leaving the fetcher in paused state.</span></span><br><span class="line">            <span class="keyword">if</span> (bytesRead != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="function"><span class="title">mDownloadState</span>-&gt;</span>saveState(</span><br><span class="line">                        uri,</span><br><span class="line">                        itemMeta,</span><br><span class="line">                        buffer,</span><br><span class="line">                        tsBuffer,</span><br><span class="line">                        firstSeqNumberInPlaylist,</span><br><span class="line">                        lastSeqNumberInPlaylist);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            shouldPause = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (bytesRead != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bufferStartsWithTsSyncByte(buffer)) &#123;</span><br><span class="line">        <span class="comment">// If we don&#x27;t see a stream in the program table after fetching a full ts segment</span></span><br><span class="line">        <span class="comment">// mark it as nonexistent.</span></span><br><span class="line">        ATSParser::SourceType srcTypes[] =</span><br><span class="line">                &#123; ATSParser::VIDEO, ATSParser::AUDIO &#125;;</span><br><span class="line">        LiveSession::StreamType streamTypes[] =</span><br><span class="line">                &#123; LiveSession::STREAMTYPE_VIDEO, LiveSession::STREAMTYPE_AUDIO &#125;;</span><br><span class="line">        const size_t kNumTypes = NELEM(srcTypes);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (size_t i = <span class="number">0</span>; i &lt; kNumTypes; i++) &#123;</span><br><span class="line">            ATSParser::SourceType srcType = srcTypes[i];</span><br><span class="line">            LiveSession::StreamType streamType = streamTypes[i];</span><br><span class="line"></span><br><span class="line">            sp&lt;AnotherPacketSource&gt; source =</span><br><span class="line">                static_cast&lt;AnotherPacketSource *&gt;(</span><br><span class="line">                    <span class="function"><span class="title">mTSParser</span>-&gt;</span>getSource(srcType).get());</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="title">if</span> (!mTSParser-&gt;</span>hasSource(srcType)) &#123;</span><br><span class="line">                ALOGW(<span class="string">&quot;MPEG2 Transport stream does not contain %s data.&quot;</span>,</span><br><span class="line">                      srcType == ATSParser::VIDEO ? <span class="string">&quot;video&quot;</span> : <span class="string">&quot;audio&quot;</span>);</span><br><span class="line"></span><br><span class="line">                mStreamTypeMask &amp;= ~streamType;</span><br><span class="line">                mPacketSources.removeItem(streamType);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (checkDecryptPadding(buffer) != OK) &#123;</span><br><span class="line">        ALOGE(<span class="string">&quot;Incorrect padding bytes after decryption.&quot;</span>);</span><br><span class="line">        notifyError(ERROR_MALFORMED);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (tsBuffer != NULL) &#123;</span><br><span class="line">        AString method;</span><br><span class="line">        CHECK(<span class="function"><span class="title">buffer</span>-&gt;</span><span class="function"><span class="title">meta</span>()-&gt;</span>findString(<span class="string">&quot;cipher-method&quot;</span>, &amp;method));</span><br><span class="line">        <span class="function"><span class="title">if</span> ((tsBuffer-&gt;</span>size() &gt; <span class="number">0</span> &amp;&amp; method == <span class="string">&quot;NONE&quot;</span>)</span><br><span class="line">                || <span class="function"><span class="title">tsBuffer</span>-&gt;</span>size() &gt; <span class="number">16</span>) &#123;</span><br><span class="line">            ALOGE(<span class="string">&quot;MPEG2 transport stream is not an even multiple of 188 &quot;</span></span><br><span class="line">                    <span class="string">&quot;bytes in length.&quot;</span>);</span><br><span class="line">            notifyError(ERROR_MALFORMED);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// bulk extract non-ts files</span></span><br><span class="line">    bool startUp = mStartup;</span><br><span class="line">    <span class="keyword">if</span> (tsBuffer == NULL) &#123;</span><br><span class="line">        status_t err = extractAndQueueAccessUnits(buffer, itemMeta);</span><br><span class="line">        <span class="keyword">if</span> (err == -EAGAIN) &#123;</span><br><span class="line">            <span class="comment">// starting sequence number too low/high</span></span><br><span class="line">            postMonitorQueue();</span><br><span class="line">            return;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (err == ERROR_OUT_OF_RANGE) &#123;</span><br><span class="line">            <span class="comment">// reached stopping point</span></span><br><span class="line">            notifyStopReached();</span><br><span class="line">            return;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">            notifyError(err);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ++mSeqNumber;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if adapting, pause after found the next starting point</span></span><br><span class="line">    <span class="keyword">if</span> (mSeekMode != LiveSession::kSeekModeExactPosition &amp;&amp; startUp != mStartup) &#123;</span><br><span class="line">        CHECK(mStartTimeUsNotify != NULL);</span><br><span class="line">        <span class="function"><span class="title">mStartTimeUsNotify</span>-&gt;</span>post();</span><br><span class="line">        mStartTimeUsNotify.clear();</span><br><span class="line">        shouldPause = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!shouldPause) &#123;</span><br><span class="line">        postMonitorQueue();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>判断是否需要切换带宽</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="built_in">bool</span> LiveSession::switch<span class="constructor">BandwidthIfNeeded(<span class="params">bool</span> <span class="params">bufferHigh</span>, <span class="params">bool</span> <span class="params">bufferLow</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// no need to check bandwidth if we only have 1 bandwidth settings</span></span><br><span class="line"></span><br><span class="line">    int32_t bandwidthBps, shortTermBps;</span><br><span class="line">    <span class="built_in">bool</span> isStable;</span><br><span class="line">    <span class="comment">//调用estimateBandwidth预测带宽</span></span><br><span class="line">    <span class="keyword">if</span> (mBandwidthEstimator-&gt;estimate<span class="constructor">Bandwidth(&amp;<span class="params">bandwidthBps</span>, &amp;<span class="params">isStable</span>, &amp;<span class="params">shortTermBps</span>)</span>) &#123;</span><br><span class="line">        <span class="constructor">ALOGV(<span class="string">&quot;bandwidth estimated at %.2f kbps, &quot;</span><span class="string">&quot;stable %d, shortTermBps %.2f kbps&quot;</span>,<span class="params">bandwidthBps</span> <span class="operator">/</span> 1024.0f, <span class="params">isStable</span>, <span class="params">shortTermBps</span> <span class="operator">/</span> 1024.0f)</span>;</span><br><span class="line">        mLastBandwidthBps = bandwidthBps;</span><br><span class="line">        mLastBandwidthStable = isStable;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="constructor">ALOGV(<span class="string">&quot;no bandwidth estimate.&quot;</span>)</span>;</span><br><span class="line">        return <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    int32_t curBandwidth = mBandwidthItems.item<span class="constructor">At(<span class="params">mCurBandwidthIndex</span>)</span>.mBandwidth;</span><br><span class="line">    <span class="comment">// canSwithDown and canSwitchUp can&#x27;t both be true.</span></span><br><span class="line">    <span class="comment">// we only want to switch up when measured bw is 120% higher than current variant,</span></span><br><span class="line">    <span class="comment">// and we only want to switch down when measured bw is below current variant.</span></span><br><span class="line">    <span class="built_in">bool</span> canSwitchDown = bufferLow<span class="operator"> &amp;&amp; </span>(bandwidthBps &lt; (int32_t)curBandwidth);</span><br><span class="line">    <span class="built_in">bool</span> canSwitchUp = bufferHigh<span class="operator"> &amp;&amp; </span>(bandwidthBps &gt; (int32_t)curBandwidth<span class="operator"> * </span><span class="number">12</span><span class="operator"> / </span><span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (canSwitchDown<span class="operator"> || </span>canSwitchUp) &#123;</span><br><span class="line">        <span class="comment">// bandwidth estimating has some delay, if we have to downswitch when</span></span><br><span class="line">        <span class="comment">// it hasn&#x27;t stabilized, use the short term to guess real bandwidth,</span></span><br><span class="line">        <span class="comment">// since it may be dropping too fast.</span></span><br><span class="line">        <span class="comment">// (note this doesn&#x27;t apply to upswitch, always use longer average there)</span></span><br><span class="line">        <span class="keyword">if</span> (!isStable<span class="operator"> &amp;&amp; </span>canSwitchDown) &#123;</span><br><span class="line">            <span class="keyword">if</span> (shortTermBps &lt; bandwidthBps) &#123;</span><br><span class="line">                bandwidthBps = shortTermBps;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//获取要修改带宽数值index</span></span><br><span class="line">        ssize_t bandwidthIndex = get<span class="constructor">BandwidthIndex(<span class="params">bandwidthBps</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// it&#x27;s possible that we&#x27;re checking for canSwitchUp case, but the returned</span></span><br><span class="line">        <span class="comment">// bandwidthIndex is &lt; mCurBandwidthIndex, as getBandwidthIndex() only uses 70%</span></span><br><span class="line">        <span class="comment">// of measured bw. In that case we don&#x27;t want to do anything, since we have</span></span><br><span class="line">        <span class="comment">// both enough buffer and enough bw.</span></span><br><span class="line">        <span class="keyword">if</span> ((canSwitchUp<span class="operator"> &amp;&amp; </span>bandwidthIndex &gt; mCurBandwidthIndex)<span class="operator"></span></span><br><span class="line"><span class="operator">         || </span>(canSwitchDown<span class="operator"> &amp;&amp; </span>bandwidthIndex &lt; mCurBandwidthIndex)) &#123;</span><br><span class="line">            <span class="comment">// if not yet prepared, just restart again with new bw index.</span></span><br><span class="line">            <span class="comment">// this is faster and playback experience is cleaner.</span></span><br><span class="line">            <span class="comment">//修改配置，包括重启各种资源</span></span><br><span class="line">            change<span class="constructor">Configuration(<span class="params">mInPreparationPhase</span> ? 0 : -1ll, <span class="params">bandwidthIndex</span>)</span>;</span><br><span class="line">            return <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">LiveSession::getBandwidthIndex</span><span class="params">(<span class="type">int32_t</span> bandwidthBps)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mBandwidthItems.<span class="built_in">size</span>() &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="comment">// shouldn&#x27;t be here if we only have 1 bandwidth, check</span></span><br><span class="line">        <span class="comment">// logic to get rid of redundant bandwidth polling</span></span><br><span class="line">        <span class="built_in">ALOGW</span>(<span class="string">&quot;getBandwidthIndex() called for single bandwidth playlist!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 1</span></span><br><span class="line">    <span class="type">char</span> value[PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="type">ssize_t</span> index = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">property_get</span>(<span class="string">&quot;media.httplive.bw-index&quot;</span>, value, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="type">char</span> *end;</span><br><span class="line">        index = <span class="built_in">strtol</span>(value, &amp;end, <span class="number">10</span>);</span><br><span class="line">        <span class="built_in">CHECK</span>(end &gt; value &amp;&amp; *end == <span class="string">&#x27;\0&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (index &gt;= <span class="number">0</span> &amp;&amp; (<span class="type">size_t</span>)index &gt;= mBandwidthItems.<span class="built_in">size</span>()) &#123;</span><br><span class="line">            index = mBandwidthItems.<span class="built_in">size</span>() - <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">char</span> value[PROPERTY_VALUE_MAX];</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">property_get</span>(<span class="string">&quot;media.httplive.max-bw&quot;</span>, value, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">            <span class="type">char</span> *end;</span><br><span class="line">            <span class="type">long</span> maxBw = <span class="built_in">strtoul</span>(value, &amp;end, <span class="number">10</span>);</span><br><span class="line">            <span class="keyword">if</span> (end &gt; value &amp;&amp; *end == <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (maxBw &gt; <span class="number">0</span> &amp;&amp; bandwidthBps &gt; maxBw) &#123;</span><br><span class="line">                    <span class="built_in">ALOGV</span>(<span class="string">&quot;bandwidth capped to %ld bps&quot;</span>, maxBw);</span><br><span class="line">                    bandwidthBps = maxBw;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Pick the highest bandwidth stream that&#x27;s not currently blacklisted</span></span><br><span class="line">        <span class="comment">// below or equal to estimated bandwidth.</span></span><br><span class="line"></span><br><span class="line">        index = mBandwidthItems.<span class="built_in">size</span>() - <span class="number">1</span>;</span><br><span class="line">        <span class="type">ssize_t</span> lowestBandwidth = <span class="built_in">getLowestValidBandwidthIndex</span>();</span><br><span class="line">        <span class="keyword">while</span> (index &gt; lowestBandwidth) &#123;</span><br><span class="line">            <span class="comment">// be conservative (70%) to avoid overestimating and immediately</span></span><br><span class="line">            <span class="comment">// switching down again.</span></span><br><span class="line">            <span class="type">size_t</span> adjustedBandwidthBps = bandwidthBps * <span class="number">7</span> / <span class="number">10</span>;</span><br><span class="line">            <span class="type">const</span> BandwidthItem &amp;item = mBandwidthItems[index];</span><br><span class="line">            <span class="keyword">if</span> (item.mBandwidth &lt;= adjustedBandwidthBps</span><br><span class="line">                    &amp;&amp; <span class="built_in">isBandwidthValid</span>(item)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            --index;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> 0</span></span><br><span class="line">    <span class="comment">// Change bandwidth at random()</span></span><br><span class="line">    <span class="type">size_t</span> index = <span class="built_in">uniformRand</span>() * mBandwidthItems.<span class="built_in">size</span>();</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> 0</span></span><br><span class="line">    <span class="comment">// There&#x27;s a 50% chance to stay on the current bandwidth and</span></span><br><span class="line">    <span class="comment">// a 50% chance to switch to the next higher bandwidth (wrapping around</span></span><br><span class="line">    <span class="comment">// to lowest)</span></span><br><span class="line">    <span class="type">const</span> <span class="type">size_t</span> kMinIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">static</span> <span class="type">ssize_t</span> mCurBandwidthIndex = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> index;</span><br><span class="line">    <span class="keyword">if</span> (mCurBandwidthIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        index = kMinIndex;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">uniformRand</span>() &lt; <span class="number">0.5</span>) &#123;</span><br><span class="line">        index = (<span class="type">size_t</span>)mCurBandwidthIndex;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        index = mCurBandwidthIndex + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (index == mBandwidthItems.<span class="built_in">size</span>()) &#123;</span><br><span class="line">            index = kMinIndex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mCurBandwidthIndex = index;</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> 0</span></span><br><span class="line">    <span class="comment">// Pick the highest bandwidth stream below or equal to 1.2 Mbit/sec</span></span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> index = mBandwidthItems.<span class="built_in">size</span>() - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (index &gt; <span class="number">0</span> &amp;&amp; mBandwidthItems.<span class="built_in">itemAt</span>(index).mBandwidth &gt; <span class="number">1200000</span>) &#123;</span><br><span class="line">        --index;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> 1</span></span><br><span class="line">    <span class="type">char</span> value[PROPERTY_VALUE_MAX];</span><br><span class="line">    <span class="type">size_t</span> index;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">property_get</span>(<span class="string">&quot;media.httplive.bw-index&quot;</span>, value, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="type">char</span> *end;</span><br><span class="line">        index = <span class="built_in">strtoul</span>(value, &amp;end, <span class="number">10</span>);</span><br><span class="line">        <span class="built_in">CHECK</span>(end &gt; value &amp;&amp; *end == <span class="string">&#x27;\0&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (index &gt;= mBandwidthItems.<span class="built_in">size</span>()) &#123;</span><br><span class="line">            index = mBandwidthItems.<span class="built_in">size</span>() - <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        index = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="type">size_t</span> index = mBandwidthItems.<span class="built_in">size</span>() - <span class="number">1</span>;  <span class="comment">// Highest bandwidth stream</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">CHECK_GE</span>(index, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> index;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">Android 源码分析</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/AOSP-源码/">AOSP 源码</a>
  </div>

</div>



</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2016/08/02/Android-进阶之源码分析基于NuPlayer的RTSP流媒体协议/" title="Android 源码分析之基于NuPlayer的RTSP流媒体协议">
  <span>
  Android 源码分析之基于NuPlayer的RTSP流媒体协议</span>
</a>
</div>


<div class="next">
<a href="/2016/08/01/Android-源码分析基于Stagefright的MediaPlayer播放框架-3/"  title="Android 源码分析之基于Stagefright的MediaPlayer播放框架[4]">
 <span>Android 源码分析之基于Stagefright的MediaPlayer播放框架[4]
</span>
</a>
</div>

</nav>

	
<section id="comments" class="comment">
	<div class="ds-thread" data-thread-key="2016/08/02/Android-进阶之源码分析基于NuPlayer的HLS流媒体协议/" data-title="Android 源码分析之基于NuPlayer的HLS流媒体协议" data-url="http://yoursite.com/2016/08/02/Android-%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%9F%BA%E4%BA%8ENuPlayer%E7%9A%84HLS%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE/"></div>
</section>


<section id="comments" class="comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
 
 <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#HLS-%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">HLS 概述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HLS%E6%A1%86%E6%9E%B6%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.</span> <span class="toc-text">HLS框架介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#M3U8-%E6%A0%87%E7%AD%BE%E4%BB%8B%E7%BB%8D%EF%BC%9A"><span class="toc-number">3.</span> <span class="toc-text">M3U8 标签介绍：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HLS%E6%92%AD%E6%94%BE%E6%B5%81%E7%A8%8B"><span class="toc-number">4.</span> <span class="toc-text">HLS播放流程</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">
<div id="authorInfo">
	
		<div class="author-img"></div>		
	
	<div class="social-info" class="clearfix">
		
		
		<a href="https://github.com/tbfungeek" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
		
		<a href="mailto:tbfungeek@163.com" target="_blank" class="icon-email" title="Email Me"></a>
		

	</div>
</div>

  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
		  
			<li><a href="/categories/Android-小经验/" title="Android 小经验">Android 小经验<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android-源码分析/" title="Android 源码分析">Android 源码分析<sup>21</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android其他/" title="Android其他">Android其他<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android初步/" title="Android初步">Android初步<sup>21</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android进阶/" title="Android进阶">Android进阶<sup>100</sup></a></li>
		  
		
		  
			<li><a href="/categories/Hexo-使用/" title="Hexo 使用">Hexo 使用<sup>10</sup></a></li>
		  
		
		  
			<li><a href="/categories/JavaScript理论/" title="JavaScript理论">JavaScript理论<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Objective-C-相关/" title="Objective C 相关">Objective C 相关<sup>24</sup></a></li>
		  
		
		  
			<li><a href="/categories/OpenCV/" title="OpenCV">OpenCV<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/ROS/" title="ROS">ROS<sup>9</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-工具使用/" title="iOS 工具使用">iOS 工具使用<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-开源库分析/" title="iOS 开源库分析">iOS 开源库分析<sup>36</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-理论基础/" title="iOS 理论基础">iOS 理论基础<sup>14</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-进阶/" title="iOS 进阶">iOS 进阶<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/个人收藏/" title="个人收藏">个人收藏<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/代码规范/" title="代码规范">代码规范<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/其他/" title="其他">其他<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/博客分类目录/" title="博客分类目录">博客分类目录<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/叨叨系列/" title="叨叨系列">叨叨系列<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/开源代码分析/" title="开源代码分析">开源代码分析<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/开源库分析/" title="开源库分析">开源库分析<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/树莓派/" title="树莓派">树莓派<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/版本控制/" title="版本控制">版本控制<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/直播/" title="直播">直播<sup>6</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/iOS-开源库分析/" title="iOS 开源库分析">iOS 开源库分析<sup>36</sup></a></li>
			
		
			
				<li><a href="/tags/Android-设计模式/" title="Android 设计模式">Android 设计模式<sup>29</sup></a></li>
			
		
			
				<li><a href="/tags/Objective-C-相关/" title="Objective C 相关">Objective C 相关<sup>24</sup></a></li>
			
		
			
				<li><a href="/tags/Android基础/" title="Android基础">Android基础<sup>21</sup></a></li>
			
		
			
				<li><a href="/tags/AOSP-源码/" title="AOSP 源码">AOSP 源码<sup>17</sup></a></li>
			
		
			
				<li><a href="/tags/Android-常用第三方库/" title="Android 常用第三方库">Android 常用第三方库<sup>15</sup></a></li>
			
		
			
				<li><a href="/tags/iOS-理论基础/" title="iOS 理论基础">iOS 理论基础<sup>14</sup></a></li>
			
		
			
				<li><a href="/tags/Hexo-使用/" title="Hexo 使用">Hexo 使用<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/ROS/" title="ROS">ROS<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/Android-动画进阶/" title="Android 动画进阶">Android 动画进阶<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/Android-JNI/" title="Android JNI">Android JNI<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android-绘图进阶/" title="Android 绘图进阶">Android 绘图进阶<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android性能优化/" title="Android性能优化">Android性能优化<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android-自动化测试/" title="Android 自动化测试">Android 自动化测试<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/OpenCV/" title="OpenCV">OpenCV<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/直播/" title="直播">直播<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android-开源源码/" title="Android 开源源码">Android 开源源码<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Android-自定义View进阶/" title="Android 自定义View进阶">Android 自定义View进阶<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/树莓派/" title="树莓派">树莓派<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/iOS-进阶/" title="iOS 进阶">iOS 进阶<sup>4</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="https://hexo.io" target="_blank" title="Hexo">Hexo</a>
            
          </li>
        
          <li>
            
            	<a href="https://pages.github.com/" target="_blank" title="GitHub">GitHub</a>
            
          </li>
        
          <li>
            
            	<a href="http://pf18.github.io/" target="_blank" title="PF18">PF18</a>
            
          </li>
        
          <li>
            
            	<a href="http://toutiao.io/" target="_blank" title="开发者头条">开发者头条</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.jcodecraeer.com/" target="_blank" title="泡在网上的日子">泡在网上的日子</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="atom.xml" target="_blank" title="rss">RSS</a>
</div>

  
  <div class="tagcloudlist">
    <p class="asidetitle">Tag Cloud</p>
    <div class="tagcloudlist clearfix">
       <a href="/tags/AOSP-%E6%BA%90%E7%A0%81/" style="font-size: 17.14px;">AOSP 源码</a> <a href="/tags/Android-APK-%E7%AD%BE%E5%90%8D/" style="font-size: 10px;">Android APK 签名</a> <a href="/tags/Android-JNI/" style="font-size: 12.86px;">Android JNI</a> <a href="/tags/Android-%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E8%BF%9B%E9%98%B6/" style="font-size: 10.71px;">Android 事件处理进阶</a> <a href="/tags/Android-%E5%8A%A8%E7%94%BB%E8%BF%9B%E9%98%B6/" style="font-size: 13.57px;">Android 动画进阶</a> <a href="/tags/Android-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%BC%80%E5%8F%91/" style="font-size: 10px;">Android 多线程开发</a> <a href="/tags/Android-%E5%B0%8F%E7%BB%8F%E9%AA%8C/" style="font-size: 10px;">Android 小经验</a> <a href="/tags/Android-%E5%B8%B8%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93/" style="font-size: 16.43px;">Android 常用第三方库</a> <a href="/tags/Android-%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B/" style="font-size: 10px;">Android 开发流程</a> <a href="/tags/Android-%E5%BC%80%E6%BA%90%E6%BA%90%E7%A0%81/" style="font-size: 12.14px;">Android 开源源码</a> <a href="/tags/Android-%E7%BB%98%E5%9B%BE%E8%BF%9B%E9%98%B6/" style="font-size: 12.86px;">Android 绘图进阶</a> <a href="/tags/Android-%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/" style="font-size: 12.86px;">Android 自动化测试</a> <a href="/tags/Android-%E8%87%AA%E5%AE%9A%E4%B9%89View%E8%BF%9B%E9%98%B6/" style="font-size: 12.14px;">Android 自定义View进阶</a> <a href="/tags/Android-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 19.29px;">Android 设计模式</a> <a href="/tags/Android%E5%85%B6%E4%BB%96/" style="font-size: 10px;">Android其他</a> <a href="/tags/Android%E5%9F%BA%E7%A1%80/" style="font-size: 17.86px;">Android基础</a> <a href="/tags/Android%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B/" style="font-size: 10px;">Android开发流程</a> <a href="/tags/Android%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" style="font-size: 12.86px;">Android性能优化</a> <a href="/tags/Android%E6%B7%B7%E6%B7%86%E6%8A%80%E6%9C%AF/" style="font-size: 10px;">Android混淆技术</a> <a href="/tags/Android%E8%B4%A8%E9%87%8F%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/" style="font-size: 11.43px;">Android质量管理工具</a> <a href="/tags/Android%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/" style="font-size: 10px;">Android逆向工程</a> <a href="/tags/Git-github/" style="font-size: 10px;">Git && github</a> <a href="/tags/Hexo-%E4%BD%BF%E7%94%A8/" style="font-size: 15px;">Hexo 使用</a> <a href="/tags/JavaScript/" style="font-size: 10px;">JavaScript</a> <a href="/tags/Linux-%E4%BD%BF%E7%94%A8/" style="font-size: 10px;">Linux 使用</a> <a href="/tags/Objective-C-%E7%9B%B8%E5%85%B3/" style="font-size: 18.57px;">Objective C 相关</a> <a href="/tags/OpenCV/" style="font-size: 12.86px;">OpenCV</a> <a href="/tags/ROS/" style="font-size: 14.29px;">ROS</a> <a href="/tags/iOS-%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/" style="font-size: 10.71px;">iOS 工具使用</a> <a href="/tags/iOS-%E5%BC%80%E6%BA%90%E5%BA%93%E5%88%86%E6%9E%90/" style="font-size: 20px;">iOS 开源库分析</a> <a href="/tags/iOS-%E7%90%86%E8%AE%BA%E5%9F%BA%E7%A1%80/" style="font-size: 15.71px;">iOS 理论基础</a> <a href="/tags/iOS-%E8%BF%9B%E9%98%B6/" style="font-size: 12.14px;">iOS 进阶</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83/" style="font-size: 10px;">代码规范</a> <a href="/tags/%E5%8D%9A%E5%AE%A2%E5%88%86%E7%B1%BB%E7%9B%AE%E5%BD%95/" style="font-size: 10.71px;">博客分类目录</a> <a href="/tags/%E5%8F%A8%E5%8F%A8%E7%B3%BB%E5%88%97/" style="font-size: 10px;">叨叨系列</a> <a href="/tags/%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8/" style="font-size: 11.43px;">工具的使用</a> <a href="/tags/%E5%BC%80%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/" style="font-size: 10.71px;">开源代码分析</a> <a href="/tags/%E5%BC%80%E6%BA%90%E5%BA%93%E5%88%86%E6%9E%90/" style="font-size: 10px;">开源库分析</a> <a href="/tags/%E6%9D%82%E7%B1%BB/" style="font-size: 10px;">杂类</a> <a href="/tags/%E6%A0%91%E8%8E%93%E6%B4%BE/" style="font-size: 12.14px;">树莓派</a> <a href="/tags/%E7%9B%B4%E6%92%AD/" style="font-size: 12.86px;">直播</a> <a href="/tags/%E7%BC%96%E7%A8%8B%E6%8A%80%E5%B7%A7/" style="font-size: 10.71px;">编程技巧</a> <a href="/tags/%E7%BD%91%E7%AB%99%E6%94%B6%E8%97%8F/" style="font-size: 10px;">网站收藏</a> <a href="/tags/%E9%87%8D%E8%A6%81%E6%8E%A7%E4%BB%B6/" style="font-size: 11.43px;">重要控件</a>
    </div>
  </div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
		
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/hsihohuang/kiddochan" target="_blank" title="Kiddochan">Kiddochan</a> © 2022 
		
		<a href="/about" target="_blank" title="Edgar">Edgar</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
        getSize();
        if (myWidth >= 1024) {
          c.click();
        }
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>




<script type="text/javascript">
  var duoshuoQuery = {short_name:"tbfungeek"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 


<script type="text/javascript">

var disqus_shortname = 'tbfungeek';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>






<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?7c9443b0374f1cf6b1dbb5ab84d939cb";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
