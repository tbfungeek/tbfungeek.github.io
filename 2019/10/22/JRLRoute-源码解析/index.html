
 <!DOCTYPE HTML>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  
    <title>JLRoutes 源码解析 | Edgar&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Edgar">
    

    
    <meta name="description" content="开源库信息 JLRoutes地址  之前有写了一篇博客《iOS 基于JLRoutes 改造的路由》那时候比较忙所以只是简单地画了一个大致的框图，这段时间有时间所以抽空再写一篇针对JRLRoute源码解析的文章。JLRoute代码量不大，建议大家可以跟着这篇博客简单过下整个代码： 源码解析在对源码进行分析之前需要先了解下JLRoutes的大致结构，JLRoutes通过sheme将整个路由空间分隔开，">
<meta property="og:type" content="article">
<meta property="og:title" content="JLRoutes 源码解析">
<meta property="og:url" content="http://yoursite.com/2019/10/22/JRLRoute-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/index.html">
<meta property="og:site_name" content="Edgar&#39;s Blog">
<meta property="og:description" content="开源库信息 JLRoutes地址  之前有写了一篇博客《iOS 基于JLRoutes 改造的路由》那时候比较忙所以只是简单地画了一个大致的框图，这段时间有时间所以抽空再写一篇针对JRLRoute源码解析的文章。JLRoute代码量不大，建议大家可以跟着这篇博客简单过下整个代码： 源码解析在对源码进行分析之前需要先了解下JLRoutes的大致结构，JLRoutes通过sheme将整个路由空间分隔开，">
<meta property="og:locale">
<meta property="article:published_time" content="2019-10-22T09:24:47.000Z">
<meta property="article:modified_time" content="2019-12-19T13:14:06.000Z">
<meta property="article:author" content="Edgar">
<meta property="article:tag" content="iOS 开源库分析">
<meta name="twitter:card" content="summary">

    
    <link rel="alternative" href="atom.xml" title="Edgar&#39;s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/unnamed4_n_mSY_icon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/profile.png">
    <link rel="apple-touch-icon-precomposed" href="/img/profile.png">
    
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.2.0"></head>

  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Edgar&#39;s Blog">Edgar&#39;s Blog</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
					<li>
 					
					<form class="search" action="/search/index.html" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" autocomplete="off" name="q" maxlength="20" placeholder="Search" />
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/10/22/JRLRoute-源码解析/" title="JLRoutes 源码解析" itemprop="url">JLRoutes 源码解析</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Edgar" target="_blank" itemprop="author">Edgar</a>
		
  <p class="article-time">
    <time datetime="2019-10-22T09:24:47.000Z" itemprop="datePublished"> Published 2019-10-22</time>
    
  </p>
</header>
	<div class="article-content">
		
		<h5 id="开源库信息"><a href="#开源库信息" class="headerlink" title="开源库信息"></a>开源库信息</h5><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/joeldev/JLRoutes">JLRoutes地址</a></li>
</ul>
<p>之前有写了一篇博客《iOS 基于JLRoutes 改造的路由》那时候比较忙所以只是简单地画了一个大致的框图，这段时间有时间所以抽空再写一篇针对JRLRoute源码解析的文章。<br>JLRoute代码量不大，建议大家可以跟着这篇博客简单过下整个代码：</p>
<h5 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h5><p>在对源码进行分析之前需要先了解下JLRoutes的大致结构，JLRoutes通过sheme将整个路由空间分隔开，每个sheme相当于一个命名空间，每个sheme对应一个JLRoutes，每个JLRoutes有一个属性mutableRoutes 用于存放它所能匹配的JLRRouteDefinition。每个JLRRouteDefinition针对一个路由匹配规则，负责路由的匹配。每个路由匹配都被封装为JLRRouteRequest，交给JLRRouteDefinition进行匹配，JLRRouteDefinition会针对该request 输出一个匹配结果JLRRouteResponse。里面包含了是否匹配的信息。大体就是这么一个流程。</p>
<p>我们下面将针对上面介绍的结构一步一步进行介绍：</p>
<p><strong><strong>通过sheme分隔路由空间</strong></strong></p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">+ (<span class="keyword">instancetype</span>)routesForScheme:(<span class="built_in">NSString</span> *)scheme &#123;</span><br><span class="line">    JLRoutes *routesController = <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        JLRGlobal_routeControllersMap = [[<span class="built_in">NSMutableDictionary</span> alloc] init];</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//如果之前没有注册当前scheme，则创建JLRoutes</span></span><br><span class="line">    <span class="keyword">if</span> (!JLRGlobal_routeControllersMap[scheme]) &#123;</span><br><span class="line">        routesController = [[<span class="keyword">self</span> alloc] init];</span><br><span class="line">        routesController.scheme = scheme;</span><br><span class="line">        JLRGlobal_routeControllersMap[scheme] = routesController;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> JLRGlobal_routeControllersMap[scheme];;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)globalRoutes &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> routesForScheme:JLRoutesGlobalRoutesScheme];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每个路由都要被添加到指定的scheme空间，存储在JLRGlobal_routeControllersMap中，JLRGlobal_routeControllersMap是一个字典类型，key为scheme，value为指定的JLRoutes。默认的情况下JLRoutes帮我们提供了一个全局的命名空间globalRoutes。</p>
<p><strong><strong>注册指定的路由匹配规则</strong></strong></p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)addRoute:(<span class="built_in">NSString</span> *)routePattern handler:(<span class="type">BOOL</span> (^)(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *, <span class="type">id</span>&gt; *parameters))handlerBlock &#123;</span><br><span class="line">    [<span class="keyword">self</span> addRoute:routePattern priority:<span class="number">0</span> handler:handlerBlock];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)addRoute:(<span class="built_in">NSString</span> *)routePattern priority:(<span class="built_in">NSUInteger</span>)priority handler:(<span class="type">BOOL</span> (^)(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *, <span class="type">id</span>&gt; *parameters))handlerBlock &#123;</span><br><span class="line">    <span class="comment">//从路由模式中匹配可选的路由模式</span></span><br><span class="line">    <span class="built_in">NSArray</span> &lt;<span class="built_in">NSString</span> *&gt; *optionalRoutePatterns = [JLRParsingUtilities expandOptionalRoutePatternsForPattern:routePattern];</span><br><span class="line">    JLRRouteDefinition *route = [[JLRGlobal_routeDefinitionClass alloc] initWithPattern:routePattern priority:priority handlerBlock:handlerBlock];</span><br><span class="line">    <span class="keyword">if</span> (optionalRoutePatterns.count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// there are optional params, parse and add them</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">NSString</span> *pattern <span class="keyword">in</span> optionalRoutePatterns) &#123;</span><br><span class="line">            JLRRouteDefinition *optionalRoute = [[JLRGlobal_routeDefinitionClass alloc] initWithPattern:pattern priority:priority handlerBlock:handlerBlock];</span><br><span class="line">            [<span class="keyword">self</span> _registerRoute:optionalRoute];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    [<span class="keyword">self</span> _registerRoute:route];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们以****&#x2F;path&#x2F;:thing&#x2F;(&#x2F;a)(&#x2F;b)(&#x2F;c)**** 为例子，这里有固定path <strong><strong>&#x2F;path&#x2F;</strong></strong> 带参数的path <strong>**&#x2F;:thing&#x2F;<strong>*<em>，可选的path <strong>**&#x2F;(&#x2F;a)(&#x2F;b)(&#x2F;c)<strong><strong>。首先我们会通过</strong></strong>expandOptionalRoutePatternsForPattern**</strong> 将可选的部分转换成固定的或者带参数的path。比如上面的</em>*</strong>&#x2F;path&#x2F;:thing&#x2F;(&#x2F;a)(&#x2F;b)(&#x2F;c)**</strong> 会转换为如下几种：</p>
<figure class="highlight elixir"><table><tr><td class="code"><pre><span class="line">/path/<span class="symbol">:thing/a/b/c</span></span><br><span class="line">/path/<span class="symbol">:thing/a/b</span></span><br><span class="line">/path/<span class="symbol">:thing/a/c</span></span><br><span class="line">/path/<span class="symbol">:thing/b/a</span></span><br><span class="line">/path/<span class="symbol">:thing/a</span></span><br><span class="line">/path/<span class="symbol">:thing/b</span></span><br><span class="line">/path/<span class="symbol">:thing/c</span></span><br></pre></td></tr></table></figure>
<p>然后再通过_registerRoute注册上面的routePattern。</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)_registerRoute:(JLRRouteDefinition *)route &#123;</span><br><span class="line">    <span class="comment">//如果是最高优先级或者之前都没注册过就直接添加</span></span><br><span class="line">    <span class="keyword">if</span> (route.priority == <span class="number">0</span> || <span class="keyword">self</span>.mutableRoutes.count == <span class="number">0</span>) &#123;</span><br><span class="line">        [<span class="keyword">self</span>.mutableRoutes addObject:route];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">NSUInteger</span> index = <span class="number">0</span>;</span><br><span class="line">        <span class="type">BOOL</span> addedRoute = <span class="literal">NO</span>;</span><br><span class="line">        <span class="comment">// 按照优先级进行排序</span></span><br><span class="line">        <span class="comment">// search through existing routes looking for a lower priority route than this one</span></span><br><span class="line">        <span class="keyword">for</span> (JLRRouteDefinition *existingRoute <span class="keyword">in</span> [<span class="keyword">self</span>.mutableRoutes <span class="keyword">copy</span>]) &#123;</span><br><span class="line">            <span class="keyword">if</span> (existingRoute.priority &lt; route.priority) &#123;</span><br><span class="line">                <span class="comment">// if found, add the route after it</span></span><br><span class="line">                [<span class="keyword">self</span>.mutableRoutes insertObject:route atIndex:index];</span><br><span class="line">                addedRoute = <span class="literal">YES</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            index++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果没有找到则直接插在最后</span></span><br><span class="line">        <span class="comment">// if we weren&#x27;t able to find a lower priority route, this is the new lowest priority route (or same priority as self.routes.lastObject) and should just be added</span></span><br><span class="line">        <span class="keyword">if</span> (!addedRoute) &#123;</span><br><span class="line">            [<span class="keyword">self</span>.mutableRoutes addObject:route];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    [route didBecomeRegisteredForScheme:<span class="keyword">self</span>.scheme];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所有的routePattern 都会被封装到JLRRouteDefinition 然后按照优先级添加到mutableRoutes中。</p>
<p><strong><strong>路由匹配</strong></strong></p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">BOOL</span>)routeURL:(<span class="built_in">NSURL</span> *)URL withParameters:(<span class="built_in">NSDictionary</span> *)parameters &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> _routeURL:URL withParameters:parameters executeRouteBlock:<span class="literal">YES</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">BOOL</span>)_routeURL:(<span class="built_in">NSURL</span> *)URL withParameters:(<span class="built_in">NSDictionary</span> *)parameters executeRouteBlock:(<span class="type">BOOL</span>)executeRouteBlock &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line"></span><br><span class="line">    <span class="type">BOOL</span> didRoute = <span class="literal">NO</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//路由选项</span></span><br><span class="line">    JLRRouteRequestOptions options = [<span class="keyword">self</span> _routeRequestOptions];</span><br><span class="line">    <span class="comment">//构建路由请求</span></span><br><span class="line">    JLRRouteRequest *request = [[JLRRouteRequest alloc] initWithURL:URL options:options additionalParameters:parameters];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (JLRRouteDefinition *route <span class="keyword">in</span> [<span class="keyword">self</span>.mutableRoutes <span class="keyword">copy</span>]) &#123;</span><br><span class="line">        <span class="comment">// check each route for a matching response</span></span><br><span class="line">        <span class="comment">// 通过请求返回一个内部匹配的结果</span></span><br><span class="line">        JLRRouteResponse *response = [route routeResponseForRequest:request];</span><br><span class="line">        <span class="comment">//不匹配继续</span></span><br><span class="line">        <span class="keyword">if</span> (!response.isMatch) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//匹配了但是强制不执行直接返回</span></span><br><span class="line">        <span class="keyword">if</span> (!executeRouteBlock) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//调用路由block传入参数，进行处理</span></span><br><span class="line">        didRoute = [route callHandlerBlockWithParameters:response.parameters];</span><br><span class="line">        <span class="keyword">if</span> (didRoute) &#123;</span><br><span class="line">            <span class="comment">//已经处理退出循环</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//没有匹配</span></span><br><span class="line">    <span class="keyword">if</span> (!didRoute) &#123;</span><br><span class="line">        [<span class="keyword">self</span> _verboseLog:<span class="string">@&quot;Could not find a matching route&quot;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//如果没有找到匹配的，并且允许转到Globle路由则调用全局路由</span></span><br><span class="line">    <span class="keyword">if</span> (!didRoute &amp;&amp; <span class="keyword">self</span>.shouldFallbackToGlobalRoutes &amp;&amp; ![<span class="keyword">self</span> _isGlobalRoutesController]) &#123;</span><br><span class="line">        didRoute = [[JLRoutes globalRoutes] _routeURL:URL withParameters:parameters executeRouteBlock:executeRouteBlock];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果没有则调用unmatchedURLHandler</span></span><br><span class="line">    <span class="keyword">if</span> (!didRoute &amp;&amp; executeRouteBlock &amp;&amp; <span class="keyword">self</span>.unmatchedURLHandler) &#123;</span><br><span class="line">        <span class="keyword">self</span>.unmatchedURLHandler(<span class="keyword">self</span>, URL, parameters);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> didRoute;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果说路由规则是一个固定的内容，那么路由匹配则是拿着一个个具体的URL去规则里面去匹配：</p>
<p>路由匹配有几个阶段：</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">1.</span> 将路由URL以及参数封装成一个JLRRouteRequest</span><br><span class="line"><span class="bullet">2.</span> 使用已经注册好的JLRRouteDefinition去和JLRRouteRequest进行匹配，并生成一个JLRRouteResponse,如果匹配，则调用相应的回调。</span><br><span class="line"><span class="bullet">3.</span> 如果不匹配则根据我们的需求选择是否允许转到Globle路由去匹配，如果还没找到则选择是否调用unmatchedURLHandler</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong><strong>JLRRouteRequest路由请求</strong></strong></p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">instancetype</span>)initWithURL:(<span class="built_in">NSURL</span> *)URL options:(JLRRouteRequestOptions)options additionalParameters:(<span class="keyword">nullable</span> <span class="built_in">NSDictionary</span> *)additionalParameters &#123;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">self</span> = [<span class="variable language_">super</span> init])) &#123;</span><br><span class="line">        <span class="keyword">self</span>.URL                    = URL;                      <span class="comment">// URL</span></span><br><span class="line">        <span class="keyword">self</span>.options                = options;                  <span class="comment">// options</span></span><br><span class="line">        <span class="keyword">self</span>.additionalParameters   = additionalParameters;     <span class="comment">// 额外参数</span></span><br><span class="line">        </span><br><span class="line">        <span class="type">BOOL</span> treatsHostAsPathComponent = ((options &amp; JLRRouteRequestOptionTreatHostAsPathComponent) == JLRRouteRequestOptionTreatHostAsPathComponent);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//取出路径的各个部分</span></span><br><span class="line">        <span class="built_in">NSURLComponents</span> *components = [<span class="built_in">NSURLComponents</span> componentsWithString:[<span class="keyword">self</span>.URL absoluteString]];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//是否将host作为path</span></span><br><span class="line">        <span class="keyword">if</span> (components.host.length &gt; <span class="number">0</span> </span><br><span class="line">            &amp;&amp; (treatsHostAsPathComponent || (![components.host isEqualToString:<span class="string">@&quot;localhost&quot;</span>] &amp;&amp; [components.host rangeOfString:<span class="string">@&quot;.&quot;</span>].location == <span class="built_in">NSNotFound</span>))) &#123;</span><br><span class="line">            <span class="comment">// convert the host to &quot;/&quot; so that the host is considered a path component</span></span><br><span class="line">            <span class="built_in">NSString</span> *host = [components.percentEncodedHost <span class="keyword">copy</span>];</span><br><span class="line">            components.host = <span class="string">@&quot;/&quot;</span>;</span><br><span class="line">            components.percentEncodedPath = [host stringByAppendingPathComponent:(components.percentEncodedPath ?: <span class="string">@&quot;&quot;</span>)];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//格式化后的路径</span></span><br><span class="line">        <span class="built_in">NSString</span> *path = [components percentEncodedPath];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// handle fragment if needed</span></span><br><span class="line">        <span class="keyword">if</span> (components.fragment != <span class="literal">nil</span>) &#123;</span><br><span class="line">            <span class="type">BOOL</span> fragmentContainsQueryParams = <span class="literal">NO</span>;</span><br><span class="line">            <span class="built_in">NSURLComponents</span> *fragmentComponents = [<span class="built_in">NSURLComponents</span> componentsWithString:components.percentEncodedFragment];</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (fragmentComponents.query == <span class="literal">nil</span> &amp;&amp; fragmentComponents.path != <span class="literal">nil</span>) &#123;</span><br><span class="line">                fragmentComponents.query = fragmentComponents.path;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (fragmentComponents.queryItems.count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// determine if this fragment is only valid query params and nothing else</span></span><br><span class="line">                fragmentContainsQueryParams = fragmentComponents.queryItems.firstObject.value.length &gt; <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (fragmentContainsQueryParams) &#123;</span><br><span class="line">                <span class="comment">// include fragment query params in with the standard set</span></span><br><span class="line">                components.queryItems = [(components.queryItems ?: @[]) arrayByAddingObjectsFromArray:fragmentComponents.queryItems];</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (fragmentComponents.path != <span class="literal">nil</span> &amp;&amp; (!fragmentContainsQueryParams || ![fragmentComponents.path isEqualToString:fragmentComponents.query])) &#123;</span><br><span class="line">                <span class="comment">// handle fragment by include fragment path as part of the main path</span></span><br><span class="line">                path = [path stringByAppendingString:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;#%@&quot;</span>, fragmentComponents.percentEncodedPath]];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// strip off leading slash so that we don&#x27;t have an empty first path component</span></span><br><span class="line">        <span class="keyword">if</span> (path.length &gt; <span class="number">0</span> &amp;&amp; [path characterAtIndex:<span class="number">0</span>] == <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">            path = [path substringFromIndex:<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// strip off trailing slash for the same reason</span></span><br><span class="line">        <span class="keyword">if</span> (path.length &gt; <span class="number">0</span> &amp;&amp; [path characterAtIndex:path.length - <span class="number">1</span>] == <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">            path = [path substringToIndex:path.length - <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// split apart into path components</span></span><br><span class="line">        <span class="keyword">self</span>.pathComponents = [path componentsSeparatedByString:<span class="string">@&quot;/&quot;</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// convert query items into a dictionary</span></span><br><span class="line">        <span class="built_in">NSArray</span> &lt;<span class="built_in">NSURLQueryItem</span> *&gt; *queryItems = [components queryItems] ?: @[];</span><br><span class="line">        <span class="built_in">NSMutableDictionary</span> *queryParams = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">NSURLQueryItem</span> *item <span class="keyword">in</span> queryItems) &#123;</span><br><span class="line">            <span class="keyword">if</span> (item.value == <span class="literal">nil</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (queryParams[item.name] == <span class="literal">nil</span>) &#123;</span><br><span class="line">                <span class="comment">// first time seeing a param with this name, set it</span></span><br><span class="line">                queryParams[item.name] = item.value;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([queryParams[item.name] isKindOfClass:[<span class="built_in">NSArray</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">                <span class="comment">// already an array of these items, append it</span></span><br><span class="line">                <span class="built_in">NSArray</span> *values = (<span class="built_in">NSArray</span> *)(queryParams[item.name]);</span><br><span class="line">                queryParams[item.name] = [values arrayByAddingObject:item.value];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// existing non-array value for this key, create an array</span></span><br><span class="line">                <span class="type">id</span> existingValue = queryParams[item.name];</span><br><span class="line">                queryParams[item.name] = @[existingValue, item.value];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">self</span>.queryParams = [queryParams <span class="keyword">copy</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">JLRRouteRequest</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// The URL being routed. 需要被路由的URL</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>, <span class="keyword">readonly</span>) <span class="built_in">NSURL</span>                     *URL;</span><br><span class="line"><span class="comment">/// The URL&#x27;s path components. URL的路径部分</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSArray</span>                 *pathComponents;</span><br><span class="line"><span class="comment">/// The URL&#x27;s query parameters. URL的请求参数部分</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSDictionary</span>            *queryParams;</span><br><span class="line"><span class="comment">/// Route request options, generally configured from the framework global options. 请求的可选部分</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) JLRRouteRequestOptions  options;</span><br><span class="line"><span class="comment">/// Additional parameters to pass through as part of the match parameters dictionary. 额外参数</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>, <span class="keyword">nullable</span>, <span class="keyword">readonly</span>) <span class="built_in">NSDictionary</span>    *additionalParameters;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>每个JLRRouteRequest包含了URL它是JLRRouteRequest其他部分的来源，pathComponents是URL中的path部分，queryParams是URL中的query部分，options是外部注入的选项配置，additionalParameters是外部注入的额外参数。进入下一阶段匹配的时候都是将这些参数与JLRRouteDefinition中定义的模版进行匹配。</p>
<p><strong><strong>JLRRouteDefinition 路由规则定义</strong></strong></p>
<p>我们接下来看下JLRRouts中的路由规则定义部分，以及路由匹配过程：</p>
<p>在JLRoutes中每个路由规则被定义为一个JLRRouteDefinition对象，我们先来看下它的结构：</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">/// 当前route 的 URL scheme</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>, <span class="keyword">readonly</span>) <span class="built_in">NSString</span>                  *scheme;</span><br><span class="line"><span class="comment">/// 当前route匹配模版.</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>, <span class="keyword">readonly</span>) <span class="built_in">NSString</span>                  *pattern;</span><br><span class="line"><span class="comment">/// 当前路由的优先级</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) <span class="built_in">NSUInteger</span>              priority;</span><br><span class="line"><span class="comment">/// 当前路由的匹配模版分隔后的Components，它通过‘/’对pattern字符串进行分隔后存到patternPathComponents</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>, <span class="keyword">readonly</span>) <span class="built_in">NSArray</span> &lt;<span class="built_in">NSString</span> *&gt;      *patternPathComponents;</span><br><span class="line"><span class="comment">/// 在每次匹配的时候都会触发这个handlerBlock</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>, <span class="keyword">readonly</span>) <span class="type">BOOL</span>                      (^handlerBlock)(<span class="built_in">NSDictionary</span> *parameters);</span><br></pre></td></tr></table></figure>

<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">instancetype</span>)initWithPattern:(<span class="built_in">NSString</span> *)pattern priority:(<span class="built_in">NSUInteger</span>)priority handlerBlock:(<span class="type">BOOL</span> (^)(<span class="built_in">NSDictionary</span> *parameters))handlerBlock &#123;</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(pattern != <span class="literal">nil</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">self</span> = [<span class="variable language_">super</span> init])) &#123;</span><br><span class="line">        <span class="keyword">self</span>.pattern = pattern;</span><br><span class="line">        <span class="keyword">self</span>.priority = priority;</span><br><span class="line">        <span class="keyword">self</span>.handlerBlock = handlerBlock;</span><br><span class="line">        <span class="keyword">if</span> ([pattern characterAtIndex:<span class="number">0</span>] == <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">            pattern = [pattern substringFromIndex:<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">self</span>.patternPathComponents = [pattern componentsSeparatedByString:<span class="string">@&quot;/&quot;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>pattern 是当前路由的匹配规则比如&#x2F;path&#x2F;:things&#x2F;a&#x2F;b&#x2F;c,而patternPathComponents则是通过‘&#x2F;’对pattern字符串进行分隔后的子pathPattern。我们接下来看下最重要的路由匹配过程。</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (JLRRouteResponse *)routeResponseForRequest:(JLRRouteRequest *)request &#123;</span><br><span class="line">    <span class="type">BOOL</span> patternContainsWildcard = [<span class="keyword">self</span>.patternPathComponents containsObject:<span class="string">@&quot;*&quot;</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//不包含通配符的情况下传入的request与当前的pathComponents长度不相等，这种情况确定是不匹配的</span></span><br><span class="line">    <span class="keyword">if</span> (request.pathComponents.count != <span class="keyword">self</span>.patternPathComponents.count &amp;&amp; !patternContainsWildcard) &#123;</span><br><span class="line">        <span class="keyword">return</span> [JLRRouteResponse invalidMatchResponse];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//通过patternPathComponents模版定义从request pathComponents取出具体的参数值来填充routeVariables，routeVariables就是匹配出的变量值</span></span><br><span class="line">    <span class="built_in">NSDictionary</span> *routeVariables = [<span class="keyword">self</span> routeVariablesForRequest:request];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (routeVariables != <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="comment">// It&#x27;s a match, set up the param dictionary and create a valid match response</span></span><br><span class="line">        <span class="comment">//匹配的情况下将所有的参数放到JLRRouteResponse返回</span></span><br><span class="line">        <span class="built_in">NSDictionary</span> *matchParams = [<span class="keyword">self</span> matchParametersForRequest:request routeVariables:routeVariables];</span><br><span class="line">        <span class="keyword">return</span> [JLRRouteResponse validMatchResponseWithParameters:matchParams];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// nil variables indicates no match, so return an invalid match response</span></span><br><span class="line">        <span class="keyword">return</span> [JLRRouteResponse invalidMatchResponse];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>routeResponseForRequest 中最关键的部分在于routeVariablesForRequest，它会在提取path中变量的过程中，一边针对path进行匹配，一边提取，一旦发现不匹配就直接返回。所以我们重点来看下routeVariablesForRequest部分：</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">NSDictionary</span> &lt;<span class="built_in">NSString</span> *, <span class="built_in">NSString</span> *&gt; *)routeVariablesForRequest:(JLRRouteRequest *)request &#123;</span><br><span class="line">    <span class="built_in">NSMutableDictionary</span> *routeVariables = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">    </span><br><span class="line">    <span class="type">BOOL</span> isMatch = <span class="literal">YES</span>;</span><br><span class="line">    <span class="built_in">NSUInteger</span> index = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSString</span> *patternComponent <span class="keyword">in</span> <span class="keyword">self</span>.patternPathComponents <span class="comment">/*这里存着变量名*/</span>) &#123;</span><br><span class="line">        <span class="built_in">NSString</span> *URLComponent = <span class="literal">nil</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//是否是通配符</span></span><br><span class="line">        <span class="type">BOOL</span> isPatternComponentWildcard = [patternComponent isEqualToString:<span class="string">@&quot;*&quot;</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. 取出request中同样位置的pathComponents</span></span><br><span class="line">        <span class="keyword">if</span> (index &lt; [request.pathComponents count]) &#123;</span><br><span class="line">            URLComponent = request.pathComponents[index]<span class="comment">/*请求这里存着变量值*/</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isPatternComponentWildcard) &#123;</span><br><span class="line">            <span class="comment">// 请求路径参数小于或者等于的时候还包含有通配符是不可能的</span></span><br><span class="line">            <span class="comment">// URLComponent is not a wildcard and index is &gt;= request.pathComponents.count, so bail</span></span><br><span class="line">            isMatch = <span class="literal">NO</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//从patternPathComponent看当前的path是否是带参数的path，带参数的path之前都是 :xxx这种以冒号开头</span></span><br><span class="line">        <span class="keyword">if</span> ([patternComponent hasPrefix:<span class="string">@&quot;:&quot;</span>]) &#123;</span><br><span class="line">            <span class="comment">// this is a variable, set it in the params</span></span><br><span class="line">            <span class="built_in">NSAssert</span>(URLComponent != <span class="literal">nil</span>, <span class="string">@&quot;URLComponent cannot be nil&quot;</span>);</span><br><span class="line">            <span class="comment">// 获取变量名---&gt; 将开头的冒号以及结尾的#去掉</span></span><br><span class="line">            <span class="built_in">NSString</span> *variableName = [<span class="keyword">self</span> routeVariableNameForValue:patternComponent];</span><br><span class="line">            <span class="comment">// 变量值 ---&gt; 将结尾的#去掉</span></span><br><span class="line">            <span class="built_in">NSString</span> *variableValue = [<span class="keyword">self</span> routeVariableValueForValue:URLComponent];</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Consult the parsing utilities as well to do any other standard variable transformations</span></span><br><span class="line">            <span class="type">BOOL</span> decodePlusSymbols = ((request.options &amp; JLRRouteRequestOptionDecodePlusSymbols) == JLRRouteRequestOptionDecodePlusSymbols);</span><br><span class="line">            variableValue = [JLRParsingUtilities variableValueFrom:variableValue decodePlusSymbols:decodePlusSymbols];</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//将变量名为key，值为value 存在 routeVariables中</span></span><br><span class="line">            routeVariables[variableName] = variableValue;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isPatternComponentWildcard <span class="comment">/*包含通配符的情况*/</span>) &#123;</span><br><span class="line">            <span class="comment">// match wildcards</span></span><br><span class="line">            <span class="built_in">NSUInteger</span> minRequiredParams = index;</span><br><span class="line">            <span class="keyword">if</span> (request.pathComponents.count &gt;= minRequiredParams) &#123;</span><br><span class="line">                <span class="comment">// match: /a/b/c/* has to be matched by at least /a/b/c</span></span><br><span class="line">                <span class="comment">// 将通配的部分统一放到routeVariables[JLRouteWildcardComponentsKey]中</span></span><br><span class="line">                routeVariables[JLRouteWildcardComponentsKey] = [request.pathComponents subarrayWithRange:<span class="built_in">NSMakeRange</span>(index, request.pathComponents.count - index)];</span><br><span class="line">                isMatch = <span class="literal">YES</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// not a match: /a/b/c/* cannot be matched by URL /a/b/</span></span><br><span class="line">                isMatch = <span class="literal">NO</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (![patternComponent isEqualToString:URLComponent]) &#123;</span><br><span class="line">            <span class="comment">// break if this is a static component and it isn&#x27;t a match</span></span><br><span class="line">            isMatch = <span class="literal">NO</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        index++;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!isMatch) &#123;</span><br><span class="line">        <span class="comment">// Return nil to indicate that there was not a match</span></span><br><span class="line">        routeVariables = <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> [routeVariables <span class="keyword">copy</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先我们会遍历JLRRouteDefinition中的patternPathComponents，将它的每个元素取出来，如果发现当前的patternPathComponent是以冒号开头，那么表示，当前的path是一个变量，就从request中的pathComponents对应位置取出pathComponent。再将patternPathComponen开始的冒号以及结尾如果是#的去掉作为key，将requst pathComponent 作为value添加到routeVariables。</p>
<p>如果当前的匹配规则patternPathComponent是通配符，并且request的pathComponents长度大于当前的index，那么将request pathComponents中剩余的值都赋给routeVariables，这时候key为通配符符号*。<br>为什么能够这样做，以为我们规定通配符要放在路径的最后面。</p>
<p>除了变量，通配符之外只剩下静态component，这种只要判断是否相等就可以了。不相等就表示直接不匹配。</p>
<p>所以routeVariablesForRequest其实是要完成两部分任务，一部分负责匹配，一部分负责将path中的变量提取出来。</p>
<p>我们再回到routeResponseForRequest，提取完path中的全部变量后会执行下面这部分代码：</p>
<figure class="highlight pf"><table><tr><td class="code"><pre><span class="line">NSDictionary *<span class="built_in">match</span>Params = [<span class="literal">self</span> <span class="built_in">match</span>ParametersForRequest:request <span class="keyword">route</span>Variables:<span class="keyword">route</span>Variables];</span><br></pre></td></tr></table></figure>

<p>它其实是将上面从path提取出来的参数以及request.additionalParameters，request.queryParams合并起来作为最终的参数，并且在这最终的参数中添加request.URL，以及self.scheme。我们知道JLRRoutes的参数可以通过path指定，通过request.queryParams，通过request.additionalParameters 这三个地方指定。这里就是将这写参数合并起来，传递下去。后续的处理block拿到这些参数进行对应的逻辑处理。</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">NSDictionary</span> *)matchParametersForRequest:(JLRRouteRequest *)request routeVariables:(<span class="built_in">NSDictionary</span> &lt;<span class="built_in">NSString</span> *, <span class="built_in">NSString</span> *&gt; *)routeVariables &#123;</span><br><span class="line">    <span class="built_in">NSMutableDictionary</span> *matchParams = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Add the parsed query parameters (&#x27;?a=b&amp;c=d&#x27;). Also includes fragment.</span></span><br><span class="line">    <span class="comment">// 添加query参数</span></span><br><span class="line">    <span class="type">BOOL</span> decodePlusSymbols = ((request.options &amp; JLRRouteRequestOptionDecodePlusSymbols) == JLRRouteRequestOptionDecodePlusSymbols);</span><br><span class="line">    [matchParams addEntriesFromDictionary:[JLRParsingUtilities queryParams:request.queryParams decodePlusSymbols:decodePlusSymbols]];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Add the actual parsed route variables (the items in the route prefixed with &#x27;:&#x27;).</span></span><br><span class="line">    <span class="comment">// 添加路径中的参数</span></span><br><span class="line">    [matchParams addEntriesFromDictionary:routeVariables];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Add the additional parameters, if any were specified in the request.</span></span><br><span class="line">    <span class="comment">// 添加request中附带的额外的参数</span></span><br><span class="line">    <span class="keyword">if</span> (request.additionalParameters != <span class="literal">nil</span>) &#123;</span><br><span class="line">        [matchParams addEntriesFromDictionary:request.additionalParameters];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Finally, add the base parameters. This is done last so that these cannot be overriden by using the same key in your route or query.</span></span><br><span class="line">    <span class="comment">// 添加request.URL ，self.scheme这些公共参数</span></span><br><span class="line">    [matchParams addEntriesFromDictionary:[<span class="keyword">self</span> defaultMatchParametersForRequest:request]];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> [matchParams <span class="keyword">copy</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSDictionary</span> *)defaultMatchParametersForRequest:(JLRRouteRequest *)request &#123;</span><br><span class="line">    <span class="keyword">return</span> @&#123;JLRoutePatternKey: <span class="keyword">self</span>.pattern ?: [<span class="built_in">NSNull</span> null], JLRouteURLKey: request.URL ?: [<span class="built_in">NSNull</span> null], JLRouteSchemeKey: <span class="keyword">self</span>.scheme ?: [<span class="built_in">NSNull</span> null]&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有了参数之后就将参数封装到JLRRouteResponse中传递给处理block：</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line"><span class="string">[JLRRouteResponse validMatchResponseWithParameters:matchParams]</span></span><br></pre></td></tr></table></figure>

<p>JLRRouteResponse 十分简单就两个属性，一个用于标记是否匹配，另一个是当前路由的所有请求：</p>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="variable">@interface</span> <span class="attribute">JLRRouteResponse </span>: NSObject &lt;NSCopying&gt;</span><br><span class="line"><span class="comment">/// 是否匹配</span></span><br><span class="line"><span class="variable">@property</span> (nonatomic, assign, readonly, getter=isMatch) BOOL match;</span><br><span class="line"><span class="comment">/// 匹配的参数</span></span><br><span class="line"><span class="variable">@property</span> (nonatomic, copy, readonly, nullable) NSDictionary *parameters;</span><br><span class="line"><span class="variable">@end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们前面在介绍_routeURL的时候看到最终的response是传递到JLRRouteDefinition中的callHandlerBlockWithParameters方法中：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">didRoute</span> = [route callHandlerBlockWithParameters:response.parameters]<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<p>而callHandlerBlockWithParameters则是调用了handlerBlock将参数传递出去，在业务层进行处理：</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">BOOL</span>)callHandlerBlockWithParameters:(<span class="built_in">NSDictionary</span> *)parameters &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.handlerBlock == <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.handlerBlock(parameters);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以整个路由的过程是这样的：</p>
<ol>
<li>在使用路由之前先注册一系列路由规则JLRRouteDefinition，每个路由规则有对应的匹配规则pathPattern,以及如果有对应的路由请求匹配这条规则后的处理。</li>
<li>将匹配规则封装成一个JLRRouteRequest请求，并拿它与所属的schema中的一系列JLRRouteDefinition进行匹配，并尝试按照JLRRouteDefinition中的规则提取对应的参数。</li>
<li>如果匹配了哪条规则，就会触发对应规则的handlerBlock，并将所有参数传递进去。我们在handlerBlock中就可以自定义我们的业务处理。</li>
</ol>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/iOS-%E5%BC%80%E6%BA%90%E5%BA%93%E5%88%86%E6%9E%90/">iOS 开源库分析</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/iOS-开源库分析/">iOS 开源库分析</a>
  </div>

</div>



</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2019/10/23/iOS-基于JLRoute-改造的路由/" title="iOS 基于JLRoute 改造的路由">
  <span>
  iOS 基于JLRoute 改造的路由</span>
</a>
</div>


<div class="next">
<a href="/2019/10/15/图解iOS之GVUserDefaults/"  title="图解iOS之GVUserDefaults">
 <span>图解iOS之GVUserDefaults
</span>
</a>
</div>

</nav>

	
<section id="comments" class="comment">
	<div class="ds-thread" data-thread-key="2019/10/22/JRLRoute-源码解析/" data-title="JLRoutes 源码解析" data-url="http://yoursite.com/2019/10/22/JRLRoute-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"></div>
</section>


<section id="comments" class="comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
 
 <ol class="toc"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%80%E6%BA%90%E5%BA%93%E4%BF%A1%E6%81%AF"><span class="toc-number">1.</span> <span class="toc-text">开源库信息</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">源码解析</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">
<div id="authorInfo">
	
		<div class="author-img"></div>		
	
	<div class="social-info" class="clearfix">
		
		
		<a href="https://github.com/tbfungeek" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
		
		<a href="mailto:tbfungeek@163.com" target="_blank" class="icon-email" title="Email Me"></a>
		

	</div>
</div>

  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
		  
			<li><a href="/categories/Android-小经验/" title="Android 小经验">Android 小经验<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android-源码分析/" title="Android 源码分析">Android 源码分析<sup>21</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android其他/" title="Android其他">Android其他<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android初步/" title="Android初步">Android初步<sup>21</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android进阶/" title="Android进阶">Android进阶<sup>100</sup></a></li>
		  
		
		  
			<li><a href="/categories/Hexo-使用/" title="Hexo 使用">Hexo 使用<sup>10</sup></a></li>
		  
		
		  
			<li><a href="/categories/JavaScript理论/" title="JavaScript理论">JavaScript理论<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Objective-C-相关/" title="Objective C 相关">Objective C 相关<sup>24</sup></a></li>
		  
		
		  
			<li><a href="/categories/OpenCV/" title="OpenCV">OpenCV<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/ROS/" title="ROS">ROS<sup>9</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-工具使用/" title="iOS 工具使用">iOS 工具使用<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-开源库分析/" title="iOS 开源库分析">iOS 开源库分析<sup>36</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-理论基础/" title="iOS 理论基础">iOS 理论基础<sup>14</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-进阶/" title="iOS 进阶">iOS 进阶<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/个人收藏/" title="个人收藏">个人收藏<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/代码规范/" title="代码规范">代码规范<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/其他/" title="其他">其他<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/博客分类目录/" title="博客分类目录">博客分类目录<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/叨叨系列/" title="叨叨系列">叨叨系列<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/开源代码分析/" title="开源代码分析">开源代码分析<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/开源库分析/" title="开源库分析">开源库分析<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/树莓派/" title="树莓派">树莓派<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/版本控制/" title="版本控制">版本控制<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/直播/" title="直播">直播<sup>6</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/iOS-开源库分析/" title="iOS 开源库分析">iOS 开源库分析<sup>36</sup></a></li>
			
		
			
				<li><a href="/tags/Android-设计模式/" title="Android 设计模式">Android 设计模式<sup>29</sup></a></li>
			
		
			
				<li><a href="/tags/Objective-C-相关/" title="Objective C 相关">Objective C 相关<sup>24</sup></a></li>
			
		
			
				<li><a href="/tags/Android基础/" title="Android基础">Android基础<sup>21</sup></a></li>
			
		
			
				<li><a href="/tags/AOSP-源码/" title="AOSP 源码">AOSP 源码<sup>17</sup></a></li>
			
		
			
				<li><a href="/tags/Android-常用第三方库/" title="Android 常用第三方库">Android 常用第三方库<sup>15</sup></a></li>
			
		
			
				<li><a href="/tags/iOS-理论基础/" title="iOS 理论基础">iOS 理论基础<sup>14</sup></a></li>
			
		
			
				<li><a href="/tags/Hexo-使用/" title="Hexo 使用">Hexo 使用<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/ROS/" title="ROS">ROS<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/Android-动画进阶/" title="Android 动画进阶">Android 动画进阶<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/Android-JNI/" title="Android JNI">Android JNI<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android-绘图进阶/" title="Android 绘图进阶">Android 绘图进阶<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android性能优化/" title="Android性能优化">Android性能优化<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android-自动化测试/" title="Android 自动化测试">Android 自动化测试<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/OpenCV/" title="OpenCV">OpenCV<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/直播/" title="直播">直播<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android-开源源码/" title="Android 开源源码">Android 开源源码<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Android-自定义View进阶/" title="Android 自定义View进阶">Android 自定义View进阶<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/树莓派/" title="树莓派">树莓派<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/iOS-进阶/" title="iOS 进阶">iOS 进阶<sup>4</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="https://hexo.io" target="_blank" title="Hexo">Hexo</a>
            
          </li>
        
          <li>
            
            	<a href="https://pages.github.com/" target="_blank" title="GitHub">GitHub</a>
            
          </li>
        
          <li>
            
            	<a href="http://pf18.github.io/" target="_blank" title="PF18">PF18</a>
            
          </li>
        
          <li>
            
            	<a href="http://toutiao.io/" target="_blank" title="开发者头条">开发者头条</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.jcodecraeer.com/" target="_blank" title="泡在网上的日子">泡在网上的日子</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="atom.xml" target="_blank" title="rss">RSS</a>
</div>

  
  <div class="tagcloudlist">
    <p class="asidetitle">Tag Cloud</p>
    <div class="tagcloudlist clearfix">
       <a href="/tags/AOSP-%E6%BA%90%E7%A0%81/" style="font-size: 17.14px;">AOSP 源码</a> <a href="/tags/Android-APK-%E7%AD%BE%E5%90%8D/" style="font-size: 10px;">Android APK 签名</a> <a href="/tags/Android-JNI/" style="font-size: 12.86px;">Android JNI</a> <a href="/tags/Android-%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E8%BF%9B%E9%98%B6/" style="font-size: 10.71px;">Android 事件处理进阶</a> <a href="/tags/Android-%E5%8A%A8%E7%94%BB%E8%BF%9B%E9%98%B6/" style="font-size: 13.57px;">Android 动画进阶</a> <a href="/tags/Android-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%BC%80%E5%8F%91/" style="font-size: 10px;">Android 多线程开发</a> <a href="/tags/Android-%E5%B0%8F%E7%BB%8F%E9%AA%8C/" style="font-size: 10px;">Android 小经验</a> <a href="/tags/Android-%E5%B8%B8%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93/" style="font-size: 16.43px;">Android 常用第三方库</a> <a href="/tags/Android-%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B/" style="font-size: 10px;">Android 开发流程</a> <a href="/tags/Android-%E5%BC%80%E6%BA%90%E6%BA%90%E7%A0%81/" style="font-size: 12.14px;">Android 开源源码</a> <a href="/tags/Android-%E7%BB%98%E5%9B%BE%E8%BF%9B%E9%98%B6/" style="font-size: 12.86px;">Android 绘图进阶</a> <a href="/tags/Android-%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/" style="font-size: 12.86px;">Android 自动化测试</a> <a href="/tags/Android-%E8%87%AA%E5%AE%9A%E4%B9%89View%E8%BF%9B%E9%98%B6/" style="font-size: 12.14px;">Android 自定义View进阶</a> <a href="/tags/Android-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 19.29px;">Android 设计模式</a> <a href="/tags/Android%E5%85%B6%E4%BB%96/" style="font-size: 10px;">Android其他</a> <a href="/tags/Android%E5%9F%BA%E7%A1%80/" style="font-size: 17.86px;">Android基础</a> <a href="/tags/Android%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B/" style="font-size: 10px;">Android开发流程</a> <a href="/tags/Android%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" style="font-size: 12.86px;">Android性能优化</a> <a href="/tags/Android%E6%B7%B7%E6%B7%86%E6%8A%80%E6%9C%AF/" style="font-size: 10px;">Android混淆技术</a> <a href="/tags/Android%E8%B4%A8%E9%87%8F%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/" style="font-size: 11.43px;">Android质量管理工具</a> <a href="/tags/Android%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/" style="font-size: 10px;">Android逆向工程</a> <a href="/tags/Git-github/" style="font-size: 10px;">Git && github</a> <a href="/tags/Hexo-%E4%BD%BF%E7%94%A8/" style="font-size: 15px;">Hexo 使用</a> <a href="/tags/JavaScript/" style="font-size: 10px;">JavaScript</a> <a href="/tags/Linux-%E4%BD%BF%E7%94%A8/" style="font-size: 10px;">Linux 使用</a> <a href="/tags/Objective-C-%E7%9B%B8%E5%85%B3/" style="font-size: 18.57px;">Objective C 相关</a> <a href="/tags/OpenCV/" style="font-size: 12.86px;">OpenCV</a> <a href="/tags/ROS/" style="font-size: 14.29px;">ROS</a> <a href="/tags/iOS-%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/" style="font-size: 10.71px;">iOS 工具使用</a> <a href="/tags/iOS-%E5%BC%80%E6%BA%90%E5%BA%93%E5%88%86%E6%9E%90/" style="font-size: 20px;">iOS 开源库分析</a> <a href="/tags/iOS-%E7%90%86%E8%AE%BA%E5%9F%BA%E7%A1%80/" style="font-size: 15.71px;">iOS 理论基础</a> <a href="/tags/iOS-%E8%BF%9B%E9%98%B6/" style="font-size: 12.14px;">iOS 进阶</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83/" style="font-size: 10px;">代码规范</a> <a href="/tags/%E5%8D%9A%E5%AE%A2%E5%88%86%E7%B1%BB%E7%9B%AE%E5%BD%95/" style="font-size: 10.71px;">博客分类目录</a> <a href="/tags/%E5%8F%A8%E5%8F%A8%E7%B3%BB%E5%88%97/" style="font-size: 10px;">叨叨系列</a> <a href="/tags/%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8/" style="font-size: 11.43px;">工具的使用</a> <a href="/tags/%E5%BC%80%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/" style="font-size: 10.71px;">开源代码分析</a> <a href="/tags/%E5%BC%80%E6%BA%90%E5%BA%93%E5%88%86%E6%9E%90/" style="font-size: 10px;">开源库分析</a> <a href="/tags/%E6%9D%82%E7%B1%BB/" style="font-size: 10px;">杂类</a> <a href="/tags/%E6%A0%91%E8%8E%93%E6%B4%BE/" style="font-size: 12.14px;">树莓派</a> <a href="/tags/%E7%9B%B4%E6%92%AD/" style="font-size: 12.86px;">直播</a> <a href="/tags/%E7%BC%96%E7%A8%8B%E6%8A%80%E5%B7%A7/" style="font-size: 10.71px;">编程技巧</a> <a href="/tags/%E7%BD%91%E7%AB%99%E6%94%B6%E8%97%8F/" style="font-size: 10px;">网站收藏</a> <a href="/tags/%E9%87%8D%E8%A6%81%E6%8E%A7%E4%BB%B6/" style="font-size: 11.43px;">重要控件</a>
    </div>
  </div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
		
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/hsihohuang/kiddochan" target="_blank" title="Kiddochan">Kiddochan</a> © 2022 
		
		<a href="/about" target="_blank" title="Edgar">Edgar</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
        getSize();
        if (myWidth >= 1024) {
          c.click();
        }
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>




<script type="text/javascript">
  var duoshuoQuery = {short_name:"tbfungeek"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 


<script type="text/javascript">

var disqus_shortname = 'tbfungeek';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>






<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?7c9443b0374f1cf6b1dbb5ab84d939cb";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
