
 <!DOCTYPE HTML>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  
    <title>JSPatch 源码分析 | Edgar&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Edgar">
    

    
    <meta name="description" content="源码信息 JSPatch JSPatch Wiki JSPatch SDK JSPatchConvertor  JSPatch是iOS平台上的热修复方案，至于什么是热修复以及使用JSPatch是否会被苹果官方拒绝上架，这里不做介绍，这篇博客只关注JSPatch 源码本身。带大家过下JSPatch的源码。 源码解析用例情景 JSPatch核心代码很精简但是这不意味着简单，还是需要仔细啃才能够理解它的">
<meta property="og:type" content="article">
<meta property="og:title" content="JSPatch 源码分析">
<meta property="og:url" content="http://yoursite.com/2019/10/08/%E5%9B%BE%E8%A7%A3iOS%E7%B3%BB%E5%88%97%E4%B9%8BJSPatch-%E4%B8%80-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="Edgar&#39;s Blog">
<meta property="og:description" content="源码信息 JSPatch JSPatch Wiki JSPatch SDK JSPatchConvertor  JSPatch是iOS平台上的热修复方案，至于什么是热修复以及使用JSPatch是否会被苹果官方拒绝上架，这里不做介绍，这篇博客只关注JSPatch 源码本身。带大家过下JSPatch的源码。 源码解析用例情景 JSPatch核心代码很精简但是这不意味着简单，还是需要仔细啃才能够理解它的">
<meta property="og:locale">
<meta property="og:image" content="http://yoursite.com/2019/10/08/%E5%9B%BE%E8%A7%A3iOS%E7%B3%BB%E5%88%97%E4%B9%8BJSPatch-%E4%B8%80-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/001.png">
<meta property="article:published_time" content="2019-10-08T15:13:05.000Z">
<meta property="article:modified_time" content="2019-12-19T13:04:22.000Z">
<meta property="article:author" content="Edgar">
<meta property="article:tag" content="iOS 开源库分析">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/2019/10/08/%E5%9B%BE%E8%A7%A3iOS%E7%B3%BB%E5%88%97%E4%B9%8BJSPatch-%E4%B8%80-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/001.png">

    
    <link rel="alternative" href="atom.xml" title="Edgar&#39;s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/unnamed4_n_mSY_icon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/profile.png">
    <link rel="apple-touch-icon-precomposed" href="/img/profile.png">
    
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.2.0"></head>

  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Edgar&#39;s Blog">Edgar&#39;s Blog</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
					<li>
 					
					<form class="search" action="/search/index.html" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" autocomplete="off" name="q" maxlength="20" placeholder="Search" />
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/10/08/图解iOS系列之JSPatch-一-源码分析/" title="JSPatch 源码分析" itemprop="url">JSPatch 源码分析</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Edgar" target="_blank" itemprop="author">Edgar</a>
		
  <p class="article-time">
    <time datetime="2019-10-08T15:13:05.000Z" itemprop="datePublished"> Published 2019-10-08</time>
    
  </p>
</header>
	<div class="article-content">
		
		<h5 id="源码信息"><a href="#源码信息" class="headerlink" title="源码信息"></a>源码信息</h5><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/bang590/JSPatch">JSPatch</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/bang590/JSPatch/wiki">JSPatch Wiki</a></li>
<li><a target="_blank" rel="noopener" href="https://jspatch.com/">JSPatch SDK</a></li>
<li><a target="_blank" rel="noopener" href="http://bang590.github.io/JSPatchConvertor/">JSPatchConvertor</a></li>
</ul>
<p>JSPatch是iOS平台上的热修复方案，至于什么是热修复以及使用JSPatch是否会被苹果官方拒绝上架，这里不做介绍，这篇博客只关注JSPatch 源码本身。带大家过下JSPatch的源码。</p>
<h5 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h5><p><strong><strong>用例情景</strong></strong></p>
<p>JSPatch核心代码很精简但是这不意味着简单，还是需要仔细啃才能够理解它的思想。</p>
<p>我们先看下JSPatchDemo中的用法例子：</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">[JPEngine startEngine];</span><br><span class="line"><span class="built_in">NSString</span> *sourcePath = [[<span class="built_in">NSBundle</span> mainBundle] pathForResource:<span class="string">@&quot;demo&quot;</span> ofType:<span class="string">@&quot;js&quot;</span>];</span><br><span class="line"><span class="built_in">NSString</span> *script = [<span class="built_in">NSString</span> stringWithContentsOfFile:sourcePath encoding:<span class="built_in">NSUTF8StringEncoding</span> error:<span class="literal">nil</span>];[JPEngine evaluateScript:script];</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p>在例子中首先启动JPEngine，紧接着会去加载本地的demo.js。然后在JPEngine中执行本地的demo.js脚本。</p>
<p>我们看下原先的RootViewController <strong><strong>JPViewController</strong></strong>:</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="meta">#import <span class="string">&quot;JPViewController.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">JPViewController</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="variable language_">super</span> viewDidLoad];</span><br><span class="line">    <span class="built_in">UIButton</span> *btn = [[<span class="built_in">UIButton</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">100</span>, [<span class="built_in">UIScreen</span> mainScreen].bounds.size.width, <span class="number">50</span>)];</span><br><span class="line">    [btn setTitle:<span class="string">@&quot;Push JPTableViewController&quot;</span> forState:<span class="built_in">UIControlStateNormal</span>];</span><br><span class="line">    [btn addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(handleBtn:) forControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>];</span><br><span class="line">    [btn setBackgroundColor:[<span class="built_in">UIColor</span> grayColor]];</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:btn];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)handleBtn:(<span class="type">id</span>)sender &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>整个界面上有一个按钮，点击它会执行handleBtn方法，但是handleBtn目前是一个空方法，但是如果你将整个demo项目跑起来后会发现点击的时候会弹出一个TableView。但是如果注释掉之前将的JPEngine相关代码，点击就不会有任何响应，所以可以确定是JPEngine搞的鬼。我们看下demo.js:</p>
<figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line">defineClass(&#x27;JPViewController&#x27;, &#123;</span><br><span class="line">  handleBtn: function(<span class="name">sender</span>) &#123;</span><br><span class="line">    var tableViewCtrl = JPTableViewController.alloc().init()</span><br><span class="line">    self.navigationController().pushViewController_animated(<span class="name">tableViewCtrl</span>, YES)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">defineClass(&#x27;JPTableViewController : UITableViewController &lt;UIAlertViewDelegate&gt;&#x27;, [&#x27;data&#x27;], &#123;</span><br><span class="line">  dataSource: function() &#123;</span><br><span class="line">    var data = self.data()<span class="comment">;</span></span><br><span class="line">    if (<span class="name">data</span>) return data<span class="comment">;</span></span><br><span class="line">    var data = []<span class="comment">;</span></span><br><span class="line">    for (<span class="name">var</span> i = <span class="number">0</span><span class="comment">; i &lt; 20; i ++) &#123;</span></span><br><span class="line">      data.push(<span class="string">&quot;cell from js &quot;</span> + i)<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line">    self.setData(<span class="name">data</span>)</span><br><span class="line">    return data<span class="comment">;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  numberOfSectionsInTableView: function(<span class="name">tableView</span>) &#123;</span><br><span class="line">    return <span class="number">1</span><span class="comment">;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  tableView_numberOfRowsInSection: function(<span class="name">tableView</span>, section) &#123;</span><br><span class="line">    return self.dataSource().length<span class="comment">;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  tableView_cellForRowAtIndexPath: function(<span class="name">tableView</span>, indexPath) &#123;</span><br><span class="line">    var cell = tableView.dequeueReusableCellWithIdentifier(<span class="string">&quot;cell&quot;</span>) </span><br><span class="line">    if (!cell) &#123;</span><br><span class="line">      cell = require(&#x27;UITableViewCell&#x27;).alloc().initWithStyle_reuseIdentifier(<span class="number">0</span>, <span class="string">&quot;cell&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    cell.textLabel().setText(<span class="name">self</span>.dataSource()[indexPath.row()])</span><br><span class="line">    return cell</span><br><span class="line">  &#125;,</span><br><span class="line">  tableView_heightForRowAtIndexPath: function(<span class="name">tableView</span>, indexPath) &#123;</span><br><span class="line">    return <span class="number">60</span></span><br><span class="line">  &#125;,</span><br><span class="line">  tableView_didSelectRowAtIndexPath: function(<span class="name">tableView</span>, indexPath) &#123;</span><br><span class="line">     var alertView = require(&#x27;UIAlertView&#x27;).alloc().initWithTitle_message_delegate_cancelButtonTitle_otherButtonTitles(<span class="string">&quot;Alert&quot;</span>,self.dataSource()[indexPath.row()], self, <span class="string">&quot;OK&quot;</span>,  null)<span class="comment">;</span></span><br><span class="line">     alertView.show()</span><br><span class="line">  &#125;,</span><br><span class="line">  alertView_willDismissWithButtonIndex: function(<span class="name">alertView</span>, idx) &#123;</span><br><span class="line">    console.log(&#x27;click btn &#x27; + alertView.buttonTitleAtIndex(<span class="name">idx</span>).toJS())</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>即使你不懂JavaScript 看到上面的代码估计也可以猜出个大概，它重写了handleBtn方法，在点击的时候会push一个JPTableViewController页面。并且使用JavaScript语言实现了JPTableViewController。也就是说它可以通过动态加载一个js文件，并且在这个js文件中改变现有代码的行为。既然本地的js文件也是需要转换为string后放到JSPatchEngine引擎中执行，如果将这个文件放到服务端下发下去，那么就可以通过后台动态控制我们应用的行为了，是不是很诱人的功能，当然我们不会将它用于实现大需求，一般如果用于修修线上的一些紧急bug还是比较方便的，特别是苹果平台审核周期有时候会比较长。这种情况如果遇到线上的一些崩溃没有热修复，只能和苹果官方沟通来缩短审核的时间，紧急发布修复版本。</p>
<p><strong><strong>JSPatch 引擎初始化</strong></strong></p>
<figure class="highlight wren"><table><tr><td class="code"><pre><span class="line"><span class="operator">+</span> (<span class="variable">void</span>)<span class="title function_">startEngine</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.判断是否存在 JSContext 类. ---&gt; iOS 7.0 以下不支持 JavaScriptCore</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="operator">!</span>[<span class="title class_">JSContext</span> <span class="keyword">class</span>] <span class="operator">||</span> <span class="variable">_context</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//2.创建一个 JS 运行环境.</span></span><br><span class="line">    <span class="title class_">JSContext</span> <span class="operator">*</span><span class="variable">context</span> <span class="operator">=</span> [[<span class="title class_">JSContext</span> <span class="variable">alloc</span>] init];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//3.为了使 JSPatch.js 可以访问 JPEngine 中定义的 C 函数，需为 context 注册 block.</span></span><br><span class="line">    <span class="comment">//3.1 创建类.</span></span><br><span class="line">    <span class="variable">context</span>[@<span class="string">&quot;_OC_defineClass&quot;</span>] <span class="operator">=</span> <span class="title function_">^</span>(<span class="params">NSString</span> *<span class="params">classDeclaration</span>, <span class="params">JSValue</span> *<span class="params">instanceMethods</span>, <span class="params">JSValue</span> *<span class="params">classMethods</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">defineClass</span>(classDeclaration, instanceMethods, classMethods);</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//3.2 类实现某协议.</span></span><br><span class="line">    <span class="variable">context</span>[@<span class="string">&quot;_OC_defineProtocol&quot;</span>] <span class="operator">=</span> <span class="title function_">^</span>(<span class="params">NSString</span> *<span class="params">protocolDeclaration</span>, <span class="params">JSValue</span> *<span class="params">instProtocol</span>, <span class="params">JSValue</span> *<span class="params">clsProtocol</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">defineProtocol</span>(<span class="variable">protocolDeclaration</span>, instProtocol,<span class="variable">clsProtocol</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//3.3 js调用oc的实例方法.</span></span><br><span class="line">    <span class="variable">context</span>[@<span class="string">&quot;_OC_callI&quot;</span>] <span class="operator">=</span> <span class="operator">^</span><span class="title function_">id</span>(<span class="params">JSValue</span> *<span class="params">obj</span>, <span class="params">NSString</span> *<span class="params">selectorName</span>, <span class="params">JSValue</span> *<span class="params">arguments</span>, <span class="params">BOOL</span> <span class="params">isSuper</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">callSelector</span>(<span class="variable">nil</span>, <span class="variable">selectorName</span>, <span class="variable">arguments</span>, <span class="variable">obj</span>, isSuper);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.4 js调用oc的类方法.</span></span><br><span class="line">    <span class="variable">context</span>[@<span class="string">&quot;_OC_callC&quot;</span>] <span class="operator">=</span> <span class="operator">^</span><span class="title function_">id</span>(<span class="params">NSString</span> *<span class="params">className</span>, <span class="params">NSString</span> *<span class="params">selectorName</span>, <span class="params">JSValue</span> *<span class="params">arguments</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">callSelector</span>(className, <span class="variable">selectorName</span>, <span class="variable">arguments</span>, <span class="variable">nil</span>, <span class="variable">NO</span>);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.5 js 对象转 oc 对象.</span></span><br><span class="line">    <span class="variable">context</span>[@<span class="string">&quot;_OC_formatJSToOC&quot;</span>] <span class="operator">=</span> <span class="operator">^</span><span class="title function_">id</span>(<span class="params">JSValue</span> *<span class="params">obj</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">formatJSToOC</span>(<span class="variable">obj</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//3.6 oc 对象 转 js 对象.</span></span><br><span class="line">    <span class="variable">context</span>[@<span class="string">&quot;_OC_formatOCToJS&quot;</span>] <span class="operator">=</span> <span class="operator">^</span><span class="title function_">id</span>(<span class="params">JSValue</span> *<span class="params">obj</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">formatOCToJS</span>([<span class="variable">obj</span> <span class="variable">toObject</span>]);</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//3.7 获取对象的关联属性</span></span><br><span class="line">    <span class="variable">context</span>[@<span class="string">&quot;_OC_getCustomProps&quot;</span>] <span class="operator">=</span> <span class="operator">^</span><span class="title function_">id</span>(<span class="params">JSValue</span> *<span class="params">obj</span>) &#123;</span><br><span class="line">        <span class="variable">id</span> <span class="variable">realObj</span> <span class="operator">=</span> <span class="title function_">formatJSToOC</span>(<span class="variable">obj</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">objc_getAssociatedObject</span>(<span class="variable">realObj</span>, <span class="variable">kPropAssociatedObjectKey</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3.8 给对象动态添加关联属性</span></span><br><span class="line">    <span class="variable">context</span>[@<span class="string">&quot;_OC_setCustomProps&quot;</span>] <span class="operator">=</span> <span class="title function_">^</span>(<span class="params">JSValue</span> *<span class="params">obj</span>, <span class="params">JSValue</span> *<span class="params">val</span>) &#123;</span><br><span class="line">        <span class="variable">id</span> <span class="variable">realObj</span> <span class="operator">=</span> <span class="title function_">formatJSToOC</span>(<span class="variable">obj</span>);</span><br><span class="line">        <span class="title function_">objc_setAssociatedObject</span>(<span class="variable">realObj</span>, <span class="variable">kPropAssociatedObjectKey</span>, <span class="variable">val</span>, <span class="variable">OBJC_ASSOCIATION_RETAIN_NONATOMIC</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//3.9 给 js 对象设置 weak.</span></span><br><span class="line">    <span class="variable">context</span>[@<span class="string">&quot;__weak&quot;</span>] <span class="operator">=</span> <span class="operator">^</span><span class="title function_">id</span>(<span class="params">JSValue</span> *<span class="params">jsval</span>) &#123;</span><br><span class="line">        <span class="variable">id</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="title function_">formatJSToOC</span>(<span class="variable">jsval</span>);</span><br><span class="line">        <span class="keyword">return</span> [[<span class="title class_">JSContext</span> <span class="variable">currentContext</span>][@<span class="string">&quot;_formatOCToJS&quot;</span>] <span class="variable">callWithArguments</span>:@[<span class="title function_">formatOCToJS</span>([<span class="title class_">JPBoxing</span> <span class="variable">boxWeakObj</span>:<span class="variable">obj</span>])]];</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.10 给 js 对象设置 strong.</span></span><br><span class="line">    <span class="variable">context</span>[@<span class="string">&quot;__strong&quot;</span>] <span class="operator">=</span> <span class="operator">^</span><span class="title function_">id</span>(<span class="params">JSValue</span> *<span class="params">jsval</span>) &#123;</span><br><span class="line">        <span class="variable">id</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="title function_">formatJSToOC</span>(<span class="variable">jsval</span>);</span><br><span class="line">        <span class="keyword">return</span> [[<span class="title class_">JSContext</span> <span class="variable">currentContext</span>][@<span class="string">&quot;_formatOCToJS&quot;</span>] <span class="variable">callWithArguments</span>:@[<span class="title function_">formatOCToJS</span>(<span class="variable">obj</span>)]];</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//3.11 获取 oc 对象的父类.</span></span><br><span class="line">    <span class="variable">context</span>[@<span class="string">&quot;_OC_superClsName&quot;</span>] <span class="operator">=</span> <span class="title function_">^</span>(<span class="params">NSString</span> *<span class="params">clsName</span>) &#123;</span><br><span class="line">        <span class="title class_">Class</span> <span class="variable">cls</span> <span class="operator">=</span> <span class="title class_">NSClassFromString</span>(<span class="variable">clsName</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">NSStringFromClass</span>([<span class="variable">cls</span> superclass]);</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//3.12 是否自动转换类型.</span></span><br><span class="line">    <span class="variable">context</span>[@<span class="string">&quot;autoConvertOCType&quot;</span>] <span class="operator">=</span> <span class="title function_">^</span>(<span class="params">BOOL</span> <span class="params">autoConvert</span>) &#123;</span><br><span class="line">        <span class="variable">_autoConvert</span> <span class="operator">=</span> <span class="variable">autoConvert</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.13 oc number 转换为 string.</span></span><br><span class="line">    <span class="variable">context</span>[@<span class="string">&quot;convertOCNumberToString&quot;</span>] <span class="operator">=</span> <span class="title function_">^</span>(<span class="params">BOOL</span> <span class="params">convertOCNumberToString</span>) &#123;</span><br><span class="line">        <span class="variable">_convertOCNumberToString</span> <span class="operator">=</span> <span class="variable">convertOCNumberToString</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//3.14 在JS中调用include方法,可以在一个JS文件中加载其他JS文件.</span></span><br><span class="line">    <span class="variable">context</span>[@<span class="string">&quot;include&quot;</span>] <span class="operator">=</span> <span class="title function_">^</span>(<span class="params">NSString</span> *<span class="params">filePath</span>) &#123;</span><br><span class="line">        <span class="title class_">NSString</span> <span class="operator">*</span><span class="variable">absolutePath</span> <span class="operator">=</span> [<span class="variable">_scriptRootDir</span> <span class="variable">stringByAppendingPathComponent</span>:<span class="variable">filePath</span>];</span><br><span class="line">        <span class="keyword">if</span> (<span class="operator">!</span><span class="variable">_runnedScript</span>) &#123;</span><br><span class="line">            <span class="variable">_runnedScript</span> <span class="operator">=</span> [[<span class="title class_">NSMutableSet</span> <span class="variable">alloc</span>] init];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">absolutePath</span> <span class="operator">&amp;&amp;</span> <span class="operator">!</span>[<span class="variable">_runnedScript</span> <span class="variable">containsObject</span>:<span class="variable">absolutePath</span>]) &#123;</span><br><span class="line">            [<span class="title class_">JPEngine</span> <span class="variable">_evaluateScriptWithPath</span>:<span class="variable">absolutePath</span>];</span><br><span class="line">            [<span class="variable">_runnedScript</span> <span class="variable">addObject</span>:<span class="variable">absolutePath</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//3.15 获取资源文件路径.</span></span><br><span class="line">    <span class="variable">context</span>[@<span class="string">&quot;resourcePath&quot;</span>] <span class="operator">=</span> <span class="title function_">^</span>(<span class="params">NSString</span> *<span class="params">filePath</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="variable">_scriptRootDir</span> <span class="variable">stringByAppendingPathComponent</span>:<span class="variable">filePath</span>];</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.16 让 js 方法延迟执行.</span></span><br><span class="line">    <span class="variable">context</span>[@<span class="string">&quot;dispatch_after&quot;</span>] <span class="operator">=</span> <span class="title function_">^</span>(<span class="params">double</span> <span class="params">time</span>, <span class="params">JSValue</span> *<span class="params">func</span>) &#123;</span><br><span class="line">        <span class="title function_">dispatch_after</span>(<span class="title function_">dispatch_time</span>(<span class="variable">DISPATCH_TIME_NOW</span>, (int64_t)(<span class="variable">time</span> <span class="operator">*</span> <span class="variable">NSEC_PER_SEC</span>)), <span class="title function_">dispatch_get_main_queue</span>(), <span class="operator">^</span>&#123;</span><br><span class="line">            [<span class="variable">func</span> <span class="variable">callWithArguments</span>:<span class="variable">nil</span>];</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//3.17 让js方法在 main queue dispatch async 执行.</span></span><br><span class="line">    <span class="variable">context</span>[@<span class="string">&quot;dispatch_async_main&quot;</span>] <span class="operator">=</span> <span class="title function_">^</span>(<span class="params">JSValue</span> *<span class="params">func</span>) &#123;</span><br><span class="line">        <span class="title function_">dispatch_async</span>(<span class="title function_">dispatch_get_main_queue</span>(), <span class="operator">^</span>&#123;</span><br><span class="line">            [<span class="variable">func</span> <span class="variable">callWithArguments</span>:<span class="variable">nil</span>];</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3.18 让js方法在 main queue dispatch sync 执行.</span></span><br><span class="line">    <span class="variable">context</span>[@<span class="string">&quot;dispatch_sync_main&quot;</span>] <span class="operator">=</span> <span class="title function_">^</span>(<span class="params">JSValue</span> *<span class="params">func</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([<span class="title class_">NSThread</span> <span class="variable">currentThread</span>].<span class="property">isMainThread</span>) &#123;</span><br><span class="line">            [<span class="variable">func</span> <span class="variable">callWithArguments</span>:<span class="variable">nil</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_">dispatch_sync</span>(<span class="title function_">dispatch_get_main_queue</span>(), <span class="operator">^</span>&#123;</span><br><span class="line">                [<span class="variable">func</span> <span class="variable">callWithArguments</span>:<span class="variable">nil</span>];</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//3.19 让js方法在 global queue dispatch async 执行.</span></span><br><span class="line">    <span class="variable">context</span>[@<span class="string">&quot;dispatch_async_global_queue&quot;</span>] <span class="operator">=</span> <span class="title function_">^</span>(<span class="params">JSValue</span> *<span class="params">func</span>) &#123;</span><br><span class="line">        <span class="title function_">dispatch_async</span>(<span class="title function_">dispatch_get_global_queue</span>(<span class="number">0</span>, <span class="number">0</span>), <span class="operator">^</span>&#123;</span><br><span class="line">            [<span class="variable">func</span> <span class="variable">callWithArguments</span>:<span class="variable">nil</span>];</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//3.20 释放js创建的oc对象.</span></span><br><span class="line">    <span class="variable">context</span>[@<span class="string">&quot;releaseTmpObj&quot;</span>] <span class="operator">=</span> <span class="operator">^</span><span class="title function_">void</span>(<span class="params">JSValue</span> *<span class="params">jsVal</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([[<span class="variable">jsVal</span> <span class="variable">toObject</span>] isKindOfClass:[<span class="title class_">NSDictionary</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">            <span class="variable">void</span> <span class="operator">*</span><span class="variable">pointer</span> <span class="operator">=</span>  [(<span class="title class_">JPBoxing</span> <span class="operator">*</span>)([<span class="variable">jsVal</span> <span class="variable">toObject</span>][@<span class="string">&quot;__obj&quot;</span>]) <span class="variable">unboxPointer</span>];</span><br><span class="line">            <span class="variable">id</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="operator">*</span>((<span class="variable">__unsafe_unretained</span> <span class="variable">id</span> <span class="operator">*</span>)<span class="variable">pointer</span>);</span><br><span class="line">            @<span class="title function_">synchronized</span>(_<span class="params">TMPMemoryPool</span>) &#123;</span><br><span class="line">                [<span class="variable">_TMPMemoryPool</span> <span class="variable">removeObjectForKey</span>:[<span class="title class_">NSNumber</span> <span class="variable">numberWithInteger</span>:[(<span class="title class_">NSObject</span><span class="operator">*</span>)<span class="variable">obj</span> <span class="variable">hash</span>]]];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//3.21 js调用oc方法进行打印.</span></span><br><span class="line">    <span class="variable">context</span>[@<span class="string">&quot;_OC_log&quot;</span>] <span class="operator">=</span> <span class="operator">^</span>() &#123;</span><br><span class="line">        <span class="title class_">NSArray</span> <span class="operator">*</span><span class="variable">args</span> <span class="operator">=</span> [<span class="title class_">JSContext</span> <span class="variable">currentArguments</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="title class_">JSValue</span> <span class="operator">*</span><span class="variable">jsVal</span> <span class="keyword">in</span> <span class="variable">args</span>) &#123;</span><br><span class="line">            <span class="variable">id</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="title function_">formatJSToOC</span>(<span class="variable">jsVal</span>);</span><br><span class="line">            <span class="title class_">NSLog</span>(@<span class="string">&quot;JSPatch.log: %@&quot;</span>, <span class="variable">obj</span> <span class="operator">==</span> <span class="variable">_nilObj</span> ? <span class="variable">nil</span> : (<span class="variable">obj</span> <span class="operator">==</span> <span class="variable">_nullObj</span> ? [<span class="title class_">NSNull</span> <span class="literal">null</span>]: <span class="variable">obj</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//3.22 将js捕捉到的异常交给oc方法处理.</span></span><br><span class="line">    <span class="variable">context</span>[@<span class="string">&quot;_OC_catch&quot;</span>] <span class="operator">=</span> <span class="title function_">^</span>(<span class="params">JSValue</span> *<span class="params">msg</span>, <span class="params">JSValue</span> *<span class="params">stack</span>) &#123;</span><br><span class="line">        <span class="variable">_exceptionBlock</span>([<span class="title class_">NSString</span> <span class="variable">stringWithFormat</span>:@<span class="string">&quot;js exception, <span class="char escape_">\n</span>msg: %@, <span class="char escape_">\n</span>stack: <span class="char escape_">\n</span> %@&quot;</span>, [<span class="variable">msg</span> <span class="variable">toObject</span>], [<span class="variable">stack</span> <span class="variable">toObject</span>]]);</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//4. 注册 JSContext 执行出现异常时的回调.</span></span><br><span class="line">    <span class="variable">context</span>.<span class="property">exceptionHandler</span> <span class="operator">=</span> <span class="title function_">^</span>(<span class="params">JSContext</span> *<span class="params">con</span>, <span class="params">JSValue</span> *<span class="params">exception</span>) &#123;</span><br><span class="line">        <span class="title class_">NSLog</span>(@<span class="string">&quot;%@&quot;</span>, <span class="variable">exception</span>);</span><br><span class="line">        <span class="variable">_exceptionBlock</span>([<span class="title class_">NSString</span> <span class="variable">stringWithFormat</span>:@<span class="string">&quot;js exception: %@&quot;</span>, <span class="variable">exception</span>]);</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//5. 创建OC中的null对象，转换成js的null对象，并设置到JSContext实例让js代码可以获取.</span></span><br><span class="line">    <span class="variable">_nullObj</span> <span class="operator">=</span> [[<span class="title class_">NSObject</span> <span class="variable">alloc</span>] init];</span><br><span class="line">    <span class="variable">context</span>[@<span class="string">&quot;_OC_null&quot;</span>] <span class="operator">=</span> <span class="title function_">formatOCToJS</span>(<span class="variable">_nullObj</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//6. 保存 context.</span></span><br><span class="line">    <span class="variable">_context</span> <span class="operator">=</span> <span class="variable">context</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//7. oc 中的 nil 对象.</span></span><br><span class="line">    <span class="variable">_nilObj</span> <span class="operator">=</span> [[<span class="title class_">NSObject</span> <span class="variable">alloc</span>] init];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//8. 同步锁.</span></span><br><span class="line">    <span class="variable">_JSMethodSignatureLock</span> <span class="operator">=</span> [[<span class="title class_">NSLock</span> <span class="variable">alloc</span>] init];</span><br><span class="line">    <span class="variable">_JSMethodForwardCallLock</span> <span class="operator">=</span> [[<span class="title class_">NSRecursiveLock</span> <span class="variable">alloc</span>] init];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//9. 在 JSPatch 中注册过的结构体定义（键：结构体名）.</span></span><br><span class="line">    <span class="variable">_registeredStruct</span> <span class="operator">=</span> [[<span class="title class_">NSMutableDictionary</span> <span class="variable">alloc</span>] init];</span><br><span class="line">    <span class="variable">_currInvokeSuperClsName</span> <span class="operator">=</span> [[<span class="title class_">NSMutableDictionary</span> <span class="variable">alloc</span>] init];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//10. 注册内存警告通知.</span></span><br><span class="line">    [[<span class="title class_">NSNotificationCenter</span> <span class="variable">defaultCenter</span>] <span class="variable">addObserver</span>:<span class="variable">self</span> <span class="variable">selector</span>:@<span class="title function_">selector</span>(<span class="variable">handleMemoryWarning</span>) <span class="variable">name</span>:<span class="title class_">UIApplicationDidReceiveMemoryWarningNotification</span> <span class="variable">object</span>:<span class="variable">nil</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//11. 读取JSPatch.js，方便传入的js代码中使用JSPatch.js提供的函数.</span></span><br><span class="line">    <span class="title class_">NSString</span> <span class="operator">*</span><span class="variable">path</span> <span class="operator">=</span> [[<span class="title class_">NSBundle</span> <span class="variable">bundleForClass</span>:[<span class="variable">self</span> <span class="keyword">class</span>]] <span class="variable">pathForResource</span>:@<span class="string">&quot;JSPatch&quot;</span> <span class="variable">ofType</span>:@<span class="string">&quot;js&quot;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="operator">!</span><span class="variable">path</span>) <span class="variable">_exceptionBlock</span>(@<span class="string">&quot;can&#x27;t find JSPatch.js&quot;</span>);</span><br><span class="line">    <span class="title class_">NSString</span> <span class="operator">*</span><span class="variable">jsCore</span> <span class="operator">=</span> [[<span class="title class_">NSString</span> <span class="variable">alloc</span>] initWithData:[[<span class="title class_">NSFileManager</span> <span class="variable">defaultManager</span>] <span class="variable">contentsAtPath</span>:<span class="variable">path</span>] <span class="variable">encoding</span>:<span class="variable">NSUTF8StringEncoding</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//12. 加载 JSPatch.js 中的所有 js 代码到JSContext.</span></span><br><span class="line">    <span class="keyword">if</span> ([<span class="variable">_context</span> <span class="variable">respondsToSelector</span>:@<span class="title function_">selector</span>(<span class="variable">evaluateScript</span>:<span class="variable">withSourceURL</span>:)]) &#123;</span><br><span class="line">        [<span class="variable">_context</span> <span class="variable">evaluateScript</span>:<span class="variable">jsCore</span> <span class="variable">withSourceURL</span>:[<span class="variable">NSURL</span> <span class="title class_">URLWithString</span>:@<span class="string">&quot;JSPatch.js&quot;</span>]];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [<span class="variable">_context</span> <span class="variable">evaluateScript</span>:<span class="variable">jsCore</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于JSPatch是基于JavaScriptCore的所以在进行JSPatch 引擎初始化的时候会先检查下当前系统中是否支持JavaScriptCore。iOS 7.0 以下不支持 JavaScriptCore 所以在iOS 7.0 以下调用startEngine不会继续执行，直接返回。否则会创建一个JSContext并开始往JSContext里面注册对应的block，这些block会在JSPatch.js 中被调用。然后会注册JSContext 执行出现异常时的回调.最后会加载 JSPatch.js 中的所有 js 代码到JSContext 运行。</p>
<p>在JSPatch.js中会向gloable环境下添加defineClass，require，defineProtocol，block，defineJSClass 这些方法，这些方法可以供我们在热修复js文件中调用。</p>
<p>我们再回到demo.js:</p>
<figure class="highlight zephir"><table><tr><td class="code"><pre><span class="line">defineClass(<span class="string">&#x27;JPTableViewController : UITableViewController &lt;UIAlertViewDelegate&gt;&#x27;</span>, [<span class="string">&#x27;data&#x27;</span>], &#123;</span><br><span class="line">  dataSource: <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> data = <span class="keyword">self</span>.data();</span><br><span class="line">    <span class="keyword">if</span> (data) <span class="keyword">return</span> data;</span><br><span class="line">    <span class="keyword">var</span> data = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i ++) &#123;</span><br><span class="line">      data.push(<span class="string">&quot;cell from js &quot;</span> + i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">self</span>.setData(data)</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">  &#125;,</span><br><span class="line">  numberOfSectionsInTableView: <span class="function"><span class="keyword">function</span><span class="params">(tableView)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  tableView_numberOfRowsInSection: <span class="function"><span class="keyword">function</span><span class="params">(tableView, section)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.dataSource().length;</span><br><span class="line">  &#125;,</span><br><span class="line">  tableView_cellForRowAtIndexPath: <span class="function"><span class="keyword">function</span><span class="params">(tableView, indexPath)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> cell = tableView.dequeueReusableCellWithIdentifier(<span class="string">&quot;cell&quot;</span>) </span><br><span class="line">    <span class="keyword">if</span> (!cell) &#123;</span><br><span class="line">      cell = <span class="keyword">require</span>(<span class="string">&#x27;UITableViewCell&#x27;</span>).alloc().initWithStyle_reuseIdentifier(<span class="number">0</span>, <span class="string">&quot;cell&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    cell.textLabel().setText(<span class="keyword">self</span>.dataSource()[indexPath.row()])</span><br><span class="line">    <span class="keyword">return</span> cell</span><br><span class="line">  &#125;,</span><br><span class="line">  tableView_heightForRowAtIndexPath: <span class="function"><span class="keyword">function</span><span class="params">(tableView, indexPath)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">60</span></span><br><span class="line">  &#125;,</span><br><span class="line">  tableView_didSelectRowAtIndexPath: <span class="function"><span class="keyword">function</span><span class="params">(tableView, indexPath)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">var</span> alertView = <span class="keyword">require</span>(<span class="string">&#x27;UIAlertView&#x27;</span>).alloc().initWithTitle_message_delegate_cancelButtonTitle_otherButtonTitles(<span class="string">&quot;Alert&quot;</span>,<span class="keyword">self</span>.dataSource()[indexPath.row()], <span class="keyword">self</span>, <span class="string">&quot;OK&quot;</span>,  <span class="keyword">null</span>);</span><br><span class="line">     alertView.show()</span><br><span class="line">  &#125;,</span><br><span class="line">  alertView_willDismissWithButtonIndex: <span class="function"><span class="keyword">function</span><span class="params">(alertView, idx)</span> </span>&#123;</span><br><span class="line">    console.log(<span class="string">&#x27;click btn &#x27;</span> + alertView.buttonTitleAtIndex(idx).toJS())</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>上面的defineClass有三个参数，第一个参数是类定义的字符串，第二个[‘data’]代表的是一个类的属性列表，这里只有一个属性参数data。第三个参数是这个类的实例方法列表。</p>
<figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line">global.defineClass = function(declaration<span class="comment">/*定义字符串*/</span>, properties<span class="comment">/*属性*/</span>, instMethods<span class="comment">/*实例方法*/</span>, clsMethods<span class="comment">/*类方法*/</span>) &#123;</span><br><span class="line">    var newInstMethods = &#123;&#125;<span class="comment">/*用于存放新的实例方法*/</span>, newClsMethods = &#123;&#125;<span class="comment">/*用于存放新的类方法*/</span></span><br><span class="line">    <span class="keyword">if</span> (!(properties instanceof Array)) &#123;</span><br><span class="line">      clsMethods = instMethods</span><br><span class="line">      instMethods = properties</span><br><span class="line">      properties = null</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (properties) &#123;</span><br><span class="line">      <span class="comment">//为属性添加Getter/Setter方法</span></span><br><span class="line">      properties.<span class="keyword">forEach</span>(function(<span class="built_in">name</span>)&#123;</span><br><span class="line">        <span class="comment">//在instMethods中添加属性的get方法</span></span><br><span class="line">        <span class="keyword">if</span> (!instMethods[<span class="built_in">name</span>]) &#123;</span><br><span class="line">          instMethods[<span class="built_in">name</span>] = <span class="variable">_propertiesGetFun</span>(<span class="built_in">name</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//在instMethods中添加属性的set方法</span></span><br><span class="line">        var nameOfSet = <span class="string">&quot;set&quot;</span>+ <span class="built_in">name</span>.substr(<span class="number">0</span>,<span class="number">1</span>).toUpperCase() + <span class="built_in">name</span>.substr(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (!instMethods[nameOfSet]) &#123;</span><br><span class="line">          instMethods[nameOfSet] = <span class="variable">_propertiesSetFun</span>(<span class="built_in">name</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//取出实际类名</span></span><br><span class="line">    var realClsName = declaration.split(<span class="string">&#x27;:&#x27;</span>)[<span class="number">0</span>].<span class="built_in">trim</span>()</span><br><span class="line">  </span><br><span class="line">    <span class="comment">//将实例方法和类方法 都转化为 key:方法名 [参数个数:方法实现]的形式 存放在newInstMethods，newClsMethods</span></span><br><span class="line">    <span class="variable">_formatDefineMethods</span>(instMethods, newInstMethods, realClsName)</span><br><span class="line">    <span class="variable">_formatDefineMethods</span>(clsMethods, newClsMethods, realClsName)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//调用OC的defineClass 进行定义</span></span><br><span class="line">    var ret = <span class="variable">_OC_defineClass</span>(declaration, newInstMethods, newClsMethods)</span><br><span class="line">    var <span class="built_in">className</span> = ret[<span class="string">&#x27;cls&#x27;</span>]</span><br><span class="line">    var superCls = ret[<span class="string">&#x27;superCls&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="variable">_ocCls</span>[<span class="built_in">className</span>] = &#123;</span><br><span class="line">      instMethods: &#123;&#125;,</span><br><span class="line">      clsMethods: &#123;&#125;,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (superCls.length &amp;&amp; <span class="variable">_ocCls</span>[superCls]) &#123;</span><br><span class="line">      <span class="keyword">for</span> (var funcName <span class="built_in">in</span> <span class="variable">_ocCls</span>[superCls][<span class="string">&#x27;instMethods&#x27;</span>]) &#123;</span><br><span class="line">        <span class="variable">_ocCls</span>[<span class="built_in">className</span>][<span class="string">&#x27;instMethods&#x27;</span>][funcName] = <span class="variable">_ocCls</span>[superCls][<span class="string">&#x27;instMethods&#x27;</span>][funcName]</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span> (var funcName <span class="built_in">in</span> <span class="variable">_ocCls</span>[superCls][<span class="string">&#x27;clsMethods&#x27;</span>]) &#123;</span><br><span class="line">        <span class="variable">_ocCls</span>[<span class="built_in">className</span>][<span class="string">&#x27;clsMethods&#x27;</span>][funcName] = <span class="variable">_ocCls</span>[superCls][<span class="string">&#x27;clsMethods&#x27;</span>][funcName]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//将自定义的js热修复代码添加到js环境</span></span><br><span class="line">    <span class="variable">_setupJSMethod</span>(<span class="built_in">className</span>, instMethods, <span class="number">1</span>, realClsName)</span><br><span class="line">    <span class="variable">_setupJSMethod</span>(<span class="built_in">className</span>, clsMethods, <span class="number">0</span>, realClsName)</span><br><span class="line"></span><br><span class="line">    return require(<span class="built_in">className</span>)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>JSPatch.js 的defineClass方法中会调用 JSEngine startEngine方法中向JSContext注入的_OC_defineClass block。传入的是这个类的定义，以及实例方法，类方法。其中实例方法和类方法的结构如下：</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">key</span>:方法名<span class="meta"> [参数个数:方法实现]</span></span><br></pre></td></tr></table></figure>

<p>我们先来看下_OC_defineClass再回过来看JSPatch.js</p>
<figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line"><span class="built_in">context</span>[@<span class="string">&quot;_OC_defineClass&quot;</span>] = ^(NSString *classDeclaration, <span class="keyword">JSValue </span>*<span class="keyword">instanceMethods, </span><span class="keyword">JSValue </span>*classMethods) &#123;</span><br><span class="line">    return defineClass(classDeclaration, <span class="keyword">instanceMethods, </span>classMethods);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">static NSDictionary *define<span class="constructor">Class(NSString <span class="operator">*</span><span class="params">classDeclaration</span>, JSValue <span class="operator">*</span><span class="params">instanceMethods</span>, JSValue <span class="operator">*</span><span class="params">classMethods</span>)</span> &#123;</span><br><span class="line">    <span class="comment">//================================根据JSj脚本实例化出相对应的类====================================================</span></span><br><span class="line">    <span class="comment">//1.使用 NSScanner 分离 classDeclaration.</span></span><br><span class="line">    NSScanner *scanner = <span class="literal">[NSS<span class="identifier">canner</span> <span class="identifier">scannerWithString</span>:<span class="identifier">classDeclaration</span>]</span>;</span><br><span class="line">    </span><br><span class="line">    NSString *className;      <span class="comment">//类名</span></span><br><span class="line">    NSString *superClassName; <span class="comment">//父类名</span></span><br><span class="line">    NSString *protocolNames;  <span class="comment">//实现的协议名</span></span><br><span class="line">    <span class="literal">[<span class="identifier">scanner</span> <span class="identifier">scanUpToString</span>:@&quot;:&quot; <span class="identifier">intoString</span>:&amp;<span class="identifier">className</span>]</span>;</span><br><span class="line">    <span class="keyword">if</span> (!scanner.isAtEnd) &#123;</span><br><span class="line">        scanner.scanLocation = scanner.scanLocation + <span class="number">1</span>;</span><br><span class="line">        <span class="literal">[<span class="identifier">scanner</span> <span class="identifier">scanUpToString</span>:@&quot;&lt;&quot; <span class="identifier">intoString</span>:&amp;<span class="identifier">superClassName</span>]</span>;</span><br><span class="line">        <span class="keyword">if</span> (!scanner.isAtEnd) &#123;</span><br><span class="line">            scanner.scanLocation = scanner.scanLocation + <span class="number">1</span>;</span><br><span class="line">            <span class="literal">[<span class="identifier">scanner</span> <span class="identifier">scanUpToString</span>:@&quot;&gt;&quot; <span class="identifier">intoString</span>:&amp;<span class="identifier">protocolNames</span>]</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!superClassName) superClassName = @<span class="string">&quot;NSObject&quot;</span>;</span><br><span class="line">    <span class="comment">//类名</span></span><br><span class="line">    className = trim(className);</span><br><span class="line">    <span class="comment">//父类名</span></span><br><span class="line">    superClassName = trim(superClassName);</span><br><span class="line">    <span class="comment">//取出协议</span></span><br><span class="line">    NSArray *protocols = <span class="literal">[<span class="identifier">protocolNames</span> <span class="identifier">length</span>]</span> ? <span class="literal">[<span class="identifier">protocolNames</span> <span class="identifier">componentsSeparatedByString</span>:@&quot;,&quot;]</span> : nil;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//实例化对应的类</span></span><br><span class="line">    Class cls = <span class="constructor">NSClassFromString(<span class="params">className</span>)</span>;</span><br><span class="line">    <span class="keyword">if</span> (!cls) &#123;</span><br><span class="line">        Class superCls = <span class="constructor">NSClassFromString(<span class="params">superClassName</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (!superCls) &#123;</span><br><span class="line">            <span class="constructor">_exceptionBlock([NSString <span class="params">stringWithFormat</span>:@<span class="string">&quot;can&#x27;t find the super class %@&quot;</span>, <span class="params">superClassName</span>])</span>;</span><br><span class="line">            return @&#123;@<span class="string">&quot;cls&quot;</span>: className&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        cls = objc<span class="constructor">_allocateClassPair(<span class="params">superCls</span>, <span class="params">className</span>.UTF8String, 0)</span>;</span><br><span class="line">        objc<span class="constructor">_registerClassPair(<span class="params">cls</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//为类添加协议</span></span><br><span class="line">    <span class="keyword">if</span> (protocols.count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (NSString* protocolName <span class="keyword">in</span> protocols) &#123;</span><br><span class="line">            Protocol *protocol = objc<span class="constructor">_getProtocol([<span class="params">trim</span>(<span class="params">protocolName</span>)</span> cStringUsingEncoding:NSUTF8StringEncoding]);</span><br><span class="line">            class_addProtocol (cls, protocol);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//====================================================================================</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i ++) &#123;</span><br><span class="line">        BOOL isInstance = i<span class="operator"> == </span><span class="number">0</span>;</span><br><span class="line">        JSValue *jsMethods = isInstance ? instanceMethods: classMethods;</span><br><span class="line">        <span class="comment">//3.若是添加实例方法，直接使用Class对象；</span></span><br><span class="line">        <span class="comment">//若是添加类方法，需要获取元类.</span></span><br><span class="line">        </span><br><span class="line">        Class currCls = isInstance ? cls: objc<span class="constructor">_getMetaClass(<span class="params">className</span>.UTF8String)</span>;</span><br><span class="line">        <span class="comment">//把js对象转换成OC的字典，从而可以取到方法名、参数个数、具体实现.</span></span><br><span class="line">        NSDictionary *methodDict = <span class="literal">[<span class="identifier">jsMethods</span> <span class="identifier">toDictionary</span>]</span>;</span><br><span class="line">        <span class="keyword">for</span> (NSString *jsMethodName <span class="keyword">in</span> methodDict.allKeys) &#123;</span><br><span class="line">            <span class="comment">//方法名为键，一个数组为值。数组第一个元素为对应实现函数的参数个数，第二个元素是方法的具体实现。</span></span><br><span class="line">            JSValue *jsMethodArr = <span class="literal">[<span class="identifier">jsMethods</span> <span class="identifier">valueForProperty</span>:<span class="identifier">jsMethodName</span>]</span>;</span><br><span class="line">            <span class="comment">//第一个值为  参数个数</span></span><br><span class="line">            <span class="built_in">int</span> numberOfArg = <span class="literal">[<span class="identifier">jsMethodArr</span>[<span class="number">0</span>]</span> toInt32];</span><br><span class="line">            <span class="comment">//将方法名转换为selectorName</span></span><br><span class="line">            NSString *selectorName = convert<span class="constructor">JPSelectorString(<span class="params">jsMethodName</span>)</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">[<span class="identifier">selectorName</span> <span class="identifier">componentsSeparatedByString</span>:@&quot;:&quot;]</span>.count - <span class="number">1</span> &lt; numberOfArg) &#123;</span><br><span class="line">                selectorName = <span class="literal">[<span class="identifier">selectorName</span> <span class="identifier">stringByAppendingString</span>:@&quot;:&quot;]</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//第二个值为  方法实现</span></span><br><span class="line">            JSValue *jsMethod = jsMethodArr<span class="literal">[<span class="number">1</span>]</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">class</span><span class="constructor">_respondsToSelector(<span class="params">currCls</span>, NSSelectorFromString(<span class="params">selectorName</span>)</span>)) &#123;</span><br><span class="line">                <span class="comment">// 4.如果要替换的类已经定义了该方法，直接对该方法替换和实现消息转发.</span></span><br><span class="line">                override<span class="constructor">Method(<span class="params">currCls</span>, <span class="params">selectorName</span>, <span class="params">jsMethod</span>, !<span class="params">isInstance</span>, NULL)</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                BOOL overrided = NO;</span><br><span class="line">                <span class="keyword">for</span> (NSString *protocolName <span class="keyword">in</span> protocols) &#123;</span><br><span class="line">                    <span class="built_in">char</span> *types = <span class="keyword">method</span><span class="constructor">TypesInProtocol(<span class="params">protocolName</span>, <span class="params">selectorName</span>, <span class="params">isInstance</span>, YES)</span>;</span><br><span class="line">                    <span class="keyword">if</span> (!types) types = <span class="keyword">method</span><span class="constructor">TypesInProtocol(<span class="params">protocolName</span>, <span class="params">selectorName</span>, <span class="params">isInstance</span>, NO)</span>;</span><br><span class="line">                    <span class="keyword">if</span> (types) &#123;</span><br><span class="line">                        override<span class="constructor">Method(<span class="params">currCls</span>, <span class="params">selectorName</span>, <span class="params">jsMethod</span>, !<span class="params">isInstance</span>, <span class="params">types</span>)</span>;</span><br><span class="line">                        free(types);</span><br><span class="line">                        overrided = YES;</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!overrided) &#123;</span><br><span class="line">                    <span class="comment">//5.2 上述两种情况都不满足.js端请求添加一个新的方法.</span></span><br><span class="line">                    <span class="keyword">if</span> (!<span class="literal">[[<span class="identifier">jsMethodName</span> <span class="identifier">substringToIndex</span>:<span class="number">1</span>]</span> isEqualToString:@<span class="string">&quot;_&quot;</span>]) &#123;</span><br><span class="line">                        <span class="comment">//方法名的处理：_改为:</span></span><br><span class="line">                        NSMutableString *typeDescStr = <span class="literal">[@&quot;@@:&quot; <span class="identifier">mutableCopy</span>]</span>;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; numberOfArg; i ++) &#123;</span><br><span class="line">                            <span class="literal">[<span class="identifier">typeDescStr</span> <span class="identifier">appendString</span>:@&quot;@&quot;]</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//构造一个typeDescription为&quot;@@:\@*&quot;的IMP.将这个IMP添加到类中.</span></span><br><span class="line">                        override<span class="constructor">Method(<span class="params">currCls</span>, <span class="params">selectorName</span>, <span class="params">jsMethod</span>, !<span class="params">isInstance</span>, [<span class="params">typeDescStr</span> <span class="params">cStringUsingEncoding</span>:NSUTF8StringEncoding])</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 6.为该类添加两个方法，使js脚本拥有设置property的方法.</span></span><br><span class="line">    <span class="keyword">class</span><span class="constructor">_addMethod(<span class="params">cls</span>, @<span class="params">selector</span>(<span class="params">getProp</span>:)</span>, (IMP)getPropIMP, <span class="string">&quot;@@:@&quot;</span>);</span><br><span class="line">    <span class="keyword">class</span><span class="constructor">_addMethod(<span class="params">cls</span>, @<span class="params">selector</span>(<span class="params">setProp</span>:<span class="params">forKey</span>:)</span>, (IMP)setPropIMP, <span class="string">&quot;v@:@@&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//// 7.返回字典给js脚本</span></span><br><span class="line">    return @&#123;@<span class="string">&quot;cls&quot;</span>: className, @<span class="string">&quot;superCls&quot;</span>: superClassName&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们以demo.js为例子，defineClass这里传入的classDeclaration为 <strong><strong>JPTableViewController : UITableViewController <UIAlertViewDelegate></UIAlertViewDelegate></strong></strong> 这个字符串。在defineClass中会从中提取类信息，父类信息，以及协议信息。<br>第二个参数instanceMethods和第三个参数classMethods分别为包含属性Setter&#x2F;Getter在内的实例方法和类方法。上面提到了这两个参数在js方法中已经将它组合成</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">key</span>:方法名<span class="meta"> [参数个数:方法实现]</span></span><br></pre></td></tr></table></figure>
<p>这种形式，我们以</p>
<figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line">tableView_numberOfRowsInSection: <span class="keyword">function</span>(<span class="params">tableView, section</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> self.dataSource().<span class="built_in">length</span>;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>为例子: key为 tableView_numberOfRowsInSection value为[2,tableView:numberOfRowsInSection:的实现] 我们知道OC中要构建一个selector需要知道这个方法是实例方法还是类方法，方法名，IMP<br>类名，IMP 都可以直接拿到，我们还缺一个关键的信息，就是selectorName. 我们从js带过来带的key为tableView_numberOfRowsInSection，它其实包含了selectorName所需要的必要信息，只不过它是以”<em>“分隔，所以将将”</em>“替换为”:”<br>然后检查通过”:”分隔的字符串数和传入的参数个数这个进行进行比较，如果少了则需要在最后加个”:”就可以拿到我们需要的selectorName了。</p>
<p>我们接下来看下热修复最关键的方法overrideMethod:</p>
<p><strong><strong>方法替换</strong></strong></p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  使用jsvalue中将要替换的方法实现来替换oc类中的方法实现</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  @param cls             被替换的类</span></span><br><span class="line"><span class="comment"> *  @param selectorName    被替换实现的SEL</span></span><br><span class="line"><span class="comment"> *  @param function        在js中定义的将要替换的新的实现</span></span><br><span class="line"><span class="comment"> *  @param isClassMethod   是否类方法（如果是--&gt;寻找MetaClass）</span></span><br><span class="line"><span class="comment"> *  @param typeDescription 被替换的实现方法的编码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">static void override<span class="constructor">Method(Class <span class="params">cls</span>, NSString <span class="operator">*</span><span class="params">selectorName</span>, JSValue <span class="operator">*</span><span class="params">function</span>, BOOL <span class="params">isClassMethod</span>, <span class="params">const</span> <span class="params">char</span> <span class="operator">*</span><span class="params">typeDescription</span>)</span> &#123;</span><br><span class="line">    <span class="comment">//1. 要重写的方法的SEL.</span></span><br><span class="line">    SEL selector = <span class="constructor">NSSelectorFromString(<span class="params">selectorName</span>)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//2. 获取重写方法的具体实现函数的格式编码.</span></span><br><span class="line">    <span class="keyword">if</span> (!typeDescription) &#123;</span><br><span class="line">        Method <span class="keyword">method</span> = <span class="keyword">class</span><span class="constructor">_getInstanceMethod(<span class="params">cls</span>, <span class="params">selector</span>)</span>;</span><br><span class="line">        typeDescription = (<span class="built_in">char</span> *)<span class="keyword">method</span><span class="constructor">_getTypeEncoding(<span class="params">method</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//3.获取 class 中被重写 SEL 对应的原始IMP.</span></span><br><span class="line">    IMP originalImp = <span class="keyword">class</span><span class="constructor">_respondsToSelector(<span class="params">cls</span>, <span class="params">selector</span>)</span> ? <span class="keyword">class</span><span class="constructor">_getMethodImplementation(<span class="params">cls</span>, <span class="params">selector</span>)</span> : NULL;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//4.准备进入消息转发处理的系统函数实现IMP.</span></span><br><span class="line">    IMP msgForwardIMP = _objc_msgForward;</span><br><span class="line">    <span class="comment">//.......</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//--------------------------------------将要修复类原来的forwardInvocaiton替换成ORIGforwardInvocation--------------------------</span></span><br><span class="line">    <span class="comment">//--------------------------------------将要修复类的SEL替换成ORIGsel添加到类---------------------------------------------------</span></span><br><span class="line">    <span class="comment">//6.将cls中原来 forwardInvocaiton: 的实现替换成 JPForwardInvocation:函数实现.</span></span><br><span class="line">    <span class="comment">//class_replaceMethod()返回的是替换之前的 IMP.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">class</span><span class="constructor">_getMethodImplementation(<span class="params">cls</span>, @<span class="params">selector</span>(<span class="params">forwardInvocation</span>:)</span>) != (IMP)JPForwardInvocation) &#123;</span><br><span class="line">        IMP originalForwardImp = <span class="keyword">class</span><span class="constructor">_replaceMethod(<span class="params">cls</span>, @<span class="params">selector</span>(<span class="params">forwardInvocation</span>:)</span>, (IMP)JPForwardInvocation, <span class="string">&quot;v@:@&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (originalForwardImp) &#123;</span><br><span class="line">            <span class="comment">//7.为cls添加新的SEL(ORIGforwardInvocation:)，指向原始 forwardInvocation: 的实现IMP.</span></span><br><span class="line">            <span class="keyword">class</span><span class="constructor">_addMethod(<span class="params">cls</span>, @<span class="params">selector</span>(ORIGforwardInvocation:)</span>, originalForwardImp, <span class="string">&quot;v@:@&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="literal">[<span class="identifier">cls</span> <span class="identifier">jp_fixMethodSignature</span>]</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">class</span><span class="constructor">_respondsToSelector(<span class="params">cls</span>, <span class="params">selector</span>)</span>) &#123;</span><br><span class="line">        NSString *originalSelectorName = <span class="literal">[NSS<span class="identifier">tring</span> <span class="identifier">stringWithFormat</span>:@&quot;ORIG%@&quot;, <span class="identifier">selectorName</span>]</span>;</span><br><span class="line">        SEL originalSelector = <span class="constructor">NSSelectorFromString(<span class="params">originalSelectorName</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">class</span><span class="constructor">_respondsToSelector(<span class="params">cls</span>, <span class="params">originalSelector</span>)</span>) &#123;</span><br><span class="line">            <span class="comment">//8.为cls添加新的SEL(ORIG...:)指向被替换方法的原始实现IMP.</span></span><br><span class="line">            <span class="keyword">class</span><span class="constructor">_addMethod(<span class="params">cls</span>, <span class="params">originalSelector</span>, <span class="params">originalImp</span>, <span class="params">typeDescription</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//9.构造替换实现后的新SEL:(JP...)</span></span><br><span class="line">    NSString *JPSelectorName = <span class="literal">[NSS<span class="identifier">tring</span> <span class="identifier">stringWithFormat</span>:@&quot;<span class="identifier">_JP</span>%@&quot;, <span class="identifier">selectorName</span>]</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//10.记录新SEL对应js传过来的待替换目标方法的实现.</span></span><br><span class="line">    <span class="constructor">_initJPOverideMethods(<span class="params">cls</span>)</span>;</span><br><span class="line">    _JSOverideMethods<span class="literal">[<span class="identifier">cls</span>]</span><span class="literal">[JPS<span class="identifier">electorName</span>]</span> = <span class="keyword">function</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//11.替换原SEL的实现IMP为msgForwardIMP</span></span><br><span class="line">    <span class="comment">//让被替换的方法调用时，直接进入“消息转发”流程（_objc_msgForward 或 _objc_msgForward_stret）</span></span><br><span class="line">    <span class="comment">//这一步放到最后是为了避免在 overrideMethod 过程中调用原sel导致的线程问题.</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Replace the original selector at last, preventing threading issus when</span></span><br><span class="line">    <span class="comment">// the selector get called during the execution of `overrideMethod`</span></span><br><span class="line">    <span class="keyword">class</span><span class="constructor">_replaceMethod(<span class="params">cls</span>, <span class="params">selector</span>, <span class="params">msgForwardIMP</span>, <span class="params">typeDescription</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果大家看过Aspect源码这部分会比较好理解，两者在这部分思路是类似的，首先会将当前类的forwardInvocaiton替换为JSPatch实现的JPForwardInvocation:如果原来的类已经有实现了forwardInvocaiton那么就会将forwardInvocaiton替换成ORIGforwardInvocation<br>当前方法的selectorName 替换为_JPselectorName，如果原来有这个方法了，这里是在覆盖原有的方法，那么会将原来的方法selectorName改为ORIGselectorName。最后将selector方法的实现替换为_objc_msgForward 或 _objc_msgForward_stret 从而在代码中调用这个方法的时候，会触发消息下发。<br>走forwardInvocaiton，也就是会走到JSPatch实现的JPForwardInvocation:来重新控制方法调用的规则。</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">static void <span class="constructor">JPForwardInvocation(<span class="params">__unsafe_unretained</span> <span class="params">id</span> <span class="params">assignSlf</span>, SEL <span class="params">selector</span>, NSInvocation <span class="operator">*</span><span class="params">invocation</span>)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//1.表示oc对象是否已经被释放</span></span><br><span class="line">    BOOL deallocFlag = NO;</span><br><span class="line">    id slf = assignSlf;</span><br><span class="line">    BOOL isBlock = <span class="literal">[[<span class="identifier">assignSlf</span> <span class="identifier">class</span>]</span> isSubclassOfClass : <span class="constructor">NSClassFromString(@<span class="string">&quot;NSBlock&quot;</span>)</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//2.获取invocation中参数的数量</span></span><br><span class="line">    NSMethodSignature *methodSignature = <span class="literal">[<span class="identifier">invocation</span> <span class="identifier">methodSignature</span>]</span>;</span><br><span class="line">    NSInteger numberOfArguments = <span class="literal">[<span class="identifier">methodSignature</span> <span class="identifier">numberOfArguments</span>]</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//3.转化调用的SEL为JPSEL（这是JSPatch中缓存JSValue* function的key格式）</span></span><br><span class="line">    NSString *selectorName = isBlock ? @<span class="string">&quot;&quot;</span> : <span class="constructor">NSStringFromSelector(<span class="params">invocation</span>.<span class="params">selector</span>)</span>;</span><br><span class="line">    NSString *JPSelectorName = <span class="literal">[NSS<span class="identifier">tring</span> <span class="identifier">stringWithFormat</span>:@&quot;<span class="identifier">_JP</span>%@&quot;, <span class="identifier">selectorName</span>]</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//4.判断JPSEL是否有对应的js函数的实现，如果没有就走原始方法的消息转发的流程.</span></span><br><span class="line">    JSValue *jsFunc = isBlock ? objc<span class="constructor">_getAssociatedObject(<span class="params">assignSlf</span>, <span class="string">&quot;_JSValue&quot;</span>)</span><span class="literal">[@&quot;<span class="identifier">cb</span>&quot;]</span> : get<span class="constructor">JSFunctionInObjectHierachy(<span class="params">slf</span>, JPSelectorName)</span>;</span><br><span class="line">    <span class="keyword">if</span> (!jsFunc) &#123;</span><br><span class="line">        <span class="constructor">JPExecuteORIGForwardInvocation(<span class="params">slf</span>, <span class="params">selector</span>, <span class="params">invocation</span>)</span>;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//5.1 初始化数组，存储NSInvacation中获取的参数列表，传给对应的js函数</span></span><br><span class="line">    NSMutableArray *argList = <span class="literal">[[NSM<span class="identifier">utableArray</span> <span class="identifier">alloc</span>]</span> init];</span><br><span class="line">    <span class="keyword">if</span> (!isBlock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">[<span class="identifier">slf</span> <span class="identifier">class</span>]</span><span class="operator"> == </span>slf) &#123;</span><br><span class="line">            <span class="comment">//5.2 类方法：设置__clsName标识表明这是一个类对象</span></span><br><span class="line">            <span class="literal">[<span class="identifier">argList</span> <span class="identifier">addObject</span>:[JSV<span class="identifier">alue</span> <span class="identifier">valueWithObject</span>:@&#123;@&quot;<span class="identifier">__clsName</span>&quot;: NSS<span class="identifier">tringFromClass</span>([<span class="identifier">slf</span> <span class="identifier">class</span>]</span>)&#125; inContext:_context]];</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="literal">[<span class="identifier">selectorName</span> <span class="identifier">isEqualToString</span>:@&quot;<span class="identifier">dealloc</span>&quot;]</span>) &#123;</span><br><span class="line">            <span class="comment">//5.3 要被释放的对象：使用assign来保存self指针</span></span><br><span class="line">            <span class="literal">[<span class="identifier">argList</span> <span class="identifier">addObject</span>:[JPB<span class="identifier">oxing</span> <span class="identifier">boxAssignObj</span>:<span class="identifier">slf</span>]</span>];</span><br><span class="line">            deallocFlag = YES;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//5.4 使用 weak 保存self 指针</span></span><br><span class="line">            <span class="literal">[<span class="identifier">argList</span> <span class="identifier">addObject</span>:[JPB<span class="identifier">oxing</span> <span class="identifier">boxWeakObj</span>:<span class="identifier">slf</span>]</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//5.5 NSInvocation 对象的前两个参数是self和_cmd,所以直接从第3个参数开始获取</span></span><br><span class="line">    <span class="keyword">for</span> (NSUInteger i = isBlock ? <span class="number">1</span> : <span class="number">2</span>; i &lt; numberOfArguments; i++) &#123;</span><br><span class="line">        const <span class="built_in">char</span> *argumentType = <span class="literal">[<span class="identifier">methodSignature</span> <span class="identifier">getArgumentTypeAtIndex</span>:<span class="identifier">i</span>]</span>;</span><br><span class="line">        <span class="comment">//返回值如果是const，获取encoding来判断类型.</span></span><br><span class="line">        switch(argumentType<span class="literal">[<span class="number">0</span>]</span><span class="operator"> == </span><span class="character">&#x27;r&#x27;</span> ? argumentType<span class="literal">[<span class="number">1</span>]</span> : argumentType<span class="literal">[<span class="number">0</span>]</span>) &#123;</span><br><span class="line">            <span class="comment">//从invocation中获取参数，添加到argList中.</span></span><br><span class="line">            #define <span class="constructor">JP_FWD_ARG_CASE(<span class="params">_typeChar</span>, <span class="params">_type</span>)</span> \</span><br><span class="line">            case _typeChar: &#123;   \</span><br><span class="line">                _type arg;  \</span><br><span class="line">                <span class="literal">[<span class="identifier">invocation</span> <span class="identifier">getArgument</span>:&amp;<span class="identifier">arg</span> <span class="identifier">atIndex</span>:<span class="identifier">i</span>]</span>;    \</span><br><span class="line">                <span class="literal">[<span class="identifier">argList</span> <span class="identifier">addObject</span>:@(<span class="identifier">arg</span>)]</span>; \</span><br><span class="line">                break;  \</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="constructor">JP_FWD_ARG_CASE(&#x27;<span class="params">c</span>&#x27;, <span class="params">char</span>)</span></span><br><span class="line">            <span class="constructor">JP_FWD_ARG_CASE(&#x27;C&#x27;, <span class="params">unsigned</span> <span class="params">char</span>)</span></span><br><span class="line">            <span class="constructor">JP_FWD_ARG_CASE(&#x27;<span class="params">s</span>&#x27;, <span class="params">short</span>)</span></span><br><span class="line">            <span class="constructor">JP_FWD_ARG_CASE(&#x27;S&#x27;, <span class="params">unsigned</span> <span class="params">short</span>)</span></span><br><span class="line">            <span class="constructor">JP_FWD_ARG_CASE(&#x27;<span class="params">i</span>&#x27;, <span class="params">int</span>)</span></span><br><span class="line">            <span class="constructor">JP_FWD_ARG_CASE(&#x27;I&#x27;, <span class="params">unsigned</span> <span class="params">int</span>)</span></span><br><span class="line">            <span class="constructor">JP_FWD_ARG_CASE(&#x27;<span class="params">l</span>&#x27;, <span class="params">long</span>)</span></span><br><span class="line">            <span class="constructor">JP_FWD_ARG_CASE(&#x27;L&#x27;, <span class="params">unsigned</span> <span class="params">long</span>)</span></span><br><span class="line">            <span class="constructor">JP_FWD_ARG_CASE(&#x27;<span class="params">q</span>&#x27;, <span class="params">long</span> <span class="params">long</span>)</span></span><br><span class="line">            <span class="constructor">JP_FWD_ARG_CASE(&#x27;Q&#x27;, <span class="params">unsigned</span> <span class="params">long</span> <span class="params">long</span>)</span></span><br><span class="line">            <span class="constructor">JP_FWD_ARG_CASE(&#x27;<span class="params">f</span>&#x27;, <span class="params">float</span>)</span></span><br><span class="line">            <span class="constructor">JP_FWD_ARG_CASE(&#x27;<span class="params">d</span>&#x27;, <span class="params">double</span>)</span></span><br><span class="line">            <span class="constructor">JP_FWD_ARG_CASE(&#x27;B&#x27;, BOOL)</span></span><br><span class="line">            case <span class="character">&#x27;@&#x27;</span>: &#123;</span><br><span class="line">                <span class="comment">//id类型参数使用__unsafe__unretained</span></span><br><span class="line">                __unsafe_unretained id arg;</span><br><span class="line">                <span class="literal">[<span class="identifier">invocation</span> <span class="identifier">getArgument</span>:&amp;<span class="identifier">arg</span> <span class="identifier">atIndex</span>:<span class="identifier">i</span>]</span>;</span><br><span class="line">                <span class="comment">//block参数使用copy，_nilObj表示nil</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">[<span class="identifier">arg</span> <span class="identifier">isKindOfClass</span>:NSC<span class="identifier">lassFromString</span>(@&quot;NSB<span class="identifier">lock</span>&quot;)]</span>) &#123;</span><br><span class="line">                    <span class="literal">[<span class="identifier">argList</span> <span class="identifier">addObject</span>:(<span class="identifier">arg</span> ? [<span class="identifier">arg</span> <span class="identifier">copy</span>]</span>: _nilObj)];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="literal">[<span class="identifier">argList</span> <span class="identifier">addObject</span>:(<span class="identifier">arg</span> ? <span class="identifier">arg</span>: <span class="identifier">_nilObj</span>)]</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            case <span class="character">&#x27;&#123;&#x27;</span>: &#123;</span><br><span class="line"><span class="comment">//                处理结构体类型参数</span></span><br><span class="line"><span class="comment">//                获取结构体类型名称，把参数包装成JSValue类型</span></span><br><span class="line">                NSString *typeString = extract<span class="constructor">StructName([NSString <span class="params">stringWithUTF8String</span>:<span class="params">argumentType</span>])</span>;</span><br><span class="line">                #define <span class="constructor">JP_FWD_ARG_STRUCT(<span class="params">_type</span>, <span class="params">_transFunc</span>)</span> \</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">[<span class="identifier">typeString</span> <span class="identifier">rangeOfString</span>:@#<span class="identifier">_type</span>]</span>.location != NSNotFound) &#123;    \</span><br><span class="line">                    _type arg; \</span><br><span class="line">                    <span class="literal">[<span class="identifier">invocation</span> <span class="identifier">getArgument</span>:&amp;<span class="identifier">arg</span> <span class="identifier">atIndex</span>:<span class="identifier">i</span>]</span>;    \</span><br><span class="line">                    <span class="literal">[<span class="identifier">argList</span> <span class="identifier">addObject</span>:[JSV<span class="identifier">alue</span> <span class="identifier">_transFunc</span>:<span class="identifier">arg</span> <span class="identifier">inContext</span>:<span class="identifier">_context</span>]</span>];  \</span><br><span class="line">                    break; \</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="constructor">JP_FWD_ARG_STRUCT(CGRect, <span class="params">valueWithRect</span>)</span></span><br><span class="line">                <span class="constructor">JP_FWD_ARG_STRUCT(CGPoint, <span class="params">valueWithPoint</span>)</span></span><br><span class="line">                <span class="constructor">JP_FWD_ARG_STRUCT(CGSize, <span class="params">valueWithSize</span>)</span></span><br><span class="line">                <span class="constructor">JP_FWD_ARG_STRUCT(NSRange, <span class="params">valueWithRange</span>)</span></span><br><span class="line"><span class="comment">//                自定义类型的结构体处理</span></span><br><span class="line">                @synchronized (_context) &#123;</span><br><span class="line">                    NSDictionary *structDefine = _registeredStruct<span class="literal">[<span class="identifier">typeString</span>]</span>;</span><br><span class="line">                    <span class="keyword">if</span> (structDefine) &#123;</span><br><span class="line">                        size_t size = size<span class="constructor">OfStructTypes(<span class="params">structDefine</span>[@<span class="string">&quot;types&quot;</span>])</span>;</span><br><span class="line">                        <span class="keyword">if</span> (size) &#123;</span><br><span class="line">                            void *ret = malloc(size);</span><br><span class="line">                            <span class="literal">[<span class="identifier">invocation</span> <span class="identifier">getArgument</span>:<span class="identifier">ret</span> <span class="identifier">atIndex</span>:<span class="identifier">i</span>]</span>;</span><br><span class="line">                            NSDictionary *dict = get<span class="constructor">DictOfStruct(<span class="params">ret</span>, <span class="params">structDefine</span>)</span>;</span><br><span class="line">                            <span class="literal">[<span class="identifier">argList</span> <span class="identifier">addObject</span>:[JSV<span class="identifier">alue</span> <span class="identifier">valueWithObject</span>:<span class="identifier">dict</span> <span class="identifier">inContext</span>:<span class="identifier">_context</span>]</span>];</span><br><span class="line">                            free(ret);</span><br><span class="line">                            break;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            case <span class="character">&#x27;:&#x27;</span>: &#123;</span><br><span class="line">                <span class="comment">//selector类型处理</span></span><br><span class="line">                SEL selector;</span><br><span class="line">                <span class="literal">[<span class="identifier">invocation</span> <span class="identifier">getArgument</span>:&amp;<span class="identifier">selector</span> <span class="identifier">atIndex</span>:<span class="identifier">i</span>]</span>;</span><br><span class="line">                NSString *selectorName = <span class="constructor">NSStringFromSelector(<span class="params">selector</span>)</span>;</span><br><span class="line">                <span class="literal">[<span class="identifier">argList</span> <span class="identifier">addObject</span>:(<span class="identifier">selectorName</span> ? <span class="identifier">selectorName</span>: <span class="identifier">_nilObj</span>)]</span>;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            case <span class="character">&#x27;^&#x27;</span>:</span><br><span class="line">            case <span class="character">&#x27;*&#x27;</span>: &#123;</span><br><span class="line">                <span class="comment">//指针类型处理</span></span><br><span class="line">                void *arg;</span><br><span class="line">                <span class="literal">[<span class="identifier">invocation</span> <span class="identifier">getArgument</span>:&amp;<span class="identifier">arg</span> <span class="identifier">atIndex</span>:<span class="identifier">i</span>]</span>;</span><br><span class="line">                <span class="literal">[<span class="identifier">argList</span> <span class="identifier">addObject</span>:[JPB<span class="identifier">oxing</span> <span class="identifier">boxPointer</span>:<span class="identifier">arg</span>]</span>];</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            case <span class="character">&#x27;#&#x27;</span>: &#123;</span><br><span class="line">                <span class="comment">//Class类型</span></span><br><span class="line">                Class arg;</span><br><span class="line">                <span class="literal">[<span class="identifier">invocation</span> <span class="identifier">getArgument</span>:&amp;<span class="identifier">arg</span> <span class="identifier">atIndex</span>:<span class="identifier">i</span>]</span>;</span><br><span class="line">                <span class="literal">[<span class="identifier">argList</span> <span class="identifier">addObject</span>:[JPB<span class="identifier">oxing</span> <span class="identifier">boxClass</span>:<span class="identifier">arg</span>]</span>];</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            default: &#123;</span><br><span class="line">                <span class="constructor">NSLog(@<span class="string">&quot;error type %s&quot;</span>, <span class="params">argumentType</span>)</span>;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (_currInvokeSuperClsName<span class="literal">[<span class="identifier">selectorName</span>]</span>) &#123;</span><br><span class="line">        Class cls = <span class="constructor">NSClassFromString(<span class="params">_currInvokeSuperClsName</span>[<span class="params">selectorName</span>])</span>;</span><br><span class="line">        NSString *tmpSelectorName = <span class="literal">[[<span class="identifier">selectorName</span> <span class="identifier">stringByReplacingOccurrencesOfString</span>:@&quot;<span class="identifier">_JPSUPER_</span>&quot; <span class="identifier">withString</span>:@&quot;<span class="identifier">_JP</span>&quot;]</span> stringByReplacingOccurrencesOfString:@<span class="string">&quot;SUPER_&quot;</span> withString:@<span class="string">&quot;_JP&quot;</span>];</span><br><span class="line">        <span class="keyword">if</span> (!_JSOverideMethods<span class="literal">[<span class="identifier">cls</span>]</span><span class="literal">[<span class="identifier">tmpSelectorName</span>]</span>) &#123;</span><br><span class="line">            NSString *ORIGSelectorName = <span class="literal">[<span class="identifier">selectorName</span> <span class="identifier">stringByReplacingOccurrencesOfString</span>:@&quot;SUPER<span class="identifier">_</span>&quot; <span class="identifier">withString</span>:@&quot;ORIG&quot;]</span>;</span><br><span class="line">            <span class="literal">[<span class="identifier">argList</span> <span class="identifier">removeObjectAtIndex</span>:<span class="number">0</span>]</span>;</span><br><span class="line">            id retObj = call<span class="constructor">Selector(<span class="params">_currInvokeSuperClsName</span>[<span class="params">selectorName</span>], ORIGSelectorName, [JSValue <span class="params">valueWithObject</span>:<span class="params">argList</span> <span class="params">inContext</span>:<span class="params">_context</span>], [JSValue <span class="params">valueWithObject</span>:@&#123;@<span class="string">&quot;__obj&quot;</span>: <span class="params">slf</span>, @<span class="string">&quot;__realClsName&quot;</span>: @<span class="string">&quot;&quot;</span>&#125; <span class="params">inContext</span>:<span class="params">_context</span>], NO)</span>;</span><br><span class="line">            id __autoreleasing ret = format<span class="constructor">JSToOC([JSValue <span class="params">valueWithObject</span>:<span class="params">retObj</span> <span class="params">inContext</span>:<span class="params">_context</span>])</span>;</span><br><span class="line">            <span class="literal">[<span class="identifier">invocation</span> <span class="identifier">setReturnValue</span>:&amp;<span class="identifier">ret</span>]</span>;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6.将上面获得的参数列表数组转化为对应的js对象数组</span></span><br><span class="line">    NSArray *params = <span class="constructor">_formatOCToJSList(<span class="params">argList</span>)</span>;</span><br><span class="line">    <span class="built_in">char</span> returnType<span class="literal">[<span class="number">255</span>]</span>;</span><br><span class="line">    strcpy(returnType, <span class="literal">[<span class="identifier">methodSignature</span> <span class="identifier">methodReturnType</span>]</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 7.获取返回值类型</span></span><br><span class="line">    <span class="comment">// Restore the return type</span></span><br><span class="line">    <span class="keyword">if</span> (strcmp(returnType, @encode(JPDouble))<span class="operator"> == </span><span class="number">0</span>) &#123;</span><br><span class="line">        strcpy(returnType, @encode(double));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (strcmp(returnType, @encode(JPFloat))<span class="operator"> == </span><span class="number">0</span>) &#123;</span><br><span class="line">        strcpy(returnType, @encode(<span class="built_in">float</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//7.1 返回值是否为const，如果是，获取后面的encoding来判断类型</span></span><br><span class="line">    switch (returnType<span class="literal">[<span class="number">0</span>]</span><span class="operator"> == </span><span class="character">&#x27;r&#x27;</span> ? returnType<span class="literal">[<span class="number">1</span>]</span> : returnType<span class="literal">[<span class="number">0</span>]</span>) &#123;</span><br><span class="line">        #define JP_FWD_RET_CALL_JS \</span><br><span class="line">            JSValue *jsval; \</span><br><span class="line">            <span class="literal">[<span class="identifier">_JSMethodForwardCallLock</span> <span class="identifier">lock</span>]</span>;   \</span><br><span class="line">            jsval = <span class="literal">[<span class="identifier">jsFunc</span> <span class="identifier">callWithArguments</span>:<span class="identifier">params</span>]</span>; \</span><br><span class="line">            <span class="literal">[<span class="identifier">_JSMethodForwardCallLock</span> <span class="identifier">unlock</span>]</span>; \</span><br><span class="line">            <span class="keyword">while</span> (!<span class="literal">[<span class="identifier">jsval</span> <span class="identifier">isNull</span>]</span><span class="operator"> &amp;&amp; </span>!<span class="literal">[<span class="identifier">jsval</span> <span class="identifier">isUndefined</span>]</span><span class="operator"> &amp;&amp; </span><span class="literal">[<span class="identifier">jsval</span> <span class="identifier">hasProperty</span>:@&quot;<span class="identifier">__isPerformInOC</span>&quot;]</span>) &#123; \</span><br><span class="line">                NSArray *args = nil;  \</span><br><span class="line">                JSValue *cb = jsval<span class="literal">[@&quot;<span class="identifier">cb</span>&quot;]</span>; \</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">[<span class="identifier">jsval</span> <span class="identifier">hasProperty</span>:@&quot;<span class="identifier">sel</span>&quot;]</span>) &#123;   \</span><br><span class="line">                    id callRet = call<span class="constructor">Selector(![<span class="params">jsval</span>[@<span class="string">&quot;clsName&quot;</span>] <span class="params">isUndefined</span>] ? [<span class="params">jsval</span>[@<span class="string">&quot;clsName&quot;</span>] <span class="params">toString</span>] : <span class="params">nil</span>, [<span class="params">jsval</span>[@<span class="string">&quot;sel&quot;</span>] <span class="params">toString</span>], <span class="params">jsval</span>[@<span class="string">&quot;args&quot;</span>], ![<span class="params">jsval</span>[@<span class="string">&quot;obj&quot;</span>] <span class="params">isUndefined</span>] ? <span class="params">jsval</span>[@<span class="string">&quot;obj&quot;</span>] : <span class="params">nil</span>, NO)</span>;  \</span><br><span class="line">                    args = @<span class="literal">[[<span class="identifier">_context</span>[@&quot;<span class="identifier">_formatOCToJS</span>&quot;]</span> callWithArguments:callRet ? @<span class="literal">[<span class="identifier">callRet</span>]</span> : <span class="constructor">_formatOCToJSList(@[<span class="params">_nilObj</span>])</span>]];  \</span><br><span class="line">                &#125;   \</span><br><span class="line">                <span class="literal">[<span class="identifier">_JSMethodForwardCallLock</span> <span class="identifier">lock</span>]</span>;    \</span><br><span class="line">                jsval = <span class="literal">[<span class="identifier">cb</span> <span class="identifier">callWithArguments</span>:<span class="identifier">args</span>]</span>;  \</span><br><span class="line">                <span class="literal">[<span class="identifier">_JSMethodForwardCallLock</span> <span class="identifier">unlock</span>]</span>;  \</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        #define <span class="constructor">JP_FWD_RET_CASE_RET(<span class="params">_typeChar</span>, <span class="params">_type</span>, <span class="params">_retCode</span>)</span>   \</span><br><span class="line">            case _typeChar : &#123; \</span><br><span class="line">                JP_FWD_RET_CALL_JS \</span><br><span class="line">                _retCode \</span><br><span class="line">                <span class="literal">[<span class="identifier">invocation</span> <span class="identifier">setReturnValue</span>:&amp;<span class="identifier">ret</span>]</span>;\</span><br><span class="line">                break;  \</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        #define <span class="constructor">JP_FWD_RET_CASE(<span class="params">_typeChar</span>, <span class="params">_type</span>, <span class="params">_typeSelector</span>)</span>   \</span><br><span class="line">            <span class="constructor">JP_FWD_RET_CASE_RET(<span class="params">_typeChar</span>, <span class="params">_type</span>, <span class="params">_type</span> <span class="params">ret</span> = [[<span class="params">jsval</span> <span class="params">toObject</span>] <span class="params">_typeSelector</span>];)</span>   \</span><br><span class="line"></span><br><span class="line">        #define JP_FWD_RET_CODE_ID \</span><br><span class="line">            id __autoreleasing ret = format<span class="constructor">JSToOC(<span class="params">jsval</span>)</span>; \</span><br><span class="line">            <span class="keyword">if</span> (ret<span class="operator"> == </span>_nilObj<span class="operator"> ||   </span>\</span><br><span class="line">                (<span class="literal">[<span class="identifier">ret</span> <span class="identifier">isKindOfClass</span>:[NSN<span class="identifier">umber</span> <span class="identifier">class</span>]</span>]<span class="operator"> &amp;&amp; </span>strcmp(<span class="literal">[<span class="identifier">ret</span> <span class="identifier">objCType</span>]</span>, <span class="string">&quot;c&quot;</span>)<span class="operator"> == </span><span class="number">0</span><span class="operator"> &amp;&amp; </span>!<span class="literal">[<span class="identifier">ret</span> <span class="identifier">boolValue</span>]</span>)) ret = nil;  \</span><br><span class="line"></span><br><span class="line">        #define JP_FWD_RET_CODE_POINTER    \</span><br><span class="line">            void *ret; \</span><br><span class="line">            id obj = format<span class="constructor">JSToOC(<span class="params">jsval</span>)</span>; \</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">[<span class="identifier">obj</span> <span class="identifier">isKindOfClass</span>:[JPB<span class="identifier">oxing</span> <span class="identifier">class</span>]</span>]) &#123; \</span><br><span class="line">                ret = <span class="literal">[((JPB<span class="identifier">oxing</span> <span class="operator">*</span>)<span class="identifier">obj</span>) <span class="identifier">unboxPointer</span>]</span>; \</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        #define JP_FWD_RET_CODE_CLASS    \</span><br><span class="line">            Class ret;   \</span><br><span class="line">            ret = format<span class="constructor">JSToOC(<span class="params">jsval</span>)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        #define JP_FWD_RET_CODE_SEL    \</span><br><span class="line">            SEL ret;   \</span><br><span class="line">            id obj = format<span class="constructor">JSToOC(<span class="params">jsval</span>)</span>; \</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">[<span class="identifier">obj</span> <span class="identifier">isKindOfClass</span>:[NSS<span class="identifier">tring</span> <span class="identifier">class</span>]</span>]) &#123; \</span><br><span class="line">                ret = <span class="constructor">NSSelectorFromString(<span class="params">obj</span>)</span>; \</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="constructor">JP_FWD_RET_CASE_RET(&#x27;@&#x27;, <span class="params">id</span>, JP_FWD_RET_CODE_ID)</span></span><br><span class="line">        <span class="constructor">JP_FWD_RET_CASE_RET(&#x27;^&#x27;, <span class="params">void</span><span class="operator">*</span>, JP_FWD_RET_CODE_POINTER)</span></span><br><span class="line">        <span class="constructor">JP_FWD_RET_CASE_RET(&#x27;<span class="operator">*</span>&#x27;, <span class="params">void</span><span class="operator">*</span>, JP_FWD_RET_CODE_POINTER)</span></span><br><span class="line">        <span class="constructor">JP_FWD_RET_CASE_RET(&#x27;#&#x27;, Class, JP_FWD_RET_CODE_CLASS)</span></span><br><span class="line">        <span class="constructor">JP_FWD_RET_CASE_RET(&#x27;:&#x27;, SEL, JP_FWD_RET_CODE_SEL)</span></span><br><span class="line"></span><br><span class="line">        <span class="constructor">JP_FWD_RET_CASE(&#x27;<span class="params">c</span>&#x27;, <span class="params">char</span>, <span class="params">charValue</span>)</span></span><br><span class="line">        <span class="constructor">JP_FWD_RET_CASE(&#x27;C&#x27;, <span class="params">unsigned</span> <span class="params">char</span>, <span class="params">unsignedCharValue</span>)</span></span><br><span class="line">        <span class="constructor">JP_FWD_RET_CASE(&#x27;<span class="params">s</span>&#x27;, <span class="params">short</span>, <span class="params">shortValue</span>)</span></span><br><span class="line">        <span class="constructor">JP_FWD_RET_CASE(&#x27;S&#x27;, <span class="params">unsigned</span> <span class="params">short</span>, <span class="params">unsignedShortValue</span>)</span></span><br><span class="line">        <span class="constructor">JP_FWD_RET_CASE(&#x27;<span class="params">i</span>&#x27;, <span class="params">int</span>, <span class="params">intValue</span>)</span></span><br><span class="line">        <span class="constructor">JP_FWD_RET_CASE(&#x27;I&#x27;, <span class="params">unsigned</span> <span class="params">int</span>, <span class="params">unsignedIntValue</span>)</span></span><br><span class="line">        <span class="constructor">JP_FWD_RET_CASE(&#x27;<span class="params">l</span>&#x27;, <span class="params">long</span>, <span class="params">longValue</span>)</span></span><br><span class="line">        <span class="constructor">JP_FWD_RET_CASE(&#x27;L&#x27;, <span class="params">unsigned</span> <span class="params">long</span>, <span class="params">unsignedLongValue</span>)</span></span><br><span class="line">        <span class="constructor">JP_FWD_RET_CASE(&#x27;<span class="params">q</span>&#x27;, <span class="params">long</span> <span class="params">long</span>, <span class="params">longLongValue</span>)</span></span><br><span class="line">        <span class="constructor">JP_FWD_RET_CASE(&#x27;Q&#x27;, <span class="params">unsigned</span> <span class="params">long</span> <span class="params">long</span>, <span class="params">unsignedLongLongValue</span>)</span></span><br><span class="line">        <span class="constructor">JP_FWD_RET_CASE(&#x27;<span class="params">f</span>&#x27;, <span class="params">float</span>, <span class="params">floatValue</span>)</span></span><br><span class="line">        <span class="constructor">JP_FWD_RET_CASE(&#x27;<span class="params">d</span>&#x27;, <span class="params">double</span>, <span class="params">doubleValue</span>)</span></span><br><span class="line">        <span class="constructor">JP_FWD_RET_CASE(&#x27;B&#x27;, BOOL, <span class="params">boolValue</span>)</span></span><br><span class="line"></span><br><span class="line">        case <span class="character">&#x27;v&#x27;</span>: &#123;</span><br><span class="line">            JP_FWD_RET_CALL_JS</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        case <span class="character">&#x27;&#123;&#x27;</span>: &#123;</span><br><span class="line">            NSString *typeString = extract<span class="constructor">StructName([NSString <span class="params">stringWithUTF8String</span>:<span class="params">returnType</span>])</span>;</span><br><span class="line">            #define <span class="constructor">JP_FWD_RET_STRUCT(<span class="params">_type</span>, <span class="params">_funcSuffix</span>)</span> \</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">[<span class="identifier">typeString</span> <span class="identifier">rangeOfString</span>:@#<span class="identifier">_type</span>]</span>.location != NSNotFound) &#123;    \</span><br><span class="line">                JP_FWD_RET_CALL_JS \</span><br><span class="line">                _type ret = <span class="literal">[<span class="identifier">jsval</span> <span class="identifier">_funcSuffix</span>]</span>; \</span><br><span class="line">                <span class="literal">[<span class="identifier">invocation</span> <span class="identifier">setReturnValue</span>:&amp;<span class="identifier">ret</span>]</span>;\</span><br><span class="line">                break;  \</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="constructor">JP_FWD_RET_STRUCT(CGRect, <span class="params">toRect</span>)</span></span><br><span class="line">            <span class="constructor">JP_FWD_RET_STRUCT(CGPoint, <span class="params">toPoint</span>)</span></span><br><span class="line">            <span class="constructor">JP_FWD_RET_STRUCT(CGSize, <span class="params">toSize</span>)</span></span><br><span class="line">            <span class="constructor">JP_FWD_RET_STRUCT(NSRange, <span class="params">toRange</span>)</span></span><br><span class="line">            </span><br><span class="line">            @synchronized (_context) &#123;</span><br><span class="line">                NSDictionary *structDefine = _registeredStruct<span class="literal">[<span class="identifier">typeString</span>]</span>;</span><br><span class="line">                <span class="keyword">if</span> (structDefine) &#123;</span><br><span class="line">                    size_t size = size<span class="constructor">OfStructTypes(<span class="params">structDefine</span>[@<span class="string">&quot;types&quot;</span>])</span>;</span><br><span class="line">                    JP_FWD_RET_CALL_JS</span><br><span class="line">                    void *ret = malloc(size);</span><br><span class="line">                    NSDictionary *dict = format<span class="constructor">JSToOC(<span class="params">jsval</span>)</span>;</span><br><span class="line">                    get<span class="constructor">StructDataWithDict(<span class="params">ret</span>, <span class="params">dict</span>, <span class="params">structDefine</span>)</span>;</span><br><span class="line">                    <span class="literal">[<span class="identifier">invocation</span> <span class="identifier">setReturnValue</span>:<span class="identifier">ret</span>]</span>;</span><br><span class="line">                    free(ret);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        default: &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (_pointersToRelease) &#123;</span><br><span class="line">        <span class="keyword">for</span> (NSValue *<span class="keyword">val</span> <span class="keyword">in</span> _pointersToRelease) &#123;</span><br><span class="line">            void *pointer = NULL;</span><br><span class="line">            <span class="literal">[<span class="identifier">val</span> <span class="identifier">getValue</span>:&amp;<span class="identifier">pointer</span>]</span>;</span><br><span class="line">            <span class="constructor">CFRelease(<span class="params">pointer</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        _pointersToRelease = nil;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//8.待替换的方法是 delloc 需要特殊处理：</span></span><br><span class="line">    <span class="keyword">if</span> (deallocFlag) &#123;</span><br><span class="line">        slf = nil;</span><br><span class="line">        Class instClass = <span class="keyword">object</span><span class="constructor">_getClass(<span class="params">assignSlf</span>)</span>;</span><br><span class="line">        Method deallocMethod = <span class="keyword">class</span><span class="constructor">_getInstanceMethod(<span class="params">instClass</span>, NSSelectorFromString(@<span class="string">&quot;ORIGdealloc&quot;</span>)</span>);</span><br><span class="line">        <span class="comment">//获取原delloc imp 指针，调用delloc，防止内存泄漏.</span></span><br><span class="line">        void (*originalDealloc)(__unsafe_unretained id, SEL) = (<span class="constructor">__typeof__(<span class="params">originalDealloc</span>)</span>)<span class="keyword">method</span><span class="constructor">_getImplementation(<span class="params">deallocMethod</span>)</span>;</span><br><span class="line">        original<span class="constructor">Dealloc(<span class="params">assignSlf</span>, NSSelectorFromString(@<span class="string">&quot;dealloc&quot;</span>)</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>JPForwardInvocation 会先从 NSInvocation中取出selector 名称，现在selector名称之前加上_JP,然后看下当前对象是否有对应的方法，我们在overideMethod方法中了解到，如果我们热修复js脚本中有对应的方法，那么就会在该对象中多出一个_JP开头的方法，指向热修复补丁中的实现。<br>所以这里会先看下当前方法中是否有对应的补丁方法，如果没有就调用JPExecuteORIGForwardInvocation走原来的消息分发机制。</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">static void <span class="constructor">JPExecuteORIGForwardInvocation(<span class="params">id</span> <span class="params">slf</span>, SEL <span class="params">selector</span>, NSInvocation <span class="operator">*</span><span class="params">invocation</span>)</span> &#123;</span><br><span class="line">    SEL origForwardSelector = @selector(ORIGforwardInvocation:);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">[<span class="identifier">slf</span> <span class="identifier">respondsToSelector</span>:<span class="identifier">origForwardSelector</span>]</span>) &#123;</span><br><span class="line">        NSMethodSignature *methodSignature = <span class="literal">[<span class="identifier">slf</span> <span class="identifier">methodSignatureForSelector</span>:<span class="identifier">origForwardSelector</span>]</span>;</span><br><span class="line">        <span class="keyword">if</span> (!methodSignature) &#123;</span><br><span class="line">            <span class="constructor">_exceptionBlock([NSString <span class="params">stringWithFormat</span>:@<span class="string">&quot;unrecognized selector -ORIGforwardInvocation: for instance %@&quot;</span>, <span class="params">slf</span>])</span>;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        NSInvocation *forwardInv= <span class="literal">[NSI<span class="identifier">nvocation</span> <span class="identifier">invocationWithMethodSignature</span>:<span class="identifier">methodSignature</span>]</span>;</span><br><span class="line">        <span class="literal">[<span class="identifier">forwardInv</span> <span class="identifier">setTarget</span>:<span class="identifier">slf</span>]</span>;</span><br><span class="line">        <span class="literal">[<span class="identifier">forwardInv</span> <span class="identifier">setSelector</span>:<span class="identifier">origForwardSelector</span>]</span>;</span><br><span class="line">        <span class="literal">[<span class="identifier">forwardInv</span> <span class="identifier">setArgument</span>:&amp;<span class="identifier">invocation</span> <span class="identifier">atIndex</span>:<span class="number">2</span>]</span>;</span><br><span class="line">        <span class="literal">[<span class="identifier">forwardInv</span> <span class="identifier">invoke</span>]</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Class superCls = <span class="literal">[[<span class="identifier">slf</span> <span class="identifier">class</span>]</span> superclass];</span><br><span class="line">        Method superForwardMethod = <span class="keyword">class</span><span class="constructor">_getInstanceMethod(<span class="params">superCls</span>, @<span class="params">selector</span>(<span class="params">forwardInvocation</span>:)</span>);</span><br><span class="line">        void (*superForwardIMP)(id, SEL, NSInvocation *);</span><br><span class="line">        superForwardIMP = (void (*)(id, SEL, NSInvocation *))<span class="keyword">method</span><span class="constructor">_getImplementation(<span class="params">superForwardMethod</span>)</span>;</span><br><span class="line">        super<span class="constructor">ForwardIMP(<span class="params">slf</span>, @<span class="params">selector</span>(<span class="params">forwardInvocation</span>:)</span>, invocation);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果有的话，会把NSInvocation中的参数提取出来，传递给对应的补丁方法。然后通过JP_FWD_RET_CALL_JS调用js方法。通过JP_FWD_RET_CALL_JS中的</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">jsval</span> = [cb callWithArguments:args]</span><br></pre></td></tr></table></figure>
<p>获取到返回值后设置到NSInvocation中，完成方法的替换。</p>
<p>比如我们上面介绍的例子中有一个handleBtn. 原来的方法实现是空实现，后面通过JSPatch的demo.js 覆盖了这个方法，我们梳理下这是怎么实现的：</p>
<p>由于我们原有对象已经有了这个方法，只不过这个方法是空的，所以在overideMethod方法中会将原来的方法的selector名称改为_ORIGHandleBtn,指向原来的实现：</p>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line">- <span class="params">(void)</span>handleBtn:<span class="params">(id)</span>sender &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>而会在该类中添加一个_JPhandleBtn,它的实现指向补丁js中的实现。<br>并且由于该对象没有实现forwardInvocaiton 所以会为该对象新增加一个JPForwardInvocation，并且将原来的对handleBtn的调用转换为_objc_msgForward。这一切工作完成后我们来看下整个调用过程：<br>我们点击按钮后会触发handleBtn，这时候由于handleBtn的实现被替换为_objc_msgForward所以会走消息分发途径，进而走到forwardInvocaiton，由于forwardInvocaiton的实现在上面被替换为JPForwardInvocation<br>在JPForwardInvocation中会先尝试将消息转发到_JPhandleBtn看下是否有这个实现，这里由于有这个实现所以就直接将invocation参数提取出来，传递给对应的js方法执行。这就达到了整个方法替换的目的。</p>
<p><strong><strong>如何在JS环境下执行OC方法</strong></strong></p>
<p>我们上面了解到了怎么通过消息转发来达到热修复的目的，接下来我们还有一个问题就是如何在JS中执行OC方法，我们看下_evaluateScript，它的作用是将补丁js方法加载到JSContext中执行。我们还是以demo.js为例子</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="operator">+</span> (<span class="type">JSValue</span> <span class="operator">*</span>)_evaluateScript:(<span class="type">NSString</span> <span class="operator">*</span>)script withSourceURL:(<span class="type">NSURL</span> <span class="operator">*</span>)resourceURL &#123;</span><br><span class="line">    <span class="comment">//1. script 不存在或当前 iOS 版本低于 7.0 退出.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="operator">!</span>script <span class="operator">||</span> <span class="operator">!</span>[<span class="type">JSContext</span> <span class="keyword">class</span>]) &#123;</span><br><span class="line">        _exceptionBlock(@<span class="string">&quot;script is nil&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//在执行脚本之前会自动调用startEngine</span></span><br><span class="line">    [<span class="keyword">self</span> startEngine];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. 正则式构建 (?&lt;!\\\\)\\.\\s*(\\w+)\\s*\\(</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="operator">!</span>_regex) &#123;</span><br><span class="line">        _regex <span class="operator">=</span> [<span class="type">NSRegularExpression</span> regularExpressionWithPattern:_regexStr options:<span class="number">0</span> error:<span class="literal">nil</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">NSString</span> <span class="operator">*</span>formatedScript <span class="operator">=</span> [<span class="type">NSString</span> stringWithFormat:@<span class="string">&quot;;(function()&#123;try&#123;<span class="subst">\n</span>%@<span class="subst">\n</span>&#125;catch(e)&#123;_OC_catch(e.message, e.stack)&#125;&#125;)();&quot;</span>, [_regex stringByReplacingMatchesInString:script options:<span class="number">0</span> range:<span class="type">NSMakeRange</span>(<span class="number">0</span>, script.length) withTemplate:_replaceStr]];</span><br><span class="line">    <span class="comment">//4.将正则处理后的js代码加载到 context 执行.(进入 JavaScriptCore)</span></span><br><span class="line">    <span class="meta">@try</span> &#123;</span><br><span class="line">        <span class="comment">//转换 JPTableViewController.alloc().init() 为 JPTableViewController.__c(&quot;alloc&quot;)().__c(&quot;init&quot;)()</span></span><br><span class="line">        <span class="keyword">if</span> ([_context respondsToSelector:<span class="meta">@selector</span>(evaluateScript:withSourceURL:)]) &#123;</span><br><span class="line">            <span class="keyword">return</span> [_context evaluateScript:formatedScript withSourceURL:resourceURL];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> [_context evaluateScript:formatedScript];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@catch</span> (<span class="type">NSException</span> <span class="operator">*</span>exception) &#123;</span><br><span class="line">        _exceptionBlock([<span class="type">NSString</span> stringWithFormat:@<span class="string">&quot;%@&quot;</span>, exception]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>demo.js加载后会先通过正则匹配处理后再送到JSContext中，我们看下匹配替换后的formatedScript是什么样的：</p>
<figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line"><span class="comment">;(function()&#123;try&#123;</span></span><br><span class="line">defineClass(&#x27;JPViewController&#x27;, &#123;</span><br><span class="line">  handleBtn: function(<span class="name">sender</span>) &#123;</span><br><span class="line">    var tableViewCtrl = JPTableViewController.__c(<span class="string">&quot;alloc&quot;</span>)().__c(<span class="string">&quot;init&quot;</span>)()</span><br><span class="line">    self.__c(<span class="string">&quot;navigationController&quot;</span>)().__c(<span class="string">&quot;pushViewController_animated&quot;</span>)(<span class="name">tableViewCtrl</span>, YES)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">defineClass(&#x27;JPTableViewController : UITableViewController &lt;UIAlertViewDelegate&gt;&#x27;, [&#x27;data&#x27;], &#123;</span><br><span class="line">  dataSource: function() &#123;</span><br><span class="line">    var data = self.__c(<span class="string">&quot;data&quot;</span>)()<span class="comment">;</span></span><br><span class="line">    if (<span class="name">data</span>) return data<span class="comment">;</span></span><br><span class="line">    var data = []<span class="comment">;</span></span><br><span class="line">    for (<span class="name">var</span> i = <span class="number">0</span><span class="comment">; i &lt; 20; i ++) &#123;</span></span><br><span class="line">      data.__c(<span class="string">&quot;push&quot;</span>)(<span class="string">&quot;cell from js &quot;</span> + i)<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line">    self.__c(<span class="string">&quot;setData&quot;</span>)(<span class="name">data</span>)</span><br><span class="line">    return data<span class="comment">;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  numberOfSectionsInTableView: function(<span class="name">tableView</span>) &#123;</span><br><span class="line">    return <span class="number">1</span><span class="comment">;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  tableView_numberOfRowsInSection: function(<span class="name">tableView</span>, section) &#123;</span><br><span class="line">    return self.__c(<span class="string">&quot;dataSource&quot;</span>)().length<span class="comment">;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  tableView_cellForRowAtIndexPath: function(<span class="name">tableView</span>, indexPath) &#123;</span><br><span class="line">    var cell = tableView.__c(<span class="string">&quot;dequeueReusableCellWithIdentifier&quot;</span>)(<span class="string">&quot;cell&quot;</span>) </span><br><span class="line">    if (!cell) &#123;</span><br><span class="line">      cell = require(&#x27;UITableViewCell&#x27;).__c(<span class="string">&quot;alloc&quot;</span>)().__c(<span class="string">&quot;initWithStyle_reuseIdentifier&quot;</span>)(<span class="number">0</span>, <span class="string">&quot;cell&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    cell.__c(<span class="string">&quot;textLabel&quot;</span>)().__c(<span class="string">&quot;setText&quot;</span>)(<span class="name">self</span>.__c(<span class="string">&quot;dataSource&quot;</span>)()[indexPath.__c(<span class="string">&quot;row&quot;</span>)()])</span><br><span class="line">    return cell</span><br><span class="line">  &#125;,</span><br><span class="line">  tableView_heightForRowAtIndexPath: function(<span class="name">tableView</span>, indexPath) &#123;</span><br><span class="line">    return <span class="number">60</span></span><br><span class="line">  &#125;,</span><br><span class="line">  tableView_didSelectRowAtIndexPath: function(<span class="name">tableView</span>, indexPath) &#123;</span><br><span class="line">     var alertView = require(&#x27;UIAlertView&#x27;).__c(<span class="string">&quot;alloc&quot;</span>)().__c(<span class="string">&quot;initWithTitle_message_delegate_cancelButtonTitle_otherButtonTitles&quot;</span>)(<span class="string">&quot;Alert&quot;</span>,self.__c(<span class="string">&quot;dataSource&quot;</span>)()[indexPath.__c(<span class="string">&quot;row&quot;</span>)()], self, <span class="string">&quot;OK&quot;</span>,  null)<span class="comment">;</span></span><br><span class="line">     alertView.__c(<span class="string">&quot;show&quot;</span>)()</span><br><span class="line">  &#125;,</span><br><span class="line">  alertView_willDismissWithButtonIndex: function(<span class="name">alertView</span>, idx) &#123;</span><br><span class="line">    console.__c(<span class="string">&quot;log&quot;</span>)(&#x27;click btn &#x27; + alertView.__c(<span class="string">&quot;buttonTitleAtIndex&quot;</span>)(<span class="name">idx</span>).__c(<span class="string">&quot;toJS&quot;</span>)())</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;catch(<span class="name">e</span>)&#123;_OC_catch(<span class="name">e</span>.message, e.stack)&#125;&#125;)()<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<p>大家可以发现所有的xxx.XXXX 都被替换成了xxx.__c(“XXXX),为什么需要这样转换呢？我们到JSPatch.js寻找这个答案：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="attr">__c</span>: <span class="keyword">function</span>(<span class="params">methodName</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> slf = <span class="variable language_">this</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (slf <span class="keyword">instanceof</span> <span class="title class_">Boolean</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (slf[methodName]) &#123;</span><br><span class="line">    <span class="keyword">return</span> slf[methodName].<span class="title function_">bind</span>(slf);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!slf.<span class="property">__obj</span> &amp;&amp; !slf.<span class="property">__clsName</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(slf + <span class="string">&#x27;.&#x27;</span> + methodName + <span class="string">&#x27; is undefined&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (slf.<span class="property">__isSuper</span> &amp;&amp; slf.<span class="property">__clsName</span>) &#123;</span><br><span class="line">        slf.<span class="property">__clsName</span> = <span class="title function_">_OC_superClsName</span>(slf.<span class="property">__obj</span>.<span class="property">__realClsName</span> ? slf.<span class="property">__obj</span>.<span class="property">__realClsName</span>: slf.<span class="property">__clsName</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> clsName = slf.<span class="property">__clsName</span></span><br><span class="line">    <span class="keyword">if</span> (clsName &amp;&amp; _ocCls[clsName]) &#123;</span><br><span class="line">    <span class="keyword">var</span> methodType = slf.<span class="property">__obj</span> ? <span class="string">&#x27;instMethods&#x27;</span>: <span class="string">&#x27;clsMethods&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> (_ocCls[clsName][methodType][methodName]) &#123;</span><br><span class="line">        slf.<span class="property">__isSuper</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> _ocCls[clsName][methodType][methodName].<span class="title function_">bind</span>(slf)</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> args = <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">slice</span>.<span class="title function_">call</span>(<span class="variable language_">arguments</span>)</span><br><span class="line">        <span class="comment">//_methodFunc() 把相关信息传给OC，OC用 Runtime 接口调用相应方法，返回结果值，这个调用就结束了。</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">_methodFunc</span>(slf.<span class="property">__obj</span>, slf.<span class="property">__clsName</span>, methodName, args, slf.<span class="property">__isSuper</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">*  <span class="attr">instance</span>: 对象</span><br><span class="line">*  <span class="attr">clsName</span>: 类名</span><br><span class="line">*  <span class="attr">methodName</span>: 方法名</span><br><span class="line">*  <span class="attr">args</span>: 参数列表</span><br><span class="line">*  <span class="attr">isSuper</span>: 是否调用<span class="variable language_">super</span>父类的方法</span><br><span class="line">*  <span class="attr">isPerformSelector</span>:是否用performSelector方式调用</span><br><span class="line">*/</span><br><span class="line"><span class="keyword">var</span> _methodFunc = <span class="keyword">function</span>(<span class="params">instance, clsName, methodName, args, isSuper, isPerformSelector</span>) &#123;</span><br><span class="line"><span class="keyword">var</span> selectorName = methodName</span><br><span class="line"><span class="keyword">if</span> (!isPerformSelector) &#123;</span><br><span class="line">    <span class="comment">//处理得到OC中的方法SEL,参数</span></span><br><span class="line">    methodName = methodName.<span class="title function_">replace</span>(<span class="regexp">/__/g</span>, <span class="string">&quot;-&quot;</span>)</span><br><span class="line">    selectorName = methodName.<span class="title function_">replace</span>(<span class="regexp">/_/g</span>, <span class="string">&quot;:&quot;</span>).<span class="title function_">replace</span>(<span class="regexp">/-/g</span>, <span class="string">&quot;_&quot;</span>)</span><br><span class="line">    <span class="keyword">var</span> marchArr = selectorName.<span class="title function_">match</span>(<span class="regexp">/:/g</span>)</span><br><span class="line">    <span class="keyword">var</span> numOfArgs = marchArr ? marchArr.<span class="property">length</span> : <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> (args.<span class="property">length</span> &gt; numOfArgs) &#123;</span><br><span class="line">    selectorName += <span class="string">&quot;:&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//当前是否是一个实例，如果是实例调用_OC_callI否则调用_OC_callC</span></span><br><span class="line"><span class="keyword">var</span> ret = instance ? <span class="title function_">_OC_callI</span>(instance, selectorName, args, isSuper):</span><br><span class="line">                        <span class="title function_">_OC_callC</span>(clsName, selectorName, args)</span><br><span class="line"><span class="comment">//获取OC方法执行完毕的返回值，并转化成JS对象</span></span><br><span class="line"><span class="keyword">return</span> <span class="title function_">_formatOCToJS</span>(ret)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>__c 里面会调用_methodFunc，_methodFunc方法里面会根据当前方法是实例方法还是类方法决定调用_OC_callI还是_OC_callC。最后将oc中的返回值转换为JS对象返回。<br>_OC_callI还是_OC_callC是在我们初始化JSPatch引擎的时候注入到JS中的。在js中调用_OC_callI或者_OC_callC会触发调用OC层的callSelector方法,通过它将js中的补丁方法中oc相关的方法交给oc层。</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  完成oc中的方法调用</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  @param className    类名（nil --&gt; 表示实例方法）</span></span><br><span class="line"><span class="comment"> *  @param selectorName 方法SEL值</span></span><br><span class="line"><span class="comment"> *  @param arguments    方法执行参数</span></span><br><span class="line"><span class="comment"> *  @param instance     对象（js对象中的变量，如: var UIAlertView = &#123; __clsName : &#x27;UIAlertView&#x27;&#125;）</span></span><br><span class="line"><span class="comment"> *  @param isSuper      是否调用的是父类方法</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  @return 方法执行后的结果值，返回给js代码中.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">#pragma mark -</span><br><span class="line">static id call<span class="constructor">Selector(NSString <span class="operator">*</span><span class="params">className</span>, NSString <span class="operator">*</span><span class="params">selectorName</span>, JSValue <span class="operator">*</span><span class="params">arguments</span>, JSValue <span class="operator">*</span><span class="params">instance</span>, BOOL <span class="params">isSuper</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    NSString *realClsName = <span class="literal">[[<span class="identifier">instance</span> <span class="identifier">valueForProperty</span>:@&quot;<span class="identifier">__realClsName</span>&quot;]</span> toString];</span><br><span class="line">   </span><br><span class="line">    <span class="comment">///[1] 实例变量处理</span></span><br><span class="line">    <span class="keyword">if</span> (instance) &#123;</span><br><span class="line">        <span class="comment">//1.将js封装的instance对象进行拆装，得到oc对象.</span></span><br><span class="line">        instance = format<span class="constructor">JSToOC(<span class="params">instance</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">class</span><span class="constructor">_isMetaClass(<span class="params">object_getClass</span>(<span class="params">instance</span>)</span>)) &#123;</span><br><span class="line">            <span class="comment">//如果调用的是类方法则获取到类名</span></span><br><span class="line">            className = <span class="constructor">NSStringFromClass((Class)</span>instance);</span><br><span class="line">            instance = nil;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!instance<span class="operator"> || </span>instance<span class="operator"> == </span>_nilObj<span class="operator"> || </span><span class="literal">[<span class="identifier">instance</span> <span class="identifier">isKindOfClass</span>:[JPB<span class="identifier">oxing</span> <span class="identifier">class</span>]</span>]) &#123;</span><br><span class="line">            <span class="comment">//如果不是类方法，但是传入的instance 是空的则返回 nil</span></span><br><span class="line">            return @&#123;@<span class="string">&quot;__isNil&quot;</span>: @(YES)&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">///[2] 参数处理</span></span><br><span class="line">    <span class="comment">//2.将js封装的参数列表转为oc类型.</span></span><br><span class="line">    id argumentsObj = format<span class="constructor">JSToOC(<span class="params">arguments</span>)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">///[2] 解包处理</span></span><br><span class="line">    <span class="keyword">if</span> (instance<span class="operator"> &amp;&amp; </span><span class="literal">[<span class="identifier">selectorName</span> <span class="identifier">isEqualToString</span>:@&quot;<span class="identifier">toJS</span>&quot;]</span>) &#123;</span><br><span class="line"><span class="comment">//      3.如果要执行的方法是&quot;toJS&quot;，即转化为js类型，对于NSString/NSDictory/NSArray/NSData需进行特殊处理</span></span><br><span class="line"><span class="comment">//        因为JSPatch中需使用JPBoxing包装OC中的上述对象，防止JavaScriptCore.framework转换类型.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">[<span class="identifier">instance</span> <span class="identifier">isKindOfClass</span>:[NSS<span class="identifier">tring</span> <span class="identifier">class</span>]</span>]<span class="operator"> || </span><span class="literal">[<span class="identifier">instance</span> <span class="identifier">isKindOfClass</span>:[NSD<span class="identifier">ictionary</span> <span class="identifier">class</span>]</span>]<span class="operator"> || </span><span class="literal">[<span class="identifier">instance</span> <span class="identifier">isKindOfClass</span>:[NSA<span class="identifier">rray</span> <span class="identifier">class</span>]</span>]<span class="operator"> || </span><span class="literal">[<span class="identifier">instance</span> <span class="identifier">isKindOfClass</span>:[NSD<span class="identifier">ate</span> <span class="identifier">class</span>]</span>]) &#123;</span><br><span class="line">            return <span class="constructor">_unboxOCObjectToJS(<span class="params">instance</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">///[3] 获取到Class对象</span></span><br><span class="line">    <span class="comment">//4.根据类名与selectorName获得对应的类对象与selector</span></span><br><span class="line">    Class cls = instance ? <span class="literal">[<span class="identifier">instance</span> <span class="identifier">class</span>]</span> : <span class="constructor">NSClassFromString(<span class="params">className</span>)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">///[3] 获取到SEL对象</span></span><br><span class="line">    SEL selector = <span class="constructor">NSSelectorFromString(<span class="params">selectorName</span>)</span>;</span><br><span class="line">    </span><br><span class="line">    NSString *superClassName = nil;</span><br><span class="line">    <span class="comment">//5.判断是否调用的是父类的方法，如果是，走父类的方法实现</span></span><br><span class="line">    <span class="keyword">if</span> (isSuper) &#123;</span><br><span class="line">        <span class="comment">//5.1 定义新的SEL:SUPERSEL</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">///[4] 构建出SUPER_seletcorName</span></span><br><span class="line">        NSString *superSelectorName = <span class="literal">[NSS<span class="identifier">tring</span> <span class="identifier">stringWithFormat</span>:@&quot;SUPER<span class="identifier">_</span>%@&quot;, <span class="identifier">selectorName</span>]</span>;</span><br><span class="line">        SEL superSelector = <span class="constructor">NSSelectorFromString(<span class="params">superSelectorName</span>)</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">///[5] 构建出superCls</span></span><br><span class="line">        Class superCls;</span><br><span class="line">        <span class="keyword">if</span> (realClsName.length) &#123;</span><br><span class="line">            Class defineClass = <span class="constructor">NSClassFromString(<span class="params">realClsName</span>)</span>;</span><br><span class="line">            superCls = defineClass ? <span class="literal">[<span class="identifier">defineClass</span> <span class="identifier">superclass</span>]</span> : <span class="literal">[<span class="identifier">cls</span> <span class="identifier">superclass</span>]</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            superCls = <span class="literal">[<span class="identifier">cls</span> <span class="identifier">superclass</span>]</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        Method superMethod = <span class="keyword">class</span><span class="constructor">_getInstanceMethod(<span class="params">superCls</span>, <span class="params">selector</span>)</span>;</span><br><span class="line">        IMP superIMP = <span class="keyword">method</span><span class="constructor">_getImplementation(<span class="params">superMethod</span>)</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5.2  将SUPERSEL指向superIMP的实现</span></span><br><span class="line">        <span class="comment">///[6] 添加superSelector方法</span></span><br><span class="line">        <span class="keyword">class</span><span class="constructor">_addMethod(<span class="params">cls</span>, <span class="params">superSelector</span>, <span class="params">superIMP</span>, <span class="params">method_getTypeEncoding</span>(<span class="params">superMethod</span>)</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//5.3  查找父类中是否有添加JPSEL的实现</span></span><br><span class="line">        NSString *JPSelectorName = <span class="literal">[NSS<span class="identifier">tring</span> <span class="identifier">stringWithFormat</span>:@&quot;<span class="identifier">_JP</span>%@&quot;, <span class="identifier">selectorName</span>]</span>;</span><br><span class="line">        JSValue *overideFunction = _JSOverideMethods<span class="literal">[<span class="identifier">superCls</span>]</span><span class="literal">[JPS<span class="identifier">electorName</span>]</span>;</span><br><span class="line">        <span class="keyword">if</span> (overideFunction) &#123;</span><br><span class="line">            <span class="comment">// 如果有，进行imp替换</span></span><br><span class="line">            override<span class="constructor">Method(<span class="params">cls</span>, <span class="params">superSelectorName</span>, <span class="params">overideFunction</span>, NO, NULL)</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        selector = superSelector;</span><br><span class="line">        superClassName = <span class="constructor">NSStringFromClass(<span class="params">superCls</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    NSMutableArray *_markArray;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//6.通过类对象与selector构造对应的NSMethodSignature签名</span></span><br><span class="line">    NSInvocation *invocation;</span><br><span class="line">    NSMethodSignature *methodSignature;</span><br><span class="line">    <span class="keyword">if</span> (!_JSMethodSignatureCache) &#123;</span><br><span class="line">        _JSMethodSignatureCache = <span class="literal">[[NSM<span class="identifier">utableDictionary</span> <span class="identifier">alloc</span>]</span>init];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (instance) &#123;</span><br><span class="line">        <span class="literal">[<span class="identifier">_JSMethodSignatureLock</span> <span class="identifier">lock</span>]</span>;</span><br><span class="line">        <span class="keyword">if</span> (!_JSMethodSignatureCache<span class="literal">[<span class="identifier">cls</span>]</span>) &#123;</span><br><span class="line">            _JSMethodSignatureCache<span class="literal">[(<span class="identifier">id</span>&lt;NSC<span class="identifier">opying</span>&gt;)<span class="identifier">cls</span>]</span> = <span class="literal">[[NSM<span class="identifier">utableDictionary</span> <span class="identifier">alloc</span>]</span>init];</span><br><span class="line">        &#125;</span><br><span class="line">        methodSignature = _JSMethodSignatureCache<span class="literal">[<span class="identifier">cls</span>]</span><span class="literal">[<span class="identifier">selectorName</span>]</span>;</span><br><span class="line">        <span class="keyword">if</span> (!methodSignature) &#123;</span><br><span class="line">            <span class="comment">//区别在这里</span></span><br><span class="line">            methodSignature = <span class="literal">[<span class="identifier">cls</span> <span class="identifier">instanceMethodSignatureForSelector</span>:<span class="identifier">selector</span>]</span>;</span><br><span class="line">            methodSignature = fix<span class="constructor">Signature(<span class="params">methodSignature</span>)</span>;</span><br><span class="line">            _JSMethodSignatureCache<span class="literal">[<span class="identifier">cls</span>]</span><span class="literal">[<span class="identifier">selectorName</span>]</span> = methodSignature;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">[<span class="identifier">_JSMethodSignatureLock</span> <span class="identifier">unlock</span>]</span>;</span><br><span class="line">        <span class="keyword">if</span> (!methodSignature) &#123;</span><br><span class="line">            <span class="constructor">_exceptionBlock([NSString <span class="params">stringWithFormat</span>:@<span class="string">&quot;unrecognized selector %@ for instance %@&quot;</span>, <span class="params">selectorName</span>, <span class="params">instance</span>])</span>;</span><br><span class="line">            return nil;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//7.根据签名构造NSInvocation对象</span></span><br><span class="line">        invocation = <span class="literal">[NSI<span class="identifier">nvocation</span> <span class="identifier">invocationWithMethodSignature</span>:<span class="identifier">methodSignature</span>]</span>;</span><br><span class="line">        <span class="comment">//8.为invocation对象设置target</span></span><br><span class="line">        <span class="literal">[<span class="identifier">invocation</span> <span class="identifier">setTarget</span>:<span class="identifier">instance</span>]</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//区别在这里</span></span><br><span class="line">        methodSignature = <span class="literal">[<span class="identifier">cls</span> <span class="identifier">methodSignatureForSelector</span>:<span class="identifier">selector</span>]</span>;</span><br><span class="line">        methodSignature = fix<span class="constructor">Signature(<span class="params">methodSignature</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (!methodSignature) &#123;</span><br><span class="line">            <span class="constructor">_exceptionBlock([NSString <span class="params">stringWithFormat</span>:@<span class="string">&quot;unrecognized selector %@ for class %@&quot;</span>, <span class="params">selectorName</span>, <span class="params">className</span>])</span>;</span><br><span class="line">            return nil;</span><br><span class="line">        &#125;</span><br><span class="line">        invocation = <span class="literal">[NSI<span class="identifier">nvocation</span> <span class="identifier">invocationWithMethodSignature</span>:<span class="identifier">methodSignature</span>]</span>;</span><br><span class="line">        <span class="literal">[<span class="identifier">invocation</span> <span class="identifier">setTarget</span>:<span class="identifier">cls</span>]</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 9.为invocation对象设置selector</span></span><br><span class="line">    <span class="literal">[<span class="identifier">invocation</span> <span class="identifier">setSelector</span>:<span class="identifier">selector</span>]</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//10.根据签名得知每个参数的实际类型</span></span><br><span class="line">    NSUInteger numberOfArguments = methodSignature.numberOfArguments;</span><br><span class="line">    NSInteger inputArguments = <span class="literal">[(NSA<span class="identifier">rray</span> <span class="operator">*</span>)<span class="identifier">argumentsObj</span> <span class="identifier">count</span>]</span>;</span><br><span class="line">    <span class="keyword">if</span> (inputArguments &gt; numberOfArguments - <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="comment">//10.1 多参数方法仅支持 id 类型参数和 id 类型返回,直接revoke并返回.</span></span><br><span class="line">        <span class="comment">// calling variable argument method, only support parameter type `id` and return type `id`</span></span><br><span class="line">        id sender = instance != nil ? instance : cls;</span><br><span class="line">        <span class="comment">//msg_send方法</span></span><br><span class="line">        id result = invoke<span class="constructor">VariableParameterMethod(<span class="params">argumentsObj</span>, <span class="params">methodSignature</span>, <span class="params">sender</span>, <span class="params">selector</span>)</span>;</span><br><span class="line">        return format<span class="constructor">OCToJS(<span class="params">result</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">///参数处理</span></span><br><span class="line">    <span class="comment">//10.2 将JS传递过来的参数进行对应的转换(如 NSNumber -&gt; int)，转换后为 NSInvoca</span></span><br><span class="line">    <span class="keyword">for</span> (NSUInteger i = <span class="number">2</span>; i &lt; numberOfArguments; i++) &#123;</span><br><span class="line">        const <span class="built_in">char</span> *argumentType = <span class="literal">[<span class="identifier">methodSignature</span> <span class="identifier">getArgumentTypeAtIndex</span>:<span class="identifier">i</span>]</span>;</span><br><span class="line">        id valObj = argumentsObj<span class="literal">[<span class="identifier">i</span>-<span class="number">2</span>]</span>;</span><br><span class="line">        switch (argumentType<span class="literal">[<span class="number">0</span>]</span><span class="operator"> == </span><span class="character">&#x27;r&#x27;</span> ? argumentType<span class="literal">[<span class="number">1</span>]</span> : argumentType<span class="literal">[<span class="number">0</span>]</span>) &#123;</span><br><span class="line">                </span><br><span class="line">                #define <span class="constructor">JP_CALL_ARG_CASE(<span class="params">_typeString</span>, <span class="params">_type</span>, <span class="params">_selector</span>)</span> \</span><br><span class="line">                case _typeString: &#123;                              \</span><br><span class="line">                    _type value = <span class="literal">[<span class="identifier">valObj</span> <span class="identifier">_selector</span>]</span>;                     \</span><br><span class="line">                    <span class="literal">[<span class="identifier">invocation</span> <span class="identifier">setArgument</span>:&amp;<span class="identifier">value</span> <span class="identifier">atIndex</span>:<span class="identifier">i</span>]</span>;\</span><br><span class="line">                    break; \</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="constructor">JP_CALL_ARG_CASE(&#x27;<span class="params">c</span>&#x27;, <span class="params">char</span>, <span class="params">charValue</span>)</span></span><br><span class="line">                <span class="constructor">JP_CALL_ARG_CASE(&#x27;C&#x27;, <span class="params">unsigned</span> <span class="params">char</span>, <span class="params">unsignedCharValue</span>)</span></span><br><span class="line">                <span class="constructor">JP_CALL_ARG_CASE(&#x27;<span class="params">s</span>&#x27;, <span class="params">short</span>, <span class="params">shortValue</span>)</span></span><br><span class="line">                <span class="constructor">JP_CALL_ARG_CASE(&#x27;S&#x27;, <span class="params">unsigned</span> <span class="params">short</span>, <span class="params">unsignedShortValue</span>)</span></span><br><span class="line">                <span class="constructor">JP_CALL_ARG_CASE(&#x27;<span class="params">i</span>&#x27;, <span class="params">int</span>, <span class="params">intValue</span>)</span></span><br><span class="line">                <span class="constructor">JP_CALL_ARG_CASE(&#x27;I&#x27;, <span class="params">unsigned</span> <span class="params">int</span>, <span class="params">unsignedIntValue</span>)</span></span><br><span class="line">                <span class="constructor">JP_CALL_ARG_CASE(&#x27;<span class="params">l</span>&#x27;, <span class="params">long</span>, <span class="params">longValue</span>)</span></span><br><span class="line">                <span class="constructor">JP_CALL_ARG_CASE(&#x27;L&#x27;, <span class="params">unsigned</span> <span class="params">long</span>, <span class="params">unsignedLongValue</span>)</span></span><br><span class="line">                <span class="constructor">JP_CALL_ARG_CASE(&#x27;<span class="params">q</span>&#x27;, <span class="params">long</span> <span class="params">long</span>, <span class="params">longLongValue</span>)</span></span><br><span class="line">                <span class="constructor">JP_CALL_ARG_CASE(&#x27;Q&#x27;, <span class="params">unsigned</span> <span class="params">long</span> <span class="params">long</span>, <span class="params">unsignedLongLongValue</span>)</span></span><br><span class="line">                <span class="constructor">JP_CALL_ARG_CASE(&#x27;<span class="params">f</span>&#x27;, <span class="params">float</span>, <span class="params">floatValue</span>)</span></span><br><span class="line">                <span class="constructor">JP_CALL_ARG_CASE(&#x27;<span class="params">d</span>&#x27;, <span class="params">double</span>, <span class="params">doubleValue</span>)</span></span><br><span class="line">                <span class="constructor">JP_CALL_ARG_CASE(&#x27;B&#x27;, BOOL, <span class="params">boolValue</span>)</span></span><br><span class="line">                </span><br><span class="line">            case <span class="character">&#x27;:&#x27;</span>: &#123;</span><br><span class="line">                SEL value = nil;</span><br><span class="line">                <span class="keyword">if</span> (valObj != _nilObj) &#123;</span><br><span class="line">                    value = <span class="constructor">NSSelectorFromString(<span class="params">valObj</span>)</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="literal">[<span class="identifier">invocation</span> <span class="identifier">setArgument</span>:&amp;<span class="identifier">value</span> <span class="identifier">atIndex</span>:<span class="identifier">i</span>]</span>;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            case <span class="character">&#x27;&#123;&#x27;</span>: &#123;</span><br><span class="line">                NSString *typeString = extract<span class="constructor">StructName([NSString <span class="params">stringWithUTF8String</span>:<span class="params">argumentType</span>])</span>;</span><br><span class="line">                JSValue *<span class="keyword">val</span> = arguments<span class="literal">[<span class="identifier">i</span>-<span class="number">2</span>]</span>;</span><br><span class="line">                #define <span class="constructor">JP_CALL_ARG_STRUCT(<span class="params">_type</span>, <span class="params">_methodName</span>)</span> \</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">[<span class="identifier">typeString</span> <span class="identifier">rangeOfString</span>:@#<span class="identifier">_type</span>]</span>.location != NSNotFound) &#123;    \</span><br><span class="line">                    _type value = <span class="literal">[<span class="identifier">val</span> <span class="identifier">_methodName</span>]</span>;  \</span><br><span class="line">                    <span class="literal">[<span class="identifier">invocation</span> <span class="identifier">setArgument</span>:&amp;<span class="identifier">value</span> <span class="identifier">atIndex</span>:<span class="identifier">i</span>]</span>;  \</span><br><span class="line">                    break; \</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="constructor">JP_CALL_ARG_STRUCT(CGRect, <span class="params">toRect</span>)</span></span><br><span class="line">                <span class="constructor">JP_CALL_ARG_STRUCT(CGPoint, <span class="params">toPoint</span>)</span></span><br><span class="line">                <span class="constructor">JP_CALL_ARG_STRUCT(CGSize, <span class="params">toSize</span>)</span></span><br><span class="line">                <span class="constructor">JP_CALL_ARG_STRUCT(NSRange, <span class="params">toRange</span>)</span></span><br><span class="line">                @synchronized (_context) &#123;</span><br><span class="line">                    NSDictionary *structDefine = _registeredStruct<span class="literal">[<span class="identifier">typeString</span>]</span>;</span><br><span class="line">                    <span class="keyword">if</span> (structDefine) &#123;</span><br><span class="line">                        size_t size = size<span class="constructor">OfStructTypes(<span class="params">structDefine</span>[@<span class="string">&quot;types&quot;</span>])</span>;</span><br><span class="line">                        void *ret = malloc(size);</span><br><span class="line">                        get<span class="constructor">StructDataWithDict(<span class="params">ret</span>, <span class="params">valObj</span>, <span class="params">structDefine</span>)</span>;</span><br><span class="line">                        <span class="literal">[<span class="identifier">invocation</span> <span class="identifier">setArgument</span>:<span class="identifier">ret</span> <span class="identifier">atIndex</span>:<span class="identifier">i</span>]</span>;</span><br><span class="line">                        free(ret);</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            case <span class="character">&#x27;*&#x27;</span>:</span><br><span class="line">            case <span class="character">&#x27;^&#x27;</span>: &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">[<span class="identifier">valObj</span> <span class="identifier">isKindOfClass</span>:[JPB<span class="identifier">oxing</span> <span class="identifier">class</span>]</span>]) &#123;</span><br><span class="line">                    void *value = <span class="literal">[((JPB<span class="identifier">oxing</span> <span class="operator">*</span>)<span class="identifier">valObj</span>) <span class="identifier">unboxPointer</span>]</span>;</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> (argumentType<span class="literal">[<span class="number">1</span>]</span><span class="operator"> == </span><span class="character">&#x27;@&#x27;</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!_TMPMemoryPool) &#123;</span><br><span class="line">                            _TMPMemoryPool = <span class="literal">[[NSM<span class="identifier">utableDictionary</span> <span class="identifier">alloc</span>]</span> init];</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (!_markArray) &#123;</span><br><span class="line">                            _markArray = <span class="literal">[[NSM<span class="identifier">utableArray</span> <span class="identifier">alloc</span>]</span> init];</span><br><span class="line">                        &#125;</span><br><span class="line">                        memset(value, <span class="number">0</span>, sizeof(id));</span><br><span class="line">                        <span class="literal">[<span class="identifier">_markArray</span> <span class="identifier">addObject</span>:<span class="identifier">valObj</span>]</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="literal">[<span class="identifier">invocation</span> <span class="identifier">setArgument</span>:&amp;<span class="identifier">value</span> <span class="identifier">atIndex</span>:<span class="identifier">i</span>]</span>;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            case <span class="character">&#x27;#&#x27;</span>: &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">[<span class="identifier">valObj</span> <span class="identifier">isKindOfClass</span>:[JPB<span class="identifier">oxing</span> <span class="identifier">class</span>]</span>]) &#123;</span><br><span class="line">                    Class value = <span class="literal">[((JPB<span class="identifier">oxing</span> <span class="operator">*</span>)<span class="identifier">valObj</span>) <span class="identifier">unboxClass</span>]</span>;</span><br><span class="line">                    <span class="literal">[<span class="identifier">invocation</span> <span class="identifier">setArgument</span>:&amp;<span class="identifier">value</span> <span class="identifier">atIndex</span>:<span class="identifier">i</span>]</span>;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            default: &#123;</span><br><span class="line">                <span class="keyword">if</span> (valObj<span class="operator"> == </span>_nullObj) &#123;</span><br><span class="line">                    valObj = <span class="literal">[NSN<span class="identifier">ull</span> <span class="identifier">null</span>]</span>;</span><br><span class="line">                    <span class="literal">[<span class="identifier">invocation</span> <span class="identifier">setArgument</span>:&amp;<span class="identifier">valObj</span> <span class="identifier">atIndex</span>:<span class="identifier">i</span>]</span>;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (valObj<span class="operator"> == </span>_nilObj<span class="operator"> ||</span></span><br><span class="line"><span class="operator">                    </span>(<span class="literal">[<span class="identifier">valObj</span> <span class="identifier">isKindOfClass</span>:[NSN<span class="identifier">umber</span> <span class="identifier">class</span>]</span>]<span class="operator"> &amp;&amp; </span>strcmp(<span class="literal">[<span class="identifier">valObj</span> <span class="identifier">objCType</span>]</span>, <span class="string">&quot;c&quot;</span>)<span class="operator"> == </span><span class="number">0</span><span class="operator"> &amp;&amp; </span>!<span class="literal">[<span class="identifier">valObj</span> <span class="identifier">boolValue</span>]</span>)) &#123;</span><br><span class="line">                    valObj = nil;</span><br><span class="line">                    <span class="literal">[<span class="identifier">invocation</span> <span class="identifier">setArgument</span>:&amp;<span class="identifier">valObj</span> <span class="identifier">atIndex</span>:<span class="identifier">i</span>]</span>;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">[(JSV<span class="identifier">alue</span> <span class="operator">*</span>)<span class="identifier">arguments</span>[<span class="identifier">i</span>-<span class="number">2</span>]</span> hasProperty:@<span class="string">&quot;__isBlock&quot;</span>]) &#123;</span><br><span class="line">                    JSValue *blkJSVal = arguments<span class="literal">[<span class="identifier">i</span>-<span class="number">2</span>]</span>;</span><br><span class="line">                    Class JPBlockClass = <span class="constructor">NSClassFromString(@<span class="string">&quot;JPBlock&quot;</span>)</span>;</span><br><span class="line">                    <span class="keyword">if</span> (JPBlockClass<span class="operator"> &amp;&amp; </span>!<span class="literal">[<span class="identifier">blkJSVal</span>[@&quot;<span class="identifier">blockObj</span>&quot;]</span> isUndefined]) &#123;</span><br><span class="line">                        __autoreleasing id cb = <span class="literal">[JPB<span class="identifier">lockClass</span> <span class="identifier">performSelector</span>:@<span class="identifier">selector</span>(<span class="identifier">blockWithBlockObj</span>:) <span class="identifier">withObject</span>:[<span class="identifier">blkJSVal</span>[@&quot;<span class="identifier">blockObj</span>&quot;]</span> toObject]];</span><br><span class="line">                        <span class="literal">[<span class="identifier">invocation</span> <span class="identifier">setArgument</span>:&amp;<span class="identifier">cb</span> <span class="identifier">atIndex</span>:<span class="identifier">i</span>]</span>;</span><br><span class="line">                        <span class="constructor">Block_release((<span class="params">__bridge</span> <span class="params">void</span> <span class="operator">*</span>)</span>cb);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        __autoreleasing id cb = gen<span class="constructor">CallbackBlock(<span class="params">arguments</span>[<span class="params">i</span>-2])</span>;</span><br><span class="line">                        <span class="literal">[<span class="identifier">invocation</span> <span class="identifier">setArgument</span>:&amp;<span class="identifier">cb</span> <span class="identifier">atIndex</span>:<span class="identifier">i</span>]</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="literal">[<span class="identifier">invocation</span> <span class="identifier">setArgument</span>:&amp;<span class="identifier">valObj</span> <span class="identifier">atIndex</span>:<span class="identifier">i</span>]</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (superClassName) _currInvokeSuperClsName<span class="literal">[<span class="identifier">selectorName</span>]</span> = superClassName;</span><br><span class="line">    <span class="comment">//11.执行 invoke 方法,并且传递指定的参数</span></span><br><span class="line">    <span class="literal">[<span class="identifier">invocation</span> <span class="identifier">invoke</span>]</span>;</span><br><span class="line">    <span class="keyword">if</span> (superClassName) <span class="literal">[<span class="identifier">_currInvokeSuperClsName</span> <span class="identifier">removeObjectForKey</span>:<span class="identifier">selectorName</span>]</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">[<span class="identifier">_markArray</span> <span class="identifier">count</span>]</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (JPBoxing *box <span class="keyword">in</span> _markArray) &#123;</span><br><span class="line">            void *pointer = <span class="literal">[<span class="identifier">box</span> <span class="identifier">unboxPointer</span>]</span>;</span><br><span class="line">            id obj = *((__unsafe_unretained id *)pointer);</span><br><span class="line">            <span class="keyword">if</span> (obj) &#123;</span><br><span class="line">                @synchronized(_TMPMemoryPool) &#123;</span><br><span class="line">                    <span class="literal">[<span class="identifier">_TMPMemoryPool</span> <span class="identifier">setObject</span>:<span class="identifier">obj</span> <span class="identifier">forKey</span>:[NSN<span class="identifier">umber</span> <span class="identifier">numberWithInteger</span>:[(NSO<span class="identifier">bject</span><span class="operator">*</span>)<span class="identifier">obj</span> <span class="identifier">hash</span>]</span>]];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">char</span> returnType<span class="literal">[<span class="number">255</span>]</span>;</span><br><span class="line">    strcpy(returnType, <span class="literal">[<span class="identifier">methodSignature</span> <span class="identifier">methodReturnType</span>]</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Restore the return type</span></span><br><span class="line">    <span class="keyword">if</span> (strcmp(returnType, @encode(JPDouble))<span class="operator"> == </span><span class="number">0</span>) &#123;</span><br><span class="line">        strcpy(returnType, @encode(double));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (strcmp(returnType, @encode(JPFloat))<span class="operator"> == </span><span class="number">0</span>) &#123;</span><br><span class="line">        strcpy(returnType, @encode(<span class="built_in">float</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    id returnValue;</span><br><span class="line">    <span class="comment">//12. 获取 invocation 运行返回值.</span></span><br><span class="line">    <span class="keyword">if</span> (strncmp(returnType, <span class="string">&quot;v&quot;</span>, <span class="number">1</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (strncmp(returnType, <span class="string">&quot;@&quot;</span>, <span class="number">1</span>)<span class="operator"> == </span><span class="number">0</span>) &#123;</span><br><span class="line">            void *result;</span><br><span class="line">            <span class="literal">[<span class="identifier">invocation</span> <span class="identifier">getReturnValue</span>:&amp;<span class="identifier">result</span>]</span>;</span><br><span class="line">            <span class="comment">// 13. 将返回值封装成JS对应的对象并返回.</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">//For performance, ignore the other methods prefix with alloc/new/copy/mutableCopy</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">[<span class="identifier">selectorName</span> <span class="identifier">isEqualToString</span>:@&quot;<span class="identifier">alloc</span>&quot;]</span><span class="operator"> || </span><span class="literal">[<span class="identifier">selectorName</span> <span class="identifier">isEqualToString</span>:@&quot;<span class="identifier">new</span>&quot;]</span><span class="operator"> ||</span></span><br><span class="line"><span class="operator">                </span><span class="literal">[<span class="identifier">selectorName</span> <span class="identifier">isEqualToString</span>:@&quot;<span class="identifier">copy</span>&quot;]</span><span class="operator"> || </span><span class="literal">[<span class="identifier">selectorName</span> <span class="identifier">isEqualToString</span>:@&quot;<span class="identifier">mutableCopy</span>&quot;]</span>) &#123;</span><br><span class="line">                returnValue = (__bridge_transfer id)result;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                returnValue = (__bridge id)result;</span><br><span class="line">            &#125;</span><br><span class="line">            return format<span class="constructor">OCToJS(<span class="params">returnValue</span>)</span>;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            switch (returnType<span class="literal">[<span class="number">0</span>]</span><span class="operator"> == </span><span class="character">&#x27;r&#x27;</span> ? returnType<span class="literal">[<span class="number">1</span>]</span> : returnType<span class="literal">[<span class="number">0</span>]</span>) &#123;</span><br><span class="line">                    </span><br><span class="line">                #define <span class="constructor">JP_CALL_RET_CASE(<span class="params">_typeString</span>, <span class="params">_type</span>)</span> \</span><br><span class="line">                case _typeString: &#123;                              \</span><br><span class="line">                    _type tempResultSet; \</span><br><span class="line">                    <span class="literal">[<span class="identifier">invocation</span> <span class="identifier">getReturnValue</span>:&amp;<span class="identifier">tempResultSet</span>]</span>;\</span><br><span class="line">                    returnValue = @(tempResultSet); \</span><br><span class="line">                    break; \</span><br><span class="line">                &#125;</span><br><span class="line">                    </span><br><span class="line">                <span class="constructor">JP_CALL_RET_CASE(&#x27;<span class="params">c</span>&#x27;, <span class="params">char</span>)</span></span><br><span class="line">                <span class="constructor">JP_CALL_RET_CASE(&#x27;C&#x27;, <span class="params">unsigned</span> <span class="params">char</span>)</span></span><br><span class="line">                <span class="constructor">JP_CALL_RET_CASE(&#x27;<span class="params">s</span>&#x27;, <span class="params">short</span>)</span></span><br><span class="line">                <span class="constructor">JP_CALL_RET_CASE(&#x27;S&#x27;, <span class="params">unsigned</span> <span class="params">short</span>)</span></span><br><span class="line">                <span class="constructor">JP_CALL_RET_CASE(&#x27;<span class="params">i</span>&#x27;, <span class="params">int</span>)</span></span><br><span class="line">                <span class="constructor">JP_CALL_RET_CASE(&#x27;I&#x27;, <span class="params">unsigned</span> <span class="params">int</span>)</span></span><br><span class="line">                <span class="constructor">JP_CALL_RET_CASE(&#x27;<span class="params">l</span>&#x27;, <span class="params">long</span>)</span></span><br><span class="line">                <span class="constructor">JP_CALL_RET_CASE(&#x27;L&#x27;, <span class="params">unsigned</span> <span class="params">long</span>)</span></span><br><span class="line">                <span class="constructor">JP_CALL_RET_CASE(&#x27;<span class="params">q</span>&#x27;, <span class="params">long</span> <span class="params">long</span>)</span></span><br><span class="line">                <span class="constructor">JP_CALL_RET_CASE(&#x27;Q&#x27;, <span class="params">unsigned</span> <span class="params">long</span> <span class="params">long</span>)</span></span><br><span class="line">                <span class="constructor">JP_CALL_RET_CASE(&#x27;<span class="params">f</span>&#x27;, <span class="params">float</span>)</span></span><br><span class="line">                <span class="constructor">JP_CALL_RET_CASE(&#x27;<span class="params">d</span>&#x27;, <span class="params">double</span>)</span></span><br><span class="line">                <span class="constructor">JP_CALL_RET_CASE(&#x27;B&#x27;, BOOL)</span></span><br><span class="line"></span><br><span class="line">                case <span class="character">&#x27;&#123;&#x27;</span>: &#123;</span><br><span class="line">                    NSString *typeString = extract<span class="constructor">StructName([NSString <span class="params">stringWithUTF8String</span>:<span class="params">returnType</span>])</span>;</span><br><span class="line">                    #define <span class="constructor">JP_CALL_RET_STRUCT(<span class="params">_type</span>, <span class="params">_methodName</span>)</span> \</span><br><span class="line">                    <span class="keyword">if</span> (<span class="literal">[<span class="identifier">typeString</span> <span class="identifier">rangeOfString</span>:@#<span class="identifier">_type</span>]</span>.location != NSNotFound) &#123;    \</span><br><span class="line">                        _type result;   \</span><br><span class="line">                        <span class="literal">[<span class="identifier">invocation</span> <span class="identifier">getReturnValue</span>:&amp;<span class="identifier">result</span>]</span>;    \</span><br><span class="line">                        return <span class="literal">[JSV<span class="identifier">alue</span> <span class="identifier">_methodName</span>:<span class="identifier">result</span> <span class="identifier">inContext</span>:<span class="identifier">_context</span>]</span>;    \</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="constructor">JP_CALL_RET_STRUCT(CGRect, <span class="params">valueWithRect</span>)</span></span><br><span class="line">                    <span class="constructor">JP_CALL_RET_STRUCT(CGPoint, <span class="params">valueWithPoint</span>)</span></span><br><span class="line">                    <span class="constructor">JP_CALL_RET_STRUCT(CGSize, <span class="params">valueWithSize</span>)</span></span><br><span class="line">                    <span class="constructor">JP_CALL_RET_STRUCT(NSRange, <span class="params">valueWithRange</span>)</span></span><br><span class="line">                    @synchronized (_context) &#123;</span><br><span class="line">                        NSDictionary *structDefine = _registeredStruct<span class="literal">[<span class="identifier">typeString</span>]</span>;</span><br><span class="line">                        <span class="keyword">if</span> (structDefine) &#123;</span><br><span class="line">                            size_t size = size<span class="constructor">OfStructTypes(<span class="params">structDefine</span>[@<span class="string">&quot;types&quot;</span>])</span>;</span><br><span class="line">                            void *ret = malloc(size);</span><br><span class="line">                            <span class="literal">[<span class="identifier">invocation</span> <span class="identifier">getReturnValue</span>:<span class="identifier">ret</span>]</span>;</span><br><span class="line">                            NSDictionary *dict = get<span class="constructor">DictOfStruct(<span class="params">ret</span>, <span class="params">structDefine</span>)</span>;</span><br><span class="line">                            free(ret);</span><br><span class="line">                            return dict;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                case <span class="character">&#x27;*&#x27;</span>:</span><br><span class="line">                case <span class="character">&#x27;^&#x27;</span>: &#123;</span><br><span class="line">                    void *result;</span><br><span class="line">                    <span class="literal">[<span class="identifier">invocation</span> <span class="identifier">getReturnValue</span>:&amp;<span class="identifier">result</span>]</span>;</span><br><span class="line">                    returnValue = format<span class="constructor">OCToJS([JPBoxing <span class="params">boxPointer</span>:<span class="params">result</span>])</span>;</span><br><span class="line">                    <span class="keyword">if</span> (strncmp(returnType, <span class="string">&quot;^&#123;CG&quot;</span>, <span class="number">4</span>)<span class="operator"> == </span><span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!_pointersToRelease) &#123;</span><br><span class="line">                            _pointersToRelease = <span class="literal">[[NSM<span class="identifier">utableArray</span> <span class="identifier">alloc</span>]</span> init];</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="literal">[<span class="identifier">_pointersToRelease</span> <span class="identifier">addObject</span>:[NSV<span class="identifier">alue</span> <span class="identifier">valueWithPointer</span>:<span class="identifier">result</span>]</span>];</span><br><span class="line">                        <span class="constructor">CFRetain(<span class="params">result</span>)</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                case <span class="character">&#x27;#&#x27;</span>: &#123;</span><br><span class="line">                    Class result;</span><br><span class="line">                    <span class="literal">[<span class="identifier">invocation</span> <span class="identifier">getReturnValue</span>:&amp;<span class="identifier">result</span>]</span>;</span><br><span class="line">                    returnValue = format<span class="constructor">OCToJS([JPBoxing <span class="params">boxClass</span>:<span class="params">result</span>])</span>;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            return returnValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return nil;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>callSelector代码很长但是它所处理的任务比较比较明确，它主要是通过js传过来的参数来构建一个Invocation 通过[invocation invoke]来执行对应的方法。代码细节部分已经给出了较为详细的注解大家可以看下整个流程。</p>
<p>我们这里回顾下整个过程；</p>
<p>在启动JSPatch 引擎之后会向Context注入一系列的OC方法给JS回调。<br>紧接着加载JSPatch.js 它里面主要定义了一些关键方法，最主要的是__c,它会从中提取到OC消息转发所必须的一系列参数，通过_OC_callI或者_OC_callC 传给 OC 层， OC 层中调用callSelector 方法，通过js传过来的参数来构建一个Invocation 通过[invocation invoke]来执行对应的方法。<br>而在OC层中加载补丁js脚本后会将脚本中的xxx.XXXX 正则替换为xxx.__c(“XXXX”)，这样通过上面的解释后调用OC层方法，如果忽略掉这部分的整个细节，整个过程是js 补丁脚本中的 xxx.XXXX 最后会转为 OC中的[invocation invoke]<br>是不是有点巧妙？</p>
<hr>
<p><strong><strong>总结</strong></strong></p>
<p>这篇博客主要从如何通过消息转发机制来使用js补丁方法&#x2F;类来替换现有的方法，从而达到热修复的目的。以及如何将js中OC相关的代码交给OC层来处理。第一部分思路有点和Aspect类似，大家可以细细体会下，很巧妙的一个方案。下面是JSPatch的一个简单的框图。</p>
<p><img src="/2019/10/08/%E5%9B%BE%E8%A7%A3iOS%E7%B3%BB%E5%88%97%E4%B9%8BJSPatch-%E4%B8%80-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/001.png"></p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/iOS-%E5%BC%80%E6%BA%90%E5%BA%93%E5%88%86%E6%9E%90/">iOS 开源库分析</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/iOS-开源库分析/">iOS 开源库分析</a>
  </div>

</div>



</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2019/10/12/图解iOS系列之Aspect-一-重要的类及关系介绍/" title="Aspect 源码解析">
  <span>
  Aspect 源码解析</span>
</a>
</div>


<div class="next">
<a href="/2019/10/05/转-RAC-知识点汇总-总结得非常全/"  title="[转]RAC 知识点汇总 总结得非常全">
 <span>[转]RAC 知识点汇总 总结得非常全
</span>
</a>
</div>

</nav>

	
<section id="comments" class="comment">
	<div class="ds-thread" data-thread-key="2019/10/08/图解iOS系列之JSPatch-一-源码分析/" data-title="JSPatch 源码分析" data-url="http://yoursite.com/2019/10/08/%E5%9B%BE%E8%A7%A3iOS%E7%B3%BB%E5%88%97%E4%B9%8BJSPatch-%E4%B8%80-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"></div>
</section>


<section id="comments" class="comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
 
 <ol class="toc"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E4%BF%A1%E6%81%AF"><span class="toc-number">1.</span> <span class="toc-text">源码信息</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">源码解析</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">
<div id="authorInfo">
	
		<div class="author-img"></div>		
	
	<div class="social-info" class="clearfix">
		
		
		<a href="https://github.com/tbfungeek" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
		
		<a href="mailto:tbfungeek@163.com" target="_blank" class="icon-email" title="Email Me"></a>
		

	</div>
</div>

  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
		  
			<li><a href="/categories/Android-小经验/" title="Android 小经验">Android 小经验<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android-源码分析/" title="Android 源码分析">Android 源码分析<sup>21</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android其他/" title="Android其他">Android其他<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android初步/" title="Android初步">Android初步<sup>21</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android进阶/" title="Android进阶">Android进阶<sup>100</sup></a></li>
		  
		
		  
			<li><a href="/categories/Hexo-使用/" title="Hexo 使用">Hexo 使用<sup>10</sup></a></li>
		  
		
		  
			<li><a href="/categories/JavaScript理论/" title="JavaScript理论">JavaScript理论<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Objective-C-相关/" title="Objective C 相关">Objective C 相关<sup>24</sup></a></li>
		  
		
		  
			<li><a href="/categories/OpenCV/" title="OpenCV">OpenCV<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/ROS/" title="ROS">ROS<sup>9</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-工具使用/" title="iOS 工具使用">iOS 工具使用<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-开源库分析/" title="iOS 开源库分析">iOS 开源库分析<sup>36</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-理论基础/" title="iOS 理论基础">iOS 理论基础<sup>14</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-进阶/" title="iOS 进阶">iOS 进阶<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/个人收藏/" title="个人收藏">个人收藏<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/代码规范/" title="代码规范">代码规范<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/其他/" title="其他">其他<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/博客分类目录/" title="博客分类目录">博客分类目录<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/叨叨系列/" title="叨叨系列">叨叨系列<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/开源代码分析/" title="开源代码分析">开源代码分析<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/开源库分析/" title="开源库分析">开源库分析<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/树莓派/" title="树莓派">树莓派<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/版本控制/" title="版本控制">版本控制<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/直播/" title="直播">直播<sup>6</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/iOS-开源库分析/" title="iOS 开源库分析">iOS 开源库分析<sup>36</sup></a></li>
			
		
			
				<li><a href="/tags/Android-设计模式/" title="Android 设计模式">Android 设计模式<sup>29</sup></a></li>
			
		
			
				<li><a href="/tags/Objective-C-相关/" title="Objective C 相关">Objective C 相关<sup>24</sup></a></li>
			
		
			
				<li><a href="/tags/Android基础/" title="Android基础">Android基础<sup>21</sup></a></li>
			
		
			
				<li><a href="/tags/AOSP-源码/" title="AOSP 源码">AOSP 源码<sup>17</sup></a></li>
			
		
			
				<li><a href="/tags/Android-常用第三方库/" title="Android 常用第三方库">Android 常用第三方库<sup>15</sup></a></li>
			
		
			
				<li><a href="/tags/iOS-理论基础/" title="iOS 理论基础">iOS 理论基础<sup>14</sup></a></li>
			
		
			
				<li><a href="/tags/Hexo-使用/" title="Hexo 使用">Hexo 使用<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/ROS/" title="ROS">ROS<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/Android-动画进阶/" title="Android 动画进阶">Android 动画进阶<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/Android-JNI/" title="Android JNI">Android JNI<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android-绘图进阶/" title="Android 绘图进阶">Android 绘图进阶<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android性能优化/" title="Android性能优化">Android性能优化<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android-自动化测试/" title="Android 自动化测试">Android 自动化测试<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/OpenCV/" title="OpenCV">OpenCV<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/直播/" title="直播">直播<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android-开源源码/" title="Android 开源源码">Android 开源源码<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Android-自定义View进阶/" title="Android 自定义View进阶">Android 自定义View进阶<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/树莓派/" title="树莓派">树莓派<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/iOS-进阶/" title="iOS 进阶">iOS 进阶<sup>4</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="https://hexo.io" target="_blank" title="Hexo">Hexo</a>
            
          </li>
        
          <li>
            
            	<a href="https://pages.github.com/" target="_blank" title="GitHub">GitHub</a>
            
          </li>
        
          <li>
            
            	<a href="http://pf18.github.io/" target="_blank" title="PF18">PF18</a>
            
          </li>
        
          <li>
            
            	<a href="http://toutiao.io/" target="_blank" title="开发者头条">开发者头条</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.jcodecraeer.com/" target="_blank" title="泡在网上的日子">泡在网上的日子</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="atom.xml" target="_blank" title="rss">RSS</a>
</div>

  
  <div class="tagcloudlist">
    <p class="asidetitle">Tag Cloud</p>
    <div class="tagcloudlist clearfix">
       <a href="/tags/AOSP-%E6%BA%90%E7%A0%81/" style="font-size: 17.14px;">AOSP 源码</a> <a href="/tags/Android-APK-%E7%AD%BE%E5%90%8D/" style="font-size: 10px;">Android APK 签名</a> <a href="/tags/Android-JNI/" style="font-size: 12.86px;">Android JNI</a> <a href="/tags/Android-%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E8%BF%9B%E9%98%B6/" style="font-size: 10.71px;">Android 事件处理进阶</a> <a href="/tags/Android-%E5%8A%A8%E7%94%BB%E8%BF%9B%E9%98%B6/" style="font-size: 13.57px;">Android 动画进阶</a> <a href="/tags/Android-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%BC%80%E5%8F%91/" style="font-size: 10px;">Android 多线程开发</a> <a href="/tags/Android-%E5%B0%8F%E7%BB%8F%E9%AA%8C/" style="font-size: 10px;">Android 小经验</a> <a href="/tags/Android-%E5%B8%B8%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93/" style="font-size: 16.43px;">Android 常用第三方库</a> <a href="/tags/Android-%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B/" style="font-size: 10px;">Android 开发流程</a> <a href="/tags/Android-%E5%BC%80%E6%BA%90%E6%BA%90%E7%A0%81/" style="font-size: 12.14px;">Android 开源源码</a> <a href="/tags/Android-%E7%BB%98%E5%9B%BE%E8%BF%9B%E9%98%B6/" style="font-size: 12.86px;">Android 绘图进阶</a> <a href="/tags/Android-%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/" style="font-size: 12.86px;">Android 自动化测试</a> <a href="/tags/Android-%E8%87%AA%E5%AE%9A%E4%B9%89View%E8%BF%9B%E9%98%B6/" style="font-size: 12.14px;">Android 自定义View进阶</a> <a href="/tags/Android-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 19.29px;">Android 设计模式</a> <a href="/tags/Android%E5%85%B6%E4%BB%96/" style="font-size: 10px;">Android其他</a> <a href="/tags/Android%E5%9F%BA%E7%A1%80/" style="font-size: 17.86px;">Android基础</a> <a href="/tags/Android%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B/" style="font-size: 10px;">Android开发流程</a> <a href="/tags/Android%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" style="font-size: 12.86px;">Android性能优化</a> <a href="/tags/Android%E6%B7%B7%E6%B7%86%E6%8A%80%E6%9C%AF/" style="font-size: 10px;">Android混淆技术</a> <a href="/tags/Android%E8%B4%A8%E9%87%8F%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/" style="font-size: 11.43px;">Android质量管理工具</a> <a href="/tags/Android%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/" style="font-size: 10px;">Android逆向工程</a> <a href="/tags/Git-github/" style="font-size: 10px;">Git && github</a> <a href="/tags/Hexo-%E4%BD%BF%E7%94%A8/" style="font-size: 15px;">Hexo 使用</a> <a href="/tags/JavaScript/" style="font-size: 10px;">JavaScript</a> <a href="/tags/Linux-%E4%BD%BF%E7%94%A8/" style="font-size: 10px;">Linux 使用</a> <a href="/tags/Objective-C-%E7%9B%B8%E5%85%B3/" style="font-size: 18.57px;">Objective C 相关</a> <a href="/tags/OpenCV/" style="font-size: 12.86px;">OpenCV</a> <a href="/tags/ROS/" style="font-size: 14.29px;">ROS</a> <a href="/tags/iOS-%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/" style="font-size: 10.71px;">iOS 工具使用</a> <a href="/tags/iOS-%E5%BC%80%E6%BA%90%E5%BA%93%E5%88%86%E6%9E%90/" style="font-size: 20px;">iOS 开源库分析</a> <a href="/tags/iOS-%E7%90%86%E8%AE%BA%E5%9F%BA%E7%A1%80/" style="font-size: 15.71px;">iOS 理论基础</a> <a href="/tags/iOS-%E8%BF%9B%E9%98%B6/" style="font-size: 12.14px;">iOS 进阶</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83/" style="font-size: 10px;">代码规范</a> <a href="/tags/%E5%8D%9A%E5%AE%A2%E5%88%86%E7%B1%BB%E7%9B%AE%E5%BD%95/" style="font-size: 10.71px;">博客分类目录</a> <a href="/tags/%E5%8F%A8%E5%8F%A8%E7%B3%BB%E5%88%97/" style="font-size: 10px;">叨叨系列</a> <a href="/tags/%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8/" style="font-size: 11.43px;">工具的使用</a> <a href="/tags/%E5%BC%80%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/" style="font-size: 10.71px;">开源代码分析</a> <a href="/tags/%E5%BC%80%E6%BA%90%E5%BA%93%E5%88%86%E6%9E%90/" style="font-size: 10px;">开源库分析</a> <a href="/tags/%E6%9D%82%E7%B1%BB/" style="font-size: 10px;">杂类</a> <a href="/tags/%E6%A0%91%E8%8E%93%E6%B4%BE/" style="font-size: 12.14px;">树莓派</a> <a href="/tags/%E7%9B%B4%E6%92%AD/" style="font-size: 12.86px;">直播</a> <a href="/tags/%E7%BC%96%E7%A8%8B%E6%8A%80%E5%B7%A7/" style="font-size: 10.71px;">编程技巧</a> <a href="/tags/%E7%BD%91%E7%AB%99%E6%94%B6%E8%97%8F/" style="font-size: 10px;">网站收藏</a> <a href="/tags/%E9%87%8D%E8%A6%81%E6%8E%A7%E4%BB%B6/" style="font-size: 11.43px;">重要控件</a>
    </div>
  </div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
		
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/hsihohuang/kiddochan" target="_blank" title="Kiddochan">Kiddochan</a> © 2022 
		
		<a href="/about" target="_blank" title="Edgar">Edgar</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
        getSize();
        if (myWidth >= 1024) {
          c.click();
        }
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>




<script type="text/javascript">
  var duoshuoQuery = {short_name:"tbfungeek"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 


<script type="text/javascript">

var disqus_shortname = 'tbfungeek';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>






<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?7c9443b0374f1cf6b1dbb5ab84d939cb";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
