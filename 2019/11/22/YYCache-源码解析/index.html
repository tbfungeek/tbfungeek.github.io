
 <!DOCTYPE HTML>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  
    <title>YYCache 源码解析 | Edgar&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Edgar">
    

    
    <meta name="description" content="开源代码信息YYCache 开源库地址 我们在分析YTKNetWork,SDWebImage的时候涉及到缓存的实现，缓存一般都包含内存缓存和磁盘缓存，并且提供磁盘空间控制，缓存内容有效期控制等功能，我们接下来也从这几个方面对YYCache进行分析。YYCache代码量不多很精简，建议大家都可以尝试阅读下，因为一旦看惯代码了，就不会觉得畏惧了。下面先给出一个之前已经绘制好的一个YYCache构成图：">
<meta property="og:type" content="article">
<meta property="og:title" content="YYCache 源码解析">
<meta property="og:url" content="http://yoursite.com/2019/11/22/YYCache-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/index.html">
<meta property="og:site_name" content="Edgar&#39;s Blog">
<meta property="og:description" content="开源代码信息YYCache 开源库地址 我们在分析YTKNetWork,SDWebImage的时候涉及到缓存的实现，缓存一般都包含内存缓存和磁盘缓存，并且提供磁盘空间控制，缓存内容有效期控制等功能，我们接下来也从这几个方面对YYCache进行分析。YYCache代码量不多很精简，建议大家都可以尝试阅读下，因为一旦看惯代码了，就不会觉得畏惧了。下面先给出一个之前已经绘制好的一个YYCache构成图：">
<meta property="og:locale">
<meta property="og:image" content="http://yoursite.com/2019/11/22/YYCache-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/0001.png">
<meta property="article:published_time" content="2019-11-21T18:05:02.000Z">
<meta property="article:modified_time" content="2019-12-19T13:30:22.000Z">
<meta property="article:author" content="Edgar">
<meta property="article:tag" content="iOS 开源库分析">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/2019/11/22/YYCache-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/0001.png">

    
    <link rel="alternative" href="atom.xml" title="Edgar&#39;s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/unnamed4_n_mSY_icon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/profile.png">
    <link rel="apple-touch-icon-precomposed" href="/img/profile.png">
    
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.2.0"></head>

  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Edgar&#39;s Blog">Edgar&#39;s Blog</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
					<li>
 					
					<form class="search" action="/search/index.html" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" autocomplete="off" name="q" maxlength="20" placeholder="Search" />
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/11/22/YYCache-源码解析/" title="YYCache 源码解析" itemprop="url">YYCache 源码解析</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Edgar" target="_blank" itemprop="author">Edgar</a>
		
  <p class="article-time">
    <time datetime="2019-11-21T18:05:02.000Z" itemprop="datePublished"> Published 2019-11-22</time>
    
  </p>
</header>
	<div class="article-content">
		
		<h5 id="开源代码信息"><a href="#开源代码信息" class="headerlink" title="开源代码信息"></a>开源代码信息</h5><p><a target="_blank" rel="noopener" href="https://github.com/ibireme/YYCache/tree/master/YYCache">YYCache 开源库地址</a></p>
<p>我们在分析YTKNetWork,SDWebImage的时候涉及到缓存的实现，缓存一般都包含内存缓存和磁盘缓存，并且提供磁盘空间控制，缓存内容有效期控制等功能，我们接下来也从这几个方面对YYCache进行分析。YYCache代码量不多很精简，建议大家都可以尝试阅读下，因为一旦看惯代码了，就不会觉得畏惧了。下面先给出一个之前已经绘制好的一个YYCache构成图：</p>
<p><img src="/2019/11/22/YYCache-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/0001.png"></p>
<p>整个开源库也只有8个文件四个类：</p>
<ul>
<li><p><strong><strong>YYCache</strong></strong>: YYCache 的顶层类，业务主要和它进行交互获取实现对应的缓存任务。</p>
</li>
<li><p><strong><strong>YYMemoryCache</strong></strong>： 内存缓存，它是基于双向链表结构，它和NSCache的区别在于，YYMemoryCache 剔除过期对象是基于LRU方法，而NSCache剔除对象的方法是不确定的。<br>          YYMemoryCache可以根据缓存的cost，count，age来控制缓存，而NSCache不能。在收到内存缓存不足警告，或者应用进入后台的时候可以指定剔除某些缓存。</p>
</li>
<li><p><strong><strong>YYDiskCache</strong></strong>: 它是基于文件以及sqlite数据的磁盘缓存，它会根据不同的情况自动选择使用文件还是数据库来存储缓存，和YYMemoryCache类似它也是给予LRU原则来移除无用的缓存的，也可以根据缓存的cost，count，age来控制缓存。并且能够在磁盘空间不足的时候自动剔除无用的数据。</p>
</li>
<li><p><strong><strong>YYKVStorage</strong></strong> 是YYDiskCache执行存储的重要对象。后面介绍源码的时候我们会详细看下这部分实现。</p>
</li>
</ul>
<p>我们先来看下YYCache，YYCache我们这里只会做简单介绍，因为它大部分的功能都依托于YYMemoryCache和YYDiskCache。它使用YYMemoryCache用于存储小而快的内存缓存，使用YYDiskCache来存储大的对象。它提供了对缓存进行增删改查的操作，并且每种操作都提供了同步和异步两种方式。</p>
<p>这里仅仅列出同步的增删改查代码其实上层的逻辑和其他的缓存没有太多的差别，重点是底层的实现：</p>
<figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line">- (void)setObject:(id&lt;NSCoding&gt;)<span class="built_in">object</span> forKey:(NSString *)key &#123;</span><br><span class="line">    [<span class="variable">_memoryCache</span> setObject:<span class="built_in">object</span> forKey:key];</span><br><span class="line">    [<span class="variable">_diskCache</span> setObject:<span class="built_in">object</span> forKey:key];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)removeObjectForKey:(NSString *)key &#123;</span><br><span class="line">    [<span class="variable">_memoryCache</span> removeObjectForKey:key];</span><br><span class="line">    [<span class="variable">_diskCache</span> removeObjectForKey:key];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (id&lt;NSCoding&gt;)objectForKey:(NSString *)key &#123;</span><br><span class="line">    id&lt;NSCoding&gt; <span class="built_in">object</span> = [<span class="variable">_memoryCache</span> objectForKey:key];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">object</span>) &#123;</span><br><span class="line">        <span class="built_in">object</span> = [<span class="variable">_diskCache</span> objectForKey:key];</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">object</span>) &#123;</span><br><span class="line">            [<span class="variable">_memoryCache</span> setObject:<span class="built_in">object</span> forKey:key];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return <span class="built_in">object</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (BOOL)containsObjectForKey:(NSString *)key &#123;</span><br><span class="line">    return [<span class="variable">_memoryCache</span> containsObjectForKey:key] || [<span class="variable">_diskCache</span> containsObjectForKey:key];</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p><strong><strong>YYMemoryCache</strong></strong></p>
<p>YYMemoryCache 内部是基于 _YYLinkedMap 双向链表实现的。我们看下YYMemoryCache初始化：</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">self</span> = <span class="variable language_">super</span>.init;</span><br><span class="line">    pthread_mutex_init(&amp;_lock, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">//创建_YYLinkedMap</span></span><br><span class="line">    _lru = [_YYLinkedMap new];</span><br><span class="line">    <span class="comment">//创建串行队列</span></span><br><span class="line">    _queue = dispatch_queue_create(<span class="string">&quot;com.ibireme.cache.memory&quot;</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">    <span class="comment">//最大缓存对象数量限制</span></span><br><span class="line">    _countLimit = <span class="built_in">NSUIntegerMax</span>;</span><br><span class="line">    <span class="comment">//最大空间消耗限制</span></span><br><span class="line">    _costLimit = <span class="built_in">NSUIntegerMax</span>;</span><br><span class="line">    <span class="comment">//最大过期时间限制</span></span><br><span class="line">    _ageLimit = DBL_MAX;</span><br><span class="line">    <span class="comment">//自动缓存清理触发时间</span></span><br><span class="line">    _autoTrimInterval = <span class="number">5.0</span>;</span><br><span class="line">    <span class="comment">//在收到内存警告的时候是否移除全部缓存对象</span></span><br><span class="line">    _shouldRemoveAllObjectsOnMemoryWarning = <span class="literal">YES</span>;</span><br><span class="line">    <span class="comment">//在进入后台的时候是否移除全部缓存对象</span></span><br><span class="line">    _shouldRemoveAllObjectsWhenEnteringBackground = <span class="literal">YES</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//注册内存警告通知</span></span><br><span class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(_appDidReceiveMemoryWarningNotification) name:<span class="built_in">UIApplicationDidReceiveMemoryWarningNotification</span> object:<span class="literal">nil</span>];</span><br><span class="line">    <span class="comment">//注册进入后台的通知</span></span><br><span class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(_appDidEnterBackgroundNotification) name:<span class="built_in">UIApplicationDidEnterBackgroundNotification</span> object:<span class="literal">nil</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//间隔_autoTrimInterval时间定期清除过期，超过限制的缓存</span></span><br><span class="line">    [<span class="keyword">self</span> _trimRecursively];</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>_YYLinkedMap是一个双向链表，这部分代码不展开介绍，但是给出了代码的相关注释：</p>
<figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line">- (void)insertNodeAtHead:(<span class="variable">_YYLinkedMapNode</span> *)node &#123;</span><br><span class="line">    CFDictionarySetValue(<span class="variable">_dic</span>, (<span class="variable">__bridge</span> const void *)(node-&gt;<span class="variable">_key</span>), (<span class="variable">__bridge</span> const void *)(node));</span><br><span class="line">    <span class="comment">//计算_totalCost</span></span><br><span class="line">    <span class="variable">_totalCost</span> += node-&gt;<span class="variable">_cost</span>;</span><br><span class="line">    <span class="comment">//计算_totalCount</span></span><br><span class="line">    <span class="variable">_totalCount</span>++;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">_head</span>) &#123;</span><br><span class="line">        <span class="comment">//将node插入到head之前</span></span><br><span class="line">        node-&gt;<span class="variable">_next</span> = <span class="variable">_head</span>;</span><br><span class="line">        <span class="variable">_head</span>-&gt;<span class="variable">_prev</span> = node;</span><br><span class="line">        <span class="variable">_head</span> = node;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//空的双向链表</span></span><br><span class="line">        <span class="variable">_head</span> = <span class="variable">_tail</span> = node;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)bringNodeToHead:(<span class="variable">_YYLinkedMapNode</span> *)node &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">_head</span> == node) return;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将node从原来的双向链表中分离开来</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">_tail</span> == node) &#123;</span><br><span class="line">        <span class="variable">_tail</span> = node-&gt;<span class="variable">_prev</span>;</span><br><span class="line">        <span class="variable">_tail</span>-&gt;<span class="variable">_next</span> = <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        node-&gt;<span class="variable">_next</span>-&gt;<span class="variable">_prev</span> = node-&gt;<span class="variable">_prev</span>;</span><br><span class="line">        node-&gt;<span class="variable">_prev</span>-&gt;<span class="variable">_next</span> = node-&gt;<span class="variable">_next</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//将node插入到head</span></span><br><span class="line">    node-&gt;<span class="variable">_next</span> = <span class="variable">_head</span>;</span><br><span class="line">    node-&gt;<span class="variable">_prev</span> = <span class="literal">nil</span>;</span><br><span class="line">    <span class="variable">_head</span>-&gt;<span class="variable">_prev</span> = node;</span><br><span class="line">    <span class="variable">_head</span> = node;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)removeNode:(<span class="variable">_YYLinkedMapNode</span> *)node &#123;</span><br><span class="line">    CFDictionaryRemoveValue(<span class="variable">_dic</span>, (<span class="variable">__bridge</span> const void *)(node-&gt;<span class="variable">_key</span>));</span><br><span class="line">    <span class="comment">//计算_totalCost</span></span><br><span class="line">    <span class="variable">_totalCost</span> -= node-&gt;<span class="variable">_cost</span>;</span><br><span class="line">    <span class="comment">//计算_totalCount</span></span><br><span class="line">    <span class="variable">_totalCount</span>--;</span><br><span class="line">    <span class="comment">//移除节点</span></span><br><span class="line">    <span class="keyword">if</span> (node-&gt;<span class="variable">_next</span>) node-&gt;<span class="variable">_next</span>-&gt;<span class="variable">_prev</span> = node-&gt;<span class="variable">_prev</span>;</span><br><span class="line">    <span class="keyword">if</span> (node-&gt;<span class="variable">_prev</span>) node-&gt;<span class="variable">_prev</span>-&gt;<span class="variable">_next</span> = node-&gt;<span class="variable">_next</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">_head</span> == node) <span class="variable">_head</span> = node-&gt;<span class="variable">_next</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">_tail</span> == node) <span class="variable">_tail</span> = node-&gt;<span class="variable">_prev</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="variable">_YYLinkedMapNode</span> *)removeTailNode &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">_tail</span>) return <span class="literal">nil</span>;</span><br><span class="line">    <span class="variable">_YYLinkedMapNode</span> *tail = <span class="variable">_tail</span>;</span><br><span class="line">    CFDictionaryRemoveValue(<span class="variable">_dic</span>, (<span class="variable">__bridge</span> const void *)(<span class="variable">_tail</span>-&gt;<span class="variable">_key</span>));</span><br><span class="line">    <span class="variable">_totalCost</span> -= <span class="variable">_tail</span>-&gt;<span class="variable">_cost</span>;</span><br><span class="line">    <span class="variable">_totalCount</span>--;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">_head</span> == <span class="variable">_tail</span>) &#123;</span><br><span class="line">        <span class="variable">_head</span> = <span class="variable">_tail</span> = <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">_tail</span> = <span class="variable">_tail</span>-&gt;<span class="variable">_prev</span>;</span><br><span class="line">        <span class="variable">_tail</span>-&gt;<span class="variable">_next</span> = <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    return tail;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)removeAll &#123;</span><br><span class="line">    <span class="variable">_totalCost</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="variable">_totalCount</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="variable">_head</span> = <span class="literal">nil</span>;</span><br><span class="line">    <span class="variable">_tail</span> = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">if</span> (CFDictionaryGetCount(<span class="variable">_dic</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        CFMutableDictionaryRef holder = <span class="variable">_dic</span>;</span><br><span class="line">        <span class="variable">_dic</span> = CFDictionaryCreateMutable(CFAllocatorGetDefault(), <span class="number">0</span>, &amp;kCFTypeDictionaryKeyCallBacks, &amp;kCFTypeDictionaryValueCallBacks);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">_releaseAsynchronously</span>) &#123;</span><br><span class="line">            dispatch_queue_t queue = <span class="variable">_releaseOnMainThread</span> ? dispatch_get_main_queue() : YYMemoryCacheGetReleaseQueue();</span><br><span class="line">            dispatch_async(queue, ^&#123;</span><br><span class="line">                CFRelease(holder); <span class="comment">// hold and release in specified queue</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">_releaseOnMainThread</span> &amp;&amp; !pthread_main_np()) &#123;</span><br><span class="line">            dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                CFRelease(holder); <span class="comment">// hold and release in specified queue</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            CFRelease(holder);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong><strong>增&#x2F;改缓存</strong></strong></p>
<figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line">- (void)setObject:(id)<span class="built_in">object</span> forKey:(id)key withCost:(NSUInteger)cost &#123;</span><br><span class="line">    <span class="comment">// 如果设置的object对象是空的那么就会移除这个对象</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">object</span>) &#123;</span><br><span class="line">        [self removeObjectForKey:key];</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    pthread_mutex_lock(&amp;<span class="variable">_lock</span>);</span><br><span class="line">    <span class="comment">//创建一个节点</span></span><br><span class="line">    <span class="variable">_YYLinkedMapNode</span> *node = CFDictionaryGetValue(<span class="variable">_lru</span>-&gt;<span class="variable">_dic</span>, (<span class="variable">__bridge</span> const void *)(key));</span><br><span class="line">    NSTimeInterval now = CACurrentMediaTime();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (node) &#123;</span><br><span class="line">        <span class="comment">//要设置的节点在缓存链表中，用新的值来更新节点内容</span></span><br><span class="line">        <span class="variable">_lru</span>-&gt;<span class="variable">_totalCost</span> -= node-&gt;<span class="variable">_cost</span>;</span><br><span class="line">        <span class="variable">_lru</span>-&gt;<span class="variable">_totalCost</span> += cost;</span><br><span class="line">        node-&gt;<span class="variable">_cost</span> = cost;</span><br><span class="line">        node-&gt;<span class="variable">_time</span> = now;</span><br><span class="line">        node-&gt;<span class="variable">_value</span> = <span class="built_in">object</span>;</span><br><span class="line">        <span class="comment">//节点移动到缓存链表的头部，</span></span><br><span class="line">        [<span class="variable">_lru</span> bringNodeToHead:node];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//要设置的节点不在缓存链表中，新建一个node将值传入并插入到双向链表的头部</span></span><br><span class="line">        node = [<span class="variable">_YYLinkedMapNode</span> new];</span><br><span class="line">        node-&gt;<span class="variable">_cost</span> = cost;</span><br><span class="line">        node-&gt;<span class="variable">_time</span> = now;</span><br><span class="line">        node-&gt;<span class="variable">_key</span> = key;</span><br><span class="line">        node-&gt;<span class="variable">_value</span> = <span class="built_in">object</span>;</span><br><span class="line">        [<span class="variable">_lru</span> insertNodeAtHead:node];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//如果缓存双向链表总的空间超过了限制大小调用trimToCost清除缓存</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">_lru</span>-&gt;<span class="variable">_totalCost</span> &gt; <span class="variable">_costLimit</span>) &#123;</span><br><span class="line">        dispatch_async(<span class="variable">_queue</span>, ^&#123;</span><br><span class="line">            [self trimToCost:<span class="variable">_costLimit</span>];</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//如果缓存数量超过了限制，移除最后的节点</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">_lru</span>-&gt;<span class="variable">_totalCount</span> &gt; <span class="variable">_countLimit</span>) &#123;</span><br><span class="line">        <span class="variable">_YYLinkedMapNode</span> *node = [<span class="variable">_lru</span> removeTailNode];</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">_lru</span>-&gt;<span class="variable">_releaseAsynchronously</span>) &#123;</span><br><span class="line">            dispatch_queue_t queue = <span class="variable">_lru</span>-&gt;<span class="variable">_releaseOnMainThread</span> ? dispatch_get_main_queue() : YYMemoryCacheGetReleaseQueue();</span><br><span class="line">            dispatch_async(queue, ^&#123;</span><br><span class="line">                [node class]; <span class="comment">//hold and release in queue</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">_lru</span>-&gt;<span class="variable">_releaseOnMainThread</span> &amp;&amp; !pthread_main_np()) &#123;</span><br><span class="line">            dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                [node class]; <span class="comment">//hold and release in queue</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    pthread_mutex_unlock(&amp;<span class="variable">_lock</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>setObject方法会首先检查传入的当前对象是否是nil，如果是nil会从缓存链表中删除传入key的元素。如果不是nil，则会在缓存链表中查看是否已经存在，如果是的话，就使用传入的object更新节点内容，然后将其移到链表的最前面。如果不存在就新建一个node插入到缓存链表头部，然后会对链表的空间以及链表节点数量进行检查，剔除掉不用的对象。</p>
<p><strong><strong>删除缓存</strong></strong></p>
<p>这个不做过多介绍大家直接看代码：</p>
<figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line">- (void)removeObjectForKey:(id)key &#123;</span><br><span class="line">    <span class="keyword">if</span> (!key) return;</span><br><span class="line">    pthread_mutex_lock(&amp;<span class="variable">_lock</span>);</span><br><span class="line">    <span class="variable">_YYLinkedMapNode</span> *node = CFDictionaryGetValue(<span class="variable">_lru</span>-&gt;<span class="variable">_dic</span>, (<span class="variable">__bridge</span> const void *)(key));</span><br><span class="line">    <span class="keyword">if</span> (node) &#123;</span><br><span class="line">        [<span class="variable">_lru</span> removeNode:node];</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">_lru</span>-&gt;<span class="variable">_releaseAsynchronously</span>) &#123;</span><br><span class="line">            dispatch_queue_t queue = <span class="variable">_lru</span>-&gt;<span class="variable">_releaseOnMainThread</span> ? dispatch_get_main_queue() : YYMemoryCacheGetReleaseQueue();</span><br><span class="line">            dispatch_async(queue, ^&#123;</span><br><span class="line">                [node class]; <span class="comment">//hold and release in queue</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">_lru</span>-&gt;<span class="variable">_releaseOnMainThread</span> &amp;&amp; !pthread_main_np()) &#123;</span><br><span class="line">            dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                [node class]; <span class="comment">//hold and release in queue</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    pthread_mutex_unlock(&amp;<span class="variable">_lock</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><strong>查找缓存</strong></strong></p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">- (id)objectForKey:(id)key &#123;</span><br><span class="line">    <span class="keyword">if</span> (!key) return nil;</span><br><span class="line">    pthread<span class="constructor">_mutex_lock(&amp;<span class="params">_lock</span>)</span>;</span><br><span class="line">    _YYLinkedMapNode *node = <span class="constructor">CFDictionaryGetValue(<span class="params">_lru</span>-&gt;<span class="params">_dic</span>, (<span class="params">__bridge</span> <span class="params">const</span> <span class="params">void</span> <span class="operator">*</span>)</span>(key));</span><br><span class="line">    <span class="comment">//每次查找之前都会将找到的对象移到缓存链表的最前面</span></span><br><span class="line">    <span class="keyword">if</span> (node) &#123;</span><br><span class="line">        node-&gt;_time = <span class="constructor">CACurrentMediaTime()</span>;</span><br><span class="line">        <span class="literal">[<span class="identifier">_lru</span> <span class="identifier">bringNodeToHead</span>:<span class="identifier">node</span>]</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    pthread<span class="constructor">_mutex_unlock(&amp;<span class="params">_lock</span>)</span>;</span><br><span class="line">    return node ? node-&gt;_value : nil;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (BOOL)containsObjectForKey:(id)key &#123;</span><br><span class="line">    <span class="keyword">if</span> (!key) return NO;</span><br><span class="line">    pthread<span class="constructor">_mutex_lock(&amp;<span class="params">_lock</span>)</span>;</span><br><span class="line">    BOOL contains = <span class="constructor">CFDictionaryContainsKey(<span class="params">_lru</span>-&gt;<span class="params">_dic</span>, (<span class="params">__bridge</span> <span class="params">const</span> <span class="params">void</span> <span class="operator">*</span>)</span>(key));</span><br><span class="line">    pthread<span class="constructor">_mutex_unlock(&amp;<span class="params">_lock</span>)</span>;</span><br><span class="line">    return contains;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这部分最关键的是它会在每次查找缓存，找到的时候将找到的对象移动到缓存链表最前面。</p>
<p><strong><strong>缓存清理</strong></strong></p>
<p>我们上面提到了在初始化的时候会触发定期清理缓存操作，默认每隔5秒进行一次。并且在每次添加缓存的时候还会触发一次。</p>
<figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line">- (void)<span class="variable">_trimToCost</span>:(NSUInteger)costLimit &#123;</span><br><span class="line">    BOOL finish = NO;</span><br><span class="line">    pthread_mutex_lock(&amp;<span class="variable">_lock</span>);</span><br><span class="line">    <span class="keyword">if</span> (costLimit == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//如果costLimit被设置为0那么就将所有的缓存都删除</span></span><br><span class="line">        [<span class="variable">_lru</span> removeAll];</span><br><span class="line">        finish = YES;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">_lru</span>-&gt;<span class="variable">_totalCost</span> &lt;= costLimit) &#123;</span><br><span class="line">        finish = YES;</span><br><span class="line">    &#125;</span><br><span class="line">    pthread_mutex_unlock(&amp;<span class="variable">_lock</span>);</span><br><span class="line">    <span class="keyword">if</span> (finish) return;</span><br><span class="line">    </span><br><span class="line">    NSMutableArray *holder = [NSMutableArray new];</span><br><span class="line">    <span class="keyword">while</span> (!finish) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pthread_mutex_trylock(&amp;<span class="variable">_lock</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//如果缓存的存储空间还是超过了限制，就从缓存尾部移除一个暂时添加到holder，避免频繁对内存读写，导致锁被占用，</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">_lru</span>-&gt;<span class="variable">_totalCost</span> &gt; costLimit) &#123;</span><br><span class="line">                <span class="variable">_YYLinkedMapNode</span> *node = [<span class="variable">_lru</span> removeTailNode];</span><br><span class="line">                <span class="keyword">if</span> (node) [holder addObject:node];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                finish = YES;</span><br><span class="line">            &#125;</span><br><span class="line">            pthread_mutex_unlock(&amp;<span class="variable">_lock</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            usleep(<span class="number">10</span> * <span class="number">1000</span>); <span class="comment">//10 ms</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//最后将待清除的对象所占用的空间清除。</span></span><br><span class="line">    <span class="keyword">if</span> (holder.<span class="built_in">count</span>) &#123;</span><br><span class="line">        dispatch_queue_t queue = <span class="variable">_lru</span>-&gt;<span class="variable">_releaseOnMainThread</span> ? dispatch_get_main_queue() : YYMemoryCacheGetReleaseQueue();</span><br><span class="line">        dispatch_async(queue, ^&#123;</span><br><span class="line">            [holder <span class="built_in">count</span>]; <span class="comment">// release in queue</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>_trimToCost 中如果有超过限制就会不断从缓存链表队尾移除一个对象，然后先将待移除的对象暂时添加到holder，避免频繁对内存读写，导致锁被占用，直到没有超过限制的时候在对应的队列中将这些对象的空间释放。****_trimToCount<strong><strong>，</strong></strong>_trimToAge**** 和 <strong><strong>_trimToCost</strong></strong> 代码类似，只不过判断的标准不一样而已，这里就不展开介绍了，有兴趣的同学可以查看对应的代码。</p>
<p><strong><strong>YYDiskCache</strong></strong></p>
<p>磁盘缓存和内存缓存对外的接口大体类似，只有一点不大一致的：</p>
<ul>
<li><strong><strong>inlineThreshold</strong></strong></li>
</ul>
<p>它多出了inlineThreshold属性，它是一个阈值，最开始的时候磁盘缓存是存储在sqlite上的，一旦存储在sqlite的磁盘缓存超过这个值的时候后续的对象就会被存储到文件，如果设置为0的话表示所有的缓存都会被存储到文件，NSUIntegerMax表示所有的对象都会被存储到sqlite，默认这个阈值是20KB</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) <span class="built_in">NSUInteger</span> inlineThreshold;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong><strong>自定义归档&#x2F;反归档处理</strong></strong></li>
</ul>
<p>多出了归档对象的方式，默认情况下YYCache是通过NSKeyedArchiver和NSKeyedUnarchiver进行归档和反归档，但是这要求对象必须遵循<strong><strong>NSCoding</strong></strong>协议，如果某些对象没法做到这一点，那么可以通过指定customArchiveBlock以及customUnarchiveBlock来自定义归档和反归档将要存储的对象：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@property (<span class="params">nullable, copy</span>) NSData *(<span class="params">^customArchiveBlock</span>)(<span class="params"><span class="built_in">id</span> <span class="built_in">object</span></span>);</span></span><br><span class="line"><span class="meta">@property (<span class="params">nullable, copy</span>) id (<span class="params">^customUnarchiveBlock</span>)(<span class="params">NSData *data</span>);</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong><strong>自定义缓存文件名规范</strong></strong></li>
</ul>
<p>默认缓存文件名是通过md5(key)计算出来的，但是我们可以通过customFileNameBlock来自定义key与对它对应的缓存文件名字的命名规范。</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">nullable</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *(^customFileNameBlock)(<span class="built_in">NSString</span> *key);</span><br></pre></td></tr></table></figure>

<ul>
<li><strong><strong>可以扩张缓存对象的数据</strong></strong></li>
</ul>
<p>在对缓存对象进行缓存之前，还可以通过下面的方法对缓存数据进行扩展，它实际上是通过关联对象的方式来实现的。</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">+ (<span class="keyword">nullable</span> <span class="built_in">NSData</span> *)getExtendedDataFromObject:(<span class="type">id</span>)object;</span><br><span class="line">+ (<span class="type">void</span>)setExtendedData:(<span class="keyword">nullable</span> <span class="built_in">NSData</span> *)extendedData toObject:(<span class="type">id</span>)object;</span><br></pre></td></tr></table></figure>

<p>我们接下来开始分析YYDiskCache</p>
<p><strong><strong>YYDiskCache的初始化</strong></strong></p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">instancetype</span>)initWithPath:(<span class="built_in">NSString</span> *)path &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> initWithPath:path inlineThreshold:<span class="number">1024</span> * <span class="number">20</span>]; <span class="comment">// 20KB</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithPath:(<span class="built_in">NSString</span> *)path</span><br><span class="line">             inlineThreshold:(<span class="built_in">NSUInteger</span>)threshold &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="variable language_">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//我们在项目中可能会有多个YYDiskCache，我们会将这些YYDiskCache的实例以path为key，缓存到类型为NSMapTable的_globalInstances中。</span></span><br><span class="line">    YYDiskCache *globalCache = _YYDiskCacheGetGlobal(path);</span><br><span class="line">    <span class="comment">//如果缓存中有就先用缓存中的，避免重复创建</span></span><br><span class="line">    <span class="keyword">if</span> (globalCache) <span class="keyword">return</span> globalCache;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//根据threshold来设定缓存的存储方式：</span></span><br><span class="line">    YYKVStorageType type;</span><br><span class="line">    <span class="keyword">if</span> (threshold == <span class="number">0</span>) &#123;</span><br><span class="line">        type = YYKVStorageTypeFile;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (threshold == <span class="built_in">NSUIntegerMax</span>) &#123;</span><br><span class="line">        type = YYKVStorageTypeSQLite;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        type = YYKVStorageTypeMixed;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//新建一个YYKVStorage，所有的磁盘存储都由YYKVStorage来完成</span></span><br><span class="line">    YYKVStorage *kv = [[YYKVStorage alloc] initWithPath:path type:type];</span><br><span class="line">    <span class="keyword">if</span> (!kv) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    _kv = kv;</span><br><span class="line">    _path = path;</span><br><span class="line">    _lock = dispatch_semaphore_create(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">//磁盘操作队列</span></span><br><span class="line">    _queue = dispatch_queue_create(<span class="string">&quot;com.ibireme.cache.disk&quot;</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">    <span class="comment">//一系列的限制</span></span><br><span class="line">    _inlineThreshold = threshold;</span><br><span class="line">    _countLimit = <span class="built_in">NSUIntegerMax</span>;</span><br><span class="line">    _costLimit = <span class="built_in">NSUIntegerMax</span>;</span><br><span class="line">    _ageLimit = DBL_MAX;</span><br><span class="line">    _freeDiskSpaceLimit = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//缓存整理主动触发时间默认为1分钟</span></span><br><span class="line">    _autoTrimInterval = <span class="number">60</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//触发缓存整理</span></span><br><span class="line">    [<span class="keyword">self</span> _trimRecursively];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//将当前YYDiskCache缓存起来</span></span><br><span class="line">    _YYDiskCacheSetGlobal(<span class="keyword">self</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//在退出应用的时候会将kv设置为nil</span></span><br><span class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(_appWillBeTerminated) name:<span class="built_in">UIApplicationWillTerminateNotification</span> object:<span class="literal">nil</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们在项目中可能会有多个YYDiskCache，我们会将这些YYDiskCache的实例以path为key，缓存到类型为NSMapTable的_globalInstances中。所以我们在最初的时候会先从globalInstances中先看下是否有已经创建好的，如果没有再新建YYDiskCache并缓存起来。YYDiskCache中最关键的就是YYKVStorage了，所有的磁盘存储都由YYKVStorage来完成。</p>
<p>YYDiskCache上层比较简单，主要的逻辑在YYKVStorage，但是在介绍YYKVStorage之前我们先简单浏览下YYDiskCache：</p>
<p><strong><strong>增&#x2F;改缓存</strong></strong></p>
<figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line">- (void)setObject:(id&lt;NSCoding&gt;)<span class="built_in">object</span> forKey:(NSString *)key &#123;</span><br><span class="line">    <span class="comment">//如果object为空表示从磁盘缓存中删除改对象，这个和YYMemoryCache是一致的</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">object</span>) &#123;</span><br><span class="line">        [self removeObjectForKey:key];</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//获取某个对象额外需要追加到对象上的数据</span></span><br><span class="line">    NSData *extendedData = [YYDiskCache getExtendedDataFromObject:<span class="built_in">object</span>];</span><br><span class="line">    NSData *value = <span class="literal">nil</span>;</span><br><span class="line">    <span class="comment">//如果指定了自定义的归档方式，那么使用自定义的归档方式来对要缓存的对象归档为NSData存储到磁盘缓存中</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">_customArchiveBlock</span>) &#123;</span><br><span class="line">        value = <span class="variable">_customArchiveBlock</span>(<span class="built_in">object</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//否则使用NSKeyedArchiver进行归档</span></span><br><span class="line">        @<span class="keyword">try</span> &#123;</span><br><span class="line">            value = [NSKeyedArchiver archivedDataWithRootObject:<span class="built_in">object</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        @<span class="keyword">catch</span> (NSException *exception) &#123;</span><br><span class="line">            <span class="comment">// nothing to do...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!value) return;</span><br><span class="line">    NSString *filename = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">_kv</span>.<span class="built_in">type</span> != YYKVStorageTypeSQLite) &#123;</span><br><span class="line">        <span class="keyword">if</span> (value.length &gt; <span class="variable">_inlineThreshold</span>) &#123;</span><br><span class="line">            filename = [self <span class="variable">_filenameForKey</span>:key];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//磁盘缓存</span></span><br><span class="line">    <span class="built_in">Lock</span>();</span><br><span class="line">    [<span class="variable">_kv</span> saveItemWithKey:key value:value filename:filename extendedData:extendedData];</span><br><span class="line">    Unlock();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上面代码注释得比较详细了，大家看代码就能看懂，就不展开了。</p>
<p><strong><strong>删除缓存</strong></strong></p>
<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line">- (void)removeObjectForKey:(NSString *)key &#123;</span><br><span class="line">    if (!key) return;</span><br><span class="line">    <span class="built_in">Lock</span>();</span><br><span class="line">    <span class="selector-attr">[_kv removeItemForKey:key]</span>;</span><br><span class="line">    <span class="built_in">Unlock</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><strong>查找缓存</strong></strong></p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">BOOL</span>)containsObjectForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span> (!key) <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    Lock();</span><br><span class="line">    <span class="type">BOOL</span> contains = [_kv itemExistsForKey:key];</span><br><span class="line">    Unlock();</span><br><span class="line">    <span class="keyword">return</span> contains;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)containsObjectForKey:(<span class="built_in">NSString</span> *)key withBlock:(<span class="type">void</span>(^)(<span class="built_in">NSString</span> *key, <span class="type">BOOL</span> contains))block &#123;</span><br><span class="line">    <span class="keyword">if</span> (!block) <span class="keyword">return</span>;</span><br><span class="line">    __<span class="keyword">weak</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>) _<span class="keyword">self</span> = <span class="keyword">self</span>;</span><br><span class="line">    <span class="built_in">dispatch_async</span>(_queue, ^&#123;</span><br><span class="line">        __<span class="keyword">strong</span> <span class="keyword">typeof</span>(_<span class="keyword">self</span>) <span class="keyword">self</span> = _<span class="keyword">self</span>;</span><br><span class="line">        <span class="type">BOOL</span> contains = [<span class="keyword">self</span> containsObjectForKey:key];</span><br><span class="line">        block(key, contains);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">id</span>&lt;<span class="built_in">NSCoding</span>&gt;)objectForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span> (!key) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    Lock();</span><br><span class="line">    YYKVStorageItem *item = [_kv getItemForKey:key];</span><br><span class="line">    Unlock();</span><br><span class="line">    <span class="keyword">if</span> (!item.value) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="type">id</span> object = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">if</span> (_customUnarchiveBlock) &#123;</span><br><span class="line">        object = _customUnarchiveBlock(item.value);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">@try</span> &#123;</span><br><span class="line">            object = [<span class="built_in">NSKeyedUnarchiver</span> unarchiveObjectWithData:item.value];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">@catch</span> (<span class="built_in">NSException</span> *exception) &#123;</span><br><span class="line">            <span class="comment">// nothing to do...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (object &amp;&amp; item.extendedData) &#123;</span><br><span class="line">        [YYDiskCache setExtendedData:item.extendedData toObject:object];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>还是不大想解释，代码不难。</p>
<p><strong><strong>缓存清理</strong></strong></p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">- (<span class="type">void</span>)_trimToCost:(<span class="built_in">NSUInteger</span>)costLimit &#123;</span><br><span class="line">    <span class="keyword">if</span> (costLimit &gt;= INT_MAX) <span class="keyword">return</span>;</span><br><span class="line">    [_kv removeItemsToFitSize:(<span class="type">int</span>)costLimit];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)_trimToCount:(<span class="built_in">NSUInteger</span>)countLimit &#123;</span><br><span class="line">    <span class="keyword">if</span> (countLimit &gt;= INT_MAX) <span class="keyword">return</span>;</span><br><span class="line">    [_kv removeItemsToFitCount:(<span class="type">int</span>)countLimit];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)_trimToAge:(<span class="built_in">NSTimeInterval</span>)ageLimit &#123;</span><br><span class="line">    <span class="keyword">if</span> (ageLimit &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        [_kv removeAllItems];</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">long</span> timestamp = time(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (timestamp &lt;= ageLimit) <span class="keyword">return</span>;</span><br><span class="line">    <span class="type">long</span> age = timestamp - ageLimit;</span><br><span class="line">    <span class="keyword">if</span> (age &gt;= INT_MAX) <span class="keyword">return</span>;</span><br><span class="line">    [_kv removeItemsEarlierThanTime:(<span class="type">int</span>)age];</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong><strong>YYKVStorage</strong></strong></p>
<p><strong><strong>存储对象</strong></strong></p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">BOOL</span>)saveItemWithKey:(<span class="built_in">NSString</span> *)key value:(<span class="built_in">NSData</span> *)value filename:(<span class="built_in">NSString</span> *)filename extendedData:(<span class="built_in">NSData</span> *)extendedData &#123;</span><br><span class="line">    <span class="comment">//.......</span></span><br><span class="line">    <span class="keyword">if</span> (filename.length) &#123;</span><br><span class="line">        <span class="comment">//如果filename不为空，表示使用文件作为磁盘缓存，这时候会先将缓存写到文件中</span></span><br><span class="line">        <span class="keyword">if</span> (![<span class="keyword">self</span> _fileWriteWithName:filename data:value]) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果缓存成功写入到缓存，那么就更新缓存记录数据</span></span><br><span class="line">        <span class="keyword">if</span> (![<span class="keyword">self</span> _dbSaveWithKey:key value:value fileName:filename extendedData:extendedData]) &#123;</span><br><span class="line">            <span class="comment">//如果缓存记录数据存储失败，那么会将缓存文件同时删除以保证缓存文件与缓存记录的同步</span></span><br><span class="line">            [<span class="keyword">self</span> _fileDeleteWithName:filename];</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (_type != YYKVStorageTypeSQLite) &#123;</span><br><span class="line">            <span class="built_in">NSString</span> *filename = [<span class="keyword">self</span> _dbGetFilenameWithKey:key];</span><br><span class="line">            <span class="keyword">if</span> (filename) &#123;</span><br><span class="line">                [<span class="keyword">self</span> _fileDeleteWithName:filename];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//由于filename为nil那么会将缓存数据缓存到inline_data字段。</span></span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">self</span> _dbSaveWithKey:key value:value fileName:<span class="literal">nil</span> extendedData:extendedData];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>saveItemWithKey方法中会先判断filename是否为空，如果是有指定缓存文件名，那么就会先将缓存数据写入到文件缓存起来，同时将缓存记录写入到数据库中，作为缓存记录。如果filename为nil，那么就直接将缓存数据缓存到数据库inline_data字段。接下来我们来看下_dbSaveWithKey：</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">- (BOOL)_dbSaveWithKey:(NSString *)key value:(NSData *)value fileName:(NSString *)fileName extendedData:(NSData *)extendedData &#123;</span><br><span class="line">    NSString *sql = @<span class="string">&quot;insert or replace into manifest (key, filename, size, inline_data, modification_time, last_access_time, extended_data) values (?1, ?2, ?3, ?4, ?5, ?6, ?7);&quot;</span>;</span><br><span class="line">    sqlite3_stmt *stmt = <span class="literal">[<span class="identifier">self</span> <span class="identifier">_dbPrepareStmt</span>:<span class="identifier">sql</span>]</span>;</span><br><span class="line">    <span class="keyword">if</span> (!stmt) return NO;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">int</span> timestamp = (<span class="built_in">int</span>)time(NULL);</span><br><span class="line">    sqlite3<span class="constructor">_bind_text(<span class="params">stmt</span>, 1, <span class="params">key</span>.UTF8String, -1, NULL)</span>;</span><br><span class="line">    sqlite3<span class="constructor">_bind_text(<span class="params">stmt</span>, 2, <span class="params">fileName</span>.UTF8String, -1, NULL)</span>;</span><br><span class="line">    sqlite3<span class="constructor">_bind_int(<span class="params">stmt</span>, 3, (<span class="params">int</span>)</span>value.length);</span><br><span class="line">    <span class="keyword">if</span> (fileName.length<span class="operator"> == </span><span class="number">0</span>) &#123;</span><br><span class="line">        sqlite3<span class="constructor">_bind_blob(<span class="params">stmt</span>, 4, <span class="params">value</span>.<span class="params">bytes</span>, (<span class="params">int</span>)</span>value.length, <span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sqlite3<span class="constructor">_bind_blob(<span class="params">stmt</span>, 4, NULL, 0, 0)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    sqlite3<span class="constructor">_bind_int(<span class="params">stmt</span>, 5, <span class="params">timestamp</span>)</span>;</span><br><span class="line">    sqlite3<span class="constructor">_bind_int(<span class="params">stmt</span>, 6, <span class="params">timestamp</span>)</span>;</span><br><span class="line">    sqlite3<span class="constructor">_bind_blob(<span class="params">stmt</span>, 7, <span class="params">extendedData</span>.<span class="params">bytes</span>, (<span class="params">int</span>)</span>extendedData.length, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">int</span> result = sqlite3<span class="constructor">_step(<span class="params">stmt</span>)</span>;</span><br><span class="line">    <span class="keyword">if</span> (result != SQLITE_DONE) &#123;</span><br><span class="line">        <span class="keyword">if</span> (_errorLogsEnabled) <span class="constructor">NSLog(@<span class="string">&quot;%s line:%d sqlite insert error (%d): %s&quot;</span>, <span class="params">__FUNCTION__</span>, <span class="params">__LINE__</span>, <span class="params">result</span>, <span class="params">sqlite3_errmsg</span>(<span class="params">_db</span>)</span>);</span><br><span class="line">        return NO;</span><br><span class="line">    &#125;</span><br><span class="line">    return YES;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们看这个方法主要是了解这个缓存记录表的结构设计：这个缓存记录表有7个字段分别列举如下：</p>
<figure class="highlight gams"><table><tr><td class="code"><pre><span class="line"><span class="comment">* key               缓存的key</span></span><br><span class="line"><span class="comment">* filename          使用文件缓存的情况下该文件存储的路径</span></span><br><span class="line"><span class="comment">* size              缓存数据大小</span></span><br><span class="line"><span class="comment">* inline_data       数据库缓存的地方</span></span><br><span class="line"><span class="comment">* modification_time 缓存修改时间</span></span><br><span class="line"><span class="comment">* last_access_time  上一次访问时间</span></span><br><span class="line"><span class="comment">* extended_data     额外追加数据</span></span><br></pre></td></tr></table></figure>

<p><strong><strong>删除对象</strong></strong></p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">BOOL</span>)removeItemForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span> (key.length == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    <span class="keyword">switch</span> (_type) &#123;</span><br><span class="line">        <span class="keyword">case</span> YYKVStorageTypeSQLite: &#123;</span><br><span class="line">            <span class="comment">//如果是YYKVStorageTypeSQLite 则只删除数据库记录就可以了，因为这时候数据是存储在数据库记录上的</span></span><br><span class="line">            <span class="keyword">return</span> [<span class="keyword">self</span> _dbDeleteItemWithKey:key];</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> YYKVStorageTypeFile:</span><br><span class="line">        <span class="keyword">case</span> YYKVStorageTypeMixed: &#123;</span><br><span class="line">            <span class="comment">//如果是YYKVStorageTypeFile或者YYKVStorageTypeMixed的形式，会同时删除缓存文件以及数据库缓存记录上的内容</span></span><br><span class="line">            <span class="built_in">NSString</span> *filename = [<span class="keyword">self</span> _dbGetFilenameWithKey:key];</span><br><span class="line">            <span class="keyword">if</span> (filename) &#123;</span><br><span class="line">                [<span class="keyword">self</span> _fileDeleteWithName:filename];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> [<span class="keyword">self</span> _dbDeleteItemWithKey:key];</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>: <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果了解了上面的表结构，其实在逻辑层面上就比较好理解了，这里就不展开介绍了。下面是一些条件删除，只是删除数据库的时候条件不一样罢了，没有啥区别：</p>
<figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line">- (BOOL)removeItemsLargerThanSize:(int)<span class="built_in">size</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">size</span> == INT_MAX) return YES;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">size</span> &lt;= <span class="number">0</span>) return [self <span class="built_in">removeAllItems</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (<span class="variable">_type</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> YYKVStorageTypeSQLite: &#123;</span><br><span class="line">            <span class="keyword">if</span> ([self <span class="variable">_dbDeleteItemsWithSizeLargerThan</span>:<span class="built_in">size</span>]) &#123;</span><br><span class="line">                [self <span class="variable">_dbCheckpoint</span>];</span><br><span class="line">                return YES;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="built_in">break</span>;</span><br><span class="line">        <span class="keyword">case</span> YYKVStorageTypeFile:</span><br><span class="line">        <span class="keyword">case</span> YYKVStorageTypeMixed: &#123;</span><br><span class="line">            NSArray *filenames = [self <span class="variable">_dbGetFilenamesWithSizeLargerThan</span>:<span class="built_in">size</span>];</span><br><span class="line">            <span class="keyword">for</span> (NSString *<span class="built_in">name</span> <span class="built_in">in</span> filenames) &#123;</span><br><span class="line">                [self <span class="variable">_fileDeleteWithName</span>:<span class="built_in">name</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ([self <span class="variable">_dbDeleteItemsWithSizeLargerThan</span>:<span class="built_in">size</span>]) &#123;</span><br><span class="line">                [self <span class="variable">_dbCheckpoint</span>];</span><br><span class="line">                return YES;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="built_in">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    return NO;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (BOOL)removeItemsEarlierThanTime:(int)<span class="built_in">time</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">time</span> &lt;= <span class="number">0</span>) return YES;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">time</span> == INT_MAX) return [self <span class="built_in">removeAllItems</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (<span class="variable">_type</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> YYKVStorageTypeSQLite: &#123;</span><br><span class="line">            <span class="keyword">if</span> ([self <span class="variable">_dbDeleteItemsWithTimeEarlierThan</span>:<span class="built_in">time</span>]) &#123;</span><br><span class="line">                [self <span class="variable">_dbCheckpoint</span>];</span><br><span class="line">                return YES;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="built_in">break</span>;</span><br><span class="line">        <span class="keyword">case</span> YYKVStorageTypeFile:</span><br><span class="line">        <span class="keyword">case</span> YYKVStorageTypeMixed: &#123;</span><br><span class="line">            NSArray *filenames = [self <span class="variable">_dbGetFilenamesWithTimeEarlierThan</span>:<span class="built_in">time</span>];</span><br><span class="line">            <span class="keyword">for</span> (NSString *<span class="built_in">name</span> <span class="built_in">in</span> filenames) &#123;</span><br><span class="line">                [self <span class="variable">_fileDeleteWithName</span>:<span class="built_in">name</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ([self <span class="variable">_dbDeleteItemsWithTimeEarlierThan</span>:<span class="built_in">time</span>]) &#123;</span><br><span class="line">                [self <span class="variable">_dbCheckpoint</span>];</span><br><span class="line">                return YES;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="built_in">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    return NO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">BOOL</span>)removeItemsToFitSize:(<span class="type">int</span>)maxSize &#123;</span><br><span class="line">    <span class="keyword">if</span> (maxSize == INT_MAX) <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    <span class="keyword">if</span> (maxSize &lt;= <span class="number">0</span>) <span class="keyword">return</span> [<span class="keyword">self</span> removeAllItems];</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> total = [<span class="keyword">self</span> _dbGetTotalItemSize];</span><br><span class="line">    <span class="keyword">if</span> (total &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    <span class="keyword">if</span> (total &lt;= maxSize) <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSArray</span> *items = <span class="literal">nil</span>;</span><br><span class="line">    <span class="type">BOOL</span> suc = <span class="literal">NO</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="type">int</span> perCount = <span class="number">16</span>;</span><br><span class="line">        items = [<span class="keyword">self</span> _dbGetItemSizeInfoOrderByTimeAscWithLimit:perCount];</span><br><span class="line">        <span class="keyword">for</span> (YYKVStorageItem *item <span class="keyword">in</span> items) &#123;</span><br><span class="line">            <span class="keyword">if</span> (total &gt; maxSize) &#123;</span><br><span class="line">                <span class="keyword">if</span> (item.filename) &#123;</span><br><span class="line">                    [<span class="keyword">self</span> _fileDeleteWithName:item.filename];</span><br><span class="line">                &#125;</span><br><span class="line">                suc = [<span class="keyword">self</span> _dbDeleteItemWithKey:item.key];</span><br><span class="line">                total -= item.size;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!suc) <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (total &gt; maxSize &amp;&amp; items.count &gt; <span class="number">0</span> &amp;&amp; suc);</span><br><span class="line">    <span class="keyword">if</span> (suc) [<span class="keyword">self</span> _dbCheckpoint];</span><br><span class="line">    <span class="keyword">return</span> suc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">BOOL</span>)removeItemsToFitCount:(<span class="type">int</span>)maxCount &#123;</span><br><span class="line">    <span class="keyword">if</span> (maxCount == INT_MAX) <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    <span class="keyword">if</span> (maxCount &lt;= <span class="number">0</span>) <span class="keyword">return</span> [<span class="keyword">self</span> removeAllItems];</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> total = [<span class="keyword">self</span> _dbGetTotalItemCount];</span><br><span class="line">    <span class="keyword">if</span> (total &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    <span class="keyword">if</span> (total &lt;= maxCount) <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSArray</span> *items = <span class="literal">nil</span>;</span><br><span class="line">    <span class="type">BOOL</span> suc = <span class="literal">NO</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="type">int</span> perCount = <span class="number">16</span>;</span><br><span class="line">        items = [<span class="keyword">self</span> _dbGetItemSizeInfoOrderByTimeAscWithLimit:perCount];</span><br><span class="line">        <span class="keyword">for</span> (YYKVStorageItem *item <span class="keyword">in</span> items) &#123;</span><br><span class="line">            <span class="keyword">if</span> (total &gt; maxCount) &#123;</span><br><span class="line">                <span class="keyword">if</span> (item.filename) &#123;</span><br><span class="line">                    [<span class="keyword">self</span> _fileDeleteWithName:item.filename];</span><br><span class="line">                &#125;</span><br><span class="line">                suc = [<span class="keyword">self</span> _dbDeleteItemWithKey:item.key];</span><br><span class="line">                total--;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!suc) <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (total &gt; maxCount &amp;&amp; items.count &gt; <span class="number">0</span> &amp;&amp; suc);</span><br><span class="line">    <span class="keyword">if</span> (suc) [<span class="keyword">self</span> _dbCheckpoint];</span><br><span class="line">    <span class="keyword">return</span> suc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><strong>获取对象</strong></strong></p>
<p>这里也不想介绍了，大家看注释吧，其实了解了数据库表结构，以及存储的思路，删除和获取其实很好理解的。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="operator">-</span> (<span class="type">YYKVStorageItem</span> <span class="operator">*</span>)getItemForKey:(<span class="type">NSString</span> <span class="operator">*</span>)key &#123;</span><br><span class="line">    <span class="keyword">if</span> (key.length <span class="operator">==</span> <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="comment">//通过key 从数据库或者到当前缓存对象的缓存记录。</span></span><br><span class="line">    <span class="type">YYKVStorageItem</span> <span class="operator">*</span>item <span class="operator">=</span> [<span class="keyword">self</span> _dbGetItemWithKey:key excludeInlineData:<span class="type">NO</span>];</span><br><span class="line">    <span class="keyword">if</span> (item) &#123;</span><br><span class="line">        <span class="comment">//更新下缓存访问时间</span></span><br><span class="line">        [<span class="keyword">self</span> _dbUpdateAccessTimeWithKey:key];</span><br><span class="line">        <span class="comment">//如果缓存记录的filename不为空，则表示是文件缓存</span></span><br><span class="line">        <span class="keyword">if</span> (item.filename) &#123;</span><br><span class="line">            <span class="comment">//读取文件，将数据添加到value字段</span></span><br><span class="line">            item.value <span class="operator">=</span> [<span class="keyword">self</span> _fileReadWithName:item.filename];</span><br><span class="line">            <span class="keyword">if</span> (<span class="operator">!</span>item.value) &#123;</span><br><span class="line">                <span class="comment">//如果缓存文件数据为空，删除缓存记录，保持缓存数据记录与缓存文件同步</span></span><br><span class="line">                [<span class="keyword">self</span> _dbDeleteItemWithKey:key];</span><br><span class="line">                item <span class="operator">=</span> <span class="literal">nil</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> item;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="operator">-</span> (<span class="type">YYKVStorageItem</span> <span class="operator">*</span>)getItemInfoForKey:(<span class="type">NSString</span> <span class="operator">*</span>)key &#123;</span><br><span class="line">    <span class="keyword">if</span> (key.length <span class="operator">==</span> <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="type">YYKVStorageItem</span> <span class="operator">*</span>item <span class="operator">=</span> [<span class="keyword">self</span> _dbGetItemWithKey:key excludeInlineData:<span class="type">YES</span>];</span><br><span class="line">    <span class="keyword">return</span> item;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="operator">-</span> (<span class="type">NSData</span> <span class="operator">*</span>)getItemValueForKey:(<span class="type">NSString</span> <span class="operator">*</span>)key &#123;</span><br><span class="line">    <span class="keyword">if</span> (key.length <span class="operator">==</span> <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="type">NSData</span> <span class="operator">*</span>value <span class="operator">=</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">switch</span> (_type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">YYKVStorageTypeFile</span>: &#123;</span><br><span class="line">            <span class="type">NSString</span> <span class="operator">*</span>filename <span class="operator">=</span> [<span class="keyword">self</span> _dbGetFilenameWithKey:key];</span><br><span class="line">            <span class="keyword">if</span> (filename) &#123;</span><br><span class="line">                value <span class="operator">=</span> [<span class="keyword">self</span> _fileReadWithName:filename];</span><br><span class="line">                <span class="keyword">if</span> (<span class="operator">!</span>value) &#123;</span><br><span class="line">                    [<span class="keyword">self</span> _dbDeleteItemWithKey:key];</span><br><span class="line">                    value <span class="operator">=</span> <span class="literal">nil</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">YYKVStorageTypeSQLite</span>: &#123;</span><br><span class="line">            value <span class="operator">=</span> [<span class="keyword">self</span> _dbGetValueWithKey:key];</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">YYKVStorageTypeMixed</span>: &#123;</span><br><span class="line">            <span class="type">NSString</span> <span class="operator">*</span>filename <span class="operator">=</span> [<span class="keyword">self</span> _dbGetFilenameWithKey:key];</span><br><span class="line">            <span class="keyword">if</span> (filename) &#123;</span><br><span class="line">                value <span class="operator">=</span> [<span class="keyword">self</span> _fileReadWithName:filename];</span><br><span class="line">                <span class="keyword">if</span> (<span class="operator">!</span>value) &#123;</span><br><span class="line">                    [<span class="keyword">self</span> _dbDeleteItemWithKey:key];</span><br><span class="line">                    value <span class="operator">=</span> <span class="literal">nil</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                value <span class="operator">=</span> [<span class="keyword">self</span> _dbGetValueWithKey:key];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (value) &#123;</span><br><span class="line">        [<span class="keyword">self</span> _dbUpdateAccessTimeWithKey:key];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>最后看下磁盘缓存的目录结构：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/path/</span><br><span class="line">      /manifest.sqlite           </span><br><span class="line">      /manifest.sqlite-shm</span><br><span class="line">      /manifest.sqlite-wal</span><br><span class="line">      /data/</span><br><span class="line">           /e10adc3949ba59abbe56e057f20f883e</span><br><span class="line">           /e10adc3949ba59abbe56e057f20f883e</span><br><span class="line">      /trash/</span><br><span class="line">            /unused_file_or_folder</span><br></pre></td></tr></table></figure>

<p>manifest.sqlite,manifest.sqlite-shm,manifest.sqlite-wal 是数据库缓存记录相关的sqlite数据库文件，&#x2F;data&#x2F;目录是用于存储对应的文件缓存，&#x2F;trash&#x2F;则是和我们电脑的垃圾箱一样。</p>
<p><strong><strong>总结</strong></strong></p>
<p>其实大家看文章开始的那张图就啥都明白了，不明白抽我，抖机～～～～～～</p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/iOS-%E5%BC%80%E6%BA%90%E5%BA%93%E5%88%86%E6%9E%90/">iOS 开源库分析</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/iOS-开源库分析/">iOS 开源库分析</a>
  </div>

</div>



</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2019/11/24/PromiseKit-的使用/" title="PromiseKit 的使用">
  <span>
  PromiseKit 的使用</span>
</a>
</div>


<div class="next">
<a href="/2019/11/20/YYModel-源码解析/"  title="YYModel 源码解析">
 <span>YYModel 源码解析
</span>
</a>
</div>

</nav>

	
<section id="comments" class="comment">
	<div class="ds-thread" data-thread-key="2019/11/22/YYCache-源码解析/" data-title="YYCache 源码解析" data-url="http://yoursite.com/2019/11/22/YYCache-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"></div>
</section>


<section id="comments" class="comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
 
 <ol class="toc"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%80%E6%BA%90%E4%BB%A3%E7%A0%81%E4%BF%A1%E6%81%AF"><span class="toc-number">1.</span> <span class="toc-text">开源代码信息</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">
<div id="authorInfo">
	
		<div class="author-img"></div>		
	
	<div class="social-info" class="clearfix">
		
		
		<a href="https://github.com/tbfungeek" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
		
		<a href="mailto:tbfungeek@163.com" target="_blank" class="icon-email" title="Email Me"></a>
		

	</div>
</div>

  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
		  
			<li><a href="/categories/Android-小经验/" title="Android 小经验">Android 小经验<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android-源码分析/" title="Android 源码分析">Android 源码分析<sup>21</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android其他/" title="Android其他">Android其他<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android初步/" title="Android初步">Android初步<sup>21</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android进阶/" title="Android进阶">Android进阶<sup>100</sup></a></li>
		  
		
		  
			<li><a href="/categories/Hexo-使用/" title="Hexo 使用">Hexo 使用<sup>10</sup></a></li>
		  
		
		  
			<li><a href="/categories/JavaScript理论/" title="JavaScript理论">JavaScript理论<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Objective-C-相关/" title="Objective C 相关">Objective C 相关<sup>24</sup></a></li>
		  
		
		  
			<li><a href="/categories/OpenCV/" title="OpenCV">OpenCV<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/ROS/" title="ROS">ROS<sup>9</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-工具使用/" title="iOS 工具使用">iOS 工具使用<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-开源库分析/" title="iOS 开源库分析">iOS 开源库分析<sup>36</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-理论基础/" title="iOS 理论基础">iOS 理论基础<sup>14</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-进阶/" title="iOS 进阶">iOS 进阶<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/个人收藏/" title="个人收藏">个人收藏<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/代码规范/" title="代码规范">代码规范<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/其他/" title="其他">其他<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/博客分类目录/" title="博客分类目录">博客分类目录<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/叨叨系列/" title="叨叨系列">叨叨系列<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/开源代码分析/" title="开源代码分析">开源代码分析<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/开源库分析/" title="开源库分析">开源库分析<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/树莓派/" title="树莓派">树莓派<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/版本控制/" title="版本控制">版本控制<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/直播/" title="直播">直播<sup>6</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/iOS-开源库分析/" title="iOS 开源库分析">iOS 开源库分析<sup>36</sup></a></li>
			
		
			
				<li><a href="/tags/Android-设计模式/" title="Android 设计模式">Android 设计模式<sup>29</sup></a></li>
			
		
			
				<li><a href="/tags/Objective-C-相关/" title="Objective C 相关">Objective C 相关<sup>24</sup></a></li>
			
		
			
				<li><a href="/tags/Android基础/" title="Android基础">Android基础<sup>21</sup></a></li>
			
		
			
				<li><a href="/tags/AOSP-源码/" title="AOSP 源码">AOSP 源码<sup>17</sup></a></li>
			
		
			
				<li><a href="/tags/Android-常用第三方库/" title="Android 常用第三方库">Android 常用第三方库<sup>15</sup></a></li>
			
		
			
				<li><a href="/tags/iOS-理论基础/" title="iOS 理论基础">iOS 理论基础<sup>14</sup></a></li>
			
		
			
				<li><a href="/tags/Hexo-使用/" title="Hexo 使用">Hexo 使用<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/ROS/" title="ROS">ROS<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/Android-动画进阶/" title="Android 动画进阶">Android 动画进阶<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/Android-JNI/" title="Android JNI">Android JNI<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android-绘图进阶/" title="Android 绘图进阶">Android 绘图进阶<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android性能优化/" title="Android性能优化">Android性能优化<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android-自动化测试/" title="Android 自动化测试">Android 自动化测试<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/OpenCV/" title="OpenCV">OpenCV<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/直播/" title="直播">直播<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android-开源源码/" title="Android 开源源码">Android 开源源码<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Android-自定义View进阶/" title="Android 自定义View进阶">Android 自定义View进阶<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/树莓派/" title="树莓派">树莓派<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/iOS-进阶/" title="iOS 进阶">iOS 进阶<sup>4</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="https://hexo.io" target="_blank" title="Hexo">Hexo</a>
            
          </li>
        
          <li>
            
            	<a href="https://pages.github.com/" target="_blank" title="GitHub">GitHub</a>
            
          </li>
        
          <li>
            
            	<a href="http://pf18.github.io/" target="_blank" title="PF18">PF18</a>
            
          </li>
        
          <li>
            
            	<a href="http://toutiao.io/" target="_blank" title="开发者头条">开发者头条</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.jcodecraeer.com/" target="_blank" title="泡在网上的日子">泡在网上的日子</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="atom.xml" target="_blank" title="rss">RSS</a>
</div>

  
  <div class="tagcloudlist">
    <p class="asidetitle">Tag Cloud</p>
    <div class="tagcloudlist clearfix">
       <a href="/tags/AOSP-%E6%BA%90%E7%A0%81/" style="font-size: 17.14px;">AOSP 源码</a> <a href="/tags/Android-APK-%E7%AD%BE%E5%90%8D/" style="font-size: 10px;">Android APK 签名</a> <a href="/tags/Android-JNI/" style="font-size: 12.86px;">Android JNI</a> <a href="/tags/Android-%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E8%BF%9B%E9%98%B6/" style="font-size: 10.71px;">Android 事件处理进阶</a> <a href="/tags/Android-%E5%8A%A8%E7%94%BB%E8%BF%9B%E9%98%B6/" style="font-size: 13.57px;">Android 动画进阶</a> <a href="/tags/Android-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%BC%80%E5%8F%91/" style="font-size: 10px;">Android 多线程开发</a> <a href="/tags/Android-%E5%B0%8F%E7%BB%8F%E9%AA%8C/" style="font-size: 10px;">Android 小经验</a> <a href="/tags/Android-%E5%B8%B8%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93/" style="font-size: 16.43px;">Android 常用第三方库</a> <a href="/tags/Android-%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B/" style="font-size: 10px;">Android 开发流程</a> <a href="/tags/Android-%E5%BC%80%E6%BA%90%E6%BA%90%E7%A0%81/" style="font-size: 12.14px;">Android 开源源码</a> <a href="/tags/Android-%E7%BB%98%E5%9B%BE%E8%BF%9B%E9%98%B6/" style="font-size: 12.86px;">Android 绘图进阶</a> <a href="/tags/Android-%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/" style="font-size: 12.86px;">Android 自动化测试</a> <a href="/tags/Android-%E8%87%AA%E5%AE%9A%E4%B9%89View%E8%BF%9B%E9%98%B6/" style="font-size: 12.14px;">Android 自定义View进阶</a> <a href="/tags/Android-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 19.29px;">Android 设计模式</a> <a href="/tags/Android%E5%85%B6%E4%BB%96/" style="font-size: 10px;">Android其他</a> <a href="/tags/Android%E5%9F%BA%E7%A1%80/" style="font-size: 17.86px;">Android基础</a> <a href="/tags/Android%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B/" style="font-size: 10px;">Android开发流程</a> <a href="/tags/Android%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" style="font-size: 12.86px;">Android性能优化</a> <a href="/tags/Android%E6%B7%B7%E6%B7%86%E6%8A%80%E6%9C%AF/" style="font-size: 10px;">Android混淆技术</a> <a href="/tags/Android%E8%B4%A8%E9%87%8F%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/" style="font-size: 11.43px;">Android质量管理工具</a> <a href="/tags/Android%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/" style="font-size: 10px;">Android逆向工程</a> <a href="/tags/Git-github/" style="font-size: 10px;">Git && github</a> <a href="/tags/Hexo-%E4%BD%BF%E7%94%A8/" style="font-size: 15px;">Hexo 使用</a> <a href="/tags/JavaScript/" style="font-size: 10px;">JavaScript</a> <a href="/tags/Linux-%E4%BD%BF%E7%94%A8/" style="font-size: 10px;">Linux 使用</a> <a href="/tags/Objective-C-%E7%9B%B8%E5%85%B3/" style="font-size: 18.57px;">Objective C 相关</a> <a href="/tags/OpenCV/" style="font-size: 12.86px;">OpenCV</a> <a href="/tags/ROS/" style="font-size: 14.29px;">ROS</a> <a href="/tags/iOS-%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/" style="font-size: 10.71px;">iOS 工具使用</a> <a href="/tags/iOS-%E5%BC%80%E6%BA%90%E5%BA%93%E5%88%86%E6%9E%90/" style="font-size: 20px;">iOS 开源库分析</a> <a href="/tags/iOS-%E7%90%86%E8%AE%BA%E5%9F%BA%E7%A1%80/" style="font-size: 15.71px;">iOS 理论基础</a> <a href="/tags/iOS-%E8%BF%9B%E9%98%B6/" style="font-size: 12.14px;">iOS 进阶</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83/" style="font-size: 10px;">代码规范</a> <a href="/tags/%E5%8D%9A%E5%AE%A2%E5%88%86%E7%B1%BB%E7%9B%AE%E5%BD%95/" style="font-size: 10.71px;">博客分类目录</a> <a href="/tags/%E5%8F%A8%E5%8F%A8%E7%B3%BB%E5%88%97/" style="font-size: 10px;">叨叨系列</a> <a href="/tags/%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8/" style="font-size: 11.43px;">工具的使用</a> <a href="/tags/%E5%BC%80%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/" style="font-size: 10.71px;">开源代码分析</a> <a href="/tags/%E5%BC%80%E6%BA%90%E5%BA%93%E5%88%86%E6%9E%90/" style="font-size: 10px;">开源库分析</a> <a href="/tags/%E6%9D%82%E7%B1%BB/" style="font-size: 10px;">杂类</a> <a href="/tags/%E6%A0%91%E8%8E%93%E6%B4%BE/" style="font-size: 12.14px;">树莓派</a> <a href="/tags/%E7%9B%B4%E6%92%AD/" style="font-size: 12.86px;">直播</a> <a href="/tags/%E7%BC%96%E7%A8%8B%E6%8A%80%E5%B7%A7/" style="font-size: 10.71px;">编程技巧</a> <a href="/tags/%E7%BD%91%E7%AB%99%E6%94%B6%E8%97%8F/" style="font-size: 10px;">网站收藏</a> <a href="/tags/%E9%87%8D%E8%A6%81%E6%8E%A7%E4%BB%B6/" style="font-size: 11.43px;">重要控件</a>
    </div>
  </div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
		
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/hsihohuang/kiddochan" target="_blank" title="Kiddochan">Kiddochan</a> © 2022 
		
		<a href="/about" target="_blank" title="Edgar">Edgar</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
        getSize();
        if (myWidth >= 1024) {
          c.click();
        }
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>




<script type="text/javascript">
  var duoshuoQuery = {short_name:"tbfungeek"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 


<script type="text/javascript">

var disqus_shortname = 'tbfungeek';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>






<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?7c9443b0374f1cf6b1dbb5ab84d939cb";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
