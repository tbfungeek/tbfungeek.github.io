
 <!DOCTYPE HTML>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  
    <title>IGKListKit ä½¿ç”¨åŠæºç åˆ†æ | Edgar&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Edgar">
    

    
    <meta name="description" content="å¼€æºä¿¡æ¯ IGKListKit æºç åœ°å€ IGKListKit æ–‡æ¡£åœ°å€  IGKListKit æ˜¯ä¸€ä¸ªæ•°æ®é©±åŠ¨çš„ç”¨äºå¿«é€Ÿåˆ›å»ºåˆ—è¡¨çš„æ¡†æ¶ï¼Œå®ƒæœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š  ğŸ™… Never call performBatchUpdates(_:, completion:) or reloadData() again ğŸ  Better architecture with reusable cells and c">
<meta property="og:type" content="article">
<meta property="og:title" content="IGKListKit ä½¿ç”¨åŠæºç åˆ†æ">
<meta property="og:url" content="http://yoursite.com/2019/12/08/IGKListKit-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="Edgar&#39;s Blog">
<meta property="og:description" content="å¼€æºä¿¡æ¯ IGKListKit æºç åœ°å€ IGKListKit æ–‡æ¡£åœ°å€  IGKListKit æ˜¯ä¸€ä¸ªæ•°æ®é©±åŠ¨çš„ç”¨äºå¿«é€Ÿåˆ›å»ºåˆ—è¡¨çš„æ¡†æ¶ï¼Œå®ƒæœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š  ğŸ™… Never call performBatchUpdates(_:, completion:) or reloadData() again ğŸ  Better architecture with reusable cells and c">
<meta property="og:locale">
<meta property="og:image" content="http://yoursite.com/2019/12/08/IGKListKit-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/00001.gif">
<meta property="og:image" content="http://yoursite.com/2019/12/08/IGKListKit-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/00002.png">
<meta property="og:image" content="http://yoursite.com/2019/12/08/IGKListKit-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/00003.png">
<meta property="article:published_time" content="2019-12-07T17:23:15.000Z">
<meta property="article:modified_time" content="2019-12-19T13:48:48.000Z">
<meta property="article:author" content="Edgar">
<meta property="article:tag" content="iOS å¼€æºåº“åˆ†æ">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/2019/12/08/IGKListKit-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/00001.gif">

    
    <link rel="alternative" href="atom.xml" title="Edgar&#39;s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/unnamed4_n_mSY_icon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/profile.png">
    <link rel="apple-touch-icon-precomposed" href="/img/profile.png">
    
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.2.0"></head>

  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Edgar&#39;s Blog">Edgar&#39;s Blog</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
					<li>
 					
					<form class="search" action="/search/index.html" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" autocomplete="off" name="q" maxlength="20" placeholder="Search" />
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/12/08/IGKListKit-ä½¿ç”¨åŠæºç åˆ†æ/" title="IGKListKit ä½¿ç”¨åŠæºç åˆ†æ" itemprop="url">IGKListKit ä½¿ç”¨åŠæºç åˆ†æ</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Edgar" target="_blank" itemprop="author">Edgar</a>
		
  <p class="article-time">
    <time datetime="2019-12-07T17:23:15.000Z" itemprop="datePublished"> Published 2019-12-08</time>
    
  </p>
</header>
	<div class="article-content">
		
		<p><img src="/2019/12/08/IGKListKit-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/00001.gif"></p>
<h5 id="å¼€æºä¿¡æ¯"><a href="#å¼€æºä¿¡æ¯" class="headerlink" title="å¼€æºä¿¡æ¯"></a>å¼€æºä¿¡æ¯</h5><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Instagram/IGListKit">IGKListKit æºç åœ°å€</a></li>
<li><a target="_blank" rel="noopener" href="https://instagram.github.io/IGListKit/">IGKListKit æ–‡æ¡£åœ°å€</a></li>
</ul>
<p><strong><strong>IGKListKit æ˜¯ä¸€ä¸ªæ•°æ®é©±åŠ¨çš„ç”¨äºå¿«é€Ÿåˆ›å»ºåˆ—è¡¨çš„æ¡†æ¶ï¼Œå®ƒæœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š</strong></strong></p>
<ul>
<li>ğŸ™… Never call performBatchUpdates(_:, completion:) or reloadData() again</li>
<li>ğŸ  Better architecture with reusable cells and components</li>
<li>ğŸ”  Create collections with multiple data types</li>
<li>ğŸ”‘ Decoupled diffing algorithm</li>
<li>âœ…	Fully unit tested</li>
<li>ğŸ” Customize your diffing behavior for your models</li>
<li>ğŸ“± Simply UICollectionView at its core</li>
<li>ğŸš€ Extendable API</li>
<li>ğŸ¦ Written in Objective-C with full Swift interop support</li>
</ul>
<h5 id="æºç è§£æ"><a href="#æºç è§£æ" class="headerlink" title="æºç è§£æ"></a>æºç è§£æ</h5><p>æ•´ä¸ªIGKListKitä»£ç è¿˜æ˜¯è›®å¤šçš„ï¼Œæˆ‘ä»¬åœ¨è¿›è¡Œæºç è§£æä¹‹å‰å…ˆå¯¹è¿™äº›ä»£ç è¿›è¡Œæ•´ç†ä¸‹ï¼Œçœ‹ä¸‹æ•´ä¸ªIGKListKitæ˜¯ç”±å“ªäº›éƒ¨åˆ†æ„æˆçš„ï¼š</p>
<p><img src="/2019/12/08/IGKListKit-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/00002.png"></p>
<p>è¿™é‡Œå¤§è‡´å°†æ•´ä¸ªä»£ç åˆ†æˆä¸¤å¤§éƒ¨åˆ†ï¼š</p>
<ol>
<li>IGListDiffKit é‡Œé¢å­˜æ”¾çš„æ˜¯IGListKitçš„diff ç®—æ³•ç›¸å…³ç±»</li>
<li>IGListKit é‡Œé¢å­˜æ”¾çš„æ˜¯æ•´ä¸ªæ¡†æ¶ä»£ç ï¼Œå®ƒæ˜¯ç”±å¦‚ä¸‹å‡ éƒ¨åˆ†æ„æˆï¼š</li>
</ol>
<ul>
<li>Adapter: è¿™æ˜¯æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œæ˜¯å®ƒå°†CollectionView,SessionController,Updater,Contextå…³è”èµ·æ¥ã€‚å®ƒä»SessionControllerè·å–æ¯ä¸ªsessionçš„æ•°æ®ï¼Œé€šè¿‡Updaterå°†æ•°æ®åŠ è½½åˆ°CollectionViewã€‚</li>
<li>Updater: è´Ÿè´£å°†æ•°æ®åŠ è½½åˆ°CollectionView</li>
<li>CollectionView: è´Ÿè´£æ•°æ®çš„å±•ç¤º</li>
<li>Context: ä¸€äº›ç¯å¢ƒä¸Šä¸‹æ–‡å…¨å±€å†…å®¹</li>
<li>Debug: ç”¨äºè¾…åŠ©è°ƒè¯•çš„å†…å®¹</li>
</ul>
<p>è¿™ç¯‡åšå®¢ä¼šä»æ•°æ®æºå¼€å§‹ï¼Œä»æ•°æ®æºçš„æä¾›ï¼Œæ ¹æ®æ•°æ®æºé€‰æ‹©SessionController,å†é€šè¿‡Updaterå°†æ•°æ®åŠ è½½åˆ°UICollectionView.</p>
<p><img src="/2019/12/08/IGKListKit-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/00003.png"></p>
<p><strong><strong>æ•°æ®æº</strong></strong></p>
<p>IGListKit æ•°æ®æºéƒ½å¿…é¡»éµå¾ª<strong><strong>IGListAdapterDataSource</strong></strong>åè®®ï¼š</p>
<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> æ ¹æ®ä¼ å…¥çš„IGListAdapteræ¥è¿”å›è¦å±•ç¤ºçš„æ•°æ®æºï¼Œæ³¨æ„è¿™é‡Œçš„æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ å¯¹åº”çš„æ˜¯ä¸€ä¸ªsessionä¸­è¦å±•ç¤ºçš„æ•°æ®é›†ï¼Œè¿”å›çš„æ˜¯å¤šä¸ªsessionæ•°æ®é›†çš„é›†åˆã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (NSArray&lt;id &lt;IGListDiffable&gt;&gt; *)objectsForListAdapter:(IGListAdapter *)listAdapter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> ä¼ å…¥ç‰¹å®šçš„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªsessionçš„æ•°æ®é›†åˆï¼Œè¿”å›å®ƒå¯¹åº”çš„sessionControllerï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œå»ºç«‹sessionControllerä¸å¯¹è±¡æ•°æ®é›†åˆçš„å¯¹åº”å…³ç³»ã€‚è¿™é‡Œä¹Ÿæ˜¯æ–°å»ºsessionControllerçš„åœ°æ–¹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œä¼ æ•°æ®ç»™sessionController</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (IGListSectionController *)listAdapter:(IGListAdapter *)listAdapter sectionControllerForObject:(id)object;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> å½“åˆ—è¡¨çš„æ•°æ®é›†åˆä¸ºç©ºçš„æ—¶å€™å¯ä»¥é€šè¿‡è¿™ä¸ªä½ç½®è¿”å›ç©ºé¡µé¢éœ€è¦å±•ç¤ºçš„å†…å®¹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (nullable UIView *)emptyViewForListAdapter:(IGListAdapter *)listAdapter;</span><br></pre></td></tr></table></figure>

<p>åœ¨<strong><strong>IGListAdapterDataSource</strong></strong>ä¸­æˆ‘ä»¬å¯ä»¥æä¾›æ•°æ®ï¼Œç©ºæ•°æ®æ—¶å€™æ‰€è¦å±•ç¤ºçš„ç•Œé¢ï¼Œä»¥åŠsessionæ•°æ®ä¸sessionControllerä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚</p>
<p><strong><strong>IGListAdapterçš„åˆå§‹åŒ–å·¥ä½œ</strong></strong></p>
<p>IGListAdapteræ˜¯æ•´ä¸ªIGListKitçš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œå®ƒè´Ÿè´£è°ƒåº¦å„ä¸ªç±»æ¥å®Œæˆä»æ•°æ®æºè·å–æ•°æ®ï¼Œæ•°æ®ä¸sessionControllerçš„æ˜ å°„å…³ç³»ï¼Œä½¿ç”¨Updaterå°†æ•°æ®åŠ è½½åˆ°UICollectionView,åˆ†å‘å„ä¸ªä»£ç†äº‹ä»¶ç­‰ç­‰åŠŸèƒ½ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹å®ƒæ˜¯ç”±å“ªäº›é‡è¦çš„ç»„ä»¶æ„æˆï¼Œä»¥åŠè¿™äº›ç»„ä»¶éƒ½æœ‰å“ªäº›åŠŸèƒ½ï¼š</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> å®¹çº³é€‚é…å™¨çš„è§†å›¾æ§åˆ¶å™¨ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">nullable</span>, <span class="keyword">weak</span>) <span class="built_in">UIViewController</span> *viewController;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> é€‚é…å™¨ä½¿ç”¨çš„UICollectionView</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">nullable</span>, <span class="keyword">weak</span>) <span class="built_in">UICollectionView</span> *collectionView;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> IGListAdapterçš„æ•°æ®æº</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">nullable</span>, <span class="keyword">weak</span>) <span class="type">id</span> &lt;IGListAdapterDataSource&gt; dataSource;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> æŸäº›å¯¹è±¡å°†è¦æ˜¾ç¤ºæˆ–è€…å·²ç»æ˜¾ç¤ºå®Œæ¯•åçš„é€šçŸ¥</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">nullable</span>, <span class="keyword">weak</span>) <span class="type">id</span> &lt;IGListAdapterDelegate&gt; delegate;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> æ¥å—UICollectionView ä»£ç†äº‹ä»¶çš„delegate</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">nullable</span>, <span class="keyword">weak</span>) <span class="type">id</span> &lt;<span class="built_in">UICollectionViewDelegate</span>&gt; collectionViewDelegate;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> æ¥å—UIScrollViewä»£ç†äº‹ä»¶çš„delegate</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">nullable</span>, <span class="keyword">weak</span>) <span class="type">id</span> &lt;<span class="built_in">UIScrollViewDelegate</span>&gt; scrollViewDelegate;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> é‡æ’sessionä»£ç†äº‹ä»¶çš„delegate</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">nullable</span>, <span class="keyword">weak</span>) <span class="type">id</span> &lt;IGListAdapterMoveDelegate&gt; moveDelegate <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">9</span>_0);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> ç”¨äºæ€§èƒ½æ£€æµ‹ç‚¹çš„çš„delegate</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">nullable</span>, <span class="keyword">weak</span>) <span class="type">id</span> &lt;IGListAdapterPerformanceDelegate&gt; performanceDelegate;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> Adapterçš„æ›´æ–°å™¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="type">id</span> &lt;IGListUpdatingDelegate&gt; updater;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> å¯¹è±¡ä¸SessionControllerçš„æ˜ å°„å…³ç³»</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) IGListSectionMap *sectionMap;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> æ˜¾ç¤ºcellçš„ç®¡ç†</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) IGListDisplayHandler *displayHandler;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> ç”¨äºå¯è§èŒƒå›´çš„ç®¡ç†</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) IGListWorkingRangeHandler *workingRangeHandler;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> è´Ÿè´£ä»£ç†äº‹ä»¶çš„åˆ†å‘</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">nullable</span>) IGListAdapterProxy *delegateProxy;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> ç©ºè§†å›¾ç•Œé¢</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">nullable</span>) <span class="built_in">UIView</span> *emptyBackgroundView;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> ç”¨äºæ³¨å†ŒCell</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableSet</span>&lt;<span class="built_in">NSString</span> *&gt; *registeredCellIdentifiers;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableSet</span>&lt;<span class="built_in">NSString</span> *&gt; *registeredNibNames;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableSet</span>&lt;<span class="built_in">NSString</span> *&gt; *registeredSupplementaryViewIdentifiers;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableSet</span>&lt;<span class="built_in">NSString</span> *&gt; *registeredSupplementaryViewNibNames;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢åˆ—å‡ºäº†æ¯”è¾ƒé‡è¦çš„ç»„ä»¶ï¼Œä½†æ˜¯ä»æ•´ä½“åŠŸèƒ½ä¸Šçœ‹æœ€ä¸»è¦çš„ç»„ä»¶åŒ…æ‹¬ï¼š</p>
<p><strong><strong>UICollectionView</strong></strong>:UICollectionViewæ˜¯æ•´ä¸ªåˆ—è¡¨çš„ç•Œé¢æ‰¿è½½å®ä½“<br><strong><strong>IGListAdapterDataSource</strong></strong>:IGListAdapterDataSourceä¸ºæ•´ä¸ªIGListAdapteræä¾›æ•°æ®å¯¹è±¡ï¼Œå¹¶ä¸”æŒ‡å®šæ¯ä¸ªsessionå¯¹åº”çš„sessionController,ä»¥åŠç©ºæ•°æ®æ—¶å€™çš„ç•Œé¢<br><strong><strong>IGListUpdatingDelegate</strong></strong>:ç”¨äºå°†æ•°æ®åŠ è½½åˆ°UICollectionView<br>****IGListAdapterDelegate&#x2F;UICollectionViewDelegate&#x2F;UIScrollViewDelegate&#x2F;****ï¼šæä¾›äº‹ä»¶å¤„ç†ä»£ç†æ–¹æ³•<br><strong><strong>IGListAdapterProxy</strong></strong>:è´Ÿè´£äº‹ä»¶åˆ†å‘<br><strong><strong>IGListSectionMap</strong></strong>:ç»´æŠ¤æ•°æ®é›†ä¸sessionControllerçš„æ˜ å°„å…³ç³»<br><strong><strong>IGListDisplayHandler</strong></strong>:è´Ÿè´£å¯è§å¯¹è±¡çš„æ§åˆ¶ï¼Œè¿™äº›å¯è§å¯¹è±¡å­˜å‚¨äºvisibleViewObjectMap<br><strong><strong>IGListWorkingRangeHandler</strong></strong>:è´Ÿè´£å·¥ä½œåŒºçš„ç®¡ç†<br><strong><strong>IGListAdapterMoveDelegate&#x2F;IGListAdapterPerformanceDelegate</strong></strong>ï¼šç§»åŠ¨sessionControllerä»¥åŠæ€§èƒ½æ£€æµ‹åŸ‹ç‚¹çš„ä»£ç†</p>
<p>æˆ‘ä»¬çœ‹ä¸‹ <strong><strong>IGListAdapter</strong></strong> çš„åˆå§‹åŒ–é˜¶æ®µï¼š</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">instancetype</span>)initWithUpdater:(<span class="type">id</span> &lt;IGListUpdatingDelegate&gt;)updater</span><br><span class="line">                 viewController:(<span class="built_in">UIViewController</span> *)viewController</span><br><span class="line">               workingRangeSize:(<span class="built_in">NSInteger</span>)workingRangeSize &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//........</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="variable language_">super</span> init]) &#123; </span><br><span class="line">        <span class="comment">//åˆå§‹åŒ–é‡è¦ç»„ä»¶</span></span><br><span class="line">        <span class="built_in">NSPointerFunctions</span> *keyFunctions = [updater objectLookupPointerFunctions];</span><br><span class="line">        <span class="built_in">NSPointerFunctions</span> *valueFunctions = [<span class="built_in">NSPointerFunctions</span> pointerFunctionsWithOptions:<span class="built_in">NSPointerFunctionsStrongMemory</span>];</span><br><span class="line">        <span class="built_in">NSMapTable</span> *table = [[<span class="built_in">NSMapTable</span> alloc] initWithKeyPointerFunctions:keyFunctions valuePointerFunctions:valueFunctions capacity:<span class="number">0</span>];</span><br><span class="line">        _sectionMap = [[IGListSectionMap alloc] initWithMapTable:table];</span><br><span class="line">        _displayHandler = [IGListDisplayHandler new];</span><br><span class="line">        _workingRangeHandler = [[IGListWorkingRangeHandler alloc] initWithWorkingRangeSize:workingRangeSize];</span><br><span class="line">        _updateListeners = [<span class="built_in">NSHashTable</span> weakObjectsHashTable];</span><br><span class="line">        _viewSectionControllerMap = [<span class="built_in">NSMapTable</span> mapTableWithKeyOptions:<span class="built_in">NSMapTableObjectPointerPersonality</span> | <span class="built_in">NSMapTableStrongMemory</span></span><br><span class="line">                                                          valueOptions:<span class="built_in">NSMapTableStrongMemory</span>];</span><br><span class="line">        _updater = updater;</span><br><span class="line">        _viewController = viewController;</span><br><span class="line">        [IGListDebugger trackAdapter:<span class="keyword">self</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆå§‹åŒ–ä»»åŠ¡ä¸­å®Œæˆäº†å¤§éƒ¨åˆ†é‡è¦ç»„ä»¶çš„åˆå§‹åŒ–ï¼Œä¸Šé¢å·²ç»ä»‹ç»äº†è¿™äº›ç»„ä»¶çš„åŠŸèƒ½ï¼Œè¿™é‡Œå°±ä¸é‡å¤ä»‹ç»äº†ã€‚</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)setCollectionView:(<span class="built_in">UICollectionView</span> *)collectionView &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœcollectionView è¢«ç”¨äºå¦ä¸€ä¸ªadapterï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦å¯¹å®ƒè¿›è¡Œé‡ç½®ï¼Œæ–­å¼€ä¸ä¹‹å‰adapterä¹‹é—´çš„å…³è”ï¼Œé¿å…ä¼šè¢«ä¹‹å‰å¯¹adapteré”™è¯¯æ›´æ–°ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (_collectionView != collectionView || _collectionView.dataSource != <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="comment">//æ¯ä¸ªUICollectionView éƒ½å¯¹åº”ä¸€ä¸ª IGListAdapterï¼ŒglobalCollectionViewAdapterMap é‡Œé¢å­˜æ”¾çš„æ˜¯ä¹‹é—´çš„å¯¹åº”å…³ç³»</span></span><br><span class="line">        <span class="keyword">static</span> <span class="built_in">NSMapTable</span>&lt;<span class="built_in">UICollectionView</span> *, IGListAdapter *&gt; *globalCollectionViewAdapterMap = <span class="literal">nil</span>;</span><br><span class="line">        <span class="keyword">if</span> (globalCollectionViewAdapterMap == <span class="literal">nil</span>) &#123;</span><br><span class="line">            globalCollectionViewAdapterMap = [<span class="built_in">NSMapTable</span> weakToWeakObjectsMapTable];</span><br><span class="line">        &#125;</span><br><span class="line">        [globalCollectionViewAdapterMap removeObjectForKey:_collectionView];</span><br><span class="line">        [[globalCollectionViewAdapterMap objectForKey:collectionView] setCollectionView:<span class="literal">nil</span>];</span><br><span class="line">        [globalCollectionViewAdapterMap setObject:<span class="keyword">self</span> forKey:collectionView];</span><br><span class="line">        <span class="comment">//globalCollectionViewAdapterMap ---&gt; key:UICollectionView  value:IGListAdapter</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//æ³¨å†Œcellä¹‹ç±»çš„åå­—</span></span><br><span class="line">        _registeredCellIdentifiers = [<span class="built_in">NSMutableSet</span> new];</span><br><span class="line">        _registeredNibNames = [<span class="built_in">NSMutableSet</span> new];</span><br><span class="line">        _registeredSupplementaryViewIdentifiers = [<span class="built_in">NSMutableSet</span> new];</span><br><span class="line">        _registeredSupplementaryViewNibNames = [<span class="built_in">NSMutableSet</span> new];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> <span class="type">BOOL</span> settingFirstCollectionView = _collectionView == <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æŒæœ‰collectionViewï¼Œå¹¶å°†adapterä½œä¸ºå®ƒçš„æ•°æ®æº</span></span><br><span class="line">        _collectionView = collectionView;</span><br><span class="line">        _collectionView.dataSource = <span class="keyword">self</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//.....</span></span><br><span class="line">        <span class="comment">//å°†adapterä¿å­˜åˆ°collectionViewLayout</span></span><br><span class="line">        [_collectionView.collectionViewLayout ig_hijackLayoutInteractiveReorderingMethodForAdapter:<span class="keyword">self</span>];</span><br><span class="line">        [_collectionView.collectionViewLayout invalidateLayout];</span><br><span class="line"></span><br><span class="line">        <span class="comment">//CollectionViewDelegate è¦ä¹ˆè®¾ç½®ä¸º delegateProxy è¦ä¹ˆè®¾ç½®ä¸ºadapter</span></span><br><span class="line">        [<span class="keyword">self</span> _updateCollectionViewDelegate];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// only construct</span></span><br><span class="line">        <span class="keyword">if</span> (!IGListExperimentEnabled(<span class="keyword">self</span>.experiments, IGListExperimentGetCollectionViewAtUpdate)</span><br><span class="line">            || settingFirstCollectionView) &#123;</span><br><span class="line">            [<span class="keyword">self</span> _updateAfterPublicSettingsChange];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)_updateCollectionViewDelegate &#123;</span><br><span class="line">    _collectionView.delegate = (<span class="type">id</span>&lt;<span class="built_in">UICollectionViewDelegate</span>&gt;)<span class="keyword">self</span>.delegateProxy ?: <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ä¸ºIGListAdapterè®¾ç½®collectionViewçš„æ—¶å€™è¦æ³¨æ„å¦‚æœglobalCollectionViewAdapterMapä¸­å·²ç»å­˜åœ¨äº†ä¸€ä¸ªæ˜ å°„å…³ç³»ï¼Œéœ€è¦é‡æ–°ç§»é™¤åæ·»åŠ ï¼Œä¹‹åä¸ºcollectionViewé‡æ–°è®¾ç½®å½“å‰çš„Adapterä½œä¸ºæ–°çš„dataSourceï¼Œä»¥åŠdelegateProxyçš„è®¾ç½®ï¼Œå¯¹äºç¬¬ä¸€æ¬¡åˆ›å»ºçš„æ—¶å€™è¿˜éœ€è¦è°ƒç”¨_updateAfterPublicSettingsChangeä»datasourceä¸­å–å‡ºå±äºå½“å‰adapterçš„æ•°æ®ï¼Œè¿›è¡Œç›¸å…³çš„æ›´æ–°ã€‚è¿™éƒ¨åˆ†åœ¨æ¥ä¸‹æ¥çš„è®¾ç½®æ•°æ®æºä¹Ÿä¼šæ¶‰åŠï¼Œæˆ‘ä»¬å°±æ¥çœ‹ä¸‹æ•°æ®æºçš„è®¾ç½®ï¼š</p>
<p><strong><strong>IGListAdapteræ•°æ®æºçš„è®¾ç½®</strong></strong></p>
<figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line">- (void)setDataSource:(id&lt;IGListAdapterDataSource&gt;)dataSource &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">_dataSource</span> != dataSource) &#123;</span><br><span class="line">        <span class="variable">_dataSource</span> = dataSource;</span><br><span class="line">        <span class="comment">//æ•°æ®æºæ”¹å˜çš„æ—¶å€™ä¼šå‰”é™¤é‡å¤æ•°æ®åæ›´æ–°æ•°æ®</span></span><br><span class="line">        [self <span class="variable">_updateAfterPublicSettingsChange</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)<span class="variable">_updateAfterPublicSettingsChange</span> &#123;</span><br><span class="line">    id&lt;IGListAdapterDataSource&gt; dataSource = <span class="variable">_dataSource</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">_collectionView</span> != <span class="literal">nil</span> &amp;&amp; dataSource != <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="comment">//å»é™¤å½“å‰Adapterä¸­é‡å¤çš„å…ƒç´ </span></span><br><span class="line">        NSArray *uniqueObjects = objectsWithDuplicateIdentifiersRemoved([dataSource objectsForListAdapter:self]);</span><br><span class="line">        <span class="comment">//æ›´æ–°æ•°æ®æº</span></span><br><span class="line">        [self <span class="variable">_updateObjects</span>:uniqueObjects dataSource:dataSource];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œä¼šé€šè¿‡[dataSource objectsForListAdapter:self]ï¼Œå–å‡ºå±äºè¯¥adapterçš„æ•°æ®å¯¹è±¡ã€‚ç„¶åé€šè¿‡objectsWithDuplicateIdentifiersRemovedå‰”é™¤æ‰é‡å¤çš„æ•°æ®åï¼Œé€šè¿‡_updateObjectsæ›´æ–°adapterä¸­çš„å…¶ä»–æ¨¡å—æ•°æ®ï¼Œæˆ‘ä»¬é‡ç‚¹çœ‹ä¸‹è¿™ä¸ªéƒ¨åˆ†ï¼š</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)_updateObjects:(<span class="built_in">NSArray</span> *)objects dataSource:(<span class="type">id</span>&lt;IGListAdapterDataSource&gt;)dataSource &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//.......</span></span><br><span class="line">    <span class="built_in">NSMutableArray</span>&lt;IGListSectionController *&gt; *sectionControllers = [<span class="built_in">NSMutableArray</span> new];</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *validObjects = [<span class="built_in">NSMutableArray</span> new];</span><br><span class="line"></span><br><span class="line">    IGListSectionMap *map = <span class="keyword">self</span>.sectionMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// collect items that have changed since the last update</span></span><br><span class="line">    <span class="built_in">NSMutableSet</span> *updatedObjects = [<span class="built_in">NSMutableSet</span> new];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//éå†ä»æ•°æ®æºè·å–åˆ°çš„æ¯ä¸ªæ•°æ®,æ³¨æ„è¿™é‡Œçš„objectå…¶å®æ˜¯ä¸€ä¸ªæ•°æ®é›†ï¼Œæ¯ä¸ªæ•°æ®é›†é’ˆå¯¹ä¸€ä¸ªsessionController</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">id</span> object <span class="keyword">in</span> objects) &#123;</span><br><span class="line">        <span class="comment">// æŸ¥çœ‹æ˜¯å¦ä¹‹å‰å·²ç»åˆ›å»ºäº†sectionControllerï¼Œå¦‚æœæœ‰å°±ç›´æ¥ä½¿ç”¨</span></span><br><span class="line">        IGListSectionController *sectionController = [map sectionControllerForObject:object];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœä¹‹å‰æ²¡æœ‰æˆ‘ä»¬å°±è¯¢é—®dataSourceè¿”å›ä¸€ä¸ªæŒ‡å®šæ•°æ®é›†å¯¹åº”çš„sessionController</span></span><br><span class="line">        <span class="keyword">if</span> (sectionController == <span class="literal">nil</span>) &#123;</span><br><span class="line">            sectionController = [dataSource listAdapter:<span class="keyword">self</span> sectionControllerForObject:object];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å¦‚æœå†æ²¡æœ‰ç›´æ¥æŠ¥é”™</span></span><br><span class="line">        <span class="keyword">if</span> (sectionController == <span class="literal">nil</span>) &#123;</span><br><span class="line">            IGLKLog(<span class="string">@&quot;WARNING: Ignoring nil section controller returned by data source %@ for object %@.&quot;</span>,</span><br><span class="line">                    dataSource, object);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°†ä¸€äº›ç¯å¢ƒå˜é‡èµ‹ç»™sectionControllerï¼Œæ¯”å¦‚å°†å½“å‰çš„adapterä½œä¸ºcollectionContextèµ‹ç»™sectionController</span></span><br><span class="line">        sectionController.collectionContext = <span class="keyword">self</span>;</span><br><span class="line">        sectionController.viewController = <span class="keyword">self</span>.viewController;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ£€æŸ¥å½“å‰çš„å¯¹è±¡æ˜¯å…¨æ–°çš„è¿˜æ˜¯å¯¹å·²ç»æœ‰çš„å¯¹è±¡è¿›è¡Œæ›´æ–°</span></span><br><span class="line">        <span class="keyword">const</span> <span class="built_in">NSInteger</span> oldSection = [map sectionForObject:object];</span><br><span class="line">        <span class="keyword">if</span> (oldSection == <span class="built_in">NSNotFound</span> || [map objectForSection:oldSection] != object) &#123;</span><br><span class="line">            <span class="comment">//æ›´æ–°çš„å¯¹è±¡</span></span><br><span class="line">            [updatedObjects addObject:object];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//å°†ç»“æœè®°å½•åˆ°sectionControllers ä¸ validObjects</span></span><br><span class="line">        [sectionControllers addObject:sectionController];</span><br><span class="line">        [validObjects addObject:object];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// clear the view controller and collection context</span></span><br><span class="line">    IGListSectionControllerPopThread();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ›´æ–°åˆ°IGListSectionMap IGListSectionMapç”¨äºç»´æŠ¤object ä¸sessionControllerçš„ä¹‹é—´çš„å…³ç³»</span></span><br><span class="line">    [map updateWithObjects:validObjects sectionControllers:sectionControllers];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// object ä¸ sessionControllerä¹‹é—´çš„å…³ç³»å·²ç»å»ºç«‹ï¼Œè¿™æ—¶å€™å¯ä»¥è®¤ä¸ºsessionControllerå·²ç»åŠ è½½å®Œæ¯•ï¼ŒåŠ è½½å®ŒæˆåsessionControllerä¼šæ”¶åˆ°didUpdateToObjectçš„é€šçŸ¥</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">id</span> object <span class="keyword">in</span> updatedObjects) &#123;</span><br><span class="line">        [[map sectionControllerForObject:object] didUpdateToObject:object];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è®¡ç®—æ€»æ•°é‡</span></span><br><span class="line">    <span class="built_in">NSInteger</span> itemCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (IGListSectionController *sectionController <span class="keyword">in</span> sectionControllers) &#123;</span><br><span class="line">        itemCount += [sectionController numberOfItems];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ ¹æ®æ€»æ•°é‡å†³å®šæ˜¾ç¤ºç©ºç•Œé¢è¿˜æ˜¯æ­£å¸¸çš„UICollectionView</span></span><br><span class="line">    [<span class="keyword">self</span> _updateBackgroundViewShouldHide:itemCount &gt; <span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)_updateBackgroundViewShouldHide:(<span class="type">BOOL</span>)shouldHide &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å¦‚æœè¿˜åœ¨æ›´æ–°é‚£ä¹ˆå…ˆè¿”å›,åœ¨update blockæ‰§è¡Œç»“æŸä¹‹åè¿˜ä¼šè°ƒç”¨</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.isInUpdateBlock) &#123;</span><br><span class="line">        <span class="keyword">return</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ ¹æ®itemCountæ•°é‡å†³å®šæ˜¯å¦æ˜¾ç¤ºç©ºç™½é¡µé¢</span></span><br><span class="line">    <span class="built_in">UIView</span> *backgroundView = [<span class="keyword">self</span>.dataSource emptyViewForListAdapter:<span class="keyword">self</span>];</span><br><span class="line">    <span class="comment">// don&#x27;t do anything if the client is using the same view</span></span><br><span class="line">    <span class="keyword">if</span> (backgroundView != _collectionView.backgroundView) &#123;</span><br><span class="line">        <span class="comment">// collection view will just stack the background views underneath each other if we do not remove the previous</span></span><br><span class="line">        <span class="comment">// one first. also fine if it is nil</span></span><br><span class="line">        [_collectionView.backgroundView removeFromSuperview];</span><br><span class="line">        _collectionView.backgroundView = backgroundView;</span><br><span class="line">    &#125;</span><br><span class="line">    _collectionView.backgroundView.hidden = shouldHide;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ä¸Šé¢ä¼ å…¥_updateObjectsçš„objectsæ˜¯æ•´ä¸ªadapteræ‰€å¯¹åº”çš„æ•°æ®é›†çš„æ•°ç»„ï¼Œé‚£ä¹ˆåœ¨_updateObjectsä¸­é¦–å…ˆéœ€è¦éå†æ•°ç»„ä¸­çš„æ¯ä¸ªæ•°æ®é›†ï¼Œæˆ‘ä»¬çŸ¥é“objectä¸sessionControllerçš„å¯¹åº”å…³ç³»å­˜åœ¨äºä¸¤ä¸ªåœ°æ–¹IGListSectionMapä»¥åŠIGListAdapterã€‚é¦–å…ˆæˆ‘ä»¬ä¼šä»IGListSectionMapä¸­å»æ£€æŸ¥æ˜¯å¦æœ‰ç¼“å­˜äº†è¿™ç§å…³ç³»ï¼Œå¦‚æœæ²¡æœ‰å†ä»IGListAdapterå»è·å–ã€‚æ‹¿åˆ°ä¹‹åå†æ›´æ–°åˆ°IGListSectionMapä»¥ä¾›ä¸‹æ¬¡ä½¿ç”¨ã€‚å¯¹äºæ•°æ®æœ‰å˜åŠ¨çš„æƒ…å†µè¿˜ä¼šè°ƒç”¨sessionControllerçš„didUpdateToObjectæ–¹æ³•ã€‚æœ€åè®¡ç®—æ•´ä¸ªadapterçš„æ•°æ®æ€»æ•°ï¼Œå¦‚æœæ•°æ®æ€»æ•°ä¸º0é‚£ä¹ˆä¼šè°ƒç”¨emptyViewForListAdapterè·å–ç©ºç•Œé¢è¿›è¡Œå±•ç¤ºã€‚</p>
<p><strong><strong>IGListAdapterä»£ç†è®¾ç½®</strong></strong></p>
<figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line">- (void)setCollectionViewDelegate:(id&lt;UICollectionViewDelegate&gt;)collectionViewDelegate &#123;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="comment">//_collectionViewDelegate è¿™ä¸ªä¼šä¼ é€’åˆ°IGListAdapterProxy</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">_collectionViewDelegate</span> != collectionViewDelegate) &#123;</span><br><span class="line">        <span class="variable">_collectionViewDelegate</span> = collectionViewDelegate;</span><br><span class="line">        <span class="comment">//åˆ›å»ºIGListAdapterProxyå¹¶è®¾ç½®ä¸ºdelegate</span></span><br><span class="line">        [self <span class="variable">_createProxyAndUpdateCollectionViewDelegate</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)setScrollViewDelegate:(id&lt;UIScrollViewDelegate&gt;)scrollViewDelegate &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">_scrollViewDelegate</span> != scrollViewDelegate) &#123;</span><br><span class="line">        <span class="variable">_scrollViewDelegate</span> = scrollViewDelegate;</span><br><span class="line">        <span class="comment">//_scrollViewDelegate è¿™ä¸ªä¼šä¼ é€’åˆ°IGListAdapterProxy</span></span><br><span class="line">        [self <span class="variable">_createProxyAndUpdateCollectionViewDelegate</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)<span class="variable">_createProxyAndUpdateCollectionViewDelegate</span> &#123;</span><br><span class="line">    <span class="variable">_collectionView</span>.delegate = <span class="literal">nil</span>;</span><br><span class="line">    self.delegateProxy = [[IGListAdapterProxy alloc] initWithCollectionViewTarget:<span class="variable">_collectionViewDelegate</span></span><br><span class="line">                                                                 scrollViewTarget:<span class="variable">_scrollViewDelegate</span></span><br><span class="line">                                                                      interceptor:self];</span><br><span class="line">    [self <span class="variable">_updateCollectionViewDelegate</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šé¢ä»£ç çœ‹IGListAdapterProxyæ¥å—ä¸‰ä¸ªå¯¹è±¡_collectionViewDelegateï¼Œ_scrollViewDelegateä»¥åŠadapterã€‚ç„¶åå†å°†IGListAdapterProxyä½œä¸ºcollectionViewçš„delegateã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥é€šè¿‡IGListAdapterProxyè¿›è¡Œç»Ÿä¸€ç®¡ç†ï¼ŒIGListAdapterProxyè´Ÿè´£è¿™äº›ä»£ç†äº‹ä»¶çš„é›†ä¸­åˆ†å‘ã€‚</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">BOOL</span>)respondsToSelector:(SEL)aSelector &#123;</span><br><span class="line">    <span class="keyword">return</span> isInterceptedSelector(aSelector)</span><br><span class="line">    || [_collectionViewTarget respondsToSelector:aSelector]</span><br><span class="line">    || [_scrollViewTarget respondsToSelector:aSelector];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">id</span>)forwardingTargetForSelector:(SEL)aSelector &#123;</span><br><span class="line">    <span class="keyword">if</span> (isInterceptedSelector(aSelector)) &#123;</span><br><span class="line">        <span class="keyword">return</span> _interceptor;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [_scrollViewTarget respondsToSelector:aSelector] ? _scrollViewTarget : _collectionViewTarget;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)invocation &#123;</span><br><span class="line">    <span class="type">void</span> *nullPointer = <span class="literal">NULL</span>;</span><br><span class="line">    [invocation setReturnValue:&amp;nullPointer];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)selector &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSObject</span> instanceMethodSignatureForSelector:<span class="keyword">@selector</span>(init)];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨IGListAdapterProxyä¸­ä¼šå¯¹è¿™äº›ä»£ç†æ–¹æ³•è¿›è¡Œæ‹¦æˆªï¼Œå¦‚æœåœ¨æ‹¦æˆªæ¸…å•å†…çš„è¯ä¼šå°†è¿™äº›ä»£ç†æ–¹æ³•è½¬åˆ°_interceptorä¹Ÿå°±æ˜¯adapterï¼Œå…¶ä»–çš„åˆ™ä¼šæ ¹æ®_scrollViewTargetä»¥åŠ_collectionViewTargetæ˜¯å¦æœ‰å“åº”çš„æ–¹æ³•æ¥ç¡®å®šè½¬å‘ç»™è°,ä¸‹é¢æ˜¯æ‹¦æˆªçš„æ–¹æ³•ï¼š</p>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">static</span> <span class="selector-tag">BOOL</span> <span class="selector-tag">isInterceptedSelector</span>(SEL sel) &#123;</span><br><span class="line">    <span class="selector-tag">return</span> (</span><br><span class="line">            <span class="comment">// UIScrollViewDelegate</span></span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">scrollViewDidScroll</span>:) ||</span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">scrollViewWillBeginDragging</span>:) ||</span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">scrollViewDidEndDragging</span>:<span class="attribute">willDecelerate</span>:) ||</span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">scrollViewDidEndDecelerating</span>:) ||</span><br><span class="line">            <span class="comment">// UICollectionViewDelegate</span></span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">collectionView</span>:<span class="attribute">willDisplayCell</span>:<span class="attribute">forItemAtIndexPath</span>:) ||</span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">collectionView</span>:<span class="attribute">didEndDisplayingCell</span>:<span class="attribute">forItemAtIndexPath</span>:) ||</span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">collectionView</span>:<span class="attribute">didSelectItemAtIndexPath</span>:) ||</span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">collectionView</span>:<span class="attribute">didDeselectItemAtIndexPath</span>:) ||</span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">collectionView</span>:<span class="attribute">didHighlightItemAtIndexPath</span>:) ||</span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">collectionView</span>:<span class="attribute">didUnhighlightItemAtIndexPath</span>:) ||</span><br><span class="line">            <span class="comment">// UICollectionViewDelegateFlowLayout</span></span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">collectionView</span>:<span class="attribute">layout</span>:<span class="attribute">sizeForItemAtIndexPath</span>:) ||</span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">collectionView</span>:<span class="attribute">layout</span>:<span class="attribute">insetForSectionAtIndex</span>:) ||</span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">collectionView</span>:<span class="attribute">layout</span>:<span class="attribute">minimumInteritemSpacingForSectionAtIndex</span>:) ||</span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">collectionView</span>:<span class="attribute">layout</span>:<span class="attribute">minimumLineSpacingForSectionAtIndex</span>:) ||</span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">collectionView</span>:<span class="attribute">layout</span>:<span class="attribute">referenceSizeForFooterInSection</span>:) ||</span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">collectionView</span>:<span class="attribute">layout</span>:<span class="attribute">referenceSizeForHeaderInSection</span>:) ||</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// IGListCollectionViewDelegateLayout</span></span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">collectionView</span>:<span class="attribute">layout</span>:<span class="attribute">customizedInitialLayoutAttributes</span>:<span class="attribute">atIndexPath</span>:) ||</span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">collectionView</span>:<span class="attribute">layout</span>:<span class="attribute">customizedFinalLayoutAttributes</span>:<span class="attribute">atIndexPath</span>:)</span><br><span class="line">            );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><strong>Object &amp;&amp; sessionController ä¹‹é—´çš„æ˜ å°„å…³ç³»</strong></strong></p>
<p>ç›®å‰åœ¨IGListKitå¯ä»¥å®Œæˆå¦‚ä¸‹å‡ ç§å¯¹è±¡ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼š</p>
<figure class="highlight brainfuck"><table><tr><td class="code"><pre><span class="line"><span class="comment">* indexPath</span> &lt;<span class="literal">--</span><span class="comment">indexPath</span><span class="string">.</span><span class="comment">section</span><span class="literal">--</span>&gt; <span class="comment">section</span> &lt;<span class="literal">---</span><span class="comment">sectionControllerForSection/sectionForSectionController</span><span class="literal">---</span>&gt; <span class="comment">IGListSectionController</span> &lt;<span class="literal">--</span><span class="comment">sectionControllerForObject/objectForSection</span><span class="literal">--</span>&gt;<span class="comment">object</span></span><br><span class="line"></span><br><span class="line"><span class="comment">* indexPath</span> <span class="literal">--</span><span class="comment">sectionControllerForSection</span><span class="literal">--</span><span class="comment">supplementaryViewSource</span><span class="literal">--</span>&gt; <span class="comment">IGListSupplementaryViewSource</span></span><br></pre></td></tr></table></figure>

<p>è¿™éƒ¨åˆ†ä»£ç å°±ä¸è´´å‡ºæ¥äº†ï¼Œæœ€åº•å±‚é€»è¾‘åœ¨sectionMapä¸Šï¼Œå¤§å®¶å¯ä»¥æŸ¥çœ‹å¯¹åº”çš„æºç ã€‚</p>
<p><strong><strong>å¯è§æ€§é€šçŸ¥</strong></strong></p>
<p>è¿™éƒ¨åˆ†ä¸»è¦æ¶‰åŠ<strong><strong>IGListDisplayDelegate</strong></strong>ï¼Œ<strong><strong>IGListAdapterDelegate</strong></strong>ï¼Œ<strong><strong>IGListDisplayHandler</strong></strong>è¿™ä¸‰ä¸ªç±»ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å®šIGListAdapterçš„delegateæ¥ç›‘å¬å¯è§æ€§æƒ…å†µï¼š</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">IGListAdapterDelegate</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> é€šçŸ¥delegateæŸä¸ªæ•°æ®é›†å³å°†æ˜¾ç¤º</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="type">void</span>)listAdapter:(IGListAdapter *)listAdapter willDisplayObject:(<span class="type">id</span>)object atIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> é€šçŸ¥delegateæŸä¸ªæ•°æ®é›†åˆå°†ä¸åœ¨æ˜¾ç¤ºèŒƒå›´å†…</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="type">void</span>)listAdapter:(IGListAdapter *)listAdapter didEndDisplayingObject:(<span class="type">id</span>)object atIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>IGListAdapterDelegateå…¶å®å’ŒIGListDisplayDelegateæ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡ä¸€ä¸ªæ˜¯åœ¨adapterä¸Šå±‚ç›‘å¬ï¼Œä¸€ä¸ªæ˜¯åœ¨sessionControllerç›‘å¬ã€‚IGListDisplayDelegateå…¶å®ç›‘å¬çš„æ˜¯æ›´ç»†ç²’åº¦çš„å¯ä»¥é€šè¿‡ä»£ç†çŸ¥é“å…·ä½“å“ªä¸ªcellè¿›å…¥å¯è§åŒºåŸŸï¼Œæˆ‘ä»¬åœ¨çœ‹ä¸‹IGListDisplayDelegateï¼š</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">IGListDisplayDelegate</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">æŒ‡å®šçš„sessionControllerè¿›å…¥åˆ°å¯è§åŒºåŸŸ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="type">void</span>)listAdapter:(IGListAdapter *)listAdapter willDisplaySectionController:(IGListSectionController *)sectionController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">æŒ‡å®šçš„sessionControllerç¦»å¼€å¯è§åŒºåŸŸ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="type">void</span>)listAdapter:(IGListAdapter *)listAdapter didEndDisplayingSectionController:(IGListSectionController *)sectionController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">åœ¨æŸä¸ªsessionControllerçš„æŸä¸ªcellè¿›å…¥åˆ°å¯è§åŒºåŸŸ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="type">void</span>)listAdapter:(IGListAdapter *)listAdapter willDisplaySectionController:(IGListSectionController *)sectionController</span><br><span class="line">               cell:(<span class="built_in">UICollectionViewCell</span> *)cell</span><br><span class="line">            atIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">æŸä¸ªsessionControllerçš„æŸä¸ªcellç¦»å¼€å¯è§åŒºåŸŸ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="type">void</span>)listAdapter:(IGListAdapter *)listAdapter didEndDisplayingSectionController:(IGListSectionController *)sectionController</span><br><span class="line">               cell:(<span class="built_in">UICollectionViewCell</span> *)cell</span><br><span class="line">            atIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>IGListAdapterDelegateå’ŒIGListDisplayDelegateå¯¹åº”çš„æ–¹æ³•æ˜¯åœ¨IGListDisplayHandlerä¸­è¢«è°ƒç”¨çš„ã€‚IGListDisplayHandlerä¸­ç»´æŠ¤ç€ä¸€ä»½visibleListSectionsä»¥åŠvisibleViewObjectMapï¼›visibleListSectionsé‡Œé¢å­˜å‚¨ç€å½“å‰å¯è§çš„sessionController,visibleViewObjectMapé‡Œé¢å­˜å‚¨çš„æ˜¯æ•°æ®å¯¹è±¡ä»¥åŠCellViewçš„æ˜ å°„å…³ç³»ã€‚åœ¨sessionControllerè¿›å…¥ç¦»å¼€å¯è§åŒºåŸŸçš„æ—¶å€™éƒ½ä¼šç»´æŠ¤è¿™ä¸¤ä¸ªå¯¹è±¡é‡Œé¢çš„å†…å®¹ï¼Œå¹¶ä¸”é€šçŸ¥adapterä»¥åŠsessionControllerä¸­çš„å¯¹åº”delegateã€‚</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)_willDisplayReusableView:(<span class="built_in">UICollectionReusableView</span> *)view</span><br><span class="line">                 forListAdapter:(IGListAdapter *)listAdapter</span><br><span class="line">              sectionController:(IGListSectionController *)sectionController</span><br><span class="line">                         object:(<span class="type">id</span>)object</span><br><span class="line">                      indexPath:(<span class="built_in">NSIndexPath</span> *)indexPath &#123;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="comment">//self.visibleViewObjectMap ä¸­å­˜å‚¨çš„æ˜¯æ•°æ®å¯¹è±¡ä»¥åŠCellView</span></span><br><span class="line">    [<span class="keyword">self</span>.visibleViewObjectMap setObject:object forKey:view];</span><br><span class="line">    <span class="comment">//å¯è§çš„sessionéƒ¨åˆ†</span></span><br><span class="line">    <span class="built_in">NSCountedSet</span> *visibleListSections = <span class="keyword">self</span>.visibleListSections;</span><br><span class="line">    <span class="keyword">if</span> ([visibleListSections countForObject:sectionController] == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/*å¦‚æœå½“å‰çš„sectionControlleræ²¡æœ‰åœ¨å¯è§sessionåˆ—è¡¨ä¸­åˆ™è§¦å‘é€šçŸ¥ç»™sectionControllerä»¥åŠlistAdapter*/</span></span><br><span class="line">        [sectionController.displayDelegate listAdapter:listAdapter willDisplaySectionController:sectionController];</span><br><span class="line">        [listAdapter.delegate listAdapter:listAdapter willDisplayObject:object atIndex:indexPath.section];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å°†å½“å‰çš„sectionControlleræ·»åŠ åˆ°visibleListSections é¿å…é‡å¤é€šçŸ¥</span></span><br><span class="line">    [visibleListSections addObject:sectionController];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)_didEndDisplayingReusableView:(<span class="built_in">UICollectionReusableView</span> *)view</span><br><span class="line">                      forListAdapter:(IGListAdapter *)listAdapter</span><br><span class="line">                   sectionController:(IGListSectionController *)sectionController</span><br><span class="line">                              object:(<span class="type">id</span>)object</span><br><span class="line">                           indexPath:(<span class="built_in">NSIndexPath</span> *)indexPath &#123;</span><br><span class="line">    IGParameterAssert(view != <span class="literal">nil</span>);</span><br><span class="line">    IGParameterAssert(listAdapter != <span class="literal">nil</span>);</span><br><span class="line">    IGParameterAssert(indexPath != <span class="literal">nil</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (object == <span class="literal">nil</span> || sectionController == <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">NSInteger</span> section = indexPath.section;</span><br><span class="line">    <span class="comment">//ç§»é™¤sectionControllerå¹¶é€šçŸ¥sectionControllerä»¥åŠlistAdapter</span></span><br><span class="line">    <span class="built_in">NSCountedSet</span> *visibleSections = <span class="keyword">self</span>.visibleListSections;</span><br><span class="line">    [visibleSections removeObject:sectionController];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ([visibleSections countForObject:sectionController] == <span class="number">0</span>) &#123;</span><br><span class="line">        [sectionController.displayDelegate listAdapter:listAdapter didEndDisplayingSectionController:sectionController];</span><br><span class="line">        [listAdapter.delegate listAdapter:listAdapter didEndDisplayingObject:object atIndex:section];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆIGListDisplayHandlerè¿™äº›æ–¹æ³•æ˜¯è°è§¦å‘çš„å‘¢ï¼Ÿå—¯ï¼Œæ˜¯Adapterè§¦å‘çš„ï¼Œæˆ‘ä»¬ä¸Šé¢ä»‹ç»IGListAdapterProxyçš„æ—¶å€™è®²åˆ°Adapterä¼šæ‹¦æˆªéƒ¨åˆ†çš„ä»£ç†æ–¹æ³•ï¼Œåœ¨è¿™éƒ¨åˆ†ä»£ç†æ–¹æ³•ä¸­å°±å¯ä»¥è°ƒç”¨IGListDisplayHandlerå‘å‡ºé€šçŸ¥ã€‚è¿™éƒ¨åˆ†ä»£ç åœ¨<strong><strong>IGListAdapter+UICollectionView</strong></strong>,è¿™é‡Œé¢åŒ…æ‹¬äº†å¯è§åŒºåŸŸçš„é€šçŸ¥ï¼Œä»¥åŠå·¥ä½œåŒºç›¸å…³çš„å¤„ç†ã€‚ç”±äºåŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯ç”±äºåœ¨IGListAdapterProxyä¼šå¯¹è¿™éƒ¨åˆ†ä»£ç†æ–¹æ³•è¿›è¡Œæ‹¦æˆªï¼Œæ‰€ä»¥è¿™é‡Œè¿˜éœ€è¦å°†äº‹ä»¶é€šçŸ¥åˆ°collectionViewDelegate</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="operator">-</span> (void)collectionView:(<span class="type">UICollectionView</span> <span class="operator">*</span>)collectionView willDisplayCell:(<span class="type">UICollectionViewCell</span> <span class="operator">*</span>)cell forItemAtIndexPath:(<span class="type">NSIndexPath</span> <span class="operator">*</span>)indexPath &#123;</span><br><span class="line">    id<span class="operator">&lt;</span><span class="type">IGListAdapterPerformanceDelegate</span><span class="operator">&gt;</span> performanceDelegate <span class="operator">=</span> <span class="keyword">self</span>.performanceDelegate;</span><br><span class="line">    [performanceDelegate listAdapterWillCallDisplayCell:<span class="keyword">self</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”±äºåœ¨IGListAdapterProxyä¼šå¯¹è¿™éƒ¨åˆ†è¯·æ±‚è¿›è¡Œæ‹¦æˆªï¼Œæ‰€ä»¥è¿™é‡Œè¿˜éœ€è¦å°†äº‹ä»¶é€šçŸ¥åˆ°collectionViewDelegate</span></span><br><span class="line">    id<span class="operator">&lt;</span><span class="type">UICollectionViewDelegate</span><span class="operator">&gt;</span> collectionViewDelegate <span class="operator">=</span> <span class="keyword">self</span>.collectionViewDelegate;</span><br><span class="line">    <span class="keyword">if</span> ([collectionViewDelegate respondsToSelector:<span class="meta">@selector</span>(collectionView:willDisplayCell:forItemAtIndexPath:)]) &#123;</span><br><span class="line">        [collectionViewDelegate collectionView:collectionView willDisplayCell:cell forItemAtIndexPath:indexPath];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–åˆ°sessionController</span></span><br><span class="line">    <span class="type">IGListSectionController</span> <span class="operator">*</span>sectionController <span class="operator">=</span> [<span class="keyword">self</span> sectionControllerForView:cell];</span><br><span class="line">    <span class="comment">// if the section controller relationship was destroyed, reconnect it</span></span><br><span class="line">    <span class="comment">// this happens with iOS 10 UICollectionView display range changes</span></span><br><span class="line">    <span class="keyword">if</span> (sectionController <span class="operator">==</span> <span class="literal">nil</span>) &#123;</span><br><span class="line">        sectionController <span class="operator">=</span> [<span class="keyword">self</span> sectionControllerForSection:indexPath.section];</span><br><span class="line">        <span class="comment">//è¿™é‡Œä¸ºäº†å»ºç«‹cellä¸sessionControllerä¹‹é—´çš„å…³ç³»ï¼Œä¾›sectionControllerForViewä½¿ç”¨</span></span><br><span class="line">        [<span class="keyword">self</span> mapView:cell toSectionController:sectionController];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å–å‡ºå½“å‰sessionControllerå¯¹åº”çš„æ•°æ®é›†</span></span><br><span class="line">    id object <span class="operator">=</span> [<span class="keyword">self</span>.sectionMap objectForSection:indexPath.section];</span><br><span class="line">    <span class="comment">//é€šçŸ¥å¯¹åº”çš„delegate</span></span><br><span class="line">    [<span class="keyword">self</span>.displayHandler willDisplayCell:cell forListAdapter:<span class="keyword">self</span> sectionController:sectionController object:object indexPath:indexPath];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å·¥ä½œåŒºç›¸å…³æ›´æ–°</span></span><br><span class="line">    _isSendingWorkingRangeDisplayUpdates <span class="operator">=</span> <span class="type">YES</span>;</span><br><span class="line">    [<span class="keyword">self</span>.workingRangeHandler willDisplayItemAtIndexPath:indexPath forListAdapter:<span class="keyword">self</span>];</span><br><span class="line">    _isSendingWorkingRangeDisplayUpdates <span class="operator">=</span> <span class="type">NO</span>;</span><br><span class="line"></span><br><span class="line">    [performanceDelegate listAdapter:<span class="keyword">self</span> didCallDisplayCell:cell onSectionController:sectionController atIndex:indexPath.item];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="operator">-</span> (void)collectionView:(<span class="type">UICollectionView</span> <span class="operator">*</span>)collectionView didEndDisplayingCell:(<span class="type">UICollectionViewCell</span> <span class="operator">*</span>)cell forItemAtIndexPath:(<span class="type">NSIndexPath</span> <span class="operator">*</span>)indexPath &#123;</span><br><span class="line">    id<span class="operator">&lt;</span><span class="type">IGListAdapterPerformanceDelegate</span><span class="operator">&gt;</span> performanceDelegate <span class="operator">=</span> <span class="keyword">self</span>.performanceDelegate;</span><br><span class="line">    [performanceDelegate listAdapterWillCallEndDisplayCell:<span class="keyword">self</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”±äºåœ¨IGListAdapterProxyä¼šå¯¹è¿™éƒ¨åˆ†è¯·æ±‚è¿›è¡Œæ‹¦æˆªï¼Œæ‰€ä»¥è¿™é‡Œè¿˜éœ€è¦å°†äº‹ä»¶é€šçŸ¥åˆ°collectionViewDelegate</span></span><br><span class="line">    id<span class="operator">&lt;</span><span class="type">UICollectionViewDelegate</span><span class="operator">&gt;</span> collectionViewDelegate <span class="operator">=</span> <span class="keyword">self</span>.collectionViewDelegate;</span><br><span class="line">    <span class="keyword">if</span> ([collectionViewDelegate respondsToSelector:<span class="meta">@selector</span>(collectionView:didEndDisplayingCell:forItemAtIndexPath:)]) &#123;</span><br><span class="line">        [collectionViewDelegate collectionView:collectionView didEndDisplayingCell:cell forItemAtIndexPath:indexPath];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–åˆ°sessionController</span></span><br><span class="line">    <span class="type">IGListSectionController</span> <span class="operator">*</span>sectionController <span class="operator">=</span> [<span class="keyword">self</span> sectionControllerForView:cell];</span><br><span class="line">    <span class="comment">//é€šçŸ¥å¯¹åº”çš„delegate</span></span><br><span class="line">    [<span class="keyword">self</span>.displayHandler didEndDisplayingCell:cell forListAdapter:<span class="keyword">self</span> sectionController:sectionController indexPath:indexPath];</span><br><span class="line">    <span class="comment">//å·¥ä½œåŒºç›¸å…³æ›´æ–°</span></span><br><span class="line">    [<span class="keyword">self</span>.workingRangeHandler didEndDisplayingItemAtIndexPath:indexPath forListAdapter:<span class="keyword">self</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// break the association between the cell and the section controller</span></span><br><span class="line">    [<span class="keyword">self</span> removeMapForView:cell];</span><br><span class="line"></span><br><span class="line">    [performanceDelegate listAdapter:<span class="keyword">self</span> didCallEndDisplayCell:cell onSectionController:sectionController atIndex:indexPath.item];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="operator">-</span> (void)collectionView:(<span class="type">UICollectionView</span> <span class="operator">*</span>)collectionView willDisplaySupplementaryView:(<span class="type">UICollectionReusableView</span> <span class="operator">*</span>)view forElementKind:(<span class="type">NSString</span> <span class="operator">*</span>)elementKind atIndexPath:(<span class="type">NSIndexPath</span> <span class="operator">*</span>)indexPath &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç”±äºåœ¨IGListAdapterProxyä¼šå¯¹è¿™éƒ¨åˆ†è¯·æ±‚è¿›è¡Œæ‹¦æˆªï¼Œæ‰€ä»¥è¿™é‡Œè¿˜éœ€è¦å°†äº‹ä»¶é€šçŸ¥åˆ°collectionViewDelegate</span></span><br><span class="line">    id<span class="operator">&lt;</span><span class="type">UICollectionViewDelegate</span><span class="operator">&gt;</span> collectionViewDelegate <span class="operator">=</span> <span class="keyword">self</span>.collectionViewDelegate;</span><br><span class="line">    <span class="keyword">if</span> ([collectionViewDelegate respondsToSelector:<span class="meta">@selector</span>(collectionView:willDisplaySupplementaryView:forElementKind:atIndexPath:)]) &#123;</span><br><span class="line">        [collectionViewDelegate collectionView:collectionView willDisplaySupplementaryView:view forElementKind:elementKind atIndexPath:indexPath];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">IGListSectionController</span> <span class="operator">*</span>sectionController <span class="operator">=</span> [<span class="keyword">self</span> sectionControllerForView:view];</span><br><span class="line">    <span class="comment">// if the section controller relationship was destroyed, reconnect it</span></span><br><span class="line">    <span class="comment">// this happens with iOS 10 UICollectionView display range changes</span></span><br><span class="line">    <span class="keyword">if</span> (sectionController <span class="operator">==</span> <span class="literal">nil</span>) &#123;</span><br><span class="line">        sectionController <span class="operator">=</span> [<span class="keyword">self</span>.sectionMap sectionControllerForSection:indexPath.section];</span><br><span class="line">        [<span class="keyword">self</span> mapView:view toSectionController:sectionController];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    id object <span class="operator">=</span> [<span class="keyword">self</span>.sectionMap objectForSection:indexPath.section];</span><br><span class="line">    <span class="comment">//é€šçŸ¥å¯¹åº”çš„delegate</span></span><br><span class="line">    [<span class="keyword">self</span>.displayHandler willDisplaySupplementaryView:view forListAdapter:<span class="keyword">self</span> sectionController:sectionController object:object indexPath:indexPath];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="operator">-</span> (void)collectionView:(<span class="type">UICollectionView</span> <span class="operator">*</span>)collectionView didEndDisplayingSupplementaryView:(<span class="type">UICollectionReusableView</span> <span class="operator">*</span>)view forElementOfKind:(<span class="type">NSString</span> <span class="operator">*</span>)elementKind atIndexPath:(<span class="type">NSIndexPath</span> <span class="operator">*</span>)indexPath &#123;</span><br><span class="line">    <span class="comment">// ç”±äºåœ¨IGListAdapterProxyä¼šå¯¹è¿™éƒ¨åˆ†è¯·æ±‚è¿›è¡Œæ‹¦æˆªï¼Œæ‰€ä»¥è¿™é‡Œè¿˜éœ€è¦å°†äº‹ä»¶é€šçŸ¥åˆ°collectionViewDelegate</span></span><br><span class="line">    id<span class="operator">&lt;</span><span class="type">UICollectionViewDelegate</span><span class="operator">&gt;</span> collectionViewDelegate <span class="operator">=</span> <span class="keyword">self</span>.collectionViewDelegate;</span><br><span class="line">    <span class="keyword">if</span> ([collectionViewDelegate respondsToSelector:<span class="meta">@selector</span>(collectionView:didEndDisplayingSupplementaryView:forElementOfKind:atIndexPath:)]) &#123;</span><br><span class="line">        [collectionViewDelegate collectionView:collectionView didEndDisplayingSupplementaryView:view forElementOfKind:elementKind atIndexPath:indexPath];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">IGListSectionController</span> <span class="operator">*</span>sectionController <span class="operator">=</span> [<span class="keyword">self</span> sectionControllerForView:view];</span><br><span class="line">    <span class="comment">//é€šçŸ¥å¯¹åº”çš„delegate</span></span><br><span class="line">    [<span class="keyword">self</span>.displayHandler didEndDisplayingSupplementaryView:view forListAdapter:<span class="keyword">self</span> sectionController:sectionController indexPath:indexPath];</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span> removeMapForView:view];</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong><strong>å·¥ä½œåŒºç®¡ç†</strong></strong></p>
<p>å¯¹äºå·¥ä½œåŒºç®¡ç†ä¼šåœ¨è¿›å…¥æ˜¾ç¤ºåŒºçš„æ—¶å€™å°†å½“å‰çš„indexPath ä¿¡æ¯æ·»åŠ åˆ°_visibleSectionIndicesï¼Œé€€å‡ºå¯è§†åŒºåŸŸçš„æ—¶å€™ä»_visibleSectionIndicesä¸­åˆ é™¤ã€‚ç„¶åæ ¹æ®workingRangeSizeæ¥ç¡®å®šèµ·å§‹å’Œç»“æŸçš„indexï¼Œæ ¹æ®ç¡®å®šçš„èµ·å§‹indexå’Œç»“æŸindexå°†å¯è§çš„sessionControlleræ·»åŠ åˆ°workingRangeSectionControllersï¼Œå†é€šè¿‡æ–°çš„workingRangeSectionControllersä¸æ—§çš„workingRangeSectionControllersè¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æœåªå‡ºç°å†æ–°çš„ï¼Œè€Œåœ¨è€çš„æ²¡å‡ºç°ï¼Œè¿™æ—¶å€™è¡¨ç¤ºå½“å‰çš„sessionControllerä¸ºæ–°è¿›å…¥å·¥ä½œåŒºçš„ï¼Œåä¹‹åˆ™ä¸ºé€€å‡ºå·¥ä½œåŒºçš„ã€‚</p>
<figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line">- (void)willDisplayItemAtIndexPath:(NSIndexPath *)indexPath</span><br><span class="line">                    forListAdapter:(IGListAdapter *)listAdapter &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¾€_visibleSectionIndicesä¸­æ’å…¥å¯è§çš„NSIndexPathä¿¡æ¯</span></span><br><span class="line">    <span class="variable">_visibleSectionIndices</span>.<span class="built_in">insert</span>(&#123;</span><br><span class="line">        .section = indexPath.section,</span><br><span class="line">        .row = indexPath.row,</span><br><span class="line">        .hash = indexPath.hash</span><br><span class="line">    &#125;);</span><br><span class="line">    [self <span class="variable">_updateWorkingRangesWithListAdapter</span>:listAdapter];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)didEndDisplayingItemAtIndexPath:(NSIndexPath *)indexPath</span><br><span class="line">                         forListAdapter:(IGListAdapter *)listAdapter &#123;</span><br><span class="line">    <span class="comment">//å°†å°†è¦ç§»é™¤åˆ°å¯è§èŒƒå›´ä¹‹å¤–çš„cellçš„NSIndexPathä»_visibleSectionIndicesä¸­ç§»é™¤</span></span><br><span class="line">    <span class="variable">_visibleSectionIndices</span>.erase(&#123;</span><br><span class="line">        .section = indexPath.section,</span><br><span class="line">        .row = indexPath.row,</span><br><span class="line">        .hash = indexPath.hash</span><br><span class="line">    &#125;);</span><br><span class="line">    [self <span class="variable">_updateWorkingRangesWithListAdapter</span>:listAdapter];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - Working Ranges</span></span><br><span class="line"></span><br><span class="line">- (void)<span class="variable">_updateWorkingRangesWithListAdapter</span>:(IGListAdapter *)listAdapter &#123;</span><br><span class="line">    IGAssertMainThread();</span><br><span class="line">    <span class="comment">// This method is optimized C++ to improve straight-line speed of these operations. Change at your peril.</span></span><br><span class="line">    <span class="comment">// We use a std::set because it is ordered.</span></span><br><span class="line">    std::<span class="built_in">set</span>&lt;NSInteger&gt; visibleSectionSet = std::<span class="built_in">set</span>&lt;NSInteger&gt;();</span><br><span class="line">    <span class="keyword">for</span> (const <span class="variable">_IGListWorkingRangeHandlerIndexPath</span> &amp;indexPath : <span class="variable">_visibleSectionIndices</span>) &#123;</span><br><span class="line">        visibleSectionSet.<span class="built_in">insert</span>(indexPath.section);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ ¹æ®workingRangeSizeè®¡ç®—workingRangeçš„start å’Œ end</span></span><br><span class="line">    NSInteger start;</span><br><span class="line">    NSInteger end;</span><br><span class="line">    <span class="keyword">if</span> (visibleSectionSet.<span class="built_in">size</span>() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// We&#x27;re now devoid of any visible sections. Bail</span></span><br><span class="line">        start = <span class="number">0</span>;</span><br><span class="line">        end = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        start = <span class="built_in">MAX</span>(*visibleSectionSet.begin() - <span class="variable">_workingRangeSize</span>, <span class="number">0</span>);</span><br><span class="line">        end = <span class="built_in">MIN</span>(*visibleSectionSet.rbegin() + <span class="number">1</span> + <span class="variable">_workingRangeSize</span>, (NSInteger)listAdapter.objects.<span class="built_in">count</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Build the current set of working range section controllers</span></span><br><span class="line">    <span class="comment">// æ„å»ºæ–°çš„å¯è§sessionController é›†åˆ</span></span><br><span class="line">    <span class="variable">_IGListWorkingRangeSectionControllerSet</span> workingRangeSectionControllers (visibleSectionSet.<span class="built_in">size</span>());</span><br><span class="line">    <span class="keyword">for</span> (NSInteger idx = start; idx &lt; end; idx++) &#123;</span><br><span class="line">        <span class="comment">//å–å‡ºå·¥ä½œåŒºä¸­çš„sessionController</span></span><br><span class="line">        id item = [listAdapter objectAtSection:idx];</span><br><span class="line">        IGListSectionController *sectionController = [listAdapter sectionControllerForObject:item];</span><br><span class="line">        workingRangeSectionControllers.<span class="built_in">insert</span>(&#123;sectionController&#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å·¥ä½œåŒºä¸èƒ½å¤§äº1000</span></span><br><span class="line">    IGAssert(workingRangeSectionControllers.<span class="built_in">size</span>() &lt; <span class="number">1000</span>, @<span class="string">&quot;This algorithm is way too slow with so many objects:%lu&quot;</span>, workingRangeSectionControllers.<span class="built_in">size</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Tell any new section controllers that they have entered the working range</span></span><br><span class="line">    <span class="comment">// ä»æ–°çš„å¯è§sessionController é›†åˆä¸­éå†æ¯ä¸ªå…ƒç´ çœ‹ä¸‹æ˜¯å¦åœ¨æ—§çš„å­˜åœ¨ï¼Œå¦‚æœåœ¨æ—§çš„ä¸å­˜åœ¨ è¯´æ˜è¿™ä¸ªæ˜¯æ–°è¿›å…¥å·¥ä½œåŒºçš„é€šçŸ¥å¯¹åº”çš„sessionController</span></span><br><span class="line">    <span class="keyword">for</span> (const <span class="variable">_IGListWorkingRangeHandlerSectionControllerWrapper</span> &amp;wrapper : workingRangeSectionControllers) &#123;</span><br><span class="line">        <span class="comment">// Check if the item exists in the old working range item array.</span></span><br><span class="line">        auto it = <span class="variable">_workingRangeSectionControllers</span>.<span class="built_in">find</span>(wrapper);</span><br><span class="line">        <span class="keyword">if</span> (it == <span class="variable">_workingRangeSectionControllers</span>.end()) &#123;</span><br><span class="line">            <span class="comment">// The section controller isn&#x27;t in the existing list, so it&#x27;s new.</span></span><br><span class="line">            id &lt;IGListWorkingRangeDelegate&gt; workingRangeDelegate = wrapper.sectionController.workingRangeDelegate;</span><br><span class="line">            [workingRangeDelegate listAdapter:listAdapter sectionControllerWillEnterWorkingRange:wrapper.sectionController];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŒç†å¤„ç†é€€å‡ºå·¥ä½œåŒºçš„äº‹ä»¶</span></span><br><span class="line">    <span class="comment">// Tell any removed section controllers that they have exited the working range</span></span><br><span class="line">    <span class="keyword">for</span> (const <span class="variable">_IGListWorkingRangeHandlerSectionControllerWrapper</span> &amp;wrapper : <span class="variable">_workingRangeSectionControllers</span>) &#123;</span><br><span class="line">        <span class="comment">// Check if the item exists in the new list of section controllers</span></span><br><span class="line">        auto it = workingRangeSectionControllers.<span class="built_in">find</span>(wrapper);</span><br><span class="line">        <span class="keyword">if</span> (it == workingRangeSectionControllers.end()) &#123;</span><br><span class="line">            <span class="comment">// If the item does not exist in the new list, then it&#x27;s been removed.</span></span><br><span class="line">            id &lt;IGListWorkingRangeDelegate&gt; workingRangeDelegate = wrapper.sectionController.workingRangeDelegate;</span><br><span class="line">            [workingRangeDelegate listAdapter:listAdapter sectionControllerDidExitWorkingRange:wrapper.sectionController];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">_workingRangeSectionControllers</span> = workingRangeSectionControllers;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><strong>åŠ è½½æ•°æ®åˆ°UICollectionView</strong></strong></p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)reloadDataWithCompletion:(<span class="keyword">nullable</span> IGListUpdaterCompletion)completion &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">id</span>&lt;IGListAdapterDataSource&gt; dataSource = <span class="keyword">self</span>.dataSource;</span><br><span class="line">    <span class="built_in">UICollectionView</span> *collectionView = <span class="keyword">self</span>.collectionView;</span><br><span class="line">    <span class="comment">//.......</span></span><br><span class="line">    <span class="comment">//ä»æ•°æ®æºé‡Œé¢è·å–å½“å‰adapterçš„å…¨éƒ¨æ•°æ®é›†</span></span><br><span class="line">    <span class="built_in">NSArray</span> *uniqueObjects = objectsWithDuplicateIdentifiersRemoved([dataSource objectsForListAdapter:<span class="keyword">self</span>]);</span><br><span class="line">    __<span class="keyword">weak</span> __typeof__(<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>;</span><br><span class="line">    <span class="comment">//è°ƒç”¨updater åŠ è½½æ•°æ®</span></span><br><span class="line">    [<span class="keyword">self</span>.updater reloadDataWithCollectionViewBlock:[<span class="keyword">self</span> _collectionViewBlock]</span><br><span class="line">                                  reloadUpdateBlock:^&#123;</span><br><span class="line">                                      <span class="comment">// purge all section controllers from the item map so that they are regenerated</span></span><br><span class="line">                                      [weakSelf.sectionMap reset];</span><br><span class="line">                                      [weakSelf _updateObjects:uniqueObjects dataSource:dataSource];</span><br><span class="line">                                  &#125; completion:^(<span class="type">BOOL</span> finished) &#123;</span><br><span class="line">                                      [weakSelf _notifyDidUpdate:IGListAdapterUpdateTypeReloadData animated:<span class="literal">NO</span>];</span><br><span class="line">                                      <span class="keyword">if</span> (completion) &#123;</span><br><span class="line">                                          completion(finished);</span><br><span class="line">                                      &#125;</span><br><span class="line">                                  &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨adapterè°ƒç”¨åŠ è½½æ•°æ®çš„æ—¶å€™ä¼šå…ˆä»datasourceä¸­è·å–åˆ°å½“å‰adapterå…¨éƒ¨sessionConstrolleræ‰€éœ€è¦çš„å…¨éƒ¨æ•°æ®é›†ã€‚è¿™äº›æ•°æ®æ•°æ®é›†è¢«åŒ…è£¹reloadUpdateBlockï¼Œç­‰åˆ°éœ€è¦æ‰§è¡ŒreloadUpdateBlockçš„æ—¶å€™æ›´æ–°Adapteré‡Œé¢çš„sessionMapç­‰ç›¸å…³ç­‰æ•°æ®é›†åˆï¼Œå› ä¸ºåé¢è°ƒç”¨UICollectionView reloadDataåä¼šé€šè¿‡UICollectionView çš„dateSourceä¹Ÿå°±æ˜¯ adapterä¸­é€šè¿‡å¯¹åº”çš„ä»£ç†æ–¹æ³•ä»sessionControllerä¸­è·å–æ•°æ®ã€‚</p>
<p>å®Œæˆä¸Šé¢çš„è®¾ç½®åå°±å¯ä»¥è°ƒç”¨updaterçš„reloadDataWithCollectionViewBlockè¿›è¡Œæ•°æ®åŠ è½½ã€‚</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)reloadDataWithCollectionViewBlock:(IGListCollectionViewBlock)collectionViewBlock</span><br><span class="line">                   reloadUpdateBlock:(IGListReloadUpdateBlock)reloadUpdateBlock</span><br><span class="line">                          completion:(<span class="keyword">nullable</span> IGListUpdatingCompletion)completion &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//.......</span></span><br><span class="line">    <span class="comment">//å°†å®Œæˆæ‰€éœ€è¦è°ƒç”¨çš„ç»“æŸå›è°ƒæ·»åŠ åˆ°completionBlocks</span></span><br><span class="line">    IGListUpdatingCompletion localCompletion = completion;</span><br><span class="line">    <span class="keyword">if</span> (localCompletion) &#123;</span><br><span class="line">        [<span class="keyword">self</span>.completionBlocks addObject:localCompletion];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">self</span>.reloadUpdates = reloadUpdateBlock;</span><br><span class="line">    <span class="keyword">self</span>.queuedReloadData = <span class="literal">YES</span>;</span><br><span class="line">    [<span class="keyword">self</span> _queueUpdateWithCollectionViewBlock:collectionViewBlock];</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>reloadDataWithCollectionViewBlockä¸­ä¼šå°†queuedReloadDataè®¾ç½®ä¸ºYES,ç„¶åè§¦å‘_queueUpdateWithCollectionViewBlockï¼Œåœ¨_queueUpdateWithCollectionViewBlockä¸­ç”±äºqueuedReloadDataè®¾ç½®ä¸ºYESï¼Œæ‰€ä»¥æ‰§è¡ŒperformReloadDataWithCollectionViewBlock</p>
<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">- (void)_queueUpdateWithCollectionViewBlock:(IGListCollectionViewBlock)collectionViewBlock &#123;</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        <span class="comment">//å¦‚æœæ­£åœ¨å¤„äºæ‰¹é‡æ›´æ–°æ•°æ®ä¸­ï¼Œæˆ–è€…æ²¡æœ‰æ–°çš„å˜æ›´åˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">        if (weakSelf.state != IGListBatchUpdateStateIdle</span><br><span class="line">            || ![weakSelf hasChanges]) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        if (weakSelf.hasQueuedReloadData) &#123;</span><br><span class="line">            <span class="comment">//æ‰§è¡ŒåŠ è½½</span></span><br><span class="line">            <span class="selector-attr">[weakSelf performReloadDataWithCollectionViewBlock:collectionViewBlock]</span>;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            <span class="comment">//æ‰¹é‡åŠ è½½</span></span><br><span class="line">            <span class="selector-attr">[weakSelf performBatchUpdatesWithCollectionViewBlock:collectionViewBlock]</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><strong>åŠ è½½æ•°æ®åˆ°UICollectionView</strong></strong></p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)performReloadDataWithCollectionViewBlock:(IGListCollectionViewBlock)collectionViewBlock &#123;</span><br><span class="line">    IGAssertMainThread();</span><br><span class="line"></span><br><span class="line">    <span class="type">id</span>&lt;IGListAdapterUpdaterDelegate&gt; delegate = <span class="keyword">self</span>.delegate;</span><br><span class="line">    <span class="type">void</span> (^reloadUpdates)(<span class="type">void</span>) = <span class="keyword">self</span>.reloadUpdates;</span><br><span class="line">    IGListBatchUpdates *batchUpdates = <span class="keyword">self</span>.batchUpdates;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *completionBlocks = [<span class="keyword">self</span>.completionBlocks mutableCopy];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¼€å§‹åŠ è½½å‰æ¸…é™¤ç›¸å…³çš„çŠ¶æ€å˜é‡</span></span><br><span class="line">    [<span class="keyword">self</span> cleanStateBeforeUpdates];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åŠ è½½ç»“æŸä¹‹åæ‰§è¡Œå…¨éƒ¨çš„completeBlock,å¹¶ä¸”å°†çŠ¶æ€æ”¹ä¸ºIGListBatchUpdateStateIdle</span></span><br><span class="line">    <span class="type">void</span> (^executeCompletionBlocks)(<span class="type">BOOL</span>) = ^(<span class="type">BOOL</span> finished) &#123;</span><br><span class="line">        <span class="keyword">for</span> (IGListUpdatingCompletion block <span class="keyword">in</span> completionBlocks) &#123;</span><br><span class="line">            block(finished);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.state = IGListBatchUpdateStateIdle;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// åœ¨æ›´æ–°ä»»åŠ¡è¿˜åœ¨é˜Ÿåˆ—çš„æ—¶å€™å¦‚æœè¿”å›æ‰§è¡Œçš„æ—¶å€™å‘ç°collectionå·²ç»è¢«é‡Šæ”¾åˆ™é‡ç½®å¯¹åº”çš„çŠ¶æ€å¹¶è°ƒç”¨completeBlockï¼Œå°†çŠ¶æ€è®¾ç½®ä¸ºIGListBatchUpdateStateIdle</span></span><br><span class="line">    <span class="built_in">UICollectionView</span> *collectionView = collectionViewBlock();</span><br><span class="line">    <span class="keyword">if</span> (collectionView == <span class="literal">nil</span>) &#123;</span><br><span class="line">        [<span class="keyword">self</span> _cleanStateAfterUpdates];</span><br><span class="line">        executeCompletionBlocks(<span class="literal">NO</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// item updates must not send mutations to the collection view while we are reloading</span></span><br><span class="line">    <span class="comment">// å°†çŠ¶æ€è®¾ç½®ä¸ºæ­£åœ¨åŠ è½½æ•°æ®</span></span><br><span class="line">    <span class="keyword">self</span>.state = IGListBatchUpdateStateExecutingBatchUpdateBlock;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è°ƒç”¨_updateObjects é‡å»ºobject å’Œ sessionControllerä¹‹é—´çš„å…³ç³»</span></span><br><span class="line">    <span class="keyword">if</span> (reloadUpdates) &#123;</span><br><span class="line">        reloadUpdates();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰§è¡Œæ‰¹é‡æ›´æ–°ä¸­çš„å•ä¸ªæ›´æ–°block</span></span><br><span class="line">    <span class="comment">// execute all stored item update blocks even if we are just calling reloadData. the actual collection view</span></span><br><span class="line">    <span class="comment">// mutations will be discarded, but clients are encouraged to put their actual /data/ mutations inside the</span></span><br><span class="line">    <span class="comment">// update block as well, so if we don&#x27;t execute the block the changes will never happen</span></span><br><span class="line">    <span class="keyword">for</span> (IGListItemUpdateBlock itemUpdateBlock <span class="keyword">in</span> batchUpdates.itemUpdateBlocks) &#123;</span><br><span class="line">        itemUpdateBlock();</span><br><span class="line">    &#125;</span><br><span class="line">    [completionBlocks addObjectsFromArray:batchUpdates.itemCompletionBlocks];</span><br><span class="line">    <span class="keyword">self</span>.state = IGListBatchUpdateStateExecutedBatchUpdateBlock;</span><br><span class="line">    <span class="comment">//å°†çŠ¶æ€è®¾ç½®ä¸ºæ‰¹é‡æ›´æ–°æ‰§è¡Œå®Œæ¯•</span></span><br><span class="line">    [<span class="keyword">self</span> _cleanStateAfterUpdates];</span><br><span class="line">    <span class="comment">//é€šçŸ¥å¤–éƒ¨å½“å‰çš„UICollectionViewå³å°†å¼€å§‹åŠ è½½æ•°æ®</span></span><br><span class="line">    [delegate listAdapterUpdater:<span class="keyword">self</span> willReloadDataWithCollectionView:collectionView];</span><br><span class="line">    <span class="comment">//åŠ è½½æ•°æ®</span></span><br><span class="line">    [collectionView reloadData];</span><br><span class="line">    [collectionView.collectionViewLayout invalidateLayout];</span><br><span class="line">    [collectionView layoutIfNeeded];</span><br><span class="line">    <span class="comment">//é€šçŸ¥å¤–éƒ¨å½“å‰çš„UICollectionViewå·²ç»åŠ è½½å®Œæ•°æ®</span></span><br><span class="line">    [delegate listAdapterUpdater:<span class="keyword">self</span> didReloadDataWithCollectionView:collectionView];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ‰§è¡Œå®Œæˆåçš„block</span></span><br><span class="line">    executeCompletionBlocks(<span class="literal">YES</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>performReloadDataWithCollectionViewBlockæ–¹æ³•ä¸­ä¼šæ‰§è¡Œä¼ å…¥çš„reloadUpdatesä»¥åŠbatchUpdates.itemUpdateBlocksä¸­å¯¹åº”çš„æ›´æ–°blockç„¶ååœ¨è°ƒç”¨å¯¹åº”çš„<br>delegate é€šçŸ¥UICollectionViewå°†è¦å¼€å§‹è¿›è¡Œæ•°æ®åŠ è½½ã€‚ç„¶åè°ƒç”¨[collectionView reloadData]åŠ è½½æ•°æ®ã€‚</p>
<p>è°ƒç”¨[collectionView reloadData] åä¾¿ä¼šè§¦å‘UICollectionViewçš„å¯¹åº”ä»£ç†ï¼Œç”±äºIGListAdapterä¼šå¯¹UICollectionView çš„UICollectionViewDataSource ä»£ç†è¿›è¡Œæ‹¦æˆªï¼Œæ‰€ä»¥è¿™äº›å¤„ç†å‡ºç°åœ¨IGListAdapterä¸­ï¼š</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">NSInteger</span>)numberOfSectionsInCollectionView:(<span class="built_in">UICollectionView</span> *)collectionView &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.sectionMap.objects.count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSInteger</span>)collectionView:(<span class="built_in">UICollectionView</span> *)collectionView numberOfItemsInSection:(<span class="built_in">NSInteger</span>)section &#123;</span><br><span class="line">    IGListSectionController * sectionController = [<span class="keyword">self</span> sectionControllerForSection:section];</span><br><span class="line">    IGAssert(sectionController != <span class="literal">nil</span>, <span class="string">@&quot;Nil section controller for section %li for item %@. Check your -diffIdentifier and -isEqual: implementations.&quot;</span>,</span><br><span class="line">             (<span class="type">long</span>)section, [<span class="keyword">self</span>.sectionMap objectForSection:section]);</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">NSInteger</span> numberOfItems = [sectionController numberOfItems];</span><br><span class="line">    IGAssert(numberOfItems &gt;= <span class="number">0</span>, <span class="string">@&quot;Cannot return negative number of items %li for section controller %@.&quot;</span>, (<span class="type">long</span>)numberOfItems, sectionController);</span><br><span class="line">    <span class="keyword">return</span> numberOfItems;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UICollectionViewCell</span> *)collectionView:(<span class="built_in">UICollectionView</span> *)collectionView cellForItemAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath &#123;</span><br><span class="line">    <span class="type">id</span>&lt;IGListAdapterPerformanceDelegate&gt; performanceDelegate = <span class="keyword">self</span>.performanceDelegate;</span><br><span class="line">    [performanceDelegate listAdapterWillCallDequeueCell:<span class="keyword">self</span>];</span><br><span class="line">    IGListSectionController *sectionController = [<span class="keyword">self</span> sectionControllerForSection:indexPath.section];</span><br><span class="line">    <span class="comment">// flag that a cell is being dequeued in case it tries to access a cell in the process</span></span><br><span class="line">    _isDequeuingCell = <span class="literal">YES</span>;</span><br><span class="line">    <span class="built_in">UICollectionViewCell</span> *cell = [sectionController cellForItemAtIndex:indexPath.item];</span><br><span class="line">    _isDequeuingCell = <span class="literal">NO</span>;</span><br><span class="line">    IGAssert(cell != <span class="literal">nil</span>, <span class="string">@&quot;Returned a nil cell at indexPath &lt;%@&gt; from section controller: &lt;%@&gt;&quot;</span>, indexPath, sectionController);</span><br><span class="line">    <span class="comment">// associate the section controller with the cell so that we know which section controller is using it</span></span><br><span class="line">    [<span class="keyword">self</span> mapView:cell toSectionController:sectionController];</span><br><span class="line">    [performanceDelegate listAdapter:<span class="keyword">self</span> didCallDequeueCell:cell onSectionController:sectionController atIndex:indexPath.item];</span><br><span class="line">    <span class="keyword">return</span> cell;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™äº›æ–¹æ³•å¤§è‡´æ€è·¯æ˜¯é€šè¿‡indexPathè·å–åˆ°å¯¹åº”çš„SessionControllerç„¶åå†é€šè¿‡SessionControllerä¸­çš„æ–¹æ³•è·å–å¯¹åº”çš„æ•°æ®ã€‚</p>
<p><strong><strong>æ‰¹é‡æ›´æ–°UICollectionViewæ•°æ®</strong></strong></p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)performUpdatesAnimated:(<span class="type">BOOL</span>)animated completion:(IGListUpdaterCompletion)completion &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//.......</span></span><br><span class="line">    <span class="type">id</span>&lt;IGListAdapterDataSource&gt; dataSource = <span class="keyword">self</span>.dataSource;</span><br><span class="line">    <span class="built_in">UICollectionView</span> *collectionView = <span class="keyword">self</span>.collectionView;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="comment">//æ—§çš„æ•°æ®æº</span></span><br><span class="line">    <span class="built_in">NSArray</span> *fromObjects = <span class="keyword">self</span>.sectionMap.objects;</span><br><span class="line"></span><br><span class="line">    IGListToObjectBlock toObjectsBlock;</span><br><span class="line">    __<span class="keyword">weak</span> __typeof__(<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>;</span><br><span class="line">    <span class="keyword">if</span> (IGListExperimentEnabled(<span class="keyword">self</span>.experiments, IGListExperimentDeferredToObjectCreation)) &#123;</span><br><span class="line">        toObjectsBlock = ^<span class="built_in">NSArray</span> *&#123;</span><br><span class="line">            __typeof__(<span class="keyword">self</span>) strongSelf = weakSelf;</span><br><span class="line">            <span class="keyword">if</span> (strongSelf == <span class="literal">nil</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> [dataSource objectsForListAdapter:strongSelf];</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//ä»dataSourceä¸­è·å–æœ€æ–°çš„æ•°æ®æº</span></span><br><span class="line">        <span class="built_in">NSArray</span> *newObjects = [dataSource objectsForListAdapter:<span class="keyword">self</span>];</span><br><span class="line">        toObjectsBlock = ^<span class="built_in">NSArray</span> *&#123;</span><br><span class="line">            <span class="keyword">return</span> newObjects;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span> _enterBatchUpdates];</span><br><span class="line">    [<span class="keyword">self</span>.updater performUpdateWithCollectionViewBlock:[<span class="keyword">self</span> _collectionViewBlock]</span><br><span class="line">                                           fromObjects:fromObjects</span><br><span class="line">                                        toObjectsBlock:toObjectsBlock</span><br><span class="line">                                              animated:animated</span><br><span class="line">                                 objectTransitionBlock:^(<span class="built_in">NSArray</span> *toObjects) &#123;</span><br><span class="line">                                     <span class="comment">// æ›´æ–°æ•°æ®æº</span></span><br><span class="line">                                     weakSelf.previousSectionMap = [weakSelf.sectionMap <span class="keyword">copy</span>];</span><br><span class="line">                                     [weakSelf _updateObjects:toObjects dataSource:dataSource];</span><br><span class="line">                                 &#125; completion:^(<span class="type">BOOL</span> finished) &#123;</span><br><span class="line">                                     weakSelf.previousSectionMap = <span class="literal">nil</span>;</span><br><span class="line">                                     [weakSelf _notifyDidUpdate:IGListAdapterUpdateTypePerformUpdates animated:animated];</span><br><span class="line">                                     <span class="keyword">if</span> (completion) &#123;</span><br><span class="line">                                         completion(finished);</span><br><span class="line">                                     &#125;</span><br><span class="line">                                     [weakSelf _exitBatchUpdates];</span><br><span class="line">                                 &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight pf"><table><tr><td class="code"><pre><span class="line">- (void)performUpdateWithCollectionViewBlock:(IGListCollectionViewBlock)collectionViewBlock</span><br><span class="line">                            <span class="keyword">from</span>Objects:(NSArray *)<span class="keyword">from</span>Objects</span><br><span class="line">                         <span class="keyword">to</span>ObjectsBlock:(IGListToObjectBlock)<span class="keyword">to</span>ObjectsBlock</span><br><span class="line">                               animated:(BOOL)animated</span><br><span class="line">                  objectTransitionBlock:(IGListObjectTransitionBlock)objectTransitionBlock</span><br><span class="line">                             completion:(IGListUpdatingCompletion)completion &#123;</span><br><span class="line">    </span><br><span class="line">    //........</span><br><span class="line">    <span class="literal">self</span>.<span class="keyword">from</span>Objects = <span class="literal">self</span>.<span class="keyword">from</span>Objects ?: <span class="literal">self</span>.pendingTransitionToObjects ?: <span class="keyword">from</span>Objects;</span><br><span class="line">    <span class="literal">self</span>.<span class="keyword">to</span>ObjectsBlock = <span class="keyword">to</span>ObjectsBlock;</span><br><span class="line"></span><br><span class="line">    <span class="literal">self</span>.queuedUpdateIsAnimated = <span class="literal">self</span>.queuedUpdateIsAnimated &amp;&amp; animated;</span><br><span class="line">    <span class="literal">self</span>.objectTransitionBlock = objectTransitionBlock;</span><br><span class="line"></span><br><span class="line">    IGListUpdatingCompletion localCompletion = completion;</span><br><span class="line">    if (localCompletion) &#123;</span><br><span class="line">        [<span class="literal">self</span>.completionBlocks addObject:localCompletion];</span><br><span class="line">    &#125;</span><br><span class="line">    [<span class="literal">self</span> _queueUpdateWithCollectionViewBlock:collectionViewBlock];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)_queueUpdateWithCollectionViewBlock:(IGListCollectionViewBlock)collectionViewBlock &#123;</span><br><span class="line">    __weak __typeof__(<span class="literal">self</span>) weakSelf = <span class="literal">self</span>;</span><br><span class="line">    dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        if (weakSelf.<span class="keyword">state</span> != IGListBatchUpdateStateIdle</span><br><span class="line">            || ![weakSelf hasChanges]) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        if (weakSelf.hasQueuedReloadData) &#123;</span><br><span class="line">            [weakSelf performReloadDataWithCollectionViewBlock:collectionViewBlock];</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //æ›´æ–°çš„æ—¶å€™èµ°è¿™é‡Œ</span><br><span class="line">            [weakSelf performBatchUpdatesWithCollectionViewBlock:collectionViewBlock];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)performBatchUpdatesWithCollectionViewBlock:(IGListCollectionViewBlock)collectionViewBlock &#123;</span><br><span class="line">    <span class="comment">//........</span></span><br><span class="line">    <span class="comment">// create local variables so we can immediately clean our state but pass these items into the batch update block</span></span><br><span class="line">    <span class="type">id</span>&lt;IGListAdapterUpdaterDelegate&gt; delegate = <span class="keyword">self</span>.delegate;</span><br><span class="line">    <span class="built_in">NSArray</span> *fromObjects = [<span class="keyword">self</span>.fromObjects <span class="keyword">copy</span>];</span><br><span class="line">    IGListToObjectBlock toObjectsBlock = [<span class="keyword">self</span>.toObjectsBlock <span class="keyword">copy</span>];</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *completionBlocks = [<span class="keyword">self</span>.completionBlocks mutableCopy];</span><br><span class="line">    <span class="type">void</span> (^objectTransitionBlock)(<span class="built_in">NSArray</span> *) = [<span class="keyword">self</span>.objectTransitionBlock <span class="keyword">copy</span>];</span><br><span class="line">    <span class="keyword">const</span> <span class="type">BOOL</span> animated = <span class="keyword">self</span>.queuedUpdateIsAnimated;</span><br><span class="line">    IGListBatchUpdates *batchUpdates = <span class="keyword">self</span>.batchUpdates;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨æ›´æ–°å‰é‡ç½®çŠ¶æ€ä¸ºåˆå§‹çŠ¶æ€</span></span><br><span class="line">    <span class="comment">// clean up all state so that new updates can be coalesced while the current update is in flight</span></span><br><span class="line">    [<span class="keyword">self</span> cleanStateBeforeUpdates];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ›´æ–°å®Œæˆä¹‹åçš„å›è°ƒ</span></span><br><span class="line">    <span class="type">void</span> (^executeCompletionBlocks)(<span class="type">BOOL</span>) = ^(<span class="type">BOOL</span> finished) &#123;</span><br><span class="line">        <span class="keyword">self</span>.applyingUpdateData = <span class="literal">nil</span>;</span><br><span class="line">        <span class="keyword">self</span>.state = IGListBatchUpdateStateIdle;</span><br><span class="line">        <span class="keyword">for</span> (IGListUpdatingCompletion block <span class="keyword">in</span> completionBlocks) &#123;</span><br><span class="line">            block(finished);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//.......</span></span><br><span class="line">    <span class="built_in">NSArray</span> *toObjects = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">if</span> (toObjectsBlock != <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="comment">//å‰”é™¤æ‰é‡å¤æ•°æ®</span></span><br><span class="line">        toObjects = objectsWithDuplicateIdentifiersRemoved(toObjectsBlock());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ•°æ®åˆ·æ–°çš„é—­åŒ…</span></span><br><span class="line">    <span class="type">void</span> (^executeUpdateBlocks)(<span class="type">void</span>) = ^&#123;</span><br><span class="line">        <span class="keyword">self</span>.state = IGListBatchUpdateStateExecutingBatchUpdateBlock;</span><br><span class="line">        <span class="comment">// æ›´æ–°åŒ…æ‹¬ IGListAdapter çš„ sectionController å’Œ objects çš„æ˜ å°„å…³ç³»ç­‰æ•°æ®ï¼Œä¿è¯æ‰§è¡Œåˆ·æ–°å‰æ•°æ®å·²ç»æ˜¯æœ€æ–°çš„</span></span><br><span class="line">        <span class="keyword">if</span> (objectTransitionBlock != <span class="literal">nil</span>) &#123;</span><br><span class="line">            objectTransitionBlock(toObjects);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è§¦å‘æ‰¹é‡åˆ·æ–°ä»»åŠ¡çš„æ•°æ®æ›´æ–°é—­åŒ…ï¼ˆåŒ…æ‹¬æ’å…¥ã€åˆ é™¤ã€åˆ·æ–°å•ä¸ª section çš„æ•°æ®ï¼‰objectTransitionBlock ä¹‹åæ‰§è¡Œæ˜¯ä¸ºäº†ä¿è¯ section çº§åˆ«çš„åˆ·æ–°åœ¨ item çº§åˆ«åˆ·æ–°ä¹‹å‰è¿›è¡Œ</span></span><br><span class="line">        <span class="keyword">for</span> (IGListItemUpdateBlock itemUpdateBlock <span class="keyword">in</span> batchUpdates.itemUpdateBlocks) &#123;</span><br><span class="line">            itemUpdateBlock();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ”¶é›†æ‰¹é‡åˆ·æ–°å®Œæˆçš„å›è°ƒï¼Œåç»­æ‰€æœ‰æ“ä½œå®Œäº†ä¹‹åä¸€å¹¶å¤„ç†</span></span><br><span class="line">        [completionBlocks addObjectsFromArray:batchUpdates.itemCompletionBlocks];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.state = IGListBatchUpdateStateExecutedBatchUpdateBlock;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰§è¡Œå…¨é‡çš„æ•°æ®æ›´æ–°å¹¶åˆ·æ–° UI</span></span><br><span class="line">    <span class="type">void</span> (^reloadDataFallback)(<span class="type">void</span>) = ^&#123;</span><br><span class="line">        <span class="comment">//æ‰§è¡Œæ›´æ–°</span></span><br><span class="line">        executeUpdateBlocks();</span><br><span class="line">        <span class="comment">//æ¸…é™¤batchUpdates</span></span><br><span class="line">        [<span class="keyword">self</span> _cleanStateAfterUpdates];</span><br><span class="line">        [<span class="keyword">self</span> _performBatchUpdatesItemBlockApplied];</span><br><span class="line">        <span class="comment">//åŠ è½½æ•°æ®</span></span><br><span class="line">        [collectionView reloadData];</span><br><span class="line">        [collectionView layoutIfNeeded];</span><br><span class="line">        executeCompletionBlocks(<span class="literal">YES</span>);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.allowsBackgroundReloading &amp;&amp; collectionView.window == <span class="literal">nil</span>) &#123;</span><br><span class="line">        [<span class="keyword">self</span> _beginPerformBatchUpdatesToObjects:toObjects];</span><br><span class="line">        reloadDataFallback();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// disables multiple performBatchUpdates: from happening at the same time</span></span><br><span class="line">    [<span class="keyword">self</span> _beginPerformBatchUpdatesToObjects:toObjects];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> IGListExperiment experiments = <span class="keyword">self</span>.experiments;</span><br><span class="line"></span><br><span class="line">    IGListIndexSetResult *(^performDiff)(<span class="type">void</span>) = ^&#123;</span><br><span class="line">        <span class="keyword">return</span> IGListDiffExperiment(fromObjects, toObjects, IGListDiffEquality, experiments);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// block executed in the first param block of -[UICollectionView performBatchUpdates:completion:]</span></span><br><span class="line">    <span class="type">void</span> (^batchUpdatesBlock)(IGListIndexSetResult *result) = ^(IGListIndexSetResult *result)&#123;</span><br><span class="line">        <span class="comment">//æ‰§è¡Œæ›´æ–°</span></span><br><span class="line">        executeUpdateBlocks();</span><br><span class="line">        <span class="keyword">self</span>.applyingUpdateData = [<span class="keyword">self</span> _flushCollectionView:collectionView</span><br><span class="line">                                              withDiffResult:result</span><br><span class="line">                                                batchUpdates:<span class="keyword">self</span>.batchUpdates</span><br><span class="line">                                                 fromObjects:fromObjects];</span><br><span class="line">        <span class="comment">//é‡ç½®çŠ¶æ€</span></span><br><span class="line">        [<span class="keyword">self</span> _cleanStateAfterUpdates];</span><br><span class="line">        [<span class="keyword">self</span> _performBatchUpdatesItemBlockApplied];</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// block used as the second param of -[UICollectionView performBatchUpdates:completion:]</span></span><br><span class="line">    <span class="type">void</span> (^batchUpdatesCompletionBlock)(<span class="type">BOOL</span>) = ^(<span class="type">BOOL</span> finished) &#123;</span><br><span class="line">        IGListBatchUpdateData *oldApplyingUpdateData = <span class="keyword">self</span>.applyingUpdateData;</span><br><span class="line">        executeCompletionBlocks(finished);</span><br><span class="line"></span><br><span class="line">        [delegate listAdapterUpdater:<span class="keyword">self</span> didPerformBatchUpdates:oldApplyingUpdateData collectionView:collectionView];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// queue another update in case something changed during batch updates. this method will bail next runloop if</span></span><br><span class="line">        <span class="comment">// there are no changes</span></span><br><span class="line">        [<span class="keyword">self</span> _queueUpdateWithCollectionViewBlock:collectionViewBlock];</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// block that executes the batch update and exception handling</span></span><br><span class="line">    <span class="type">void</span> (^performUpdate)(IGListIndexSetResult *) = ^(IGListIndexSetResult *result)&#123;</span><br><span class="line">        [collectionView layoutIfNeeded];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">@try</span> &#123;</span><br><span class="line">            <span class="comment">// å¯¹å¤–é€šçŸ¥å³å°†è¿›è¡Œ batch update</span></span><br><span class="line">            [delegate  listAdapterUpdater:<span class="keyword">self</span></span><br><span class="line">willPerformBatchUpdatesWithCollectionView:collectionView</span><br><span class="line">                              fromObjects:fromObjects</span><br><span class="line">                                toObjects:toObjects</span><br><span class="line">                       listIndexSetResult:result];</span><br><span class="line">            <span class="keyword">if</span> (collectionView.dataSource == <span class="literal">nil</span>) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœæ•°æ®æºä¸ºç©ºåˆ™ä¸å†åˆ·æ–°çš„ UICollectionview</span></span><br><span class="line">                batchUpdatesCompletionBlock(<span class="literal">NO</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result.changeCount &gt; <span class="number">100</span> &amp;&amp; IGListExperimentEnabled(experiments, IGListExperimentReloadDataFallback)) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœå˜åŒ–æ•°é‡è¶…è¿‡100ï¼Œè¿›è¡Œå…¨é‡åˆ·æ–°</span></span><br><span class="line">                reloadDataFallback();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (animated) &#123;</span><br><span class="line">                <span class="comment">//æ‰§è¡Œæ›´æ–°çš„æ‰¹é‡åŠ¨ç”»</span></span><br><span class="line">                [collectionView performBatchUpdates:^&#123;</span><br><span class="line">                    batchUpdatesBlock(result);</span><br><span class="line">                &#125; completion:batchUpdatesCompletionBlock];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                [<span class="built_in">CATransaction</span> begin];</span><br><span class="line">                [<span class="built_in">CATransaction</span> setDisableActions:<span class="literal">YES</span>];</span><br><span class="line">                [collectionView performBatchUpdates:^&#123;</span><br><span class="line">                    batchUpdatesBlock(result);</span><br><span class="line">                &#125; completion:^(<span class="type">BOOL</span> finished) &#123;</span><br><span class="line">                    [<span class="built_in">CATransaction</span> commit];</span><br><span class="line">                    batchUpdatesCompletionBlock(finished);</span><br><span class="line">                &#125;];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">@catch</span> (<span class="built_in">NSException</span> *exception) &#123;</span><br><span class="line">            [delegate listAdapterUpdater:<span class="keyword">self</span></span><br><span class="line">                          collectionView:collectionView</span><br><span class="line">                  willCrashWithException:exception</span><br><span class="line">                             fromObjects:fromObjects</span><br><span class="line">                               toObjects:toObjects</span><br><span class="line">                              diffResult:result</span><br><span class="line">                                 updates:(<span class="type">id</span>)<span class="keyword">self</span>.applyingUpdateData];</span><br><span class="line">            <span class="keyword">@throw</span> exception;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (IGListExperimentEnabled(experiments, IGListExperimentBackgroundDiffing)) &#123;</span><br><span class="line">        <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(QOS_CLASS_USER_INITIATED, <span class="number">0</span>), ^&#123;</span><br><span class="line">            IGListIndexSetResult *result = performDiff();</span><br><span class="line">            <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                performUpdate(result);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        IGListIndexSetResult *result = performDiff();</span><br><span class="line">        performUpdate(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰¹é‡æ›´æ–°è¿™éƒ¨åˆ†ç»†èŠ‚æœ‰ç‚¹å¤šï¼Œè¿™é‡Œå½’çº³å¦‚ä¸‹ï¼š</p>
<p>å¦‚æœallowsBackgroundReloadingä¸ºYES,ä¹Ÿå°±æ˜¯è¯´å…è®¸åå°åŠ è½½æ•°æ®çš„æƒ…å†µä¸‹å¦‚æœcollectionViewä¸æ˜¾ç¤ºï¼Œåˆ™è·³è¿‡æ•°æ®diffå’Œæ‰¹é‡æ›´æ–°ç›´æ¥è¿›è¡Œå…¨é‡åŠ è½½åˆ·æ–°ã€‚å¦åˆ™åœ¨å­çº¿ç¨‹è°ƒç”¨performDiff() é€šè¿‡ IGListDiffExperiment è®¡ç®—æ•°æ®çš„å˜åŒ–ï¼Œç„¶ååœ¨ä¸»çº¿ç¨‹è°ƒç”¨performUpdateè¿›è¡Œæ‰¹é‡æ›´æ–°æ“ä½œï¼š<br>åœ¨performUpdateå¼€å§‹çš„æ—¶å€™å…ˆé€šè¿‡ä»£ç†å¯¹å¤–é€šçŸ¥å³å°†è¿›è¡Œ batch update æ‰¹é‡æ›´æ–°ï¼Œç´§æ¥ç€åˆ¤æ–­å¦‚æœ collectionView çš„ dataSource ä¸º nilï¼Œç»“æŸæ›´æ–°è¿‡ç¨‹ï¼Œå¦‚æœå˜åŒ–çš„æ•°æ®ä¸ªæ•°è¶…è¿‡100ï¼Œå°±ä¸è¿›è¡Œæ‰¹é‡æ›´æ–°äº†ç›´æ¥è°ƒç”¨ reloadData å…¨é‡åˆ·æ–°æ•°æ®ï¼›å¦‚æœå˜åŒ–æ•°æ®å°äº100ï¼Œåˆ™è°ƒç”¨ <strong><strong>-[UICollectionView performBatchUpdates:completion:]</strong></strong> æ‰¹é‡åˆ·æ–°æ•°æ®ï¼Œåˆ·æ–°è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨ <strong><strong>-_flushCollectionView:withDiffResult:batchUpdates:fromObjects:</strong></strong> å°†æ•°æ®æºæä¾›çš„æ•°æ®å’Œ diff ç»“æœåŒ…è£…æˆæ‰¹é‡æ›´æ–°çš„æ•°æ®ç±»å‹ IGListBatchUpdateData ä»¥ä¾¿ UICollectionView è¿›è¡Œè¯»å–ã€‚è¿™é‡Œæœ€å…³é”®çš„ä»£ç åœ¨****_flushCollectionView****</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="operator">-</span> (<span class="type">IGListBatchUpdateData</span> <span class="operator">*</span>)_flushCollectionView:(<span class="type">UICollectionView</span> <span class="operator">*</span>)collectionView</span><br><span class="line">                                withDiffResult:(<span class="type">IGListIndexSetResult</span> <span class="operator">*</span>)diffResult</span><br><span class="line">                                  batchUpdates:(<span class="type">IGListBatchUpdates</span> <span class="operator">*</span>)batchUpdates</span><br><span class="line">                                   fromObjects:(<span class="type">NSArray</span> <span class="operator">&lt;</span>id<span class="operator">&lt;</span><span class="type">IGListDiffable</span><span class="operator">&gt;&gt;</span> <span class="operator">*</span>)fromObjects &#123;</span><br><span class="line">    <span class="comment">//ç§»åŠ¨session</span></span><br><span class="line">    <span class="type">NSSet</span> <span class="operator">*</span>moves <span class="operator">=</span> [[<span class="type">NSSet</span> alloc] initWithArray:diffResult.moves];</span><br><span class="line">    <span class="comment">//reloadçš„itemï¼šåˆå¹¶é€šè¿‡diffå’Œé€šè¿‡reloadItemsæ‰‹åŠ¨reloadsçš„session</span></span><br><span class="line">    <span class="type">NSMutableIndexSet</span> <span class="operator">*</span>reloads <span class="operator">=</span> [diffResult.updates mutableCopy];</span><br><span class="line">    [reloads addIndexes:batchUpdates.sectionReloads];</span><br><span class="line">    <span class="comment">//æ’å…¥çš„session</span></span><br><span class="line">    <span class="type">NSMutableIndexSet</span> <span class="operator">*</span>inserts <span class="operator">=</span> [diffResult.inserts mutableCopy];</span><br><span class="line">    <span class="comment">//åˆ é™¤çš„session</span></span><br><span class="line">    <span class="type">NSMutableIndexSet</span> <span class="operator">*</span>deletes <span class="operator">=</span> [diffResult.deletes mutableCopy];</span><br><span class="line">    <span class="type">NSMutableArray</span>&lt;<span class="type">NSIndexPath</span> *&gt; <span class="operator">*</span>itemUpdates <span class="operator">=</span> [<span class="type">NSMutableArray</span> new];</span><br><span class="line">    <span class="comment">//å¦‚æœmovesAsDeletesInserts = YES é‚£ä¹ˆå°±å°†movesä¸­çš„è½¬æ¢ä¸ºdeleteså’Œinsertsæ“ä½œ</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.movesAsDeletesInserts) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">IGListMoveIndex</span> <span class="operator">*</span>move <span class="keyword">in</span> moves) &#123;</span><br><span class="line">            [deletes addIndex:move.from];</span><br><span class="line">            [inserts addIndex:move.to];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// clear out all moves</span></span><br><span class="line">        moves <span class="operator">=</span> [<span class="type">NSSet</span> new];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Item reloads are not safe, if any section moves happened or there are inserts/deletes.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.preferItemReloadsForSectionReloads</span><br><span class="line">        <span class="operator">&amp;&amp;</span> moves.count <span class="operator">==</span> <span class="number">0</span> <span class="operator">&amp;&amp;</span> inserts.count <span class="operator">==</span> <span class="number">0</span> <span class="operator">&amp;&amp;</span> deletes.count <span class="operator">==</span> <span class="number">0</span> <span class="operator">&amp;&amp;</span> reloads.count <span class="operator">&gt;</span> <span class="number">0</span>) &#123;</span><br><span class="line">        [reloads enumerateIndexesUsingBlock:<span class="operator">^</span>(<span class="type">NSUInteger</span> sectionIndex, <span class="type">BOOL</span> <span class="operator">*</span> _Nonnull stop) &#123;</span><br><span class="line">            <span class="type">NSMutableIndexSet</span> <span class="operator">*</span>localIndexSet <span class="operator">=</span> [<span class="type">NSMutableIndexSet</span> indexSetWithIndex:sectionIndex];</span><br><span class="line">            <span class="keyword">if</span> (sectionIndex <span class="operator">&lt;</span> [collectionView numberOfSections]</span><br><span class="line">                <span class="operator">&amp;&amp;</span> sectionIndex <span class="operator">&lt;</span> [collectionView.dataSource numberOfSectionsInCollectionView:collectionView]</span><br><span class="line">                <span class="operator">&amp;&amp;</span> [collectionView numberOfItemsInSection:sectionIndex] <span class="operator">==</span> [collectionView.dataSource collectionView:collectionView numberOfItemsInSection:sectionIndex]) &#123;</span><br><span class="line">                <span class="comment">// Perfer to do item reloads instead, if the number of items in section is unchanged.</span></span><br><span class="line">                [itemUpdates addObjectsFromArray:convertSectionReloadToItemUpdates(localIndexSet, collectionView)];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Otherwise, fallback to convert into delete+insert section operation.</span></span><br><span class="line">                convertReloadToDeleteInsert(localIndexSet, deletes, inserts, diffResult, fromObjects);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// åœ¨performBatchUpdatesä¸­ä½¿ç”¨reloadSectionsæ˜¯ä¸å®‰å…¨çš„ï¼Œæ‰€ä»¥éœ€è¦å°†reloadsè½¬æ¢ä¸ºdeletes+inserts</span></span><br><span class="line">        convertReloadToDeleteInsert(reloads, deletes, inserts, diffResult, fromObjects);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ’å…¥ï¼Œåˆ é™¤ï¼Œç§»åŠ¨ itemå¤„ç†</span></span><br><span class="line">    <span class="type">NSMutableArray</span>&lt;<span class="type">NSIndexPath</span> *&gt; <span class="operator">*</span>itemInserts <span class="operator">=</span> batchUpdates.itemInserts;</span><br><span class="line">    <span class="type">NSMutableArray</span>&lt;<span class="type">NSIndexPath</span> *&gt; <span class="operator">*</span>itemDeletes <span class="operator">=</span> batchUpdates.itemDeletes;</span><br><span class="line">    <span class="type">NSMutableArray</span>&lt;<span class="type">IGListMoveIndexPath</span> *&gt; <span class="operator">*</span>itemMoves <span class="operator">=</span> batchUpdates.itemMoves;</span><br><span class="line"></span><br><span class="line">    <span class="type">NSSet</span>&lt;<span class="type">NSIndexPath</span> *&gt; <span class="operator">*</span>uniqueDeletes <span class="operator">=</span> [<span class="type">NSSet</span> setWithArray:itemDeletes];</span><br><span class="line">    <span class="type">NSMutableSet</span>&lt;<span class="type">NSIndexPath</span> *&gt; <span class="operator">*</span>reloadDeletePaths <span class="operator">=</span> [<span class="type">NSMutableSet</span> new];</span><br><span class="line">    <span class="type">NSMutableSet</span>&lt;<span class="type">NSIndexPath</span> *&gt; <span class="operator">*</span>reloadInsertPaths <span class="operator">=</span> [<span class="type">NSMutableSet</span> new];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">IGListReloadIndexPath</span> <span class="operator">*</span>reload <span class="keyword">in</span> batchUpdates.itemReloads) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="operator">!</span>[uniqueDeletes containsObject:reload.fromIndexPath]) &#123;</span><br><span class="line">            [reloadDeletePaths addObject:reload.fromIndexPath];</span><br><span class="line">            [reloadInsertPaths addObject:reload.toIndexPath];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    [itemDeletes addObjectsFromArray:[reloadDeletePaths allObjects]];</span><br><span class="line">    [itemInserts addObjectsFromArray:[reloadInsertPaths allObjects]];</span><br><span class="line"></span><br><span class="line">    const <span class="type">BOOL</span> fixIndexPathImbalance <span class="operator">=</span> <span class="type">IGListExperimentEnabled</span>(<span class="keyword">self</span>.experiments, <span class="type">IGListExperimentFixIndexPathImbalance</span>);</span><br><span class="line">    <span class="type">IGListBatchUpdateData</span> <span class="operator">*</span>updateData <span class="operator">=</span> [[<span class="type">IGListBatchUpdateData</span> alloc] initWithInsertSections:inserts</span><br><span class="line">                                                                               deleteSections:deletes</span><br><span class="line">                                                                                 moveSections:moves</span><br><span class="line">                                                                             insertIndexPaths:itemInserts</span><br><span class="line">                                                                             deleteIndexPaths:itemDeletes</span><br><span class="line">                                                                             updateIndexPaths:itemUpdates</span><br><span class="line">                                                                               moveIndexPaths:itemMoves</span><br><span class="line">                                                                        fixIndexPathImbalance:fixIndexPathImbalance];</span><br><span class="line">    [collectionView ig_applyBatchUpdateData:updateData];</span><br><span class="line">    <span class="keyword">return</span> updateData;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="operator">-</span> (void)ig_applyBatchUpdateData:(<span class="type">IGListBatchUpdateData</span> <span class="operator">*</span>)updateData &#123;    </span><br><span class="line">    [<span class="keyword">self</span> deleteItemsAtIndexPaths:updateData.deleteIndexPaths];</span><br><span class="line">    [<span class="keyword">self</span> insertItemsAtIndexPaths:updateData.insertIndexPaths];</span><br><span class="line">    [<span class="keyword">self</span> reloadItemsAtIndexPaths:updateData.updateIndexPaths];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">IGListMoveIndexPath</span> <span class="operator">*</span>move <span class="keyword">in</span> updateData.moveIndexPaths) &#123;</span><br><span class="line">        [<span class="keyword">self</span> moveItemAtIndexPath:move.from toIndexPath:move.to];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">IGListMoveIndex</span> <span class="operator">*</span>move <span class="keyword">in</span> updateData.moveSections) &#123;</span><br><span class="line">        [<span class="keyword">self</span> moveSection:move.from toSection:move.to];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span> deleteSections:updateData.deleteSections];</span><br><span class="line">    [<span class="keyword">self</span> insertSections:updateData.insertSections];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>åœ¨_flushCollectionViewä¸­ä¼šå¯¹æ‰‹åŠ¨æ·»åŠ çš„æ‰¹é‡æ“ä½œå’Œé€šè¿‡diffç®—æ³•ç¡®å®šçš„æ›´æ–°æ“ä½œç»Ÿä¸€è½¬æ¢ä¸ºå¯¹sessionçš„insert,delete,reloadçš„æ“ä½œï¼Œæœ€åè°ƒç”¨UICollectionViewçš„<strong><strong>deleteItemsAtIndexPaths</strong></strong>ï¼Œ<strong><strong>insertItemsAtIndexPaths</strong></strong>ï¼Œ<strong><strong>reloadItemsAtIndexPaths</strong></strong>ï¼Œ<strong><strong>moveItemAtIndexPath</strong></strong>ï¼Œ<strong><strong>moveSection</strong></strong>ï¼Œ<strong><strong>deleteSections</strong></strong>ï¼Œ<strong><strong>insertSections</strong></strong>ã€‚å¯¹UICollectionViewè¿›è¡Œæ›´æ–°ã€‚</p>
<p><strong><strong>IGListSectionController</strong></strong></p>
<p>IGListSectionController åœ¨IGListKitä¸­ä¹Ÿæ˜¯ä¸€ä¸ªååˆ†å…³é”®çš„å¯¹è±¡ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹å®ƒæ‹¥æœ‰çš„å±æ€§ï¼š</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">IGListSectionController</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> Sessionä¸­çš„itemæ•°é‡</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">- (<span class="built_in">NSInteger</span>)numberOfItems;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> æŒ‡å®šindexä½ç½®ä¸Šçš„itemå°ºå¯¸</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="built_in">CGSize</span>)sizeForItemAtIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  è¿”å›æŒ‡å®šä½ç½®çš„Cellå¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (__kindof <span class="built_in">UICollectionViewCell</span> *)cellForItemAtIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  ä»å¤–ç•Œæ³¨å…¥è¯¥Sessionæ‰€æ‹¥æœ‰çš„æ•´ä¸ªå¯¹è±¡æ•°ç»„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="type">void</span>)didUpdateToObject:(<span class="type">id</span>)object;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)didSelectItemAtIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line">- (<span class="type">void</span>)didDeselectItemAtIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line">- (<span class="type">void</span>)didHighlightItemAtIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line">- (<span class="type">void</span>)didUnhighlightItemAtIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">- (<span class="type">BOOL</span>)canMoveItemAtIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line">- (<span class="type">void</span>)moveObjectFromIndex:(<span class="built_in">NSInteger</span>)sourceIndex toIndex:(<span class="built_in">NSInteger</span>)destinationIndex <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">9</span>_0);</span><br><span class="line">    </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> æŒæœ‰åˆ›å»ºè¯¥SessionControllerçš„Adapterçš„ViewController</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>, <span class="keyword">nullable</span>, <span class="keyword">readonly</span>) <span class="built_in">UIViewController</span> *viewController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> ä¸collectionView äº¤äº’çš„ä¸Šä¸‹æ–‡</span></span><br><span class="line"><span class="comment"> Use this property for accessing the collection size, dequeuing cells, reloading, inserting, deleting, etc.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>, <span class="keyword">nullable</span>, <span class="keyword">readonly</span>) <span class="type">id</span> &lt;IGListCollectionContext&gt; collectionContext;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> å½“å‰sessionControllerå¯¹åº”çš„session</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) <span class="built_in">NSInteger</span> section;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) <span class="type">BOOL</span> isFirstSection;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) <span class="type">BOOL</span> isLastSection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">UIEdgeInsets</span> inset;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">CGFloat</span> minimumLineSpacing;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">CGFloat</span> minimumInteritemSpacing;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>, <span class="keyword">nullable</span>) <span class="type">id</span> &lt;IGListSupplementaryViewSource&gt; supplementaryViewSource;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    section controller çš„æ˜¾ç¤ºäº‹ä»¶ä»£ç†</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>, <span class="keyword">nullable</span>) <span class="type">id</span> &lt;IGListDisplayDelegate&gt; displayDelegate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    section controller çš„working rangeäº‹ä»¶ä»£ç†</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>, <span class="keyword">nullable</span>) <span class="type">id</span> &lt;IGListWorkingRangeDelegate&gt; workingRangeDelegate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    section controller çš„æ»šåŠ¨äº‹ä»¶ä»£ç†</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>, <span class="keyword">nullable</span>) <span class="type">id</span> &lt;IGListScrollDelegate&gt; scrollDelegate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>, <span class="keyword">nullable</span>) <span class="type">id</span>&lt;IGListTransitionDelegate&gt; transitionDelegate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šé¢ä¸Šçœ‹å¤–éƒ¨ä¸»è¦é€šè¿‡didUpdateToObjectå°†æ•°æ®æ³¨å…¥åˆ°IGListSectionControllerï¼Œç„¶åé€šè¿‡<strong><strong>numberOfItems</strong></strong>ï¼Œ<strong><strong>sizeForItemAtIndex</strong></strong>ï¼Œ<strong><strong>cellForItemAtIndex</strong></strong>ï¼Œ<strong><strong>supplementaryViewSource</strong></strong> åˆ†åˆ«æŒ‡å®šitemæ•°é‡ï¼Œå°ºå¯¸ï¼Œcellå®ä¾‹ï¼ŒSessionControllerçš„headerï¼Œfooterã€‚ä»¥åŠé€šè¿‡collectionContextå’ŒUICollectionViewè¿›è¡Œäº¤äº’ï¼Œ</p>
<p>æˆ‘ä»¬æœ€åæ¥çœ‹ä¸‹IGListCollectionContextï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„ç±»ï¼Œæˆ‘ä»¬åœ¨ç¡®å®šsessionControllerçš„æ—¶å€™ç”¨å¾—æ¯”è¾ƒå¤šã€‚</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">IGListCollectionContext</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">CGSize</span> containerSize;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">UIEdgeInsets</span> containerInset;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">UIEdgeInsets</span> adjustedContainerInset;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">CGSize</span> insetContainerSize;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">CGSize</span>)containerSizeForSectionController:(IGListSectionController *)sectionController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) IGListCollectionScrollingTraits scrollingTraits;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) IGListExperiment experiments;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSInteger</span>)indexForCell:(<span class="built_in">UICollectionViewCell</span> *)cell</span><br><span class="line">        sectionController:(IGListSectionController *)sectionController;</span><br><span class="line">- (<span class="keyword">nullable</span> __kindof <span class="built_in">UICollectionViewCell</span> *)cellForItemAtIndex:(<span class="built_in">NSInteger</span>)index</span><br><span class="line">                                             sectionController:(IGListSectionController *)sectionController;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSArray</span>&lt;<span class="built_in">UICollectionViewCell</span> *&gt; *)visibleCellsForSectionController:(IGListSectionController *)sectionController;</span><br><span class="line">- (<span class="built_in">NSArray</span>&lt;<span class="built_in">NSIndexPath</span> *&gt; *)visibleIndexPathsForSectionController:(IGListSectionController *) sectionController;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)deselectItemAtIndex:(<span class="built_in">NSInteger</span>)index</span><br><span class="line">          sectionController:(IGListSectionController *)sectionController</span><br><span class="line">                   animated:(<span class="type">BOOL</span>)animated;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)selectItemAtIndex:(<span class="built_in">NSInteger</span>)index</span><br><span class="line">        sectionController:(IGListSectionController *)sectionController</span><br><span class="line">                 animated:(<span class="type">BOOL</span>)animated</span><br><span class="line">           scrollPosition:(<span class="built_in">UICollectionViewScrollPosition</span>)scrollPosition;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (__kindof <span class="built_in">UICollectionViewCell</span> *)dequeueReusableCellOfClass:(Class)cellClass</span><br><span class="line">                                          withReuseIdentifier:(<span class="keyword">nullable</span> <span class="built_in">NSString</span> *)reuseIdentifier</span><br><span class="line">                                         forSectionController:(IGListSectionController *)sectionController</span><br><span class="line">                                                      atIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line">- (__kindof <span class="built_in">UICollectionViewCell</span> *)dequeueReusableCellOfClass:(Class)cellClass</span><br><span class="line">                                         forSectionController:(IGListSectionController *)sectionController</span><br><span class="line">                                                      atIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line">- (__kindof <span class="built_in">UICollectionViewCell</span> *)dequeueReusableCellWithNibName:(<span class="built_in">NSString</span> *)nibName</span><br><span class="line">                                                           bundle:(<span class="keyword">nullable</span> <span class="built_in">NSBundle</span> *)bundle</span><br><span class="line">                                             forSectionController:(IGListSectionController *)sectionController</span><br><span class="line">                                                          atIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line">- (__kindof <span class="built_in">UICollectionViewCell</span> *)dequeueReusableCellFromStoryboardWithIdentifier:(<span class="built_in">NSString</span> *)identifier</span><br><span class="line">                                                              forSectionController:(IGListSectionController *)sectionController</span><br><span class="line">                                                                           atIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line">- (__kindof <span class="built_in">UICollectionReusableView</span> *)dequeueReusableSupplementaryViewOfKind:(<span class="built_in">NSString</span> *)elementKind</span><br><span class="line">                                                         forSectionController:(IGListSectionController *)sectionController</span><br><span class="line">                                                                        <span class="keyword">class</span>:(Class)viewClass</span><br><span class="line">                                                                      atIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line">- (__kindof <span class="built_in">UICollectionReusableView</span> *)dequeueReusableSupplementaryViewFromStoryboardOfKind:(<span class="built_in">NSString</span> *)elementKind</span><br><span class="line">                                                                             withIdentifier:(<span class="built_in">NSString</span> *)identifier</span><br><span class="line">                                                                       forSectionController:(IGListSectionController *)sectionController</span><br><span class="line">                                                                                    atIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line">- (__kindof <span class="built_in">UICollectionReusableView</span> *)dequeueReusableSupplementaryViewOfKind:(<span class="built_in">NSString</span> *)elementKind</span><br><span class="line">                                                         forSectionController:(IGListSectionController *)sectionController</span><br><span class="line">                                                                      nibName:(<span class="built_in">NSString</span> *)nibName</span><br><span class="line">                                                                       bundle:(<span class="keyword">nullable</span> <span class="built_in">NSBundle</span> *)bundle</span><br><span class="line">                                                                      atIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)invalidateLayoutForSectionController:(IGListSectionController *)sectionController</span><br><span class="line">                                  completion:(<span class="keyword">nullable</span> <span class="type">void</span> (^)(<span class="type">BOOL</span> finished))completion;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)performBatchAnimated:(<span class="type">BOOL</span>)animated</span><br><span class="line">                     updates:(<span class="type">void</span> (^)(<span class="type">id</span>&lt;IGListBatchContext&gt; batchContext))updates</span><br><span class="line">                  completion:(<span class="keyword">nullable</span> <span class="type">void</span> (^)(<span class="type">BOOL</span> finished))completion;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)scrollToSectionController:(IGListSectionController *)sectionController</span><br><span class="line">                          atIndex:(<span class="built_in">NSInteger</span>)index</span><br><span class="line">                   scrollPosition:(<span class="built_in">UICollectionViewScrollPosition</span>)scrollPosition</span><br><span class="line">                         animated:(<span class="type">BOOL</span>)animated;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h5 id="ç›¸å…³æ–‡ç« æ¨è"><a href="#ç›¸å…³æ–‡ç« æ¨è" class="headerlink" title="ç›¸å…³æ–‡ç« æ¨è"></a>ç›¸å…³æ–‡ç« æ¨è</h5><ul>
<li><a target="_blank" rel="noopener" href="https://chipengliu.github.io/2019/11/05/IGListKit/">IGListKit æºç è§£æ</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/5dc966bb6fb9a04a837ba7d7">IGListKit æºç è§£æ</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/entry/5bee4514e51d4556a633c6c9">iOS â€” å¿«é€Ÿä¸Šæ‰‹ Instagram&#x2F;IGListKit æ¡†æ¶</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/entry/59e075256fb9a044fb06c569">å¤§è§„æ¨¡é‡æ„â€”â€”é‡å†™ Instagram Feed çš„ç»éªŒä¹‹è°ˆ</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/entry/58650058128fe10069f8f92a">Instagram&#x2F;IGListKit å®è·µè°ˆ</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/entry/5c42fe08518825261c1b9808">IGListKitæ¡†æ¶è¯¦ç»†è§£æ</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/3517619085f7">IGListKitæ¡†æ¶è§£æ</a></li>
<li><a target="_blank" rel="noopener" href="https://xiangwangfeng.com/2017/03/16/IGListKit-diff-%E5%AE%9E%E7%8E%B0%E7%AE%80%E6%9E%90/">IGListKit diff å®ç°ç®€æ</a></li>
</ul>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/iOS-%E5%BC%80%E6%BA%90%E5%BA%93%E5%88%86%E6%9E%90/">iOS å¼€æºåº“åˆ†æ</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/iOS-å¼€æºåº“åˆ†æ/">iOS å¼€æºåº“åˆ†æ</a>
  </div>

</div>



</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2019/12/14/iOS-å¼€æºåº“æºç è§£æ-ç»„ä»¶åŒ–BeeHive/" title="iOS å¼€æºåº“æºç è§£æ- ç»„ä»¶åŒ–BeeHive">
  <span>
  iOS å¼€æºåº“æºç è§£æ- ç»„ä»¶åŒ–BeeHive</span>
</a>
</div>


<div class="next">
<a href="/2019/12/06/MJRefresh-ä½¿ç”¨åŠæºç åˆ†æ/"  title="MJRefresh ä½¿ç”¨åŠæºç åˆ†æ">
 <span>MJRefresh ä½¿ç”¨åŠæºç åˆ†æ
</span>
</a>
</div>

</nav>

	
<section id="comments" class="comment">
	<div class="ds-thread" data-thread-key="2019/12/08/IGKListKit-ä½¿ç”¨åŠæºç åˆ†æ/" data-title="IGKListKit ä½¿ç”¨åŠæºç åˆ†æ" data-url="http://yoursite.com/2019/12/08/IGKListKit-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"></div>
</section>


<section id="comments" class="comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
 
 <ol class="toc"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%80%E6%BA%90%E4%BF%A1%E6%81%AF"><span class="toc-number">1.</span> <span class="toc-text">å¼€æºä¿¡æ¯</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">æºç è§£æ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E6%96%87%E7%AB%A0%E6%8E%A8%E8%8D%90"><span class="toc-number">3.</span> <span class="toc-text">ç›¸å…³æ–‡ç« æ¨è</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">
<div id="authorInfo">
	
		<div class="author-img"></div>		
	
	<div class="social-info" class="clearfix">
		
		
		<a href="https://github.com/tbfungeek" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
		
		<a href="mailto:tbfungeek@163.com" target="_blank" class="icon-email" title="Email Me"></a>
		

	</div>
</div>

  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
		  
			<li><a href="/categories/Android-å°ç»éªŒ/" title="Android å°ç»éªŒ">Android å°ç»éªŒ<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android-æºç åˆ†æ/" title="Android æºç åˆ†æ">Android æºç åˆ†æ<sup>21</sup></a></li>
		  
		
		  
			<li><a href="/categories/Androidå…¶ä»–/" title="Androidå…¶ä»–">Androidå…¶ä»–<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Androidåˆæ­¥/" title="Androidåˆæ­¥">Androidåˆæ­¥<sup>21</sup></a></li>
		  
		
		  
			<li><a href="/categories/Androidè¿›é˜¶/" title="Androidè¿›é˜¶">Androidè¿›é˜¶<sup>100</sup></a></li>
		  
		
		  
			<li><a href="/categories/Hexo-ä½¿ç”¨/" title="Hexo ä½¿ç”¨">Hexo ä½¿ç”¨<sup>10</sup></a></li>
		  
		
		  
			<li><a href="/categories/JavaScriptç†è®º/" title="JavaScriptç†è®º">JavaScriptç†è®º<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Objective-C-ç›¸å…³/" title="Objective C ç›¸å…³">Objective C ç›¸å…³<sup>24</sup></a></li>
		  
		
		  
			<li><a href="/categories/OpenCV/" title="OpenCV">OpenCV<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/ROS/" title="ROS">ROS<sup>9</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-å·¥å…·ä½¿ç”¨/" title="iOS å·¥å…·ä½¿ç”¨">iOS å·¥å…·ä½¿ç”¨<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-å¼€æºåº“åˆ†æ/" title="iOS å¼€æºåº“åˆ†æ">iOS å¼€æºåº“åˆ†æ<sup>36</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-ç†è®ºåŸºç¡€/" title="iOS ç†è®ºåŸºç¡€">iOS ç†è®ºåŸºç¡€<sup>14</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-è¿›é˜¶/" title="iOS è¿›é˜¶">iOS è¿›é˜¶<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/ä¸ªäººæ”¶è—/" title="ä¸ªäººæ”¶è—">ä¸ªäººæ”¶è—<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/ä»£ç è§„èŒƒ/" title="ä»£ç è§„èŒƒ">ä»£ç è§„èŒƒ<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/å…¶ä»–/" title="å…¶ä»–">å…¶ä»–<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/åšå®¢åˆ†ç±»ç›®å½•/" title="åšå®¢åˆ†ç±»ç›®å½•">åšå®¢åˆ†ç±»ç›®å½•<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/å¨å¨ç³»åˆ—/" title="å¨å¨ç³»åˆ—">å¨å¨ç³»åˆ—<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/å¼€æºä»£ç åˆ†æ/" title="å¼€æºä»£ç åˆ†æ">å¼€æºä»£ç åˆ†æ<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/å¼€æºåº“åˆ†æ/" title="å¼€æºåº“åˆ†æ">å¼€æºåº“åˆ†æ<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/æ ‘è“æ´¾/" title="æ ‘è“æ´¾">æ ‘è“æ´¾<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/ç‰ˆæœ¬æ§åˆ¶/" title="ç‰ˆæœ¬æ§åˆ¶">ç‰ˆæœ¬æ§åˆ¶<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/ç›´æ’­/" title="ç›´æ’­">ç›´æ’­<sup>6</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/iOS-å¼€æºåº“åˆ†æ/" title="iOS å¼€æºåº“åˆ†æ">iOS å¼€æºåº“åˆ†æ<sup>36</sup></a></li>
			
		
			
				<li><a href="/tags/Android-è®¾è®¡æ¨¡å¼/" title="Android è®¾è®¡æ¨¡å¼">Android è®¾è®¡æ¨¡å¼<sup>29</sup></a></li>
			
		
			
				<li><a href="/tags/Objective-C-ç›¸å…³/" title="Objective C ç›¸å…³">Objective C ç›¸å…³<sup>24</sup></a></li>
			
		
			
				<li><a href="/tags/AndroidåŸºç¡€/" title="AndroidåŸºç¡€">AndroidåŸºç¡€<sup>21</sup></a></li>
			
		
			
				<li><a href="/tags/AOSP-æºç /" title="AOSP æºç ">AOSP æºç <sup>17</sup></a></li>
			
		
			
				<li><a href="/tags/Android-å¸¸ç”¨ç¬¬ä¸‰æ–¹åº“/" title="Android å¸¸ç”¨ç¬¬ä¸‰æ–¹åº“">Android å¸¸ç”¨ç¬¬ä¸‰æ–¹åº“<sup>15</sup></a></li>
			
		
			
				<li><a href="/tags/iOS-ç†è®ºåŸºç¡€/" title="iOS ç†è®ºåŸºç¡€">iOS ç†è®ºåŸºç¡€<sup>14</sup></a></li>
			
		
			
				<li><a href="/tags/Hexo-ä½¿ç”¨/" title="Hexo ä½¿ç”¨">Hexo ä½¿ç”¨<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/ROS/" title="ROS">ROS<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/Android-åŠ¨ç”»è¿›é˜¶/" title="Android åŠ¨ç”»è¿›é˜¶">Android åŠ¨ç”»è¿›é˜¶<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/Android-JNI/" title="Android JNI">Android JNI<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android-ç»˜å›¾è¿›é˜¶/" title="Android ç»˜å›¾è¿›é˜¶">Android ç»˜å›¾è¿›é˜¶<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Androidæ€§èƒ½ä¼˜åŒ–/" title="Androidæ€§èƒ½ä¼˜åŒ–">Androidæ€§èƒ½ä¼˜åŒ–<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android-è‡ªåŠ¨åŒ–æµ‹è¯•/" title="Android è‡ªåŠ¨åŒ–æµ‹è¯•">Android è‡ªåŠ¨åŒ–æµ‹è¯•<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/OpenCV/" title="OpenCV">OpenCV<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/ç›´æ’­/" title="ç›´æ’­">ç›´æ’­<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android-å¼€æºæºç /" title="Android å¼€æºæºç ">Android å¼€æºæºç <sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Android-è‡ªå®šä¹‰Viewè¿›é˜¶/" title="Android è‡ªå®šä¹‰Viewè¿›é˜¶">Android è‡ªå®šä¹‰Viewè¿›é˜¶<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/æ ‘è“æ´¾/" title="æ ‘è“æ´¾">æ ‘è“æ´¾<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/iOS-è¿›é˜¶/" title="iOS è¿›é˜¶">iOS è¿›é˜¶<sup>4</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="https://hexo.io" target="_blank" title="Hexo">Hexo</a>
            
          </li>
        
          <li>
            
            	<a href="https://pages.github.com/" target="_blank" title="GitHub">GitHub</a>
            
          </li>
        
          <li>
            
            	<a href="http://pf18.github.io/" target="_blank" title="PF18">PF18</a>
            
          </li>
        
          <li>
            
            	<a href="http://toutiao.io/" target="_blank" title="å¼€å‘è€…å¤´æ¡">å¼€å‘è€…å¤´æ¡</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.jcodecraeer.com/" target="_blank" title="æ³¡åœ¨ç½‘ä¸Šçš„æ—¥å­">æ³¡åœ¨ç½‘ä¸Šçš„æ—¥å­</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="atom.xml" target="_blank" title="rss">RSS</a>
</div>

  
  <div class="tagcloudlist">
    <p class="asidetitle">Tag Cloud</p>
    <div class="tagcloudlist clearfix">
       <a href="/tags/AOSP-%E6%BA%90%E7%A0%81/" style="font-size: 17.14px;">AOSP æºç </a> <a href="/tags/Android-APK-%E7%AD%BE%E5%90%8D/" style="font-size: 10px;">Android APK ç­¾å</a> <a href="/tags/Android-JNI/" style="font-size: 12.86px;">Android JNI</a> <a href="/tags/Android-%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E8%BF%9B%E9%98%B6/" style="font-size: 10.71px;">Android äº‹ä»¶å¤„ç†è¿›é˜¶</a> <a href="/tags/Android-%E5%8A%A8%E7%94%BB%E8%BF%9B%E9%98%B6/" style="font-size: 13.57px;">Android åŠ¨ç”»è¿›é˜¶</a> <a href="/tags/Android-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%BC%80%E5%8F%91/" style="font-size: 10px;">Android å¤šçº¿ç¨‹å¼€å‘</a> <a href="/tags/Android-%E5%B0%8F%E7%BB%8F%E9%AA%8C/" style="font-size: 10px;">Android å°ç»éªŒ</a> <a href="/tags/Android-%E5%B8%B8%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93/" style="font-size: 16.43px;">Android å¸¸ç”¨ç¬¬ä¸‰æ–¹åº“</a> <a href="/tags/Android-%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B/" style="font-size: 10px;">Android å¼€å‘æµç¨‹</a> <a href="/tags/Android-%E5%BC%80%E6%BA%90%E6%BA%90%E7%A0%81/" style="font-size: 12.14px;">Android å¼€æºæºç </a> <a href="/tags/Android-%E7%BB%98%E5%9B%BE%E8%BF%9B%E9%98%B6/" style="font-size: 12.86px;">Android ç»˜å›¾è¿›é˜¶</a> <a href="/tags/Android-%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/" style="font-size: 12.86px;">Android è‡ªåŠ¨åŒ–æµ‹è¯•</a> <a href="/tags/Android-%E8%87%AA%E5%AE%9A%E4%B9%89View%E8%BF%9B%E9%98%B6/" style="font-size: 12.14px;">Android è‡ªå®šä¹‰Viewè¿›é˜¶</a> <a href="/tags/Android-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 19.29px;">Android è®¾è®¡æ¨¡å¼</a> <a href="/tags/Android%E5%85%B6%E4%BB%96/" style="font-size: 10px;">Androidå…¶ä»–</a> <a href="/tags/Android%E5%9F%BA%E7%A1%80/" style="font-size: 17.86px;">AndroidåŸºç¡€</a> <a href="/tags/Android%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B/" style="font-size: 10px;">Androidå¼€å‘æµç¨‹</a> <a href="/tags/Android%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" style="font-size: 12.86px;">Androidæ€§èƒ½ä¼˜åŒ–</a> <a href="/tags/Android%E6%B7%B7%E6%B7%86%E6%8A%80%E6%9C%AF/" style="font-size: 10px;">Androidæ··æ·†æŠ€æœ¯</a> <a href="/tags/Android%E8%B4%A8%E9%87%8F%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/" style="font-size: 11.43px;">Androidè´¨é‡ç®¡ç†å·¥å…·</a> <a href="/tags/Android%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/" style="font-size: 10px;">Androidé€†å‘å·¥ç¨‹</a> <a href="/tags/Git-github/" style="font-size: 10px;">Git && github</a> <a href="/tags/Hexo-%E4%BD%BF%E7%94%A8/" style="font-size: 15px;">Hexo ä½¿ç”¨</a> <a href="/tags/JavaScript/" style="font-size: 10px;">JavaScript</a> <a href="/tags/Linux-%E4%BD%BF%E7%94%A8/" style="font-size: 10px;">Linux ä½¿ç”¨</a> <a href="/tags/Objective-C-%E7%9B%B8%E5%85%B3/" style="font-size: 18.57px;">Objective C ç›¸å…³</a> <a href="/tags/OpenCV/" style="font-size: 12.86px;">OpenCV</a> <a href="/tags/ROS/" style="font-size: 14.29px;">ROS</a> <a href="/tags/iOS-%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/" style="font-size: 10.71px;">iOS å·¥å…·ä½¿ç”¨</a> <a href="/tags/iOS-%E5%BC%80%E6%BA%90%E5%BA%93%E5%88%86%E6%9E%90/" style="font-size: 20px;">iOS å¼€æºåº“åˆ†æ</a> <a href="/tags/iOS-%E7%90%86%E8%AE%BA%E5%9F%BA%E7%A1%80/" style="font-size: 15.71px;">iOS ç†è®ºåŸºç¡€</a> <a href="/tags/iOS-%E8%BF%9B%E9%98%B6/" style="font-size: 12.14px;">iOS è¿›é˜¶</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83/" style="font-size: 10px;">ä»£ç è§„èŒƒ</a> <a href="/tags/%E5%8D%9A%E5%AE%A2%E5%88%86%E7%B1%BB%E7%9B%AE%E5%BD%95/" style="font-size: 10.71px;">åšå®¢åˆ†ç±»ç›®å½•</a> <a href="/tags/%E5%8F%A8%E5%8F%A8%E7%B3%BB%E5%88%97/" style="font-size: 10px;">å¨å¨ç³»åˆ—</a> <a href="/tags/%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8/" style="font-size: 11.43px;">å·¥å…·çš„ä½¿ç”¨</a> <a href="/tags/%E5%BC%80%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/" style="font-size: 10.71px;">å¼€æºä»£ç åˆ†æ</a> <a href="/tags/%E5%BC%80%E6%BA%90%E5%BA%93%E5%88%86%E6%9E%90/" style="font-size: 10px;">å¼€æºåº“åˆ†æ</a> <a href="/tags/%E6%9D%82%E7%B1%BB/" style="font-size: 10px;">æ‚ç±»</a> <a href="/tags/%E6%A0%91%E8%8E%93%E6%B4%BE/" style="font-size: 12.14px;">æ ‘è“æ´¾</a> <a href="/tags/%E7%9B%B4%E6%92%AD/" style="font-size: 12.86px;">ç›´æ’­</a> <a href="/tags/%E7%BC%96%E7%A8%8B%E6%8A%80%E5%B7%A7/" style="font-size: 10.71px;">ç¼–ç¨‹æŠ€å·§</a> <a href="/tags/%E7%BD%91%E7%AB%99%E6%94%B6%E8%97%8F/" style="font-size: 10px;">ç½‘ç«™æ”¶è—</a> <a href="/tags/%E9%87%8D%E8%A6%81%E6%8E%A7%E4%BB%B6/" style="font-size: 11.43px;">é‡è¦æ§ä»¶</a>
    </div>
  </div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
		
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/hsihohuang/kiddochan" target="_blank" title="Kiddochan">Kiddochan</a> Â© 2022 
		
		<a href="/about" target="_blank" title="Edgar">Edgar</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
        getSize();
        if (myWidth >= 1024) {
          c.click();
        }
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>




<script type="text/javascript">
  var duoshuoQuery = {short_name:"tbfungeek"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 


<script type="text/javascript">

var disqus_shortname = 'tbfungeek';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>






<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?7c9443b0374f1cf6b1dbb5ab84d939cb";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
