
 <!DOCTYPE HTML>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  
    <title>IGKListKit 使用及源码分析 | Edgar&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Edgar">
    

    
    <meta name="description" content="开源信息 IGKListKit 源码地址 IGKListKit 文档地址  IGKListKit 是一个数据驱动的用于快速创建列表的框架，它有如下特点：  🙅 Never call performBatchUpdates(_:, completion:) or reloadData() again 🏠 Better architecture with reusable cells and c">
<meta property="og:type" content="article">
<meta property="og:title" content="IGKListKit 使用及源码分析">
<meta property="og:url" content="http://yoursite.com/2019/12/08/IGKListKit-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="Edgar&#39;s Blog">
<meta property="og:description" content="开源信息 IGKListKit 源码地址 IGKListKit 文档地址  IGKListKit 是一个数据驱动的用于快速创建列表的框架，它有如下特点：  🙅 Never call performBatchUpdates(_:, completion:) or reloadData() again 🏠 Better architecture with reusable cells and c">
<meta property="og:locale">
<meta property="og:image" content="http://yoursite.com/2019/12/08/IGKListKit-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/00001.gif">
<meta property="og:image" content="http://yoursite.com/2019/12/08/IGKListKit-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/00002.png">
<meta property="og:image" content="http://yoursite.com/2019/12/08/IGKListKit-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/00003.png">
<meta property="article:published_time" content="2019-12-07T17:23:15.000Z">
<meta property="article:modified_time" content="2019-12-19T13:48:48.000Z">
<meta property="article:author" content="Edgar">
<meta property="article:tag" content="iOS 开源库分析">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/2019/12/08/IGKListKit-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/00001.gif">

    
    <link rel="alternative" href="atom.xml" title="Edgar&#39;s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/unnamed4_n_mSY_icon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/profile.png">
    <link rel="apple-touch-icon-precomposed" href="/img/profile.png">
    
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.2.0"></head>

  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Edgar&#39;s Blog">Edgar&#39;s Blog</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
					<li>
 					
					<form class="search" action="/search/index.html" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" autocomplete="off" name="q" maxlength="20" placeholder="Search" />
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/12/08/IGKListKit-使用及源码分析/" title="IGKListKit 使用及源码分析" itemprop="url">IGKListKit 使用及源码分析</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Edgar" target="_blank" itemprop="author">Edgar</a>
		
  <p class="article-time">
    <time datetime="2019-12-07T17:23:15.000Z" itemprop="datePublished"> Published 2019-12-08</time>
    
  </p>
</header>
	<div class="article-content">
		
		<p><img src="/2019/12/08/IGKListKit-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/00001.gif"></p>
<h5 id="开源信息"><a href="#开源信息" class="headerlink" title="开源信息"></a>开源信息</h5><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Instagram/IGListKit">IGKListKit 源码地址</a></li>
<li><a target="_blank" rel="noopener" href="https://instagram.github.io/IGListKit/">IGKListKit 文档地址</a></li>
</ul>
<p><strong><strong>IGKListKit 是一个数据驱动的用于快速创建列表的框架，它有如下特点：</strong></strong></p>
<ul>
<li>🙅 Never call performBatchUpdates(_:, completion:) or reloadData() again</li>
<li>🏠 Better architecture with reusable cells and components</li>
<li>🔠 Create collections with multiple data types</li>
<li>🔑 Decoupled diffing algorithm</li>
<li>✅	Fully unit tested</li>
<li>🔍 Customize your diffing behavior for your models</li>
<li>📱 Simply UICollectionView at its core</li>
<li>🚀 Extendable API</li>
<li>🐦 Written in Objective-C with full Swift interop support</li>
</ul>
<h5 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h5><p>整个IGKListKit代码还是蛮多的，我们在进行源码解析之前先对这些代码进行整理下，看下整个IGKListKit是由哪些部分构成的：</p>
<p><img src="/2019/12/08/IGKListKit-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/00002.png"></p>
<p>这里大致将整个代码分成两大部分：</p>
<ol>
<li>IGListDiffKit 里面存放的是IGListKit的diff 算法相关类</li>
<li>IGListKit 里面存放的是整个框架代码，它是由如下几部分构成：</li>
</ol>
<ul>
<li>Adapter: 这是最核心的部分，是它将CollectionView,SessionController,Updater,Context关联起来。它从SessionController获取每个session的数据，通过Updater将数据加载到CollectionView。</li>
<li>Updater: 负责将数据加载到CollectionView</li>
<li>CollectionView: 负责数据的展示</li>
<li>Context: 一些环境上下文全局内容</li>
<li>Debug: 用于辅助调试的内容</li>
</ul>
<p>这篇博客会从数据源开始，从数据源的提供，根据数据源选择SessionController,再通过Updater将数据加载到UICollectionView.</p>
<p><img src="/2019/12/08/IGKListKit-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/00003.png"></p>
<p><strong><strong>数据源</strong></strong></p>
<p>IGListKit 数据源都必须遵循<strong><strong>IGListAdapterDataSource</strong></strong>协议：</p>
<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 根据传入的IGListAdapter来返回要展示的数据源，注意这里的数组中的每个元素对应的是一个session中要展示的数据集，返回的是多个session数据集的集合。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (NSArray&lt;id &lt;IGListDiffable&gt;&gt; *)objectsForListAdapter:(IGListAdapter *)listAdapter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 传入特定的对象，也就是一个session的数据集合，返回它对应的sessionController，我们可以在这里建立sessionController与对象数据集合的对应关系。这里也是新建sessionController的地方，我们可以在这里传数据给sessionController</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (IGListSectionController *)listAdapter:(IGListAdapter *)listAdapter sectionControllerForObject:(id)object;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 当列表的数据集合为空的时候可以通过这个位置返回空页面需要展示的内容</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (nullable UIView *)emptyViewForListAdapter:(IGListAdapter *)listAdapter;</span><br></pre></td></tr></table></figure>

<p>在<strong><strong>IGListAdapterDataSource</strong></strong>中我们可以提供数据，空数据时候所要展示的界面，以及session数据与sessionController之间的映射关系。</p>
<p><strong><strong>IGListAdapter的初始化工作</strong></strong></p>
<p>IGListAdapter是整个IGListKit的核心部分，它负责调度各个类来完成从数据源获取数据，数据与sessionController的映射关系，使用Updater将数据加载到UICollectionView,分发各个代理事件等等功能，所以我们先来看下它是由哪些重要的组件构成，以及这些组件都有哪些功能：</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 容纳适配器的视图控制器。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">nullable</span>, <span class="keyword">weak</span>) <span class="built_in">UIViewController</span> *viewController;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 适配器使用的UICollectionView</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">nullable</span>, <span class="keyword">weak</span>) <span class="built_in">UICollectionView</span> *collectionView;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> IGListAdapter的数据源</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">nullable</span>, <span class="keyword">weak</span>) <span class="type">id</span> &lt;IGListAdapterDataSource&gt; dataSource;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 某些对象将要显示或者已经显示完毕后的通知</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">nullable</span>, <span class="keyword">weak</span>) <span class="type">id</span> &lt;IGListAdapterDelegate&gt; delegate;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 接受UICollectionView 代理事件的delegate</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">nullable</span>, <span class="keyword">weak</span>) <span class="type">id</span> &lt;<span class="built_in">UICollectionViewDelegate</span>&gt; collectionViewDelegate;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 接受UIScrollView代理事件的delegate</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">nullable</span>, <span class="keyword">weak</span>) <span class="type">id</span> &lt;<span class="built_in">UIScrollViewDelegate</span>&gt; scrollViewDelegate;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 重排session代理事件的delegate</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">nullable</span>, <span class="keyword">weak</span>) <span class="type">id</span> &lt;IGListAdapterMoveDelegate&gt; moveDelegate <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">9</span>_0);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 用于性能检测点的的delegate</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">nullable</span>, <span class="keyword">weak</span>) <span class="type">id</span> &lt;IGListAdapterPerformanceDelegate&gt; performanceDelegate;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> Adapter的更新器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="type">id</span> &lt;IGListUpdatingDelegate&gt; updater;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 对象与SessionController的映射关系</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) IGListSectionMap *sectionMap;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 显示cell的管理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) IGListDisplayHandler *displayHandler;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 用于可见范围的管理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) IGListWorkingRangeHandler *workingRangeHandler;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 负责代理事件的分发</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">nullable</span>) IGListAdapterProxy *delegateProxy;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 空视图界面</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">nullable</span>) <span class="built_in">UIView</span> *emptyBackgroundView;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 用于注册Cell</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableSet</span>&lt;<span class="built_in">NSString</span> *&gt; *registeredCellIdentifiers;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableSet</span>&lt;<span class="built_in">NSString</span> *&gt; *registeredNibNames;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableSet</span>&lt;<span class="built_in">NSString</span> *&gt; *registeredSupplementaryViewIdentifiers;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableSet</span>&lt;<span class="built_in">NSString</span> *&gt; *registeredSupplementaryViewNibNames;</span><br></pre></td></tr></table></figure>

<p>上面列出了比较重要的组件，但是从整体功能上看最主要的组件包括：</p>
<p><strong><strong>UICollectionView</strong></strong>:UICollectionView是整个列表的界面承载实体<br><strong><strong>IGListAdapterDataSource</strong></strong>:IGListAdapterDataSource为整个IGListAdapter提供数据对象，并且指定每个session对应的sessionController,以及空数据时候的界面<br><strong><strong>IGListUpdatingDelegate</strong></strong>:用于将数据加载到UICollectionView<br>****IGListAdapterDelegate&#x2F;UICollectionViewDelegate&#x2F;UIScrollViewDelegate&#x2F;****：提供事件处理代理方法<br><strong><strong>IGListAdapterProxy</strong></strong>:负责事件分发<br><strong><strong>IGListSectionMap</strong></strong>:维护数据集与sessionController的映射关系<br><strong><strong>IGListDisplayHandler</strong></strong>:负责可见对象的控制，这些可见对象存储于visibleViewObjectMap<br><strong><strong>IGListWorkingRangeHandler</strong></strong>:负责工作区的管理<br><strong><strong>IGListAdapterMoveDelegate&#x2F;IGListAdapterPerformanceDelegate</strong></strong>：移动sessionController以及性能检测埋点的代理</p>
<p>我们看下 <strong><strong>IGListAdapter</strong></strong> 的初始化阶段：</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">instancetype</span>)initWithUpdater:(<span class="type">id</span> &lt;IGListUpdatingDelegate&gt;)updater</span><br><span class="line">                 viewController:(<span class="built_in">UIViewController</span> *)viewController</span><br><span class="line">               workingRangeSize:(<span class="built_in">NSInteger</span>)workingRangeSize &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//........</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="variable language_">super</span> init]) &#123; </span><br><span class="line">        <span class="comment">//初始化重要组件</span></span><br><span class="line">        <span class="built_in">NSPointerFunctions</span> *keyFunctions = [updater objectLookupPointerFunctions];</span><br><span class="line">        <span class="built_in">NSPointerFunctions</span> *valueFunctions = [<span class="built_in">NSPointerFunctions</span> pointerFunctionsWithOptions:<span class="built_in">NSPointerFunctionsStrongMemory</span>];</span><br><span class="line">        <span class="built_in">NSMapTable</span> *table = [[<span class="built_in">NSMapTable</span> alloc] initWithKeyPointerFunctions:keyFunctions valuePointerFunctions:valueFunctions capacity:<span class="number">0</span>];</span><br><span class="line">        _sectionMap = [[IGListSectionMap alloc] initWithMapTable:table];</span><br><span class="line">        _displayHandler = [IGListDisplayHandler new];</span><br><span class="line">        _workingRangeHandler = [[IGListWorkingRangeHandler alloc] initWithWorkingRangeSize:workingRangeSize];</span><br><span class="line">        _updateListeners = [<span class="built_in">NSHashTable</span> weakObjectsHashTable];</span><br><span class="line">        _viewSectionControllerMap = [<span class="built_in">NSMapTable</span> mapTableWithKeyOptions:<span class="built_in">NSMapTableObjectPointerPersonality</span> | <span class="built_in">NSMapTableStrongMemory</span></span><br><span class="line">                                                          valueOptions:<span class="built_in">NSMapTableStrongMemory</span>];</span><br><span class="line">        _updater = updater;</span><br><span class="line">        _viewController = viewController;</span><br><span class="line">        [IGListDebugger trackAdapter:<span class="keyword">self</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>初始化任务中完成了大部分重要组件的初始化，上面已经介绍了这些组件的功能，这里就不重复介绍了。</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)setCollectionView:(<span class="built_in">UICollectionView</span> *)collectionView &#123;</span><br><span class="line">    <span class="comment">// 如果collectionView 被用于另一个adapter，那么我们需要对它进行重置，断开与之前adapter之间的关联，避免会被之前对adapter错误更新。</span></span><br><span class="line">    <span class="keyword">if</span> (_collectionView != collectionView || _collectionView.dataSource != <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="comment">//每个UICollectionView 都对应一个 IGListAdapter，globalCollectionViewAdapterMap 里面存放的是之间的对应关系</span></span><br><span class="line">        <span class="keyword">static</span> <span class="built_in">NSMapTable</span>&lt;<span class="built_in">UICollectionView</span> *, IGListAdapter *&gt; *globalCollectionViewAdapterMap = <span class="literal">nil</span>;</span><br><span class="line">        <span class="keyword">if</span> (globalCollectionViewAdapterMap == <span class="literal">nil</span>) &#123;</span><br><span class="line">            globalCollectionViewAdapterMap = [<span class="built_in">NSMapTable</span> weakToWeakObjectsMapTable];</span><br><span class="line">        &#125;</span><br><span class="line">        [globalCollectionViewAdapterMap removeObjectForKey:_collectionView];</span><br><span class="line">        [[globalCollectionViewAdapterMap objectForKey:collectionView] setCollectionView:<span class="literal">nil</span>];</span><br><span class="line">        [globalCollectionViewAdapterMap setObject:<span class="keyword">self</span> forKey:collectionView];</span><br><span class="line">        <span class="comment">//globalCollectionViewAdapterMap ---&gt; key:UICollectionView  value:IGListAdapter</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//注册cell之类的名字</span></span><br><span class="line">        _registeredCellIdentifiers = [<span class="built_in">NSMutableSet</span> new];</span><br><span class="line">        _registeredNibNames = [<span class="built_in">NSMutableSet</span> new];</span><br><span class="line">        _registeredSupplementaryViewIdentifiers = [<span class="built_in">NSMutableSet</span> new];</span><br><span class="line">        _registeredSupplementaryViewNibNames = [<span class="built_in">NSMutableSet</span> new];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> <span class="type">BOOL</span> settingFirstCollectionView = _collectionView == <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//持有collectionView，并将adapter作为它的数据源</span></span><br><span class="line">        _collectionView = collectionView;</span><br><span class="line">        _collectionView.dataSource = <span class="keyword">self</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//.....</span></span><br><span class="line">        <span class="comment">//将adapter保存到collectionViewLayout</span></span><br><span class="line">        [_collectionView.collectionViewLayout ig_hijackLayoutInteractiveReorderingMethodForAdapter:<span class="keyword">self</span>];</span><br><span class="line">        [_collectionView.collectionViewLayout invalidateLayout];</span><br><span class="line"></span><br><span class="line">        <span class="comment">//CollectionViewDelegate 要么设置为 delegateProxy 要么设置为adapter</span></span><br><span class="line">        [<span class="keyword">self</span> _updateCollectionViewDelegate];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// only construct</span></span><br><span class="line">        <span class="keyword">if</span> (!IGListExperimentEnabled(<span class="keyword">self</span>.experiments, IGListExperimentGetCollectionViewAtUpdate)</span><br><span class="line">            || settingFirstCollectionView) &#123;</span><br><span class="line">            [<span class="keyword">self</span> _updateAfterPublicSettingsChange];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)_updateCollectionViewDelegate &#123;</span><br><span class="line">    _collectionView.delegate = (<span class="type">id</span>&lt;<span class="built_in">UICollectionViewDelegate</span>&gt;)<span class="keyword">self</span>.delegateProxy ?: <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>为IGListAdapter设置collectionView的时候要注意如果globalCollectionViewAdapterMap中已经存在了一个映射关系，需要重新移除后添加，之后为collectionView重新设置当前的Adapter作为新的dataSource，以及delegateProxy的设置，对于第一次创建的时候还需要调用_updateAfterPublicSettingsChange从datasource中取出属于当前adapter的数据，进行相关的更新。这部分在接下来的设置数据源也会涉及，我们就来看下数据源的设置：</p>
<p><strong><strong>IGListAdapter数据源的设置</strong></strong></p>
<figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line">- (void)setDataSource:(id&lt;IGListAdapterDataSource&gt;)dataSource &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">_dataSource</span> != dataSource) &#123;</span><br><span class="line">        <span class="variable">_dataSource</span> = dataSource;</span><br><span class="line">        <span class="comment">//数据源改变的时候会剔除重复数据后更新数据</span></span><br><span class="line">        [self <span class="variable">_updateAfterPublicSettingsChange</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)<span class="variable">_updateAfterPublicSettingsChange</span> &#123;</span><br><span class="line">    id&lt;IGListAdapterDataSource&gt; dataSource = <span class="variable">_dataSource</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">_collectionView</span> != <span class="literal">nil</span> &amp;&amp; dataSource != <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="comment">//去除当前Adapter中重复的元素</span></span><br><span class="line">        NSArray *uniqueObjects = objectsWithDuplicateIdentifiersRemoved([dataSource objectsForListAdapter:self]);</span><br><span class="line">        <span class="comment">//更新数据源</span></span><br><span class="line">        [self <span class="variable">_updateObjects</span>:uniqueObjects dataSource:dataSource];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里会通过[dataSource objectsForListAdapter:self]，取出属于该adapter的数据对象。然后通过objectsWithDuplicateIdentifiersRemoved剔除掉重复的数据后，通过_updateObjects更新adapter中的其他模块数据，我们重点看下这个部分：</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)_updateObjects:(<span class="built_in">NSArray</span> *)objects dataSource:(<span class="type">id</span>&lt;IGListAdapterDataSource&gt;)dataSource &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//.......</span></span><br><span class="line">    <span class="built_in">NSMutableArray</span>&lt;IGListSectionController *&gt; *sectionControllers = [<span class="built_in">NSMutableArray</span> new];</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *validObjects = [<span class="built_in">NSMutableArray</span> new];</span><br><span class="line"></span><br><span class="line">    IGListSectionMap *map = <span class="keyword">self</span>.sectionMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// collect items that have changed since the last update</span></span><br><span class="line">    <span class="built_in">NSMutableSet</span> *updatedObjects = [<span class="built_in">NSMutableSet</span> new];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//遍历从数据源获取到的每个数据,注意这里的object其实是一个数据集，每个数据集针对一个sessionController</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">id</span> object <span class="keyword">in</span> objects) &#123;</span><br><span class="line">        <span class="comment">// 查看是否之前已经创建了sectionController，如果有就直接使用</span></span><br><span class="line">        IGListSectionController *sectionController = [map sectionControllerForObject:object];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果之前没有我们就询问dataSource返回一个指定数据集对应的sessionController</span></span><br><span class="line">        <span class="keyword">if</span> (sectionController == <span class="literal">nil</span>) &#123;</span><br><span class="line">            sectionController = [dataSource listAdapter:<span class="keyword">self</span> sectionControllerForObject:object];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果再没有直接报错</span></span><br><span class="line">        <span class="keyword">if</span> (sectionController == <span class="literal">nil</span>) &#123;</span><br><span class="line">            IGLKLog(<span class="string">@&quot;WARNING: Ignoring nil section controller returned by data source %@ for object %@.&quot;</span>,</span><br><span class="line">                    dataSource, object);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将一些环境变量赋给sectionController，比如将当前的adapter作为collectionContext赋给sectionController</span></span><br><span class="line">        sectionController.collectionContext = <span class="keyword">self</span>;</span><br><span class="line">        sectionController.viewController = <span class="keyword">self</span>.viewController;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查当前的对象是全新的还是对已经有的对象进行更新</span></span><br><span class="line">        <span class="keyword">const</span> <span class="built_in">NSInteger</span> oldSection = [map sectionForObject:object];</span><br><span class="line">        <span class="keyword">if</span> (oldSection == <span class="built_in">NSNotFound</span> || [map objectForSection:oldSection] != object) &#123;</span><br><span class="line">            <span class="comment">//更新的对象</span></span><br><span class="line">            [updatedObjects addObject:object];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//将结果记录到sectionControllers 与 validObjects</span></span><br><span class="line">        [sectionControllers addObject:sectionController];</span><br><span class="line">        [validObjects addObject:object];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// clear the view controller and collection context</span></span><br><span class="line">    IGListSectionControllerPopThread();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新到IGListSectionMap IGListSectionMap用于维护object 与sessionController的之间的关系</span></span><br><span class="line">    [map updateWithObjects:validObjects sectionControllers:sectionControllers];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// object 与 sessionController之间的关系已经建立，这时候可以认为sessionController已经加载完毕，加载完成后sessionController会收到didUpdateToObject的通知</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">id</span> object <span class="keyword">in</span> updatedObjects) &#123;</span><br><span class="line">        [[map sectionControllerForObject:object] didUpdateToObject:object];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//计算总数量</span></span><br><span class="line">    <span class="built_in">NSInteger</span> itemCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (IGListSectionController *sectionController <span class="keyword">in</span> sectionControllers) &#123;</span><br><span class="line">        itemCount += [sectionController numberOfItems];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据总数量决定显示空界面还是正常的UICollectionView</span></span><br><span class="line">    [<span class="keyword">self</span> _updateBackgroundViewShouldHide:itemCount &gt; <span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)_updateBackgroundViewShouldHide:(<span class="type">BOOL</span>)shouldHide &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//如果还在更新那么先返回,在update block执行结束之后还会调用</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.isInUpdateBlock) &#123;</span><br><span class="line">        <span class="keyword">return</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//根据itemCount数量决定是否显示空白页面</span></span><br><span class="line">    <span class="built_in">UIView</span> *backgroundView = [<span class="keyword">self</span>.dataSource emptyViewForListAdapter:<span class="keyword">self</span>];</span><br><span class="line">    <span class="comment">// don&#x27;t do anything if the client is using the same view</span></span><br><span class="line">    <span class="keyword">if</span> (backgroundView != _collectionView.backgroundView) &#123;</span><br><span class="line">        <span class="comment">// collection view will just stack the background views underneath each other if we do not remove the previous</span></span><br><span class="line">        <span class="comment">// one first. also fine if it is nil</span></span><br><span class="line">        [_collectionView.backgroundView removeFromSuperview];</span><br><span class="line">        _collectionView.backgroundView = backgroundView;</span><br><span class="line">    &#125;</span><br><span class="line">    _collectionView.backgroundView.hidden = shouldHide;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们上面传入_updateObjects的objects是整个adapter所对应的数据集的数组，那么在_updateObjects中首先需要遍历数组中的每个数据集，我们知道object与sessionController的对应关系存在于两个地方IGListSectionMap以及IGListAdapter。首先我们会从IGListSectionMap中去检查是否有缓存了这种关系，如果没有再从IGListAdapter去获取。拿到之后再更新到IGListSectionMap以供下次使用。对于数据有变动的情况还会调用sessionController的didUpdateToObject方法。最后计算整个adapter的数据总数，如果数据总数为0那么会调用emptyViewForListAdapter获取空界面进行展示。</p>
<p><strong><strong>IGListAdapter代理设置</strong></strong></p>
<figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line">- (void)setCollectionViewDelegate:(id&lt;UICollectionViewDelegate&gt;)collectionViewDelegate &#123;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="comment">//_collectionViewDelegate 这个会传递到IGListAdapterProxy</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">_collectionViewDelegate</span> != collectionViewDelegate) &#123;</span><br><span class="line">        <span class="variable">_collectionViewDelegate</span> = collectionViewDelegate;</span><br><span class="line">        <span class="comment">//创建IGListAdapterProxy并设置为delegate</span></span><br><span class="line">        [self <span class="variable">_createProxyAndUpdateCollectionViewDelegate</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)setScrollViewDelegate:(id&lt;UIScrollViewDelegate&gt;)scrollViewDelegate &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">_scrollViewDelegate</span> != scrollViewDelegate) &#123;</span><br><span class="line">        <span class="variable">_scrollViewDelegate</span> = scrollViewDelegate;</span><br><span class="line">        <span class="comment">//_scrollViewDelegate 这个会传递到IGListAdapterProxy</span></span><br><span class="line">        [self <span class="variable">_createProxyAndUpdateCollectionViewDelegate</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)<span class="variable">_createProxyAndUpdateCollectionViewDelegate</span> &#123;</span><br><span class="line">    <span class="variable">_collectionView</span>.delegate = <span class="literal">nil</span>;</span><br><span class="line">    self.delegateProxy = [[IGListAdapterProxy alloc] initWithCollectionViewTarget:<span class="variable">_collectionViewDelegate</span></span><br><span class="line">                                                                 scrollViewTarget:<span class="variable">_scrollViewDelegate</span></span><br><span class="line">                                                                      interceptor:self];</span><br><span class="line">    [self <span class="variable">_updateCollectionViewDelegate</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面代码看IGListAdapterProxy接受三个对象_collectionViewDelegate，_scrollViewDelegate以及adapter。然后再将IGListAdapterProxy作为collectionView的delegate。这样做的好处是可以通过IGListAdapterProxy进行统一管理，IGListAdapterProxy负责这些代理事件的集中分发。</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">BOOL</span>)respondsToSelector:(SEL)aSelector &#123;</span><br><span class="line">    <span class="keyword">return</span> isInterceptedSelector(aSelector)</span><br><span class="line">    || [_collectionViewTarget respondsToSelector:aSelector]</span><br><span class="line">    || [_scrollViewTarget respondsToSelector:aSelector];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">id</span>)forwardingTargetForSelector:(SEL)aSelector &#123;</span><br><span class="line">    <span class="keyword">if</span> (isInterceptedSelector(aSelector)) &#123;</span><br><span class="line">        <span class="keyword">return</span> _interceptor;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [_scrollViewTarget respondsToSelector:aSelector] ? _scrollViewTarget : _collectionViewTarget;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)invocation &#123;</span><br><span class="line">    <span class="type">void</span> *nullPointer = <span class="literal">NULL</span>;</span><br><span class="line">    [invocation setReturnValue:&amp;nullPointer];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)selector &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSObject</span> instanceMethodSignatureForSelector:<span class="keyword">@selector</span>(init)];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在IGListAdapterProxy中会对这些代理方法进行拦截，如果在拦截清单内的话会将这些代理方法转到_interceptor也就是adapter，其他的则会根据_scrollViewTarget以及_collectionViewTarget是否有响应的方法来确定转发给谁,下面是拦截的方法：</p>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">static</span> <span class="selector-tag">BOOL</span> <span class="selector-tag">isInterceptedSelector</span>(SEL sel) &#123;</span><br><span class="line">    <span class="selector-tag">return</span> (</span><br><span class="line">            <span class="comment">// UIScrollViewDelegate</span></span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">scrollViewDidScroll</span>:) ||</span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">scrollViewWillBeginDragging</span>:) ||</span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">scrollViewDidEndDragging</span>:<span class="attribute">willDecelerate</span>:) ||</span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">scrollViewDidEndDecelerating</span>:) ||</span><br><span class="line">            <span class="comment">// UICollectionViewDelegate</span></span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">collectionView</span>:<span class="attribute">willDisplayCell</span>:<span class="attribute">forItemAtIndexPath</span>:) ||</span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">collectionView</span>:<span class="attribute">didEndDisplayingCell</span>:<span class="attribute">forItemAtIndexPath</span>:) ||</span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">collectionView</span>:<span class="attribute">didSelectItemAtIndexPath</span>:) ||</span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">collectionView</span>:<span class="attribute">didDeselectItemAtIndexPath</span>:) ||</span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">collectionView</span>:<span class="attribute">didHighlightItemAtIndexPath</span>:) ||</span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">collectionView</span>:<span class="attribute">didUnhighlightItemAtIndexPath</span>:) ||</span><br><span class="line">            <span class="comment">// UICollectionViewDelegateFlowLayout</span></span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">collectionView</span>:<span class="attribute">layout</span>:<span class="attribute">sizeForItemAtIndexPath</span>:) ||</span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">collectionView</span>:<span class="attribute">layout</span>:<span class="attribute">insetForSectionAtIndex</span>:) ||</span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">collectionView</span>:<span class="attribute">layout</span>:<span class="attribute">minimumInteritemSpacingForSectionAtIndex</span>:) ||</span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">collectionView</span>:<span class="attribute">layout</span>:<span class="attribute">minimumLineSpacingForSectionAtIndex</span>:) ||</span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">collectionView</span>:<span class="attribute">layout</span>:<span class="attribute">referenceSizeForFooterInSection</span>:) ||</span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">collectionView</span>:<span class="attribute">layout</span>:<span class="attribute">referenceSizeForHeaderInSection</span>:) ||</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// IGListCollectionViewDelegateLayout</span></span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">collectionView</span>:<span class="attribute">layout</span>:<span class="attribute">customizedInitialLayoutAttributes</span>:<span class="attribute">atIndexPath</span>:) ||</span><br><span class="line">            sel == <span class="variable">@selector</span>(<span class="attribute">collectionView</span>:<span class="attribute">layout</span>:<span class="attribute">customizedFinalLayoutAttributes</span>:<span class="attribute">atIndexPath</span>:)</span><br><span class="line">            );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><strong>Object &amp;&amp; sessionController 之间的映射关系</strong></strong></p>
<p>目前在IGListKit可以完成如下几种对象之间的映射关系：</p>
<figure class="highlight brainfuck"><table><tr><td class="code"><pre><span class="line"><span class="comment">* indexPath</span> &lt;<span class="literal">--</span><span class="comment">indexPath</span><span class="string">.</span><span class="comment">section</span><span class="literal">--</span>&gt; <span class="comment">section</span> &lt;<span class="literal">---</span><span class="comment">sectionControllerForSection/sectionForSectionController</span><span class="literal">---</span>&gt; <span class="comment">IGListSectionController</span> &lt;<span class="literal">--</span><span class="comment">sectionControllerForObject/objectForSection</span><span class="literal">--</span>&gt;<span class="comment">object</span></span><br><span class="line"></span><br><span class="line"><span class="comment">* indexPath</span> <span class="literal">--</span><span class="comment">sectionControllerForSection</span><span class="literal">--</span><span class="comment">supplementaryViewSource</span><span class="literal">--</span>&gt; <span class="comment">IGListSupplementaryViewSource</span></span><br></pre></td></tr></table></figure>

<p>这部分代码就不贴出来了，最底层逻辑在sectionMap上，大家可以查看对应的源码。</p>
<p><strong><strong>可见性通知</strong></strong></p>
<p>这部分主要涉及<strong><strong>IGListDisplayDelegate</strong></strong>，<strong><strong>IGListAdapterDelegate</strong></strong>，<strong><strong>IGListDisplayHandler</strong></strong>这三个类，我们可以指定IGListAdapter的delegate来监听可见性情况：</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">IGListAdapterDelegate</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 通知delegate某个数据集即将显示</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="type">void</span>)listAdapter:(IGListAdapter *)listAdapter willDisplayObject:(<span class="type">id</span>)object atIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 通知delegate某个数据集合将不在显示范围内</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="type">void</span>)listAdapter:(IGListAdapter *)listAdapter didEndDisplayingObject:(<span class="type">id</span>)object atIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>IGListAdapterDelegate其实和IGListDisplayDelegate是一样的，只不过一个是在adapter上层监听，一个是在sessionController监听。IGListDisplayDelegate其实监听的是更细粒度的可以通过代理知道具体哪个cell进入可见区域，我们在看下IGListDisplayDelegate：</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">IGListDisplayDelegate</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">指定的sessionController进入到可见区域</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="type">void</span>)listAdapter:(IGListAdapter *)listAdapter willDisplaySectionController:(IGListSectionController *)sectionController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">指定的sessionController离开可见区域</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="type">void</span>)listAdapter:(IGListAdapter *)listAdapter didEndDisplayingSectionController:(IGListSectionController *)sectionController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">在某个sessionController的某个cell进入到可见区域</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="type">void</span>)listAdapter:(IGListAdapter *)listAdapter willDisplaySectionController:(IGListSectionController *)sectionController</span><br><span class="line">               cell:(<span class="built_in">UICollectionViewCell</span> *)cell</span><br><span class="line">            atIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">某个sessionController的某个cell离开可见区域</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="type">void</span>)listAdapter:(IGListAdapter *)listAdapter didEndDisplayingSectionController:(IGListSectionController *)sectionController</span><br><span class="line">               cell:(<span class="built_in">UICollectionViewCell</span> *)cell</span><br><span class="line">            atIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>IGListAdapterDelegate和IGListDisplayDelegate对应的方法是在IGListDisplayHandler中被调用的。IGListDisplayHandler中维护着一份visibleListSections以及visibleViewObjectMap；visibleListSections里面存储着当前可见的sessionController,visibleViewObjectMap里面存储的是数据对象以及CellView的映射关系。在sessionController进入离开可见区域的时候都会维护这两个对象里面的内容，并且通知adapter以及sessionController中的对应delegate。</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)_willDisplayReusableView:(<span class="built_in">UICollectionReusableView</span> *)view</span><br><span class="line">                 forListAdapter:(IGListAdapter *)listAdapter</span><br><span class="line">              sectionController:(IGListSectionController *)sectionController</span><br><span class="line">                         object:(<span class="type">id</span>)object</span><br><span class="line">                      indexPath:(<span class="built_in">NSIndexPath</span> *)indexPath &#123;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="comment">//self.visibleViewObjectMap 中存储的是数据对象以及CellView</span></span><br><span class="line">    [<span class="keyword">self</span>.visibleViewObjectMap setObject:object forKey:view];</span><br><span class="line">    <span class="comment">//可见的session部分</span></span><br><span class="line">    <span class="built_in">NSCountedSet</span> *visibleListSections = <span class="keyword">self</span>.visibleListSections;</span><br><span class="line">    <span class="keyword">if</span> ([visibleListSections countForObject:sectionController] == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/*如果当前的sectionController没有在可见session列表中则触发通知给sectionController以及listAdapter*/</span></span><br><span class="line">        [sectionController.displayDelegate listAdapter:listAdapter willDisplaySectionController:sectionController];</span><br><span class="line">        [listAdapter.delegate listAdapter:listAdapter willDisplayObject:object atIndex:indexPath.section];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//将当前的sectionController添加到visibleListSections 避免重复通知</span></span><br><span class="line">    [visibleListSections addObject:sectionController];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)_didEndDisplayingReusableView:(<span class="built_in">UICollectionReusableView</span> *)view</span><br><span class="line">                      forListAdapter:(IGListAdapter *)listAdapter</span><br><span class="line">                   sectionController:(IGListSectionController *)sectionController</span><br><span class="line">                              object:(<span class="type">id</span>)object</span><br><span class="line">                           indexPath:(<span class="built_in">NSIndexPath</span> *)indexPath &#123;</span><br><span class="line">    IGParameterAssert(view != <span class="literal">nil</span>);</span><br><span class="line">    IGParameterAssert(listAdapter != <span class="literal">nil</span>);</span><br><span class="line">    IGParameterAssert(indexPath != <span class="literal">nil</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (object == <span class="literal">nil</span> || sectionController == <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">NSInteger</span> section = indexPath.section;</span><br><span class="line">    <span class="comment">//移除sectionController并通知sectionController以及listAdapter</span></span><br><span class="line">    <span class="built_in">NSCountedSet</span> *visibleSections = <span class="keyword">self</span>.visibleListSections;</span><br><span class="line">    [visibleSections removeObject:sectionController];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ([visibleSections countForObject:sectionController] == <span class="number">0</span>) &#123;</span><br><span class="line">        [sectionController.displayDelegate listAdapter:listAdapter didEndDisplayingSectionController:sectionController];</span><br><span class="line">        [listAdapter.delegate listAdapter:listAdapter didEndDisplayingObject:object atIndex:section];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么IGListDisplayHandler这些方法是谁触发的呢？嗯，是Adapter触发的，我们上面介绍IGListAdapterProxy的时候讲到Adapter会拦截部分的代理方法，在这部分代理方法中就可以调用IGListDisplayHandler发出通知。这部分代码在<strong><strong>IGListAdapter+UICollectionView</strong></strong>,这里面包括了可见区域的通知，以及工作区相关的处理。由于同时需要注意的是由于在IGListAdapterProxy会对这部分代理方法进行拦截，所以这里还需要将事件通知到collectionViewDelegate</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="operator">-</span> (void)collectionView:(<span class="type">UICollectionView</span> <span class="operator">*</span>)collectionView willDisplayCell:(<span class="type">UICollectionViewCell</span> <span class="operator">*</span>)cell forItemAtIndexPath:(<span class="type">NSIndexPath</span> <span class="operator">*</span>)indexPath &#123;</span><br><span class="line">    id<span class="operator">&lt;</span><span class="type">IGListAdapterPerformanceDelegate</span><span class="operator">&gt;</span> performanceDelegate <span class="operator">=</span> <span class="keyword">self</span>.performanceDelegate;</span><br><span class="line">    [performanceDelegate listAdapterWillCallDisplayCell:<span class="keyword">self</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 由于在IGListAdapterProxy会对这部分请求进行拦截，所以这里还需要将事件通知到collectionViewDelegate</span></span><br><span class="line">    id<span class="operator">&lt;</span><span class="type">UICollectionViewDelegate</span><span class="operator">&gt;</span> collectionViewDelegate <span class="operator">=</span> <span class="keyword">self</span>.collectionViewDelegate;</span><br><span class="line">    <span class="keyword">if</span> ([collectionViewDelegate respondsToSelector:<span class="meta">@selector</span>(collectionView:willDisplayCell:forItemAtIndexPath:)]) &#123;</span><br><span class="line">        [collectionViewDelegate collectionView:collectionView willDisplayCell:cell forItemAtIndexPath:indexPath];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取到sessionController</span></span><br><span class="line">    <span class="type">IGListSectionController</span> <span class="operator">*</span>sectionController <span class="operator">=</span> [<span class="keyword">self</span> sectionControllerForView:cell];</span><br><span class="line">    <span class="comment">// if the section controller relationship was destroyed, reconnect it</span></span><br><span class="line">    <span class="comment">// this happens with iOS 10 UICollectionView display range changes</span></span><br><span class="line">    <span class="keyword">if</span> (sectionController <span class="operator">==</span> <span class="literal">nil</span>) &#123;</span><br><span class="line">        sectionController <span class="operator">=</span> [<span class="keyword">self</span> sectionControllerForSection:indexPath.section];</span><br><span class="line">        <span class="comment">//这里为了建立cell与sessionController之间的关系，供sectionControllerForView使用</span></span><br><span class="line">        [<span class="keyword">self</span> mapView:cell toSectionController:sectionController];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//取出当前sessionController对应的数据集</span></span><br><span class="line">    id object <span class="operator">=</span> [<span class="keyword">self</span>.sectionMap objectForSection:indexPath.section];</span><br><span class="line">    <span class="comment">//通知对应的delegate</span></span><br><span class="line">    [<span class="keyword">self</span>.displayHandler willDisplayCell:cell forListAdapter:<span class="keyword">self</span> sectionController:sectionController object:object indexPath:indexPath];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//工作区相关更新</span></span><br><span class="line">    _isSendingWorkingRangeDisplayUpdates <span class="operator">=</span> <span class="type">YES</span>;</span><br><span class="line">    [<span class="keyword">self</span>.workingRangeHandler willDisplayItemAtIndexPath:indexPath forListAdapter:<span class="keyword">self</span>];</span><br><span class="line">    _isSendingWorkingRangeDisplayUpdates <span class="operator">=</span> <span class="type">NO</span>;</span><br><span class="line"></span><br><span class="line">    [performanceDelegate listAdapter:<span class="keyword">self</span> didCallDisplayCell:cell onSectionController:sectionController atIndex:indexPath.item];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="operator">-</span> (void)collectionView:(<span class="type">UICollectionView</span> <span class="operator">*</span>)collectionView didEndDisplayingCell:(<span class="type">UICollectionViewCell</span> <span class="operator">*</span>)cell forItemAtIndexPath:(<span class="type">NSIndexPath</span> <span class="operator">*</span>)indexPath &#123;</span><br><span class="line">    id<span class="operator">&lt;</span><span class="type">IGListAdapterPerformanceDelegate</span><span class="operator">&gt;</span> performanceDelegate <span class="operator">=</span> <span class="keyword">self</span>.performanceDelegate;</span><br><span class="line">    [performanceDelegate listAdapterWillCallEndDisplayCell:<span class="keyword">self</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 由于在IGListAdapterProxy会对这部分请求进行拦截，所以这里还需要将事件通知到collectionViewDelegate</span></span><br><span class="line">    id<span class="operator">&lt;</span><span class="type">UICollectionViewDelegate</span><span class="operator">&gt;</span> collectionViewDelegate <span class="operator">=</span> <span class="keyword">self</span>.collectionViewDelegate;</span><br><span class="line">    <span class="keyword">if</span> ([collectionViewDelegate respondsToSelector:<span class="meta">@selector</span>(collectionView:didEndDisplayingCell:forItemAtIndexPath:)]) &#123;</span><br><span class="line">        [collectionViewDelegate collectionView:collectionView didEndDisplayingCell:cell forItemAtIndexPath:indexPath];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取到sessionController</span></span><br><span class="line">    <span class="type">IGListSectionController</span> <span class="operator">*</span>sectionController <span class="operator">=</span> [<span class="keyword">self</span> sectionControllerForView:cell];</span><br><span class="line">    <span class="comment">//通知对应的delegate</span></span><br><span class="line">    [<span class="keyword">self</span>.displayHandler didEndDisplayingCell:cell forListAdapter:<span class="keyword">self</span> sectionController:sectionController indexPath:indexPath];</span><br><span class="line">    <span class="comment">//工作区相关更新</span></span><br><span class="line">    [<span class="keyword">self</span>.workingRangeHandler didEndDisplayingItemAtIndexPath:indexPath forListAdapter:<span class="keyword">self</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// break the association between the cell and the section controller</span></span><br><span class="line">    [<span class="keyword">self</span> removeMapForView:cell];</span><br><span class="line"></span><br><span class="line">    [performanceDelegate listAdapter:<span class="keyword">self</span> didCallEndDisplayCell:cell onSectionController:sectionController atIndex:indexPath.item];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="operator">-</span> (void)collectionView:(<span class="type">UICollectionView</span> <span class="operator">*</span>)collectionView willDisplaySupplementaryView:(<span class="type">UICollectionReusableView</span> <span class="operator">*</span>)view forElementKind:(<span class="type">NSString</span> <span class="operator">*</span>)elementKind atIndexPath:(<span class="type">NSIndexPath</span> <span class="operator">*</span>)indexPath &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 由于在IGListAdapterProxy会对这部分请求进行拦截，所以这里还需要将事件通知到collectionViewDelegate</span></span><br><span class="line">    id<span class="operator">&lt;</span><span class="type">UICollectionViewDelegate</span><span class="operator">&gt;</span> collectionViewDelegate <span class="operator">=</span> <span class="keyword">self</span>.collectionViewDelegate;</span><br><span class="line">    <span class="keyword">if</span> ([collectionViewDelegate respondsToSelector:<span class="meta">@selector</span>(collectionView:willDisplaySupplementaryView:forElementKind:atIndexPath:)]) &#123;</span><br><span class="line">        [collectionViewDelegate collectionView:collectionView willDisplaySupplementaryView:view forElementKind:elementKind atIndexPath:indexPath];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">IGListSectionController</span> <span class="operator">*</span>sectionController <span class="operator">=</span> [<span class="keyword">self</span> sectionControllerForView:view];</span><br><span class="line">    <span class="comment">// if the section controller relationship was destroyed, reconnect it</span></span><br><span class="line">    <span class="comment">// this happens with iOS 10 UICollectionView display range changes</span></span><br><span class="line">    <span class="keyword">if</span> (sectionController <span class="operator">==</span> <span class="literal">nil</span>) &#123;</span><br><span class="line">        sectionController <span class="operator">=</span> [<span class="keyword">self</span>.sectionMap sectionControllerForSection:indexPath.section];</span><br><span class="line">        [<span class="keyword">self</span> mapView:view toSectionController:sectionController];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    id object <span class="operator">=</span> [<span class="keyword">self</span>.sectionMap objectForSection:indexPath.section];</span><br><span class="line">    <span class="comment">//通知对应的delegate</span></span><br><span class="line">    [<span class="keyword">self</span>.displayHandler willDisplaySupplementaryView:view forListAdapter:<span class="keyword">self</span> sectionController:sectionController object:object indexPath:indexPath];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="operator">-</span> (void)collectionView:(<span class="type">UICollectionView</span> <span class="operator">*</span>)collectionView didEndDisplayingSupplementaryView:(<span class="type">UICollectionReusableView</span> <span class="operator">*</span>)view forElementOfKind:(<span class="type">NSString</span> <span class="operator">*</span>)elementKind atIndexPath:(<span class="type">NSIndexPath</span> <span class="operator">*</span>)indexPath &#123;</span><br><span class="line">    <span class="comment">// 由于在IGListAdapterProxy会对这部分请求进行拦截，所以这里还需要将事件通知到collectionViewDelegate</span></span><br><span class="line">    id<span class="operator">&lt;</span><span class="type">UICollectionViewDelegate</span><span class="operator">&gt;</span> collectionViewDelegate <span class="operator">=</span> <span class="keyword">self</span>.collectionViewDelegate;</span><br><span class="line">    <span class="keyword">if</span> ([collectionViewDelegate respondsToSelector:<span class="meta">@selector</span>(collectionView:didEndDisplayingSupplementaryView:forElementOfKind:atIndexPath:)]) &#123;</span><br><span class="line">        [collectionViewDelegate collectionView:collectionView didEndDisplayingSupplementaryView:view forElementOfKind:elementKind atIndexPath:indexPath];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">IGListSectionController</span> <span class="operator">*</span>sectionController <span class="operator">=</span> [<span class="keyword">self</span> sectionControllerForView:view];</span><br><span class="line">    <span class="comment">//通知对应的delegate</span></span><br><span class="line">    [<span class="keyword">self</span>.displayHandler didEndDisplayingSupplementaryView:view forListAdapter:<span class="keyword">self</span> sectionController:sectionController indexPath:indexPath];</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span> removeMapForView:view];</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong><strong>工作区管理</strong></strong></p>
<p>对于工作区管理会在进入显示区的时候将当前的indexPath 信息添加到_visibleSectionIndices，退出可视区域的时候从_visibleSectionIndices中删除。然后根据workingRangeSize来确定起始和结束的index，根据确定的起始index和结束index将可见的sessionController添加到workingRangeSectionControllers，再通过新的workingRangeSectionControllers与旧的workingRangeSectionControllers进行对比，如果只出现再新的，而在老的没出现，这时候表示当前的sessionController为新进入工作区的，反之则为退出工作区的。</p>
<figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line">- (void)willDisplayItemAtIndexPath:(NSIndexPath *)indexPath</span><br><span class="line">                    forListAdapter:(IGListAdapter *)listAdapter &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 往_visibleSectionIndices中插入可见的NSIndexPath信息</span></span><br><span class="line">    <span class="variable">_visibleSectionIndices</span>.<span class="built_in">insert</span>(&#123;</span><br><span class="line">        .section = indexPath.section,</span><br><span class="line">        .row = indexPath.row,</span><br><span class="line">        .hash = indexPath.hash</span><br><span class="line">    &#125;);</span><br><span class="line">    [self <span class="variable">_updateWorkingRangesWithListAdapter</span>:listAdapter];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)didEndDisplayingItemAtIndexPath:(NSIndexPath *)indexPath</span><br><span class="line">                         forListAdapter:(IGListAdapter *)listAdapter &#123;</span><br><span class="line">    <span class="comment">//将将要移除到可见范围之外的cell的NSIndexPath从_visibleSectionIndices中移除</span></span><br><span class="line">    <span class="variable">_visibleSectionIndices</span>.erase(&#123;</span><br><span class="line">        .section = indexPath.section,</span><br><span class="line">        .row = indexPath.row,</span><br><span class="line">        .hash = indexPath.hash</span><br><span class="line">    &#125;);</span><br><span class="line">    [self <span class="variable">_updateWorkingRangesWithListAdapter</span>:listAdapter];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - Working Ranges</span></span><br><span class="line"></span><br><span class="line">- (void)<span class="variable">_updateWorkingRangesWithListAdapter</span>:(IGListAdapter *)listAdapter &#123;</span><br><span class="line">    IGAssertMainThread();</span><br><span class="line">    <span class="comment">// This method is optimized C++ to improve straight-line speed of these operations. Change at your peril.</span></span><br><span class="line">    <span class="comment">// We use a std::set because it is ordered.</span></span><br><span class="line">    std::<span class="built_in">set</span>&lt;NSInteger&gt; visibleSectionSet = std::<span class="built_in">set</span>&lt;NSInteger&gt;();</span><br><span class="line">    <span class="keyword">for</span> (const <span class="variable">_IGListWorkingRangeHandlerIndexPath</span> &amp;indexPath : <span class="variable">_visibleSectionIndices</span>) &#123;</span><br><span class="line">        visibleSectionSet.<span class="built_in">insert</span>(indexPath.section);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据workingRangeSize计算workingRange的start 和 end</span></span><br><span class="line">    NSInteger start;</span><br><span class="line">    NSInteger end;</span><br><span class="line">    <span class="keyword">if</span> (visibleSectionSet.<span class="built_in">size</span>() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// We&#x27;re now devoid of any visible sections. Bail</span></span><br><span class="line">        start = <span class="number">0</span>;</span><br><span class="line">        end = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        start = <span class="built_in">MAX</span>(*visibleSectionSet.begin() - <span class="variable">_workingRangeSize</span>, <span class="number">0</span>);</span><br><span class="line">        end = <span class="built_in">MIN</span>(*visibleSectionSet.rbegin() + <span class="number">1</span> + <span class="variable">_workingRangeSize</span>, (NSInteger)listAdapter.objects.<span class="built_in">count</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Build the current set of working range section controllers</span></span><br><span class="line">    <span class="comment">// 构建新的可见sessionController 集合</span></span><br><span class="line">    <span class="variable">_IGListWorkingRangeSectionControllerSet</span> workingRangeSectionControllers (visibleSectionSet.<span class="built_in">size</span>());</span><br><span class="line">    <span class="keyword">for</span> (NSInteger idx = start; idx &lt; end; idx++) &#123;</span><br><span class="line">        <span class="comment">//取出工作区中的sessionController</span></span><br><span class="line">        id item = [listAdapter objectAtSection:idx];</span><br><span class="line">        IGListSectionController *sectionController = [listAdapter sectionControllerForObject:item];</span><br><span class="line">        workingRangeSectionControllers.<span class="built_in">insert</span>(&#123;sectionController&#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//工作区不能大于1000</span></span><br><span class="line">    IGAssert(workingRangeSectionControllers.<span class="built_in">size</span>() &lt; <span class="number">1000</span>, @<span class="string">&quot;This algorithm is way too slow with so many objects:%lu&quot;</span>, workingRangeSectionControllers.<span class="built_in">size</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Tell any new section controllers that they have entered the working range</span></span><br><span class="line">    <span class="comment">// 从新的可见sessionController 集合中遍历每个元素看下是否在旧的存在，如果在旧的不存在 说明这个是新进入工作区的通知对应的sessionController</span></span><br><span class="line">    <span class="keyword">for</span> (const <span class="variable">_IGListWorkingRangeHandlerSectionControllerWrapper</span> &amp;wrapper : workingRangeSectionControllers) &#123;</span><br><span class="line">        <span class="comment">// Check if the item exists in the old working range item array.</span></span><br><span class="line">        auto it = <span class="variable">_workingRangeSectionControllers</span>.<span class="built_in">find</span>(wrapper);</span><br><span class="line">        <span class="keyword">if</span> (it == <span class="variable">_workingRangeSectionControllers</span>.end()) &#123;</span><br><span class="line">            <span class="comment">// The section controller isn&#x27;t in the existing list, so it&#x27;s new.</span></span><br><span class="line">            id &lt;IGListWorkingRangeDelegate&gt; workingRangeDelegate = wrapper.sectionController.workingRangeDelegate;</span><br><span class="line">            [workingRangeDelegate listAdapter:listAdapter sectionControllerWillEnterWorkingRange:wrapper.sectionController];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 同理处理退出工作区的事件</span></span><br><span class="line">    <span class="comment">// Tell any removed section controllers that they have exited the working range</span></span><br><span class="line">    <span class="keyword">for</span> (const <span class="variable">_IGListWorkingRangeHandlerSectionControllerWrapper</span> &amp;wrapper : <span class="variable">_workingRangeSectionControllers</span>) &#123;</span><br><span class="line">        <span class="comment">// Check if the item exists in the new list of section controllers</span></span><br><span class="line">        auto it = workingRangeSectionControllers.<span class="built_in">find</span>(wrapper);</span><br><span class="line">        <span class="keyword">if</span> (it == workingRangeSectionControllers.end()) &#123;</span><br><span class="line">            <span class="comment">// If the item does not exist in the new list, then it&#x27;s been removed.</span></span><br><span class="line">            id &lt;IGListWorkingRangeDelegate&gt; workingRangeDelegate = wrapper.sectionController.workingRangeDelegate;</span><br><span class="line">            [workingRangeDelegate listAdapter:listAdapter sectionControllerDidExitWorkingRange:wrapper.sectionController];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">_workingRangeSectionControllers</span> = workingRangeSectionControllers;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><strong>加载数据到UICollectionView</strong></strong></p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)reloadDataWithCompletion:(<span class="keyword">nullable</span> IGListUpdaterCompletion)completion &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">id</span>&lt;IGListAdapterDataSource&gt; dataSource = <span class="keyword">self</span>.dataSource;</span><br><span class="line">    <span class="built_in">UICollectionView</span> *collectionView = <span class="keyword">self</span>.collectionView;</span><br><span class="line">    <span class="comment">//.......</span></span><br><span class="line">    <span class="comment">//从数据源里面获取当前adapter的全部数据集</span></span><br><span class="line">    <span class="built_in">NSArray</span> *uniqueObjects = objectsWithDuplicateIdentifiersRemoved([dataSource objectsForListAdapter:<span class="keyword">self</span>]);</span><br><span class="line">    __<span class="keyword">weak</span> __typeof__(<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>;</span><br><span class="line">    <span class="comment">//调用updater 加载数据</span></span><br><span class="line">    [<span class="keyword">self</span>.updater reloadDataWithCollectionViewBlock:[<span class="keyword">self</span> _collectionViewBlock]</span><br><span class="line">                                  reloadUpdateBlock:^&#123;</span><br><span class="line">                                      <span class="comment">// purge all section controllers from the item map so that they are regenerated</span></span><br><span class="line">                                      [weakSelf.sectionMap reset];</span><br><span class="line">                                      [weakSelf _updateObjects:uniqueObjects dataSource:dataSource];</span><br><span class="line">                                  &#125; completion:^(<span class="type">BOOL</span> finished) &#123;</span><br><span class="line">                                      [weakSelf _notifyDidUpdate:IGListAdapterUpdateTypeReloadData animated:<span class="literal">NO</span>];</span><br><span class="line">                                      <span class="keyword">if</span> (completion) &#123;</span><br><span class="line">                                          completion(finished);</span><br><span class="line">                                      &#125;</span><br><span class="line">                                  &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在adapter调用加载数据的时候会先从datasource中获取到当前adapter全部sessionConstroller所需要的全部数据集。这些数据数据集被包裹reloadUpdateBlock，等到需要执行reloadUpdateBlock的时候更新Adapter里面的sessionMap等相关等数据集合，因为后面调用UICollectionView reloadData后会通过UICollectionView 的dateSource也就是 adapter中通过对应的代理方法从sessionController中获取数据。</p>
<p>完成上面的设置后就可以调用updater的reloadDataWithCollectionViewBlock进行数据加载。</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)reloadDataWithCollectionViewBlock:(IGListCollectionViewBlock)collectionViewBlock</span><br><span class="line">                   reloadUpdateBlock:(IGListReloadUpdateBlock)reloadUpdateBlock</span><br><span class="line">                          completion:(<span class="keyword">nullable</span> IGListUpdatingCompletion)completion &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//.......</span></span><br><span class="line">    <span class="comment">//将完成所需要调用的结束回调添加到completionBlocks</span></span><br><span class="line">    IGListUpdatingCompletion localCompletion = completion;</span><br><span class="line">    <span class="keyword">if</span> (localCompletion) &#123;</span><br><span class="line">        [<span class="keyword">self</span>.completionBlocks addObject:localCompletion];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">self</span>.reloadUpdates = reloadUpdateBlock;</span><br><span class="line">    <span class="keyword">self</span>.queuedReloadData = <span class="literal">YES</span>;</span><br><span class="line">    [<span class="keyword">self</span> _queueUpdateWithCollectionViewBlock:collectionViewBlock];</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>reloadDataWithCollectionViewBlock中会将queuedReloadData设置为YES,然后触发_queueUpdateWithCollectionViewBlock，在_queueUpdateWithCollectionViewBlock中由于queuedReloadData设置为YES，所以执行performReloadDataWithCollectionViewBlock</p>
<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">- (void)_queueUpdateWithCollectionViewBlock:(IGListCollectionViewBlock)collectionViewBlock &#123;</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        <span class="comment">//如果正在处于批量更新数据中，或者没有新的变更则直接返回</span></span><br><span class="line">        if (weakSelf.state != IGListBatchUpdateStateIdle</span><br><span class="line">            || ![weakSelf hasChanges]) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        if (weakSelf.hasQueuedReloadData) &#123;</span><br><span class="line">            <span class="comment">//执行加载</span></span><br><span class="line">            <span class="selector-attr">[weakSelf performReloadDataWithCollectionViewBlock:collectionViewBlock]</span>;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            <span class="comment">//批量加载</span></span><br><span class="line">            <span class="selector-attr">[weakSelf performBatchUpdatesWithCollectionViewBlock:collectionViewBlock]</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><strong>加载数据到UICollectionView</strong></strong></p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)performReloadDataWithCollectionViewBlock:(IGListCollectionViewBlock)collectionViewBlock &#123;</span><br><span class="line">    IGAssertMainThread();</span><br><span class="line"></span><br><span class="line">    <span class="type">id</span>&lt;IGListAdapterUpdaterDelegate&gt; delegate = <span class="keyword">self</span>.delegate;</span><br><span class="line">    <span class="type">void</span> (^reloadUpdates)(<span class="type">void</span>) = <span class="keyword">self</span>.reloadUpdates;</span><br><span class="line">    IGListBatchUpdates *batchUpdates = <span class="keyword">self</span>.batchUpdates;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *completionBlocks = [<span class="keyword">self</span>.completionBlocks mutableCopy];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//开始加载前清除相关的状态变量</span></span><br><span class="line">    [<span class="keyword">self</span> cleanStateBeforeUpdates];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//加载结束之后执行全部的completeBlock,并且将状态改为IGListBatchUpdateStateIdle</span></span><br><span class="line">    <span class="type">void</span> (^executeCompletionBlocks)(<span class="type">BOOL</span>) = ^(<span class="type">BOOL</span> finished) &#123;</span><br><span class="line">        <span class="keyword">for</span> (IGListUpdatingCompletion block <span class="keyword">in</span> completionBlocks) &#123;</span><br><span class="line">            block(finished);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.state = IGListBatchUpdateStateIdle;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 在更新任务还在队列的时候如果返回执行的时候发现collection已经被释放则重置对应的状态并调用completeBlock，将状态设置为IGListBatchUpdateStateIdle</span></span><br><span class="line">    <span class="built_in">UICollectionView</span> *collectionView = collectionViewBlock();</span><br><span class="line">    <span class="keyword">if</span> (collectionView == <span class="literal">nil</span>) &#123;</span><br><span class="line">        [<span class="keyword">self</span> _cleanStateAfterUpdates];</span><br><span class="line">        executeCompletionBlocks(<span class="literal">NO</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// item updates must not send mutations to the collection view while we are reloading</span></span><br><span class="line">    <span class="comment">// 将状态设置为正在加载数据</span></span><br><span class="line">    <span class="keyword">self</span>.state = IGListBatchUpdateStateExecutingBatchUpdateBlock;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//调用_updateObjects 重建object 和 sessionController之间的关系</span></span><br><span class="line">    <span class="keyword">if</span> (reloadUpdates) &#123;</span><br><span class="line">        reloadUpdates();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行批量更新中的单个更新block</span></span><br><span class="line">    <span class="comment">// execute all stored item update blocks even if we are just calling reloadData. the actual collection view</span></span><br><span class="line">    <span class="comment">// mutations will be discarded, but clients are encouraged to put their actual /data/ mutations inside the</span></span><br><span class="line">    <span class="comment">// update block as well, so if we don&#x27;t execute the block the changes will never happen</span></span><br><span class="line">    <span class="keyword">for</span> (IGListItemUpdateBlock itemUpdateBlock <span class="keyword">in</span> batchUpdates.itemUpdateBlocks) &#123;</span><br><span class="line">        itemUpdateBlock();</span><br><span class="line">    &#125;</span><br><span class="line">    [completionBlocks addObjectsFromArray:batchUpdates.itemCompletionBlocks];</span><br><span class="line">    <span class="keyword">self</span>.state = IGListBatchUpdateStateExecutedBatchUpdateBlock;</span><br><span class="line">    <span class="comment">//将状态设置为批量更新执行完毕</span></span><br><span class="line">    [<span class="keyword">self</span> _cleanStateAfterUpdates];</span><br><span class="line">    <span class="comment">//通知外部当前的UICollectionView即将开始加载数据</span></span><br><span class="line">    [delegate listAdapterUpdater:<span class="keyword">self</span> willReloadDataWithCollectionView:collectionView];</span><br><span class="line">    <span class="comment">//加载数据</span></span><br><span class="line">    [collectionView reloadData];</span><br><span class="line">    [collectionView.collectionViewLayout invalidateLayout];</span><br><span class="line">    [collectionView layoutIfNeeded];</span><br><span class="line">    <span class="comment">//通知外部当前的UICollectionView已经加载完数据</span></span><br><span class="line">    [delegate listAdapterUpdater:<span class="keyword">self</span> didReloadDataWithCollectionView:collectionView];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//执行完成后的block</span></span><br><span class="line">    executeCompletionBlocks(<span class="literal">YES</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>performReloadDataWithCollectionViewBlock方法中会执行传入的reloadUpdates以及batchUpdates.itemUpdateBlocks中对应的更新block然后在调用对应的<br>delegate 通知UICollectionView将要开始进行数据加载。然后调用[collectionView reloadData]加载数据。</p>
<p>调用[collectionView reloadData] 后便会触发UICollectionView的对应代理，由于IGListAdapter会对UICollectionView 的UICollectionViewDataSource 代理进行拦截，所以这些处理出现在IGListAdapter中：</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">NSInteger</span>)numberOfSectionsInCollectionView:(<span class="built_in">UICollectionView</span> *)collectionView &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.sectionMap.objects.count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSInteger</span>)collectionView:(<span class="built_in">UICollectionView</span> *)collectionView numberOfItemsInSection:(<span class="built_in">NSInteger</span>)section &#123;</span><br><span class="line">    IGListSectionController * sectionController = [<span class="keyword">self</span> sectionControllerForSection:section];</span><br><span class="line">    IGAssert(sectionController != <span class="literal">nil</span>, <span class="string">@&quot;Nil section controller for section %li for item %@. Check your -diffIdentifier and -isEqual: implementations.&quot;</span>,</span><br><span class="line">             (<span class="type">long</span>)section, [<span class="keyword">self</span>.sectionMap objectForSection:section]);</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">NSInteger</span> numberOfItems = [sectionController numberOfItems];</span><br><span class="line">    IGAssert(numberOfItems &gt;= <span class="number">0</span>, <span class="string">@&quot;Cannot return negative number of items %li for section controller %@.&quot;</span>, (<span class="type">long</span>)numberOfItems, sectionController);</span><br><span class="line">    <span class="keyword">return</span> numberOfItems;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UICollectionViewCell</span> *)collectionView:(<span class="built_in">UICollectionView</span> *)collectionView cellForItemAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath &#123;</span><br><span class="line">    <span class="type">id</span>&lt;IGListAdapterPerformanceDelegate&gt; performanceDelegate = <span class="keyword">self</span>.performanceDelegate;</span><br><span class="line">    [performanceDelegate listAdapterWillCallDequeueCell:<span class="keyword">self</span>];</span><br><span class="line">    IGListSectionController *sectionController = [<span class="keyword">self</span> sectionControllerForSection:indexPath.section];</span><br><span class="line">    <span class="comment">// flag that a cell is being dequeued in case it tries to access a cell in the process</span></span><br><span class="line">    _isDequeuingCell = <span class="literal">YES</span>;</span><br><span class="line">    <span class="built_in">UICollectionViewCell</span> *cell = [sectionController cellForItemAtIndex:indexPath.item];</span><br><span class="line">    _isDequeuingCell = <span class="literal">NO</span>;</span><br><span class="line">    IGAssert(cell != <span class="literal">nil</span>, <span class="string">@&quot;Returned a nil cell at indexPath &lt;%@&gt; from section controller: &lt;%@&gt;&quot;</span>, indexPath, sectionController);</span><br><span class="line">    <span class="comment">// associate the section controller with the cell so that we know which section controller is using it</span></span><br><span class="line">    [<span class="keyword">self</span> mapView:cell toSectionController:sectionController];</span><br><span class="line">    [performanceDelegate listAdapter:<span class="keyword">self</span> didCallDequeueCell:cell onSectionController:sectionController atIndex:indexPath.item];</span><br><span class="line">    <span class="keyword">return</span> cell;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这些方法大致思路是通过indexPath获取到对应的SessionController然后再通过SessionController中的方法获取对应的数据。</p>
<p><strong><strong>批量更新UICollectionView数据</strong></strong></p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)performUpdatesAnimated:(<span class="type">BOOL</span>)animated completion:(IGListUpdaterCompletion)completion &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//.......</span></span><br><span class="line">    <span class="type">id</span>&lt;IGListAdapterDataSource&gt; dataSource = <span class="keyword">self</span>.dataSource;</span><br><span class="line">    <span class="built_in">UICollectionView</span> *collectionView = <span class="keyword">self</span>.collectionView;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="comment">//旧的数据源</span></span><br><span class="line">    <span class="built_in">NSArray</span> *fromObjects = <span class="keyword">self</span>.sectionMap.objects;</span><br><span class="line"></span><br><span class="line">    IGListToObjectBlock toObjectsBlock;</span><br><span class="line">    __<span class="keyword">weak</span> __typeof__(<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>;</span><br><span class="line">    <span class="keyword">if</span> (IGListExperimentEnabled(<span class="keyword">self</span>.experiments, IGListExperimentDeferredToObjectCreation)) &#123;</span><br><span class="line">        toObjectsBlock = ^<span class="built_in">NSArray</span> *&#123;</span><br><span class="line">            __typeof__(<span class="keyword">self</span>) strongSelf = weakSelf;</span><br><span class="line">            <span class="keyword">if</span> (strongSelf == <span class="literal">nil</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> [dataSource objectsForListAdapter:strongSelf];</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//从dataSource中获取最新的数据源</span></span><br><span class="line">        <span class="built_in">NSArray</span> *newObjects = [dataSource objectsForListAdapter:<span class="keyword">self</span>];</span><br><span class="line">        toObjectsBlock = ^<span class="built_in">NSArray</span> *&#123;</span><br><span class="line">            <span class="keyword">return</span> newObjects;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span> _enterBatchUpdates];</span><br><span class="line">    [<span class="keyword">self</span>.updater performUpdateWithCollectionViewBlock:[<span class="keyword">self</span> _collectionViewBlock]</span><br><span class="line">                                           fromObjects:fromObjects</span><br><span class="line">                                        toObjectsBlock:toObjectsBlock</span><br><span class="line">                                              animated:animated</span><br><span class="line">                                 objectTransitionBlock:^(<span class="built_in">NSArray</span> *toObjects) &#123;</span><br><span class="line">                                     <span class="comment">// 更新数据源</span></span><br><span class="line">                                     weakSelf.previousSectionMap = [weakSelf.sectionMap <span class="keyword">copy</span>];</span><br><span class="line">                                     [weakSelf _updateObjects:toObjects dataSource:dataSource];</span><br><span class="line">                                 &#125; completion:^(<span class="type">BOOL</span> finished) &#123;</span><br><span class="line">                                     weakSelf.previousSectionMap = <span class="literal">nil</span>;</span><br><span class="line">                                     [weakSelf _notifyDidUpdate:IGListAdapterUpdateTypePerformUpdates animated:animated];</span><br><span class="line">                                     <span class="keyword">if</span> (completion) &#123;</span><br><span class="line">                                         completion(finished);</span><br><span class="line">                                     &#125;</span><br><span class="line">                                     [weakSelf _exitBatchUpdates];</span><br><span class="line">                                 &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight pf"><table><tr><td class="code"><pre><span class="line">- (void)performUpdateWithCollectionViewBlock:(IGListCollectionViewBlock)collectionViewBlock</span><br><span class="line">                            <span class="keyword">from</span>Objects:(NSArray *)<span class="keyword">from</span>Objects</span><br><span class="line">                         <span class="keyword">to</span>ObjectsBlock:(IGListToObjectBlock)<span class="keyword">to</span>ObjectsBlock</span><br><span class="line">                               animated:(BOOL)animated</span><br><span class="line">                  objectTransitionBlock:(IGListObjectTransitionBlock)objectTransitionBlock</span><br><span class="line">                             completion:(IGListUpdatingCompletion)completion &#123;</span><br><span class="line">    </span><br><span class="line">    //........</span><br><span class="line">    <span class="literal">self</span>.<span class="keyword">from</span>Objects = <span class="literal">self</span>.<span class="keyword">from</span>Objects ?: <span class="literal">self</span>.pendingTransitionToObjects ?: <span class="keyword">from</span>Objects;</span><br><span class="line">    <span class="literal">self</span>.<span class="keyword">to</span>ObjectsBlock = <span class="keyword">to</span>ObjectsBlock;</span><br><span class="line"></span><br><span class="line">    <span class="literal">self</span>.queuedUpdateIsAnimated = <span class="literal">self</span>.queuedUpdateIsAnimated &amp;&amp; animated;</span><br><span class="line">    <span class="literal">self</span>.objectTransitionBlock = objectTransitionBlock;</span><br><span class="line"></span><br><span class="line">    IGListUpdatingCompletion localCompletion = completion;</span><br><span class="line">    if (localCompletion) &#123;</span><br><span class="line">        [<span class="literal">self</span>.completionBlocks addObject:localCompletion];</span><br><span class="line">    &#125;</span><br><span class="line">    [<span class="literal">self</span> _queueUpdateWithCollectionViewBlock:collectionViewBlock];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)_queueUpdateWithCollectionViewBlock:(IGListCollectionViewBlock)collectionViewBlock &#123;</span><br><span class="line">    __weak __typeof__(<span class="literal">self</span>) weakSelf = <span class="literal">self</span>;</span><br><span class="line">    dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        if (weakSelf.<span class="keyword">state</span> != IGListBatchUpdateStateIdle</span><br><span class="line">            || ![weakSelf hasChanges]) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        if (weakSelf.hasQueuedReloadData) &#123;</span><br><span class="line">            [weakSelf performReloadDataWithCollectionViewBlock:collectionViewBlock];</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //更新的时候走这里</span><br><span class="line">            [weakSelf performBatchUpdatesWithCollectionViewBlock:collectionViewBlock];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)performBatchUpdatesWithCollectionViewBlock:(IGListCollectionViewBlock)collectionViewBlock &#123;</span><br><span class="line">    <span class="comment">//........</span></span><br><span class="line">    <span class="comment">// create local variables so we can immediately clean our state but pass these items into the batch update block</span></span><br><span class="line">    <span class="type">id</span>&lt;IGListAdapterUpdaterDelegate&gt; delegate = <span class="keyword">self</span>.delegate;</span><br><span class="line">    <span class="built_in">NSArray</span> *fromObjects = [<span class="keyword">self</span>.fromObjects <span class="keyword">copy</span>];</span><br><span class="line">    IGListToObjectBlock toObjectsBlock = [<span class="keyword">self</span>.toObjectsBlock <span class="keyword">copy</span>];</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *completionBlocks = [<span class="keyword">self</span>.completionBlocks mutableCopy];</span><br><span class="line">    <span class="type">void</span> (^objectTransitionBlock)(<span class="built_in">NSArray</span> *) = [<span class="keyword">self</span>.objectTransitionBlock <span class="keyword">copy</span>];</span><br><span class="line">    <span class="keyword">const</span> <span class="type">BOOL</span> animated = <span class="keyword">self</span>.queuedUpdateIsAnimated;</span><br><span class="line">    IGListBatchUpdates *batchUpdates = <span class="keyword">self</span>.batchUpdates;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在更新前重置状态为初始状态</span></span><br><span class="line">    <span class="comment">// clean up all state so that new updates can be coalesced while the current update is in flight</span></span><br><span class="line">    [<span class="keyword">self</span> cleanStateBeforeUpdates];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新完成之后的回调</span></span><br><span class="line">    <span class="type">void</span> (^executeCompletionBlocks)(<span class="type">BOOL</span>) = ^(<span class="type">BOOL</span> finished) &#123;</span><br><span class="line">        <span class="keyword">self</span>.applyingUpdateData = <span class="literal">nil</span>;</span><br><span class="line">        <span class="keyword">self</span>.state = IGListBatchUpdateStateIdle;</span><br><span class="line">        <span class="keyword">for</span> (IGListUpdatingCompletion block <span class="keyword">in</span> completionBlocks) &#123;</span><br><span class="line">            block(finished);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//.......</span></span><br><span class="line">    <span class="built_in">NSArray</span> *toObjects = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">if</span> (toObjectsBlock != <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="comment">//剔除掉重复数据</span></span><br><span class="line">        toObjects = objectsWithDuplicateIdentifiersRemoved(toObjectsBlock());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数据刷新的闭包</span></span><br><span class="line">    <span class="type">void</span> (^executeUpdateBlocks)(<span class="type">void</span>) = ^&#123;</span><br><span class="line">        <span class="keyword">self</span>.state = IGListBatchUpdateStateExecutingBatchUpdateBlock;</span><br><span class="line">        <span class="comment">// 更新包括 IGListAdapter 的 sectionController 和 objects 的映射关系等数据，保证执行刷新前数据已经是最新的</span></span><br><span class="line">        <span class="keyword">if</span> (objectTransitionBlock != <span class="literal">nil</span>) &#123;</span><br><span class="line">            objectTransitionBlock(toObjects);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 触发批量刷新任务的数据更新闭包（包括插入、删除、刷新单个 section 的数据）objectTransitionBlock 之后执行是为了保证 section 级别的刷新在 item 级别刷新之前进行</span></span><br><span class="line">        <span class="keyword">for</span> (IGListItemUpdateBlock itemUpdateBlock <span class="keyword">in</span> batchUpdates.itemUpdateBlocks) &#123;</span><br><span class="line">            itemUpdateBlock();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//收集批量刷新完成的回调，后续所有操作完了之后一并处理</span></span><br><span class="line">        [completionBlocks addObjectsFromArray:batchUpdates.itemCompletionBlocks];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.state = IGListBatchUpdateStateExecutedBatchUpdateBlock;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行全量的数据更新并刷新 UI</span></span><br><span class="line">    <span class="type">void</span> (^reloadDataFallback)(<span class="type">void</span>) = ^&#123;</span><br><span class="line">        <span class="comment">//执行更新</span></span><br><span class="line">        executeUpdateBlocks();</span><br><span class="line">        <span class="comment">//清除batchUpdates</span></span><br><span class="line">        [<span class="keyword">self</span> _cleanStateAfterUpdates];</span><br><span class="line">        [<span class="keyword">self</span> _performBatchUpdatesItemBlockApplied];</span><br><span class="line">        <span class="comment">//加载数据</span></span><br><span class="line">        [collectionView reloadData];</span><br><span class="line">        [collectionView layoutIfNeeded];</span><br><span class="line">        executeCompletionBlocks(<span class="literal">YES</span>);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.allowsBackgroundReloading &amp;&amp; collectionView.window == <span class="literal">nil</span>) &#123;</span><br><span class="line">        [<span class="keyword">self</span> _beginPerformBatchUpdatesToObjects:toObjects];</span><br><span class="line">        reloadDataFallback();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// disables multiple performBatchUpdates: from happening at the same time</span></span><br><span class="line">    [<span class="keyword">self</span> _beginPerformBatchUpdatesToObjects:toObjects];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> IGListExperiment experiments = <span class="keyword">self</span>.experiments;</span><br><span class="line"></span><br><span class="line">    IGListIndexSetResult *(^performDiff)(<span class="type">void</span>) = ^&#123;</span><br><span class="line">        <span class="keyword">return</span> IGListDiffExperiment(fromObjects, toObjects, IGListDiffEquality, experiments);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// block executed in the first param block of -[UICollectionView performBatchUpdates:completion:]</span></span><br><span class="line">    <span class="type">void</span> (^batchUpdatesBlock)(IGListIndexSetResult *result) = ^(IGListIndexSetResult *result)&#123;</span><br><span class="line">        <span class="comment">//执行更新</span></span><br><span class="line">        executeUpdateBlocks();</span><br><span class="line">        <span class="keyword">self</span>.applyingUpdateData = [<span class="keyword">self</span> _flushCollectionView:collectionView</span><br><span class="line">                                              withDiffResult:result</span><br><span class="line">                                                batchUpdates:<span class="keyword">self</span>.batchUpdates</span><br><span class="line">                                                 fromObjects:fromObjects];</span><br><span class="line">        <span class="comment">//重置状态</span></span><br><span class="line">        [<span class="keyword">self</span> _cleanStateAfterUpdates];</span><br><span class="line">        [<span class="keyword">self</span> _performBatchUpdatesItemBlockApplied];</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// block used as the second param of -[UICollectionView performBatchUpdates:completion:]</span></span><br><span class="line">    <span class="type">void</span> (^batchUpdatesCompletionBlock)(<span class="type">BOOL</span>) = ^(<span class="type">BOOL</span> finished) &#123;</span><br><span class="line">        IGListBatchUpdateData *oldApplyingUpdateData = <span class="keyword">self</span>.applyingUpdateData;</span><br><span class="line">        executeCompletionBlocks(finished);</span><br><span class="line"></span><br><span class="line">        [delegate listAdapterUpdater:<span class="keyword">self</span> didPerformBatchUpdates:oldApplyingUpdateData collectionView:collectionView];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// queue another update in case something changed during batch updates. this method will bail next runloop if</span></span><br><span class="line">        <span class="comment">// there are no changes</span></span><br><span class="line">        [<span class="keyword">self</span> _queueUpdateWithCollectionViewBlock:collectionViewBlock];</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// block that executes the batch update and exception handling</span></span><br><span class="line">    <span class="type">void</span> (^performUpdate)(IGListIndexSetResult *) = ^(IGListIndexSetResult *result)&#123;</span><br><span class="line">        [collectionView layoutIfNeeded];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">@try</span> &#123;</span><br><span class="line">            <span class="comment">// 对外通知即将进行 batch update</span></span><br><span class="line">            [delegate  listAdapterUpdater:<span class="keyword">self</span></span><br><span class="line">willPerformBatchUpdatesWithCollectionView:collectionView</span><br><span class="line">                              fromObjects:fromObjects</span><br><span class="line">                                toObjects:toObjects</span><br><span class="line">                       listIndexSetResult:result];</span><br><span class="line">            <span class="keyword">if</span> (collectionView.dataSource == <span class="literal">nil</span>) &#123;</span><br><span class="line">                <span class="comment">// 如果数据源为空则不再刷新的 UICollectionview</span></span><br><span class="line">                batchUpdatesCompletionBlock(<span class="literal">NO</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result.changeCount &gt; <span class="number">100</span> &amp;&amp; IGListExperimentEnabled(experiments, IGListExperimentReloadDataFallback)) &#123;</span><br><span class="line">                <span class="comment">// 如果变化数量超过100，进行全量刷新</span></span><br><span class="line">                reloadDataFallback();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (animated) &#123;</span><br><span class="line">                <span class="comment">//执行更新的批量动画</span></span><br><span class="line">                [collectionView performBatchUpdates:^&#123;</span><br><span class="line">                    batchUpdatesBlock(result);</span><br><span class="line">                &#125; completion:batchUpdatesCompletionBlock];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                [<span class="built_in">CATransaction</span> begin];</span><br><span class="line">                [<span class="built_in">CATransaction</span> setDisableActions:<span class="literal">YES</span>];</span><br><span class="line">                [collectionView performBatchUpdates:^&#123;</span><br><span class="line">                    batchUpdatesBlock(result);</span><br><span class="line">                &#125; completion:^(<span class="type">BOOL</span> finished) &#123;</span><br><span class="line">                    [<span class="built_in">CATransaction</span> commit];</span><br><span class="line">                    batchUpdatesCompletionBlock(finished);</span><br><span class="line">                &#125;];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">@catch</span> (<span class="built_in">NSException</span> *exception) &#123;</span><br><span class="line">            [delegate listAdapterUpdater:<span class="keyword">self</span></span><br><span class="line">                          collectionView:collectionView</span><br><span class="line">                  willCrashWithException:exception</span><br><span class="line">                             fromObjects:fromObjects</span><br><span class="line">                               toObjects:toObjects</span><br><span class="line">                              diffResult:result</span><br><span class="line">                                 updates:(<span class="type">id</span>)<span class="keyword">self</span>.applyingUpdateData];</span><br><span class="line">            <span class="keyword">@throw</span> exception;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (IGListExperimentEnabled(experiments, IGListExperimentBackgroundDiffing)) &#123;</span><br><span class="line">        <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(QOS_CLASS_USER_INITIATED, <span class="number">0</span>), ^&#123;</span><br><span class="line">            IGListIndexSetResult *result = performDiff();</span><br><span class="line">            <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                performUpdate(result);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        IGListIndexSetResult *result = performDiff();</span><br><span class="line">        performUpdate(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>批量更新这部分细节有点多，这里归纳如下：</p>
<p>如果allowsBackgroundReloading为YES,也就是说允许后台加载数据的情况下如果collectionView不显示，则跳过数据diff和批量更新直接进行全量加载刷新。否则在子线程调用performDiff() 通过 IGListDiffExperiment 计算数据的变化，然后在主线程调用performUpdate进行批量更新操作：<br>在performUpdate开始的时候先通过代理对外通知即将进行 batch update 批量更新，紧接着判断如果 collectionView 的 dataSource 为 nil，结束更新过程，如果变化的数据个数超过100，就不进行批量更新了直接调用 reloadData 全量刷新数据；如果变化数据小于100，则调用 <strong><strong>-[UICollectionView performBatchUpdates:completion:]</strong></strong> 批量刷新数据，刷新过程中会调用 <strong><strong>-_flushCollectionView:withDiffResult:batchUpdates:fromObjects:</strong></strong> 将数据源提供的数据和 diff 结果包装成批量更新的数据类型 IGListBatchUpdateData 以便 UICollectionView 进行读取。这里最关键的代码在****_flushCollectionView****</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="operator">-</span> (<span class="type">IGListBatchUpdateData</span> <span class="operator">*</span>)_flushCollectionView:(<span class="type">UICollectionView</span> <span class="operator">*</span>)collectionView</span><br><span class="line">                                withDiffResult:(<span class="type">IGListIndexSetResult</span> <span class="operator">*</span>)diffResult</span><br><span class="line">                                  batchUpdates:(<span class="type">IGListBatchUpdates</span> <span class="operator">*</span>)batchUpdates</span><br><span class="line">                                   fromObjects:(<span class="type">NSArray</span> <span class="operator">&lt;</span>id<span class="operator">&lt;</span><span class="type">IGListDiffable</span><span class="operator">&gt;&gt;</span> <span class="operator">*</span>)fromObjects &#123;</span><br><span class="line">    <span class="comment">//移动session</span></span><br><span class="line">    <span class="type">NSSet</span> <span class="operator">*</span>moves <span class="operator">=</span> [[<span class="type">NSSet</span> alloc] initWithArray:diffResult.moves];</span><br><span class="line">    <span class="comment">//reload的item：合并通过diff和通过reloadItems手动reloads的session</span></span><br><span class="line">    <span class="type">NSMutableIndexSet</span> <span class="operator">*</span>reloads <span class="operator">=</span> [diffResult.updates mutableCopy];</span><br><span class="line">    [reloads addIndexes:batchUpdates.sectionReloads];</span><br><span class="line">    <span class="comment">//插入的session</span></span><br><span class="line">    <span class="type">NSMutableIndexSet</span> <span class="operator">*</span>inserts <span class="operator">=</span> [diffResult.inserts mutableCopy];</span><br><span class="line">    <span class="comment">//删除的session</span></span><br><span class="line">    <span class="type">NSMutableIndexSet</span> <span class="operator">*</span>deletes <span class="operator">=</span> [diffResult.deletes mutableCopy];</span><br><span class="line">    <span class="type">NSMutableArray</span>&lt;<span class="type">NSIndexPath</span> *&gt; <span class="operator">*</span>itemUpdates <span class="operator">=</span> [<span class="type">NSMutableArray</span> new];</span><br><span class="line">    <span class="comment">//如果movesAsDeletesInserts = YES 那么就将moves中的转换为deletes和inserts操作</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.movesAsDeletesInserts) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">IGListMoveIndex</span> <span class="operator">*</span>move <span class="keyword">in</span> moves) &#123;</span><br><span class="line">            [deletes addIndex:move.from];</span><br><span class="line">            [inserts addIndex:move.to];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// clear out all moves</span></span><br><span class="line">        moves <span class="operator">=</span> [<span class="type">NSSet</span> new];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Item reloads are not safe, if any section moves happened or there are inserts/deletes.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.preferItemReloadsForSectionReloads</span><br><span class="line">        <span class="operator">&amp;&amp;</span> moves.count <span class="operator">==</span> <span class="number">0</span> <span class="operator">&amp;&amp;</span> inserts.count <span class="operator">==</span> <span class="number">0</span> <span class="operator">&amp;&amp;</span> deletes.count <span class="operator">==</span> <span class="number">0</span> <span class="operator">&amp;&amp;</span> reloads.count <span class="operator">&gt;</span> <span class="number">0</span>) &#123;</span><br><span class="line">        [reloads enumerateIndexesUsingBlock:<span class="operator">^</span>(<span class="type">NSUInteger</span> sectionIndex, <span class="type">BOOL</span> <span class="operator">*</span> _Nonnull stop) &#123;</span><br><span class="line">            <span class="type">NSMutableIndexSet</span> <span class="operator">*</span>localIndexSet <span class="operator">=</span> [<span class="type">NSMutableIndexSet</span> indexSetWithIndex:sectionIndex];</span><br><span class="line">            <span class="keyword">if</span> (sectionIndex <span class="operator">&lt;</span> [collectionView numberOfSections]</span><br><span class="line">                <span class="operator">&amp;&amp;</span> sectionIndex <span class="operator">&lt;</span> [collectionView.dataSource numberOfSectionsInCollectionView:collectionView]</span><br><span class="line">                <span class="operator">&amp;&amp;</span> [collectionView numberOfItemsInSection:sectionIndex] <span class="operator">==</span> [collectionView.dataSource collectionView:collectionView numberOfItemsInSection:sectionIndex]) &#123;</span><br><span class="line">                <span class="comment">// Perfer to do item reloads instead, if the number of items in section is unchanged.</span></span><br><span class="line">                [itemUpdates addObjectsFromArray:convertSectionReloadToItemUpdates(localIndexSet, collectionView)];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Otherwise, fallback to convert into delete+insert section operation.</span></span><br><span class="line">                convertReloadToDeleteInsert(localIndexSet, deletes, inserts, diffResult, fromObjects);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 在performBatchUpdates中使用reloadSections是不安全的，所以需要将reloads转换为deletes+inserts</span></span><br><span class="line">        convertReloadToDeleteInsert(reloads, deletes, inserts, diffResult, fromObjects);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//插入，删除，移动 item处理</span></span><br><span class="line">    <span class="type">NSMutableArray</span>&lt;<span class="type">NSIndexPath</span> *&gt; <span class="operator">*</span>itemInserts <span class="operator">=</span> batchUpdates.itemInserts;</span><br><span class="line">    <span class="type">NSMutableArray</span>&lt;<span class="type">NSIndexPath</span> *&gt; <span class="operator">*</span>itemDeletes <span class="operator">=</span> batchUpdates.itemDeletes;</span><br><span class="line">    <span class="type">NSMutableArray</span>&lt;<span class="type">IGListMoveIndexPath</span> *&gt; <span class="operator">*</span>itemMoves <span class="operator">=</span> batchUpdates.itemMoves;</span><br><span class="line"></span><br><span class="line">    <span class="type">NSSet</span>&lt;<span class="type">NSIndexPath</span> *&gt; <span class="operator">*</span>uniqueDeletes <span class="operator">=</span> [<span class="type">NSSet</span> setWithArray:itemDeletes];</span><br><span class="line">    <span class="type">NSMutableSet</span>&lt;<span class="type">NSIndexPath</span> *&gt; <span class="operator">*</span>reloadDeletePaths <span class="operator">=</span> [<span class="type">NSMutableSet</span> new];</span><br><span class="line">    <span class="type">NSMutableSet</span>&lt;<span class="type">NSIndexPath</span> *&gt; <span class="operator">*</span>reloadInsertPaths <span class="operator">=</span> [<span class="type">NSMutableSet</span> new];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">IGListReloadIndexPath</span> <span class="operator">*</span>reload <span class="keyword">in</span> batchUpdates.itemReloads) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="operator">!</span>[uniqueDeletes containsObject:reload.fromIndexPath]) &#123;</span><br><span class="line">            [reloadDeletePaths addObject:reload.fromIndexPath];</span><br><span class="line">            [reloadInsertPaths addObject:reload.toIndexPath];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    [itemDeletes addObjectsFromArray:[reloadDeletePaths allObjects]];</span><br><span class="line">    [itemInserts addObjectsFromArray:[reloadInsertPaths allObjects]];</span><br><span class="line"></span><br><span class="line">    const <span class="type">BOOL</span> fixIndexPathImbalance <span class="operator">=</span> <span class="type">IGListExperimentEnabled</span>(<span class="keyword">self</span>.experiments, <span class="type">IGListExperimentFixIndexPathImbalance</span>);</span><br><span class="line">    <span class="type">IGListBatchUpdateData</span> <span class="operator">*</span>updateData <span class="operator">=</span> [[<span class="type">IGListBatchUpdateData</span> alloc] initWithInsertSections:inserts</span><br><span class="line">                                                                               deleteSections:deletes</span><br><span class="line">                                                                                 moveSections:moves</span><br><span class="line">                                                                             insertIndexPaths:itemInserts</span><br><span class="line">                                                                             deleteIndexPaths:itemDeletes</span><br><span class="line">                                                                             updateIndexPaths:itemUpdates</span><br><span class="line">                                                                               moveIndexPaths:itemMoves</span><br><span class="line">                                                                        fixIndexPathImbalance:fixIndexPathImbalance];</span><br><span class="line">    [collectionView ig_applyBatchUpdateData:updateData];</span><br><span class="line">    <span class="keyword">return</span> updateData;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="operator">-</span> (void)ig_applyBatchUpdateData:(<span class="type">IGListBatchUpdateData</span> <span class="operator">*</span>)updateData &#123;    </span><br><span class="line">    [<span class="keyword">self</span> deleteItemsAtIndexPaths:updateData.deleteIndexPaths];</span><br><span class="line">    [<span class="keyword">self</span> insertItemsAtIndexPaths:updateData.insertIndexPaths];</span><br><span class="line">    [<span class="keyword">self</span> reloadItemsAtIndexPaths:updateData.updateIndexPaths];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">IGListMoveIndexPath</span> <span class="operator">*</span>move <span class="keyword">in</span> updateData.moveIndexPaths) &#123;</span><br><span class="line">        [<span class="keyword">self</span> moveItemAtIndexPath:move.from toIndexPath:move.to];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">IGListMoveIndex</span> <span class="operator">*</span>move <span class="keyword">in</span> updateData.moveSections) &#123;</span><br><span class="line">        [<span class="keyword">self</span> moveSection:move.from toSection:move.to];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span> deleteSections:updateData.deleteSections];</span><br><span class="line">    [<span class="keyword">self</span> insertSections:updateData.insertSections];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在_flushCollectionView中会对手动添加的批量操作和通过diff算法确定的更新操作统一转换为对session的insert,delete,reload的操作，最后调用UICollectionView的<strong><strong>deleteItemsAtIndexPaths</strong></strong>，<strong><strong>insertItemsAtIndexPaths</strong></strong>，<strong><strong>reloadItemsAtIndexPaths</strong></strong>，<strong><strong>moveItemAtIndexPath</strong></strong>，<strong><strong>moveSection</strong></strong>，<strong><strong>deleteSections</strong></strong>，<strong><strong>insertSections</strong></strong>。对UICollectionView进行更新。</p>
<p><strong><strong>IGListSectionController</strong></strong></p>
<p>IGListSectionController 在IGListKit中也是一个十分关键的对象，我们先来看下它拥有的属性：</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">IGListSectionController</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> Session中的item数量</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">- (<span class="built_in">NSInteger</span>)numberOfItems;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 指定index位置上的item尺寸</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="built_in">CGSize</span>)sizeForItemAtIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  返回指定位置的Cell对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (__kindof <span class="built_in">UICollectionViewCell</span> *)cellForItemAtIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  从外界注入该Session所拥有的整个对象数组</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="type">void</span>)didUpdateToObject:(<span class="type">id</span>)object;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)didSelectItemAtIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line">- (<span class="type">void</span>)didDeselectItemAtIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line">- (<span class="type">void</span>)didHighlightItemAtIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line">- (<span class="type">void</span>)didUnhighlightItemAtIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">- (<span class="type">BOOL</span>)canMoveItemAtIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line">- (<span class="type">void</span>)moveObjectFromIndex:(<span class="built_in">NSInteger</span>)sourceIndex toIndex:(<span class="built_in">NSInteger</span>)destinationIndex <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">9</span>_0);</span><br><span class="line">    </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 持有创建该SessionController的Adapter的ViewController</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>, <span class="keyword">nullable</span>, <span class="keyword">readonly</span>) <span class="built_in">UIViewController</span> *viewController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 与collectionView 交互的上下文</span></span><br><span class="line"><span class="comment"> Use this property for accessing the collection size, dequeuing cells, reloading, inserting, deleting, etc.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>, <span class="keyword">nullable</span>, <span class="keyword">readonly</span>) <span class="type">id</span> &lt;IGListCollectionContext&gt; collectionContext;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 当前sessionController对应的session</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) <span class="built_in">NSInteger</span> section;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) <span class="type">BOOL</span> isFirstSection;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) <span class="type">BOOL</span> isLastSection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">UIEdgeInsets</span> inset;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">CGFloat</span> minimumLineSpacing;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">CGFloat</span> minimumInteritemSpacing;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>, <span class="keyword">nullable</span>) <span class="type">id</span> &lt;IGListSupplementaryViewSource&gt; supplementaryViewSource;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    section controller 的显示事件代理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>, <span class="keyword">nullable</span>) <span class="type">id</span> &lt;IGListDisplayDelegate&gt; displayDelegate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    section controller 的working range事件代理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>, <span class="keyword">nullable</span>) <span class="type">id</span> &lt;IGListWorkingRangeDelegate&gt; workingRangeDelegate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    section controller 的滚动事件代理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>, <span class="keyword">nullable</span>) <span class="type">id</span> &lt;IGListScrollDelegate&gt; scrollDelegate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>, <span class="keyword">nullable</span>) <span class="type">id</span>&lt;IGListTransitionDelegate&gt; transitionDelegate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>从上面上看外部主要通过didUpdateToObject将数据注入到IGListSectionController，然后通过<strong><strong>numberOfItems</strong></strong>，<strong><strong>sizeForItemAtIndex</strong></strong>，<strong><strong>cellForItemAtIndex</strong></strong>，<strong><strong>supplementaryViewSource</strong></strong> 分别指定item数量，尺寸，cell实例，SessionController的header，footer。以及通过collectionContext和UICollectionView进行交互，</p>
<p>我们最后来看下IGListCollectionContext，它也是一个比较重要的类，我们在确定sessionController的时候用得比较多。</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">IGListCollectionContext</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">CGSize</span> containerSize;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">UIEdgeInsets</span> containerInset;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">UIEdgeInsets</span> adjustedContainerInset;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">CGSize</span> insetContainerSize;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">CGSize</span>)containerSizeForSectionController:(IGListSectionController *)sectionController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) IGListCollectionScrollingTraits scrollingTraits;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) IGListExperiment experiments;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSInteger</span>)indexForCell:(<span class="built_in">UICollectionViewCell</span> *)cell</span><br><span class="line">        sectionController:(IGListSectionController *)sectionController;</span><br><span class="line">- (<span class="keyword">nullable</span> __kindof <span class="built_in">UICollectionViewCell</span> *)cellForItemAtIndex:(<span class="built_in">NSInteger</span>)index</span><br><span class="line">                                             sectionController:(IGListSectionController *)sectionController;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSArray</span>&lt;<span class="built_in">UICollectionViewCell</span> *&gt; *)visibleCellsForSectionController:(IGListSectionController *)sectionController;</span><br><span class="line">- (<span class="built_in">NSArray</span>&lt;<span class="built_in">NSIndexPath</span> *&gt; *)visibleIndexPathsForSectionController:(IGListSectionController *) sectionController;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)deselectItemAtIndex:(<span class="built_in">NSInteger</span>)index</span><br><span class="line">          sectionController:(IGListSectionController *)sectionController</span><br><span class="line">                   animated:(<span class="type">BOOL</span>)animated;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)selectItemAtIndex:(<span class="built_in">NSInteger</span>)index</span><br><span class="line">        sectionController:(IGListSectionController *)sectionController</span><br><span class="line">                 animated:(<span class="type">BOOL</span>)animated</span><br><span class="line">           scrollPosition:(<span class="built_in">UICollectionViewScrollPosition</span>)scrollPosition;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (__kindof <span class="built_in">UICollectionViewCell</span> *)dequeueReusableCellOfClass:(Class)cellClass</span><br><span class="line">                                          withReuseIdentifier:(<span class="keyword">nullable</span> <span class="built_in">NSString</span> *)reuseIdentifier</span><br><span class="line">                                         forSectionController:(IGListSectionController *)sectionController</span><br><span class="line">                                                      atIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line">- (__kindof <span class="built_in">UICollectionViewCell</span> *)dequeueReusableCellOfClass:(Class)cellClass</span><br><span class="line">                                         forSectionController:(IGListSectionController *)sectionController</span><br><span class="line">                                                      atIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line">- (__kindof <span class="built_in">UICollectionViewCell</span> *)dequeueReusableCellWithNibName:(<span class="built_in">NSString</span> *)nibName</span><br><span class="line">                                                           bundle:(<span class="keyword">nullable</span> <span class="built_in">NSBundle</span> *)bundle</span><br><span class="line">                                             forSectionController:(IGListSectionController *)sectionController</span><br><span class="line">                                                          atIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line">- (__kindof <span class="built_in">UICollectionViewCell</span> *)dequeueReusableCellFromStoryboardWithIdentifier:(<span class="built_in">NSString</span> *)identifier</span><br><span class="line">                                                              forSectionController:(IGListSectionController *)sectionController</span><br><span class="line">                                                                           atIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line">- (__kindof <span class="built_in">UICollectionReusableView</span> *)dequeueReusableSupplementaryViewOfKind:(<span class="built_in">NSString</span> *)elementKind</span><br><span class="line">                                                         forSectionController:(IGListSectionController *)sectionController</span><br><span class="line">                                                                        <span class="keyword">class</span>:(Class)viewClass</span><br><span class="line">                                                                      atIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line">- (__kindof <span class="built_in">UICollectionReusableView</span> *)dequeueReusableSupplementaryViewFromStoryboardOfKind:(<span class="built_in">NSString</span> *)elementKind</span><br><span class="line">                                                                             withIdentifier:(<span class="built_in">NSString</span> *)identifier</span><br><span class="line">                                                                       forSectionController:(IGListSectionController *)sectionController</span><br><span class="line">                                                                                    atIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line">- (__kindof <span class="built_in">UICollectionReusableView</span> *)dequeueReusableSupplementaryViewOfKind:(<span class="built_in">NSString</span> *)elementKind</span><br><span class="line">                                                         forSectionController:(IGListSectionController *)sectionController</span><br><span class="line">                                                                      nibName:(<span class="built_in">NSString</span> *)nibName</span><br><span class="line">                                                                       bundle:(<span class="keyword">nullable</span> <span class="built_in">NSBundle</span> *)bundle</span><br><span class="line">                                                                      atIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)invalidateLayoutForSectionController:(IGListSectionController *)sectionController</span><br><span class="line">                                  completion:(<span class="keyword">nullable</span> <span class="type">void</span> (^)(<span class="type">BOOL</span> finished))completion;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)performBatchAnimated:(<span class="type">BOOL</span>)animated</span><br><span class="line">                     updates:(<span class="type">void</span> (^)(<span class="type">id</span>&lt;IGListBatchContext&gt; batchContext))updates</span><br><span class="line">                  completion:(<span class="keyword">nullable</span> <span class="type">void</span> (^)(<span class="type">BOOL</span> finished))completion;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)scrollToSectionController:(IGListSectionController *)sectionController</span><br><span class="line">                          atIndex:(<span class="built_in">NSInteger</span>)index</span><br><span class="line">                   scrollPosition:(<span class="built_in">UICollectionViewScrollPosition</span>)scrollPosition</span><br><span class="line">                         animated:(<span class="type">BOOL</span>)animated;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h5 id="相关文章推荐"><a href="#相关文章推荐" class="headerlink" title="相关文章推荐"></a>相关文章推荐</h5><ul>
<li><a target="_blank" rel="noopener" href="https://chipengliu.github.io/2019/11/05/IGListKit/">IGListKit 源码解析</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/5dc966bb6fb9a04a837ba7d7">IGListKit 源码解析</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/entry/5bee4514e51d4556a633c6c9">iOS — 快速上手 Instagram&#x2F;IGListKit 框架</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/entry/59e075256fb9a044fb06c569">大规模重构——重写 Instagram Feed 的经验之谈</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/entry/58650058128fe10069f8f92a">Instagram&#x2F;IGListKit 实践谈</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/entry/5c42fe08518825261c1b9808">IGListKit框架详细解析</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/3517619085f7">IGListKit框架解析</a></li>
<li><a target="_blank" rel="noopener" href="https://xiangwangfeng.com/2017/03/16/IGListKit-diff-%E5%AE%9E%E7%8E%B0%E7%AE%80%E6%9E%90/">IGListKit diff 实现简析</a></li>
</ul>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/iOS-%E5%BC%80%E6%BA%90%E5%BA%93%E5%88%86%E6%9E%90/">iOS 开源库分析</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/iOS-开源库分析/">iOS 开源库分析</a>
  </div>

</div>



</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2019/12/14/iOS-开源库源码解析-组件化BeeHive/" title="iOS 开源库源码解析- 组件化BeeHive">
  <span>
  iOS 开源库源码解析- 组件化BeeHive</span>
</a>
</div>


<div class="next">
<a href="/2019/12/06/MJRefresh-使用及源码分析/"  title="MJRefresh 使用及源码分析">
 <span>MJRefresh 使用及源码分析
</span>
</a>
</div>

</nav>

	
<section id="comments" class="comment">
	<div class="ds-thread" data-thread-key="2019/12/08/IGKListKit-使用及源码分析/" data-title="IGKListKit 使用及源码分析" data-url="http://yoursite.com/2019/12/08/IGKListKit-%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"></div>
</section>


<section id="comments" class="comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
 
 <ol class="toc"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%80%E6%BA%90%E4%BF%A1%E6%81%AF"><span class="toc-number">1.</span> <span class="toc-text">开源信息</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">源码解析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E6%96%87%E7%AB%A0%E6%8E%A8%E8%8D%90"><span class="toc-number">3.</span> <span class="toc-text">相关文章推荐</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">
<div id="authorInfo">
	
		<div class="author-img"></div>		
	
	<div class="social-info" class="clearfix">
		
		
		<a href="https://github.com/tbfungeek" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
		
		<a href="mailto:tbfungeek@163.com" target="_blank" class="icon-email" title="Email Me"></a>
		

	</div>
</div>

  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
		  
			<li><a href="/categories/Android-小经验/" title="Android 小经验">Android 小经验<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android-源码分析/" title="Android 源码分析">Android 源码分析<sup>21</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android其他/" title="Android其他">Android其他<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android初步/" title="Android初步">Android初步<sup>21</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android进阶/" title="Android进阶">Android进阶<sup>100</sup></a></li>
		  
		
		  
			<li><a href="/categories/Hexo-使用/" title="Hexo 使用">Hexo 使用<sup>10</sup></a></li>
		  
		
		  
			<li><a href="/categories/JavaScript理论/" title="JavaScript理论">JavaScript理论<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Objective-C-相关/" title="Objective C 相关">Objective C 相关<sup>24</sup></a></li>
		  
		
		  
			<li><a href="/categories/OpenCV/" title="OpenCV">OpenCV<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/ROS/" title="ROS">ROS<sup>9</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-工具使用/" title="iOS 工具使用">iOS 工具使用<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-开源库分析/" title="iOS 开源库分析">iOS 开源库分析<sup>36</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-理论基础/" title="iOS 理论基础">iOS 理论基础<sup>14</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-进阶/" title="iOS 进阶">iOS 进阶<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/个人收藏/" title="个人收藏">个人收藏<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/代码规范/" title="代码规范">代码规范<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/其他/" title="其他">其他<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/博客分类目录/" title="博客分类目录">博客分类目录<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/叨叨系列/" title="叨叨系列">叨叨系列<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/开源代码分析/" title="开源代码分析">开源代码分析<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/开源库分析/" title="开源库分析">开源库分析<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/树莓派/" title="树莓派">树莓派<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/版本控制/" title="版本控制">版本控制<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/直播/" title="直播">直播<sup>6</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/iOS-开源库分析/" title="iOS 开源库分析">iOS 开源库分析<sup>36</sup></a></li>
			
		
			
				<li><a href="/tags/Android-设计模式/" title="Android 设计模式">Android 设计模式<sup>29</sup></a></li>
			
		
			
				<li><a href="/tags/Objective-C-相关/" title="Objective C 相关">Objective C 相关<sup>24</sup></a></li>
			
		
			
				<li><a href="/tags/Android基础/" title="Android基础">Android基础<sup>21</sup></a></li>
			
		
			
				<li><a href="/tags/AOSP-源码/" title="AOSP 源码">AOSP 源码<sup>17</sup></a></li>
			
		
			
				<li><a href="/tags/Android-常用第三方库/" title="Android 常用第三方库">Android 常用第三方库<sup>15</sup></a></li>
			
		
			
				<li><a href="/tags/iOS-理论基础/" title="iOS 理论基础">iOS 理论基础<sup>14</sup></a></li>
			
		
			
				<li><a href="/tags/Hexo-使用/" title="Hexo 使用">Hexo 使用<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/ROS/" title="ROS">ROS<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/Android-动画进阶/" title="Android 动画进阶">Android 动画进阶<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/Android-JNI/" title="Android JNI">Android JNI<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android-绘图进阶/" title="Android 绘图进阶">Android 绘图进阶<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android性能优化/" title="Android性能优化">Android性能优化<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android-自动化测试/" title="Android 自动化测试">Android 自动化测试<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/OpenCV/" title="OpenCV">OpenCV<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/直播/" title="直播">直播<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android-开源源码/" title="Android 开源源码">Android 开源源码<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Android-自定义View进阶/" title="Android 自定义View进阶">Android 自定义View进阶<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/树莓派/" title="树莓派">树莓派<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/iOS-进阶/" title="iOS 进阶">iOS 进阶<sup>4</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="https://hexo.io" target="_blank" title="Hexo">Hexo</a>
            
          </li>
        
          <li>
            
            	<a href="https://pages.github.com/" target="_blank" title="GitHub">GitHub</a>
            
          </li>
        
          <li>
            
            	<a href="http://pf18.github.io/" target="_blank" title="PF18">PF18</a>
            
          </li>
        
          <li>
            
            	<a href="http://toutiao.io/" target="_blank" title="开发者头条">开发者头条</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.jcodecraeer.com/" target="_blank" title="泡在网上的日子">泡在网上的日子</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="atom.xml" target="_blank" title="rss">RSS</a>
</div>

  
  <div class="tagcloudlist">
    <p class="asidetitle">Tag Cloud</p>
    <div class="tagcloudlist clearfix">
       <a href="/tags/AOSP-%E6%BA%90%E7%A0%81/" style="font-size: 17.14px;">AOSP 源码</a> <a href="/tags/Android-APK-%E7%AD%BE%E5%90%8D/" style="font-size: 10px;">Android APK 签名</a> <a href="/tags/Android-JNI/" style="font-size: 12.86px;">Android JNI</a> <a href="/tags/Android-%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E8%BF%9B%E9%98%B6/" style="font-size: 10.71px;">Android 事件处理进阶</a> <a href="/tags/Android-%E5%8A%A8%E7%94%BB%E8%BF%9B%E9%98%B6/" style="font-size: 13.57px;">Android 动画进阶</a> <a href="/tags/Android-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%BC%80%E5%8F%91/" style="font-size: 10px;">Android 多线程开发</a> <a href="/tags/Android-%E5%B0%8F%E7%BB%8F%E9%AA%8C/" style="font-size: 10px;">Android 小经验</a> <a href="/tags/Android-%E5%B8%B8%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93/" style="font-size: 16.43px;">Android 常用第三方库</a> <a href="/tags/Android-%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B/" style="font-size: 10px;">Android 开发流程</a> <a href="/tags/Android-%E5%BC%80%E6%BA%90%E6%BA%90%E7%A0%81/" style="font-size: 12.14px;">Android 开源源码</a> <a href="/tags/Android-%E7%BB%98%E5%9B%BE%E8%BF%9B%E9%98%B6/" style="font-size: 12.86px;">Android 绘图进阶</a> <a href="/tags/Android-%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/" style="font-size: 12.86px;">Android 自动化测试</a> <a href="/tags/Android-%E8%87%AA%E5%AE%9A%E4%B9%89View%E8%BF%9B%E9%98%B6/" style="font-size: 12.14px;">Android 自定义View进阶</a> <a href="/tags/Android-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 19.29px;">Android 设计模式</a> <a href="/tags/Android%E5%85%B6%E4%BB%96/" style="font-size: 10px;">Android其他</a> <a href="/tags/Android%E5%9F%BA%E7%A1%80/" style="font-size: 17.86px;">Android基础</a> <a href="/tags/Android%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B/" style="font-size: 10px;">Android开发流程</a> <a href="/tags/Android%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" style="font-size: 12.86px;">Android性能优化</a> <a href="/tags/Android%E6%B7%B7%E6%B7%86%E6%8A%80%E6%9C%AF/" style="font-size: 10px;">Android混淆技术</a> <a href="/tags/Android%E8%B4%A8%E9%87%8F%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/" style="font-size: 11.43px;">Android质量管理工具</a> <a href="/tags/Android%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/" style="font-size: 10px;">Android逆向工程</a> <a href="/tags/Git-github/" style="font-size: 10px;">Git && github</a> <a href="/tags/Hexo-%E4%BD%BF%E7%94%A8/" style="font-size: 15px;">Hexo 使用</a> <a href="/tags/JavaScript/" style="font-size: 10px;">JavaScript</a> <a href="/tags/Linux-%E4%BD%BF%E7%94%A8/" style="font-size: 10px;">Linux 使用</a> <a href="/tags/Objective-C-%E7%9B%B8%E5%85%B3/" style="font-size: 18.57px;">Objective C 相关</a> <a href="/tags/OpenCV/" style="font-size: 12.86px;">OpenCV</a> <a href="/tags/ROS/" style="font-size: 14.29px;">ROS</a> <a href="/tags/iOS-%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/" style="font-size: 10.71px;">iOS 工具使用</a> <a href="/tags/iOS-%E5%BC%80%E6%BA%90%E5%BA%93%E5%88%86%E6%9E%90/" style="font-size: 20px;">iOS 开源库分析</a> <a href="/tags/iOS-%E7%90%86%E8%AE%BA%E5%9F%BA%E7%A1%80/" style="font-size: 15.71px;">iOS 理论基础</a> <a href="/tags/iOS-%E8%BF%9B%E9%98%B6/" style="font-size: 12.14px;">iOS 进阶</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83/" style="font-size: 10px;">代码规范</a> <a href="/tags/%E5%8D%9A%E5%AE%A2%E5%88%86%E7%B1%BB%E7%9B%AE%E5%BD%95/" style="font-size: 10.71px;">博客分类目录</a> <a href="/tags/%E5%8F%A8%E5%8F%A8%E7%B3%BB%E5%88%97/" style="font-size: 10px;">叨叨系列</a> <a href="/tags/%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8/" style="font-size: 11.43px;">工具的使用</a> <a href="/tags/%E5%BC%80%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/" style="font-size: 10.71px;">开源代码分析</a> <a href="/tags/%E5%BC%80%E6%BA%90%E5%BA%93%E5%88%86%E6%9E%90/" style="font-size: 10px;">开源库分析</a> <a href="/tags/%E6%9D%82%E7%B1%BB/" style="font-size: 10px;">杂类</a> <a href="/tags/%E6%A0%91%E8%8E%93%E6%B4%BE/" style="font-size: 12.14px;">树莓派</a> <a href="/tags/%E7%9B%B4%E6%92%AD/" style="font-size: 12.86px;">直播</a> <a href="/tags/%E7%BC%96%E7%A8%8B%E6%8A%80%E5%B7%A7/" style="font-size: 10.71px;">编程技巧</a> <a href="/tags/%E7%BD%91%E7%AB%99%E6%94%B6%E8%97%8F/" style="font-size: 10px;">网站收藏</a> <a href="/tags/%E9%87%8D%E8%A6%81%E6%8E%A7%E4%BB%B6/" style="font-size: 11.43px;">重要控件</a>
    </div>
  </div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
		
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/hsihohuang/kiddochan" target="_blank" title="Kiddochan">Kiddochan</a> © 2022 
		
		<a href="/about" target="_blank" title="Edgar">Edgar</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
        getSize();
        if (myWidth >= 1024) {
          c.click();
        }
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>




<script type="text/javascript">
  var duoshuoQuery = {short_name:"tbfungeek"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 


<script type="text/javascript">

var disqus_shortname = 'tbfungeek';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>






<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?7c9443b0374f1cf6b1dbb5ab84d939cb";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
