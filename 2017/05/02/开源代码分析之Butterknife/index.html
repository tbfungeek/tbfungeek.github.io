
 <!DOCTYPE HTML>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  
    <title>开源代码分析之Butterknife | Edgar&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Edgar">
    

    
    <meta name="description" content="作为Android应用开发工程师估计没有人没听过Butterknife吧，我们可以借助它来简化view的查找过程以及通过注释将监听器绑定到事件响应方法上，这样可以减少很多代码量。对于Butterknife的用法在之前的博客中已经做了相应的介绍，这部分主要是分析Butterknife的源码，在之后的博文中还会对编译时注解解析器的实现做对应的介绍，如果想要对这部分内容有比较深入的了解，可以看下 《Ja">
<meta property="og:type" content="article">
<meta property="og:title" content="开源代码分析之Butterknife">
<meta property="og:url" content="http://yoursite.com/2017/05/02/%E5%BC%80%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BButterknife/index.html">
<meta property="og:site_name" content="Edgar&#39;s Blog">
<meta property="og:description" content="作为Android应用开发工程师估计没有人没听过Butterknife吧，我们可以借助它来简化view的查找过程以及通过注释将监听器绑定到事件响应方法上，这样可以减少很多代码量。对于Butterknife的用法在之前的博客中已经做了相应的介绍，这部分主要是分析Butterknife的源码，在之后的博文中还会对编译时注解解析器的实现做对应的介绍，如果想要对这部分内容有比较深入的了解，可以看下 《Ja">
<meta property="og:locale">
<meta property="og:image" content="http://yoursite.com/2017/05/02/%E5%BC%80%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BButterknife/image002.png">
<meta property="og:image" content="http://yoursite.com/2017/05/02/%E5%BC%80%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BButterknife/image001.png">
<meta property="article:published_time" content="2017-05-02T14:08:50.000Z">
<meta property="article:modified_time" content="2017-05-17T14:07:02.000Z">
<meta property="article:author" content="Edgar">
<meta property="article:tag" content="开源代码分析">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/2017/05/02/%E5%BC%80%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BButterknife/image002.png">

    
    <link rel="alternative" href="atom.xml" title="Edgar&#39;s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/unnamed4_n_mSY_icon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/profile.png">
    <link rel="apple-touch-icon-precomposed" href="/img/profile.png">
    
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.2.0"></head>

  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Edgar&#39;s Blog">Edgar&#39;s Blog</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
					<li>
 					
					<form class="search" action="/search/index.html" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" autocomplete="off" name="q" maxlength="20" placeholder="Search" />
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/05/02/开源代码分析之Butterknife/" title="开源代码分析之Butterknife" itemprop="url">开源代码分析之Butterknife</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Edgar" target="_blank" itemprop="author">Edgar</a>
		
  <p class="article-time">
    <time datetime="2017-05-02T14:08:50.000Z" itemprop="datePublished"> Published 2017-05-02</time>
    
  </p>
</header>
	<div class="article-content">
		
		<p>作为Android应用开发工程师估计没有人没听过Butterknife吧，我们可以借助它来简化view的查找过程以及通过注释将监听器绑定到事件响应方法上，这样可以减少很多代码量。对于Butterknife的用法在之前的博客中已经做了相应的介绍，这部分主要是分析Butterknife的源码，在之后的博文中还会对编译时注解解析器的实现做对应的介绍，如果想要对这部分内容有比较深入的了解，可以看下 《Java 进阶系列之注解》 以及《一步一步编写编译时注解框架》以及该篇博客。</p>
<p>好了言归正传，我们在介绍之前看下Butterknife 的工作原理：<br>在没有Butterknife的情况下我们用的是 Android 原生的API方法findViewById,而有了Butterknife后我们就可以直接使用@BindView(R.id.text) , 但是如果仔细看过源码的同学，会发现到最后还是调用findViewById，只不过这个是编译时注解框架帮我们生成了对应的代码，换句话说Butterknife以带有注解的源码文件作为javac编译器输入，在编译的时候会调用注解解析工具，对这些源码中的注解进行解析，解析后再通过代码生成工具来产生对应的源码文件，最后将我们自己的源码文件和注解解析工具产生的源码一同作为编译器输入进行编译。</p>
<p>ok 了解了整个原理我们就可以进行深入研究了。</p>
<p>我们将分成两大部分进行分析：</p>
<ul>
<li>绑定View以及事件</li>
<li>注解解析器</li>
</ul>
<h4 id="项目结构-："><a href="#项目结构-：" class="headerlink" title="[项目结构]："></a>[项目结构]：</h4><p><img src="/2017/05/02/%E5%BC%80%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BButterknife/image002.png"></p>
<h4 id="绑定过程-："><a href="#绑定过程-：" class="headerlink" title="[绑定过程]："></a>[绑定过程]：</h4><p>在绑定实用的是bind方法，bing方法实现如下，它的实现十分简单，但是在介绍bind时候，必须要先大概知道什么是target，什么是source，简单讲target就是一个实体，它承载着source，目前butterknife支持的target 包括activity，dialog，以及view。source就是我们实际要查找控件的地方。也就是findViewById 应用的对象。下面是以activity为target，所以对应的source就是对应activity的DecorView.</p>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="meta">@NonNull</span> <span class="meta">@UiThread</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function">Unbinder <span class="title">bind</span><span class="params">(@NonNull Activity <span class="keyword">target</span>)</span> </span>&#123;</span><br><span class="line">  View sourceView = <span class="keyword">target</span>.getWindow().getDecorView();</span><br><span class="line">  <span class="function"><span class="keyword">return</span> <span class="title">createBinding</span><span class="params">(<span class="keyword">target</span>, sourceView)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着我们来看下createBinding方法，在方法开始的时候会使用target的class对象来获取对应的ViewBinding的构造方法，target的ViewBinding对象是由ButterknifeProcessor生成的，这个会在后面介绍ButterknifeProcessor的时候进行详细展开介绍。获取到对应的ViewBinding对象后调用该对象的构造方法并返回。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="title class_">Unbinder</span> <span class="title function_">createBinding</span>(<span class="params"><span class="meta">@NonNull</span> <span class="built_in">Object</span> target, <span class="meta">@NonNull</span> View source</span>) &#123;</span><br><span class="line">    <span class="comment">//获取target的Class对象，比如 XXXActivity.class</span></span><br><span class="line">    <span class="title class_">Class</span>&lt;?&gt; targetClass = target.<span class="title function_">getClass</span>();</span><br><span class="line">    <span class="comment">//获取targetClass对应ViewBinding的构造方法</span></span><br><span class="line">    <span class="title class_">Constructor</span>&lt;? <span class="keyword">extends</span> <span class="title class_">Unbinder</span>&gt; constructor = <span class="title function_">findBindingConstructorForClass</span>(targetClass);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (constructor == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Unbinder</span>.<span class="property">EMPTY</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//这样一来，ButterKnife.bind(this)传递进去的MainActivity会通过反射生成MainActivity_ViewBinding实例。</span></span><br><span class="line">    <span class="comment">//在这个实例的构造函数内，进行findViewById、setOnclickListener等操作</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">  </span><br><span class="line">      <span class="keyword">return</span> constructor.<span class="title function_">newInstance</span>(target, source);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="title class_">IllegalAccessException</span> e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Unable to invoke &quot;</span> + constructor, e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="title class_">InstantiationException</span> e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Unable to invoke &quot;</span> + constructor, e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="title class_">InvocationTargetException</span> e) &#123;</span><br><span class="line">      <span class="title class_">Throwable</span> cause = e.<span class="title function_">getCause</span>();</span><br><span class="line">      <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> <span class="title class_">RuntimeException</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> (<span class="title class_">RuntimeException</span>) cause;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> <span class="title class_">Error</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> (<span class="title class_">Error</span>) cause;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Unable to create binding instance.&quot;</span>, cause);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>findBindingConstructorForClass 的作用就是加载对应targetClass的ViewBinding对象的构造方法：</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">@Nullable @CheckResult @UiThread</span><br><span class="line"><span class="keyword">private</span> static Constructor&lt;? extends Unbinder&gt; find<span class="constructor">BindingConstructorForClass(Class&lt;?&gt; <span class="params">cls</span>)</span> &#123;</span><br><span class="line">  <span class="comment">//首先将传入XXXXActivity 类对象 作为参数尝试从缓存中获取通过JavaPoet产生的ViewBinding的构造方法</span></span><br><span class="line">  <span class="comment">//内存缓存BINDINGS 的组成是以targetClass为key，targetClass ViewBinding 构造方法为value的一个Map</span></span><br><span class="line">  Constructor&lt;? extends Unbinder&gt; bindingCtor = <span class="module-access"><span class="module"><span class="identifier">BINDINGS</span>.</span></span>get(cls);</span><br><span class="line">  <span class="keyword">if</span> (bindingCtor != null) &#123;</span><br><span class="line">    <span class="keyword">if</span> (debug) <span class="module-access"><span class="module"><span class="identifier">Log</span>.</span></span>d(TAG, <span class="string">&quot;HIT: Cached in binding map.&quot;</span>);</span><br><span class="line">    return bindingCtor;</span><br><span class="line">  &#125;</span><br><span class="line">  String clsName = cls.get<span class="constructor">Name()</span>;</span><br><span class="line">  <span class="comment">//由于Butterknife 不能用于注释android以及java这些标准sdk的类所以先进行这种类型的过滤</span></span><br><span class="line">  <span class="keyword">if</span> (clsName.starts<span class="constructor">With(<span class="string">&quot;android.&quot;</span>)</span><span class="operator"> || </span>clsName.starts<span class="constructor">With(<span class="string">&quot;java.&quot;</span>)</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (debug) <span class="module-access"><span class="module"><span class="identifier">Log</span>.</span></span>d(TAG, <span class="string">&quot;MISS: Reached framework class. Abandoning search.&quot;</span>);</span><br><span class="line">    return null;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//使用类加载器加载在编译阶段由JavaPoet生成的XXXX_ViewBinding类对象</span></span><br><span class="line">    Class&lt;?&gt; bindingClass = cls.get<span class="constructor">ClassLoader()</span>.load<span class="constructor">Class(<span class="params">clsName</span> + <span class="string">&quot;_ViewBinding&quot;</span>)</span>;</span><br><span class="line">    <span class="comment">//获取对应的构造方法类，并且会将得到的Constructor缓存起来，避免反射的性能问题。</span></span><br><span class="line">    bindingCtor = (Constructor&lt;? extends Unbinder&gt;) bindingClass.get<span class="constructor">Constructor(<span class="params">cls</span>, View.<span class="params">class</span>)</span>;</span><br><span class="line">    <span class="keyword">if</span> (debug) <span class="module-access"><span class="module"><span class="identifier">Log</span>.</span></span>d(TAG, <span class="string">&quot;HIT: Loaded binding class and constructor.&quot;</span>);</span><br><span class="line">  &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">    <span class="comment">//如果没有找到那么找它对应的父类ViewBinding的构造方法</span></span><br><span class="line">    <span class="keyword">if</span> (debug) <span class="module-access"><span class="module"><span class="identifier">Log</span>.</span></span>d(TAG, <span class="string">&quot;Not found. Trying superclass &quot;</span> + cls.get<span class="constructor">Superclass()</span>.get<span class="constructor">Name()</span>);</span><br><span class="line">    bindingCtor = find<span class="constructor">BindingConstructorForClass(<span class="params">cls</span>.<span class="params">getSuperclass</span>()</span>);</span><br><span class="line">  &#125; catch (NoSuchMethodException e) &#123;</span><br><span class="line">    throw <span class="keyword">new</span> <span class="constructor">RuntimeException(<span class="string">&quot;Unable to find binding constructor for &quot;</span> + <span class="params">clsName</span>, <span class="params">e</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//将其添加到缓存中,后续使用的时候就不需要进行再次使用反射了从而加快了效率</span></span><br><span class="line">  <span class="module-access"><span class="module"><span class="identifier">BINDINGS</span>.</span></span>put(cls, bindingCtor);</span><br><span class="line">  return bindingCtor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了提高整体性能，这里使用了BINDINGS这个Map作为内存缓存。BINDINGS的定义如下：</p>
<figure class="highlight oxygene"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> Map&lt;<span class="keyword">Class</span>&lt;?&gt;, <span class="keyword">Constructor</span>&lt;? <span class="title function_">extends</span> <span class="title function_">Unbinder</span>&gt;&gt; <span class="title function_">BINDINGS</span> = <span class="title function_">new</span> <span class="title function_">LinkedHashMap</span>&lt;&gt;<span class="params">()</span>;</span><br></pre></td></tr></table></figure>
<p>它的键值为我们的target 的类对象，我们以MainActivity为例子，那么key为MainActivity.class 对应的值呢？就是MainActivity_ViewBinding的构造方法，这个构造方法只有一个参数（View）.<br>这个阶段的整个过程如下：<br>拿着target类对象到BINDINGS缓存中去匹配，看下是否有缓存，如果有缓存那么使用缓存，如果没有那么就获取JavaPoet产生的MainActivity_ViewBinding(View view)的构造方法，并添加到缓冲中，供后续使用，为啥要缓存？<br>因为这里获取MainActivity_ViewBinding的构造方法使用的是反射的方式，对性能有所影响，使用缓存可以减少反射的使用次数，但是这里有一个疑问就是会不会因为Butterknife的大量使用从而导致缓存占用很大的空间，这个问题又是如何克服的？我们带着这个问题继续。获取到构造方法后我们new出一个实例对象，这里可以看出 MainActivity_ViewBinding.java继承的是Unbinder，而Unbinder中的unbind方法有可能就是处理缓存清除的工作。<br>我们看下Butterknife sample例子中产生的一个代码：</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">public <span class="keyword">class</span> G_ViewBinding&lt;T extends G&gt; extends E_ViewBinding&lt;T&gt; &#123;</span><br><span class="line">  <span class="keyword">private</span> View view16908290;</span><br><span class="line"></span><br><span class="line">  @UiThread</span><br><span class="line">  public <span class="constructor">G_ViewBinding(<span class="params">final</span> T <span class="params">target</span>, View <span class="params">source</span>)</span> &#123;</span><br><span class="line">    super(target, source);</span><br><span class="line"></span><br><span class="line">    View view;</span><br><span class="line">    target.button2 = <span class="module-access"><span class="module"><span class="identifier">Utils</span>.</span></span>find<span class="constructor">RequiredView(<span class="params">source</span>, <span class="params">android</span>.R.<span class="params">id</span>.<span class="params">button2</span>, <span class="string">&quot;field &#x27;button2&#x27;&quot;</span>)</span>;</span><br><span class="line">    view = <span class="module-access"><span class="module"><span class="identifier">Utils</span>.</span></span>find<span class="constructor">RequiredView(<span class="params">source</span>, <span class="params">android</span>.R.<span class="params">id</span>.<span class="params">content</span>, <span class="string">&quot;method &#x27;onClick&#x27;&quot;</span>)</span>;</span><br><span class="line">    view16908290 = view;</span><br><span class="line">    view.set<span class="constructor">OnClickListener(<span class="params">new</span> DebouncingOnClickListener()</span> &#123;</span><br><span class="line">      @Override</span><br><span class="line">      public void <span class="keyword">do</span><span class="constructor">Click(View <span class="params">p0</span>)</span> &#123;</span><br><span class="line">        target.on<span class="constructor">Click()</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    Context context = source.get<span class="constructor">Context()</span>;</span><br><span class="line">    Resources res = context.get<span class="constructor">Resources()</span>;</span><br><span class="line">    Resources.Theme theme = context.get<span class="constructor">Theme()</span>;</span><br><span class="line">    target.grayColor = <span class="module-access"><span class="module"><span class="identifier">Utils</span>.</span></span>get<span class="constructor">Color(<span class="params">res</span>, <span class="params">theme</span>, <span class="params">android</span>.R.<span class="params">color</span>.<span class="params">darker_gray</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public void unbind<span class="literal">()</span> &#123;</span><br><span class="line">    T target = this.target;</span><br><span class="line">    super.unbind<span class="literal">()</span>;</span><br><span class="line">    target.button2 = null;</span><br><span class="line">    view16908290.set<span class="constructor">OnClickListener(<span class="params">null</span>)</span>;</span><br><span class="line">    view16908290 = null;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们先不看上面的具体代码，只看unbind方法。它会递归地将对应的view对象设置成null，从而在gc的时候释放掉资源。</p>
<p>从上面代码看整个butterknife包的源码是十分简单的，最重要的在于xxxx_ViewBinding.class的生成，这就需要对butterknife-compiler包中的源码进行研究了，我们所有的注解都在butterknife-annotations这个包中，我们这里只以BindView注解作为分析对象：<br>具体的注解相关内容见《Java进阶之注解》 这篇博客。</p>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="variable">@Retention</span>(CLASS) <span class="variable">@Target</span>(FIELD)</span><br><span class="line">public <span class="variable">@interface</span> BindView &#123;</span><br><span class="line">  <span class="comment">/** View ID to which the field will be bound. */</span></span><br><span class="line">  <span class="variable">@IdRes</span> int value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面我们可以看出@BindView注解应用于属性定义中，并且只在源码级别以及class级别中存在，它的值为一个id类型的值。不允许其他类型的值作为参数。</p>
<h4 id="Butterknife注释解析器ButterknifeProcessor-："><a href="#Butterknife注释解析器ButterknifeProcessor-：" class="headerlink" title="[Butterknife注释解析器ButterknifeProcessor]："></a>[Butterknife注释解析器ButterknifeProcessor]：</h4><p>从上面一小结介绍可以看出Butterknife.java 中的工作很简单就是拿着targetClass找到对应的ViewBinding,至于ViewBinding怎么来的则是这一小结的介绍重点，在介绍ButterKnife注解解析器之前我们再次回顾下注解解析器在整个编译过程中的的作用：<br>我们知道Java使用Javac处理编译过程的，在Java的编译时期,Javac会先调用java注解处理器来进行处理。因此我们可以自定义注解处理器来做一些处理。注解处理器通常以java源码或者已编译的字节码作为输入，然后生成一些源码文件作为输出。在这个过程可以在已有的代码上添加一些方法，来帮我们做一些有用的事情。这些生成的 java 文件跟其他手动编写的java源码一样，会被 javac 编译。编译时解析是注解强大的地方之一。我们可以利用它在编译时帮你生成一些代码逻辑，避免了运行时利用反射解析所带来的性能开销。</p>
<p>下面是ButterKnifeProcessor的大体结构：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="meta">@AutoService</span>(<span class="title class_">Processor</span>.<span class="property">class</span>)</span><br><span class="line"><span class="comment">//要解析编译时注释，可以通过创建一个继承自AbstractProcessor的注解处理器，然后实现相关方法。</span></span><br><span class="line"><span class="keyword">public</span> final <span class="keyword">class</span> <span class="title class_">ButterKnifeProcessor</span> <span class="keyword">extends</span> <span class="title class_ inherited__">AbstractProcessor</span> &#123;</span><br><span class="line">  <span class="comment">//指定支持的 java 版本，通常返回 SourceVersion.latestSupported()</span></span><br><span class="line">  <span class="meta">@Override</span> <span class="keyword">public</span> <span class="title class_">SourceVersion</span> <span class="title function_">getSupportedSourceVersion</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">SourceVersion</span>.<span class="title function_">latestSupported</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span> <span class="keyword">public</span> <span class="title class_">Set</span>&lt;<span class="title class_">String</span>&gt; <span class="title function_">getSupportedOptions</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Collections</span>.<span class="title function_">singleton</span>(<span class="variable constant_">OPTION_SDK_INT</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//init方法是在Processor创建时被javac调用并执行初始化操作。</span></span><br><span class="line">  <span class="comment">//做一些初始化操作，可以在这里获取Filer，Elements等辅助类</span></span><br><span class="line">  <span class="comment">//@param processingEnv 提供一系列的注解处理工具。</span></span><br><span class="line">  <span class="keyword">public</span> synchronized <span class="built_in">void</span> <span class="title function_">init</span>(<span class="params">ProcessingEnvironment env</span>) &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//注解处理器要处理的注解类型,值为完全限定名（就是带所在包名和路径的类全名） **/</span></span><br><span class="line">  <span class="meta">@Override</span> <span class="keyword">public</span> <span class="title class_">Set</span>&lt;<span class="title class_">String</span>&gt; <span class="title function_">getSupportedAnnotationTypes</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Set</span>&lt;<span class="title class_">String</span>&gt; types = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="title class_">Class</span>&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt; annotation : <span class="title function_">getSupportedAnnotations</span>()) &#123;</span><br><span class="line">      <span class="comment">//将支持的注释类型添加到types集合中</span></span><br><span class="line">      types.<span class="title function_">add</span>(annotation.<span class="title function_">getCanonicalName</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> types;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//注解处理需要执行一次或者多次。每次执行时，处理器方法被调用，并且传入了当前要处理的注解类型。可以在这个方法中扫描和处理注解，并生成Java代码。</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">boolean</span> <span class="title function_">process</span>(<span class="params"><span class="built_in">Set</span>&lt;? <span class="keyword">extends</span> TypeElement&gt; elements, RoundEnvironment env</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面我们就顺着这个框架对ButterKnifeProcessor进行分析：<br>我们首先看下<br>@AutoService(Processor.class)的作用：一旦在Processor类上加上注解@AutoService(Processor.class)，它自动帮你将这个类添加到META-INF&#x2F;service&#x2F;javax.naaotation.processing.Processor下Java的ServiceLoader会自己去找到这个类并进行编译处理。<br>接着是init方法：<br>init方法是在Processor创建时被javac调用并执行初始化操作。通过ProcessingEnvironment参数我们可以获得如下元素：<br>Messager ：用于打印Log,在编译的时候会在Message窗口中输出。<br>Elements ：用于处理编程元素的辅助类<br>Filer    ：用于注解处理器生成新文件的<br>Locale   ：用于获取时区信息的类<br>Types    ：用于操作类型的辅助方法<br>其中最常用的就是Elements以及Types和打印Log用到的Messager.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(ProcessingEnvironment env)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.init(env);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取sdk 版本</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">sdk</span> <span class="operator">=</span> env</span><br><span class="line">.getOptions().get(OPTION_SDK_INT);</span><br><span class="line">    <span class="keyword">if</span> (sdk != <span class="literal">null</span>) &#123;</span><br><span class="line">  </span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.<span class="type">sd</span></span><br><span class="line">    <span class="variable">k</span> <span class="operator">=</span> Integer.parseInt(sdk);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">        env.getMessager().printMessage(Kind.WARNING, <span class="string">&quot;Unable to parse supplied minSdk option &#x27;&quot;</span> + sdk + <span class="string">&quot;&#x27;. Falling back to API 1 support.&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    elementUtils = env.getElementUtils();</span><br><span class="line">    typeUtils = env.getTypeUtils();</span><br><span class="line">    filer = env.getFiler();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      trees = Trees.instance(processingEnv);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException ignored) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>接着就是整个注解解析器的关键方法process，每次执行时，处理器方法被调用，并且传入了当前要处理的注解类型。可以在这个方法中扫描和处理注解，并生成Java代码。我们看下面的process方法，在这个方法中主要完成了两项任务，一个就是调用findAndParseTargets来获取bindingMap<br>bindingMap 是什么呢？它其实对应的是每个有调用bind绑定的target，举个例子来说，我们在MainActicity的onCreate方法调用了Butterknife的bind方法，那么ButterknifeProcessor就会产生一个对应的BindingSet，也就是说有多少个bind，bindingMap里面就有多少个BindingSet。然后再使用Javapost来为每个BingSet生成一个_ViewBinding.class.</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">boolean</span> <span class="title function_">process</span>(<span class="params"><span class="built_in">Set</span>&lt;? <span class="keyword">extends</span> TypeElement&gt; elements, RoundEnvironment env</span>) &#123;</span><br><span class="line">  <span class="title class_">Map</span>&lt;<span class="title class_">TypeElement</span>, <span class="title class_">BindingSet</span>&gt; bindingMap = <span class="title function_">findAndParseTargets</span>(env);</span><br><span class="line">  <span class="keyword">for</span> (<span class="title class_">Map</span>.<span class="property">Entry</span>&lt;<span class="title class_">TypeElement</span>, <span class="title class_">BindingSet</span>&gt; entry : bindingMap.<span class="title function_">entrySet</span>()) &#123;</span><br><span class="line">    <span class="title class_">TypeElement</span> typeElement = entry.</span><br><span class="line"><span class="title function_">getKey</span>();</span><br><span class="line">    <span class="title class_">BindingSet</span> binding = entry.<span class="title function_">getValue</span>();</span><br><span class="line">    <span class="title class_">JavaFile</span> javaFile = binding.<span class="title function_">brewJava</span>(sdk);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      javaFile.<span class="title function_">writeTo</span>(filer);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="title class_">IOExceptio</span></span><br><span class="line">n e) &#123;</span><br><span class="line">      <span class="title function_">error</span>(typeElement, </span><br><span class="line">  <span class="string">&quot;Unable to write binding for type %s: %s&quot;</span>, typeElement, e.<span class="title function_">getMessage</span>());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们先来看下findAndParseTarets，它的任务分成如下几个部分：</p>
<ol>
<li>调用scanForRClasses  分别通过RClassScanner IdScanner VarScanner 解析R 文件并将解析结果存放到symbols 中，至于symbols的作用是什么我们后面介绍</li>
<li>调用一系列parseXXXX方法解析各种注解</li>
<li>调用findAndParseListener 来解析各种事件注解</li>
<li>整理BindingSet的继承关系<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> Map&lt;TypeElement, BindingSet&gt; find<span class="constructor">AndParseTargets(RoundEnvironment <span class="params">env</span>)</span> &#123;</span><br><span class="line">  Map&lt;TypeElement, BindingSet.Builder&gt; builderMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;<span class="literal">()</span>;</span><br><span class="line">  Set&lt;TypeElement&gt; erasedTargetNames = <span class="keyword">new</span> LinkedHashSet&lt;&gt;<span class="literal">()</span>;</span><br><span class="line">  <span class="comment">//建立view与R的id的关系</span></span><br><span class="line">  <span class="comment">//比如在Butterknife 编译出来的代码MainActivity_ViewBinding里持有一个全局变量view8131034512，</span></span><br><span class="line">  <span class="comment">// 这个其实就是MainActivity的tvTitle，后面的8131034512就是对应在R文件的id。</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//分别通过RClassScanner IdScanner VarScanner 解析R 文件并将解析结果存放到symbols 中</span></span><br><span class="line">  scan<span class="constructor">ForRClasses(<span class="params">env</span>)</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Process each @BindView element.</span></span><br><span class="line">  <span class="keyword">for</span> (Element element : env.get<span class="constructor">ElementsAnnotatedWith(BindView.<span class="params">class</span>)</span>) &#123;</span><br><span class="line">    <span class="comment">// we don&#x27;t SuperficialValidation.validateElement(element)</span></span><br><span class="line">    <span class="comment">// so that an unresolved View type can be generated by later processing rounds</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      parse<span class="constructor">BindView(<span class="params">element</span>, <span class="params">builderMap</span>, <span class="params">erasedTargetNames</span>)</span>;</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">      log<span class="constructor">ParsingError(<span class="params">element</span>, BindView.<span class="params">class</span>, <span class="params">e</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Process each annotation that corresponds to a listener.</span></span><br><span class="line">  <span class="keyword">for</span> (Class&lt;? extends Annotation&gt; listener : LISTENERS) &#123;</span><br><span class="line">    find<span class="constructor">AndParseListener(<span class="params">env</span>, <span class="params">listener</span>, <span class="params">builderMap</span>, <span class="params">erasedTargetNames</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  Deque&lt;Map.Entry&lt;TypeElement, BindingSet.Builder&gt;&gt; entries = <span class="keyword">new</span> ArrayDeque&lt;&gt;(builderMap.entry<span class="constructor">Set()</span>);</span><br><span class="line">  Map&lt;TypeElement, BindingSet&gt; bindingMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;<span class="literal">()</span>;</span><br><span class="line">  <span class="keyword">while</span> (!entries.is<span class="constructor">Empty()</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//取出第一个元素</span></span><br><span class="line">    Map.Entry&lt;TypeElement, BindingSet.Builder&gt; entry = entries.remove<span class="constructor">First()</span>;</span><br><span class="line">    TypeElement <span class="keyword">type</span> = entry.get<span class="constructor">Key()</span>;</span><br><span class="line">    BindingSet.Builder builder = entry.get<span class="constructor">Value()</span>;</span><br><span class="line"></span><br><span class="line">    TypeElement parentType = find<span class="constructor">ParentType(<span class="params">type</span>, <span class="params">erasedTargetNames</span>)</span>;</span><br><span class="line">    <span class="keyword">if</span> (parentType<span class="operator"> == </span>null) &#123;</span><br><span class="line">      bindin</span><br><span class="line">  gMap.put(<span class="keyword">type</span>, builder.build<span class="literal">()</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      BindingSet parentBinding = bindingMap.get(parentType);</span><br><span class="line">      <span class="keyword">if</span> (parentBinding != null) &#123;</span><br><span class="line">        builder.set<span class="constructor">Parent(<span class="params">parentBinding</span>)</span>;</span><br><span class="line">        bindingMap.put(<span class="keyword">type</span>, builder.build<span class="literal">()</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Has a superclass binding but we haven&#x27;t built it yet. Re-enqueue for later.</span></span><br><span class="line">        entries.add<span class="constructor">Last(<span class="params">entry</span>)</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return bindingMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>首先看下scanForRClasses：<br>它的作用是解析R文件将获取到的数据存入symbols，用于作为后续标识每个元素的key。R 元素中的每一个变量对应symols中的一个元素。</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> void scan<span class="constructor">ForRClasses(RoundEnvironment <span class="params">env</span>)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (trees<span class="operator"> == </span>null) return;</span><br><span class="line">  RClassScanner scanner = <span class="keyword">new</span> <span class="constructor">RClassScanner()</span>;</span><br><span class="line">  <span class="keyword">for</span> (Class&lt;? extends Annotation&gt; annotation : get<span class="constructor">SupportedAnnotations()</span>) &#123;</span><br><span class="line">    <span class="comment">//遍历全部支持的注解，找出使用给定注释类型注释的元素 比如这里可以返回全部使用@BindView注解的元素</span></span><br><span class="line">    <span class="keyword">for</span> (Element element : env.get<span class="constructor">ElementsAnnotatedWith(<span class="params">annotation</span>)</span>) &#123;</span><br><span class="line">      JCTree tree = (JCTree) trees.get<span class="constructor">Tree(<span class="params">element</span>, <span class="params">getMirror</span>(<span class="params">element</span>, <span class="params">annotation</span>)</span>);</span><br><span class="line">      <span class="keyword">if</span> (tree != null) &#123;</span><br><span class="line">        <span class="comment">//获取对应元素（使用BindView元素）的包名的完全限定名称</span></span><br><span class="line">        <span class="comment">//首先根据element获取到包名，再利用RClassScanner寻找到R文件，在R文件里利用IdScanner寻找到内部类id，</span></span><br><span class="line">        <span class="comment">//在id类里利用VarScanner寻找到tvTitle的id。最后就可以得到view2131034112。</span></span><br><span class="line">        String respectivePackageName = elementUtils.get<span class="constructor">PackageOf(<span class="params">element</span>)</span>.get<span class="constructor">QualifiedName()</span>.<span class="keyword">to</span><span class="constructor">String()</span>;</span><br><span class="line">        <span class="comment">//扫描指定的包</span></span><br><span class="line">        scanner.set<span class="constructor">CurrentPackageName(<span class="params">respectivePackageName</span>)</span>;</span><br><span class="line">        tree.accept(scanner);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//包名  +  R Class</span></span><br><span class="line">  <span class="keyword">for</span> (Map.Entry&lt;String, Set&lt;String&gt;&gt; packageNameToRClassSet : scanner.get<span class="constructor">RClasses()</span>.entry<span class="constructor">Set()</span>) &#123;</span><br><span class="line">    String respectivePackageName = packageNameToRClassSet.get<span class="constructor">Key()</span>;</span><br><span class="line">    <span class="comment">//获取对应的R类</span></span><br><span class="line">    <span class="keyword">for</span> (String rClass : packageNameToRClassSet.get<span class="constructor">Value()</span>) &#123;</span><br><span class="line">      <span class="comment">//解析R类</span></span><br><span class="line">      <span class="comment">//respectivePackageName 元素的包名</span></span><br><span class="line">      parse<span class="constructor">RClass(<span class="params">respectivePackageName</span><span class="operator">/</span><span class="operator">*</span><span class="params">key</span><span class="operator">*</span><span class="operator">/</span>, <span class="params">rClass</span><span class="operator">/</span><span class="operator">*</span><span class="params">value</span><span class="operator">*</span><span class="operator">/</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>查找R文件使用的是RClassScanner,它是一个TreeScanner，它会找到整个项目的R文件: </p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">RClassScanner</span> <span class="keyword">extends</span> <span class="title class_ inherited__">TreeScanner</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> final <span class="title class_">Map</span>&lt;<span class="title class_">String</span>, <span class="title class_">Set</span>&lt;<span class="title class_">String</span>&gt;&gt; rClasses = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">  <span class="keyword">private</span> <span class="title class_">String</span> currentPackageName;</span><br><span class="line">  <span class="comment">//数据结构 包名 + RC 类名集合</span></span><br><span class="line">  <span class="comment">//rClasses  ---| String 包名(currentPackageName) + RC 类名集合(rClassSet) Set&lt;String&gt; -&gt; symbol.getEnclosingElement().getEnclosingElement().enclClass().className()</span></span><br><span class="line">  <span class="comment">//             | String 包名(currentPackageName) + RC 类名集合(rClassSet) Set&lt;String&gt; -&gt; symbol.getEnclosingElement().getEnclosingElement().enclClass().className()</span></span><br><span class="line">  <span class="comment">//             | String 包名(currentPackageName) + RC 类名集合(rClassSet) Set&lt;String&gt; -&gt; symbol.getEnclosingElement().getEnclosingElement().enclClass().className()</span></span><br><span class="line">  <span class="comment">//             | String 包名(currentPackageName) + RC 类名集合(rClassSet) Set&lt;String&gt; -&gt; symbol.getEnclosingElement().getEnclosingElement().enclClass().className()</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">visitSelect</span>(<span class="params">JCTree.JCFieldAccess jcFieldAccess</span>) &#123;</span><br><span class="line">    <span class="title class_">Symbol</span> <span class="built_in">symbol</span> = jcFieldAccess.<span class="property">sym</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">symbol</span> != <span class="literal">null</span></span><br><span class="line">        &amp;&amp; <span class="built_in">symbol</span>.<span class="title function_">getEnclosingElement</span>() != <span class="literal">null</span></span><br><span class="line">        &amp;&amp; <span class="built_in">symbol</span>.<span class="title function_">getEnclosingElement</span>().<span class="title function_">getEnclosingElement</span>() != <span class="literal">null</span></span><br><span class="line">        &amp;&amp; <span class="built_in">symbol</span>.<span class="title function_">getEnclosingElement</span>().<span class="title function_">getEnclosingElement</span>().<span class="title function_">enclClass</span>() != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">//从缓存中获取对应的包名对应的 RClass 集合</span></span><br><span class="line">      <span class="title class_">Set</span>&lt;<span class="title class_">String</span>&gt; rClassSet = rClasses.<span class="title function_">get</span>(currentPackageName);</span><br><span class="line">      <span class="keyword">if</span> (rClassSet == <span class="literal">null</span>) &#123;</span><br><span class="line">        rClassSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        rClasses.<span class="title function_">put</span>(currentPackageName, rClassSet);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// getEnclosingElement 返回封装此元素（非严格意义上）的最里层元素。这里是对应的R Class 文件</span></span><br><span class="line">      rClassSet.<span class="title function_">add</span>(<span class="built_in">symbol</span>.<span class="title function_">getEnclosingElement</span>().<span class="title function_">getEnclosingElement</span>().<span class="title function_">enclClass</span>().<span class="title function_">className</span>());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 获取当前包的rClasses对象</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="title class_">Map</span>&lt;<span class="title class_">String</span>, <span class="title class_">Set</span>&lt;<span class="title class_">String</span>&gt;&gt; <span class="title function_">getRClasses</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> rClasses;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 设置当前扫描的包名</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> <span class="variable">respectivePackageName</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="built_in">void</span> <span class="title function_">setCurrentPackageName</span>(<span class="params"><span class="built_in">String</span> respectivePackageName</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">currentPackageName</span> = respectivePackageName;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在找到全部的R文件后在scanForRClass中会调用parseRClass对扫描到的R文件进行解析：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="built_in">void</span> <span class="title function_">parseRClass</span>(<span class="params"><span class="built_in">String</span> respectivePackageName, <span class="built_in">String</span> rClass</span>) &#123;</span><br><span class="line">    <span class="title class_">Element</span> element;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//对应的R元素</span></span><br><span class="line">      element = elementUtils.<span class="title function_">getTypeElement</span>(rClass);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="title class_">MirroredTypeException</span> mte) &#123;</span><br><span class="line">      element = typeUtils.<span class="title function_">asElement</span>(mte.<span class="title function_">getTypeMirror</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//对应的R文件</span></span><br><span class="line">    <span class="title class_">JCTree</span> tree = (<span class="title class_">JCTree</span>) trees.<span class="title function_">getTree</span>(element);</span><br><span class="line">    <span class="keyword">if</span> (tree != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title class_">IdScanner</span> idScanner = <span class="keyword">new</span> <span class="title class_">IdScanner</span>(symbols,</span><br><span class="line">              elementUtils.<span class="title function_">getPackageOf</span>(element).<span class="title function_">getQualifiedName</span>().<span class="title function_">toString</span>()<span class="comment">/*R class 全路径*/</span>,</span><br><span class="line">              respectivePackageName<span class="comment">/*目标元素的包名*/</span>);</span><br><span class="line">      tree.<span class="title function_">accept</span>(idScanner);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">parseCompiledR</span>(respectivePackageName, (<span class="title class_">TypeElement</span>) element);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>我们从上面代码中可以看到在parseRClass中会使用IdScanner 对当前扫描的R文件进行扫描：</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> static <span class="class"><span class="keyword">class</span> <span class="title">IdScanner</span> <span class="keyword">extends</span> <span class="title">TreeScanner</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Map</span>&lt;<span class="type">QualifiedId</span>, <span class="type">Id</span>&gt; ids;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> rPackageName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> respectivePackageName;</span><br><span class="line"></span><br><span class="line">    <span class="type">IdScanner</span>(<span class="type">Map</span>&lt;<span class="type">QualifiedId</span>, <span class="type">Id</span>&gt; ids, <span class="type">String</span> rPackageName<span class="comment">/*R class 全路径*/</span>, <span class="type">String</span> respectivePackageName<span class="comment">/*对应的包名*/</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.ids = ids;</span><br><span class="line">      <span class="keyword">this</span>.rPackageName = rPackageName;</span><br><span class="line">      <span class="keyword">this</span>.respectivePackageName = respectivePackageName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public void visitClassDef(<span class="type">JCTree</span>.<span class="type">JCClassDecl</span> jcClassDecl) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="type">JCTree</span> tree : jcClassDecl.defs) &#123;</span><br><span class="line">        <span class="comment">//每个指的是R 文件中的一个类 比如anim</span></span><br><span class="line">        <span class="keyword">if</span> (tree instanceof <span class="type">ClassTree</span>) &#123;</span><br><span class="line">          <span class="type">ClassTree</span> classTree = (<span class="type">ClassTree</span>) tree;</span><br><span class="line">          <span class="comment">//返回对应的类名比如 public static final class anim 返回的是 anim</span></span><br><span class="line">          <span class="type">String</span> className = classTree.getSimpleName().toString();</span><br><span class="line">          <span class="comment">//看下当前的类型是否在支持的范围内</span></span><br><span class="line">          <span class="keyword">if</span> (<span class="type">SUPPORTED_TYPES</span>.contains(className)) &#123;</span><br><span class="line">            <span class="comment">//获取到资源类型的全限定名 比如com.demo.example.R.anim</span></span><br><span class="line">            <span class="type">ClassName</span> rClassName = <span class="type">ClassName</span>.get(rPackageName, <span class="string">&quot;R&quot;</span>, className);</span><br><span class="line">            <span class="type">VarScanner</span> scanner = <span class="keyword">new</span> <span class="type">VarScanner</span>(ids, rClassName <span class="comment">/* 这里是某个资源类的全限定名*/</span>, respectivePackageName);</span><br><span class="line">            ((<span class="type">JCTree</span>) classTree).accept(scanner);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>在IdScanner 中会对R文件中的每个内部类进行扫描，判断当前的内部类是否是所支持的，如果是那么就调用VarScanner进行进一步扫描。</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> static <span class="keyword">class</span> VarScanner extends TreeScanner &#123;</span><br><span class="line">   <span class="keyword">private</span> final Map&lt;QualifiedId, Id&gt; ids;</span><br><span class="line">   <span class="keyword">private</span> final ClassName className;</span><br><span class="line">   <span class="keyword">private</span> final String respectivePackageName;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="constructor">VarScanner(Map&lt;QualifiedId, Id&gt; <span class="params">ids</span>, ClassName <span class="params">className</span><span class="operator">/</span><span class="operator">*</span><span class="params">com</span>.<span class="params">demo</span>.<span class="params">example</span>.R.<span class="params">anim</span><span class="operator">*</span><span class="operator">/</span>, String <span class="params">respectivePackageName</span>)</span> &#123;</span><br><span class="line">     this.ids = ids;</span><br><span class="line">     this.className = className;</span><br><span class="line">     this.respectivePackageName = respectivePackageName;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   @Override public void visit<span class="constructor">VarDef(JCTree.JCVariableDecl <span class="params">jcVariableDecl</span>)</span> &#123;</span><br><span class="line">     <span class="keyword">if</span> (<span class="string">&quot;int&quot;</span>.equals(jcVariableDecl.get<span class="constructor">Type()</span>.<span class="keyword">to</span><span class="constructor">String()</span>)) &#123;</span><br><span class="line">       <span class="comment">//资源id</span></span><br><span class="line">       <span class="built_in">int</span> id = <span class="module-access"><span class="module"><span class="identifier">Integer</span>.</span></span>value<span class="constructor">Of(<span class="params">jcVariableDecl</span>.<span class="params">getInitializer</span>()</span>.<span class="keyword">to</span><span class="constructor">String()</span>);</span><br><span class="line">       <span class="comment">//资源名</span></span><br><span class="line">       String resourceName = jcVariableDecl.get<span class="constructor">Name()</span>.<span class="keyword">to</span><span class="constructor">String()</span>;</span><br><span class="line">       <span class="comment">// 元素所在包名，资源id</span></span><br><span class="line">       QualifiedId qualifiedId = <span class="keyword">new</span> <span class="constructor">QualifiedId(<span class="params">respectivePackageName</span>, <span class="params">id</span>)</span>;</span><br><span class="line">       <span class="comment">//[获取到资源类型的全限定名比如com.demo.example.R.anim]  [资源名abc_fade_in] [0x7f040000]</span></span><br><span class="line">       ids.put(qualifiedId, <span class="keyword">new</span> <span class="constructor">Id(<span class="params">id</span>, <span class="params">className</span>, <span class="params">resourceName</span>)</span>);</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>VarScanner 也是一个TreeScanner，它的所用就是在R 文件内部类中扫描，并将扫描到的id 添加到symbos中。</p>
<p>介绍到这里我们做下简要，首先我们会通过RCScanner找到项目的R文件，再使用IdScanner对R文件中的内部类进行扫描，每个内部类对应一类资源，最后通过VarScanner对id进行扫描然后存入sybols这个map.</p>
<p>symbols定义如下：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Map</span>&lt;<span class="type">QualifiedId</span>, <span class="type">Id</span>&gt; symbols <span class="operator">=</span> new <span class="type">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight brainfuck"><table><tr><td class="code"><pre><span class="line"><span class="comment">Key:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">QualifiedId</span> <span class="literal">---</span><span class="comment">|</span><span class="literal">---</span> <span class="comment">respectivePackageName 当前资源所在对包</span></span><br><span class="line">               <span class="comment">|</span><span class="literal">---</span> <span class="comment">id 当前资源id</span></span><br><span class="line"></span><br><span class="line"><span class="comment">Value</span>       <span class="literal">---</span><span class="comment">|</span><span class="literal">---</span> <span class="comment">id 当前资源id  比如 0x7f040000</span></span><br><span class="line">               <span class="comment">|</span><span class="literal">---</span><span class="comment"> className 获取到资源类型的全限定名 比如com</span><span class="string">.</span><span class="comment">demo</span><span class="string">.</span><span class="comment">example</span><span class="string">.</span><span class="comment">R</span><span class="string">.</span><span class="comment">anim</span></span><br><span class="line">               <span class="comment">|</span><span class="literal">---</span> <span class="comment">resourceName 资源名  比如 abc_fade_in</span></span><br></pre></td></tr></table></figure>


<p>介绍完scanForRClass我们继续了解下注解的解析过程：<br>在进行解析之前会先对注解所应用的对象做初步检查：</p>
<ul>
<li>验证对应的修饰符是否是static 或者 private ,注解是否正在修饰局部变量，是否处于私有类中，以及检查包名是否是在android以及java标准API包内，如果有上述的情况就返回false</li>
<li>获取使用该注解的元素对应类型是否继承自View</li>
</ul>
<p>如果校验无误，那么会先查询bingMap中是否已经有对应的BindingSet了，如果没有就创建一个并添加到bingMap中。如果有的话就完对应的BindingSet添加Field这些Field会在JavaPost创建对应源码文件的时候用于生成对应的成员变量。这个后面会进行详细介绍。<br>我们下面深入看两点：</p>
<ol>
<li>BindingSet是怎么创建的</li>
<li>addFeild是怎么添加的<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> void parse<span class="constructor">BindView(Element <span class="params">element</span>, Map&lt;TypeElement, BindingSet.Builder&gt; <span class="params">builderMap</span>, Set&lt;TypeElement&gt; <span class="params">erasedTargetNames</span>)</span> &#123;</span><br><span class="line">  TypeElement enclosingElement = (TypeElement) element.get<span class="constructor">EnclosingElement()</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//校验一:解析前初步校验</span></span><br><span class="line">  <span class="comment">//验证对应的修饰符是否是static 或者 private ,注解是否正在修饰局部变量，是否处于私有类中，以及检查包名是否是在android以及java标准API包内，如果有上述的情况就返回false</span></span><br><span class="line">  boolean hasError = is<span class="constructor">InaccessibleViaGeneratedCode(BindView.<span class="params">class</span>, <span class="string">&quot;fields&quot;</span>, <span class="params">element</span>)</span><span class="operator"> || </span>is<span class="constructor">BindingInWrongPackage(BindView.<span class="params">class</span>, <span class="params">element</span>)</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//校验二:获取使用该注解的元素对应类型是否继承自View</span></span><br><span class="line">  TypeMirror elementType = element.<span class="keyword">as</span><span class="constructor">Type()</span>;</span><br><span class="line">  <span class="comment">// 是否是一个变量类型</span></span><br><span class="line">  <span class="keyword">if</span> (elementType.get<span class="constructor">Kind()</span><span class="operator"> == </span>TypeKind.TYPEVAR) &#123;</span><br><span class="line">    TypeVariable typeVariable = (TypeVariable) elementType;</span><br><span class="line">    <span class="comment">//获取它的父类</span></span><br><span class="line">    elementType = typeVariable.get<span class="constructor">UpperBound()</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  Name qualifiedName = enclosingElement.get<span class="constructor">QualifiedName()</span>;</span><br><span class="line">  Name simpleName = element.get<span class="constructor">SimpleName()</span>;</span><br><span class="line">  <span class="comment">//如果不是View类型并且不是接口那么就返回类型失败的错误</span></span><br><span class="line">  <span class="keyword">if</span> (!is<span class="constructor">SubtypeOfType(<span class="params">elementType</span>, VIEW_TYPE)</span><span class="operator"> &amp;&amp; </span>!is<span class="constructor">Interface(<span class="params">elementType</span>)</span>) &#123;</span><br><span class="line">    <span class="comment">//解析不了的类型</span></span><br><span class="line">    <span class="keyword">if</span> (elementType.get<span class="constructor">Kind()</span><span class="operator"> == </span>TypeKind.ERROR) &#123;</span><br><span class="line">      note(element, <span class="string">&quot;@%s field with unresolved type (%s) &quot;</span> + <span class="string">&quot;must elsewhere be generated as a View or interface. (%s.%s)&quot;</span>, <span class="module-access"><span class="module"><span class="identifier">BindView</span>.</span></span><span class="keyword">class</span>.get<span class="constructor">SimpleName()</span>, elementType, qualifiedName, simpleName);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">//不是View的子类或者不是接口</span></span><br><span class="line">      error(element, <span class="string">&quot;@%s fields must extend from View or be an interface. (%s.%s)&quot;</span>, <span class="module-access"><span class="module"><span class="identifier">BindView</span>.</span></span><span class="keyword">class</span>.get<span class="constructor">SimpleName()</span>, qualifiedName, simpleName);</span><br><span class="line">      hasError = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//如果解析错误那么不继续解析</span></span><br><span class="line">  <span class="keyword">if</span> (hasError) &#123;</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//获取BindView注解中的id值</span></span><br><span class="line">  <span class="built_in">int</span> id = element.get<span class="constructor">Annotation(BindView.<span class="params">class</span>)</span>.value<span class="literal">()</span>;</span><br><span class="line">  <span class="comment">//用包名和id生成一个QualifiedId:symble中存放的内容是以QualifiedId为键值</span></span><br><span class="line">  QualifiedId qualifiedId = element<span class="constructor">ToQualifiedId(<span class="params">element</span>, <span class="params">id</span>)</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//从缓存中获取对应元素所在类的BindingSet.Builder，每个注解元素所在类都只有一个BindingSet.Builder</span></span><br><span class="line">  <span class="comment">//比如我们当前的元素位于MainActivity中，那么解析的时候就获取MainActivity对应的BindingSet.Builder</span></span><br><span class="line">  BindingSet.Builder builder = builderMap.get(enclosingElement<span class="comment">/*MainActivity*/</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//判断是否存在同一个id重复绑定的问题</span></span><br><span class="line">  <span class="keyword">if</span> (builder != null) &#123;</span><br><span class="line">    String existingBindingName = builder.find<span class="constructor">ExistingBindingName(<span class="params">getId</span>(<span class="params">qualifiedId</span>)</span>);</span><br><span class="line">    <span class="comment">//重复绑定的情况</span></span><br><span class="line">    <span class="keyword">if</span> (existingBindingName != null) &#123;</span><br><span class="line">      error(element, <span class="string">&quot;Attempt to use @%s for an already bound ID %d on &#x27;%s&#x27;. (%s.%s)&quot;</span>,</span><br><span class="line">              <span class="module-access"><span class="module"><span class="identifier">BindView</span>.</span></span><span class="keyword">class</span>.get<span class="constructor">SimpleName()</span>, id, existingBindingName,</span><br><span class="line">              enclosingElement.get<span class="constructor">QualifiedName()</span>, element.get<span class="constructor">SimpleName()</span>);</span><br><span class="line">      return;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//元素所处类对应包名/*MainActivity*/ + BindingSet.Builder</span></span><br><span class="line">    builder = get<span class="constructor">OrCreateBindingBuilder(<span class="params">builderMap</span>, <span class="params">enclosingElement</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//控件名 比如mTextView</span></span><br><span class="line">  String name = simpleName.<span class="keyword">to</span><span class="constructor">String()</span>;</span><br><span class="line">  <span class="comment">//获取对应的类型 TextView</span></span><br><span class="line">  TypeName <span class="keyword">type</span> = <span class="module-access"><span class="module"><span class="identifier">TypeName</span>.</span></span>get(elementType);</span><br><span class="line">  <span class="comment">//当前元素是否是必须的</span></span><br><span class="line">  boolean required = is<span class="constructor">FieldRequired(<span class="params">element</span>)</span>;</span><br><span class="line">  <span class="comment">//将当前的成员变量添加到BuildSet中   比如上述的例子:  id  /  TextView   mTextView    false</span></span><br><span class="line">  builder.add<span class="constructor">Field(<span class="params">getId</span>(<span class="params">qualifiedId</span>)</span>, <span class="keyword">new</span> <span class="constructor">FieldViewBinding(<span class="params">name</span>, <span class="params">type</span>, <span class="params">required</span>)</span>);</span><br><span class="line">  <span class="comment">// Add the type-erased version to the valid binding targets set.</span></span><br><span class="line">  erasedTargetNames.add(enclosingElement);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>BindingSet的创建是通过调用getOrCreateBindingBuilder方法来完成的：<br>它会先判断当前target类型是activity，dialog，还是一般的view，以及生成target对应的ViewBinding文件名。</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="comment">//builderMap 中存放的形式  key: 对应的包名 + 对应的BindingSet.Builder</span></span><br><span class="line"><span class="keyword">private</span> BindingSet.Builder get<span class="constructor">OrCreateBindingBuilder(Map&lt;TypeElement, BindingSet.Builder&gt; <span class="params">builderMap</span>, TypeElement <span class="params">enclosingElement</span>)</span> &#123;</span><br><span class="line">  BindingSet.Builder builder = builderMap.get(enclosingElement);</span><br><span class="line">  <span class="keyword">if</span> (builder<span class="operator"> == </span>null) &#123;</span><br><span class="line">    builder = <span class="module-access"><span class="module"><span class="identifier">BindingSet</span>.</span></span><span class="keyword">new</span><span class="constructor">Builder(<span class="params">enclosingElement</span><span class="operator">/</span><span class="operator">*</span>MainActivity<span class="operator">*</span><span class="operator">/</span>)</span>;</span><br><span class="line">    builderMap.put(enclosingElement, builder);</span><br><span class="line">  &#125;</span><br><span class="line">  return builder;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 创建一个Builder，每个文件对应一个Builder，这里主要判断当前是否是View，是否是Activity，是否是Dialog，是否是Final，以及对应的报名</span></span><br><span class="line"><span class="comment">  * 参数为注解所处上层元素</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">static Builder <span class="keyword">new</span><span class="constructor">Builder(TypeElement <span class="params">enclosingElement</span>)</span> &#123;</span><br><span class="line">  TypeMirror typeMirror = enclosingElement.<span class="keyword">as</span><span class="constructor">Type()</span>;</span><br><span class="line">  <span class="comment">//判断当前是否View</span></span><br><span class="line">  boolean isView = is<span class="constructor">SubtypeOfType(<span class="params">typeMirror</span>, VIEW_TYPE)</span>;</span><br><span class="line">  <span class="comment">//判断当前是否Activity</span></span><br><span class="line">  boolean isActivity = is<span class="constructor">SubtypeOfType(<span class="params">typeMirror</span>, ACTIVITY_TYPE)</span>;</span><br><span class="line">  <span class="comment">//判断当前是否Dialog</span></span><br><span class="line">  boolean isDialog = is<span class="constructor">SubtypeOfType(<span class="params">typeMirror</span>, DIALOG_TYPE)</span>;</span><br><span class="line">  <span class="comment">//获取上层类的类型</span></span><br><span class="line">  TypeName targetType = <span class="module-access"><span class="module"><span class="identifier">TypeName</span>.</span></span>get(typeMirror);</span><br><span class="line">  <span class="keyword">if</span> (targetType instanceof ParameterizedTypeName) &#123;</span><br><span class="line">    targetType = ((ParameterizedTypeName) targetType).rawType;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//获取包名</span></span><br><span class="line">  String packageName = get<span class="constructor">Package(<span class="params">enclosingElement</span>)</span>.get<span class="constructor">QualifiedName()</span>.<span class="keyword">to</span><span class="constructor">String()</span>;</span><br><span class="line">  String className = enclosingElement.get<span class="constructor">QualifiedName()</span>.<span class="keyword">to</span><span class="constructor">String()</span>.substring(packageName.length<span class="literal">()</span> + <span class="number">1</span>).replace(<span class="character">&#x27;.&#x27;</span>, <span class="character">&#x27;$&#x27;</span>);</span><br><span class="line">  <span class="comment">//生成源码的文件名</span></span><br><span class="line">  ClassName bindingClassName = <span class="module-access"><span class="module"><span class="identifier">ClassName</span>.</span></span>get(packageName, className + <span class="string">&quot;_ViewBinding&quot;</span>);</span><br><span class="line">  boolean isFinal = enclosingElement.get<span class="constructor">Modifiers()</span>.contains(Modifier.FINAL);</span><br><span class="line">  return <span class="keyword">new</span> <span class="constructor">Builder(<span class="params">targetType</span>, <span class="params">bindingClassName</span>, <span class="params">isFinal</span>, <span class="params">isView</span>, <span class="params">isActivity</span>, <span class="params">isDialog</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那BindingSet的结构是怎样的呢？我们继续往下看：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Builder</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> TypeName targetTypeName;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ClassName bindingClassName;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> isFinal;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> isView;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> isActivity;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> isDialog;</span><br><span class="line">  <span class="keyword">private</span> BindingSet parentBinding;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Id, ViewBinding.Builder&gt; viewIdMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ImmutableList.Builder&lt;FieldCollectionViewBinding&gt; collectionBindings = ImmutableList.builder();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ImmutableList.Builder&lt;ResourceBinding&gt; resourceBindings = ImmutableList.builder();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 添加Field</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">addField</span><span class="params">(Id id, FieldViewBinding binding)</span> &#123;</span><br><span class="line">    ViewBinding.<span class="type">Builder</span> <span class="variable">viewBinding</span> <span class="operator">=</span> getOrCreateViewBindings(id);</span><br><span class="line">    viewBinding.setFieldBinding(binding);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 添加方法</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="type">boolean</span> <span class="title function_">addMethod</span><span class="params">(Id id, ListenerClass listener, ListenerMethod method, MethodViewBinding binding)</span> &#123;</span><br><span class="line">    ViewBinding.<span class="type">Builder</span> <span class="variable">viewBinding</span> <span class="operator">=</span> getOrCreateViewBindings(id);</span><br><span class="line">    <span class="keyword">if</span> (viewBinding.hasMethodBinding(listener, method) &amp;&amp; !<span class="string">&quot;void&quot;</span>.equals(method.returnType())) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    viewBinding.addMethodBinding(listener, method, binding);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 添加Field集合</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">addFieldCollection</span><span class="params">(FieldCollectionViewBinding binding)</span> &#123;</span><br><span class="line">    collectionBindings.add(binding);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    *  添加资源</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">addResource</span><span class="params">(ResourceBinding binding)</span> &#123;</span><br><span class="line">    resourceBindings.add(binding);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">setParent</span><span class="params">(BindingSet parent)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.parentBinding = parent;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 当前id是否已经被绑定了</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  String <span class="title function_">findExistingBindingName</span><span class="params">(Id id)</span> &#123;</span><br><span class="line">    ViewBinding.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> viewIdMap.get(id);</span><br><span class="line">    <span class="keyword">if</span> (builder == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">FieldViewBinding</span> <span class="variable">fieldBinding</span> <span class="operator">=</span> builder.fieldBinding;</span><br><span class="line">    <span class="keyword">if</span> (fieldBinding == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fieldBinding.getName();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 往viewIdMap中获取ViewBinding.Builder</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="keyword">private</span> ViewBinding.Builder <span class="title function_">getOrCreateViewBindings</span><span class="params">(Id id)</span> &#123;</span><br><span class="line">    ViewBinding.<span class="type">Builder</span> <span class="variable">viewId</span> <span class="operator">=</span> viewIdMap.get(id);</span><br><span class="line">    <span class="keyword">if</span> (viewId == <span class="literal">null</span>) &#123;</span><br><span class="line">      viewId = <span class="keyword">new</span> <span class="title class_">ViewBinding</span>.Builder(id);</span><br><span class="line">      viewIdMap.put(id, viewId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> viewId;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  BindingSet <span class="title function_">build</span><span class="params">()</span> &#123;</span><br><span class="line">    ImmutableList.Builder&lt;ViewBinding&gt; viewBindings = ImmutableList.builder();</span><br><span class="line">    <span class="keyword">for</span> (ViewBinding.Builder builder : viewIdMap.values()) &#123;</span><br><span class="line">      viewBindings.add(builder.build());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//将当前的绑定数据传到BindingSet</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BindingSet</span>(targetTypeName, bindingClassName, isFinal, isView, isActivity, isDialog,</span><br><span class="line">        viewBindings.build(), collectionBindings.build(), resourceBindings.build(), parentBinding);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们从BindingSet的Builder可以看出它有如下的成员变量：</p>
<figure class="highlight cos"><table><tr><td class="code"><pre><span class="line">parentBinding       指向父类的BindingSet。</span><br><span class="line">viewIdMap           与<span class="keyword">View</span>相关的绑定信息，包括<span class="keyword">view</span>对象以及事件方法。</span><br><span class="line">collectionBindings  多个<span class="keyword">view</span>集体绑定的情况</span><br><span class="line">resourceBindings    资源绑定</span><br></pre></td></tr></table></figure>
<p>它有如下方法：</p>
<figure class="highlight oxygene"><table><tr><td class="code"><pre><span class="line">void addField(Id id, FieldViewBinding binding)  添加Field</span><br><span class="line">boolean addMethod(Id id, ListenerClass listener, ListenerMethod <span class="keyword">method</span>, <span class="title function_">MethodViewBinding</span> <span class="title function_">binding</span>)  添加事件方法</span><br><span class="line"><span class="title function_">void</span> <span class="title function_">addFieldCollection</span><span class="params">(FieldCollectionViewBinding binding)</span>  添加<span class="title function_">Field</span>集合</span><br><span class="line"><span class="title function_">void</span> <span class="title function_">addResource</span><span class="params">(ResourceBinding binding)</span>  添加资源</span><br></pre></td></tr></table></figure>

<p>介绍完BindView 我也把事件绑定的方法贴出来了，下面有较为详细的注释。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">findAndParseListener</span><span class="params">(RoundEnvironment env, Class&lt;? extends Annotation&gt; annotationClass, Map&lt;TypeElement, BindingSet.Builder&gt; builderMap, Set&lt;TypeElement&gt; erasedTargetNames)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(annotationClass)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        parseListenerAnnotation(annotationClass, element, builderMap, erasedTargetNames);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="type">StringWriter</span> <span class="variable">stackTrace</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringWriter</span>();</span><br><span class="line">        e.printStackTrace(<span class="keyword">new</span> <span class="title class_">PrintWriter</span>(stackTrace));</span><br><span class="line">        error(element, <span class="string">&quot;Unable to generate view binder for @%s.\n\n%s&quot;</span>,</span><br><span class="line">            annotationClass.getSimpleName(), stackTrace.toString());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">parseListenerAnnotation</span><span class="params">(Class&lt;? extends Annotation&gt; annotationClass, Element element, Map&lt;TypeElement, BindingSet.Builder&gt; builderMap, Set&lt;TypeElement&gt; erasedTargetNames)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// This should be guarded by the annotation&#x27;s @Target but it&#x27;s worth a check for safe casting.</span></span><br><span class="line">    <span class="comment">//首先检查当前元素是否是方法类型</span></span><br><span class="line">    <span class="keyword">if</span> (!(element <span class="keyword">instanceof</span> ExecutableElement) || element.getKind() != METHOD) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(String.format(<span class="string">&quot;@%s annotation must be on a method.&quot;</span>, annotationClass.getSimpleName()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">ExecutableElement</span> <span class="variable">executableElement</span> <span class="operator">=</span> (ExecutableElement) element;</span><br><span class="line">    <span class="type">TypeElement</span> <span class="variable">enclosingElement</span> <span class="operator">=</span> (TypeElement) element.getEnclosingElement();</span><br><span class="line">    <span class="comment">//获取注解中的id数组</span></span><br><span class="line">    <span class="type">Annotation</span> <span class="variable">annotation</span> <span class="operator">=</span> element.getAnnotation(annotationClass);</span><br><span class="line">    <span class="type">Method</span> <span class="variable">annotationValue</span> <span class="operator">=</span> annotationClass.getDeclaredMethod(<span class="string">&quot;value&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (annotationValue.getReturnType() != <span class="type">int</span>[].class) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(String.format(<span class="string">&quot;@%s annotation value() type not int[].&quot;</span>, annotationClass));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span>[] ids = (<span class="type">int</span>[]) annotationValue.invoke(annotation);</span><br><span class="line">    <span class="comment">//方法名字</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> executableElement.getSimpleName().toString();</span><br><span class="line">    <span class="comment">//是否必须</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">required</span> <span class="operator">=</span> isListenerRequired(executableElement);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//校验是否错误</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">hasError</span> <span class="operator">=</span> isInaccessibleViaGeneratedCode(annotationClass, <span class="string">&quot;methods&quot;</span>, element);</span><br><span class="line">    hasError |= isBindingInWrongPackage(annotationClass, element);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查找是否有重复的id</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">duplicateId</span> <span class="operator">=</span> findDuplicate(ids);</span><br><span class="line">    <span class="keyword">if</span> (duplicateId != <span class="literal">null</span>) &#123;</span><br><span class="line">      error(element, <span class="string">&quot;@%s annotation for method contains duplicate ID %d. (%s.%s)&quot;</span>,</span><br><span class="line">          annotationClass.getSimpleName(), duplicateId, enclosingElement.getQualifiedName(),</span><br><span class="line">          element.getSimpleName());</span><br><span class="line">      hasError = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取到对应ListenerClass</span></span><br><span class="line">    <span class="type">ListenerClass</span> <span class="variable">listener</span> <span class="operator">=</span> annotationClass.getAnnotation(ListenerClass.class);</span><br><span class="line">    <span class="keyword">if</span> (listener == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(</span><br><span class="line">          String.format(<span class="string">&quot;No @%s defined on @%s.&quot;</span>, ListenerClass.class.getSimpleName(),</span><br><span class="line">              annotationClass.getSimpleName()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*@ListenerClass(</span></span><br><span class="line"><span class="comment">            targetType = &quot;android.view.View&quot;,</span></span><br><span class="line"><span class="comment">            setter = &quot;setOnClickListener&quot;,</span></span><br><span class="line"><span class="comment">            type = &quot;butterknife.internal.DebouncingOnClickListener&quot;,</span></span><br><span class="line"><span class="comment">            method = @ListenerMethod(</span></span><br><span class="line"><span class="comment">                    name = &quot;doClick&quot;,</span></span><br><span class="line"><span class="comment">                    parameters = &quot;android.view.View&quot;</span></span><br><span class="line"><span class="comment">            )</span></span><br><span class="line"><span class="comment">    )*/</span></span><br><span class="line">    ListenerMethod method;</span><br><span class="line">    ListenerMethod[] methods = listener.method();</span><br><span class="line">    <span class="comment">//获取onClick注解中@ListenerClass中的method</span></span><br><span class="line">    <span class="keyword">if</span> (methods.length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="comment">//不允许有两个以上的method</span></span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(String.format(<span class="string">&quot;Multiple listener methods specified on @%s.&quot;</span>, annotationClass.getSimpleName()));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (methods.length == <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="comment">//method 不允许和callbacks共存</span></span><br><span class="line">      <span class="keyword">if</span> (listener.callbacks() != ListenerClass.NONE.class) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(String.format(<span class="string">&quot;Both method() and callback() defined on @%s.&quot;</span>, annotationClass.getSimpleName()));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//获取到methods[0]</span></span><br><span class="line">      method = methods[<span class="number">0</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">//如果没有method就获取callback</span></span><br><span class="line">      <span class="type">Method</span> <span class="variable">annotationCallback</span> <span class="operator">=</span> annotationClass.getDeclaredMethod(<span class="string">&quot;callback&quot;</span>);</span><br><span class="line">      Enum&lt;?&gt; callback = (Enum&lt;?&gt;) annotationCallback.invoke(annotation);</span><br><span class="line">      <span class="type">Field</span> <span class="variable">callbackField</span> <span class="operator">=</span> callback.getDeclaringClass().getField(callback.name());</span><br><span class="line">      method = callbackField.getAnnotation(ListenerMethod.class);</span><br><span class="line">      <span class="keyword">if</span> (method == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(</span><br><span class="line">            String.format(<span class="string">&quot;No @%s defined on @%s&#x27;s %s.%s.&quot;</span>, ListenerMethod.class.getSimpleName(),</span><br><span class="line">                annotationClass.getSimpleName(), callback.getDeclaringClass().getSimpleName(),</span><br><span class="line">                callback.name()));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//验证回调方法的参数（实际被注释的方法参数不能大于注解中提供的参数个数）</span></span><br><span class="line">    <span class="comment">// Verify that the method has equal to or less than the number of parameters as the listener.</span></span><br><span class="line">    <span class="comment">//获取实际的方法参数</span></span><br><span class="line">    List&lt;? <span class="keyword">extends</span> <span class="title class_">VariableElement</span>&gt; methodParameters = executableElement.getParameters();</span><br><span class="line">    <span class="comment">//如果注解目标参数大于ListenerMethod注解指定的参数个数就报错</span></span><br><span class="line">    <span class="keyword">if</span> (methodParameters.size() &gt; method.parameters().length) &#123;</span><br><span class="line">      error(element, <span class="string">&quot;@%s methods can have at most %s parameter(s). (%s.%s)&quot;</span>,</span><br><span class="line">          annotationClass.getSimpleName(), method.parameters().length,</span><br><span class="line">          enclosingElement.getQualifiedName(), element.getSimpleName());</span><br><span class="line">      hasError = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证返回类型（实际被注释的方法参数需要等于注解中提供的参数类型）</span></span><br><span class="line">    <span class="comment">// Verify method return type matches the listener.</span></span><br><span class="line">    <span class="type">TypeMirror</span> <span class="variable">returnType</span> <span class="operator">=</span> executableElement.getReturnType();</span><br><span class="line">    <span class="keyword">if</span> (returnType <span class="keyword">instanceof</span> TypeVariable) &#123;</span><br><span class="line">      <span class="type">TypeVariable</span> <span class="variable">typeVariable</span> <span class="operator">=</span> (TypeVariable) returnType;</span><br><span class="line">      returnType = typeVariable.getUpperBound();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!returnType.toString().equals(method.returnType())) &#123;</span><br><span class="line">      error(element, <span class="string">&quot;@%s methods must have a &#x27;%s&#x27; return type. (%s.%s)&quot;</span>,</span><br><span class="line">          annotationClass.getSimpleName(), method.returnType(),</span><br><span class="line">          enclosingElement.getQualifiedName(), element.getSimpleName());</span><br><span class="line">      hasError = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//校验结束，如果有问题就不在继续</span></span><br><span class="line">    <span class="keyword">if</span> (hasError) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Parameter[] parameters = Parameter.NONE;</span><br><span class="line">    <span class="comment">//省略参数的创建过程</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//name 名字  parameters 参数  required 是否必须</span></span><br><span class="line">    <span class="type">MethodViewBinding</span> <span class="variable">binding</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MethodViewBinding</span>(name, Arrays.asList(parameters), required);</span><br><span class="line">    <span class="comment">//创建一个BindingSet.Builder</span></span><br><span class="line">    BindingSet.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> getOrCreateBindingBuilder(builderMap, enclosingElement);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> id : ids) &#123;</span><br><span class="line">      <span class="comment">//为每个id绑定一个方法</span></span><br><span class="line">      <span class="type">QualifiedId</span> <span class="variable">qualifiedId</span> <span class="operator">=</span> elementToQualifiedId(element, id);</span><br><span class="line">      <span class="comment">//ListenerClass listener = annotationClass.getAnnotation(ListenerClass.class);</span></span><br><span class="line">      <span class="keyword">if</span> (!builder.addMethod(getId(qualifiedId), listener, method, binding)) &#123;</span><br><span class="line">        error(element, <span class="string">&quot;Multiple listener methods with return value specified for ID %d. (%s.%s)&quot;</span>, id, enclosingElement.getQualifiedName(), element.getSimpleName());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Add the type-erased version to the valid binding targets set.</span></span><br><span class="line">    erasedTargetNames.add(enclosingElement);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>使用JavaPoest为每个BindingSet创建对应的_ViewBinding文件：<br>我们在此回到process方法</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">boolean</span> <span class="title function_">process</span>(<span class="params"><span class="built_in">Set</span>&lt;? <span class="keyword">extends</span> TypeElement&gt; elements, RoundEnvironment env</span>) &#123;</span><br><span class="line">  <span class="title class_">Map</span>&lt;<span class="title class_">TypeElement</span>, <span class="title class_">BindingSet</span>&gt; bindingMap = <span class="title function_">findAndParseTargets</span>(env);</span><br><span class="line">  <span class="keyword">for</span> (<span class="title class_">Map</span>.<span class="property">Entry</span>&lt;<span class="title class_">TypeElement</span>, <span class="title class_">BindingSet</span>&gt; entry : bindingMap.<span class="title function_">entrySet</span>()) &#123;</span><br><span class="line">    <span class="title class_">TypeElement</span> typeElement = entry.<span class="title function_">getKey</span>();</span><br><span class="line">    <span class="title class_">BindingSet</span> binding = entry.<span class="title function_">getValue</span>();</span><br><span class="line">    <span class="title class_">JavaFile</span> javaFile = binding.<span class="title function_">brewJava</span>(sdk);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      javaFile.<span class="title function_">writeTo</span>(filer);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="title class_">IOException</span> e) &#123;</span><br><span class="line">      <span class="title function_">error</span>(typeElement, <span class="string">&quot;Unable to write binding for type %s: %s&quot;</span>, typeElement, e.<span class="title function_">getMessage</span>());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们上面了解了如何从R文件中获取对应的信息构成后续作为Id使用的symbols。再对代码中使用到的Butterknife注解进行解析，获取到对应的View 绑定，事件方法绑定，资源绑定信息，添加到对应BingSet中，最后我们要了解的是最后一步 – 使用JavaPost来将BindingSet中收集到的View 绑定，事件方法绑定，资源绑定信息生成对应的源码：<br>我们先来看下brewJava 方法：</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">JavaFile brew<span class="constructor">Java(<span class="params">int</span> <span class="params">sdk</span>)</span> &#123;</span><br><span class="line">    return JavaFile</span><br><span class="line">            .builder(bindingClassName.package<span class="constructor">Name()</span><span class="comment">/*com.package.xxxx.MainActivity_BindingView*/</span>, create<span class="constructor">Type(<span class="params">sdk</span>)</span>)</span><br><span class="line">            .add<span class="constructor">FileComment(<span class="string">&quot;Generated code from Butter Knife. Do not modify!&quot;</span>)</span></span><br><span class="line">            .build<span class="literal">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>brewJava 方法中最重要的就是createType，它是生成_ViewBinding的核心代码，下面给出了详细的注释：</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> TypeSpec create<span class="constructor">Type(<span class="params">int</span> <span class="params">sdk</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用JavaPost 生成  &quot;public final class MainActivity_BindingView&quot;</span></span><br><span class="line">    TypeSpec.Builder result = <span class="module-access"><span class="module"><span class="identifier">TypeSpec</span>.</span></span><span class="keyword">class</span><span class="constructor">Builder(<span class="params">bindingClassName</span>.<span class="params">simpleName</span>()</span>).add<span class="constructor">Modifiers(PUBLIC)</span>;</span><br><span class="line">    <span class="keyword">if</span> (isFinal) &#123;</span><br><span class="line">      result.add<span class="constructor">Modifiers(FINAL)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//生成 public final class MainActivity_BindingView extends Unbinder</span></span><br><span class="line">    <span class="comment">//或者 public final class MainActivity_BindingView extends XXXXActivity_BindingView</span></span><br><span class="line">    <span class="comment">//查看是否父类有绑定，添加绑定类的父类</span></span><br><span class="line">    <span class="keyword">if</span> (parentBinding != null) &#123;</span><br><span class="line">      result.superclass(parentBinding.bindingClassName);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      result.add<span class="constructor">Superinterface(UNBINDER)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//是否有方法或者值绑定，如果有那么添加target成员,在只有资源绑定的情况下就没有target成员变量</span></span><br><span class="line">    <span class="keyword">if</span> (has<span class="constructor">TargetField()</span>) &#123;</span><br><span class="line">      result.add<span class="constructor">Field(<span class="params">targetTypeName</span>, <span class="string">&quot;target&quot;</span>, PRIVATE)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建对应的构造方法</span></span><br><span class="line">    <span class="keyword">if</span> (isView) &#123;</span><br><span class="line">      result.add<span class="constructor">Method(<span class="params">createBindingConstructorForView</span>()</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isActivity) &#123;</span><br><span class="line">      result.add<span class="constructor">Method(<span class="params">createBindingConstructorForActivity</span>()</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isDialog) &#123;</span><br><span class="line">      result.add<span class="constructor">Method(<span class="params">createBindingConstructorForDialog</span>()</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加一个废弃的方法用于在Butterknife.bind方法反射时候使用</span></span><br><span class="line">    <span class="keyword">if</span> (!constructor<span class="constructor">NeedsView()</span>) &#123;</span><br><span class="line">      result.add<span class="constructor">Method(<span class="params">createBindingViewDelegateConstructor</span>()</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    result.add<span class="constructor">Method(<span class="params">createBindingConstructor</span>(<span class="params">sdk</span>)</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加unbind方法</span></span><br><span class="line">    <span class="keyword">if</span> (has<span class="constructor">ViewBindings()</span><span class="operator"> || </span>parentBinding<span class="operator"> == </span>null) &#123;</span><br><span class="line">      result.add<span class="constructor">Method(<span class="params">createBindingUnbindMethod</span>(<span class="params">result</span>)</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    return result.build<span class="literal">()</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>那么我们在Butterknife bind方法中调用的构造函数是哪个呢：就是createBindingConstructor</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> MethodSpec create<span class="constructor">BindingConstructor(<span class="params">int</span> <span class="params">sdk</span>)</span> &#123;</span><br><span class="line">  <span class="comment">//添加一个无参数的构造方法</span></span><br><span class="line">  <span class="comment">//@UiThread</span></span><br><span class="line">  <span class="comment">//public class MainActivity_BindingView &#123;</span></span><br><span class="line">  <span class="comment">//   MainActivity_BindingView(Activity target,View source) &#123;</span></span><br><span class="line">  <span class="comment">//      super(target, source);</span></span><br><span class="line">  <span class="comment">//      this.target = target</span></span><br><span class="line">  <span class="comment">//   &#125;</span></span><br><span class="line">  <span class="comment">//&#125;</span></span><br><span class="line">  MethodSpec.Builder constructor = <span class="module-access"><span class="module"><span class="identifier">MethodSpec</span>.</span></span>constructor<span class="constructor">Builder()</span></span><br><span class="line">      .add<span class="constructor">Annotation(UI_THREAD)</span></span><br><span class="line">      .add<span class="constructor">Modifiers(PUBLIC)</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (has<span class="constructor">MethodBindings()</span>) &#123;</span><br><span class="line">    constructor.add<span class="constructor">Parameter(<span class="params">targetTypeName</span>, <span class="string">&quot;target&quot;</span>, FINAL)</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    constructor.add<span class="constructor">Parameter(<span class="params">targetTypeName</span>, <span class="string">&quot;target&quot;</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//如果跟View相关那么添加成员变量source 否则添加成员变量context</span></span><br><span class="line">  <span class="keyword">if</span> (constructor<span class="constructor">NeedsView()</span>) &#123;</span><br><span class="line">    constructor.add<span class="constructor">Parameter(VIEW, <span class="string">&quot;source&quot;</span>)</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    constructor.add<span class="constructor">Parameter(CONTEXT, <span class="string">&quot;context&quot;</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (has<span class="constructor">UnqualifiedResourceBindings()</span>) &#123;</span><br><span class="line">    <span class="comment">// Aapt can change IDs out from underneath us, just suppress since all will work at runtime.</span></span><br><span class="line">    constructor.add<span class="constructor">Annotation(AnnotationSpec.<span class="params">builder</span>(SuppressWarnings.<span class="params">class</span>)</span></span><br><span class="line">        .add<span class="constructor">Member(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;$S&quot;</span>, <span class="string">&quot;ResourceType&quot;</span>)</span></span><br><span class="line">        .build<span class="literal">()</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//是否有onTouch事件绑定</span></span><br><span class="line">  <span class="keyword">if</span> (has<span class="constructor">OnTouchMethodBindings()</span>) &#123;</span><br><span class="line">    constructor.add<span class="constructor">Annotation(AnnotationSpec.<span class="params">builder</span>(SUPPRESS_LINT)</span></span><br><span class="line">        .add<span class="constructor">Member(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;$S&quot;</span>, <span class="string">&quot;ClickableViewAccessibility&quot;</span>)</span></span><br><span class="line">        .build<span class="literal">()</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//添加对父类构造方法的调用</span></span><br><span class="line">  <span class="keyword">if</span> (parentBinding != null) &#123;</span><br><span class="line">    <span class="keyword">if</span> (parentBinding.constructor<span class="constructor">NeedsView()</span>) &#123;</span><br><span class="line">      constructor.add<span class="constructor">Statement(<span class="string">&quot;super(target, source)&quot;</span>)</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (constructor<span class="constructor">NeedsView()</span>) &#123;</span><br><span class="line">      constructor.add<span class="constructor">Statement(<span class="string">&quot;super(target, source.getContext())&quot;</span>)</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      constructor.add<span class="constructor">Statement(<span class="string">&quot;super(target, context)&quot;</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    constructor.add<span class="constructor">Code(<span class="string">&quot;\n&quot;</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//给target赋值</span></span><br><span class="line">  <span class="keyword">if</span> (has<span class="constructor">TargetField()</span>) &#123;</span><br><span class="line">    constructor.add<span class="constructor">Statement(<span class="string">&quot;this.target = target&quot;</span>)</span>;</span><br><span class="line">    constructor.add<span class="constructor">Code(<span class="string">&quot;\n&quot;</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//添加View 绑定</span></span><br><span class="line">  <span class="keyword">if</span> (has<span class="constructor">ViewBindings()</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (has<span class="constructor">ViewLocal()</span>) &#123;</span><br><span class="line">      <span class="comment">// Local variable in which all views will be temporarily stored.</span></span><br><span class="line">      constructor.add<span class="constructor">Statement(<span class="string">&quot;$T view&quot;</span>, VIEW)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//添加绑定的View,这里是重点</span></span><br><span class="line">    <span class="keyword">for</span> (ViewBinding binding : viewBindings) &#123;</span><br><span class="line">      add<span class="constructor">ViewBinding(<span class="params">constructor</span>, <span class="params">binding</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (FieldCollectionViewBinding binding : collectionBindings) &#123;</span><br><span class="line">      constructor.add<span class="constructor">Statement(<span class="string">&quot;$L&quot;</span>, <span class="params">binding</span>.<span class="params">render</span>()</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!resourceBindings.is<span class="constructor">Empty()</span>) &#123;</span><br><span class="line">      constructor.add<span class="constructor">Code(<span class="string">&quot;\n&quot;</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//添加其他绑定</span></span><br><span class="line">  <span class="keyword">if</span> (!resourceBindings.is<span class="constructor">Empty()</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (constructor<span class="constructor">NeedsView()</span>) &#123;</span><br><span class="line">      constructor.add<span class="constructor">Statement(<span class="string">&quot;$T context = source.getContext()&quot;</span>, CONTEXT)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (has<span class="constructor">ResourceBindingsNeedingResource(<span class="params">sdk</span>)</span>) &#123;</span><br><span class="line">      constructor.add<span class="constructor">Statement(<span class="string">&quot;$T res = context.getResources()&quot;</span>, RESOURCES)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (ResourceBinding binding : resourceBindings) &#123;</span><br><span class="line">      constructor.add<span class="constructor">Statement(<span class="string">&quot;$L&quot;</span>, <span class="params">binding</span>.<span class="params">render</span>(<span class="params">sdk</span>)</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return constructor.build<span class="literal">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码已经注释很清楚了，我们直接讲最重要的：addViewBinding，在调用addViewBinding之前会调用hasViewBindings来判断当前是否有view绑定以及事件方法绑定，如果有才会调用addViewBinding.<br>在addViewBinding方法中会判断是否isRequired来决定是调用butterknife.internal.Utils的findRequiredViewAsType 还是findOptionalView</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_ invoke__">addViewBinding</span>(MethodSpec.Builder result, ViewBinding binding) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (binding.<span class="title function_ invoke__">isSingleFieldBinding</span>()) &#123;</span><br><span class="line">      FieldViewBinding fieldBinding = binding.<span class="title function_ invoke__">getFieldBinding</span>();</span><br><span class="line">      CodeBlock.Builder builder = CodeBlock.<span class="title function_ invoke__">builder</span>().<span class="title function_ invoke__">add</span>(<span class="string">&quot;target.<span class="subst">$L</span> = &quot;</span>, fieldBinding.<span class="title function_ invoke__">getName</span>());</span><br><span class="line">      <span class="comment">//生成target.mTextBtn =</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">//是否需要强制转换</span></span><br><span class="line">      <span class="keyword">boolean</span> requiresCast = <span class="title function_ invoke__">requiresCast</span>(fieldBinding.<span class="title function_ invoke__">getType</span>());</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!requiresCast &amp;&amp; !fieldBinding.<span class="title function_ invoke__">isRequired</span>()) &#123;</span><br><span class="line">        <span class="comment">//生成 target.mTextBtn = source.findViewById(id)</span></span><br><span class="line">        builder.<span class="title function_ invoke__">add</span>(<span class="string">&quot;source.findViewById(<span class="subst">$L</span>)&quot;</span>, binding.<span class="title function_ invoke__">getId</span>().code);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        builder.<span class="title function_ invoke__">add</span>(<span class="string">&quot;<span class="subst">$T</span>.find&quot;</span>, UTILS);</span><br><span class="line">        builder.<span class="title function_ invoke__">add</span>(fieldBinding.<span class="title function_ invoke__">isRequired</span>() ? <span class="string">&quot;RequiredView&quot;</span> : <span class="string">&quot;OptionalView&quot;</span>);</span><br><span class="line">        <span class="comment">//调用butterknife.internal.Utils的findRequiredViewAsType 或者findOptionalView</span></span><br><span class="line">        <span class="keyword">if</span> (requiresCast) &#123;</span><br><span class="line">          builder.<span class="title function_ invoke__">add</span>(<span class="string">&quot;AsType&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        builder.<span class="title function_ invoke__">add</span>(<span class="string">&quot;(source, <span class="subst">$L</span>&quot;</span>, binding.<span class="title function_ invoke__">getId</span>().code);</span><br><span class="line">        <span class="keyword">if</span> (fieldBinding.<span class="title function_ invoke__">isRequired</span>() || requiresCast) &#123;</span><br><span class="line">          builder.<span class="title function_ invoke__">add</span>(<span class="string">&quot;, <span class="subst">$S</span>&quot;</span>, <span class="title function_ invoke__">asHumanDescription</span>(<span class="title function_ invoke__">singletonList</span>(fieldBinding)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (requiresCast) &#123;</span><br><span class="line">          builder.<span class="title function_ invoke__">add</span>(<span class="string">&quot;, <span class="subst">$T</span>.class&quot;</span>, fieldBinding.<span class="title function_ invoke__">getRawType</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        builder.<span class="title function_ invoke__">add</span>(<span class="string">&quot;)&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      result.<span class="title function_ invoke__">addStatement</span>(<span class="string">&quot;<span class="subst">$L</span>&quot;</span>, builder.<span class="title function_ invoke__">build</span>());</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;MemberViewBinding&gt; requiredBindings = binding.<span class="title function_ invoke__">getRequiredBindings</span>();</span><br><span class="line">    <span class="keyword">if</span> (requiredBindings.<span class="title function_ invoke__">isEmpty</span>()) &#123;</span><br><span class="line">      result.<span class="title function_ invoke__">addStatement</span>(<span class="string">&quot;view = source.findViewById(<span class="subst">$L</span>)&quot;</span>, binding.<span class="title function_ invoke__">getId</span>().code);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!binding.<span class="title function_ invoke__">isBoundToRoot</span>()) &#123;</span><br><span class="line">      result.<span class="title function_ invoke__">addStatement</span>(<span class="string">&quot;view = <span class="subst">$T</span>.findRequiredView(source, <span class="subst">$L</span>, <span class="subst">$S</span>)&quot;</span>, UTILS,</span><br><span class="line">              binding.<span class="title function_ invoke__">getId</span>().code, <span class="title function_ invoke__">asHumanDescription</span>(requiredBindings));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//添加成员变量绑定</span></span><br><span class="line">    <span class="title function_ invoke__">addFieldBinding</span>(result, binding);</span><br><span class="line">    <span class="comment">//添加方法绑定</span></span><br><span class="line">    <span class="title function_ invoke__">addMethodBindings</span>(result, binding);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>findOptionalViewAsType 和 findRequiredViewAsType 有什么区别呢？我们从下面代码可以看出findRequiredViewAsType会在source中获取对应的控件，后判断是否获取到，如果没有获取到会抛出如下异常：</p>
<figure class="highlight haxe"><table><tr><td class="code"><pre><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">IllegalStateException</span>(<span class="string">&quot;Required view &#x27;&quot;</span></span><br><span class="line">    + name</span><br><span class="line">    + <span class="string">&quot;&#x27; with ID &quot;</span></span><br><span class="line">    + id</span><br><span class="line">    + <span class="string">&quot; for &quot;</span></span><br><span class="line">    + who</span><br><span class="line">    + <span class="string">&quot; was not found. If this view is optional add &#x27;@Nullable&#x27; (fields) or &#x27;@Optional&#x27;&quot;</span></span><br><span class="line">    + <span class="string">&quot; (methods) annotation.&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>而最终的类型转换是通过cls.cast 方法来完成的。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">findOptionalViewAsType</span>(<span class="params">View source, <span class="meta">@IdRes</span> int id, <span class="built_in">String</span> who,</span></span><br><span class="line"><span class="params">    Class&lt;T&gt; cls</span>) &#123;</span><br><span class="line">  <span class="title class_">View</span> view = source.<span class="title function_">findViewById</span>(id);</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">castView</span>(view, id, who, cls);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">findRequiredViewAsType</span>(<span class="params">View source, <span class="meta">@IdRes</span> int id, <span class="built_in">String</span> who,</span></span><br><span class="line"><span class="params">    Class&lt;T&gt; cls</span>) &#123;</span><br><span class="line">  <span class="title class_">View</span> view = <span class="title function_">findRequiredView</span>(source, id, who);</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">castView</span>(view, id, who, cls);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="title class_">View</span> <span class="title function_">findRequiredView</span>(<span class="params">View source, <span class="meta">@IdRes</span> int id, <span class="built_in">String</span> who</span>) &#123;</span><br><span class="line">  <span class="title class_">View</span> view = source.<span class="title function_">findViewById</span>(id);</span><br><span class="line">  <span class="keyword">if</span> (view != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> view;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title class_">String</span> name = <span class="title function_">getResourceEntryName</span>(source, id);</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Required view &#x27;&quot;</span></span><br><span class="line">      + name</span><br><span class="line">      + <span class="string">&quot;&#x27; with ID &quot;</span></span><br><span class="line">      + id</span><br><span class="line">      + <span class="string">&quot; for &quot;</span></span><br><span class="line">      + who</span><br><span class="line">      + <span class="string">&quot; was not found. If this view is optional add &#x27;@Nullable&#x27; (fields) or &#x27;@Optional&#x27;&quot;</span></span><br><span class="line">      + <span class="string">&quot; (methods) annotation.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">castView</span>(<span class="params">View view, <span class="meta">@IdRes</span> int id, <span class="built_in">String</span> who, Class&lt;T&gt; cls</span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> cls.<span class="title function_">cast</span>(view);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (<span class="title class_">ClassCastException</span> e) &#123;</span><br><span class="line">    <span class="title class_">String</span> name = <span class="title function_">getResourceEntryName</span>(view, id);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;View &#x27;&quot;</span></span><br><span class="line">        + name</span><br><span class="line">        + <span class="string">&quot;&#x27; with ID &quot;</span></span><br><span class="line">        + id</span><br><span class="line">        + <span class="string">&quot; for &quot;</span></span><br><span class="line">        + who</span><br><span class="line">        + <span class="string">&quot; was of the wrong type. See cause for more info.&quot;</span>, e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>到此为止整个Butterknife源码分析完毕。老规矩上图：<br><img src="/2017/05/02/%E5%BC%80%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BButterknife/image001.png"></p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/%E5%BC%80%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/">开源代码分析</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/开源代码分析/">开源代码分析</a>
  </div>

</div>



</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2017/05/26/开源代码分析之EventBus/" title="开源代码分析之EventBus">
  <span>
  开源代码分析之EventBus</span>
</a>
</div>


<div class="next">
<a href="/2017/05/02/一步一步编写编译时注释框架-1/"  title="一步一步编写编译时注释框架[1]">
 <span>一步一步编写编译时注释框架[1]
</span>
</a>
</div>

</nav>

	
<section id="comments" class="comment">
	<div class="ds-thread" data-thread-key="2017/05/02/开源代码分析之Butterknife/" data-title="开源代码分析之Butterknife" data-url="http://yoursite.com/2017/05/02/%E5%BC%80%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BButterknife/"></div>
</section>


<section id="comments" class="comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
 
 <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84-%EF%BC%9A"><span class="toc-number">1.</span> <span class="toc-text">[项目结构]：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%91%E5%AE%9A%E8%BF%87%E7%A8%8B-%EF%BC%9A"><span class="toc-number">2.</span> <span class="toc-text">[绑定过程]：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Butterknife%E6%B3%A8%E9%87%8A%E8%A7%A3%E6%9E%90%E5%99%A8ButterknifeProcessor-%EF%BC%9A"><span class="toc-number">3.</span> <span class="toc-text">[Butterknife注释解析器ButterknifeProcessor]：</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">
<div id="authorInfo">
	
		<div class="author-img"></div>		
	
	<div class="social-info" class="clearfix">
		
		
		<a href="https://github.com/tbfungeek" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
		
		<a href="mailto:tbfungeek@163.com" target="_blank" class="icon-email" title="Email Me"></a>
		

	</div>
</div>

  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
		  
			<li><a href="/categories/Android-小经验/" title="Android 小经验">Android 小经验<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android-源码分析/" title="Android 源码分析">Android 源码分析<sup>21</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android其他/" title="Android其他">Android其他<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android初步/" title="Android初步">Android初步<sup>21</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android进阶/" title="Android进阶">Android进阶<sup>100</sup></a></li>
		  
		
		  
			<li><a href="/categories/Hexo-使用/" title="Hexo 使用">Hexo 使用<sup>10</sup></a></li>
		  
		
		  
			<li><a href="/categories/JavaScript理论/" title="JavaScript理论">JavaScript理论<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Objective-C-相关/" title="Objective C 相关">Objective C 相关<sup>24</sup></a></li>
		  
		
		  
			<li><a href="/categories/OpenCV/" title="OpenCV">OpenCV<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/ROS/" title="ROS">ROS<sup>9</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-工具使用/" title="iOS 工具使用">iOS 工具使用<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-开源库分析/" title="iOS 开源库分析">iOS 开源库分析<sup>36</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-理论基础/" title="iOS 理论基础">iOS 理论基础<sup>14</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-进阶/" title="iOS 进阶">iOS 进阶<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/个人收藏/" title="个人收藏">个人收藏<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/代码规范/" title="代码规范">代码规范<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/其他/" title="其他">其他<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/博客分类目录/" title="博客分类目录">博客分类目录<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/叨叨系列/" title="叨叨系列">叨叨系列<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/开源代码分析/" title="开源代码分析">开源代码分析<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/开源库分析/" title="开源库分析">开源库分析<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/树莓派/" title="树莓派">树莓派<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/版本控制/" title="版本控制">版本控制<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/直播/" title="直播">直播<sup>6</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/iOS-开源库分析/" title="iOS 开源库分析">iOS 开源库分析<sup>36</sup></a></li>
			
		
			
				<li><a href="/tags/Android-设计模式/" title="Android 设计模式">Android 设计模式<sup>29</sup></a></li>
			
		
			
				<li><a href="/tags/Objective-C-相关/" title="Objective C 相关">Objective C 相关<sup>24</sup></a></li>
			
		
			
				<li><a href="/tags/Android基础/" title="Android基础">Android基础<sup>21</sup></a></li>
			
		
			
				<li><a href="/tags/AOSP-源码/" title="AOSP 源码">AOSP 源码<sup>17</sup></a></li>
			
		
			
				<li><a href="/tags/Android-常用第三方库/" title="Android 常用第三方库">Android 常用第三方库<sup>15</sup></a></li>
			
		
			
				<li><a href="/tags/iOS-理论基础/" title="iOS 理论基础">iOS 理论基础<sup>14</sup></a></li>
			
		
			
				<li><a href="/tags/Hexo-使用/" title="Hexo 使用">Hexo 使用<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/ROS/" title="ROS">ROS<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/Android-动画进阶/" title="Android 动画进阶">Android 动画进阶<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/Android-JNI/" title="Android JNI">Android JNI<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android-绘图进阶/" title="Android 绘图进阶">Android 绘图进阶<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android性能优化/" title="Android性能优化">Android性能优化<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android-自动化测试/" title="Android 自动化测试">Android 自动化测试<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/OpenCV/" title="OpenCV">OpenCV<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/直播/" title="直播">直播<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android-开源源码/" title="Android 开源源码">Android 开源源码<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Android-自定义View进阶/" title="Android 自定义View进阶">Android 自定义View进阶<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/树莓派/" title="树莓派">树莓派<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/iOS-进阶/" title="iOS 进阶">iOS 进阶<sup>4</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="https://hexo.io" target="_blank" title="Hexo">Hexo</a>
            
          </li>
        
          <li>
            
            	<a href="https://pages.github.com/" target="_blank" title="GitHub">GitHub</a>
            
          </li>
        
          <li>
            
            	<a href="http://pf18.github.io/" target="_blank" title="PF18">PF18</a>
            
          </li>
        
          <li>
            
            	<a href="http://toutiao.io/" target="_blank" title="开发者头条">开发者头条</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.jcodecraeer.com/" target="_blank" title="泡在网上的日子">泡在网上的日子</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="atom.xml" target="_blank" title="rss">RSS</a>
</div>

  
  <div class="tagcloudlist">
    <p class="asidetitle">Tag Cloud</p>
    <div class="tagcloudlist clearfix">
       <a href="/tags/AOSP-%E6%BA%90%E7%A0%81/" style="font-size: 17.14px;">AOSP 源码</a> <a href="/tags/Android-APK-%E7%AD%BE%E5%90%8D/" style="font-size: 10px;">Android APK 签名</a> <a href="/tags/Android-JNI/" style="font-size: 12.86px;">Android JNI</a> <a href="/tags/Android-%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E8%BF%9B%E9%98%B6/" style="font-size: 10.71px;">Android 事件处理进阶</a> <a href="/tags/Android-%E5%8A%A8%E7%94%BB%E8%BF%9B%E9%98%B6/" style="font-size: 13.57px;">Android 动画进阶</a> <a href="/tags/Android-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%BC%80%E5%8F%91/" style="font-size: 10px;">Android 多线程开发</a> <a href="/tags/Android-%E5%B0%8F%E7%BB%8F%E9%AA%8C/" style="font-size: 10px;">Android 小经验</a> <a href="/tags/Android-%E5%B8%B8%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93/" style="font-size: 16.43px;">Android 常用第三方库</a> <a href="/tags/Android-%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B/" style="font-size: 10px;">Android 开发流程</a> <a href="/tags/Android-%E5%BC%80%E6%BA%90%E6%BA%90%E7%A0%81/" style="font-size: 12.14px;">Android 开源源码</a> <a href="/tags/Android-%E7%BB%98%E5%9B%BE%E8%BF%9B%E9%98%B6/" style="font-size: 12.86px;">Android 绘图进阶</a> <a href="/tags/Android-%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/" style="font-size: 12.86px;">Android 自动化测试</a> <a href="/tags/Android-%E8%87%AA%E5%AE%9A%E4%B9%89View%E8%BF%9B%E9%98%B6/" style="font-size: 12.14px;">Android 自定义View进阶</a> <a href="/tags/Android-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 19.29px;">Android 设计模式</a> <a href="/tags/Android%E5%85%B6%E4%BB%96/" style="font-size: 10px;">Android其他</a> <a href="/tags/Android%E5%9F%BA%E7%A1%80/" style="font-size: 17.86px;">Android基础</a> <a href="/tags/Android%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B/" style="font-size: 10px;">Android开发流程</a> <a href="/tags/Android%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" style="font-size: 12.86px;">Android性能优化</a> <a href="/tags/Android%E6%B7%B7%E6%B7%86%E6%8A%80%E6%9C%AF/" style="font-size: 10px;">Android混淆技术</a> <a href="/tags/Android%E8%B4%A8%E9%87%8F%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/" style="font-size: 11.43px;">Android质量管理工具</a> <a href="/tags/Android%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/" style="font-size: 10px;">Android逆向工程</a> <a href="/tags/Git-github/" style="font-size: 10px;">Git && github</a> <a href="/tags/Hexo-%E4%BD%BF%E7%94%A8/" style="font-size: 15px;">Hexo 使用</a> <a href="/tags/JavaScript/" style="font-size: 10px;">JavaScript</a> <a href="/tags/Linux-%E4%BD%BF%E7%94%A8/" style="font-size: 10px;">Linux 使用</a> <a href="/tags/Objective-C-%E7%9B%B8%E5%85%B3/" style="font-size: 18.57px;">Objective C 相关</a> <a href="/tags/OpenCV/" style="font-size: 12.86px;">OpenCV</a> <a href="/tags/ROS/" style="font-size: 14.29px;">ROS</a> <a href="/tags/iOS-%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/" style="font-size: 10.71px;">iOS 工具使用</a> <a href="/tags/iOS-%E5%BC%80%E6%BA%90%E5%BA%93%E5%88%86%E6%9E%90/" style="font-size: 20px;">iOS 开源库分析</a> <a href="/tags/iOS-%E7%90%86%E8%AE%BA%E5%9F%BA%E7%A1%80/" style="font-size: 15.71px;">iOS 理论基础</a> <a href="/tags/iOS-%E8%BF%9B%E9%98%B6/" style="font-size: 12.14px;">iOS 进阶</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83/" style="font-size: 10px;">代码规范</a> <a href="/tags/%E5%8D%9A%E5%AE%A2%E5%88%86%E7%B1%BB%E7%9B%AE%E5%BD%95/" style="font-size: 10.71px;">博客分类目录</a> <a href="/tags/%E5%8F%A8%E5%8F%A8%E7%B3%BB%E5%88%97/" style="font-size: 10px;">叨叨系列</a> <a href="/tags/%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8/" style="font-size: 11.43px;">工具的使用</a> <a href="/tags/%E5%BC%80%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/" style="font-size: 10.71px;">开源代码分析</a> <a href="/tags/%E5%BC%80%E6%BA%90%E5%BA%93%E5%88%86%E6%9E%90/" style="font-size: 10px;">开源库分析</a> <a href="/tags/%E6%9D%82%E7%B1%BB/" style="font-size: 10px;">杂类</a> <a href="/tags/%E6%A0%91%E8%8E%93%E6%B4%BE/" style="font-size: 12.14px;">树莓派</a> <a href="/tags/%E7%9B%B4%E6%92%AD/" style="font-size: 12.86px;">直播</a> <a href="/tags/%E7%BC%96%E7%A8%8B%E6%8A%80%E5%B7%A7/" style="font-size: 10.71px;">编程技巧</a> <a href="/tags/%E7%BD%91%E7%AB%99%E6%94%B6%E8%97%8F/" style="font-size: 10px;">网站收藏</a> <a href="/tags/%E9%87%8D%E8%A6%81%E6%8E%A7%E4%BB%B6/" style="font-size: 11.43px;">重要控件</a>
    </div>
  </div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
		
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/hsihohuang/kiddochan" target="_blank" title="Kiddochan">Kiddochan</a> © 2022 
		
		<a href="/about" target="_blank" title="Edgar">Edgar</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
        getSize();
        if (myWidth >= 1024) {
          c.click();
        }
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>




<script type="text/javascript">
  var duoshuoQuery = {short_name:"tbfungeek"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 


<script type="text/javascript">

var disqus_shortname = 'tbfungeek';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>






<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?7c9443b0374f1cf6b1dbb5ab84d939cb";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
