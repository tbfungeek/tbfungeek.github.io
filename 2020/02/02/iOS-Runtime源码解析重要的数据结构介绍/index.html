
 <!DOCTYPE HTML>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  
    <title>iOS Runtime源码解析重要的数据结构介绍 | Edgar&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Edgar">
    

    
    <meta name="description" content="很早之前写过图解Runtime系列，那时候比较忙只是画了流程图，当然对自己理解已经够用了，但是对于没有看过源码对同学可能会看不懂，想着一个系列的博客都快完成了，少了这块总觉得缺了什么，并且Runtime是iOS的核心对理解底层有很大帮助，所以找了个空余时间将这块补上了。 我们知道编程语言有静态语言和动态语言之分，静态语言在编译的时候就已经明确了每行代码最终执行哪些代码，Objective C 作为">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS Runtime源码解析重要的数据结构介绍">
<meta property="og:url" content="http://yoursite.com/2020/02/02/iOS-Runtime%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E9%87%8D%E8%A6%81%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%BB%8B%E7%BB%8D/index.html">
<meta property="og:site_name" content="Edgar&#39;s Blog">
<meta property="og:description" content="很早之前写过图解Runtime系列，那时候比较忙只是画了流程图，当然对自己理解已经够用了，但是对于没有看过源码对同学可能会看不懂，想着一个系列的博客都快完成了，少了这块总觉得缺了什么，并且Runtime是iOS的核心对理解底层有很大帮助，所以找了个空余时间将这块补上了。 我们知道编程语言有静态语言和动态语言之分，静态语言在编译的时候就已经明确了每行代码最终执行哪些代码，Objective C 作为">
<meta property="og:locale">
<meta property="og:image" content="http://yoursite.com/2020/02/02/iOS-Runtime%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E9%87%8D%E8%A6%81%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%BB%8B%E7%BB%8D/000000001.png">
<meta property="og:image" content="http://yoursite.com/2020/02/02/iOS-Runtime%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E9%87%8D%E8%A6%81%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%BB%8B%E7%BB%8D/000000002.png">
<meta property="article:published_time" content="2020-02-01T23:49:22.000Z">
<meta property="article:modified_time" content="2020-02-06T14:01:12.000Z">
<meta property="article:author" content="Edgar">
<meta property="article:tag" content="Objective C 相关">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/2020/02/02/iOS-Runtime%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E9%87%8D%E8%A6%81%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%BB%8B%E7%BB%8D/000000001.png">

    
    <link rel="alternative" href="atom.xml" title="Edgar&#39;s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/unnamed4_n_mSY_icon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/profile.png">
    <link rel="apple-touch-icon-precomposed" href="/img/profile.png">
    
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.2.0"></head>

  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Edgar&#39;s Blog">Edgar&#39;s Blog</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
					<li>
 					
					<form class="search" action="/search/index.html" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" autocomplete="off" name="q" maxlength="20" placeholder="Search" />
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2020/02/02/iOS-Runtime源码解析重要的数据结构介绍/" title="iOS Runtime源码解析重要的数据结构介绍" itemprop="url">iOS Runtime源码解析重要的数据结构介绍</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Edgar" target="_blank" itemprop="author">Edgar</a>
		
  <p class="article-time">
    <time datetime="2020-02-01T23:49:22.000Z" itemprop="datePublished"> Published 2020-02-02</time>
    
  </p>
</header>
	<div class="article-content">
		
		<p>很早之前写过图解Runtime系列，那时候比较忙只是画了流程图，当然对自己理解已经够用了，但是对于没有看过源码对同学可能会看不懂，想着一个系列的博客都快完成了，少了这块总觉得缺了什么，并且Runtime是iOS的核心对理解底层有很大帮助，所以找了个空余时间将这块补上了。</p>
<p>我们知道编程语言有静态语言和动态语言之分，静态语言在编译的时候就已经明确了每行代码最终执行哪些代码，Objective C 作为动态语言它的底层是由编译器和Runtime构成，编译时期只是决定向某个对象发送某个消息，但是最终这个对象怎么处理这个消息取决于这个对象而不是固定的，也就是说在编译之后还可以针对发过来的消息对这个消息进行一系列处理最终决定执行哪些代码，这部分工作都交由Runtime处理。在介绍Runtime细节之前我们先看下相关的数据结构，熟悉这些数据结构对理解Runtime来说是必不可少的。本文将以Objc 2.0 中的数据结构为研究对象。</p>
<p>我们上层最经常接触的应该算是<strong><strong>Class</strong></strong>和<strong><strong>id</strong></strong>这两个类型了，它实际上分别是****objc_class * <strong><strong>，</strong></strong>objc_object * ****的重定义类型。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">objc_class</span> *Class;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">objc_object</span> *id;</span><br></pre></td></tr></table></figure>

<ul>
<li><h6 id="objc-object-结构"><a href="#objc-object-结构" class="headerlink" title="objc_object 结构"></a><strong><strong>objc_object 结构</strong></strong></h6></li>
</ul>
<p>objc_object里面有个重要的成员对象<strong><strong>isa_t isa</strong></strong>，因为objc_object是用来存储对象数据用的，所以不宜将无用的数据存储在objc_object上，所以这里只存放了<strong><strong>isa_t isa</strong></strong>，通过<strong><strong>isa_t isa</strong></strong>可以找到objc_class，objc_class中存放的才是这些对象公用的数据。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">objc_object</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">isa_t</span> isa;</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li><h6 id="objc-class-结构"><a href="#objc-class-结构" class="headerlink" title="objc_class 结构"></a><strong><strong>objc_class 结构</strong></strong></h6></li>
</ul>
<p>objc_class结构如下所示：</p>
<figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">objc_class</span> : objc_object &#123;</span><br><span class="line">    <span class="comment">// Class ISA;</span></span><br><span class="line">    Class superclass;</span><br><span class="line">    <span class="type">cache_t</span> cache;             <span class="comment">// formerly cache pointer and vtable</span></span><br><span class="line">    <span class="type">class_data_bits_t</span> bits;    <span class="comment">// class_rw_t * plus custom rr/alloc flags</span></span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>我们从它的定义上看，它其实也是一个objc_object，所以objc_class也会有一个isa，它其实指向的是Meta class，Meta class 也是一个objc_class它和objc_object指向objc_class区别在于它的cache以及bits中存放的是类静态方法等数据。这些会在后面介绍。</p>
<ul>
<li><h6 id="isa-t-结构"><a href="#isa-t-结构" class="headerlink" title="isa_t 结构"></a><strong><strong>isa_t 结构</strong></strong></h6></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">union</span> <span class="title class_">isa_t</span> &#123;</span><br><span class="line">    <span class="built_in">isa_t</span>() &#123; &#125;</span><br><span class="line">    <span class="built_in">isa_t</span>(<span class="type">uintptr_t</span> value) : <span class="built_in">bits</span>(value) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    Class cls;</span><br><span class="line">    <span class="type">uintptr_t</span> bits;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(ISA_BITFIELD)</span></span><br><span class="line">    <span class="keyword">struct</span> &#123;</span><br><span class="line">        ISA_BITFIELD;  <span class="comment">// defined in isa.h</span></span><br><span class="line">    &#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong><strong>isa_t</strong></strong> 是一个共用体，在64位机器中会启用NONPOINTER_ISA优化，具体见<a target="_blank" rel="noopener" href="https://github.com/tbfungeek/iOS-Daily-Interview/issues/2">谈谈iOS的内存管理方式的理解</a>,这时候isa就不单纯用于存储指向某个类的指针。那么当启用NONPOINTER_ISA优化的时候作用域是怎样的呢？我们这里看到****#if defined(ISA_BITFIELD)****，这个条件编译，ISA_BITFIELD是在isa.h中定义的我们来看下它的具体定义：</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line"># <span class="keyword">if</span> __arm64__</span><br><span class="line"><span class="comment">//.........</span></span><br><span class="line">#   define ISA_BITFIELD                                                      \</span><br><span class="line">      <span class="built_in">uint</span>ptr_t nonpointer        : <span class="number">1</span>;                                       \</span><br><span class="line">      <span class="built_in">uint</span>ptr_t has_assoc         : <span class="number">1</span>;                                       \</span><br><span class="line">      <span class="built_in">uint</span>ptr_t has_cxx_dtor      : <span class="number">1</span>;                                       \</span><br><span class="line">      <span class="built_in">uint</span>ptr_t shiftcls          : <span class="number">33</span>; <span class="comment">/*MACH_VM_MAX_ADDRESS 0x1000000000*/</span> \</span><br><span class="line">      <span class="built_in">uint</span>ptr_t magic             : <span class="number">6</span>;                                       \</span><br><span class="line">      <span class="built_in">uint</span>ptr_t weakly_referenced : <span class="number">1</span>;                                       \</span><br><span class="line">      <span class="built_in">uint</span>ptr_t deallocating      : <span class="number">1</span>;                                       \</span><br><span class="line">      <span class="built_in">uint</span>ptr_t has_sidetable_rc  : <span class="number">1</span>;                                       \</span><br><span class="line">      <span class="built_in">uint</span>ptr_t extra_rc          : <span class="number">19</span></span><br></pre></td></tr></table></figure>

<p>下面是这些字段的意义：</p>
<ul>
<li><p><strong><strong>nonpointer （1位）</strong></strong> 标记是否是纯的ISA指针，还是非指针型的NOPOINTER_ISA指针indexed，0表示普通的isa,1表示NOPOINTER_ISA指针</p>
</li>
<li><p><strong><strong>has_assoc （1位）</strong></strong> 表示该对象是否包含 associated object，如果没有，则析构时会更快</p>
</li>
<li><p><strong><strong>has_cxx_dtor （1位）</strong></strong> 表示该对象是否有 C++ 或 ARC 的析构函数，如果没有，则析构时更快</p>
</li>
<li><p><strong><strong>shiftcls （33位）</strong></strong> 类的指针</p>
</li>
<li><p><strong><strong>magic（6位）</strong></strong> 固定值为 0xd2，用于在调试时分辨对象是否未完成初始化</p>
</li>
<li><p><strong><strong>weakly_referenced（1位）</strong></strong> 标记对象是否有弱引用指针weakly_referenced</p>
</li>
<li><p><strong><strong>deallocating （1位）</strong></strong> 该对象是否正在析构</p>
</li>
<li><p><strong><strong>has_sidetable_rc （1位）</strong></strong> 是否使用了引用计数表sideTable</p>
</li>
<li><p><strong><strong>extra_rc（19位）</strong></strong> 存储引用计数值减一后的值 (首先会存储在该字段中，当到达上限后，has_sidetable_rc 等于1，对应的引用计数值存入相应的引用计数表中)</p>
</li>
<li><h6 id="cache-t-结构"><a href="#cache-t-结构" class="headerlink" title="cache_t 结构"></a><strong><strong>cache_t 结构</strong></strong></h6></li>
</ul>
<p>cache_t主要用于存储某个类中使用过方法的缓存，一般一个类会有很多方法，这些方法并不都是常用的，如果每次调用都需要从该类的所有方法列表中查询明显会降低效率，所以这里引入了cache_t，通过这种以空间换时间的方式来加快方法查找效率。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">cache_t</span> &#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">bucket_t</span> *_buckets;</span><br><span class="line">    <span class="type">mask_t</span> _mask;</span><br><span class="line">    <span class="type">mask_t</span> _occupied;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>cache_t中包含三个属性：</p>
<p><strong><strong>_buckets</strong></strong> 指向bucket_t结构体，它实际上是一个可动态扩展的哈希表。在存储的数据超过3&#x2F;4的时候就会调用expend方法进行扩展。****_mask**** 表示整个_buckets链表的大小，****_occupied****表示当前_buckets链表里面缓存的bucket_t节点数。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">bucket_t</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    MethodCacheIMP _imp;</span><br><span class="line">    <span class="type">cache_key_t</span> _key;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><strong>bucket_t</strong></strong> 结构也十分简单，就是一个以selector映射而成的cache_key_t以及方法指针_imp。</p>
<ul>
<li><h6 id="class-data-bits-t-结构"><a href="#class-data-bits-t-结构" class="headerlink" title="class_data_bits_t 结构"></a><strong><strong>class_data_bits_t 结构</strong></strong></h6></li>
</ul>
<p>我们再继续看objc_class中的class_data_bits_t类型：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">class_data_bits_t</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">uintptr_t</span> bits;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">class_rw_t</span>* <span class="title">data</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">class_rw_t</span> *)(bits &amp; FAST_DATA_MASK);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里最关键的数据为class_rw_t，它才是包含类最有用信息的部分，我们从名字上可以看出它是可读写的，为什么要强调它是可读写的，因为它里面还有一个十分重要的class_ro_t类型。这个我们后面再介绍，我们先将重心放在class_rw_t中：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">class_rw_t</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> flags;</span><br><span class="line">    <span class="type">uint32_t</span> version;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">class_ro_t</span> *ro;</span><br><span class="line"></span><br><span class="line">    <span class="type">method_array_t</span> methods;</span><br><span class="line">    <span class="type">property_array_t</span> properties;</span><br><span class="line">    <span class="type">protocol_array_t</span> protocols;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">class_rw_t</span>* <span class="title">data</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">class_rw_t</span> *)(bits &amp; FAST_DATA_MASK);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//........</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><strong><strong>methods</strong></strong>对象或者类的方法，这部分是可读写的，在Runtime阶段，会将分类的中的方法追加到这部分。</li>
<li><strong><strong>properties</strong></strong>对象或者类的属性</li>
<li><strong><strong>protocols</strong></strong>对象或者类的协议</li>
<li><strong><strong>ro</strong></strong>对象或者类中只读的部分，这部分在编译时期就已经确定了。</li>
</ul>
<p>我们再来看下<strong><strong>class_ro_t</strong></strong>结构：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">class_ro_t</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> * name;</span><br><span class="line">    <span class="type">uint32_t</span> flags;</span><br><span class="line">    <span class="type">uint32_t</span> instanceStart;</span><br><span class="line">    <span class="type">uint32_t</span> instanceSize;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">ivar_list_t</span> * ivars;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint8_t</span> * ivarLayout;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint8_t</span> * weakIvarLayout;</span><br><span class="line"></span><br><span class="line">    <span class="type">method_list_t</span> * baseMethodList;</span><br><span class="line">    <span class="type">protocol_list_t</span> * baseProtocols;</span><br><span class="line">    <span class="type">property_list_t</span> *baseProperties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>它包括实例起始位置<strong><strong>instanceStart</strong></strong>，以及实例大小<strong><strong>instanceSize</strong></strong>。<br>成员变量相关：<strong><strong>ivars</strong></strong>，<strong><strong>ivarLayout</strong></strong>，<strong><strong>weakIvarLayout</strong></strong>。<br>基础成分：<strong><strong>baseMethodList</strong></strong>，<strong><strong>baseProtocols</strong></strong>，<strong><strong>baseProperties</strong></strong></p>
<ul>
<li><h6 id="SEL-定义"><a href="#SEL-定义" class="headerlink" title="SEL 定义"></a><strong><strong>SEL 定义</strong></strong></h6></li>
</ul>
<p>SEL和id Class 一样都是objc对应类型的结构体指针的便捷定义。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">objc_selector</span> *SEL;</span><br></pre></td></tr></table></figure>

<p>objc_selector是一个映射到方法的C字符串，不同类中相同名字的方法所对应的selector是相同的，即使方法名字相同而变量类型不同也会导致它们具有相同的selector。由于这点特性，导致了OC不支持函数重载。简单说SEL不包含返回值类型，参数类型，以及所属类的信息。只包含方法名对应的信息，实际上它在Runtime中作为消息发送给对象，对象根据它来查找对应的 IMP进行执行。</p>
<ul>
<li><h6 id="IMP-定义"><a href="#IMP-定义" class="headerlink" title="IMP 定义"></a><strong><strong>IMP 定义</strong></strong></h6></li>
</ul>
<p>IMP是函数指针，即函数执行的入口。该函数使用标准的C调用。</p>
<figure class="highlight elm"><table><tr><td class="code"><pre><span class="line">typedef id _Nullable (*<span class="type">IMP</span>)(id _Nonnull, <span class="type">SEL</span> _Nonnull, ...); </span><br></pre></td></tr></table></figure>
<p>它包含两个参数：</p>
<ul>
<li><p>第一个参数指向 self（它代表当前类实例的地址，如果是类则指向的是它的元类），作为消息的接受者；</p>
</li>
<li><p>第二个参数代表方法的选择子；</p>
</li>
<li><p>… 代表可选参数，前面的 id 代表返回值。</p>
</li>
<li><h6 id="Method-定义"><a href="#Method-定义" class="headerlink" title="Method 定义"></a><strong><strong>Method 定义</strong></strong></h6></li>
</ul>
<figure class="highlight oxygene"><table><tr><td class="code"><pre><span class="line">typedef struct method_t *<span class="keyword">Method</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">struct method_t &#123;</span><br><span class="line">    SEL name<span class="comment">;</span></span><br><span class="line">    const char *types<span class="comment">;</span></span><br><span class="line">    MethodListIMP imp<span class="comment">;</span></span><br><span class="line">    //.....</span><br><span class="line">&#125;<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<p>我们知道一个方法的组成包括方法返回值，方法参数，方法名，方法实现体，对应于method_t分别是<strong><strong>types</strong></strong>，<strong><strong>name</strong></strong>，<strong><strong>imp</strong></strong>，关于types涉及到类型编码，如果大家不了解可以通过如下链接进行扩展阅读：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://nshipster.cn/type-encodings/">Type Encodings</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html">Apple Develper Type Encodings</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/liumengdi666/article/details/52402296">iOS类型编码Type Encodings与属性类型Property Type</a></li>
</ul>
<p>在实际编程中可以通过method_getTypeEncoding方法来获得：</p>
<figure class="highlight oxygene"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> char * _Nullable method_getTypeEncoding(<span class="keyword">Method</span> _<span class="title function_">Nonnull</span> <span class="title function_">m</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/2020/02/02/iOS-Runtime%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E9%87%8D%E8%A6%81%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%BB%8B%E7%BB%8D/000000001.png"></p>
<ul>
<li><h6 id="protocol-t-定义"><a href="#protocol-t-定义" class="headerlink" title="protocol_t 定义"></a><strong><strong>protocol_t 定义</strong></strong></h6></li>
</ul>
<p>protocol_t 主要用于存放协议相关的数据（注意它其实也是一个objc_object），由于协议也可以遵循协议，所以协议内部有协议列表用于存放当前协议所遵循的协议。而实例方法和类方法都包含必须实现和可选实现的部分，这两部是分开存放的，同时需要注意的是协议内部也为实例方法中提供了属性的存储，实际上协议也可以声明属性的，在介绍协议的使用的时候会给予介绍。</p>
<figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">protocol_t</span> : objc_object &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">protocol_list_t</span> *protocols;</span><br><span class="line">    <span class="type">method_list_t</span> *instanceMethods;</span><br><span class="line">    <span class="type">method_list_t</span> *classMethods;</span><br><span class="line">    <span class="type">method_list_t</span> *optionalInstanceMethods;</span><br><span class="line">    <span class="type">method_list_t</span> *optionalClassMethods;</span><br><span class="line">    <span class="type">property_list_t</span> *instanceProperties;</span><br><span class="line">    <span class="type">uint32_t</span> size;   <span class="comment">// sizeof(protocol_t)</span></span><br><span class="line">    <span class="type">uint32_t</span> flags;</span><br><span class="line">    <span class="comment">//.......</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<ul>
<li><h6 id="property-t-定义"><a href="#property-t-定义" class="headerlink" title="property_t 定义"></a><strong><strong>property_t 定义</strong></strong></h6></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">property_t</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *attributes;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>对于属性结构比较简单就只有属性名字，以及对应的属性字符串，至于属性至于属性字符串的介绍可以看下面官方的文档介绍：</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtPropertyIntrospection.html">Property Type and Functions</a></p>
</li>
<li><h6 id="ivar-t-定义"><a href="#ivar-t-定义" class="headerlink" title="ivar_t 定义"></a><strong><strong>ivar_t 定义</strong></strong></h6></li>
</ul>
<figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ivar_t</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int32_t</span> *offset;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *type;</span><br><span class="line">    <span class="comment">// alignment is sometimes -1; use alignment() instead</span></span><br><span class="line">    <span class="type">uint32_t</span> alignment_raw;</span><br><span class="line">    <span class="type">uint32_t</span> size;</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>如果我们使用下面方式声明实例变量，那么这些实例变量就会转换为ivar_t</p>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="variable">@interface</span> <span class="attribute">TestClass </span>: NSObject &#123;</span><br><span class="line">    <span class="variable">@public</span></span><br><span class="line">        NSString *_name;</span><br><span class="line">    <span class="variable">@private</span></span><br><span class="line">        NSString *_ID;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是实际开发中大多数使用属性而不使用这种方法，使用这种写法，对象布局在编译器就已经固定了。只要碰到访问_name变量的代码，编译器就把其替换为偏移量ivar_t 中的（offset），这个偏移量是硬编码，表示该变量距离存放对象的内存区域的起始地址有多远。但是如果在运行过程中，又新增了一个实例变量，硬编码于其中的变量就会读到错误的值，这也是为什么OC无法动态添加成员变量的原因。</p>
<p>最后使用一个图来总结下全文的内容：</p>
<p><img src="/2020/02/02/iOS-Runtime%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E9%87%8D%E8%A6%81%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%BB%8B%E7%BB%8D/000000002.png"></p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Objective-C-%E7%9B%B8%E5%85%B3/">Objective C 相关</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Objective-C-相关/">Objective C 相关</a>
  </div>

</div>



</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2020/02/02/iOS-Runtime源码解析-Runtime初始化/" title="iOS Runtime源码解析 Runtime初始化">
  <span>
  iOS Runtime源码解析 Runtime初始化</span>
</a>
</div>


<div class="next">
<a href="/2020/01/18/iOS-Runtime源码解析之Runtime较好的文章推荐-md/"  title="iOS-Runtime源码解析之Runtime较好的文章推荐">
 <span>iOS-Runtime源码解析之Runtime较好的文章推荐
</span>
</a>
</div>

</nav>

	
<section id="comments" class="comment">
	<div class="ds-thread" data-thread-key="2020/02/02/iOS-Runtime源码解析重要的数据结构介绍/" data-title="iOS Runtime源码解析重要的数据结构介绍" data-url="http://yoursite.com/2020/02/02/iOS-Runtime%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E9%87%8D%E8%A6%81%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%BB%8B%E7%BB%8D/"></div>
</section>


<section id="comments" class="comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
 
 <ol class="toc"><li class="toc-item toc-level-6"><a class="toc-link" href="#objc-object-%E7%BB%93%E6%9E%84"><span class="toc-number">1.</span> <span class="toc-text">objc_object 结构</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#objc-class-%E7%BB%93%E6%9E%84"><span class="toc-number">2.</span> <span class="toc-text">objc_class 结构</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#isa-t-%E7%BB%93%E6%9E%84"><span class="toc-number">3.</span> <span class="toc-text">isa_t 结构</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#cache-t-%E7%BB%93%E6%9E%84"><span class="toc-number">4.</span> <span class="toc-text">cache_t 结构</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#class-data-bits-t-%E7%BB%93%E6%9E%84"><span class="toc-number">5.</span> <span class="toc-text">class_data_bits_t 结构</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#SEL-%E5%AE%9A%E4%B9%89"><span class="toc-number">6.</span> <span class="toc-text">SEL 定义</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#IMP-%E5%AE%9A%E4%B9%89"><span class="toc-number">7.</span> <span class="toc-text">IMP 定义</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Method-%E5%AE%9A%E4%B9%89"><span class="toc-number">8.</span> <span class="toc-text">Method 定义</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#protocol-t-%E5%AE%9A%E4%B9%89"><span class="toc-number">9.</span> <span class="toc-text">protocol_t 定义</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#property-t-%E5%AE%9A%E4%B9%89"><span class="toc-number">10.</span> <span class="toc-text">property_t 定义</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#ivar-t-%E5%AE%9A%E4%B9%89"><span class="toc-number">11.</span> <span class="toc-text">ivar_t 定义</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">
<div id="authorInfo">
	
		<div class="author-img"></div>		
	
	<div class="social-info" class="clearfix">
		
		
		<a href="https://github.com/tbfungeek" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
		
		<a href="mailto:tbfungeek@163.com" target="_blank" class="icon-email" title="Email Me"></a>
		

	</div>
</div>

  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
		  
			<li><a href="/categories/Android-小经验/" title="Android 小经验">Android 小经验<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android-源码分析/" title="Android 源码分析">Android 源码分析<sup>21</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android其他/" title="Android其他">Android其他<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android初步/" title="Android初步">Android初步<sup>21</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android进阶/" title="Android进阶">Android进阶<sup>100</sup></a></li>
		  
		
		  
			<li><a href="/categories/Hexo-使用/" title="Hexo 使用">Hexo 使用<sup>10</sup></a></li>
		  
		
		  
			<li><a href="/categories/JavaScript理论/" title="JavaScript理论">JavaScript理论<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Objective-C-相关/" title="Objective C 相关">Objective C 相关<sup>24</sup></a></li>
		  
		
		  
			<li><a href="/categories/OpenCV/" title="OpenCV">OpenCV<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/ROS/" title="ROS">ROS<sup>9</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-工具使用/" title="iOS 工具使用">iOS 工具使用<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-开源库分析/" title="iOS 开源库分析">iOS 开源库分析<sup>36</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-理论基础/" title="iOS 理论基础">iOS 理论基础<sup>14</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-进阶/" title="iOS 进阶">iOS 进阶<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/个人收藏/" title="个人收藏">个人收藏<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/代码规范/" title="代码规范">代码规范<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/其他/" title="其他">其他<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/博客分类目录/" title="博客分类目录">博客分类目录<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/叨叨系列/" title="叨叨系列">叨叨系列<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/开源代码分析/" title="开源代码分析">开源代码分析<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/开源库分析/" title="开源库分析">开源库分析<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/树莓派/" title="树莓派">树莓派<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/版本控制/" title="版本控制">版本控制<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/直播/" title="直播">直播<sup>6</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/iOS-开源库分析/" title="iOS 开源库分析">iOS 开源库分析<sup>36</sup></a></li>
			
		
			
				<li><a href="/tags/Android-设计模式/" title="Android 设计模式">Android 设计模式<sup>29</sup></a></li>
			
		
			
				<li><a href="/tags/Objective-C-相关/" title="Objective C 相关">Objective C 相关<sup>24</sup></a></li>
			
		
			
				<li><a href="/tags/Android基础/" title="Android基础">Android基础<sup>21</sup></a></li>
			
		
			
				<li><a href="/tags/AOSP-源码/" title="AOSP 源码">AOSP 源码<sup>17</sup></a></li>
			
		
			
				<li><a href="/tags/Android-常用第三方库/" title="Android 常用第三方库">Android 常用第三方库<sup>15</sup></a></li>
			
		
			
				<li><a href="/tags/iOS-理论基础/" title="iOS 理论基础">iOS 理论基础<sup>14</sup></a></li>
			
		
			
				<li><a href="/tags/Hexo-使用/" title="Hexo 使用">Hexo 使用<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/ROS/" title="ROS">ROS<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/Android-动画进阶/" title="Android 动画进阶">Android 动画进阶<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/Android-JNI/" title="Android JNI">Android JNI<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android-绘图进阶/" title="Android 绘图进阶">Android 绘图进阶<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android性能优化/" title="Android性能优化">Android性能优化<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android-自动化测试/" title="Android 自动化测试">Android 自动化测试<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/OpenCV/" title="OpenCV">OpenCV<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/直播/" title="直播">直播<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android-开源源码/" title="Android 开源源码">Android 开源源码<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Android-自定义View进阶/" title="Android 自定义View进阶">Android 自定义View进阶<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/树莓派/" title="树莓派">树莓派<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/iOS-进阶/" title="iOS 进阶">iOS 进阶<sup>4</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="https://hexo.io" target="_blank" title="Hexo">Hexo</a>
            
          </li>
        
          <li>
            
            	<a href="https://pages.github.com/" target="_blank" title="GitHub">GitHub</a>
            
          </li>
        
          <li>
            
            	<a href="http://pf18.github.io/" target="_blank" title="PF18">PF18</a>
            
          </li>
        
          <li>
            
            	<a href="http://toutiao.io/" target="_blank" title="开发者头条">开发者头条</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.jcodecraeer.com/" target="_blank" title="泡在网上的日子">泡在网上的日子</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="atom.xml" target="_blank" title="rss">RSS</a>
</div>

  
  <div class="tagcloudlist">
    <p class="asidetitle">Tag Cloud</p>
    <div class="tagcloudlist clearfix">
       <a href="/tags/AOSP-%E6%BA%90%E7%A0%81/" style="font-size: 17.14px;">AOSP 源码</a> <a href="/tags/Android-APK-%E7%AD%BE%E5%90%8D/" style="font-size: 10px;">Android APK 签名</a> <a href="/tags/Android-JNI/" style="font-size: 12.86px;">Android JNI</a> <a href="/tags/Android-%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E8%BF%9B%E9%98%B6/" style="font-size: 10.71px;">Android 事件处理进阶</a> <a href="/tags/Android-%E5%8A%A8%E7%94%BB%E8%BF%9B%E9%98%B6/" style="font-size: 13.57px;">Android 动画进阶</a> <a href="/tags/Android-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%BC%80%E5%8F%91/" style="font-size: 10px;">Android 多线程开发</a> <a href="/tags/Android-%E5%B0%8F%E7%BB%8F%E9%AA%8C/" style="font-size: 10px;">Android 小经验</a> <a href="/tags/Android-%E5%B8%B8%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93/" style="font-size: 16.43px;">Android 常用第三方库</a> <a href="/tags/Android-%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B/" style="font-size: 10px;">Android 开发流程</a> <a href="/tags/Android-%E5%BC%80%E6%BA%90%E6%BA%90%E7%A0%81/" style="font-size: 12.14px;">Android 开源源码</a> <a href="/tags/Android-%E7%BB%98%E5%9B%BE%E8%BF%9B%E9%98%B6/" style="font-size: 12.86px;">Android 绘图进阶</a> <a href="/tags/Android-%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/" style="font-size: 12.86px;">Android 自动化测试</a> <a href="/tags/Android-%E8%87%AA%E5%AE%9A%E4%B9%89View%E8%BF%9B%E9%98%B6/" style="font-size: 12.14px;">Android 自定义View进阶</a> <a href="/tags/Android-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 19.29px;">Android 设计模式</a> <a href="/tags/Android%E5%85%B6%E4%BB%96/" style="font-size: 10px;">Android其他</a> <a href="/tags/Android%E5%9F%BA%E7%A1%80/" style="font-size: 17.86px;">Android基础</a> <a href="/tags/Android%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B/" style="font-size: 10px;">Android开发流程</a> <a href="/tags/Android%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" style="font-size: 12.86px;">Android性能优化</a> <a href="/tags/Android%E6%B7%B7%E6%B7%86%E6%8A%80%E6%9C%AF/" style="font-size: 10px;">Android混淆技术</a> <a href="/tags/Android%E8%B4%A8%E9%87%8F%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/" style="font-size: 11.43px;">Android质量管理工具</a> <a href="/tags/Android%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/" style="font-size: 10px;">Android逆向工程</a> <a href="/tags/Git-github/" style="font-size: 10px;">Git && github</a> <a href="/tags/Hexo-%E4%BD%BF%E7%94%A8/" style="font-size: 15px;">Hexo 使用</a> <a href="/tags/JavaScript/" style="font-size: 10px;">JavaScript</a> <a href="/tags/Linux-%E4%BD%BF%E7%94%A8/" style="font-size: 10px;">Linux 使用</a> <a href="/tags/Objective-C-%E7%9B%B8%E5%85%B3/" style="font-size: 18.57px;">Objective C 相关</a> <a href="/tags/OpenCV/" style="font-size: 12.86px;">OpenCV</a> <a href="/tags/ROS/" style="font-size: 14.29px;">ROS</a> <a href="/tags/iOS-%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/" style="font-size: 10.71px;">iOS 工具使用</a> <a href="/tags/iOS-%E5%BC%80%E6%BA%90%E5%BA%93%E5%88%86%E6%9E%90/" style="font-size: 20px;">iOS 开源库分析</a> <a href="/tags/iOS-%E7%90%86%E8%AE%BA%E5%9F%BA%E7%A1%80/" style="font-size: 15.71px;">iOS 理论基础</a> <a href="/tags/iOS-%E8%BF%9B%E9%98%B6/" style="font-size: 12.14px;">iOS 进阶</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83/" style="font-size: 10px;">代码规范</a> <a href="/tags/%E5%8D%9A%E5%AE%A2%E5%88%86%E7%B1%BB%E7%9B%AE%E5%BD%95/" style="font-size: 10.71px;">博客分类目录</a> <a href="/tags/%E5%8F%A8%E5%8F%A8%E7%B3%BB%E5%88%97/" style="font-size: 10px;">叨叨系列</a> <a href="/tags/%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8/" style="font-size: 11.43px;">工具的使用</a> <a href="/tags/%E5%BC%80%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/" style="font-size: 10.71px;">开源代码分析</a> <a href="/tags/%E5%BC%80%E6%BA%90%E5%BA%93%E5%88%86%E6%9E%90/" style="font-size: 10px;">开源库分析</a> <a href="/tags/%E6%9D%82%E7%B1%BB/" style="font-size: 10px;">杂类</a> <a href="/tags/%E6%A0%91%E8%8E%93%E6%B4%BE/" style="font-size: 12.14px;">树莓派</a> <a href="/tags/%E7%9B%B4%E6%92%AD/" style="font-size: 12.86px;">直播</a> <a href="/tags/%E7%BC%96%E7%A8%8B%E6%8A%80%E5%B7%A7/" style="font-size: 10.71px;">编程技巧</a> <a href="/tags/%E7%BD%91%E7%AB%99%E6%94%B6%E8%97%8F/" style="font-size: 10px;">网站收藏</a> <a href="/tags/%E9%87%8D%E8%A6%81%E6%8E%A7%E4%BB%B6/" style="font-size: 11.43px;">重要控件</a>
    </div>
  </div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
		
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/hsihohuang/kiddochan" target="_blank" title="Kiddochan">Kiddochan</a> © 2022 
		
		<a href="/about" target="_blank" title="Edgar">Edgar</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
        getSize();
        if (myWidth >= 1024) {
          c.click();
        }
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>




<script type="text/javascript">
  var duoshuoQuery = {short_name:"tbfungeek"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 


<script type="text/javascript">

var disqus_shortname = 'tbfungeek';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>






<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?7c9443b0374f1cf6b1dbb5ab84d939cb";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
