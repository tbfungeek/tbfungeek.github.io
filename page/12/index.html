
 <!DOCTYPE HTML>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  
    <title>Edgar&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Edgar">
    

    
    <meta name="description" content="Android | 全栈工程师">
<meta property="og:type" content="website">
<meta property="og:title" content="Edgar&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/page/12/index.html">
<meta property="og:site_name" content="Edgar&#39;s Blog">
<meta property="og:description" content="Android | 全栈工程师">
<meta property="og:locale">
<meta property="article:author" content="Edgar">
<meta name="twitter:card" content="summary">

    
    <link rel="alternative" href="atom.xml" title="Edgar&#39;s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/unnamed4_n_mSY_icon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/profile.png">
    <link rel="apple-touch-icon-precomposed" href="/img/profile.png">
    
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.2.0"></head>

  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Edgar&#39;s Blog">Edgar&#39;s Blog</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
					<li>
 					
					<form class="search" action="/search/index.html" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" autocomplete="off" name="q" maxlength="20" placeholder="Search" />
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/02/06/Java-进阶系列之IO/" title="Java 进阶系列之IO" itemprop="url">Java 进阶系列之IO</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Edgar" target="_blank" itemprop="author">Edgar</a>
		
  <p class="article-time">
    <time datetime="2017-02-06T13:06:55.000Z" itemprop="datePublished"> Published 2017-02-06</time>
    
  </p>
</header>
    <div class="article-content">
        
        
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>



<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/02/06/Java-进阶系列之IO/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/02/06/Java-进阶系列之IO/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/02/06/Java-进阶系列之多线程/" title="Java 进阶系列之多线程" itemprop="url">Java 进阶系列之多线程</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Edgar" target="_blank" itemprop="author">Edgar</a>
		
  <p class="article-time">
    <time datetime="2017-02-06T13:06:39.000Z" itemprop="datePublished"> Published 2017-02-06</time>
    
  </p>
</header>
    <div class="article-content">
        
        
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>



<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/02/06/Java-进阶系列之多线程/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/02/06/Java-进阶系列之多线程/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/02/06/Java-进阶系列之注解/" title="Java 进阶系列之注解" itemprop="url">Java 进阶系列之注解</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Edgar" target="_blank" itemprop="author">Edgar</a>
		
  <p class="article-time">
    <time datetime="2017-02-06T13:06:32.000Z" itemprop="datePublished"> Published 2017-02-06</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>本章知识点</p>
<ul>
<li>JDK内置系统注解</li>
<li>元注释以及自定义注释</li>
<li>注解解析器实现</li>
<li>Android中的专用注解</li>
</ul>
<h4 id="JDK内置系统注解"><a href="#JDK内置系统注解" class="headerlink" title="JDK内置系统注解"></a>JDK内置系统注解</h4><p>Java提供了三种内建注解。</p>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="variable">@Override</span></span><br><span class="line">这个估计开发中是最常见的一个注解了，它用于表示所注解的方法是一个用于覆盖父类的一个方法，一旦存在任何的拼写错误导致方法签名对不上被覆盖的方法，编译器就会发出错误提示。</span><br><span class="line"><span class="variable">@Deprecated</span></span><br><span class="line">这个一般用于标记某个方法不在使用了，通过这个注释，开发者可以了解到哪些接口是处于遗弃状态的。</span><br><span class="line"><span class="variable">@SuppressWarnings</span></span><br><span class="line">这个注释用于忽视某个警告信息。</span><br></pre></td></tr></table></figure>

<h4 id="元注释以及自定义注释"><a href="#元注释以及自定义注释" class="headerlink" title="元注释以及自定义注释"></a>元注释以及自定义注释</h4><p>Java中提供了四种元注释用于定义自定义注释，如下所示：</p>
<p>@Target	表示该注解可以用在什么地方，由ElementType枚举定义 ,当注解未指定Target值时,该注解可以使用任何元素之上</p>
<figure class="highlight oxygene"><table><tr><td class="code"><pre><span class="line">PACKAGE：包声明</span><br><span class="line"><span class="keyword">TYPE</span>：类、接口 注解类型,<span class="keyword">enum</span>声明 </span><br><span class="line">ANNOTATION_TYPE：注解声明（应用于另一个注解上）</span><br><span class="line">FIELD：域声明（包括<span class="keyword">enum</span>实例） </span><br><span class="line"><span class="keyword">CONSTRUCTOR</span>：构造器的声明 </span><br><span class="line"><span class="title function_">METHOD</span>：方法声明 </span><br><span class="line"><span class="title function_">LOCAL_VARIABLE</span>：局部变量声明 </span><br><span class="line"><span class="title function_">PARAMETER</span>：参数声明</span><br><span class="line"><span class="title function_">TYPE_PARAMETER</span>：类型参数声明（1.8新加入） </span><br><span class="line"><span class="title function_">TYPE_USE</span>：类型使用声明（1.8新加入）</span><br></pre></td></tr></table></figure>

<p>@Retention	表示需要在什么级别保存该注解信息，由RetentionPolicy枚举定义,当注解未定义Retention值时，默认值是CLASS</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">SOURCE：注解将被编译器丢弃（该类型的注解信息只会保留在源码里，源码经过编译后，注解信息会被丢弃，不会保留在编译好的<span class="keyword">class</span>文件里）</span><br><span class="line"><span class="symbol">CLASS</span>：注解在<span class="symbol">class</span>文件中可用，但会被<span class="symbol">VM</span>丢弃（该类型的注解信息会保留在源码里和<span class="symbol">class</span>文件里，在执行的时候，不会加载到虚拟机（<span class="symbol">JVM</span>）中）</span><br><span class="line"><span class="symbol">RUNTIME</span>：<span class="symbol">VM</span>将在运行期也保留注解信息，因此可以通过反射机制读取注解的信息（源码、<span class="symbol">class</span>文件和执行的时候都有注解的信息）</span><br></pre></td></tr></table></figure>
<p>@Documented	表示注解会被包含在javaApi文档中<br>@Inherited	允许子类继承父类的注解，表示注解类型能被自动继承。 如果一个类使用了 @Inherited 类型的注解，则此类的子类也将含有该注解。</p>
<h4 id="自定义注解语法："><a href="#自定义注解语法：" class="headerlink" title="自定义注解语法："></a>自定义注解语法：</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.annotation.*;</span><br><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.SOURCE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AnatationTest &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要注意的是注解也将会编译成class文件,我们通过javac将上述的注解编译为字节码，然后使用javap对其进行反编译，将会得到如下的代码：</p>
<figure class="highlight haxe"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AnatationTest</span> <span class="keyword"><span class="keyword">extends</span> <span class="type">java</span></span>.<span class="title">lang</span>.<span class="title">annotation</span>.<span class="title">Annotation</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也就是说使用@interface 关键字声明一个注解，它会自动继承 java.lang.annotation.Annotaion 接口。</p>
<p>自定义注解的时候需要注意如下几点：</p>
<ul>
<li>参数成员访问修饰符只能使用 public 或者 default 这个和枚举是一样的</li>
<li>注解方法不能有参数。</li>
<li>@interface 里面的每一个方法表示声明了一个可配置的参数，方法名即位参数名。返回值类型就是参数的类型，下面是能够允许的类型：<figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line">所有基本类型（<span class="type">int</span>,<span class="type">float</span>,<span class="type">boolean</span>,<span class="type">byte</span>,<span class="type">double</span>,<span class="type">char</span>,<span class="type">long</span>,<span class="type">short</span>）</span><br><span class="line"><span class="type">String</span></span><br><span class="line">Class</span><br><span class="line"><span class="keyword">enum</span></span><br><span class="line"><span class="title class_">Annotation</span></span><br><span class="line">以及上述类型所组成的 数组</span><br></pre></td></tr></table></figure></li>
<li>如果需要声明默认值可以使用default 关键字。</li>
<li>注解元素必须有确定的值，要么在定义注解元素时默认值指定，要么使用此注解时指定。非基本类型注解元素的值不可为 null</li>
</ul>
<h4 id="注解解析器实现"><a href="#注解解析器实现" class="headerlink" title="注解解析器实现"></a>注解解析器实现</h4><p>注释的解析有两种方式：</p>
<ul>
<li>运行时解析<br>运行时注解指的是@Retention的值为RUNTIME的注解。java.lang.reflect包中有一个AnnotatedElement接口，这个接口定义了用于获取注解信息的几个方法：<br>getAnnotation(Class annotationClass)	                            当存在该元素的指定类型注解，则返回相应注释，否则返回null<br>getAnnotations()	                                                返回此元素上存在的所有注解<br>getDeclaredAnnotations()	                                        返回直接存在于此元素上的所有注解。<br>isAnnotationPresent(Class&lt;? extends Annotation&gt; annotationClass)	当存在该元素的指定类型注解，则返回true，否则返回false<br>使用这些接口就可以在运行时解析对应的注释。</li>
</ul>
<p>下面是运行时解析的例子：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.PACKAGE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> PackageAnnotation &#123;</span><br><span class="line">    String <span class="title function_">desc</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> TypeAnnotation &#123;</span><br><span class="line">    String <span class="title function_">desc</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(ElementType.CONSTRUCTOR)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ConstructAnnotaion &#123;</span><br><span class="line">    String <span class="title function_">desc</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(ElementType.FIELD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> FieldAnnotation &#123;</span><br><span class="line">    String <span class="title function_">desc</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MethodAnnotation &#123;</span><br><span class="line">    String <span class="title function_">desc</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(ElementType.PARAMETER)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ParamAnnotation &#123;</span><br><span class="line">    String <span class="title function_">desc</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="meta">@TypeAnnotation</span>(desc = <span class="string">&quot;This is TypeAnnotation&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestClass</span> &#123;</span><br><span class="line">    <span class="meta">@FieldAnnotation</span>(desc = <span class="string">&quot;This is FieldAnnotation&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> mTestField = <span class="string">&quot;mTestField&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ConstructAnnotaion</span>(desc = <span class="string">&quot;This is ConstructAnnotaion&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">TestClass</span>() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@MethodAnnotation</span>(desc = <span class="string">&quot;This is MethodAnnotation&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">method</span>(<span class="params"><span class="meta">@ParamAnnotation</span>(desc = <span class="string">&quot;This is ParamAnnotation&quot;</span>)<span class="built_in">String</span> param</span>) &#123;</span><br><span class="line">        <span class="title class_">String</span> localvalue = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;method!!!!!&quot;</span>+param);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>package-info.java</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PackageAnnotation(desc = <span class="string">&quot;This is a package annotation!&quot;</span>)</span></span><br><span class="line"><span class="keyword">package</span> com.javabase.annotationbase.testclass;</span><br><span class="line"><span class="keyword">import</span> com.javabase.annotationbase.annotations.PackageAnnotation;</span><br></pre></td></tr></table></figure>

<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">public <span class="keyword">class</span> RuntimeAnnotationProcessor &#123;</span><br><span class="line"></span><br><span class="line">    public void test<span class="constructor">PackageAnnotation(Class&lt;?&gt; <span class="params">clzz</span>)</span> &#123;</span><br><span class="line">        Package packageName = clzz.get<span class="constructor">Package()</span>;</span><br><span class="line">        <span class="keyword">if</span>(packageName.is<span class="constructor">AnnotationPresent(PackageAnnotation.<span class="params">class</span>)</span>) &#123;</span><br><span class="line">            PackageAnnotation packageAnnotation = packageName.get<span class="constructor">Annotation(PackageAnnotation.<span class="params">class</span>)</span>;</span><br><span class="line">            <span class="module-access"><span class="module"><span class="identifier">System</span>.</span></span>out.println(packageAnnotation.desc<span class="literal">()</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void test<span class="constructor">ClassAnnotation(Class&lt;?&gt; <span class="params">clz</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (clz.is<span class="constructor">AnnotationPresent(TypeAnnotation.<span class="params">class</span>)</span>) &#123;</span><br><span class="line">            TypeAnnotation typeAnnotation = clz.get<span class="constructor">Annotation(TypeAnnotation.<span class="params">class</span>)</span>;</span><br><span class="line">            <span class="module-access"><span class="module"><span class="identifier">System</span>.</span></span>out.println(typeAnnotation.desc<span class="literal">()</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void test<span class="constructor">ConstructureAnnotation(Class&lt;?&gt; <span class="params">clz</span>)</span>  &#123;</span><br><span class="line">        Constructor<span class="literal">[]</span> constructors = clz.get<span class="constructor">Constructors()</span>;</span><br><span class="line">        <span class="keyword">for</span>(Constructor constructor : constructors) &#123;</span><br><span class="line">            <span class="keyword">if</span>(constructor.is<span class="constructor">AnnotationPresent(ConstructAnnotaion.<span class="params">class</span>)</span>) &#123;</span><br><span class="line">                ConstructAnnotaion annotation = (ConstructAnnotaion) constructor.get<span class="constructor">Annotation(ConstructAnnotaion.<span class="params">class</span>)</span>;</span><br><span class="line">                <span class="module-access"><span class="module"><span class="identifier">System</span>.</span></span>out.println(annotation.desc<span class="literal">()</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void test<span class="constructor">FieldAnnotation(Class&lt;?&gt; <span class="params">clz</span>)</span> &#123;</span><br><span class="line">        Field<span class="literal">[]</span> fields = clz.get<span class="constructor">Fields()</span>;</span><br><span class="line">        <span class="keyword">if</span>(fields != null<span class="operator"> &amp;&amp; </span>fields.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Field field: fields) &#123;</span><br><span class="line">                <span class="keyword">if</span>(field.is<span class="constructor">AnnotationPresent(FieldAnnotation.<span class="params">class</span>)</span>) &#123;</span><br><span class="line">                    FieldAnnotation fieldAnnotation = field.get<span class="constructor">Annotation(FieldAnnotation.<span class="params">class</span>)</span>;</span><br><span class="line">                    <span class="module-access"><span class="module"><span class="identifier">System</span>.</span></span>out.println(fieldAnnotation.desc<span class="literal">()</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void test<span class="constructor">MethodAnnotation(Class&lt;?&gt; <span class="params">clz</span>)</span> &#123;</span><br><span class="line">        Method<span class="literal">[]</span> methods = clz.get<span class="constructor">Methods()</span>;</span><br><span class="line">        <span class="keyword">if</span> (methods != null<span class="operator"> &amp;&amp; </span>methods.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Method <span class="keyword">method</span> : methods) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">method</span>.is<span class="constructor">AnnotationPresent(MethodAnnotation.<span class="params">class</span>)</span>) &#123;</span><br><span class="line">                    MethodAnnotation methodAnnotation = <span class="keyword">method</span>.get<span class="constructor">Annotation(MethodAnnotation.<span class="params">class</span>)</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">method</span>.invoke(clz.<span class="keyword">new</span><span class="constructor">Instance()</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">                    &#125; catch (IllegalAccessException <span class="pattern-match">| <span class="constructor">InvocationTargetException</span></span></span><br><span class="line"><span class="pattern-match">                            | <span class="constructor">InstantiationException</span> e) &#123;</span></span><br><span class="line"><span class="pattern-match">                        e.print<span class="constructor">StackTrace()</span>;</span></span><br><span class="line"><span class="pattern-match">                    &#125;</span></span><br><span class="line"><span class="pattern-match">                    <span class="constructor">System</span>.out.println(<span class="keyword">method</span><span class="constructor">Annotation</span>.desc());</span></span><br><span class="line"><span class="pattern-match">                &#125;</span></span><br><span class="line"><span class="pattern-match">            &#125;</span></span><br><span class="line"><span class="pattern-match">        &#125;</span></span><br><span class="line"><span class="pattern-match">    &#125;</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">    public void test<span class="constructor">ParamAnnotation(Class&lt;?&gt; <span class="params">clz</span>)</span> &#123;</span></span><br><span class="line"><span class="pattern-match">        <span class="constructor">Method</span>[] methods = clz.get<span class="constructor">Methods()</span>;</span></span><br><span class="line"><span class="pattern-match">        <span class="keyword">if</span> (methods != null <span class="operator">&amp;&amp;</span> methods.length &gt; 0) &#123;</span></span><br><span class="line"><span class="pattern-match">            <span class="keyword">for</span> (<span class="constructor">Method</span> <span class="keyword">method</span> : methods) &#123;</span></span><br><span class="line"><span class="pattern-match">                <span class="keyword">if</span> (<span class="keyword">method</span>.is<span class="constructor">AnnotationPresent(MethodAnnotation.<span class="params">class</span>)</span>) &#123;</span></span><br><span class="line"><span class="pattern-match">                    <span class="constructor">Parameter</span>[] parameters = <span class="keyword">method</span>.get<span class="constructor">Parameters()</span>;</span></span><br><span class="line"><span class="pattern-match">                    <span class="keyword">if</span> (parameters != null <span class="operator">&amp;&amp;</span> parameters.length &gt; 0) &#123;</span></span><br><span class="line"><span class="pattern-match">                        <span class="keyword">for</span> (<span class="constructor">Parameter</span> parameter : parameters) &#123;</span></span><br><span class="line"><span class="pattern-match">                            <span class="keyword">if</span>(parameter.is<span class="constructor">AnnotationPresent(ParamAnnotation.<span class="params">class</span>)</span>) &#123;</span></span><br><span class="line"><span class="pattern-match">                                <span class="constructor">ParamAnnotation</span> param<span class="constructor">Annotation</span> = parameter.get<span class="constructor">Annotation(ParamAnnotation.<span class="params">class</span>)</span>;</span></span><br><span class="line"><span class="pattern-match">                                <span class="constructor">System</span>.out.println(param<span class="constructor">Annotation</span>.desc());</span></span><br><span class="line"><span class="pattern-match">                            &#125;</span></span><br><span class="line"><span class="pattern-match">                        &#125;</span></span><br><span class="line"><span class="pattern-match">                    &#125;</span></span><br><span class="line"><span class="pattern-match">                &#125;</span></span><br><span class="line"><span class="pattern-match">            &#125;</span></span><br><span class="line"><span class="pattern-match">        &#125;</span></span><br><span class="line"><span class="pattern-match">    &#125;</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">&#125;</span></span><br><span class="line"><span class="pattern-match"></span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>编译时解析<br>编译时注解指的是@Retention的值为CLASS的注解。对于这类注解的解析，我们需要自定义一个派生自 AbstractProcessor的“注解处理类”并重写process 函数。</p>
</li>
<li><p>APT(Annotation Processing Tool)是一种处理注释的工具<br>Annotation处理器在处理注释时可以根据源文件中的Annotation生成额外的源文件和其它的文件,APT还会编译生成的源文件和原来的源文件，将它们一起生成class文件。</p>
</li>
<li><p>整个注解处理器的可以由如下几个部分构成：<br>注解处理器（AbstractProcess）+代码处理（JavaPoet）+处理器注册（AutoService）+apt</p>
</li>
<li><p>整个过程分成如下几个部分：<br>1.定义注解（如@automain）<br>2.定义注解处理器<br>3.在处理器里面完成处理方式，通常是生成java代码，这个就需要用到代码处理。<br>4.注册处理器，这里就需要用到处理器注册。<br>5.利用APT进一步处理。</p>
</li>
</ul>
<p>建立一个APT 项目，并添加apt依赖：</p>
<figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"><span class="keyword">buildscript</span> &#123;</span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">dependencies</span> &#123;</span><br><span class="line">        <span class="keyword">classpath</span> <span class="string">&#x27;com.android.tools.build:gradle:2.2.3&#x27;</span></span><br><span class="line">        <span class="keyword">classpath</span> <span class="string">&#x27;com.neenbedankt.gradle.plugins:android-apt:1.8&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">allprojects</span> &#123;</span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">task</span> clean(type: <span class="keyword">Delete</span>) &#123;</span><br><span class="line">    <span class="keyword">delete</span> rootProject.buildDir</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加apt 插件</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">//</span>添加APT plugin</span><br><span class="line">apply plugin: <span class="string">&#x27;com.neenbedankt.android-apt&#x27;</span></span><br></pre></td></tr></table></figure>
<p>新建一个model 命名为compiler 用于存放注解处理器：<br>并添加autoservice 和javapoet依赖：</p>
<figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line">apply plugin: <span class="string">&#x27;java&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    <span class="keyword">compile</span> <span class="keyword">fileTree</span>(dir: <span class="string">&#x27;libs&#x27;</span>, <span class="keyword">include</span>: [<span class="string">&#x27;*.jar&#x27;</span>])</span><br><span class="line">    <span class="keyword">compile</span> <span class="string">&#x27;com.squareup:javapoet:1.8.0&#x27;</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">&#x27;com.google.auto.service:auto-service:1.0-rc2&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">sourceCompatibility</span> = <span class="string">&quot;1.7&quot;</span></span><br><span class="line"><span class="keyword">targetCompatibility</span> = <span class="string">&quot;1.7&quot;</span></span><br></pre></td></tr></table></figure>

<p>创建AnnotationProcessor</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.auto.service.AutoService;</span><br><span class="line"><span class="keyword">import</span> com.squareup.javapoet.JavaFile;</span><br><span class="line"><span class="keyword">import</span> com.squareup.javapoet.MethodSpec;</span><br><span class="line"><span class="keyword">import</span> com.squareup.javapoet.TypeSpec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.processing.AbstractProcessor;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.processing.Processor;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.processing.RoundEnvironment;</span><br><span class="line"><span class="keyword">import</span> javax.lang.model.element.Modifier;</span><br><span class="line"><span class="keyword">import</span> javax.lang.model.element.TypeElement;</span><br><span class="line"></span><br><span class="line"><span class="meta">@AutoService(Processor.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AnnotationProcessor</span> <span class="keyword">extends</span> <span class="title class_">AbstractProcessor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Set&lt;String&gt; <span class="title function_">getSupportedAnnotationTypes</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Collections.singleton(TestAnnotation.class.getCanonicalName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> &#123;</span><br><span class="line">        <span class="type">MethodSpec</span> <span class="variable">main</span> <span class="operator">=</span> MethodSpec.methodBuilder(<span class="string">&quot;main&quot;</span>)</span><br><span class="line">                .addModifiers(Modifier.PUBLIC, Modifier.STATIC)</span><br><span class="line">                .returns(<span class="keyword">void</span>.class)</span><br><span class="line">                .addParameter(String[].class, <span class="string">&quot;args&quot;</span>)</span><br><span class="line">                .addStatement(<span class="string">&quot;$T.out.println($S)&quot;</span>, System.class, <span class="string">&quot;Hello, JavaPoet!&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="type">TypeSpec</span> <span class="variable">helloWorld</span> <span class="operator">=</span> TypeSpec.classBuilder(<span class="string">&quot;HelloWorld&quot;</span>)</span><br><span class="line">                .addModifiers(Modifier.PUBLIC, Modifier.FINAL)</span><br><span class="line">                .addMethod(main)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="type">JavaFile</span> <span class="variable">javaFile</span> <span class="operator">=</span> JavaFile.builder(<span class="string">&quot;com.example.helloworld&quot;</span>, helloWorld)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            javaFile.writeTo(processingEnv.getFiler());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这时候编译后会在&#x2F;app&#x2F;build&#x2F;generated&#x2F;source&#x2F;apt&#x2F;debug&#x2F;目录下生成HelloWorld.java文件</p>
<p>参考材料<br><a target="_blank" rel="noopener" href="http://www.race604.com/annotation-processing/">http://www.race604.com/annotation-processing/</a><br><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/1942ad208927">http://www.jianshu.com/p/1942ad208927</a><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/lmj623565791/article/details/43452969">http://blog.csdn.net/lmj623565791/article/details/43452969</a><br><a target="_blank" rel="noopener" href="https://github.com/taoweiji/DemoAPT?utm_source=tuicool&amp;utm_medium=referral">https://github.com/taoweiji/DemoAPT?utm_source=tuicool&amp;utm_medium=referral</a><br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/lbangel/p/3523741.html">http://www.cnblogs.com/lbangel/p/3523741.html</a><br><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/94979c056b20">http://www.jianshu.com/p/94979c056b20</a><br><a target="_blank" rel="noopener" href="http://alighters.com/blog/2016/05/10/apt-code-generate/">http://alighters.com/blog/2016/05/10/apt-code-generate/</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>



<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/02/06/Java-进阶系列之注解/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/02/06/Java-进阶系列之注解/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/02/06/Java-进阶系列之反射/" title="Java 进阶系列之反射" itemprop="url">Java 进阶系列之反射</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Edgar" target="_blank" itemprop="author">Edgar</a>
		
  <p class="article-time">
    <time datetime="2017-02-06T13:05:58.000Z" itemprop="datePublished"> Published 2017-02-06</time>
    
  </p>
</header>
    <div class="article-content">
        
        
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>



<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/02/06/Java-进阶系列之反射/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/02/06/Java-进阶系列之反射/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/02/06/Java-进阶系列之泛型/" title="Java 进阶系列之泛型" itemprop="url">Java 进阶系列之泛型</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Edgar" target="_blank" itemprop="author">Edgar</a>
		
  <p class="article-time">
    <time datetime="2017-02-06T13:05:43.000Z" itemprop="datePublished"> Published 2017-02-06</time>
    
  </p>
</header>
    <div class="article-content">
        
        
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>



<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/02/06/Java-进阶系列之泛型/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/02/06/Java-进阶系列之泛型/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/02/06/Java-进阶系列之枚举/" title="Java 进阶系列之枚举" itemprop="url">Java 进阶系列之枚举</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Edgar" target="_blank" itemprop="author">Edgar</a>
		
  <p class="article-time">
    <time datetime="2017-02-06T13:05:26.000Z" itemprop="datePublished"> Published 2017-02-06</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>本章知识点</p>
<ul>
<li>Enume 枚举类型的重要方法的使用</li>
<li>自定义枚举变量并为自定义枚举类添加相关方法</li>
<li>分类枚举的组织方式</li>
<li>EnumeSet 和 EnumeMap的使用</li>
</ul>
<p>在开始介绍今天的专题之前我们首先需要明确下什么时候我们会使用到枚举，在未接触枚举之前，大家或许写过这样的代码：</p>
<figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> <span class="type">int</span> LIGHT_STATUS_OFF = <span class="number">1</span>; <span class="comment">//表示灯关闭的状态</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> <span class="type">int</span> LIGHT_STATUS_ON = <span class="number">2</span>;  <span class="comment">//表示灯开启的状态</span></span><br></pre></td></tr></table></figure>

<p>也就是用一些常量表示某个时刻的状态，这种表示方式有如下几个缺点：</p>
<ul>
<li>类型不安全<br>由于状态的对应值是整型，所以程序执行过程中很有可能传入一个任意的整数值，从而导致出现错误。</li>
<li>一致性差<br>因为整型枚举属于编译期常量，所以编译过程完成后，所有客户端和服务器端引用的地方，会直接将整数值写入。这样，当你修改旧的枚举整数值后或者增加新的枚举值后，所有引用地方代码都需要重新编译，否则运行时刻就会出现错误。</li>
<li>可读性差<br>由于上述用于枚举的仅仅是一些无任何含义的整数值，如果在运行期调试时候，你就会发现日志中有很多难以理解的数字，但除了程序员本身，其他人很难明白其所表示的真实含义，比较不直观。</li>
</ul>
<p>为了解决这些问题在5.0 版本 SDK 发布时候引入了枚举特性，通过枚举，可以把相关的常量分组到一个枚举类型里，而且枚举提供了比常量更多的方法。</p>
<p>上面的常量可以通过下面的枚举变量进行实现：</p>
<figure class="highlight actionscript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> enume LIGHT_STATUS &#123;</span><br><span class="line">    LIGHT_STATUS_OFF,</span><br><span class="line">    LIGHT_STATUS_ON</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Enume-枚举类型的重要方法的使用"><a href="#Enume-枚举类型的重要方法的使用" class="headerlink" title="Enume 枚举类型的重要方法的使用"></a>Enume 枚举类型的重要方法的使用</h4><p>Enume 对象的可用方法不多,列举如下:</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">values</span><span class="params">()</span></span> 用于返回整个枚举所包含的状态值</span><br><span class="line"><span class="function"><span class="title">name</span><span class="params">()</span></span> 用于返回某个enume item的名字</span><br><span class="line"><span class="function"><span class="title">ordinal</span><span class="params">()</span></span> 用于获取当前enume item 在枚举类中声明时候的次序</span><br><span class="line"><span class="function"><span class="title">getDeclaringClass</span><span class="params">()</span></span> 用于获取当前enume item在哪个枚举类中进行声明</span><br></pre></td></tr></table></figure>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">private enum LIGHT_STATUS &#123;</span><br><span class="line">    LIGHT_STATUS_ON,</span><br><span class="line">    LIGHT_STATUS_OFF;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">public</span> <span class="type">void</span> enumBaseUsage() &#123;</span><br><span class="line">    <span class="keyword">System</span>.<span class="keyword">out</span>.println(&quot;There are &quot;+LIGHT_STATUS.<span class="keyword">values</span>().length+&quot; members in LIGHT_STATUS&quot;);</span><br><span class="line">    <span class="keyword">for</span>(LIGHT_STATUS status:LIGHT_STATUS.<span class="keyword">values</span>()) &#123;</span><br><span class="line">        <span class="keyword">System</span>.<span class="keyword">out</span>.println(status.ordinal()+&quot; : &quot;+status.name()+ &quot; : Declaring in &quot;+status.getDeclaringClass().getSimpleName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于编译器会自动为我们提供equals()以及hashCode(),所以可以使用&#x3D;&#x3D;来比较enume实例，同时由于它也实现了Comparable接口所以也可以使用compareTo方法进行比较，除了实现了Comparable 接口外，它还实现了Serializable接口。</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line"><span class="built_in">public</span> <span class="type">void</span> enumeValueCompare() &#123;</span><br><span class="line"></span><br><span class="line">    LIGHT_STATUS statusA = LIGHT_STATUS.LIGHT_STATUS_ON;</span><br><span class="line">    LIGHT_STATUS statusB = LIGHT_STATUS.LIGHT_STATUS_ON;</span><br><span class="line">    LIGHT_STATUS statusC = LIGHT_STATUS.LIGHT_STATUS_OFF;</span><br><span class="line">    <span class="keyword">if</span>(statusA == statusB) &#123;</span><br><span class="line">        <span class="keyword">System</span>.<span class="keyword">out</span>.println(&quot;equals&quot;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">System</span>.<span class="keyword">out</span>.println(&quot;not equals&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(statusA == statusC) &#123;</span><br><span class="line">        <span class="keyword">System</span>.<span class="keyword">out</span>.println(&quot;equals&quot;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">System</span>.<span class="keyword">out</span>.println(&quot;not equals&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(statusA.compareTo(statusC)&gt;<span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">System</span>.<span class="keyword">out</span>.println(&quot; &gt;0 &quot;);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(statusA.compareTo(statusC) == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">System</span>.<span class="keyword">out</span>.println(&quot; =0&quot;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">System</span>.<span class="keyword">out</span>.println(&quot; &lt;0&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="自定义枚举变量并为自定义枚举类添加相关方法"><a href="#自定义枚举变量并为自定义枚举类添加相关方法" class="headerlink" title="自定义枚举变量并为自定义枚举类添加相关方法"></a>自定义枚举变量并为自定义枚举类添加相关方法</h4><p>枚举的定义和类的定义十分相似，但是也存在着一些区别，下面是二者的区别点：</p>
<ul>
<li>首先枚举类型不能使用extends进行继承</li>
<li>枚举的定义分成两个部分，第一部分用于定义枚举实例，第二部分用于定义属性以及方法，但是需要注意点是在定义enume实例之前不能定义先定义任何属性活着方法，</li>
<li>对于枚举类的构造方法，一旦enume定义结束，编译器就不允许我们再使用其构造方法来创建任何实例。</li>
</ul>
<p>下面是自定义的一个枚举类型：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">enum</span> <span class="variable constant_">ITEM_TYPE</span> &#123;</span><br><span class="line">    <span class="title function_">ITEM_TYPE_NORMAL</span>(<span class="params"><span class="string">&quot;The item which is used to show normal item&quot;</span></span>)&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">getInfo</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;ITEM_TYPE_NORMAL&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">ITEM_TYPE_NEWEST</span>(<span class="params"><span class="string">&quot;The item which is used to show newest item&quot;</span></span>)&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">getInfo</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;ITEM_TYPE_NEWEST&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">ITEM_TYPE_HOTEST</span>(<span class="params"><span class="string">&quot;The item which is used to show hotest item&quot;</span></span>)&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">getInfo</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;ITEM_TYPE_HOTEST&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> description;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="built_in">void</span> <span class="title function_">getInfo</span>();</span><br><span class="line">    <span class="title function_">ITEM_TYPE</span>(<span class="params"><span class="built_in">String</span> description</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">description</span> = description;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getDescription</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> description;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它包括每个枚举类型实例，以及枚举类型的描述，下面是测试例子：<br>上面的例子中我们通过声明抽象方法，在每个enume 实例中进行覆写，来指定每个enume实例相关的方法，而在实例声明之后的方法实现的是全部实例共有的方法。</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line"><span class="built_in">public</span> <span class="type">void</span> customEnume() &#123;</span><br><span class="line">    <span class="keyword">for</span> (ITEM_TYPE itemType : ITEM_TYPE.<span class="keyword">values</span>()) &#123;</span><br><span class="line">        <span class="keyword">System</span>.<span class="keyword">out</span>.println(itemType.name() +&quot; : &quot; + itemType.getDescription() );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们看sdk源码的时候可以发现enume实际上是继承自Enume类的，但是Enume 类中并没有values方法，实际上values是编译器添加的静态方法，所以如果我们将enume实例向上转型为Enum  那么 values方法就不可使用了。<br>解决这个问题我们可以借助Class类中的getEnumeConstants 方法来获取所有enume实例。</p>
<figure class="highlight roboconf"><table><tr><td class="code"><pre><span class="line">public void getEnumeConstants() &#123;</span><br><span class="line">    <span class="attribute">Enum&lt;ITEM_TYPE&gt; itemTypeEnum = ITEM_TYPE.ITEM_TYPE_NEWEST;;</span></span><br><span class="line"><span class="attribute">    for (Enum item</span> : itemTypeEnum<span class="variable">.getClass</span>()<span class="variable">.getEnumConstants</span>()) &#123;</span><br><span class="line">        System<span class="variable">.out</span><span class="variable">.println</span>(item<span class="variable">.name</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="分类枚举的组织方式"><a href="#分类枚举的组织方式" class="headerlink" title="分类枚举的组织方式"></a>分类枚举的组织方式</h4><p>有时候我们每个枚举实例中还包含其他分类，这时候就要讲究枚举类的分类了：<br>下面是一种比较标准的分类写法，它使用接口Food将不同的子类组织起来，再通过getEnumConstants<br>获取每种子类型的值：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">enum</span> <span class="variable constant_">FOOD</span> &#123;</span><br><span class="line">    <span class="title function_">COFFEE</span>(<span class="title class_">Food</span>.<span class="property">Coffee</span>.<span class="property">class</span>),<span class="title function_">DESSERT</span>(<span class="title class_">Food</span>.<span class="property">Dessert</span>.<span class="property">class</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">interface</span> <span class="title class_">Food</span> &#123;</span><br><span class="line">        <span class="keyword">enum</span> <span class="title class_">Coffee</span> <span class="keyword">implements</span> <span class="title class_">Food</span> &#123;</span><br><span class="line">            <span class="variable constant_">BLACK_COFFEE</span>,<span class="variable constant_">WHITE_COFFEE</span>,<span class="variable constant_">TEA</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">enum</span> <span class="title class_">Dessert</span> <span class="keyword">implements</span> <span class="title class_">Food</span> &#123;</span><br><span class="line">            <span class="variable constant_">FRUIT</span>,<span class="variable constant_">GELATO</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Food</span>[] <span class="title class_">ItemValues</span>;</span><br><span class="line">    <span class="title function_">FOOD</span>(<span class="params">Class&lt;? <span class="keyword">extends</span> Food&gt; cls</span>) &#123;</span><br><span class="line">        <span class="title class_">ItemValues</span> = cls.<span class="title function_">getEnumConstants</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Food</span>[] <span class="title function_">getItemValues</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">ItemValues</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="EnumeSet-和-EnumeMap的使用"><a href="#EnumeSet-和-EnumeMap的使用" class="headerlink" title="EnumeSet 和 EnumeMap的使用"></a>EnumeSet 和 EnumeMap的使用</h4><p>EnumeSet用法：<br>在刚接触枚举的时候，当时没有觉得它有什么用处，第一感觉它和枚举没啥区别。但是后面才发现二者的区别，传统的enume不能添加或者删除元素，但是EnumeSet 可以添加删除。<br>假设我们有一种情况下，某个版本有不同的特性，这些特性分别用枚举实例来表示。那么这时候我们就可以构造一个具有全部特性的EnumeSet  再根据版本号来将代表某写特性的枚举值添加或者移除：</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line"><span class="built_in">public</span> <span class="type">void</span> testEnumeSet() &#123;</span><br><span class="line">    EnumSet&lt;ITEM_TYPE&gt; itemTypes = EnumSet.allOf(ITEM_TYPE.<span class="keyword">class</span>);</span><br><span class="line">    <span class="keyword">System</span>.<span class="keyword">out</span>.println(itemTypes);</span><br><span class="line">    itemTypes = EnumSet.noneOf(ITEM_TYPE.<span class="keyword">class</span>);</span><br><span class="line">    <span class="keyword">System</span>.<span class="keyword">out</span>.println(itemTypes);</span><br><span class="line">    itemTypes = EnumSet.<span class="keyword">of</span>(ITEM_TYPE.ITEM_TYPE_HOTEST);</span><br><span class="line">    <span class="keyword">System</span>.<span class="keyword">out</span>.println(itemTypes);</span><br><span class="line">    itemTypes = EnumSet.range(ITEM_TYPE.ITEM_TYPE_NEWEST, ITEM_TYPE.ITEM_TYPE_HOTEST);</span><br><span class="line">    <span class="keyword">System</span>.<span class="keyword">out</span>.println(itemTypes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>EnumeMap用法：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">testEnumeMap</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">EnumMap</span>&lt;<span class="variable constant_">LIGHT_STATUS</span>, command&gt; itemMap = <span class="keyword">new</span> <span class="title class_">EnumMap</span>&lt;<span class="variable constant_">LIGHT_STATUS</span>, command&gt;(<span class="variable constant_">LIGHT_STATUS</span>.<span class="property">class</span>);</span><br><span class="line">    itemMap.<span class="title function_">put</span>(<span class="variable constant_">LIGHT_STATUS</span>.<span class="property">LIGHT_STATUS_ON</span>, <span class="keyword">new</span> <span class="title function_">command</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">action</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;The light is on, i will turn off the light&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    itemMap.<span class="title function_">put</span>(<span class="variable constant_">LIGHT_STATUS</span>.<span class="property">LIGHT_STATUS_OFF</span>, <span class="keyword">new</span> <span class="title function_">command</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">action</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;The light is off, i will turn on the light&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    itemMap.<span class="title function_">get</span>(<span class="variable constant_">LIGHT_STATUS</span>.<span class="property">LIGHT_STATUS_ON</span>).<span class="title function_">action</span>();</span><br><span class="line">    itemMap.<span class="title function_">get</span>(<span class="variable constant_">LIGHT_STATUS</span>.<span class="property">LIGHT_STATUS_OFF</span>).<span class="title function_">action</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="如何避免错误使用-Enum"><a href="#如何避免错误使用-Enum" class="headerlink" title="如何避免错误使用 Enum"></a>如何避免错误使用 Enum</h4><p>在使用 Enum 时候有几个地方需要注意：<br>enum 类型不支持 public 和 protected 修饰符的构造方法，因此构造函数一定要是 private。也正因为如此，所以枚举对象是无法在程序中通过直接调用其构造方法来初始化的。<br>定义 enum 类型时候，如果是简单类型，那么最后一个枚举值后不用跟任何一个符号；但如果有定制方法，那么最后一个枚举值与后面代码要用分号’;’隔开，不能用逗号或空格。<br>由于 enum 类型的值实际上是通过运行期构造出对象来表示的，所以在 cluster 环境下，每个虚拟机都会构造出一个同义的枚举对象。因而在做比较操作时候就需要注意，如果直接通过使用等号 ( ‘ &#x3D;&#x3D; ’ ) 操作符，这些看似一样的枚举值一定不相等，因为这不是同一个对象实例。<br>一个 Java 源文件中最多只能有一个 public 类型的枚举类，且该 Java 源文件的名字也必须和该枚举类的类名相同<br>使用 enum 定义的枚举类默认继承了 java.lang.Enum 类，并实现了 java.lang.Seriablizable 和 java.lang.Comparable 两个接口;<br>枚举类的所有实例(枚举值)必须在枚举类的第一行显式地列出，否则这个枚举类将永远不能产生实例。列出这些实例(枚举值)时，系统会自动添加 public static final 修饰，无需显式添加。</p>
<h4 id="在Android-开发中为什么需要节制使用枚举"><a href="#在Android-开发中为什么需要节制使用枚举" class="headerlink" title="在Android 开发中为什么需要节制使用枚举"></a>在Android 开发中为什么需要节制使用枚举</h4><p>(该部分引用自 <a target="_blank" rel="noopener" href="http://www.codeceo.com/article/why-android-not-use-enums.html">http://www.codeceo.com/article/why-android-not-use-enums.html</a>)<br>关于Android性能优化中一个常见的建议是不要在你的代码中使用Enums，就连 Android官网上都强烈建议不要使用。为什么？<br>因为使用枚举之后增加了dex包的大小，理论上dex包越大，加载速度越慢<br>同时使用枚举，运行时的内存占用也会相对变大 （Enums often require more than twice as much memory as static constants）</p>
<p>Android中当你的App启动后系统会给App单独分配一块内存。App的DEX code、Heap以及运行时的内存分配都会在这块内存中。接下来看两种写法：</p>
<ul>
<li>使用Int表示状态<figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> <span class="type">int</span> VALUE1 =<span class="number">1</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> <span class="type">int</span> VALUE1 =<span class="number">2</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> <span class="type">int</span> VALUE1 =<span class="number">3</span>;</span><br></pre></td></tr></table></figure></li>
<li>使用Enums表示状态<figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">static</span> <span class="keyword">enum</span> <span class="title class_">Value</span>&#123;</span><br><span class="line">  VALUE1,</span><br><span class="line">  VALUE2,</span><br><span class="line">  VALUE3</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
情形2中的DEX size增加是情形1中的13倍之多。这还只是DEX code的增加，同样，运行时的内存分配，一个enum值的声明会消耗至少20 bytes，这还不算其中的对象数组需要保持对enum值的引用。Why？使用javap反编译情形二中生成的class文件，去掉汇编代码后如下：<figure class="highlight axapta"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">VALUE</span> <span class="keyword">extends</span> <span class="title class_ inherited__">java</span>.lang.Enum&#123;  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> VALUE VALUE1;  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> VALUE VALUE2;  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> VALUE VALUE3;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> VALUE[] values[];</span><br><span class="line">  <span class="keyword">static</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
可以看到实际上enum类型继承java.lang.Enum，每个枚举项都会被声明成一个静态变量，并被赋值。VALUE value1 &#x3D; VALUE.VALUE1则会引起对静态变量的引用。<br>因此，当你的代码或包含的Lib中大量使用enums时，对于本身内存小的手机将是灾难性的。不可否认enums会使得代码更易读更安全，那么我们需要如何在二者之间做权衡呢：<br>我们可以看这个帖子的回答：</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/29183904/should-i-strictly-avoid-using-enums-on-android">http://stackoverflow.com/questions/29183904/should-i-strictly-avoid-using-enums-on-android</a><br>大体的意思是，在如下情况下可以考虑用枚举</p>
<ul>
<li>需要类型检查的时候，我们只能接受某些非连续的值的情况，使用枚举变量可以有效避免传入非安全的值。</li>
<li>更多的数据，你的数据包含不止一个信息并且这些信息不能放在一个变量中的时候。</li>
<li>复杂的数据，你的数据需要一些操作方法作用在它上面的时候。</li>
</ul>
<p>除了这些情况大家尽量不使用枚举，简单来说就是能不用enume 的尽量不用，那么我们是否能够克服使用静态常量的问题呢？肯定是有办法的，下面就介绍下Android中的替代方案：</p>
<h4 id="Android中的替代方案"><a href="#Android中的替代方案" class="headerlink" title="Android中的替代方案"></a>Android中的替代方案</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Sexs</span> &#123;</span><br><span class="line">    <span class="meta">@IntDef(&#123;MALE, FEMALE&#125;)</span></span><br><span class="line">    <span class="meta">@Retention(RetentionPolicy.SOURCE)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="meta">@interface</span> PersonSex&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MALE</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">FEMALE</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.main_activity);</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">        person.setSex(MALE);</span><br><span class="line">        ((Button) findViewById(R.id.test)).setText(person.getSexDes());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Sexs</span>.PersonSex </span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> sex;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSex</span><span class="params">(<span class="meta">@Sexs</span>.PersonSex <span class="type">int</span> sex)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.sex = sex;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Sexs</span>.PersonSex </span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getSex</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> sex;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getSexDes</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (sex == MALE) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;男&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;女&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>@SEX注解可以放到属性定义，参数，返回值等地方对数据类型进行限制。</p>
<h4 id="为什么Enume-不能继承其他类，也不能被其他类继承"><a href="#为什么Enume-不能继承其他类，也不能被其他类继承" class="headerlink" title="为什么Enume 不能继承其他类，也不能被其他类继承"></a>为什么Enume 不能继承其他类，也不能被其他类继承</h4><p>为了说明这个问题我们先编写一个枚举类如下所示：</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> EnumeTest &#123;</span><br><span class="line">        LIGHT_STATUS_ON,LIGHT_STATUS_OFF</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后紧接着将该类编译成class文件，然后使用javap来反编译查看到底长啥样,下面就是反编译后的样子：</p>
 <figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">EnumeTest</span> extends java.lang.Enum&lt;EnumeTest&gt; &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> EnumeTest LIGHT_STATUS_ON;</span><br><span class="line">  <span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> EnumeTest LIGHT_STATUS_OFF;</span><br><span class="line">  <span class="keyword">public</span> <span class="type">static</span> EnumeTest[] <span class="built_in">values</span>();</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="type">static</span> EnumeTest <span class="title">valueOf</span><span class="params">(java.lang.<span class="type">String</span>)</span></span>;</span><br><span class="line">  <span class="type">static</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 大家应该知道为什么enume后面不能使用extends来继承其他类了吧，因为已经继承了Enum，Java中不支持多继承，那为啥不能被其他继承？因为是final 类。</p>
<h4 id="枚举与混淆"><a href="#枚举与混淆" class="headerlink" title="枚举与混淆"></a>枚举与混淆</h4><p>混淆大家估计都懂吧，即使不懂也听说过这个概念，就是用于增强反编译的难度，基本上大多数的app在发布之前都会通过混淆处理，在默认的混淆配置文件中,已经加入了对枚举混淆的处理</p>
<figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line"># For enumeration classes, see http:<span class="comment">//proguard.sourceforge.net/manual/examples.html#enumerations</span></span><br><span class="line">-keepclassmembers <span class="keyword">enum</span> * &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">static</span> **[] <span class="built_in">values</span>();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="type">static</span> ** <span class="title">valueOf</span><span class="params">(java.lang.<span class="type">String</span>)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使用proguard优化"><a href="#使用proguard优化" class="headerlink" title="使用proguard优化"></a>使用proguard优化</h4><p>使用Proguard进行优化，可以将枚举尽可能的转换成int。配置如下</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">-optimizations <span class="keyword">class</span>/<span class="symbol">unboxing</span>/<span class="symbol">enum</span></span><br></pre></td></tr></table></figure>

<p>确保上述代码生效，需要确proguard配置文件不包含-dontoptimize指令。</p>
<h4 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h4><p><a target="_blank" rel="noopener" href="http://www.ibm.com/developerworks/cn/java/j-lo-enum/">http://www.ibm.com/developerworks/cn/java/j-lo-enum/</a><br><a target="_blank" rel="noopener" href="https://www.liaohuqiu.net/cn/posts/android-enum-memory-usage/">https://www.liaohuqiu.net/cn/posts/android-enum-memory-usage/</a><br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/zgz345/p/5871351.html">http://www.cnblogs.com/zgz345/p/5871351.html</a><br><a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/29183904/should-i-strictly-avoid-using-enums-on-android">http://stackoverflow.com/questions/29183904/should-i-strictly-avoid-using-enums-on-android</a><br><a target="_blank" rel="noopener" href="http://droidyue.com/blog/2016/11/29/dive-into-enum/index.html">http://droidyue.com/blog/2016/11/29/dive-into-enum/index.html</a><br><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/f8ac84a3e3c1">http://www.jianshu.com/p/f8ac84a3e3c1</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>



<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/02/06/Java-进阶系列之枚举/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/02/06/Java-进阶系列之枚举/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/01/17/JavaScript-查缺补漏清单/" title="JavaScript 查缺补漏清单" itemprop="url">JavaScript 查缺补漏清单</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Edgar" target="_blank" itemprop="author">Edgar</a>
		
  <p class="article-time">
    <time datetime="2017-01-17T15:48:52.000Z" itemprop="datePublished"> Published 2017-01-17</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ol>
<li><p>变量名可以使用$或者 _开头 </p>
</li>
<li><p>javascript 有七种数据类型:Number , String ,Boolean, Object,null,undefined,symbol.<br>由于JavaScript的变量作用域实际上是函数内部，我们在for循环等语句块中是无法定义具有局部作用域的变量的：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;<span class="number">100</span>; i++) &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">    i += <span class="number">100</span>; <span class="comment">// 仍然可以引用变量i</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了解决块级作用域，ES6引入了新的关键字let，用let替代var可以申明一个块级作用域的变量：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i=<span class="number">0</span>; i&lt;<span class="number">100</span>; i++) &#123;</span><br><span class="line">        sum += i;</span><br><span class="line">    &#125;</span><br><span class="line">    i += <span class="number">1</span>; <span class="comment">// SyntaxError</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于var和let申明的是变量，如果要申明一个常量，在ES6之前是不行的，我们通常用全部大写的变量来表示“这是一个常量，不要修改它的值”：</p>
<figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">var PI <span class="operator">=</span> <span class="number">3.14</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>ES6标准引入了新的关键字const来定义常量，const与let都具有块级作用域：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PI</span> = <span class="number">3.14</span>;</span><br><span class="line"><span class="variable constant_">PI</span> = <span class="number">3</span>; <span class="comment">// 某些浏览器不报错，但是无效果！</span></span><br><span class="line"><span class="variable constant_">PI</span>; <span class="comment">// 3.14</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>使用var申明的变量则不是全局变量，它的范围被限制在该变量被申明的函数体内，同名变量在不同的函数体内互不冲突。<br>为了修补JavaScript这一严重设计缺陷，ECMA在后续规范中推出了strict模式，在strict模式下运行的JavaScript代码，强制通过var申明变量，未使用var申明变量就使用的，将导致运行错误。启用strict模式的方法是在JavaScript代码的第一行写上：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>这是一个字符串，不支持strict模式的浏览器会把它当做一个字符串语句执行，支持strict模式的浏览器将开启strict模式运行JavaScript。<br>JavaScript在设计之初，为了方便初学者学习，并不强制要求用var申明变量。这个设计错误带来了严重的后果：如果一个变量没有通过var申明就被使用，那么该变量就自动被申明为全局变量：<br>i &#x3D; 10; &#x2F;&#x2F; i现在是全局变量<br>定义值的标志有三种 var  let const：</p>
</li>
<li><p>null 和undefined的区别：<br>JavaScript的设计者希望用null表示一个空的值，而undefined表示值未定义。事实证明，这并没有什么卵用，区分两者的意义不大。大多数情况下，我们都应该用null。undefined仅仅在判断函数参数是否传递的情况下有用。实际上也可以记住，对象类型用null。基本数据类型用undefined。</p>
</li>
<li><p>关于字符串<br>‘’单引号可以包含双引号，双引号内部可以包含单引号，· · 内部可以包含很多包括换行在内的符号由于多行字符串用\n写起来比较费事，所以最新的ES6标准新增了一种多行字符串的表示方法，用<code>...</code>表示：<br><code>这是一个 多行 字符串</code>;<br>要把多个字符串连接起来，可以用+号连接：</p>
<figure class="highlight delphi"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="keyword">name</span> = <span class="string">&#x27;小明&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> age = <span class="number">20</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="keyword">message</span> = <span class="string">&#x27;你好, &#x27;</span> + <span class="keyword">name</span> + <span class="string">&#x27;, 你今年&#x27;</span> + age + <span class="string">&#x27;岁了!&#x27;</span>;</span><br><span class="line">alert(<span class="keyword">message</span>);</span><br></pre></td></tr></table></figure>
<p>如果有很多变量需要连接，用+号就比较麻烦。ES6新增了一种模板字符串，表示方法和上面的多行字符串一样，但是它会自动替换字符串中的变量：</p>
<figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> name = <span class="string">&#x27;小明&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> age = <span class="number">20</span>;</span><br><span class="line"><span class="keyword">var</span> message = <span class="string">`你好, <span class="subst">$&#123;name&#125;</span>, 你今年<span class="subst">$&#123;age&#125;</span>岁了!`</span>;</span><br><span class="line">alert(message);</span><br></pre></td></tr></table></figure>
</li>
<li><p>要特别注意相等运算符&#x3D;&#x3D;。JavaScript在设计时，有两种比较运算符：<br>第一种是&#x3D;&#x3D;比较，它会自动转换数据类型再比较，很多时候，会得到非常诡异的结果；<br>第二种是&#x3D;&#x3D;&#x3D;比较，它不会自动转换数据类型，如果数据类型不一致，返回false，如果一致，再比较。<br>由于JavaScript这个设计缺陷，不要使用&#x3D;&#x3D;比较，始终坚持使用&#x3D;&#x3D;&#x3D;比较。<br>还有一个特殊的对比符号为全不等，表示数值和类型都不相等。</p>
</li>
<li><p>&amp;&amp; 和|| 返回的是第一个可以判断结果的那个值</p>
</li>
<li><p>for in<br>for循环的一个变体是for … in循环，它可以把一个对象的所有属性依次循环出来：</p>
<figure class="highlight xquery"><table><tr><td class="code"><pre><span class="line">var o = &#123;</span><br><span class="line">   <span class="built_in"> name</span>: <span class="string">&#x27;Jack&#x27;</span>,</span><br><span class="line">    age: <span class="number">20</span>,</span><br><span class="line">    city: <span class="string">&#x27;Beijing&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">for</span> (var<span class="built_in"> key</span> <span class="keyword">in</span> o) &#123;</span><br><span class="line">    alert<span class="built_in">(key</span>); // <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;age&#x27;</span>, <span class="string">&#x27;city&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于Array也是对象，而它的每个元素的索引被视为对象的属性，因此，for … in循环可以直接循环出Array的索引：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">var a = [<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>];</span><br><span class="line"><span class="keyword">for</span> (var i <span class="keyword">in</span> a) &#123;</span><br><span class="line">    alert(i); <span class="regexp">//</span> <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span></span><br><span class="line">    alert(a[i]); <span class="regexp">//</span> <span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>for of 与for in的区别</p>
</li>
</ol>
<p>for … in循环由于历史遗留问题，它遍历的实际上是对象的属性名称。一个Array数组实际上也是一个对象，它的每个元素的索引被视为一个属性。当我们手动给Array对象添加了额外的属性后，for … in循环将带来意想不到的意外效果：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">var a = [<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>];</span><br><span class="line">a.name = <span class="string">&#x27;Hello&#x27;</span>;</span><br><span class="line"><span class="keyword">for</span> (var x <span class="keyword">in</span> a) &#123;</span><br><span class="line">    alert(x); <span class="regexp">//</span> <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;name&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>for … in循环将把name包括在内，但Array的length属性却不包括在内。<br>for … of循环则完全修复了这些问题，它只循环集合本身的元素：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">var a = [<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>];</span><br><span class="line">a.name = <span class="string">&#x27;Hello&#x27;</span>;</span><br><span class="line"><span class="keyword">for</span> (var x of a) &#123;</span><br><span class="line">    alert(x); <span class="regexp">//</span> <span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这就是为什么要引入新的for … of循环。</p>
<ol start="9">
<li>JavaScript把null、undefined、0、NaN和空字符串’’视为false，其他值一概视为true</li>
</ol>
<p>NaN这个特殊的Number与所有其他值都不相等，包括它自己：</p>
<figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">NaN</span> <span class="operator">=</span><span class="operator">=</span><span class="operator">=</span> NaN<span class="comment">; // false</span></span><br></pre></td></tr></table></figure>
<p>唯一能判断NaN的方法是通过isNaN()函数：</p>
<figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="built_in">isNaN</span>(<span class="literal">NaN</span>); <span class="comment">// true  </span></span><br></pre></td></tr></table></figure>

<ol start="10">
<li><p>数组：</p>
<figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3.14</span>, <span class="string">&#x27;Hello&#x27;</span>, <span class="literal">null</span>, <span class="literal">true</span>];</span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>); <span class="comment">// 创建了数组[1, 2, 3]</span></span><br></pre></td></tr></table></figure>
<p>可以是任意元素<br>可以读和修改某个元素<br>要取得Array的长度，直接访问length属性：</p>
<figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3.14</span>, <span class="string">&#x27;Hello&#x27;</span>, <span class="literal">null</span>, <span class="literal">true</span>];</span><br><span class="line">arr.<span class="built_in">length</span>; <span class="comment">// 6</span></span><br></pre></td></tr></table></figure>
<p>请注意，直接给Array的length赋一个新的值会导致Array大小的变化：</p>
<figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">arr.<span class="built_in">length</span>; <span class="comment">// 3</span></span><br><span class="line">arr.<span class="built_in">length</span> = <span class="number">6</span>;</span><br><span class="line">arr; <span class="comment">// arr变为[1, 2, 3, undefined, undefined, undefined]</span></span><br><span class="line">arr.<span class="built_in">length</span> = <span class="number">2</span>;</span><br><span class="line">arr; <span class="comment">// arr变为[1, 2]</span></span><br></pre></td></tr></table></figure>
<p>Array可以通过索引把对应的元素修改为新的值，因此，对Array的索引进行赋值会直接修改这个Array：</p>
<figure class="highlight prolog"><table><tr><td class="code"><pre><span class="line">var arr = [<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>];</span><br><span class="line">arr[<span class="number">1</span>] = <span class="number">99</span>;</span><br><span class="line">arr; // arr现在变为[<span class="string">&#x27;A&#x27;</span>, <span class="number">99</span>, <span class="string">&#x27;C&#x27;</span>]</span><br></pre></td></tr></table></figure>
<p>请注意，如果通过索引赋值时，索引超过了范围，同样会引起Array大小的变化：</p>
<figure class="highlight prolog"><table><tr><td class="code"><pre><span class="line">var arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">arr[<span class="number">5</span>] = <span class="string">&#x27;x&#x27;</span>;</span><br><span class="line">arr; // arr变为[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, undefined, undefined, <span class="string">&#x27;x&#x27;</span>]</span><br></pre></td></tr></table></figure>
<p>大多数其他编程语言不允许直接改变数组的大小，越界访问索引会报错。然而，JavaScript的Array却不会有任何错误。在编写代码时，不建议直接修改Array的大小，访问索引时要确保索引不会越界。</p>
</li>
<li><p>函数</p>
</li>
</ol>
<p>参数类<br>JavaScript的函数在查找变量时从自身函数定义开始，从“内”向“外”查找。如果内部函数定义了与外部函数重名的变量，则内部函数的变量将“屏蔽”外部函数的变量。<br>参数个数判断<br>如果没有return语句，函数执行完毕后也会返回结果，只是结果为undefined。<br>由于JavaScript允许传入任意个参数而不影响调用，因此传入的参数比定义的参数多也没有问题，虽然函数内部并不需要这些参数：<br>传入的参数比定义的少也没有问题。</p>
<p>arguments</p>
<p>JavaScript还有一个免费赠送的关键字arguments，它只在函数内部起作用，并且永远指向当前函数的调用者传入的所有参数。arguments类似Array但它不是一个Array：</p>
<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line">function <span class="built_in">foo</span>(x) &#123;</span><br><span class="line">    <span class="built_in">alert</span>(x); <span class="comment">// 10for (var i=0; i&lt;arguments.length; i++) &#123;</span></span><br><span class="line">        <span class="built_in">alert</span>(arguments[i]); <span class="comment">// 10, 20, 30</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">foo</span>(<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>);</span><br></pre></td></tr></table></figure>
<p>利用arguments，你可以获得调用者传入的所有参数。也就是说，即使函数不定义任何参数，还是可以拿到参数的值：</p>
<figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">abs</span>(<span class="params"></span>) &#123;<span class="keyword">if</span> (arguments.<span class="built_in">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> x = arguments[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">return</span> x &gt;= <span class="number">0</span> ? x : -x;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">abs</span>(); <span class="comment">// 0</span></span><br><span class="line"><span class="built_in">abs</span>(<span class="number">10</span>); <span class="comment">// 10</span></span><br><span class="line"><span class="built_in">abs</span>(<span class="number">-9</span>); <span class="comment">// 9</span></span><br></pre></td></tr></table></figure>
<p>实际上arguments最常用于判断传入参数的个数。你可能会看到这样的写法：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">//</span> foo(a[, b], c)<span class="regexp">//</span> 接收<span class="number">2</span>~<span class="number">3</span>个参数，b是可选参数，如果只传<span class="number">2</span>个参数，b默认为null：<span class="keyword">function</span> foo(a, b, c) &#123;<span class="keyword">if</span> (arguments.length === <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="regexp">//</span> 实际拿到的参数是a和b，c为undefined</span><br><span class="line">        c = b; <span class="regexp">//</span> 把b赋给c</span><br><span class="line">        b = null; <span class="regexp">//</span> b变为默认值</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="regexp">//</span> ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要把中间的参数b变为“可选”参数，就只能通过arguments判断，然后重新调整参数并赋值。</p>
<p>rest参数</p>
<p>由于JavaScript函数允许接收任意个参数，于是我们就不得不用arguments来获取所有参数：</p>
<figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">a, b</span>) &#123;<span class="keyword">var</span> i, rest = [];</span><br><span class="line">    <span class="keyword">if</span> (arguments.<span class="built_in">length</span> &gt; <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">2</span>; i&lt;arguments.<span class="built_in">length</span>; i++) &#123;</span><br><span class="line">            rest.<span class="built_in">push</span>(arguments[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&#x27;a = &#x27;</span> + a);</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&#x27;b = &#x27;</span> + b);</span><br><span class="line">    <span class="built_in">console</span>.<span class="built_in">log</span>(rest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了获取除了已定义参数a、b之外的参数，我们不得不用arguments，并且循环要从索引2开始以便排除前两个参数，这种写法很别扭，只是为了获得额外的rest参数，有没有更好的方法？</p>
<p>ES6标准引入了rest参数，上面的函数可以改写为：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> foo(a, b, ...rest) &#123;</span><br><span class="line">    console.log(<span class="string">&#x27;a = &#x27;</span> + a);</span><br><span class="line">    console.log(<span class="string">&#x27;b = &#x27;</span> + b);</span><br><span class="line">    console.log(rest);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">foo(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>);</span><br><span class="line"><span class="regexp">//</span> 结果:<span class="regexp">//</span> a = <span class="number">1</span><span class="regexp">//</span> b = <span class="number">2</span><span class="regexp">//</span> Array [ <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span> ]</span><br><span class="line"></span><br><span class="line">foo(<span class="number">1</span>);</span><br><span class="line"><span class="regexp">//</span> 结果:<span class="regexp">//</span> a = <span class="number">1</span><span class="regexp">//</span> b = undefined<span class="regexp">//</span> Array []</span><br></pre></td></tr></table></figure>
<p>rest参数只能写在最后，前面用…标识，从运行结果可知，传入的参数先绑定a、b，多余的参数以数组形式交给变量rest，所以，不再需要arguments我们就获取了全部参数。</p>
<p>如果传入的参数连正常定义的参数都没填满，也不要紧，rest参数会接收一个空数组（注意不是undefined</p>
<p>由于JavaScript的函数可以嵌套，此时，内部函数可以访问外部函数定义的变量，反过来则不行：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;<span class="keyword">var</span> x = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params"></span>) &#123;<span class="keyword">var</span> y = x + <span class="number">1</span>; <span class="comment">// bar可以访问foo的变量x!</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> z = y + <span class="number">1</span>; <span class="comment">// ReferenceError! foo不可以访问bar的变量y!</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>名字空间</p>
<p>全局变量会绑定到window上，不同的JavaScript文件如果使用了相同的全局变量，或者定义了相同名字的顶层函数，都会造成命名冲突，并且很难被发现。</p>
<p>减少冲突的一个方法是把自己的所有变量和函数全部绑定到一个全局变量中。例如：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">//</span> 唯一的全局变量MYAPP:var MYAPP = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span> 其他变量:</span><br><span class="line">MYAPP.name = <span class="string">&#x27;myapp&#x27;</span>;</span><br><span class="line">MYAPP.version = <span class="number">1.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span> 其他函数:</span><br><span class="line">MYAPP.foo = <span class="keyword">function</span> () &#123;return <span class="string">&#x27;foo&#x27;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>把自己的代码全部放入唯一的名字空间MYAPP中，会大大减少全局变量冲突的可能。</p>
<p>全局作用域</p>
<p>不在任何函数内定义的变量就具有全局作用域。实际上，JavaScript默认有一个全局对象window，全局作用域的变量实际上被绑定到window的一个属性：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> course = <span class="string">&#x27;Learn JavaScript&#x27;</span>;</span><br><span class="line"><span class="title function_">alert</span>(course); <span class="comment">// &#x27;Learn JavaScript&#x27;</span></span><br><span class="line"><span class="title function_">alert</span>(<span class="variable language_">window</span>.<span class="property">course</span>); <span class="comment">// &#x27;Learn JavaScript&#x27;</span></span><br></pre></td></tr></table></figure>
<p>因此，直接访问全局变量course和访问window.course是完全一样的。</p>
<p>你可能猜到了，由于函数定义有两种方式，以变量方式var foo &#x3D; function () {}定义的函数实际上也是一个全局变量，因此，顶层函数的定义也被视为一个全局变量，并绑定到window对象：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">alert</span>(<span class="string">&#x27;foo&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">foo</span>(); <span class="comment">// 直接调用foo()</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">foo</span>(); <span class="comment">// 通过window.foo()调用</span></span><br></pre></td></tr></table></figure>

<p>名称空间<br>全局作用域<br>局部作用域<br>参数作用域</p>
<p>对象<br>访问属性是通过.操作符完成的，但这要求属性名必须是一个有效的变量名。如果属性名包含特殊字符，就必须用’’括起来：<br>访问这个属性也无法使用.操作符，必须用[‘xxx’]来访问：</p>
<p>如果我们要检测xiaoming是否拥有某一属性，可以用in操作符：<br>要判断一个属性是否是xiaoming自身拥有的，而不是继承得到的，可以用hasOwnProperty()方法：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;name&#x27;</span> <span class="keyword">in</span> xiaoming; <span class="regexp">//</span> true</span><br><span class="line"><span class="string">&#x27;grade&#x27;</span> <span class="keyword">in</span> xiaoming; <span class="regexp">//</span> false</span><br><span class="line">xiaoming.hasOwnProperty(<span class="string">&#x27;name&#x27;</span>); <span class="regexp">//</span> true</span><br><span class="line">xiaoming.hasOwnProperty(<span class="string">&#x27;toString&#x27;</span>); <span class="regexp">//</span> false</span><br></pre></td></tr></table></figure>
<p>JavaScript对每个创建的对象都会设置一个原型，指向它的原型对象。</p>
<p>当我们用obj.xxx访问一个对象的属性时，JavaScript引擎先在当前对象上查找该属性，如果没有找到，就到其原型对象上找，如果还没有找到，就一直上溯到Object.prototype对象，最后，如果还没有找到，就只能返回undefined。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> myObject = &#123;</span><br><span class="line">	objectName : <span class="string">&quot;jimmy&quot;</span>,<span class="comment">/*注意这里是逗号*/</span></span><br><span class="line">	<span class="string">&quot;object-Age&quot;</span> : <span class="number">29</span>, <span class="comment">/*名字可以包含特殊字符，如果有特殊字符需要使用引号阔起来*/</span></span><br><span class="line">	getAge : <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable language_">this</span>[<span class="string">&quot;object-Age&quot;</span>];</span><br><span class="line">	&#125;<span class="comment">/*注意这里没有分号*/</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(myObject.<span class="title function_">getAge</span>());</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(myObject[<span class="string">&quot;object-Age&quot;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">User</span>(<span class="params">firstName,lastName</span>) &#123;</span><br><span class="line">	<span class="variable language_">this</span>.<span class="property">firstName</span> = firstName;</span><br><span class="line">	<span class="variable language_">this</span>.<span class="property">lastName</span> = lastName;</span><br><span class="line">	<span class="variable language_">this</span>.<span class="property">sayHello</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">		<span class="variable language_">console</span>.<span class="title function_">log</span>(firstName + <span class="string">&quot; : &quot;</span> +lastName);</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> user = <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;jimmy&quot;</span>,<span class="string">&quot;lin&quot;</span>);</span><br><span class="line">user.<span class="title function_">sayHello</span>();</span><br><span class="line"><span class="comment">//删除某个熟悉</span></span><br><span class="line"><span class="keyword">delete</span> user.<span class="property">firstName</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> key <span class="keyword">in</span> user) &#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;key ====&quot;</span>+key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用apply和call来绑定this的指向<br>虽然在一个独立的函数调用中，根据是否是strict模式，this指向undefined或window，不过，我们还是可以控制this的指向的！</p>
<p>要指定函数的this指向哪个对象，可以用函数本身的apply方法，它接收两个参数，第一个参数就是需要绑定的this变量，第二个参数是Array，表示函数本身的参数。</p>
<p>用apply修复getAge()调用：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getAge</span>(<span class="params"></span>) &#123;<span class="keyword">var</span> y = <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getFullYear</span>();</span><br><span class="line">    <span class="keyword">return</span> y - <span class="variable language_">this</span>.<span class="property">birth</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> xiaoming = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;小明&#x27;</span>,</span><br><span class="line">    <span class="attr">birth</span>: <span class="number">1990</span>,</span><br><span class="line">    <span class="attr">age</span>: getAge</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">xiaoming.<span class="title function_">age</span>(); <span class="comment">// 25</span></span><br><span class="line">getAge.<span class="title function_">apply</span>(xiaoming, []); <span class="comment">// 25, this指向xiaoming, 参数为空</span></span><br><span class="line">另一个与<span class="title function_">apply</span>()类似的方法是<span class="title function_">call</span>()，唯一区别是：</span><br></pre></td></tr></table></figure>
<p>apply()把参数打包成Array再传入；</p>
<p>call()把参数按顺序传入。</p>
<p>比如调用Math.max(3, 5, 4)，分别用apply()和call()实现如下：</p>
<figure class="highlight llvm"><table><tr><td class="code"><pre><span class="line">Math.<span class="keyword">max</span>.apply(<span class="keyword">null</span><span class="punctuation">,</span> [<span class="number">3</span><span class="punctuation">,</span> <span class="number">5</span><span class="punctuation">,</span> <span class="number">4</span>])<span class="comment">; // 5</span></span><br><span class="line">Math.<span class="keyword">max</span>.<span class="keyword">call</span>(<span class="keyword">null</span><span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">,</span> <span class="number">5</span><span class="punctuation">,</span> <span class="number">4</span>)<span class="comment">; // 5</span></span><br></pre></td></tr></table></figure>
<p>对普通函数调用，我们通常把this绑定为null。</p>
<p>装饰器：</p>
<p>利用apply()，我们还可以动态改变函数的行为。</p>
<p>JavaScript的所有对象都是动态的，即使内置的函数，我们也可以重新指向新的函数。</p>
<p>现在假定我们想统计一下代码一共调用了多少次parseInt()，可以把所有的调用都找出来，然后手动加上count +&#x3D; 1，不过这样做太傻了。最佳方案是用我们自己的函数替换掉默认的parseInt()：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> count = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> oldParseInt = <span class="built_in">parseInt</span>; <span class="comment">// 保存原函数</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">parseInt</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    count += <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> oldParseInt.<span class="title function_">apply</span>(<span class="literal">null</span>, <span class="variable language_">arguments</span>); <span class="comment">// 调用原函数</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试:</span></span><br><span class="line"><span class="built_in">parseInt</span>(<span class="string">&#x27;10&#x27;</span>);</span><br><span class="line"><span class="built_in">parseInt</span>(<span class="string">&#x27;20&#x27;</span>);</span><br><span class="line"><span class="built_in">parseInt</span>(<span class="string">&#x27;30&#x27;</span>);</span><br><span class="line">count; <span class="comment">// 3</span></span><br></pre></td></tr></table></figure>
<p>另一个需要注意的问题是，返回的函数并没有立刻执行，而是直到调用了f()才执行。我们来看一个例子：</p>
<p>返回闭包时牢记的一点就是：返回函数不要引用任何循环变量，或者后续会发生变化的变量。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">闭包（closure）是<span class="title class_">Javascript</span>语言的一个难点，也是它的特色，很多高级应用都要依靠闭包实现。</span><br><span class="line">下面就是我的学习笔记，对于<span class="title class_">Javascript</span>初学者应该是很有用的。</span><br><span class="line">一、变量的作用域</span><br><span class="line">要理解闭包，首先必须理解<span class="title class_">Javascript</span>特殊的变量作用域。</span><br><span class="line">变量的作用域无非就是两种：全局变量和局部变量。</span><br><span class="line"><span class="title class_">Javascript</span>语言的特殊之处，就在于函数内部可以直接读取全局变量。</span><br><span class="line">　　<span class="keyword">var</span> n=<span class="number">999</span>;</span><br><span class="line">　　<span class="keyword">function</span> <span class="title function_">f1</span>(<span class="params"></span>)&#123;</span><br><span class="line">　　　　<span class="title function_">alert</span>(n);</span><br><span class="line">　　&#125;</span><br><span class="line">　　<span class="title function_">f1</span>(); <span class="comment">// 999</span></span><br><span class="line">另一方面，在函数外部自然无法读取函数内的局部变量。</span><br><span class="line">　　<span class="keyword">function</span> <span class="title function_">f1</span>(<span class="params"></span>)&#123;</span><br><span class="line">　　　　<span class="keyword">var</span> n=<span class="number">999</span>;</span><br><span class="line">　　&#125;</span><br><span class="line">　　<span class="title function_">alert</span>(n); <span class="comment">// error</span></span><br><span class="line">这里有一个地方需要注意，函数内部声明变量的时候，一定要使用<span class="keyword">var</span>命令。如果不用的话，你实际上声明了一个全局变量！</span><br><span class="line">　　<span class="keyword">function</span> <span class="title function_">f1</span>(<span class="params"></span>)&#123;</span><br><span class="line">　　　　n=<span class="number">999</span>;</span><br><span class="line">　　&#125;</span><br><span class="line">　　<span class="title function_">f1</span>();</span><br><span class="line">　　<span class="title function_">alert</span>(n); <span class="comment">// 999</span></span><br><span class="line">二、如何从外部读取局部变量？</span><br><span class="line">出于种种原因，我们有时候需要得到函数内的局部变量。但是，前面已经说过了，正常情况下，这是办不到的，只有通过变通方法才能实现。</span><br><span class="line">那就是在函数的内部，再定义一个函数。</span><br><span class="line">　　<span class="keyword">function</span> <span class="title function_">f1</span>(<span class="params"></span>)&#123;</span><br><span class="line">　　　　<span class="keyword">var</span> n=<span class="number">999</span>;</span><br><span class="line">　　　　<span class="keyword">function</span> <span class="title function_">f2</span>(<span class="params"></span>)&#123;</span><br><span class="line">　　　　　　<span class="title function_">alert</span>(n); <span class="comment">// 999</span></span><br><span class="line">　　　　&#125;</span><br><span class="line">　　&#125;</span><br><span class="line">在上面的代码中，函数f2就被包括在函数f1内部，这时f1内部的所有局部变量，对f2都是可见的。但是反过来就不行，f2内部的局部变量，</span><br><span class="line">对f1就是不可见的。这就是<span class="title class_">Javascript</span>语言特有的<span class="string">&quot;链式作用域&quot;</span>结构（chain scope），子对象会 <span class="string">&quot;一级一级&quot;</span> 地向上寻找所有父对象的变量。</span><br><span class="line">所以，父对象的所有变量，对子对象都是可见的，反之则不成立。</span><br><span class="line">既然f2可以读取f1中的局部变量，那么只要把f2作为返回值，我们不就可以在f1外部读取它的内部变量了吗！</span><br><span class="line">　　<span class="keyword">function</span> <span class="title function_">f1</span>(<span class="params"></span>)&#123;</span><br><span class="line">　　　　<span class="keyword">var</span> n=<span class="number">999</span>;</span><br><span class="line">　　　　<span class="keyword">function</span> <span class="title function_">f2</span>(<span class="params"></span>)&#123;</span><br><span class="line">　　　　　　<span class="title function_">alert</span>(n); </span><br><span class="line">　　　　&#125;</span><br><span class="line">　　　　<span class="keyword">return</span> f2;</span><br><span class="line">　　&#125;</span><br><span class="line">　　<span class="keyword">var</span> result=<span class="title function_">f1</span>();</span><br><span class="line">　　<span class="title function_">result</span>(); <span class="comment">// 999</span></span><br><span class="line">三、闭包的概念</span><br><span class="line">上一节代码中的f2函数，就是闭包。</span><br><span class="line">各种专业文献上的<span class="string">&quot;闭包&quot;</span>（closure）定义非常抽象，很难看懂。我的理解是，闭包就是能够读取其他函数内部变量的函数。</span><br><span class="line">由于在<span class="title class_">Javascript</span>语言中，只有函数内部的子函数才能读取局部变量，因此可以把闭包简单理解成<span class="string">&quot;定义在一个函数内部的函数&quot;</span>。</span><br><span class="line">所以，在本质上，闭包就是将函数内部和函数外部连接起来的一座桥梁。</span><br><span class="line">四、闭包的用途</span><br><span class="line">闭包可以用在许多地方。它的最大用处有两个，一个是前面提到的可以读取函数内部的变量，另一个就是让这些变量的值始终保持在内存中。</span><br><span class="line">怎么来理解这句话呢？请看下面的代码。</span><br><span class="line">　　<span class="keyword">function</span> <span class="title function_">f1</span>(<span class="params"></span>)&#123;</span><br><span class="line">　　　　<span class="keyword">var</span> n=<span class="number">999</span>;</span><br><span class="line">　　　　nAdd=<span class="keyword">function</span>(<span class="params"></span>)&#123;n+=<span class="number">1</span>&#125;</span><br><span class="line">　　　　<span class="keyword">function</span> <span class="title function_">f2</span>(<span class="params"></span>)&#123;</span><br><span class="line">　　　　　　<span class="title function_">alert</span>(n);</span><br><span class="line">　　　　&#125;</span><br><span class="line">　　　　<span class="keyword">return</span> f2;</span><br><span class="line">　　&#125;</span><br><span class="line">　　<span class="keyword">var</span> result=<span class="title function_">f1</span>();</span><br><span class="line">　　<span class="title function_">result</span>(); <span class="comment">// 999</span></span><br><span class="line">　　<span class="title function_">nAdd</span>();</span><br><span class="line">　　<span class="title function_">result</span>(); <span class="comment">// 1000</span></span><br><span class="line">在这段代码中，result实际上就是闭包f2函数。它一共运行了两次，第一次的值是<span class="number">999</span>，第二次的值是<span class="number">1000</span>。</span><br><span class="line">这证明了，函数f1中的局部变量n一直保存在内存中，并没有在f1调用后被自动清除。</span><br><span class="line">为什么会这样呢？原因就在于f1是f2的父函数，而f2被赋给了一个全局变量，这导致f2始终在内存中，而f2的存在依赖于f1，</span><br><span class="line">因此f1也始终在内存中，不会在调用结束后，被垃圾回收机制（garbage collection）回收。</span><br><span class="line">这段代码中另一个值得注意的地方，就是<span class="string">&quot;nAdd=function()&#123;n+=1&#125;&quot;</span>这一行，首先在nAdd前面没有使用<span class="keyword">var</span>关键字，因此nAdd是一个全局变量，而不是局部变量。</span><br><span class="line">其次，nAdd的值是一个匿名函数（anonymous <span class="keyword">function</span>），而这个匿名函数本身也是一个闭包，</span><br><span class="line">所以nAdd相当于是一个setter，可以在函数外部对函数内部的局部变量进行操作。</span><br><span class="line">五、使用闭包的注意点</span><br><span class="line"><span class="number">1</span>）由于闭包会使得函数中的变量都被保存在内存中，内存消耗很大，所以不能滥用闭包，否则会造成网页的性能问题，在<span class="variable constant_">IE</span>中可能导致内存泄露。</span><br><span class="line">解决方法是，在退出函数之前，将不使用的局部变量全部删除。</span><br><span class="line"><span class="number">2</span>）闭包会在父函数外部，改变父函数内部变量的值。所以，如果你把父函数当作对象（object）使用，把闭包当作它的公用方法（<span class="title class_">Public</span> <span class="title class_">Method</span>），</span><br><span class="line">把内部变量当作它的私有属性（private value），这时一定要小心，不要随便改变父函数内部变量的值。</span><br><span class="line">六、思考题</span><br><span class="line">如果你能理解下面两段代码的运行结果，应该就算理解闭包的运行机制了。</span><br><span class="line">代码片段一。</span><br><span class="line">　　<span class="keyword">var</span> name = <span class="string">&quot;The Window&quot;</span>;</span><br><span class="line">　　<span class="keyword">var</span> object = &#123;</span><br><span class="line">　　　　name : <span class="string">&quot;My Object&quot;</span>,</span><br><span class="line">　　　　getNameFunc : <span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="comment">//alert(this.name);//My Object</span></span><br><span class="line">　　　　　　<span class="keyword">return</span> <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">　　　　　　　　<span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">name</span>;<span class="comment">// 空</span></span><br><span class="line">　　　　　　&#125;;</span><br><span class="line">　　　　&#125;</span><br><span class="line">　　&#125;;</span><br><span class="line">        <span class="title function_">alert</span>(<span class="variable language_">this</span>.<span class="property">name</span>);<span class="comment">// The Window</span></span><br><span class="line">　　<span class="title function_">alert</span>(object.<span class="title function_">getNameFunc</span>()()); <span class="comment">// 空</span></span><br><span class="line"> </span><br><span class="line">代码片段二。</span><br><span class="line">　　<span class="keyword">var</span> name = <span class="string">&quot;The Window&quot;</span>;</span><br><span class="line">　　<span class="keyword">var</span> object = &#123;</span><br><span class="line">　　　　name : <span class="string">&quot;My Object&quot;</span>,</span><br><span class="line">　　　　getNameFunc : <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">　　　　　　<span class="keyword">var</span> that = <span class="variable language_">this</span>;</span><br><span class="line">　　　　　　<span class="keyword">return</span> <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">　　　　　　　　<span class="keyword">return</span> that.<span class="property">name</span>;</span><br><span class="line">　　　　　　&#125;;</span><br><span class="line">　　　　&#125;</span><br><span class="line">　　&#125;;</span><br><span class="line">　　<span class="title function_">alert</span>(object.<span class="title function_">getNameFunc</span>()()); <span class="comment">// My Object</span></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">一层访问一层，不能跨层访问</span><br></pre></td></tr></table></figure>
<p>箭头函数： 用箭头定义函数……..</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">var</span> fun = x=&gt;x*x</span><br><span class="line"><span class="function"><span class="title">alert</span><span class="params">(fun(<span class="number">2</span>)</span></span>)            <span class="comment">//单参数</span></span><br><span class="line"><span class="selector-tag">var</span> fun1 = ()=&gt;<span class="number">2</span></span><br><span class="line"><span class="function"><span class="title">alert</span><span class="params">(fun1()</span></span>)        <span class="comment">//无参数</span></span><br><span class="line"><span class="selector-tag">var</span> fun2 = (x,y)=&gt;x+y</span><br><span class="line"><span class="function"><span class="title">alert</span><span class="params">(fun2(<span class="number">1</span>,<span class="number">2</span>)</span></span>)        <span class="comment">//双参数</span></span><br><span class="line"><span class="selector-tag">var</span> fun3 = ()=&gt;(&#123;<span class="selector-tag">a</span>:<span class="number">12</span>&#125;)</span><br><span class="line"><span class="function"><span class="title">alert</span><span class="params">(fun3()</span></span>.a)          <span class="comment">//返回值是对象（要加括号）</span></span><br></pre></td></tr></table></figure>
<p>箭头函数有两种格式，一种像上面的，只包含一个表达式，连{ … }和return都省略掉了。还有一种可以包含多条语句，这时候就不能省略{ … }和return：<br>箭头函数和匿名函数一个明显的区别是this指针。箭头函数中的this指针由上下文决定。</p>
<p>在函数中定义函数<br>将函数作为参数<br>将函数作为返回值</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/JavaScript%E7%90%86%E8%AE%BA/">JavaScript理论</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/JavaScript/">JavaScript</a>
  </div>

</div>



<div class="comments-count">
	
	  	<span></span>
		<a href="/2017/01/17/JavaScript-查缺补漏清单/#comments" class="ds-thread-count comments-count-link" data-thread-key="2017/01/17/JavaScript-查缺补漏清单/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/10/30/Android-开源项目学习之Retrofit2-0使用篇/" title="Android 开源项目学习之Retrofit2.0使用篇" itemprop="url">Android 开源项目学习之Retrofit2.0使用篇</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Edgar" target="_blank" itemprop="author">Edgar</a>
		
  <p class="article-time">
    <time datetime="2016-10-30T15:12:30.000Z" itemprop="datePublished"> Published 2016-10-30</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ol start="0">
<li>引入Retrofit 相关的库<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">compile</span> &#x27;io.reactivex:rxjava:<span class="number">1</span>.<span class="number">1</span>.<span class="number">0</span>&#x27;      //RxJava 相关</span><br><span class="line"><span class="attribute">compile</span> &#x27;io.reactivex:rxandroid:<span class="number">1</span>.<span class="number">1</span>.<span class="number">0</span>&#x27;   //RxJava 相关</span><br><span class="line"><span class="attribute">compile</span> &#x27;com.squareup.retrofit2:adapter-rxjava:<span class="number">2</span>.<span class="number">0</span>.<span class="number">0</span>-beta4&#x27;  //Retrofit Rxjava Adapter</span><br><span class="line"><span class="attribute">compile</span> &#x27;com.squareup.retrofit2:retrofit:<span class="number">2</span>.<span class="number">0</span>.<span class="number">0</span>-beta4&#x27;        //Retrofit </span><br><span class="line"><span class="attribute">compile</span> &#x27;com.squareup.retrofit2:converter-gson:<span class="number">2</span>.<span class="number">0</span>.<span class="number">0</span>-beta4&#x27;  //Gson Adapter</span><br><span class="line"><span class="attribute">compile</span> &#x27;com.google.code.gson:gson:<span class="number">2</span>.<span class="number">6</span>.<span class="number">2</span>&#x27;                    //Gson</span><br></pre></td></tr></table></figure></li>
<li>定义 Api 接口<br>一个Service是一个接口如下所示，它一般指定了http方式是一个get还是post方式，以及一个相对的路径。<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">public</span> <span class="selector-tag">interface</span> <span class="selector-tag">OpenWeatherApi</span> &#123;</span><br><span class="line">    <span class="variable">@GET</span>(<span class="string">&quot;weather&quot;</span>)</span><br><span class="line">    Call&lt;WeatherResult&gt; getCityWeather(<span class="variable">@Query</span>(<span class="string">&quot;id&quot;</span>) String id,<span class="variable">@Query</span>(<span class="string">&quot;appid&quot;</span>) String ApiId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>使用注释来创建url<br>这个方面请大家看下这篇博客，个人认为总结得十分全面，所以就直接转过来了：<br><a target="_blank" rel="noopener" href="http://blog.csdn.net/stven_king/article/details/52372172">http://blog.csdn.net/stven_king/article/details/52372172</a><br>最常使用的请求方式：<br>@GET @POST<br>请求url相关的注释：<br>@Query，@QueryMap，@Field，@FieldMap，@FormUrlEncoded，@Path，@Url</li>
</ol>
<p>( 1 ) GET 请求方式：</p>
<figure class="highlight autoit"><table><tr><td class="code"><pre><span class="line">public interface GitHubService &#123;//无参数<span class="symbol">@GET</span>(<span class="string">&quot;users/stven0king/repos&quot;</span>)</span><br><span class="line">    <span class="built_in">Call</span>&lt;List&lt;Repo&gt;&gt; listRepos()<span class="comment">;</span></span><br><span class="line">    //少数参数<span class="symbol">@GET</span>(<span class="string">&quot;users/stven0king/repos&quot;</span>)</span><br><span class="line">    <span class="built_in">Call</span>&lt;List&lt;Repo&gt;&gt; listRepos(<span class="symbol">@Query</span>(<span class="string">&quot;time&quot;</span>) long time)<span class="comment">;</span></span><br><span class="line">    //参数较多<span class="symbol">@GET</span>(<span class="string">&quot;users/stven0king/repos&quot;</span>)</span><br><span class="line">    <span class="built_in">Call</span>&lt;List&lt;Repo&gt;&gt; listRepos(<span class="symbol">@QueryMap</span> Map&lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt; params)<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>( 2 ) POST 请求方式：</p>
<figure class="highlight autoit"><table><tr><td class="code"><pre><span class="line">public interface GitHubService &#123;//无参数<span class="symbol">@POST</span>(<span class="string">&quot;users/stven0king/repos&quot;</span>)</span><br><span class="line">    <span class="built_in">Call</span>&lt;List&lt;Repo&gt;&gt; listRepos()<span class="comment">;</span></span><br><span class="line">    //少数参数<span class="symbol">@FormUrlEncoded</span><span class="symbol">@POST</span>(<span class="string">&quot;users/stven0king/repos&quot;</span>)</span><br><span class="line">    <span class="built_in">Call</span>&lt;List&lt;Repo&gt;&gt; listRepos(<span class="symbol">@Field</span>(<span class="string">&quot;time&quot;</span>) long time)<span class="comment">;</span></span><br><span class="line">    //参数较多<span class="symbol">@FormUrlEncoded</span><span class="symbol">@POST</span>(<span class="string">&quot;users/stven0king/repos&quot;</span>)</span><br><span class="line">    <span class="built_in">Call</span>&lt;List&lt;Repo&gt;&gt; listRepos(<span class="symbol">@FieldMap</span> Map&lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt; params)<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>@POST @GET多了一个@FromUrlEncoded的注解。如果去掉@FromUrlEncoded在post请求中使用@Field和@FieldMap，那么程序会抛出Java.lang.IllegalArgumentException: @Field parameters can only be used with form encoding. (parameter #1)的错误异常。</p>
<p>( 3 ) 半静态的url 地址请求：</p>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">public</span> <span class="selector-tag">interface</span> <span class="selector-tag">GitHubService</span> &#123;<span class="variable">@GET</span>(<span class="string">&quot;users/&#123;user&#125;/repos&quot;</span>)</span><br><span class="line">  Call&lt;List&lt;Repo&gt;&gt; listRepos(<span class="variable">@Path</span>(<span class="string">&quot;user&quot;</span>) String user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>( 4 ) 动态的url地址请求：</p>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">public</span> <span class="selector-tag">interface</span> <span class="selector-tag">GitHubService</span> &#123;<span class="variable">@GET</span></span><br><span class="line">  Call&lt;List&lt;Repo&gt;&gt; listRepos(<span class="variable">@Url</span> String user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>创建retrofit对象<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">Retrofit retrofit = <span class="keyword">new</span> Retrofit.<span class="constructor">Builder()</span></span><br><span class="line">        .base<span class="constructor">Url(<span class="string">&quot;http://api.openweathermap.org/data/2.5/&quot;</span>)</span></span><br><span class="line">        .add<span class="constructor">ConverterFactory(GsonConverterFactory.<span class="params">create</span>()</span>)</span><br><span class="line">        .build<span class="literal">()</span>;</span><br></pre></td></tr></table></figure>
在Retrofit 2.0中，需要我们自己引入Converter 不然的话Retrofit 只能接收字符串结果，下面是retrofit 支持的json converter<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">Gson: com<span class="selector-class">.squareup</span><span class="selector-class">.retrofit</span>:converter-gson</span><br><span class="line">Jackson: com<span class="selector-class">.squareup</span><span class="selector-class">.retrofit</span>:converter-jackson</span><br><span class="line">Moshi: com<span class="selector-class">.squareup</span><span class="selector-class">.retrofit</span>:converter-moshi</span><br><span class="line">Protobuf: com<span class="selector-class">.squareup</span><span class="selector-class">.retrofit</span>:converter-protobuf</span><br><span class="line">Wire: com<span class="selector-class">.squareup</span><span class="selector-class">.retrofit</span>:converter-wire</span><br><span class="line">Simple XML: com<span class="selector-class">.squareup</span><span class="selector-class">.retrofit</span>:converter-simplexml</span><br></pre></td></tr></table></figure></li>
<li>使用retrofit对象来创建对应的API接口：<figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">OpenWeatherApi mWeatherService <span class="operator">=</span> retrofit.create(OpenWeatherApi.class)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
5.使用上面创建的API接口来访问对应的服务：<br>（这里为了安全所以我这边用了一个伪appid，大家可以自己申请然后替换）<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">Call</span>&lt;WeatherResult&gt; resultCall = mWeatherService.getCityWeather(&quot;1790437&quot;,&quot;f8ddddd63c40c0bcb89&quot;);</span><br><span class="line">resultCall.enqueue(<span class="built_in">new</span> Callback&lt;WeatherResult&gt;() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    <span class="built_in">public</span> <span class="type">void</span> onResponse(<span class="keyword">Call</span>&lt;WeatherResult&gt; <span class="keyword">call</span>, Response&lt;WeatherResult&gt; response) &#123;</span><br><span class="line">        <span class="keyword">if</span>(response.body() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">Log</span>.i(&quot;xiaohai.lin&quot;,&quot;Request Failed Response Code = &quot;+ response.code());</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">Log</span>.i(&quot;xiaohai.lin&quot;,&quot;Templete = &quot;+response.body().getMain().getTemp());</span><br><span class="line">        <span class="keyword">Log</span>.i(&quot;xiaohai.lin&quot;,&quot;getDescription = &quot;+response.body().getWeather().<span class="keyword">get</span>(<span class="number">0</span>).getDescription());</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    <span class="built_in">public</span> <span class="type">void</span> onFailure(<span class="keyword">Call</span>&lt;WeatherResult&gt; <span class="keyword">call</span>, Throwable t) &#123;&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li>
<li>异步请求<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">resultCall.enqueue(<span class="built_in">new</span> Callback&lt;WeatherResult&gt;() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    <span class="built_in">public</span> <span class="type">void</span> onResponse(<span class="keyword">Call</span>&lt;WeatherResult&gt; <span class="keyword">call</span>, Response&lt;WeatherResult&gt; response) &#123;</span><br><span class="line">        <span class="keyword">if</span>(response.body() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">Log</span>.i(&quot;xiaohai.lin&quot;,&quot;Request Failed Response Code = &quot;+ response.code());</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">Log</span>.i(&quot;xiaohai.lin&quot;,&quot;Templete = &quot;+response.body().getMain().getTemp());</span><br><span class="line">        <span class="keyword">Log</span>.i(&quot;xiaohai.lin&quot;,&quot;getDescription = &quot;+response.body().getWeather().<span class="keyword">get</span>(<span class="number">0</span>).getDescription());</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    <span class="built_in">public</span> <span class="type">void</span> onFailure(<span class="keyword">Call</span>&lt;WeatherResult&gt; <span class="keyword">call</span>, Throwable t) &#123;&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
以上代码发起了一个在后台线程的请求并从response 的response.body()方法中获取一个结果对象。这里onResponse和onFailure方法是在主线程中调用的。</li>
<li>同步请求<br>同步请求需要调用execute方法，但是由于同步方式会阻塞线程所以不能在主线程中调用。否则会遇到NetworkOnMainThreadException异常。<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">new</span> AsyncTask&lt;String, Integer, Response&lt;WeatherResult&gt;&gt;()&#123;</span><br><span class="line">    @Override</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Response&lt;WeatherResult&gt; <span class="title">doInBackground</span>(<span class="params">String... <span class="keyword">params</span></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">params</span> == <span class="literal">null</span>|| <span class="keyword">params</span>[<span class="number">0</span>] == <span class="literal">null</span>||<span class="keyword">params</span>[<span class="number">1</span>]== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</span><br><span class="line">                .baseUrl(<span class="string">&quot;http://api.openweathermap.org/data/2.5/&quot;</span>)</span><br><span class="line">                .addConverterFactory(GsonConverterFactory.create())</span><br><span class="line">                .build();</span><br><span class="line">        OpenWeatherApi mWeatherService = retrofit.create(OpenWeatherApi.<span class="keyword">class</span>);</span><br><span class="line">        final Call&lt;WeatherResult&gt; resultCall = mWeatherService.getCityWeather(<span class="keyword">params</span>[<span class="number">0</span>],<span class="keyword">params</span>[<span class="number">1</span>]);</span><br><span class="line">        Response&lt;WeatherResult&gt; result = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            result = resultCall.execute();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostExecute</span>(<span class="params">Response&lt;WeatherResult&gt; response</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(response == <span class="literal">null</span> || response.body() == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Log.i(<span class="string">&quot;xiaohai.lin&quot;</span>,<span class="string">&quot;Templete = &quot;</span>+response.body().getMain().getTemp());</span><br><span class="line">        Log.i(<span class="string">&quot;xiaohai.lin&quot;</span>,<span class="string">&quot;getDescription = &quot;</span>+response.body().getWeather().<span class="keyword">get</span>(<span class="number">0</span>).getDescription());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;.execute(<span class="string">&quot;1790437&quot;</span>,<span class="string">&quot;f8ddddcb89&quot;</span>);</span><br></pre></td></tr></table></figure>
8 取消正在进行中访问<figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">call.cancel()<span class="comment">;</span></span><br></pre></td></tr></table></figure>
9 获取结果的处理</li>
</ol>
<p>在Retrofit 1.9中，如果获取的 response 不能被解析成定义好的对象，则会调用failure。但是在Retrofit 2.0中，不管 response 是否能被解析。onResponse总是会被调用。但是在结果不能被解析的情况下，response.body()会返回null。</p>
<p>如果response存在什么问题，onResponse也会被调用。我们可以从response.errorBody().string()中获取错误信息的主体。</p>
<p>10 Retrofix 结合 Rxjava</p>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">public</span> <span class="selector-tag">interface</span> <span class="selector-tag">OpenWeatherApis</span> &#123;</span><br><span class="line">    <span class="variable">@GET</span>(<span class="string">&quot;weather&quot;</span>)</span><br><span class="line">    Observable&lt;WeatherResult&gt; getCityWeather(<span class="variable">@Query</span>(<span class="string">&quot;id&quot;</span>) String id, <span class="variable">@Query</span>(<span class="string">&quot;appid&quot;</span>) String ApiId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">Retrofit retrofit = <span class="keyword">new</span> Retrofit.<span class="constructor">Builder()</span></span><br><span class="line">        .base<span class="constructor">Url(<span class="string">&quot;http://api.openweathermap.org/data/2.5/&quot;</span>)</span></span><br><span class="line">        .add<span class="constructor">ConverterFactory(GsonConverterFactory.<span class="params">create</span>()</span>)</span><br><span class="line">        .add<span class="constructor">CallAdapterFactory(RxJavaCallAdapterFactory.<span class="params">create</span>()</span>)</span><br><span class="line">        .build<span class="literal">()</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">OpenWeatherApis openWeatherApis = retrofit.create(<span class="module-access"><span class="module"><span class="identifier">OpenWeatherApis</span>.</span></span><span class="keyword">class</span>);</span><br><span class="line">Observable&lt;WeatherResult&gt; result = openWeatherApis.get<span class="constructor">CityWeather(<span class="string">&quot;1790437&quot;</span>,<span class="string">&quot;f8d8edded5c40c0bcbdd89&quot;</span>)</span>;</span><br><span class="line">result.observe<span class="constructor">On(AndroidSchedulers.<span class="params">mainThread</span>()</span>)</span><br><span class="line">        .subscribe<span class="constructor">On(Schedulers.<span class="params">io</span>()</span>)</span><br><span class="line">        .subscribe(<span class="keyword">new</span> Action1&lt;WeatherResult&gt;<span class="literal">()</span> &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void call(WeatherResult weatherResult) &#123;</span><br><span class="line">                <span class="module-access"><span class="module"><span class="identifier">Log</span>.</span></span>i(<span class="string">&quot;xiaohai.lin&quot;</span>,<span class="string">&quot;Templete = &quot;</span>+weatherResult.get<span class="constructor">Main()</span>.get<span class="constructor">Temp()</span>);</span><br><span class="line">                <span class="module-access"><span class="module"><span class="identifier">Log</span>.</span></span>i(<span class="string">&quot;xiaohai.lin&quot;</span>,<span class="string">&quot;getDescription = &quot;</span>+weatherResult.get<span class="constructor">Weather()</span>.get(<span class="number">0</span>).get<span class="constructor">Description()</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<p>11 添加log支持</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">HttpLoggingInterceptor httpLoggingInterceptor = <span class="keyword">new</span> <span class="constructor">HttpLoggingInterceptor()</span>;</span><br><span class="line">httpLoggingInterceptor.set<span class="constructor">Level(HttpLoggingInterceptor.Level.BODY)</span>;</span><br><span class="line">OkHttpClient okHttpClient = <span class="keyword">new</span> OkHttpClient.<span class="constructor">Builder()</span></span><br><span class="line">        .add<span class="constructor">Interceptor(<span class="params">httpLoggingInterceptor</span>)</span></span><br><span class="line">        .build<span class="literal">()</span>;</span><br><span class="line"></span><br><span class="line">Retrofit retrofit = <span class="keyword">new</span> Retrofit.<span class="constructor">Builder()</span></span><br><span class="line">        .base<span class="constructor">Url(<span class="string">&quot;http://api.openweathermap.org/data/2.5/&quot;</span>)</span></span><br><span class="line">        .add<span class="constructor">ConverterFactory(GsonConverterFactory.<span class="params">create</span>()</span>)</span><br><span class="line">        .client(okHttpClient)</span><br><span class="line">        .build<span class="literal">()</span>;</span><br><span class="line">OpenWeatherApi mWeatherService = retrofit.create(<span class="module-access"><span class="module"><span class="identifier">OpenWeatherApi</span>.</span></span><span class="keyword">class</span>);</span><br><span class="line">final Call&lt;WeatherResult&gt; resultCall = mWeatherService.get<span class="constructor">CityWeather(<span class="string">&quot;1790437&quot;</span>,<span class="string">&quot;f8d8ead8299f963abcded5c40c0bcb89&quot;</span>)</span>;</span><br><span class="line">resultCall.enqueue(<span class="keyword">new</span> Callback&lt;WeatherResult&gt;<span class="literal">()</span> &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void on<span class="constructor">Response(Call&lt;WeatherResult&gt; <span class="params">call</span>, Response&lt;WeatherResult&gt; <span class="params">response</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(response.body<span class="literal">()</span><span class="operator"> == </span>null) &#123;</span><br><span class="line">            <span class="module-access"><span class="module"><span class="identifier">Log</span>.</span></span>i(<span class="string">&quot;xiaohai.lin&quot;</span>,<span class="string">&quot;Request Failed Response Code = &quot;</span>+ response.code<span class="literal">()</span>);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">Log</span>.</span></span>i(<span class="string">&quot;xiaohai.lin&quot;</span>,<span class="string">&quot;Templete = &quot;</span>+response.body<span class="literal">()</span>.get<span class="constructor">Main()</span>.get<span class="constructor">Temp()</span>);</span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">Log</span>.</span></span>i(<span class="string">&quot;xiaohai.lin&quot;</span>,<span class="string">&quot;getDescription = &quot;</span>+response.body<span class="literal">()</span>.get<span class="constructor">Weather()</span>.get(<span class="number">0</span>).get<span class="constructor">Description()</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void on<span class="constructor">Failure(Call&lt;WeatherResult&gt; <span class="params">call</span>, Throwable <span class="params">t</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>11 Retrofix 结合 Realm:</p>
<p>Realm 是我个人的喜好，是用得最爽的一个nosql类型的数据库，没有之一。<br>Realm 可以与 Retrofit 1.x 和 2.x 无缝配合工作。但注意 Retrofit 不会自动将对象存入 Realm。<br>需要通过调用 Realm.copyToRealm() 或 Realm.copyToRealmOrUpdate() 来将它们存入 Realm。</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">realm.<span class="keyword">begin</span><span class="constructor">Transaction()</span>;</span><br><span class="line">WeatherResult realmWhether = realm.copy<span class="constructor">ToRealmOrUpdate(<span class="params">result</span>)</span>;</span><br><span class="line">realm.commit<span class="constructor">Transaction()</span>;</span><br></pre></td></tr></table></figure>
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">Android 源码分析</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Android-开源源码/">Android 开源源码</a>
  </div>

</div>



<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/10/30/Android-开源项目学习之Retrofit2-0使用篇/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/10/30/Android-开源项目学习之Retrofit2-0使用篇/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/10/30/Android-开源框架源码分析一-picasso/" title="Android 开源框架源码分析之picasso" itemprop="url">Android 开源框架源码分析之picasso</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Edgar" target="_blank" itemprop="author">Edgar</a>
		
  <p class="article-time">
    <time datetime="2016-10-30T14:24:18.000Z" itemprop="datePublished"> Published 2016-10-30</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>今天开始我将对目前较为流行的开源库以及开源框架的源码进行分析，希望能够通过学习这些源码背后的设计思想，从而让自己的编程和设计能力有所提高。<br>废话不多说，切入正题。今天给大家介绍的picasso是一个图片缓存库，想必很多人对他都很熟悉了，它支持三级缓存，它的使用极为简单，同时也支持十分灵活的配置方式。大家可以通过如下地址下载到源码 <a target="_blank" rel="noopener" href="http://square.github.io/picasso/">http://square.github.io/picasso/</a></p>
<ol>
<li>分析情景介绍</li>
</ol>
<p>我们以一个最简单的使用情景来对源码进行分析：</p>
<figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line">Picasso.with<span class="params">(context)</span><span class="string">.load</span><span class="params">(&quot;http://image.baidu.com/search/detail?<span class="attr">z</span>=0&amp;<span class="attr">ipn</span>=&quot;)</span><span class="string">.into</span><span class="params">(imageView)</span>;</span><br></pre></td></tr></table></figure>

<p>上面的代码是执行从网络上加载地址为<a target="_blank" rel="noopener" href="http://image.baidu.com/search/detail?z=0&amp;ipn=">http://image.baidu.com/search/detail?z=0&amp;ipn=</a> 的图片到指定的imageView控件中。</p>
<ol start="2">
<li>代码组织结构介绍</li>
</ol>
<p>在分析源码之前我们先看下整个开源库的代码组织，但是大家如果将代码下载到本地后会感到失望，因为个人认为picasso的代码组织是极为不规范的，整个源码只有一个package。下面是我根据自己的理解将其源码进行重新的组织。总共分成5个包，</p>
<p><img src="/2016/10/30/Android-%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%80-picasso/1.png"></p>
<ul>
<li>action包包含有：Action抽象类，FetchAction，GetAction，ImageViewAction，RemoteViewsAction，Target，TargetAction。</li>
<li>requst包中包含的是：Request，RequestCreator，DeferredRequestCreator</li>
<li>requesthandler包中包含的是：AssetRequestHandler，ContactsPhotoRequestHandler，ContentStreamRequestHandler，FileRequestHandler，MediaStoreRequestHandler，NetworkRequestHandler，ResourceRequestHandler，RequestHandler</li>
<li>core包中包含有如下几个文件：</li>
</ul>
<p><img src="/2016/10/30/Android-%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%80-picasso/2.png"></p>
<p>为什么这样分包大家可以在源码分析完后对整个流程以及每个类对职责有较为深入了解后进行思考。</p>
<p>3 .详细流程介绍</p>
<p>3.1 with  流程解析：<br>with阶段的主要任务是创建全局默认的Picasso实例，所创建的实例一般来说能够适合于绝大多数应用场景，如果不满足可以自己通过Builder来创建，也可以通过setSingletonInstance来注入我们自己创建的Picasso，但是这个方法需要在with方法前调用，因为这里创建picasso使用对是单例模式。</p>
<p>picasso默认对配置如下：<br>(1) 缓存使用LRU 缓存方式，缓存大小占用应用可用存储的15% RAM<br>(2) 硬盘缓存空间占用手机存储的2%，并且大小不小于5M，最大50MB。<br>(3) 具有3个线程用于磁盘和网络访问<br>(4) 缓存位于应用目录下对picasso-cache目录。</p>
<p>我们看下它是如何完成这部分的工作的，首先它使用建造者模式结合单例来创建picasso对象，之所以采用建造者模式是因为这种模式能够给配置参数多的对象的构建带来很大的方便。</p>
<figure class="highlight d"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Picasso <span class="keyword">with</span>(<span class="keyword">@NonNull</span> Context context) &#123;</span><br><span class="line">  <span class="keyword">if</span> (context == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;context == null&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (singleton == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (Picasso.<span class="keyword">class</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (singleton == <span class="literal">null</span>) &#123;</span><br><span class="line">        singleton = <span class="keyword">new</span> Builder(context).build();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> singleton;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们能从Builder对象中获取到什么信息呢？一般一个对象的Builder是用于向外面暴露设置内部组件的接口（此接口非彼接口），通过暴露的接口来注入我们自定义的对象。Picasso 的 Builder也是一样的。通过它我们可以注入自定义的下载器，线程池，缓存，请求转换器，请求处理器，内部事件监听。它还有一个builder方法，它的用处就是在全部设置后，检查重要的组件是否有设置了，如果没有设置，那么就创建初始化组件来使用。</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> static <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Context context;                <span class="comment">//上下文</span></span><br><span class="line">  <span class="keyword">private</span> Downloader downloader;                <span class="comment">//自定义的下载器</span></span><br><span class="line">  <span class="keyword">private</span> ExecutorService service;              <span class="comment">//自定义的线程池</span></span><br><span class="line">  <span class="keyword">private</span> Cache cache;                          <span class="comment">//自定义的缓存</span></span><br><span class="line">  <span class="keyword">private</span> Listener listener;                    <span class="comment">//监听器</span></span><br><span class="line">  <span class="keyword">private</span> RequestTransformer transformer;       <span class="comment">//请求转换器</span></span><br><span class="line">  <span class="keyword">private</span> List&lt;RequestHandler&gt; requestHandlers; <span class="comment">//请求处理器</span></span><br><span class="line">  <span class="keyword">private</span> Bitmap.Config defaultBitmapConfig;    <span class="comment">//图像配置</span></span><br><span class="line">  <span class="keyword">private</span> boolean indicatorsEnabled;            <span class="comment">//是否显示指示标志</span></span><br><span class="line">  <span class="keyword">private</span> boolean loggingEnabled;               <span class="comment">//是否开启Log</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**Builder构造方法*/</span></span><br><span class="line">  <span class="keyword">public</span> Builder(<span class="meta">@NonNull</span> Context context) &#123;</span><br><span class="line">    <span class="keyword">if</span> (context == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> new IllegalArgumentException(<span class="string">&quot;Context must not be null.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.context = context.getApplicationContext();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**指定默认用于解码图片的的BitmapConfig*/</span></span><br><span class="line">  <span class="keyword">public</span> Builder defaultBitmapConfig(<span class="meta">@NonNull</span> Bitmap.Config bitmapConfig) &#123;</span><br><span class="line">    <span class="keyword">if</span> (bitmapConfig == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> new IllegalArgumentException(<span class="string">&quot;Bitmap config must not be null.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.defaultBitmapConfig = bitmapConfig;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**指定用于下载图片的下载器*/</span></span><br><span class="line">  <span class="keyword">public</span> Builder downloader(<span class="meta">@NonNull</span> Downloader downloader) &#123;</span><br><span class="line">    <span class="keyword">if</span> (downloader == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> new IllegalArgumentException(<span class="string">&quot;Downloader must not be null.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.downloader != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> new IllegalStateException(<span class="string">&quot;Downloader already set.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.downloader = downloader;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/** 指定用于在后台下载图片的后台线程池 */</span></span><br><span class="line">  <span class="keyword">public</span> Builder executor(<span class="meta">@NonNull</span> ExecutorService executorService) &#123;</span><br><span class="line">    <span class="keyword">if</span> (executorService == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> new IllegalArgumentException(<span class="string">&quot;Executor service must not be null.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.service != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> new IllegalStateException(<span class="string">&quot;Executor service already set.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.service = executorService;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/** 指定用于存放最近使用的图片的缓存 */</span></span><br><span class="line">  <span class="keyword">public</span> Builder memoryCache(<span class="meta">@NonNull</span> Cache memoryCache) &#123;</span><br><span class="line">    <span class="keyword">if</span> (memoryCache == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> new IllegalArgumentException(<span class="string">&quot;Memory cache must not be null.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.cache != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> new IllegalStateException(<span class="string">&quot;Memory cache already set.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.cache = memoryCache;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/** 指定一个用于监听事件的监听器 */</span></span><br><span class="line">  <span class="keyword">public</span> Builder listener(<span class="meta">@NonNull</span> Listener listener) &#123;</span><br><span class="line">    <span class="keyword">if</span> (listener == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> new IllegalArgumentException(<span class="string">&quot;Listener must not be null.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.listener != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> new IllegalStateException(<span class="string">&quot;Listener already set.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.listener = listener;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**指定一个对所有到来请求进行转换的请求转换器*/</span></span><br><span class="line">  <span class="keyword">public</span> Builder requestTransformer(<span class="meta">@NonNull</span> RequestTransformer transformer) &#123;</span><br><span class="line">    <span class="keyword">if</span> (transformer == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> new IllegalArgumentException(<span class="string">&quot;Transformer must not be null.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.transformer != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> new IllegalStateException(<span class="string">&quot;Transformer already set.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.transformer = transformer;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/** 添加请求处理器 */</span></span><br><span class="line">  <span class="keyword">public</span> Builder addRequestHandler(<span class="meta">@NonNull</span> RequestHandler requestHandler) &#123;</span><br><span class="line">    <span class="keyword">if</span> (requestHandler == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> new IllegalArgumentException(<span class="string">&quot;RequestHandler must not be null.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (requestHandlers == <span class="literal">null</span>) &#123;</span><br><span class="line">      requestHandlers = new ArrayList&lt;RequestHandler&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (requestHandlers.contains(requestHandler)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> new IllegalStateException(<span class="string">&quot;RequestHandler already registered.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    requestHandlers.add(requestHandler);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/** 是否显示调试的标志在图片上 */</span></span><br><span class="line">  <span class="keyword">public</span> Builder indicatorsEnabled(boolean enabled) &#123;</span><br><span class="line">    <span class="keyword">this</span>.indicatorsEnabled = enabled;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/** 是否显示Log*/</span></span><br><span class="line">  <span class="keyword">public</span> Builder loggingEnabled(boolean enabled) &#123;</span><br><span class="line">    <span class="keyword">this</span>.loggingEnabled = enabled;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/** 配置了诸如默认的下载器，请求转换器，默认的memory cache等： */</span></span><br><span class="line">  <span class="keyword">public</span> Picasso build() &#123;</span><br><span class="line">    <span class="comment">//如果某些没有进行自定义那么就在这里使用默认的配置</span></span><br><span class="line">    Context context = <span class="keyword">this</span>.context;</span><br><span class="line">    <span class="keyword">if</span> (downloader == <span class="literal">null</span>) &#123;</span><br><span class="line">      downloader = Utils.createDefaultDownloader(context);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (cache == <span class="literal">null</span>) &#123;</span><br><span class="line">      cache = new LruCache(context);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (service == <span class="literal">null</span>) &#123;</span><br><span class="line">      service = new PicassoExecutorService();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (transformer == <span class="literal">null</span>) &#123;</span><br><span class="line">      transformer = RequestTransformer.IDENTITY;</span><br><span class="line">    &#125;</span><br><span class="line">    Stats stats = new Stats(cache);</span><br><span class="line">    Dispatcher dispatcher = new Dispatcher(context, service, HANDLER, downloader, cache, stats);</span><br><span class="line">    <span class="keyword">return</span> new Picasso(context, dispatcher, cache, listener, transformer, requestHandlers, stats,</span><br><span class="line">        defaultBitmapConfig, indicatorsEnabled, loggingEnabled);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来我们重点看下builder方法，如果我们没有注入自定义的下载器，那么就会调用createDefaultDownloader创建出一个下载器：<br>下面这种写法也是比较值得借鉴的。下面的create方法只是在应用缓存目录下创建一个picasso-cache的缓存目录。后续下载的图片都缓存在这个目录下。<br>&#x2F;**</p>
<ul>
<li>优先选用OKHttp3.如果没有那么就使用OkHttp，再没有那么使用Android 默认的下载方式<br> *&#x2F;<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function">Downloader <span class="title">createDefaultDownloader</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (SDK_INT &gt;= GINGERBREAD) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Class.forName(<span class="string">&quot;okhttp3.OkHttpClient&quot;</span>);</span><br><span class="line">      <span class="comment">//这里会先创建一个缓存目录</span></span><br><span class="line">      <span class="function"><span class="keyword">return</span> OkHttp3DownloaderCreator.<span class="title">create</span><span class="params">(context)</span></span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException ignored) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Class.forName(<span class="string">&quot;com.squareup.okhttp.OkHttpClient&quot;</span>);</span><br><span class="line">      <span class="comment">//这里会先创建一个缓存目录</span></span><br><span class="line">      <span class="function"><span class="keyword">return</span> OkHttpDownloaderCreator.<span class="title">create</span><span class="params">(context)</span></span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException ignored) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> UrlConnectionDownloader(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
接着我们看下默认缓存的设置：</li>
</ul>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">public</span> <span class="selector-tag">LruCache</span>(<span class="variable">@NonNull</span> Context context) &#123;</span><br><span class="line">  <span class="selector-tag">this</span>(Utils.calculateMemoryCacheSize(context));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据是否是大堆栈类型，如果是则获取大堆栈存储，否则获取标准堆栈存储。然后使用大概15%的存储空间作为缓存。</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">static <span class="built_in">int</span> calculate<span class="constructor">MemoryCacheSize(Context <span class="params">context</span>)</span> &#123;</span><br><span class="line">  ActivityManager am = get<span class="constructor">Service(<span class="params">context</span>, ACTIVITY_SERVICE)</span>;</span><br><span class="line">  boolean largeHeap = (context.get<span class="constructor">ApplicationInfo()</span>.flags &amp; FLAG_LARGE_HEAP) != <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">int</span> memoryClass = am.get<span class="constructor">MemoryClass()</span>;</span><br><span class="line">  <span class="keyword">if</span> (largeHeap<span class="operator"> &amp;&amp; </span>SDK_INT &gt;= HONEYCOMB) &#123;</span><br><span class="line">    memoryClass = <span class="module-access"><span class="module"><span class="identifier">ActivityManagerHoneycomb</span>.</span></span>get<span class="constructor">LargeMemoryClass(<span class="params">am</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Target ~15% of the available heap.</span></span><br><span class="line">  return (<span class="built_in">int</span>) (<span class="number">1024L</span><span class="operator"> * </span><span class="number">1024L</span><span class="operator"> * </span>memoryClass<span class="operator"> / </span><span class="number">7</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着我们看下默认的线程池的设置：<br>它是继承自ThreadPoolExcutor</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PicassoExecutorService</span> <span class="keyword">extends</span> <span class="title">ThreadPoolExecutor</span></span></span><br><span class="line"><span class="type">PicassoExecutorService</span>() &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * corePoolSize  线程池中容纳的核心线程数目，即使这些线程是空闲的，它会被保留在线程池中，除非allowCoreThreadTimeOut设置为true</span></span><br><span class="line"><span class="comment">   * maximumPoolSize  最大线程池大小</span></span><br><span class="line"><span class="comment">   * keepAliveTime    存活时间 当线程池中的线程数大于核心线程数的时候，在达到这个时间的时候等待新任务的空闲线程将会被终止</span></span><br><span class="line"><span class="comment">   * unit  keepAliveTime 参数的单位</span></span><br><span class="line"><span class="comment">   * workQueue 用于在任务执行前保存任务的队列，这个队列将只会保留通过execute方法提交的Runnable任务</span></span><br><span class="line"><span class="comment">   * threadFactory 在excutor创建一个线程时候使用的工厂类</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">super</span>(<span class="type">DEFAULT_THREAD_COUNT</span>, <span class="type">DEFAULT_THREAD_COUNT</span>, <span class="number">0</span>, <span class="type">TimeUnit</span>.<span class="type">MILLISECONDS</span>,</span><br><span class="line">      <span class="keyword">new</span> <span class="type">PriorityBlockingQueue</span>&lt;<span class="type">Runnable</span>&gt;(), <span class="keyword">new</span> <span class="type">Utils</span>.<span class="type">PicassoThreadFactory</span>());</span><br><span class="line">&#125;</span><br><span class="line">static <span class="class"><span class="keyword">class</span> <span class="title">PicassoThreadFactory</span> <span class="title">implements</span> <span class="title">ThreadFactory</span> </span>&#123;</span><br><span class="line">  <span class="meta">@SuppressWarnings</span>(<span class="string">&quot;NullableProblems&quot;</span>)</span><br><span class="line">  public <span class="type">Thread</span> newThread(<span class="type">Runnable</span> r) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="type">PicassoThread</span>(r);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> static <span class="class"><span class="keyword">class</span> <span class="title">PicassoThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">  public <span class="type">PicassoThread</span>(<span class="type">Runnable</span> r) &#123;</span><br><span class="line">    <span class="keyword">super</span>(r);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Override</span> public void run() &#123;</span><br><span class="line">    <span class="type">Process</span>.setThreadPriority(<span class="type">THREAD_PRIORITY_BACKGROUND</span>);</span><br><span class="line">    <span class="keyword">super</span>.run();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>紧接着我们来看下请求转换器：<br>请求转换器会在每次请求被提交的时候被调用，它主要用于修改某个请求的信息。我们看到默认的请求，并没有对请求做任何事情，只是简单的将原先的请求返回。</p>
<figure class="highlight vbscript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> interface RequestTransformer &#123;</span><br><span class="line">  <span class="built_in">Request</span> transformRequest(<span class="built_in">Request</span> <span class="built_in">request</span>);</span><br><span class="line">  RequestTransformer IDENTITY = <span class="keyword">new</span> RequestTransformer() &#123;</span><br><span class="line">    @Override <span class="keyword">public</span> <span class="built_in">Request</span> transformRequest(<span class="built_in">Request</span> <span class="built_in">request</span>) &#123;</span><br><span class="line">      return <span class="built_in">request</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Picasso 还有一个统计对象States，用于统计Picasso中的各种事件。它的主要对象只有三个带有消息处理能力的HandlerThread线程，一个Cache引用，一个Handler。</p>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> HandlerThread statsThread;</span><br><span class="line"><span class="keyword">final</span> Cache cache;</span><br><span class="line"><span class="keyword">final</span> Handler <span class="keyword">handler</span>;</span><br><span class="line">它的统计对象数据有：</span><br><span class="line"><span class="keyword">long</span> cacheHits;                            <span class="comment">//通过缓存获取到图片</span></span><br><span class="line"><span class="keyword">long</span> cacheMisses;                  <span class="comment">//通过其他方式获取图片</span></span><br><span class="line"><span class="keyword">long</span> totalDownloadSize;              <span class="comment">//下载的总数据量大小</span></span><br><span class="line"><span class="keyword">long</span> totalOriginalBitmapSize;              <span class="comment">//解码后统计总图片大小</span></span><br><span class="line"><span class="keyword">long</span> totalTransformedBitmapSize;           <span class="comment">//图像转换大小</span></span><br><span class="line"><span class="keyword">long</span> averageDownloadSize;                  <span class="comment">//平均下载大小</span></span><br><span class="line"><span class="keyword">long</span> averageOriginalBitmapSize;            <span class="comment">//平均解码后图片大小</span></span><br><span class="line"><span class="keyword">long</span> averageTransformedBitmapSize;         <span class="comment">//平均转换后图片大小</span></span><br><span class="line"><span class="keyword">int</span> downloadCount;                 <span class="comment">//下载次数</span></span><br><span class="line"><span class="keyword">int</span> originalBitmapCount;             <span class="comment">//原始图片数量</span></span><br><span class="line"><span class="keyword">int</span> transformedBitmapCount;                                 <span class="comment">//转换图片数量</span></span><br></pre></td></tr></table></figure>

<p>整个流程如下所示：<br>外界通过State对象调用dispatchXXXX方法，在dispatch方法中往Handler中发送事件，然后再调用performXXXX来处理这个事件。<br><img src="/2016/10/30/Android-%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%80-picasso/3.png"></p>
<p>接下来我们继续看下Dispatcher，它负责分发Action的：<br>我们先看下她的构造方法：</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line">Dispatcher(Context context, ExecutorService service, Handler mainThreadHandler,</span><br><span class="line">    Downloader downloader, Cache cache, Stats stats) &#123;</span><br><span class="line">  <span class="comment">//分发线程</span></span><br><span class="line">  <span class="keyword">this</span>.dispatcherThread = new DispatcherThread();</span><br><span class="line">  <span class="keyword">this</span>.dispatcherThread.start();</span><br><span class="line">  <span class="comment">//分发Handler</span></span><br><span class="line">  <span class="keyword">this</span>.handler = new DispatcherHandler(dispatcherThread.getLooper(), <span class="keyword">this</span>);  </span><br><span class="line">  <span class="comment">//主线程Handler</span></span><br><span class="line">  <span class="keyword">this</span>.mainThreadHandler = mainThreadHandler;</span><br><span class="line">  <span class="comment">//线程池</span></span><br><span class="line">  <span class="keyword">this</span>.service = service;</span><br><span class="line">  <span class="keyword">this</span>.hunterMap = new LinkedHashMap&lt;String, BitmapHunter&gt;();</span><br><span class="line">  <span class="keyword">this</span>.failedActions = new WeakHashMap&lt;Object, Action&gt;();</span><br><span class="line">  <span class="keyword">this</span>.pausedActions = new WeakHashMap&lt;Object, Action&gt;();</span><br><span class="line">  <span class="keyword">this</span>.pausedTags = new HashSet&lt;Object&gt;();</span><br><span class="line">  <span class="comment">//下载器</span></span><br><span class="line">  <span class="keyword">this</span>.downloader = downloader;</span><br><span class="line">  <span class="keyword">this</span>.cache = cache;</span><br><span class="line">  <span class="keyword">this</span>.stats = stats;</span><br><span class="line">  <span class="keyword">this</span>.batch = new ArrayList&lt;BitmapHunter&gt;(<span class="number">4</span>);</span><br><span class="line">  <span class="keyword">this</span>.airplaneMode = Utils.isAirplaneModeOn(<span class="keyword">this</span>.context);</span><br><span class="line">  <span class="keyword">this</span>.scansNetworkChanges = hasPermission(context, Manifest.permission.ACCESS_NETWORK_STATE);</span><br><span class="line">  <span class="comment">//网络监听器</span></span><br><span class="line">  <span class="keyword">this</span>.receiver = new NetworkBroadcastReceiver(<span class="keyword">this</span>);</span><br><span class="line">  receiver.register();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 整个流程还是和State对象一致，也是由HandlerThread + Handler构成，外部调用dispatchXXX方法传递事件，在Handler中周转下最终调用performXXXX进行处理。这个具体涉及到的时候再重点介绍。<br>在build最后新建一个Picass对象返回，我们看下Picass对象的构造方法：<br>&#x2F;**</p>
<ul>
<li>Picasso 有如下几个重要的对象：</li>
<li>RequestTransformer:请求转换器</li>
<li>Dispatcher：请求分发器</li>
<li>allRequestHandlers:请求处理器</li>
<li>Cache 缓存器</li>
<li>Stats 事件统计</li>
<li>CleanupThread 清除线程<br> *&#x2F; <figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line">Picasso(Context context, Dispatcher dispatcher, Cache cache, Listener listener,</span><br><span class="line">    RequestTransformer requestTransformer, List&lt;RequestHandler&gt; extraRequestHandlers, Stats stats,</span><br><span class="line">    Bitmap.Config defaultBitmapConfig, boolean indicatorsEnabled, boolean loggingEnabled) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.context = context;</span><br><span class="line">  <span class="keyword">this</span>.dispatcher = dispatcher;</span><br><span class="line">  <span class="keyword">this</span>.cache = cache;</span><br><span class="line">  <span class="keyword">this</span>.listener = listener;</span><br><span class="line">  <span class="keyword">this</span>.requestTransformer = requestTransformer;</span><br><span class="line">  <span class="keyword">this</span>.defaultBitmapConfig = defaultBitmapConfig;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//内部有7个请求处理器，额外的有一个</span></span><br><span class="line">  int builtInHandlers = <span class="number">7</span>; <span class="comment">// Adjust this as internal handlers are added or removed.</span></span><br><span class="line">  int extraCount = (extraRequestHandlers != <span class="literal">null</span> ? extraRequestHandlers.size() : <span class="number">0</span>);</span><br><span class="line">  List&lt;RequestHandler&gt; allRequestHandlers = new ArrayList&lt;RequestHandler&gt;(builtInHandlers + extraCount);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//将各个RequestHandler添加到allRequestHandlers</span></span><br><span class="line">  allRequestHandlers.add(new ResourceRequestHandler(context));</span><br><span class="line">  <span class="keyword">if</span> (extraRequestHandlers != <span class="literal">null</span>) &#123;</span><br><span class="line">    allRequestHandlers.addAll(extraRequestHandlers);</span><br><span class="line">  &#125;</span><br><span class="line">  allRequestHandlers.add(new ContactsPhotoRequestHandler(context));</span><br><span class="line">  allRequestHandlers.add(new MediaStoreRequestHandler(context));</span><br><span class="line">  allRequestHandlers.add(new ContentStreamRequestHandler(context));</span><br><span class="line">  allRequestHandlers.add(new AssetRequestHandler(context));</span><br><span class="line">  allRequestHandlers.add(new FileRequestHandler(context));</span><br><span class="line">  allRequestHandlers.add(new NetworkRequestHandler(dispatcher.downloader, stats));</span><br><span class="line">  requestHandlers = Collections.unmodifiableList(allRequestHandlers);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.stats = stats;</span><br><span class="line">  <span class="comment">//用于存储Traget和Action的Map</span></span><br><span class="line">  <span class="keyword">this</span>.targetToAction = new WeakHashMap&lt;Object, Action&gt;();</span><br><span class="line">  <span class="keyword">this</span>.targetToDeferredRequestCreator = new WeakHashMap&lt;ImageView, DeferredRequestCreator&gt;();</span><br><span class="line">  <span class="comment">//软引用队列</span></span><br><span class="line">  <span class="keyword">this</span>.referenceQueue = new ReferenceQueue&lt;Object&gt;();</span><br><span class="line">  <span class="comment">//清除线程</span></span><br><span class="line">  <span class="keyword">this</span>.cleanupThread = new CleanupThread(referenceQueue, HANDLER);</span><br><span class="line">  <span class="keyword">this</span>.cleanupThread.start();</span><br><span class="line">  <span class="comment">//调试相关</span></span><br><span class="line">  <span class="keyword">this</span>.indicatorsEnabled = indicatorsEnabled;</span><br><span class="line">  <span class="keyword">this</span>.loggingEnabled = loggingEnabled;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
我们可以看到在构造方法中添加了很多的requestHandler，用于对请求进行处理，这个在后面介绍流程的时候在进行介绍。<br>到目前为止我们知道了整个Picasso的大体结构入下图所示:<br><img src="/2016/10/30/Android-%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%80-picasso/4.png"><br>主要包括请求转换器，请求处理类，请求分发器，而请求分发器则负责将请求的分发和执行。</li>
</ul>
<p>with流程总结：<br>在with阶段主要是使用建造模式和单例模式，创建Picasso对象。在通过Picasso的Builder接口我们可以看出Picasso可以允许我们注入自定义的下载器，线程池，缓存，请求转换器，请求处理器，内部事件监听。然后通过build方法中检查哪些对象还没创建，如果还没创建就使用默认的方案，在创建Picasso对象的阶段会注册系列的请求处理器为后续的请求处理做准备。<br>我们可以从这个部分学到什么？</p>
<ol>
<li>Builder + 单例模式创建对象</li>
<li>通过Builder注入自定义对象，这里的自定义对象一般是抽象类或者接口，这样可以提供一个模板，用户可以通过这种方式来根据模板创建需要的对象。</li>
</ol>
<p>3.2   load流程：</p>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">public</span> <span class="selector-tag">RequestCreator</span> <span class="selector-tag">load</span>(<span class="variable">@Nullable</span> Uri uri) &#123;</span><br><span class="line">  <span class="selector-tag">return</span> <span class="selector-tag">new</span> <span class="selector-tag">RequestCreator</span>(this, uri, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在load阶段传递的是用于标示图片的Uri. path resourceId等。返回的是RequestCreator</p>
<figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line"><span class="built_in">RequestCreator</span>(Picasso picasso, Uri uri, <span class="type">int</span> resourceId) &#123;</span><br><span class="line">  <span class="keyword">if</span> (picasso.shutdown) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">IllegalStateException</span>(</span><br><span class="line">        <span class="string">&quot;Picasso instance already shut down. Cannot submit new requests.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.picasso = picasso;</span><br><span class="line">  <span class="keyword">this</span>.data = <span class="keyword">new</span> Request.<span class="built_in">Builder</span>(uri, resourceId, picasso.defaultBitmapConfig);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 这里实际上只是创建了一个Request.Builder为创建请求对象做准备。load阶段很简单吧。 这个阶段重点记住load提供的接口有如下几种：</p>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">public</span> <span class="selector-tag">RequestCreator</span> <span class="selector-tag">load</span>(<span class="variable">@Nullable</span> Uri uri) </span><br><span class="line"><span class="selector-tag">public</span> <span class="selector-tag">RequestCreator</span> <span class="selector-tag">load</span>(<span class="variable">@Nullable</span> String path)    <span class="comment">//android.resource:   file:  content:</span></span><br><span class="line"><span class="selector-tag">public</span> <span class="selector-tag">RequestCreator</span> <span class="selector-tag">load</span>(<span class="variable">@NonNull</span> File file)        </span><br><span class="line"><span class="selector-tag">public</span> <span class="selector-tag">RequestCreator</span> <span class="selector-tag">load</span>(<span class="variable">@DrawableRes</span> int resourceId)</span><br></pre></td></tr></table></figure>

<p>load阶段总结：<br>load阶段就完成两个任务，一个是创建一个RequestCreator，另一个是创建Requst.Builder.为into阶段做准备。</p>
<p>3.3  into流程分析：<br>下面代码是整个流程的代码，每个步骤我们将会在后面一一展开。</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">public void into(ImageView target, Callback callback) &#123;</span><br><span class="line">  <span class="comment">//获取创建请求的时间</span></span><br><span class="line">  long started = <span class="module-access"><span class="module"><span class="identifier">System</span>.</span></span>nano<span class="constructor">Time()</span>;</span><br><span class="line">  <span class="comment">//注意into阶段必须在主线程，所以在这个阶段需要检查下当前是否是在主线程</span></span><br><span class="line">  check<span class="constructor">Main()</span>;</span><br><span class="line">  <span class="keyword">if</span> (target<span class="operator"> == </span>null) &#123;</span><br><span class="line">    throw <span class="keyword">new</span> <span class="constructor">IllegalArgumentException(<span class="string">&quot;Target must not be null.&quot;</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//对输入的Uri进行检查，如果没有Uri或者resourceId那么就取消请求，根据要求看下是否显示占位图</span></span><br><span class="line">  <span class="keyword">if</span> (!data.has<span class="constructor">Image()</span>) &#123;</span><br><span class="line">    picasso.cancel<span class="constructor">Request(<span class="params">target</span>)</span>;</span><br><span class="line">    <span class="keyword">if</span> (setPlaceholder) &#123;</span><br><span class="line">      set<span class="constructor">Placeholder(<span class="params">target</span>, <span class="params">getPlaceholderDrawable</span>()</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (deferred) &#123;</span><br><span class="line">    <span class="keyword">if</span> (data.has<span class="constructor">Size()</span>) &#123;</span><br><span class="line">      throw <span class="keyword">new</span> <span class="constructor">IllegalStateException(<span class="string">&quot;Fit cannot be used with resize.&quot;</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">int</span> width = target.get<span class="constructor">Width()</span>;</span><br><span class="line">    <span class="built_in">int</span> height = target.get<span class="constructor">Height()</span>;</span><br><span class="line">    <span class="keyword">if</span> (width<span class="operator"> == </span><span class="number">0</span><span class="operator"> || </span>height<span class="operator"> == </span><span class="number">0</span><span class="operator"> || </span>target.is<span class="constructor">LayoutRequested()</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (setPlaceholder) &#123;</span><br><span class="line">        set<span class="constructor">Placeholder(<span class="params">target</span>, <span class="params">getPlaceholderDrawable</span>()</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      picasso.defer(target, <span class="keyword">new</span> <span class="constructor">DeferredRequestCreator(<span class="params">this</span>, <span class="params">target</span>, <span class="params">callback</span>)</span>);</span><br><span class="line">      return;</span><br><span class="line">    &#125;</span><br><span class="line">    data.resize(width, height);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//创建请求，请求有两个重要的元素id以及创建时间，创建完后需要通过请求转换器先进行初步的转换</span></span><br><span class="line">  Request request = create<span class="constructor">Request(<span class="params">started</span>)</span>;</span><br><span class="line">  <span class="comment">//使用请求信息，生成一个请求的key</span></span><br><span class="line">  String requestKey = create<span class="constructor">Key(<span class="params">request</span>)</span>;</span><br><span class="line">  <span class="comment">//查看请求策略，是否需要从缓存中获取数据</span></span><br><span class="line">  <span class="keyword">if</span> (should<span class="constructor">ReadFromMemoryCache(<span class="params">memoryPolicy</span>)</span>) &#123;</span><br><span class="line">    <span class="comment">//使用请求的key在cache中尝试获取图像，并统计获取结果</span></span><br><span class="line">    Bitmap bitmap = picasso.quick<span class="constructor">MemoryCacheCheck(<span class="params">requestKey</span>)</span>;</span><br><span class="line">    <span class="comment">//如果获取到了就取消请求，并设置图片，回调返回</span></span><br><span class="line">    <span class="keyword">if</span> (bitmap != null) &#123;</span><br><span class="line">      picasso.cancel<span class="constructor">Request(<span class="params">target</span>)</span>;</span><br><span class="line">      set<span class="constructor">Bitmap(<span class="params">target</span>, <span class="params">picasso</span>.<span class="params">context</span>, <span class="params">bitmap</span>, MEMORY, <span class="params">noFade</span>, <span class="params">picasso</span>.<span class="params">indicatorsEnabled</span>)</span>;</span><br><span class="line">      <span class="keyword">if</span> (picasso.loggingEnabled) &#123;</span><br><span class="line">        log(OWNER_MAIN, VERB_COMPLETED, request.plain<span class="constructor">Id()</span>, <span class="string">&quot;from &quot;</span> + MEMORY);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (callback != null) &#123;</span><br><span class="line">        callback.on<span class="constructor">Success()</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      return;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//如果需要从其他地方获取，那么就先显示占位图</span></span><br><span class="line">  <span class="keyword">if</span> (setPlaceholder) &#123;</span><br><span class="line">    set<span class="constructor">Placeholder(<span class="params">target</span>, <span class="params">getPlaceholderDrawable</span>()</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//初始化一个Action并提交</span></span><br><span class="line">  Action action = <span class="keyword">new</span> <span class="constructor">ImageViewAction(<span class="params">picasso</span>, <span class="params">target</span>, <span class="params">request</span>, <span class="params">memoryPolicy</span>,<span class="params">networkPolicy</span>, <span class="params">errorResId</span>, <span class="params">errorDrawable</span>, <span class="params">requestKey</span>, <span class="params">tag</span>, <span class="params">callback</span>, <span class="params">noFade</span>)</span>;</span><br><span class="line">  picasso.enqueue<span class="constructor">AndSubmit(<span class="params">action</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.1.1  Request的创建过程</p>
<p>into阶段会先对传入的Uri进行判断，如果为空就取消请求。并根据需要决定是否显示占位符<br>然后使用load阶段创建的Request.Builder来创建请求。每个请求都有两个关键的成员，一个id一个创建时间。创建完Request对象后会通过请求转换器对其进行转换。</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> Request create<span class="constructor">Request(<span class="params">long</span> <span class="params">started</span>)</span> &#123;</span><br><span class="line">  <span class="built_in">int</span> id = nextId.get<span class="constructor">AndIncrement()</span>; <span class="comment">//获得id</span></span><br><span class="line">  Request request = data.build<span class="literal">()</span>;    <span class="comment">//调用RequestBuidler 创建请求对象Requst</span></span><br><span class="line">  request.id = id;                   <span class="comment">//给请求设置id以及创建时间</span></span><br><span class="line">  request.started = started;         <span class="comment">//请求是通过这两个来标示一个请求对象的</span></span><br><span class="line">  Request transformed = picasso.transform<span class="constructor">Request(<span class="params">request</span>)</span>;  <span class="comment">//对请求进行转换，默认的请求转换器为空操作，直接返回原来的请求</span></span><br><span class="line">  return transformed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们先来看下Request.Builder 的 build方法：</p>
<figure class="highlight haxe"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Request build() &#123;</span><br><span class="line">    <span class="keyword">if</span> (centerInside &amp;&amp; centerCrop) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">IllegalStateException</span>(<span class="string">&quot;Center crop and center inside can not be used together.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (centerCrop &amp;&amp; (targetWidth == <span class="number">0</span> &amp;&amp; targetHeight == <span class="number">0</span>)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">IllegalStateException</span>(</span><br><span class="line">          <span class="string">&quot;Center crop requires calling resize with positive width and height.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (centerInside &amp;&amp; (targetWidth == <span class="number">0</span> &amp;&amp; targetHeight == <span class="number">0</span>)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">IllegalStateException</span>(</span><br><span class="line">          <span class="string">&quot;Center inside requires calling resize with positive width and height.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (priority == <span class="literal">null</span>) &#123;</span><br><span class="line">      priority = Priority.NORMAL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="type">Request</span>(uri, resourceId, stableKey, transformations, targetWidth, targetHeight,</span><br><span class="line">        centerCrop, centerInside, centerCropGravity, onlyScaleDown, rotationDegrees,</span><br><span class="line">        rotationPivotX, rotationPivotY, hasRotationPivot, purgeable, config, priority);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述的build过程首先对参数进行检查，通过上述的Requst对象中注入了包括uri在内的众多参数。<br>紧接着就是根据request对象来生成用于标示Requst的RequestKey。</p>
<figure class="highlight haskell"><table><tr><td class="code"><pre><span class="line"><span class="title">static</span> <span class="type">String</span> createKey(<span class="type">Request</span> <span class="class"><span class="keyword">data</span>, <span class="type">StringBuilder</span> builder) &#123;</span></span><br><span class="line"><span class="class">  <span class="title">if</span> (<span class="title">data</span>.<span class="title">stableKey</span> != <span class="title">null</span>) &#123;</span></span><br><span class="line"><span class="class">    <span class="title">builder</span>.<span class="title">ensureCapacity</span>(<span class="title">data</span>.<span class="title">stableKey</span>.<span class="title">length</span>() + <span class="type">KEY_PADDING</span>);</span></span><br><span class="line"><span class="class">    <span class="title">builder</span>.<span class="title">append</span>(<span class="title">data</span>.<span class="title">stableKey</span>);</span></span><br><span class="line"><span class="class">  &#125; else if (<span class="title">data</span>.<span class="title">uri</span> != <span class="title">null</span>) &#123;</span></span><br><span class="line"><span class="class">    <span class="type">String</span> <span class="title">path</span> = <span class="title">data</span>.<span class="title">uri</span>.<span class="title">toString</span>();</span></span><br><span class="line"><span class="class">    <span class="title">builder</span>.<span class="title">ensureCapacity</span>(<span class="title">path</span>.<span class="title">length</span>() + <span class="type">KEY_PADDING</span>);</span></span><br><span class="line"><span class="class">    <span class="title">builder</span>.<span class="title">append</span>(<span class="title">path</span>);</span></span><br><span class="line"><span class="class">  &#125; else &#123;</span></span><br><span class="line"><span class="class">    <span class="title">builder</span>.<span class="title">ensureCapacity</span>(<span class="type">KEY_PADDING</span>);</span></span><br><span class="line"><span class="class">    <span class="title">builder</span>.<span class="title">append</span>(<span class="title">data</span>.<span class="title">resourceId</span>);</span></span><br><span class="line"><span class="class">  &#125;</span></span><br><span class="line">  builder.append(<span class="type">KEY_SEPARATOR</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="class"><span class="keyword">data</span>.rotationDegrees != 0) &#123;</span></span><br><span class="line"><span class="class">    <span class="title">builder</span>.<span class="title">append</span>(&quot;<span class="title">rotation</span>:&quot;).<span class="title">append</span>(<span class="title">data</span>.<span class="title">rotationDegrees</span>);</span></span><br><span class="line"><span class="class">    <span class="title">if</span> (<span class="title">data</span>.<span class="title">hasRotationPivot</span>) &#123;</span></span><br><span class="line"><span class="class">      <span class="title">builder</span>.<span class="title">append</span>(&#x27;@&#x27;).<span class="title">append</span>(<span class="title">data</span>.<span class="title">rotationPivotX</span>).<span class="title">append</span>(&#x27;<span class="title">x&#x27;</span>).<span class="title">append</span>(<span class="title">data</span>.<span class="title">rotationPivotY</span>);</span></span><br><span class="line"><span class="class">    &#125;</span></span><br><span class="line">    builder.append(<span class="type">KEY_SEPARATOR</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="class"><span class="keyword">data</span>.hasSize()) &#123;</span></span><br><span class="line"><span class="class">    <span class="title">builder</span>.<span class="title">append</span>(&quot;<span class="title">resize</span>:&quot;).<span class="title">append</span>(<span class="title">data</span>.<span class="title">targetWidth</span>).<span class="title">append</span>(&#x27;<span class="title">x&#x27;</span>).<span class="title">append</span>(<span class="title">data</span>.<span class="title">targetHeight</span>);</span></span><br><span class="line"><span class="class">    <span class="title">builder</span>.<span class="title">append</span>(<span class="type">KEY_SEPARATOR</span>);</span></span><br><span class="line"><span class="class">  &#125;</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="class"><span class="keyword">data</span>.centerCrop) &#123;</span></span><br><span class="line"><span class="class">    <span class="title">builder</span>.<span class="title">append</span>(&quot;<span class="title">centerCrop</span>:&quot;).<span class="title">append</span>(<span class="title">data</span>.<span class="title">centerCropGravity</span>).<span class="title">append</span>(<span class="type">KEY_SEPARATOR</span>);</span></span><br><span class="line"><span class="class">  &#125; else if (<span class="title">data</span>.<span class="title">centerInside</span>) &#123;</span></span><br><span class="line"><span class="class">    <span class="title">builder</span>.<span class="title">append</span>(&quot;<span class="title">centerInside</span>&quot;).<span class="title">append</span>(<span class="type">KEY_SEPARATOR</span>);</span></span><br><span class="line"><span class="class">  &#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="class"><span class="keyword">data</span>.transformations != null) &#123;</span></span><br><span class="line"><span class="class">    //<span class="title">noinspection</span> <span class="type">ForLoopReplaceableByForEach</span></span></span><br><span class="line"><span class="class">    <span class="title">for</span> (<span class="title">int</span> <span class="title">i</span> = 0, <span class="title">count</span> = <span class="title">data</span>.<span class="title">transformations</span>.<span class="title">size</span>(); <span class="title">i</span> &lt; <span class="title">count</span>; <span class="title">i</span>++) &#123;</span></span><br><span class="line"><span class="class">      <span class="title">builder</span>.<span class="title">append</span>(<span class="title">data</span>.<span class="title">transformations</span>.<span class="title">get</span>(<span class="title">i</span>).<span class="title">key</span>());</span></span><br><span class="line"><span class="class">      <span class="title">builder</span>.<span class="title">append</span>(<span class="type">KEY_SEPARATOR</span>);</span></span><br><span class="line"><span class="class">    &#125;</span></span><br><span class="line">  &#125;</span><br><span class="line">  return builder.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.1.2  发起请求</p>
<p>( 1 ) 从缓存预取<br>在发起请求的时候首先查看下缓存策略，看下是否优先从缓存中获取图片数据，如果是的话就调用picasso.quickMemoryCacheCheck来检查缓存中是否已经有需要的数据了。如果有就返回，并且将结果传递给统计对象。然后取消现有的请求，并将图像设置到ImageView上。</p>
<figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line"><span class="keyword">Bitmap </span>quickMemoryCacheCheck(String key) &#123;</span><br><span class="line">  <span class="keyword">Bitmap </span><span class="keyword">cached </span>= <span class="keyword">cache.get(key);</span></span><br><span class="line"><span class="keyword"></span>  if (<span class="keyword">cached </span>!= null) &#123;</span><br><span class="line">    stats.<span class="keyword">dispatchCacheHit();</span></span><br><span class="line"><span class="keyword"></span>  &#125; else &#123;</span><br><span class="line">    stats.<span class="keyword">dispatchCacheMiss();</span></span><br><span class="line"><span class="keyword"></span>  &#125;</span><br><span class="line">  return <span class="keyword">cached;</span></span><br><span class="line"><span class="keyword"></span>&#125;</span><br></pre></td></tr></table></figure>
<p>(2) 创建Action 通过其他途径获取<br>紧接着创建一个ImageViewAction然后调用picasso.enqueueAndSubmit将Action发出。接下来这部分是非常重要的，所以在进行这部分介绍之前进行一下总结：</p>
<p>在into阶段首先会使用load阶段创建的RequstCreator来创建一个Request，并设置Requst的id以及启动时间这两个关键，参数，在创建Request这个过程中会先检查一系列的参数，然后再new出一个Requst对象出来。然后再使用创建出的Requst对象的参数创建出作为Request标示的requestKey。<br>再根据缓存策略，查看是否优先使用缓存中的图像，如果是的话那么就使用上面创建出来的requstKey从缓存中获取，并将结果反馈给stats对象进行统计，如果不优先使用缓存中的图像的话那么就创建出一个Action，然后调用picasso.enqueueAndSubmit将Action发出。<br>Action 是Target 以及Request的封装，它有个重要的方法abstract void complete(Bitmap result, Picasso.LoadedFrom from)在请求结束的时候会调用这个进行处理，这个后续会进行介绍，Action的子类目前有GetAction  FetchAction  TargetAction ImageViewAction RmoteViewAction这些。</p>
<p>我们继续看接下来的流程：<br>在提交到分发器之前需要先检查当前Action的对象是否绑定了另外的Action，如果是的话那么取消原先的请求，将当前的Action和Target放到targetToAction。然后提交到分发器上。</p>
<figure class="highlight fortran"><table><tr><td class="code"><pre><span class="line">void enqueueAndSubmit(<span class="keyword">Action</span> <span class="keyword">action</span>) &#123;</span><br><span class="line">  //获取<span class="keyword">Action</span>中的<span class="keyword">target</span></span><br><span class="line">  Object <span class="keyword">target</span> = <span class="keyword">action</span>.getTarget();</span><br><span class="line">  //如果当前targetToAction 中记录的 <span class="keyword">Target</span>中指定的<span class="keyword">action</span>不是当前的<span class="keyword">action</span> 说明之前已经指定了，那么取消原先的</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">target</span> <span class="comment">!= null &amp;&amp; targetToAction.get(target) != action) &#123;</span></span><br><span class="line">    cancelExistingRequest(<span class="keyword">target</span>);</span><br><span class="line">    //提交到targetToAction</span><br><span class="line">    targetToAction.put(<span class="keyword">target</span>, <span class="keyword">action</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  //提交到分发器</span><br><span class="line">  submit(<span class="keyword">action</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分发器分发请求：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">submit</span>(<span class="params">Action action</span>) &#123;</span><br><span class="line">   <span class="comment">//分发器分发请求</span></span><br><span class="line">  dispatcher.<span class="title function_">dispatchSubmit</span>(action);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void dispatch<span class="constructor">Submit(Action <span class="params">action</span>)</span> &#123;</span><br><span class="line">  handler.send<span class="constructor">Message(<span class="params">handler</span>.<span class="params">obtainMessage</span>(REQUEST_SUBMIT, <span class="params">action</span>)</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span> </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(<span class="keyword">final</span> Message msg)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">      <span class="keyword">case</span> REQUEST_SUBMIT: &#123;</span><br><span class="line">        <span class="type">Action</span> <span class="variable">action</span> <span class="operator">=</span> (Action) msg.obj;</span><br><span class="line">        dispatcher.performSubmit(action);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">     <span class="comment">//...............</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void perform<span class="constructor">Submit(Action <span class="params">action</span>)</span> &#123;</span><br><span class="line">  perform<span class="constructor">Submit(<span class="params">action</span>, <span class="params">true</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的流程在之前已经介绍了，由外部调用dispatchXXXX方法，然后传递给Hander，然后再由performXXXXX进行处理。</p>
<p>匹配requestHandler封装到BitmapHunter：<br>在performSubmit中根据Action来判断那个requstHandler可以处理这个请求，然后将这个requstHandler传递到新创建的BitmapHunter中。</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void perform<span class="constructor">Submit(Action <span class="params">action</span>, <span class="params">boolean</span> <span class="params">dismissFailed</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (pausedTags.contains(action.get<span class="constructor">Tag()</span>)) &#123;</span><br><span class="line">    pausedActions.put(action.get<span class="constructor">Target()</span>, action);</span><br><span class="line">    <span class="comment">//查看是否在停止的列表中</span></span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//从hunterMap通过RequestKey查找是否有已经存在的BitmapHunter(搜索者)</span></span><br><span class="line">  BitmapHunter hunter = hunterMap.get(action.get<span class="constructor">Key()</span>);</span><br><span class="line">  <span class="keyword">if</span> (hunter != null) &#123;</span><br><span class="line">    hunter.attach(action);</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//查找能够处理请求的RequestHandler，并将其封装到BitmapHunter</span></span><br><span class="line">  hunter = <span class="keyword">for</span><span class="constructor">Request(<span class="params">action</span>.<span class="params">getPicasso</span>()</span>, this, cache, stats, action);</span><br><span class="line">  <span class="comment">//BitmapHunter 实际上是一个线程，在这里将其丢到线程池进行执行，进入线程池后会调用其中的run方法</span></span><br><span class="line">  hunter.future = service.submit(hunter);</span><br><span class="line">  <span class="comment">//添加到hunterMap</span></span><br><span class="line">  hunterMap.put(action.get<span class="constructor">Key()</span>, hunter);</span><br><span class="line">  <span class="keyword">if</span> (dismissFailed) &#123;</span><br><span class="line">    failedActions.remove(action.get<span class="constructor">Target()</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>forRequst 方法中取出请求，以及请求处理器列表。依次调用请求处理器的canHandleRequst来判断当前requstHandler是否能够处理当前的请求。</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">static BitmapHunter <span class="keyword">for</span><span class="constructor">Request(Picasso <span class="params">picasso</span>, Dispatcher <span class="params">dispatcher</span>, Cache <span class="params">cache</span>, Stats <span class="params">stats</span>, Action <span class="params">action</span>)</span> &#123;</span><br><span class="line">  <span class="comment">//获取Action中封装的请求</span></span><br><span class="line">  Request request = action.get<span class="constructor">Request()</span>;</span><br><span class="line">  <span class="comment">//获取Picasso注册的RequestHandlers</span></span><br><span class="line">  List&lt;RequestHandler&gt; requestHandlers = picasso.get<span class="constructor">RequestHandlers()</span>;</span><br><span class="line">  <span class="comment">//遍历每个RequestHandler 看下那个Handler能够处理这个请求</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>, count = requestHandlers.size<span class="literal">()</span>; i &lt; count; i++) &#123;</span><br><span class="line">    RequestHandler requestHandler = requestHandlers.get(i);</span><br><span class="line">    <span class="comment">//使用请求的Uri来判断那个Handler进行处理</span></span><br><span class="line">    <span class="keyword">if</span> (requestHandler.can<span class="constructor">HandleRequest(<span class="params">request</span>)</span>) &#123; <span class="comment">//如果可以处理当前请求那么就将Action传递给新建的BitmapHunter</span></span><br><span class="line">      return <span class="keyword">new</span> <span class="constructor">BitmapHunter(<span class="params">picasso</span>, <span class="params">dispatcher</span>, <span class="params">cache</span>, <span class="params">stats</span>, <span class="params">action</span>, <span class="params">requestHandler</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return <span class="keyword">new</span> <span class="constructor">BitmapHunter(<span class="params">picasso</span>, <span class="params">dispatcher</span>, <span class="params">cache</span>, <span class="params">stats</span>, <span class="params">action</span>, ERRORING_HANDLER)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每个requestHandler都有一个canHandleRequst的方法，将request进去，在这个方法中将根据请求的Uri来进行匹配。当前是否可以处理这个类型的请求。所以在new Picasso 对象的时候各个requestHandler的请求对象的添加顺序很关键。<br>下面是网络请求处理器的canHandleRequest的实现。</p>
<figure class="highlight lasso"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">boolean</span> canHandleRequest(Request <span class="built_in">data</span>) &#123;</span><br><span class="line">  <span class="built_in">String</span> scheme = <span class="built_in">data</span>.uri.getScheme();</span><br><span class="line">  <span class="keyword">return</span> (SCHEME_HTTP.<span class="keyword">equals</span>(scheme) || SCHEME_HTTPS.<span class="keyword">equals</span>(scheme));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在添加到线程池后将会调用BitmapHunter的run方法。在run方法中主要是获取最终的Bitmap，然后再通过分发器来返回结果。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>()</span> &#123;</span><br><span class="line">    <span class="comment">//修改线程名字</span></span><br><span class="line">    updateThreadName(data);</span><br><span class="line">    <span class="comment">//获取图片并完成转换，首先会先从缓存中获取，然后调用RequestHandler load方法进行获取，最后再进行内部转换以及自定义的图片转换</span></span><br><span class="line">    result = hunt();</span><br><span class="line">    <span class="comment">//向分发器返回结果</span></span><br><span class="line">    <span class="keyword">if</span> (result == <span class="literal">null</span>) &#123;</span><br><span class="line">      dispatcher.dispatchFailed(<span class="keyword">this</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      dispatcher.dispatchComplete(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过requestHandler中的load方法加载图片数据：<br>获取图片主要是通过hunt方法，在这个方法中会先尝试从缓存中获取，如果缓存中没有，那么通过requstHandler中的load方法，这时候会有两种可能，一种是直接返回Bitmap。另一种是返回一个InputStream。如果是Bitmap那么就直接进入下一步，如果是输入流的话需要将从流中对其进行解码。</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">Bitmap hunt<span class="literal">()</span> throws IOException &#123;</span><br><span class="line">  Bitmap bitmap = null;</span><br><span class="line">  <span class="comment">//先尝试从缓存中获取图片</span></span><br><span class="line">  <span class="keyword">if</span> (should<span class="constructor">ReadFromMemoryCache(<span class="params">memoryPolicy</span>)</span>) &#123;</span><br><span class="line">    bitmap = cache.get(key);</span><br><span class="line">    <span class="keyword">if</span> (bitmap != null) &#123;</span><br><span class="line">      stats.dispatch<span class="constructor">CacheHit()</span>;</span><br><span class="line">      loadedFrom = MEMORY;</span><br><span class="line">      return bitmap;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  data.networkPolicy = retryCount<span class="operator"> == </span><span class="number">0</span> ? <span class="module-access"><span class="module"><span class="identifier">NetworkPolicy</span>.</span><span class="module"><span class="identifier">OFFLINE</span>.</span></span>index : networkPolicy;</span><br><span class="line">  <span class="comment">//调用requestHandler的load方法进行加载图片</span></span><br><span class="line">  RequestHandler.Result result = requestHandler.load(data, networkPolicy);</span><br><span class="line">  <span class="keyword">if</span> (result != null) &#123;</span><br><span class="line">    loadedFrom = result.get<span class="constructor">LoadedFrom()</span>;</span><br><span class="line">    exifOrientation = result.get<span class="constructor">ExifOrientation()</span>;</span><br><span class="line">    bitmap = result.get<span class="constructor">Bitmap()</span>;</span><br><span class="line">    <span class="comment">//首先会尝试直接获取Bitmap</span></span><br><span class="line">    <span class="keyword">if</span> (bitmap<span class="operator"> == </span>null) &#123;</span><br><span class="line">      <span class="comment">//如果不行的话尝试获取输入流</span></span><br><span class="line">      InputStream is = result.get<span class="constructor">Stream()</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//使用输入流来创建Bitmap</span></span><br><span class="line">        bitmap = decode<span class="constructor">Stream(<span class="params">is</span>, <span class="params">data</span>)</span>;</span><br><span class="line">      &#125; finally &#123;</span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">Utils</span>.</span></span>close<span class="constructor">Quietly(<span class="params">is</span>)</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (bitmap != null) &#123;</span><br><span class="line">    <span class="comment">//统计解码</span></span><br><span class="line">    stats.dispatch<span class="constructor">BitmapDecoded(<span class="params">bitmap</span>)</span>;</span><br><span class="line">    <span class="comment">//如果需要进行图片转换那么就进行转换</span></span><br><span class="line">    <span class="keyword">if</span> (data.needs<span class="constructor">Transformation()</span><span class="operator"> || </span>exifOrientation != <span class="number">0</span>) &#123;</span><br><span class="line">      synchronized (DECODE_LOCK) &#123;</span><br><span class="line">        <span class="comment">//调用transformResult进行图片转换</span></span><br><span class="line">        <span class="keyword">if</span> (data.needs<span class="constructor">MatrixTransform()</span><span class="operator"> || </span>exifOrientation != <span class="number">0</span>) &#123;</span><br><span class="line">          bitmap = transform<span class="constructor">Result(<span class="params">data</span>, <span class="params">bitmap</span>, <span class="params">exifOrientation</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果有自定义的转换效果那么就调用applyCustomTransformations 应用图片转换</span></span><br><span class="line">        <span class="keyword">if</span> (data.has<span class="constructor">CustomTransformations()</span>) &#123;</span><br><span class="line">          bitmap = apply<span class="constructor">CustomTransformations(<span class="params">data</span>.<span class="params">transformations</span>, <span class="params">bitmap</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//统计转换</span></span><br><span class="line">      <span class="keyword">if</span> (bitmap != null) &#123;</span><br><span class="line">        stats.dispatch<span class="constructor">BitmapTransformed(<span class="params">bitmap</span>)</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return bitmap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Result <span class="title function_">load</span><span class="params">(Request request, <span class="type">int</span> networkPolicy)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  <span class="comment">//调用Downloader进行下载</span></span><br><span class="line">  <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> downloader.load(request.uri, request.networkPolicy);</span><br><span class="line">  <span class="keyword">if</span> (response == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//查看是从哪里下载的？</span></span><br><span class="line">  Picasso.<span class="type">LoadedFrom</span> <span class="variable">loadedFrom</span> <span class="operator">=</span> response.cached ? DISK : NETWORK;</span><br><span class="line">  <span class="comment">//获取返回的图片</span></span><br><span class="line">  <span class="type">Bitmap</span> <span class="variable">bitmap</span> <span class="operator">=</span> response.getBitmap();</span><br><span class="line">  <span class="comment">//如果图片数据不为空那么返回图片</span></span><br><span class="line">  <span class="keyword">if</span> (bitmap != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(bitmap, loadedFrom);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> response.getInputStream();</span><br><span class="line">  <span class="keyword">if</span> (is == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (loadedFrom == DISK &amp;&amp; response.getContentLength() == <span class="number">0</span>) &#123;</span><br><span class="line">    Utils.closeQuietly(is);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ContentLengthException</span>(<span class="string">&quot;Received response with 0 content-length header.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (loadedFrom == NETWORK &amp;&amp; response.getContentLength() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    stats.dispatchDownloadFinished(response.getContentLength());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(is, loadedFrom);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>图像执行内部以及自定义变换处理：<br>获取到Bitmap数据之后接着就进行图像的转换，首先进行内部的转换，这个是通过调用transformRequst进行的。</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">static Bitmap transform<span class="constructor">Result(Request <span class="params">data</span>, Bitmap <span class="params">result</span>, <span class="params">int</span> <span class="params">exifOrientation</span>)</span> &#123;</span><br><span class="line">  <span class="built_in">int</span> inWidth = result.get<span class="constructor">Width()</span>;</span><br><span class="line">  <span class="built_in">int</span> inHeight = result.get<span class="constructor">Height()</span>;</span><br><span class="line">  boolean onlyScaleDown = data.onlyScaleDown;</span><br><span class="line">  <span class="built_in">int</span> drawX = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">int</span> drawY = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">int</span> drawWidth = inWidth;</span><br><span class="line">  <span class="built_in">int</span> drawHeight = inHeight;</span><br><span class="line">  Matrix matrix = <span class="keyword">new</span> <span class="constructor">Matrix()</span>;</span><br><span class="line">  <span class="keyword">if</span> (data.needs<span class="constructor">MatrixTransform()</span><span class="operator"> || </span>exifOrientation != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">int</span> targetWidth = data.targetWidth;</span><br><span class="line">    <span class="built_in">int</span> targetHeight = data.targetHeight;</span><br><span class="line">    <span class="built_in">float</span> targetRotation = data.rotationDegrees;</span><br><span class="line">    <span class="keyword">if</span> (targetRotation != <span class="number">0</span>) &#123;</span><br><span class="line">      double cosR = <span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>cos(<span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span><span class="keyword">to</span><span class="constructor">Radians(<span class="params">targetRotation</span>)</span>);</span><br><span class="line">      double sinR = <span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>sin(<span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span><span class="keyword">to</span><span class="constructor">Radians(<span class="params">targetRotation</span>)</span>);</span><br><span class="line">      <span class="keyword">if</span> (data.hasRotationPivot) &#123;</span><br><span class="line">        matrix.set<span class="constructor">Rotate(<span class="params">targetRotation</span>, <span class="params">data</span>.<span class="params">rotationPivotX</span>, <span class="params">data</span>.<span class="params">rotationPivotY</span>)</span>;</span><br><span class="line">        <span class="comment">// Recalculate dimensions after rotation around pivot point</span></span><br><span class="line">        double x1T = data.rotationPivotX<span class="operator"> * </span>(<span class="number">1.0</span> - cosR) + (data.rotationPivotY<span class="operator"> * </span>sinR);</span><br><span class="line">        double y1T = data.rotationPivotY<span class="operator"> * </span>(<span class="number">1.0</span> - cosR) - (data.rotationPivotX<span class="operator"> * </span>sinR);</span><br><span class="line">        double x2T = x1T + (data.targetWidth<span class="operator"> * </span>cosR);</span><br><span class="line">        double y2T = y1T + (data.targetWidth<span class="operator"> * </span>sinR);</span><br><span class="line">        double x3T = x1T + (data.targetWidth<span class="operator"> * </span>cosR) - (data.targetHeight<span class="operator"> * </span>sinR);</span><br><span class="line">        double y3T = y1T + (data.targetWidth<span class="operator"> * </span>sinR) + (data.targetHeight<span class="operator"> * </span>cosR);</span><br><span class="line">        double x4T = x1T - (data.targetHeight<span class="operator"> * </span>sinR);</span><br><span class="line">        double y4T = y1T + (data.targetHeight<span class="operator"> * </span>cosR);</span><br><span class="line">        double maxX = <span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>max(x4T, <span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>max(x3T, <span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>max(x1T, x2T)));</span><br><span class="line">        double minX = <span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>min(x4T, <span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>min(x3T, <span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>min(x1T, x2T)));</span><br><span class="line">        double maxY = <span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>max(y4T, <span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>max(y3T, <span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>max(y1T, y2T)));</span><br><span class="line">        double minY = <span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>min(y4T, <span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>min(y3T, <span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>min(y1T, y2T)));</span><br><span class="line">        targetWidth = (<span class="built_in">int</span>) <span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>floor(maxX - minX);</span><br><span class="line">        targetHeight  = (<span class="built_in">int</span>) <span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>floor(maxY - minY);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        matrix.set<span class="constructor">Rotate(<span class="params">targetRotation</span>)</span>;</span><br><span class="line">        <span class="comment">// Recalculate dimensions after rotation (around origin)</span></span><br><span class="line">        double x1T = <span class="number">0.0</span>;</span><br><span class="line">        double y1T = <span class="number">0.0</span>;</span><br><span class="line">        double x2T = (data.targetWidth<span class="operator"> * </span>cosR);</span><br><span class="line">        double y2T = (data.targetWidth<span class="operator"> * </span>sinR);</span><br><span class="line">        double x3T = (data.targetWidth<span class="operator"> * </span>cosR) - (data.targetHeight<span class="operator"> * </span>sinR);</span><br><span class="line">        double y3T = (data.targetWidth<span class="operator"> * </span>sinR) + (data.targetHeight<span class="operator"> * </span>cosR);</span><br><span class="line">        double x4T = -(data.targetHeight<span class="operator"> * </span>sinR);</span><br><span class="line">        double y4T = (data.targetHeight<span class="operator"> * </span>cosR);</span><br><span class="line">        double maxX = <span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>max(x4T, <span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>max(x3T, <span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>max(x1T, x2T)));</span><br><span class="line">        double minX = <span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>min(x4T, <span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>min(x3T, <span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>min(x1T, x2T)));</span><br><span class="line">        double maxY = <span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>max(y4T, <span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>max(y3T, <span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>max(y1T, y2T)));</span><br><span class="line">        double minY = <span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>min(y4T, <span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>min(y3T, <span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>min(y1T, y2T)));</span><br><span class="line">        targetWidth = (<span class="built_in">int</span>) <span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>floor(maxX - minX);</span><br><span class="line">        targetHeight  = (<span class="built_in">int</span>) <span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>floor(maxY - minY);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (exifOrientation != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">int</span> exifRotation = get<span class="constructor">ExifRotation(<span class="params">exifOrientation</span>)</span>;</span><br><span class="line">      <span class="built_in">int</span> exifTranslation = get<span class="constructor">ExifTranslation(<span class="params">exifOrientation</span>)</span>;</span><br><span class="line">      <span class="keyword">if</span> (exifRotation != <span class="number">0</span>) &#123;</span><br><span class="line">        matrix.pre<span class="constructor">Rotate(<span class="params">exifRotation</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (exifRotation<span class="operator"> == </span><span class="number">90</span><span class="operator"> || </span>exifRotation<span class="operator"> == </span><span class="number">270</span>) &#123;</span><br><span class="line">           <span class="comment">// Recalculate dimensions after exif rotation</span></span><br><span class="line">           <span class="built_in">int</span> tmpHeight = targetHeight;</span><br><span class="line">           targetHeight = targetWidth;</span><br><span class="line">           targetWidth = tmpHeight;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (exifTranslation != <span class="number">1</span>) &#123;</span><br><span class="line">        matrix.post<span class="constructor">Scale(<span class="params">exifTranslation</span>, 1)</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (data.centerCrop) &#123;</span><br><span class="line">      <span class="comment">// Keep aspect ratio if one dimension is set to 0</span></span><br><span class="line">      <span class="built_in">float</span> widthRatio =</span><br><span class="line">          targetWidth != <span class="number">0</span> ? targetWidth<span class="operator"> / </span>(<span class="built_in">float</span>) inWidth : targetHeight<span class="operator"> / </span>(<span class="built_in">float</span>) inHeight;</span><br><span class="line">      <span class="built_in">float</span> heightRatio =</span><br><span class="line">          targetHeight != <span class="number">0</span> ? targetHeight<span class="operator"> / </span>(<span class="built_in">float</span>) inHeight : targetWidth<span class="operator"> / </span>(<span class="built_in">float</span>) inWidth;</span><br><span class="line">      <span class="built_in">float</span> scaleX, scaleY;</span><br><span class="line">      <span class="keyword">if</span> (widthRatio &gt; heightRatio) &#123;</span><br><span class="line">        <span class="built_in">int</span> newSize = (<span class="built_in">int</span>) <span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>ceil(inHeight<span class="operator"> * </span>(heightRatio<span class="operator"> / </span>widthRatio));</span><br><span class="line">        <span class="keyword">if</span> ((data.centerCropGravity &amp; Gravity.TOP)<span class="operator"> == </span>Gravity.TOP) &#123;</span><br><span class="line">          drawY = <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((data.centerCropGravity &amp; Gravity.BOTTOM)<span class="operator"> == </span>Gravity.BOTTOM) &#123;</span><br><span class="line">          drawY = inHeight - newSize;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          drawY = (inHeight - newSize)<span class="operator"> / </span><span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        drawHeight = newSize;</span><br><span class="line">        scaleX = widthRatio;</span><br><span class="line">        scaleY = targetHeight<span class="operator"> / </span>(<span class="built_in">float</span>) drawHeight;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (widthRatio &lt; heightRatio) &#123;</span><br><span class="line">        <span class="built_in">int</span> newSize = (<span class="built_in">int</span>) <span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>ceil(inWidth<span class="operator"> * </span>(widthRatio<span class="operator"> / </span>heightRatio));</span><br><span class="line">        <span class="keyword">if</span> ((data.centerCropGravity &amp; Gravity.LEFT)<span class="operator"> == </span>Gravity.LEFT) &#123;</span><br><span class="line">          drawX = <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((data.centerCropGravity &amp; Gravity.RIGHT)<span class="operator"> == </span>Gravity.RIGHT) &#123;</span><br><span class="line">          drawX = inWidth - newSize;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          drawX = (inWidth - newSize)<span class="operator"> / </span><span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        drawWidth = newSize;</span><br><span class="line">        scaleX = targetWidth<span class="operator"> / </span>(<span class="built_in">float</span>) drawWidth;</span><br><span class="line">        scaleY = heightRatio;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        drawX = <span class="number">0</span>;</span><br><span class="line">        drawWidth = inWidth;</span><br><span class="line">        scaleX = scaleY = heightRatio;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (should<span class="constructor">Resize(<span class="params">onlyScaleDown</span>, <span class="params">inWidth</span>, <span class="params">inHeight</span>, <span class="params">targetWidth</span>, <span class="params">targetHeight</span>)</span>) &#123;</span><br><span class="line">        matrix.pre<span class="constructor">Scale(<span class="params">scaleX</span>, <span class="params">scaleY</span>)</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data.centerInside) &#123;</span><br><span class="line">      <span class="comment">// Keep aspect ratio if one dimension is set to 0</span></span><br><span class="line">      <span class="built_in">float</span> widthRatio =</span><br><span class="line">          targetWidth != <span class="number">0</span> ? targetWidth<span class="operator"> / </span>(<span class="built_in">float</span>) inWidth : targetHeight<span class="operator"> / </span>(<span class="built_in">float</span>) inHeight;</span><br><span class="line">      <span class="built_in">float</span> heightRatio =</span><br><span class="line">          targetHeight != <span class="number">0</span> ? targetHeight<span class="operator"> / </span>(<span class="built_in">float</span>) inHeight : targetWidth<span class="operator"> / </span>(<span class="built_in">float</span>) inWidth;</span><br><span class="line">      <span class="built_in">float</span> scale = widthRatio &lt; heightRatio ? widthRatio : heightRatio;</span><br><span class="line">      <span class="keyword">if</span> (should<span class="constructor">Resize(<span class="params">onlyScaleDown</span>, <span class="params">inWidth</span>, <span class="params">inHeight</span>, <span class="params">targetWidth</span>, <span class="params">targetHeight</span>)</span>) &#123;</span><br><span class="line">        matrix.pre<span class="constructor">Scale(<span class="params">scale</span>, <span class="params">scale</span>)</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((targetWidth != <span class="number">0</span><span class="operator"> || </span>targetHeight != <span class="number">0</span>) <span class="comment">//</span><span class="operator"></span></span><br><span class="line"><span class="operator">        &amp;&amp; </span>(targetWidth != inWidth<span class="operator"> || </span>targetHeight != inHeight)) &#123;</span><br><span class="line">      <span class="comment">// If an explicit target size has been specified and they do not match the results bounds,</span></span><br><span class="line">      <span class="comment">// pre-scale the existing matrix appropriately.</span></span><br><span class="line">      <span class="comment">// Keep aspect ratio if one dimension is set to 0.</span></span><br><span class="line">      <span class="built_in">float</span> sx =</span><br><span class="line">          targetWidth != <span class="number">0</span> ? targetWidth<span class="operator"> / </span>(<span class="built_in">float</span>) inWidth : targetHeight<span class="operator"> / </span>(<span class="built_in">float</span>) inHeight;</span><br><span class="line">      <span class="built_in">float</span> sy =</span><br><span class="line">          targetHeight != <span class="number">0</span> ? targetHeight<span class="operator"> / </span>(<span class="built_in">float</span>) inHeight : targetWidth<span class="operator"> / </span>(<span class="built_in">float</span>) inWidth;</span><br><span class="line">      <span class="keyword">if</span> (should<span class="constructor">Resize(<span class="params">onlyScaleDown</span>, <span class="params">inWidth</span>, <span class="params">inHeight</span>, <span class="params">targetWidth</span>, <span class="params">targetHeight</span>)</span>) &#123;</span><br><span class="line">        matrix.pre<span class="constructor">Scale(<span class="params">sx</span>, <span class="params">sy</span>)</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  Bitmap newResult = <span class="module-access"><span class="module"><span class="identifier">Bitmap</span>.</span></span>create<span class="constructor">Bitmap(<span class="params">result</span>, <span class="params">drawX</span>, <span class="params">drawY</span>, <span class="params">drawWidth</span>, <span class="params">drawHeight</span>, <span class="params">matrix</span>, <span class="params">true</span>)</span>;</span><br><span class="line">  <span class="keyword">if</span> (newResult != result) &#123;</span><br><span class="line">    result.recycle<span class="literal">()</span>;</span><br><span class="line">    result = newResult;</span><br><span class="line">  &#125;</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来就是进行自定义的处理，这个是我们可以进行自己设置的。</p>
<figure class="highlight haxe"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> Bitmap applyCustomTransformations(List&lt;Transformation&gt; transformations, Bitmap result) &#123;</span><br><span class="line">  <span class="keyword">for</span> (int i = <span class="number">0</span>, count = transformations.size(); i &lt; count; i++) &#123;</span><br><span class="line">    final Transformation transformation = transformations.<span class="keyword">get</span>(i);</span><br><span class="line">    Bitmap <span class="keyword">new</span><span class="type">Result</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">new</span><span class="type">Result</span> = transformation.transform(result);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (final RuntimeException e) &#123;</span><br><span class="line">      <span class="comment">//.................</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    result = <span class="keyword">new</span><span class="type">Result</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>往主线程中返回处理后的Bitmap：</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void dispatch<span class="constructor">Complete(BitmapHunter <span class="params">hunter</span>)</span> &#123;</span><br><span class="line">  handler.send<span class="constructor">Message(<span class="params">handler</span>.<span class="params">obtainMessage</span>(HUNTER_COMPLETE, <span class="params">hunter</span>)</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">case HUNTER_COMPLETE: &#123;</span><br><span class="line">  <span class="keyword">BitmapHunter </span>hunter = (<span class="keyword">BitmapHunter) </span>msg.obj;</span><br><span class="line">  <span class="keyword">dispatcher.performComplete(hunter);</span></span><br><span class="line"><span class="keyword"></span>  <span class="keyword">break;</span></span><br><span class="line"><span class="keyword"></span>&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void perform<span class="constructor">Complete(BitmapHunter <span class="params">hunter</span>)</span> &#123;</span><br><span class="line">  <span class="comment">//是否需要写入到缓存中</span></span><br><span class="line">  <span class="keyword">if</span> (should<span class="constructor">WriteToMemoryCache(<span class="params">hunter</span>.<span class="params">getMemoryPolicy</span>()</span>)) &#123;</span><br><span class="line">    cache.set(hunter.get<span class="constructor">Key()</span>, hunter.get<span class="constructor">Result()</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//移除hunterMap中注册的信息</span></span><br><span class="line">  hunterMap.remove(hunter.get<span class="constructor">Key()</span>);</span><br><span class="line">  <span class="comment">//将图片展现出来</span></span><br><span class="line">  batch(hunter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">void</span> <span class="title">batch</span><span class="params">(BitmapHunter hunter)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (hunter.isCancelled()) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  batch.add(hunter);</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">handler</span>.hasMessages(HUNTER_DELAY_NEXT_BATCH)) &#123;</span><br><span class="line">    <span class="keyword">handler</span>.sendEmptyMessageDelayed(HUNTER_DELAY_NEXT_BATCH, BATCH_DELAY);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight actionscript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> HUNTER_DELAY_NEXT_BATCH: &#123;</span><br><span class="line">  dispatcher.performBatchComplete();</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里将上面的BitmapHandler数组返回给主线程。</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void perform<span class="constructor">BatchComplete()</span> &#123;</span><br><span class="line">  List&lt;BitmapHunter&gt; copy = <span class="keyword">new</span> ArrayList&lt;BitmapHunter&gt;(batch);</span><br><span class="line">  batch.clear<span class="literal">()</span>;</span><br><span class="line">  <span class="comment">//这里是将其转送到Picasso类中进行处理，mainThreadHandler是在初始化DisPatcher的时候传入的HANDLER</span></span><br><span class="line">  mainThreadHandler.send<span class="constructor">Message(<span class="params">mainThreadHandler</span>.<span class="params">obtainMessage</span>(HUNTER_BATCH_COMPLETE, <span class="params">copy</span>)</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>显示图片处理：<br>在complete阶段每个BitmapHunter都会将自己传递给Picasso complete中进行处理。</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">case HUNTER_BATCH_COMPLETE: &#123;</span><br><span class="line">  <span class="regexp">//</span>获取BitmapHunter列表</span><br><span class="line">  List&lt;BitmapHunter&gt; batch = (List&lt;BitmapHunter&gt;) msg.obj;</span><br><span class="line">  <span class="regexp">//</span>对BitmapHandler列表中的每个handler调用complete方法进行处理。</span><br><span class="line">  <span class="keyword">for</span> (int i = <span class="number">0</span>, n = batch.size(); i &lt; n; i++) &#123;</span><br><span class="line">    <span class="regexp">//</span>调用complete进行处理</span><br><span class="line">    BitmapHunter hunter = batch.get(i);</span><br><span class="line">    hunter.picasso.complete(hunter);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在Picasso的complete方法中将会从BitmapHunter中获取到图片数据。通过deliverAction进行图片的显示。</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">void complete(BitmapHunter hunter) &#123;</span><br><span class="line">  Action single = hunter.get<span class="constructor">Action()</span>;</span><br><span class="line">  List&lt;Action&gt; joined = hunter.get<span class="constructor">Actions()</span>;</span><br><span class="line"></span><br><span class="line">  boolean hasMultiple = joined != null<span class="operator"> &amp;&amp; </span>!joined.is<span class="constructor">Empty()</span>;</span><br><span class="line">  boolean shouldDeliver = single != null<span class="operator"> || </span>hasMultiple;</span><br><span class="line">  <span class="keyword">if</span> (!shouldDeliver) &#123;</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//从hunter中获取Uri Exception result以及图片的来源</span></span><br><span class="line">  Uri uri = hunter.get<span class="constructor">Data()</span>.uri;</span><br><span class="line">  Exception <span class="keyword">exception</span> = hunter.get<span class="constructor">Exception()</span>;</span><br><span class="line">  Bitmap result = hunter.get<span class="constructor">Result()</span>;</span><br><span class="line">  LoadedFrom from = hunter.get<span class="constructor">LoadedFrom()</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (single != null) &#123;</span><br><span class="line">    <span class="comment">//显示图片</span></span><br><span class="line">    deliver<span class="constructor">Action(<span class="params">result</span>, <span class="params">from</span>, <span class="params">single</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (hasMultiple) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>, n = joined.size<span class="literal">()</span>; i &lt; n; i++) &#123;</span><br><span class="line">      Action join = joined.get(i);</span><br><span class="line">      deliver<span class="constructor">Action(<span class="params">result</span>, <span class="params">from</span>, <span class="params">join</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//通过回调返回结果</span></span><br><span class="line">  <span class="keyword">if</span> (listener != null<span class="operator"> &amp;&amp; </span><span class="keyword">exception</span> != null) &#123;</span><br><span class="line">    listener.on<span class="constructor">ImageLoadFailed(<span class="params">this</span>, <span class="params">uri</span>, <span class="params">exception</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在deliverAction中将会调用Action中的complete方法进行将图像显示到控件上。</p>
<figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> void deliverAction(Bitmap result, LoadedFrom <span class="keyword">from</span>, <span class="built_in">Action</span> <span class="built_in">action</span>) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (result != null) &#123;</span><br><span class="line">    <span class="comment">//调用Action的complete方法</span></span><br><span class="line">    <span class="built_in">action</span>.complete(result, <span class="keyword">from</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">action</span>.error();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终是调用PicassoDrawable的setBitmap方法显示到ImageView上的。</p>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">complete</span><span class="params">(Bitmap result, Picasso.LoadedFrom from)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(</span><br><span class="line">        String.format(<span class="string">&quot;Attempted to complete action with no result!\n%s&quot;</span>, <span class="keyword">this</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//取出要显示图片的ImageView</span></span><br><span class="line">  ImageView <span class="keyword">target</span> = <span class="keyword">this</span>.<span class="keyword">target</span>.get();</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">target</span> == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Context context = picasso.context;</span><br><span class="line">  <span class="comment">//使用PicassoDrawable  setBitmap 方法将图片显示到ImageView上</span></span><br><span class="line">  PicassoDrawable.setBitmap(<span class="keyword">target</span>, context, result, from, noFade, indicatorsEnabled);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//回调放回结果</span></span><br><span class="line">  <span class="keyword">if</span> (callback != <span class="keyword">null</span>) &#123;</span><br><span class="line">    callback.onSuccess();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="function"><span class="keyword">void</span> <span class="title">setBitmap</span><span class="params">(ImageView <span class="keyword">target</span>, Context context, Bitmap bitmap,</span></span></span><br><span class="line"><span class="params"><span class="function">    Picasso.LoadedFrom loadedFrom, <span class="keyword">boolean</span> noFade, <span class="keyword">boolean</span> debugging)</span> </span>&#123;</span><br><span class="line">  Drawable placeholder = <span class="keyword">target</span>.getDrawable();</span><br><span class="line">  <span class="keyword">if</span> (placeholder <span class="keyword">instanceof</span> AnimationDrawable) &#123;</span><br><span class="line">    ((AnimationDrawable) placeholder).stop();</span><br><span class="line">  &#125;</span><br><span class="line">  PicassoDrawable drawable = <span class="keyword">new</span> PicassoDrawable(context, bitmap, placeholder, loadedFrom, noFade, debugging);</span><br><span class="line">  <span class="comment">//最终显示图片</span></span><br><span class="line">  <span class="keyword">target</span>.setImageDrawable(drawable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整个流程大致如下：</p>
<p><img src="/2016/10/30/Android-%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%80-picasso/5.png"></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">Android 源码分析</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Android-开源源码/">Android 开源源码</a>
  </div>

</div>



<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/10/30/Android-开源框架源码分析一-picasso/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/10/30/Android-开源框架源码分析一-picasso/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/08/22/Android-源码分析之TODO-MVP-Loaders/" title="Android 源码分析之TODO MVP Loaders" itemprop="url">Android 源码分析之TODO MVP Loaders</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Edgar" target="_blank" itemprop="author">Edgar</a>
		
  <p class="article-time">
    <time datetime="2016-08-22T10:08:19.000Z" itemprop="datePublished"> Published 2016-08-22</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>在看这篇博客之前请先看下Android 源码分析之TODO MVP 以及Android 进阶之设计模式 二 MVP模式。整个代码的流程在Android 源码分析之TODO MVP已经介绍过了，这篇博客将只介绍差异的部分。</p>
<p>还是老样子从TasksActivity开始分析：</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">TasksActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> static <span class="keyword">final</span> <span class="type">String</span> <span class="type">CURRENT_FILTERING_KEY</span> = <span class="string">&quot;CURRENT_FILTERING_KEY&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">DrawerLayout</span> mDrawerLayout;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">TasksPresenter</span> mTasksPresenter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> void onCreate(<span class="type">Bundle</span> savedInstanceState) &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//....................</span></span><br><span class="line">        <span class="type">TasksFragment</span> tasksFragment =</span><br><span class="line">                (<span class="type">TasksFragment</span>) getSupportFragmentManager().findFragmentById(<span class="type">R</span>.id.contentFrame);</span><br><span class="line">        <span class="keyword">if</span> (tasksFragment == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Create the fragment</span></span><br><span class="line">            tasksFragment = <span class="type">TasksFragment</span>.newInstance();</span><br><span class="line">            <span class="type">ActivityUtils</span>.addFragmentToActivity(</span><br><span class="line">                    getSupportFragmentManager(), tasksFragment, <span class="type">R</span>.id.contentFrame);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create the presenter</span></span><br><span class="line">        <span class="type">TasksRepository</span> repository = <span class="type">Injection</span>.provideTasksRepository(getApplicationContext());</span><br><span class="line">        <span class="type">TasksLoader</span> tasksLoader = <span class="keyword">new</span> <span class="type">TasksLoader</span>(getApplicationContext(), repository);</span><br><span class="line"></span><br><span class="line">        mTasksPresenter = <span class="keyword">new</span> <span class="type">TasksPresenter</span>(</span><br><span class="line">                tasksLoader,</span><br><span class="line">                getSupportLoaderManager(),</span><br><span class="line">                repository,</span><br><span class="line">                tasksFragment</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">//......................</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//.........................</span></span><br></pre></td></tr></table></figure>

<p>由于这个部分只是数据加载方式做了修改，所以View层TasksFragment没有多大的改变。 我们来看下数据层的代码：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TasksRepository</span> <span class="keyword">implements</span> <span class="title class_">TasksDataSource</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="title class_">TasksRepository</span> <span class="variable constant_">INSTANCE</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//远程数据源</span></span><br><span class="line">    <span class="keyword">private</span> final <span class="title class_">TasksDataSource</span> mTasksRemoteDataSource;</span><br><span class="line">    <span class="comment">//本地数据源</span></span><br><span class="line">    <span class="keyword">private</span> final <span class="title class_">TasksDataSource</span> mTasksLocalDataSource;</span><br><span class="line">    <span class="comment">//数据源监听器</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">List</span>&lt;<span class="title class_">TasksRepositoryObserver</span>&gt; mObservers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;<span class="title class_">TasksRepositoryObserver</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 内存缓存区</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="title class_">Map</span>&lt;<span class="title class_">String</span>, <span class="title class_">Task</span>&gt; mCachedTasks;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Marks the cache as invalid, to force an update the next time data is requested. This variable</span></span><br><span class="line"><span class="comment">     * has package local visibility so it can be accessed from tests.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//用于表示当前缓存数据是否可用</span></span><br><span class="line">    <span class="built_in">boolean</span> mCacheIsDirty;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the single instance of this class, creating it if necessary.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tasksRemoteDataSource the backend data source</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tasksLocalDataSource  the device storage data source</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the &#123;<span class="doctag">@link</span> TasksRepository&#125; instance</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//单例方式创建TasksRepository</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="title class_">TasksRepository</span> <span class="title function_">getInstance</span>(<span class="params">TasksDataSource tasksRemoteDataSource,</span></span><br><span class="line"><span class="params">                                              TasksDataSource tasksLocalDataSource</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable constant_">INSTANCE</span> == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="variable constant_">INSTANCE</span> = <span class="keyword">new</span> <span class="title class_">TasksRepository</span>(tasksRemoteDataSource, tasksLocalDataSource);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable constant_">INSTANCE</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Used to force &#123;<span class="doctag">@link</span> #getInstance(TasksDataSource, TasksDataSource)&#125; to create a new instance</span></span><br><span class="line"><span class="comment">     * next time it&#x27;s called.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">void</span> <span class="title function_">destroyInstance</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable constant_">INSTANCE</span> = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Prevent direct instantiation.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">TasksRepository</span>(<span class="meta">@NonNull</span> <span class="title class_">TasksDataSource</span> tasksRemoteDataSource,</span><br><span class="line">                            <span class="meta">@NonNull</span> <span class="title class_">TasksDataSource</span> tasksLocalDataSource) &#123;</span><br><span class="line">        mTasksRemoteDataSource = <span class="title function_">checkNotNull</span>(tasksRemoteDataSource);</span><br><span class="line">        mTasksLocalDataSource = <span class="title function_">checkNotNull</span>(tasksLocalDataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注册数据源变化监听器</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">addContentObserver</span>(<span class="params">TasksRepositoryObserver observer</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mObservers.<span class="title function_">contains</span>(observer)) &#123;</span><br><span class="line">            mObservers.<span class="title function_">add</span>(observer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//移除数据源变化监听器</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">removeContentObserver</span>(<span class="params">TasksRepositoryObserver observer</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mObservers.<span class="title function_">contains</span>(observer)) &#123;</span><br><span class="line">            mObservers.<span class="title function_">remove</span>(observer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通知监听者数据源发生变化</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">void</span> <span class="title function_">notifyContentObserver</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="title class_">TasksRepositoryObserver</span> observer : mObservers) &#123;</span><br><span class="line">            observer.<span class="title function_">onTasksChanged</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Gets tasks from cache, local data source (SQLite) or remote data source, whichever is</span></span><br><span class="line"><span class="comment">     * available first. This is done synchronously because it&#x27;s used by the &#123;<span class="doctag">@link</span> TasksLoader&#125;,</span></span><br><span class="line"><span class="comment">     * which implements the async mechanism.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">List</span>&lt;<span class="title class_">Task</span>&gt; <span class="title function_">getTasks</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title class_">List</span>&lt;<span class="title class_">Task</span>&gt; tasks = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (!mCacheIsDirty) &#123;</span><br><span class="line">            <span class="comment">//表示缓存中数据还可以用</span></span><br><span class="line">            <span class="comment">// Respond immediately with cache if available and not dirty</span></span><br><span class="line">            <span class="keyword">if</span> (mCachedTasks != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">//从缓存中获取数据</span></span><br><span class="line">                tasks = <span class="title function_">getCachedTasks</span>();</span><br><span class="line">                <span class="keyword">return</span> tasks;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//这个是第一次的情况下，从数据库中加载数据</span></span><br><span class="line">                <span class="comment">// Query the local storage if available.</span></span><br><span class="line">                tasks = mTasksLocalDataSource.<span class="title function_">getTasks</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// To simplify, we&#x27;ll consider the local data source fresh when it has data.</span></span><br><span class="line">        <span class="comment">//如果从本地数据库中加载完就会跑到这里，对结果进行判断，如果是空则表示，数据库中没有想要的数据，那么就从远程数据源中获取。</span></span><br><span class="line">        <span class="keyword">if</span> (tasks == <span class="literal">null</span> || tasks.<span class="title function_">isEmpty</span>()) &#123;</span><br><span class="line">            <span class="comment">// Grab remote data if cache is dirty or local data not available.</span></span><br><span class="line">            tasks = mTasksRemoteDataSource.<span class="title function_">getTasks</span>();</span><br><span class="line">            <span class="comment">// We copy the data to the device so we don&#x27;t need to query the network next time</span></span><br><span class="line">            <span class="comment">//从远程数据源中获取后将其缓存到数据库中，供下一次使用。</span></span><br><span class="line">            <span class="title function_">saveTasksInLocalDataSource</span>(tasks);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//不论是从数据库中加载还是从远程数据源中加载数据都需要将数据缓存到内存中</span></span><br><span class="line">        <span class="title function_">processLoadedTasks</span>(tasks);</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">getCachedTasks</span>();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断缓存数据是否可用</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">boolean</span> <span class="title function_">cachedTasksAvailable</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> mCachedTasks != <span class="literal">null</span> &amp;&amp; !mCacheIsDirty;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取缓存中的数据</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">List</span>&lt;<span class="title class_">Task</span>&gt; <span class="title function_">getCachedTasks</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> mCachedTasks == <span class="literal">null</span> ? <span class="literal">null</span> : <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(mCachedTasks.<span class="title function_">values</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取缓存中的指定数据</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Task</span> <span class="title function_">getCachedTask</span>(<span class="params"><span class="built_in">String</span> taskId</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> mCachedTasks.<span class="title function_">get</span>(taskId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将数据保存到数据库中</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">void</span> <span class="title function_">saveTasksInLocalDataSource</span>(<span class="params">List&lt;Task&gt; tasks</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (tasks != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="title class_">Task</span> task : tasks) &#123;</span><br><span class="line">                mTasksLocalDataSource.<span class="title function_">saveTask</span>(task);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将数据缓存到内存上</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">void</span> <span class="title function_">processLoadedTasks</span>(<span class="params">List&lt;Task&gt; tasks</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (tasks == <span class="literal">null</span>) &#123;</span><br><span class="line">            mCachedTasks = <span class="literal">null</span>;</span><br><span class="line">            mCacheIsDirty = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mCachedTasks == <span class="literal">null</span>) &#123;</span><br><span class="line">            mCachedTasks = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        mCachedTasks.<span class="title function_">clear</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="title class_">Task</span> task : tasks) &#123;</span><br><span class="line">            mCachedTasks.<span class="title function_">put</span>(task.<span class="title function_">getId</span>(), task);</span><br><span class="line">        &#125;</span><br><span class="line">        mCacheIsDirty = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//保存任务</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">saveTask</span>(<span class="params"><span class="meta">@NonNull</span> Task task</span>) &#123;</span><br><span class="line">        <span class="title function_">checkNotNull</span>(task);</span><br><span class="line">        mTasksRemoteDataSource.<span class="title function_">saveTask</span>(task);</span><br><span class="line">        mTasksLocalDataSource.<span class="title function_">saveTask</span>(task);</span><br><span class="line">        <span class="comment">// Do in memory cache update to keep the app UI up to date</span></span><br><span class="line">        <span class="keyword">if</span> (mCachedTasks == <span class="literal">null</span>) &#123;</span><br><span class="line">            mCachedTasks = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        mCachedTasks.<span class="title function_">put</span>(task.<span class="title function_">getId</span>(), task);</span><br><span class="line">        <span class="comment">// Update the UI</span></span><br><span class="line">        <span class="title function_">notifyContentObserver</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加完成的任务</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">completeTask</span>(<span class="params"><span class="meta">@NonNull</span> Task task</span>) &#123;</span><br><span class="line">        <span class="title function_">checkNotNull</span>(task);</span><br><span class="line">        mTasksRemoteDataSource.<span class="title function_">completeTask</span>(task);</span><br><span class="line">        mTasksLocalDataSource.<span class="title function_">completeTask</span>(task);</span><br><span class="line">        <span class="title class_">Task</span> completedTask = <span class="keyword">new</span> <span class="title class_">Task</span>(task.<span class="title function_">getTitle</span>(), task.<span class="title function_">getDescription</span>(), task.<span class="title function_">getId</span>(), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Do in memory cache update to keep the app UI up to date</span></span><br><span class="line">        <span class="keyword">if</span> (mCachedTasks == <span class="literal">null</span>) &#123;</span><br><span class="line">            mCachedTasks = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        mCachedTasks.<span class="title function_">put</span>(task.<span class="title function_">getId</span>(), completedTask);</span><br><span class="line">        <span class="comment">// Update the UI</span></span><br><span class="line">        <span class="title function_">notifyContentObserver</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加完成的任务</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">completeTask</span>(<span class="params"><span class="meta">@NonNull</span> <span class="built_in">String</span> taskId</span>) &#123;</span><br><span class="line">        <span class="title function_">checkNotNull</span>(taskId);</span><br><span class="line">        <span class="title function_">completeTask</span>(<span class="title function_">getTaskWithId</span>(taskId));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加激活的任务</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">activateTask</span>(<span class="params"><span class="meta">@NonNull</span> Task task</span>) &#123;</span><br><span class="line">        <span class="title function_">checkNotNull</span>(task);</span><br><span class="line">        mTasksRemoteDataSource.<span class="title function_">activateTask</span>(task);</span><br><span class="line">        mTasksLocalDataSource.<span class="title function_">activateTask</span>(task);</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Task</span> activeTask = <span class="keyword">new</span> <span class="title class_">Task</span>(task.<span class="title function_">getTitle</span>(), task.<span class="title function_">getDescription</span>(), task.<span class="title function_">getId</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Do in memory cache update to keep the app UI up to date</span></span><br><span class="line">        <span class="keyword">if</span> (mCachedTasks == <span class="literal">null</span>) &#123;</span><br><span class="line">            mCachedTasks = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        mCachedTasks.<span class="title function_">put</span>(task.<span class="title function_">getId</span>(), activeTask);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Update the UI</span></span><br><span class="line">        <span class="title function_">notifyContentObserver</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加激活的任务</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">activateTask</span>(<span class="params"><span class="meta">@NonNull</span> <span class="built_in">String</span> taskId</span>) &#123;</span><br><span class="line">        <span class="title function_">checkNotNull</span>(taskId);</span><br><span class="line">        <span class="title function_">activateTask</span>(<span class="title function_">getTaskWithId</span>(taskId));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//清除完成的任务</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">clearCompletedTasks</span>(<span class="params"></span>) &#123;</span><br><span class="line">        mTasksRemoteDataSource.<span class="title function_">clearCompletedTasks</span>();</span><br><span class="line">        mTasksLocalDataSource.<span class="title function_">clearCompletedTasks</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Do in memory cache update to keep the app UI up to date</span></span><br><span class="line">        <span class="keyword">if</span> (mCachedTasks == <span class="literal">null</span>) &#123;</span><br><span class="line">            mCachedTasks = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title class_">Iterator</span>&lt;<span class="title class_">Map</span>.<span class="property">Entry</span>&lt;<span class="title class_">String</span>, <span class="title class_">Task</span>&gt;&gt; it = mCachedTasks.<span class="title function_">entrySet</span>().<span class="title function_">iterator</span>();</span><br><span class="line">        <span class="keyword">while</span> (it.<span class="title function_">hasNext</span>()) &#123;</span><br><span class="line">            <span class="title class_">Map</span>.<span class="property">Entry</span>&lt;<span class="title class_">String</span>, <span class="title class_">Task</span>&gt; entry = it.<span class="title function_">next</span>();</span><br><span class="line">            <span class="keyword">if</span> (entry.<span class="title function_">getValue</span>().<span class="title function_">isCompleted</span>()) &#123;</span><br><span class="line">                it.<span class="title function_">remove</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Update the UI</span></span><br><span class="line">        <span class="title function_">notifyContentObserver</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Gets tasks from local data source (sqlite) unless the table is new or empty. In that case it</span></span><br><span class="line"><span class="comment">     * uses the network data source. This is done to simplify the sample.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Task</span> <span class="title function_">getTask</span>(<span class="params"><span class="meta">@NonNull</span> final <span class="built_in">String</span> taskId</span>) &#123;</span><br><span class="line">        <span class="title function_">checkNotNull</span>(taskId);</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Task</span> cachedTask = <span class="title function_">getTaskWithId</span>(taskId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Respond immediately with cache if we have one</span></span><br><span class="line">        <span class="keyword">if</span> (cachedTask != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> cachedTask;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Is the task in the local data source? If not, query the network.</span></span><br><span class="line">        <span class="title class_">Task</span> task = mTasksLocalDataSource.<span class="title function_">getTask</span>(taskId);</span><br><span class="line">        <span class="keyword">if</span> (task == <span class="literal">null</span>) &#123;</span><br><span class="line">            task = mTasksRemoteDataSource.<span class="title function_">getTask</span>(taskId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> task;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Task</span> <span class="title function_">getTaskWithId</span>(<span class="params"><span class="meta">@NonNull</span> <span class="built_in">String</span> id</span>) &#123;</span><br><span class="line">        <span class="title function_">checkNotNull</span>(id);</span><br><span class="line">        <span class="keyword">if</span> (mCachedTasks == <span class="literal">null</span> || mCachedTasks.<span class="title function_">isEmpty</span>()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> mCachedTasks.<span class="title function_">get</span>(id);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">refreshTasks</span>(<span class="params"></span>) &#123;</span><br><span class="line">        mCacheIsDirty = <span class="literal">true</span>;</span><br><span class="line">        <span class="title function_">notifyContentObserver</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">deleteAllTasks</span>(<span class="params"></span>) &#123;</span><br><span class="line">        mTasksRemoteDataSource.<span class="title function_">deleteAllTasks</span>();</span><br><span class="line">        mTasksLocalDataSource.<span class="title function_">deleteAllTasks</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mCachedTasks == <span class="literal">null</span>) &#123;</span><br><span class="line">            mCachedTasks = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        mCachedTasks.<span class="title function_">clear</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Update the UI</span></span><br><span class="line">        <span class="title function_">notifyContentObserver</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">deleteTask</span>(<span class="params"><span class="meta">@NonNull</span> <span class="built_in">String</span> taskId</span>) &#123;</span><br><span class="line">        mTasksRemoteDataSource.<span class="title function_">deleteTask</span>(<span class="title function_">checkNotNull</span>(taskId));</span><br><span class="line">        mTasksLocalDataSource.<span class="title function_">deleteTask</span>(<span class="title function_">checkNotNull</span>(taskId));</span><br><span class="line"></span><br><span class="line">        mCachedTasks.<span class="title function_">remove</span>(taskId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Update the UI</span></span><br><span class="line">        <span class="title function_">notifyContentObserver</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TasksRepositoryObserver</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">void</span> <span class="title function_">onTasksChanged</span>();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面代码来看其实TasksRepository 主要的变化不大，主要是将原先的Callback回调变成了观察者模式。TasksLocalDataSource，以及TasksRemoteDataSource变化也不大。最大的变化应当属于TasksLoader<br>它是继承自AsyncTaskLoader以及实现了TasksRepositoryObserver。AsyncTaskLoader 这个之前都没介绍过，这个将会在后续的博客中补上。<br>一提到AsyncTaskLoader估计就会想到CursorLoader以及AysncTask，其实也差不多，它就是用于在后台中加载数据的。</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TasksLoader</span> <span class="keyword">extends</span> <span class="title class_ inherited__">AsyncTaskLoader</span>&lt;<span class="title class_">List</span>&lt;<span class="title class_">Task</span>&gt;&gt;</span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">TasksRepository</span>.<span class="property">TasksRepositoryObserver</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">TasksRepository</span> mRepository;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">TasksLoader</span>(<span class="title class_">Context</span> context, <span class="meta">@NonNull</span> <span class="title class_">TasksRepository</span> repository) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(context);</span><br><span class="line">        <span class="title function_">checkNotNull</span>(repository);</span><br><span class="line">        mRepository = repository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//在后台加载数据</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">List</span>&lt;<span class="title class_">Task</span>&gt; <span class="title function_">loadInBackground</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> mRepository.<span class="title function_">getTasks</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">deliverResult</span>(<span class="params">List&lt;Task&gt; data</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果后台加载线程没有开始，就直接返回</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">isReset</span>()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将结果传递给UI线程</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">isStarted</span>()) &#123;</span><br><span class="line">            <span class="variable language_">super</span>.<span class="title function_">deliverResult</span>(data);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="built_in">void</span> <span class="title function_">onStartLoading</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果缓存中有任何可用的数据那么直接返回</span></span><br><span class="line">        <span class="comment">// Deliver any previously loaded data immediately if available.</span></span><br><span class="line">        <span class="keyword">if</span> (mRepository.<span class="title function_">cachedTasksAvailable</span>()) &#123;</span><br><span class="line">            <span class="title function_">deliverResult</span>(mRepository.<span class="title function_">getCachedTasks</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//监听数据集的变化</span></span><br><span class="line">        <span class="comment">// Begin monitoring the underlying data source.</span></span><br><span class="line">        mRepository.<span class="title function_">addContentObserver</span>(<span class="variable language_">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果内容有改变或者内存缓存内的任务不可用那么强制执行一次加载</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">takeContentChanged</span>() || !mRepository.<span class="title function_">cachedTasksAvailable</span>()) &#123;</span><br><span class="line">            <span class="comment">// When a change has  been delivered or the repository cache isn&#x27;t available, we force</span></span><br><span class="line">            <span class="comment">// a load.</span></span><br><span class="line">            <span class="title function_">forceLoad</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="built_in">void</span> <span class="title function_">onStopLoading</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title function_">cancelLoad</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="built_in">void</span> <span class="title function_">onReset</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title function_">cancelLoad</span>();</span><br><span class="line">        mRepository.<span class="title function_">removeContentObserver</span>(<span class="variable language_">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果数据集中发生变化启动一次加载</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">onTasksChanged</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">isStarted</span>()) &#123;</span><br><span class="line">            <span class="title function_">forceLoad</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TasksPresenter</span> <span class="keyword">implements</span> <span class="title class_">TasksContract</span>.<span class="property">Presenter</span>,</span><br><span class="line">        <span class="title class_">LoaderManager</span>.<span class="property">LoaderCallbacks</span>&lt;<span class="title class_">List</span>&lt;<span class="title class_">Task</span>&gt;&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> final <span class="keyword">static</span> int <span class="variable constant_">TASKS_QUERY</span> = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> final <span class="title class_">TasksRepository</span> mTasksRepository;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> final <span class="title class_">TasksContract</span>.<span class="property">View</span> mTasksView;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> final <span class="title class_">TasksLoader</span> mLoader;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> final <span class="title class_">LoaderManager</span> mLoaderManager;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">List</span>&lt;<span class="title class_">Task</span>&gt; mCurrentTasks;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">TasksFilterType</span> mCurrentFiltering = <span class="title class_">TasksFilterType</span>.<span class="property">ALL_TASKS</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">boolean</span> mFirstLoad;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">TasksPresenter</span>(<span class="meta">@NonNull</span> <span class="title class_">TasksLoader</span> loader, <span class="meta">@NonNull</span> <span class="title class_">LoaderManager</span> loaderManager,</span><br><span class="line">                          <span class="meta">@NonNull</span> <span class="title class_">TasksRepository</span> tasksRepository, <span class="meta">@NonNull</span> <span class="title class_">TasksContract</span>.<span class="property">View</span> tasksView) &#123;</span><br><span class="line">        mLoader = <span class="title function_">checkNotNull</span>(loader, <span class="string">&quot;loader cannot be null!&quot;</span>);</span><br><span class="line">        mLoaderManager = <span class="title function_">checkNotNull</span>(loaderManager, <span class="string">&quot;loader manager cannot be null&quot;</span>);</span><br><span class="line">        mTasksRepository = <span class="title function_">checkNotNull</span>(tasksRepository, <span class="string">&quot;tasksRepository cannot be null&quot;</span>);</span><br><span class="line">        mTasksView = <span class="title function_">checkNotNull</span>(tasksView, <span class="string">&quot;tasksView cannot be null!&quot;</span>);</span><br><span class="line">        mTasksView.<span class="title function_">setPresenter</span>(<span class="variable language_">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">result</span>(<span class="params">int requestCode, int resultCode</span>) &#123;</span><br><span class="line">        <span class="comment">// If a task was successfully added, show snackbar</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title class_">AddEditTaskActivity</span>.<span class="property">REQUEST_ADD_TASK</span> == requestCode &amp;&amp; <span class="title class_">Activity</span>.<span class="property">RESULT_OK</span> == resultCode) &#123;</span><br><span class="line">            mTasksView.<span class="title function_">showSuccessfullySavedMessage</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//这里启动AsyncTaskLoader</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">start</span>(<span class="params"></span>) &#123;</span><br><span class="line">        mLoaderManager.<span class="title function_">initLoader</span>(<span class="variable constant_">TASKS_QUERY</span>, <span class="literal">null</span>, <span class="variable language_">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Loader</span>&lt;<span class="title class_">List</span>&lt;<span class="title class_">Task</span>&gt;&gt; <span class="title function_">onCreateLoader</span>(<span class="params">int id, Bundle args</span>) &#123;</span><br><span class="line">        mTasksView.<span class="title function_">setLoadingIndicator</span>(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//返回从TaskActivity中传来的TasksLoader</span></span><br><span class="line">        <span class="keyword">return</span> mLoader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">onLoadFinished</span>(<span class="params">Loader&lt;List&lt;Task&gt;&gt; loader, List&lt;Task&gt; data</span>) &#123;</span><br><span class="line">        mTasksView.<span class="title function_">setLoadingIndicator</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        mCurrentTasks = data;</span><br><span class="line">        <span class="keyword">if</span> (mCurrentTasks == <span class="literal">null</span>) &#123;</span><br><span class="line">            mTasksView.<span class="title function_">showLoadingTasksError</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_">showFilteredTasks</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">void</span> <span class="title function_">showFilteredTasks</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title class_">List</span>&lt;<span class="title class_">Task</span>&gt; tasksToDisplay = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (mCurrentTasks != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="title class_">Task</span> task : mCurrentTasks) &#123;</span><br><span class="line">                <span class="keyword">switch</span> (mCurrentFiltering) &#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="attr">ALL_TASKS</span>:</span><br><span class="line">                        tasksToDisplay.<span class="title function_">add</span>(task);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="attr">ACTIVE_TASKS</span>:</span><br><span class="line">                        <span class="keyword">if</span> (task.<span class="title function_">isActive</span>()) &#123;</span><br><span class="line">                            tasksToDisplay.<span class="title function_">add</span>(task);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="attr">COMPLETED_TASKS</span>:</span><br><span class="line">                        <span class="keyword">if</span> (task.<span class="title function_">isCompleted</span>()) &#123;</span><br><span class="line">                            tasksToDisplay.<span class="title function_">add</span>(task);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="attr">default</span>:</span><br><span class="line">                        tasksToDisplay.<span class="title function_">add</span>(task);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">processTasks</span>(tasksToDisplay);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">onLoaderReset</span>(<span class="params">Loader&lt;List&lt;Task&gt;&gt; loader</span>) &#123;</span><br><span class="line">        <span class="comment">// no-op</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> forceUpdate Pass in true to refresh the data in the &#123;<span class="doctag">@link</span> TasksDataSource&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">loadTasks</span>(<span class="params"><span class="built_in">boolean</span> forceUpdate</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (forceUpdate || mFirstLoad) &#123;</span><br><span class="line">            mFirstLoad = <span class="literal">false</span>;</span><br><span class="line">            mTasksRepository.<span class="title function_">refreshTasks</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_">showFilteredTasks</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">void</span> <span class="title function_">processTasks</span>(<span class="params">List&lt;Task&gt; tasks</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (tasks.<span class="title function_">isEmpty</span>()) &#123;</span><br><span class="line">            <span class="comment">// Show a message indicating there are no tasks for that filter type.</span></span><br><span class="line">            <span class="title function_">processEmptyTasks</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Show the list of tasks</span></span><br><span class="line">            mTasksView.<span class="title function_">showTasks</span>(tasks);</span><br><span class="line">            <span class="comment">// Set the filter label&#x27;s text.</span></span><br><span class="line">            <span class="title function_">showFilterLabel</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">void</span> <span class="title function_">showFilterLabel</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (mCurrentFiltering) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="attr">ACTIVE_TASKS</span>:</span><br><span class="line">                mTasksView.<span class="title function_">showActiveFilterLabel</span>();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="attr">COMPLETED_TASKS</span>:</span><br><span class="line">                mTasksView.<span class="title function_">showCompletedFilterLabel</span>();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="attr">default</span>:</span><br><span class="line">                mTasksView.<span class="title function_">showAllFilterLabel</span>();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">void</span> <span class="title function_">processEmptyTasks</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (mCurrentFiltering) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="attr">ACTIVE_TASKS</span>:</span><br><span class="line">                mTasksView.<span class="title function_">showNoActiveTasks</span>();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="attr">COMPLETED_TASKS</span>:</span><br><span class="line">                mTasksView.<span class="title function_">showNoCompletedTasks</span>();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="attr">default</span>:</span><br><span class="line">                mTasksView.<span class="title function_">showNoTasks</span>();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">addNewTask</span>(<span class="params"></span>) &#123;</span><br><span class="line">        mTasksView.<span class="title function_">showAddTask</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">openTaskDetails</span>(<span class="params"><span class="meta">@NonNull</span> Task requestedTask</span>) &#123;</span><br><span class="line">        <span class="title function_">checkNotNull</span>(requestedTask, <span class="string">&quot;requestedTask cannot be null!&quot;</span>);</span><br><span class="line">        mTasksView.<span class="title function_">showTaskDetailsUi</span>(requestedTask.<span class="title function_">getId</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">completeTask</span>(<span class="params"><span class="meta">@NonNull</span> Task completedTask</span>) &#123;</span><br><span class="line">        <span class="title function_">checkNotNull</span>(completedTask, <span class="string">&quot;completedTask cannot be null!&quot;</span>);</span><br><span class="line">        mTasksRepository.<span class="title function_">completeTask</span>(completedTask);</span><br><span class="line">        mTasksView.<span class="title function_">showTaskMarkedComplete</span>();</span><br><span class="line">        <span class="title function_">loadTasks</span>(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">activateTask</span>(<span class="params"><span class="meta">@NonNull</span> Task activeTask</span>) &#123;</span><br><span class="line">        <span class="title function_">checkNotNull</span>(activeTask, <span class="string">&quot;activeTask cannot be null!&quot;</span>);</span><br><span class="line">        mTasksRepository.<span class="title function_">activateTask</span>(activeTask);</span><br><span class="line">        mTasksView.<span class="title function_">showTaskMarkedActive</span>();</span><br><span class="line">        <span class="title function_">loadTasks</span>(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">clearCompletedTasks</span>(<span class="params"></span>) &#123;</span><br><span class="line">        mTasksRepository.<span class="title function_">clearCompletedTasks</span>();</span><br><span class="line">        mTasksView.<span class="title function_">showCompletedTasksCleared</span>();</span><br><span class="line">        <span class="title function_">loadTasks</span>(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Sets the current task filtering type.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> requestType Can be &#123;<span class="doctag">@link</span> TasksFilterType#ALL_TASKS&#125;,</span></span><br><span class="line"><span class="comment">     *                    &#123;<span class="doctag">@link</span> TasksFilterType#COMPLETED_TASKS&#125;, or &#123;<span class="doctag">@link</span> TasksFilterType#ACTIVE_TASKS&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setFiltering</span>(<span class="params">TasksFilterType requestType</span>) &#123;</span><br><span class="line">        mCurrentFiltering = requestType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">TasksFilterType</span> <span class="title function_">getFiltering</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> mCurrentFiltering;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们返过头看下，整个代码和之前的差别不是很大，差别主要是增加了TasksLoader，将原先在主要线程加载数据改成使用Loader在后台加载数据，并且使用Observer来监听数据集合的变化，来代替回调的方式。</p>
<p>下面是整个代码的结构：<br><img src="/2016/08/22/Android-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BTODO-MVP-Loaders/1.png"></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">Android 源码分析</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Android-开源源码/">Android 开源源码</a>
  </div>

</div>



<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/08/22/Android-源码分析之TODO-MVP-Loaders/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/08/22/Android-源码分析之TODO-MVP-Loaders/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/page/11/">&lt;span&gt;&lt;&#x2F;span&gt;Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="page-number" href="/page/11/">11</a><span class="page-number current">12</span><a class="page-number" href="/page/13/">13</a><a class="page-number" href="/page/14/">14</a><span class="space">&hellip;</span><a class="page-number" href="/page/30/">30</a><a class="extend next" rel="next" href="/page/13/">Next&lt;span&gt;&lt;&#x2F;span&gt;</a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">
<div id="authorInfo">
	
		<div class="author-img"></div>		
	
	<div class="social-info" class="clearfix">
		
		
		<a href="https://github.com/tbfungeek" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
		
		<a href="mailto:tbfungeek@163.com" target="_blank" class="icon-email" title="Email Me"></a>
		

	</div>
</div>

  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
		  
			<li><a href="/categories/Android-小经验/" title="Android 小经验">Android 小经验<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android-源码分析/" title="Android 源码分析">Android 源码分析<sup>21</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android其他/" title="Android其他">Android其他<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android初步/" title="Android初步">Android初步<sup>21</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android进阶/" title="Android进阶">Android进阶<sup>100</sup></a></li>
		  
		
		  
			<li><a href="/categories/Hexo-使用/" title="Hexo 使用">Hexo 使用<sup>10</sup></a></li>
		  
		
		  
			<li><a href="/categories/JavaScript理论/" title="JavaScript理论">JavaScript理论<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Objective-C-相关/" title="Objective C 相关">Objective C 相关<sup>24</sup></a></li>
		  
		
		  
			<li><a href="/categories/OpenCV/" title="OpenCV">OpenCV<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/ROS/" title="ROS">ROS<sup>9</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-工具使用/" title="iOS 工具使用">iOS 工具使用<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-开源库分析/" title="iOS 开源库分析">iOS 开源库分析<sup>36</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-理论基础/" title="iOS 理论基础">iOS 理论基础<sup>14</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS-进阶/" title="iOS 进阶">iOS 进阶<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/个人收藏/" title="个人收藏">个人收藏<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/代码规范/" title="代码规范">代码规范<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/其他/" title="其他">其他<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/博客分类目录/" title="博客分类目录">博客分类目录<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/叨叨系列/" title="叨叨系列">叨叨系列<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/开源代码分析/" title="开源代码分析">开源代码分析<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/开源库分析/" title="开源库分析">开源库分析<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/树莓派/" title="树莓派">树莓派<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/版本控制/" title="版本控制">版本控制<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/直播/" title="直播">直播<sup>6</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/iOS-开源库分析/" title="iOS 开源库分析">iOS 开源库分析<sup>36</sup></a></li>
			
		
			
				<li><a href="/tags/Android-设计模式/" title="Android 设计模式">Android 设计模式<sup>29</sup></a></li>
			
		
			
				<li><a href="/tags/Objective-C-相关/" title="Objective C 相关">Objective C 相关<sup>24</sup></a></li>
			
		
			
				<li><a href="/tags/Android基础/" title="Android基础">Android基础<sup>21</sup></a></li>
			
		
			
				<li><a href="/tags/AOSP-源码/" title="AOSP 源码">AOSP 源码<sup>17</sup></a></li>
			
		
			
				<li><a href="/tags/Android-常用第三方库/" title="Android 常用第三方库">Android 常用第三方库<sup>15</sup></a></li>
			
		
			
				<li><a href="/tags/iOS-理论基础/" title="iOS 理论基础">iOS 理论基础<sup>14</sup></a></li>
			
		
			
				<li><a href="/tags/Hexo-使用/" title="Hexo 使用">Hexo 使用<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/ROS/" title="ROS">ROS<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/Android-动画进阶/" title="Android 动画进阶">Android 动画进阶<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/Android-JNI/" title="Android JNI">Android JNI<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android-绘图进阶/" title="Android 绘图进阶">Android 绘图进阶<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android性能优化/" title="Android性能优化">Android性能优化<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android-自动化测试/" title="Android 自动化测试">Android 自动化测试<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/OpenCV/" title="OpenCV">OpenCV<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/直播/" title="直播">直播<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android-开源源码/" title="Android 开源源码">Android 开源源码<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Android-自定义View进阶/" title="Android 自定义View进阶">Android 自定义View进阶<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/树莓派/" title="树莓派">树莓派<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/iOS-进阶/" title="iOS 进阶">iOS 进阶<sup>4</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="https://hexo.io" target="_blank" title="Hexo">Hexo</a>
            
          </li>
        
          <li>
            
            	<a href="https://pages.github.com/" target="_blank" title="GitHub">GitHub</a>
            
          </li>
        
          <li>
            
            	<a href="http://pf18.github.io/" target="_blank" title="PF18">PF18</a>
            
          </li>
        
          <li>
            
            	<a href="http://toutiao.io/" target="_blank" title="开发者头条">开发者头条</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.jcodecraeer.com/" target="_blank" title="泡在网上的日子">泡在网上的日子</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="atom.xml" target="_blank" title="rss">RSS</a>
</div>

  
  <div class="tagcloudlist">
    <p class="asidetitle">Tag Cloud</p>
    <div class="tagcloudlist clearfix">
       <a href="/tags/AOSP-%E6%BA%90%E7%A0%81/" style="font-size: 17.14px;">AOSP 源码</a> <a href="/tags/Android-APK-%E7%AD%BE%E5%90%8D/" style="font-size: 10px;">Android APK 签名</a> <a href="/tags/Android-JNI/" style="font-size: 12.86px;">Android JNI</a> <a href="/tags/Android-%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E8%BF%9B%E9%98%B6/" style="font-size: 10.71px;">Android 事件处理进阶</a> <a href="/tags/Android-%E5%8A%A8%E7%94%BB%E8%BF%9B%E9%98%B6/" style="font-size: 13.57px;">Android 动画进阶</a> <a href="/tags/Android-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%BC%80%E5%8F%91/" style="font-size: 10px;">Android 多线程开发</a> <a href="/tags/Android-%E5%B0%8F%E7%BB%8F%E9%AA%8C/" style="font-size: 10px;">Android 小经验</a> <a href="/tags/Android-%E5%B8%B8%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93/" style="font-size: 16.43px;">Android 常用第三方库</a> <a href="/tags/Android-%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B/" style="font-size: 10px;">Android 开发流程</a> <a href="/tags/Android-%E5%BC%80%E6%BA%90%E6%BA%90%E7%A0%81/" style="font-size: 12.14px;">Android 开源源码</a> <a href="/tags/Android-%E7%BB%98%E5%9B%BE%E8%BF%9B%E9%98%B6/" style="font-size: 12.86px;">Android 绘图进阶</a> <a href="/tags/Android-%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/" style="font-size: 12.86px;">Android 自动化测试</a> <a href="/tags/Android-%E8%87%AA%E5%AE%9A%E4%B9%89View%E8%BF%9B%E9%98%B6/" style="font-size: 12.14px;">Android 自定义View进阶</a> <a href="/tags/Android-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 19.29px;">Android 设计模式</a> <a href="/tags/Android%E5%85%B6%E4%BB%96/" style="font-size: 10px;">Android其他</a> <a href="/tags/Android%E5%9F%BA%E7%A1%80/" style="font-size: 17.86px;">Android基础</a> <a href="/tags/Android%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B/" style="font-size: 10px;">Android开发流程</a> <a href="/tags/Android%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" style="font-size: 12.86px;">Android性能优化</a> <a href="/tags/Android%E6%B7%B7%E6%B7%86%E6%8A%80%E6%9C%AF/" style="font-size: 10px;">Android混淆技术</a> <a href="/tags/Android%E8%B4%A8%E9%87%8F%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/" style="font-size: 11.43px;">Android质量管理工具</a> <a href="/tags/Android%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/" style="font-size: 10px;">Android逆向工程</a> <a href="/tags/Git-github/" style="font-size: 10px;">Git && github</a> <a href="/tags/Hexo-%E4%BD%BF%E7%94%A8/" style="font-size: 15px;">Hexo 使用</a> <a href="/tags/JavaScript/" style="font-size: 10px;">JavaScript</a> <a href="/tags/Linux-%E4%BD%BF%E7%94%A8/" style="font-size: 10px;">Linux 使用</a> <a href="/tags/Objective-C-%E7%9B%B8%E5%85%B3/" style="font-size: 18.57px;">Objective C 相关</a> <a href="/tags/OpenCV/" style="font-size: 12.86px;">OpenCV</a> <a href="/tags/ROS/" style="font-size: 14.29px;">ROS</a> <a href="/tags/iOS-%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/" style="font-size: 10.71px;">iOS 工具使用</a> <a href="/tags/iOS-%E5%BC%80%E6%BA%90%E5%BA%93%E5%88%86%E6%9E%90/" style="font-size: 20px;">iOS 开源库分析</a> <a href="/tags/iOS-%E7%90%86%E8%AE%BA%E5%9F%BA%E7%A1%80/" style="font-size: 15.71px;">iOS 理论基础</a> <a href="/tags/iOS-%E8%BF%9B%E9%98%B6/" style="font-size: 12.14px;">iOS 进阶</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83/" style="font-size: 10px;">代码规范</a> <a href="/tags/%E5%8D%9A%E5%AE%A2%E5%88%86%E7%B1%BB%E7%9B%AE%E5%BD%95/" style="font-size: 10.71px;">博客分类目录</a> <a href="/tags/%E5%8F%A8%E5%8F%A8%E7%B3%BB%E5%88%97/" style="font-size: 10px;">叨叨系列</a> <a href="/tags/%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8/" style="font-size: 11.43px;">工具的使用</a> <a href="/tags/%E5%BC%80%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/" style="font-size: 10.71px;">开源代码分析</a> <a href="/tags/%E5%BC%80%E6%BA%90%E5%BA%93%E5%88%86%E6%9E%90/" style="font-size: 10px;">开源库分析</a> <a href="/tags/%E6%9D%82%E7%B1%BB/" style="font-size: 10px;">杂类</a> <a href="/tags/%E6%A0%91%E8%8E%93%E6%B4%BE/" style="font-size: 12.14px;">树莓派</a> <a href="/tags/%E7%9B%B4%E6%92%AD/" style="font-size: 12.86px;">直播</a> <a href="/tags/%E7%BC%96%E7%A8%8B%E6%8A%80%E5%B7%A7/" style="font-size: 10.71px;">编程技巧</a> <a href="/tags/%E7%BD%91%E7%AB%99%E6%94%B6%E8%97%8F/" style="font-size: 10px;">网站收藏</a> <a href="/tags/%E9%87%8D%E8%A6%81%E6%8E%A7%E4%BB%B6/" style="font-size: 11.43px;">重要控件</a>
    </div>
  </div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
		
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/hsihohuang/kiddochan" target="_blank" title="Kiddochan">Kiddochan</a> © 2022 
		
		<a href="/about" target="_blank" title="Edgar">Edgar</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>










<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?7c9443b0374f1cf6b1dbb5ab84d939cb";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
